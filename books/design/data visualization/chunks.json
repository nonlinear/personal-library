[
  {
    "chunk_full": "![cover.png](images/cover.png)\n\n\nBeautiful Visualization\n\nEdited by Julie Steele and Noah Iliinsky\n\n![oralogo.png](images/oralogo.png)\n\nBeijing · Cambridge · Farnham · Köln · Sebastopol · Taipei · Tokyo\n\n\nBeautiful Visualization\n\nEdited by Julie Steele and Noah Iliinsky\n\nCopyright © 2010 O’Reilly Media, Inc. All rights reserved.\n\nPublished by O’Reilly Media, Inc., 1005 Gravenstein Highway North, Sebastopol,\nCA 95472.\n\nO’Reilly books may be purchased for educational, business, or sales\npromotional use. Online editions are also available for most titles\n(http://my.safaribooksonline.com). For more information, contact our\ncorporate/institutional sales department: (800) 998-9938 or\ncorporate@oreilly.com.\n\nEditor: Julie Steele\n\nProduction Editor: Rachel Monaghan\n\nCopyeditor: Rachel Head\n\nProofreader: Rachel Monaghan\n\nIndexer: Julie Hawks\n\nCover Designer: Karen Montgomery\n\nInterior Designer: Ron Bilodeau\n\nIllustrator: Robert Romano\n\nThe O’Reilly logo is a registered trademark of O’Reilly Media, Inc. Beautiful\nVisualization, the cover image, and related trade dress are trademarks of\nO’Reilly Media, Inc.\n\nMany of the designations used by manufacturers and sellers to distinguish\ntheir products are claimed as trademarks. Where those designations appear in\nthis book, and O’Reilly Media, Inc. was aware of a trademark claim, the\ndesignations have been printed in caps or initial caps.\n\nWhile every precaution has been taken in the preparation of this book, the\npublisher and authors assume no responsibility for errors or omissions, or for\ndamages resulting from the use of the information contained herein.\n\nISBN: 978-1-449-37986-5\n\n\nPreface\n\nThis book found its beginnings as a natural outgrowth of Toby Segaran and Jeff\nHammerbacher’s [Beautiful Data](http://oreilly.com/catalog/9780596157111/)\n(O’Reilly), which explores everything from data gathering to data storage and\norganization and data analysis. While working on that project, it became clear\nto us that visualization—the practice of presenting information for\nconsumption as art—was a topic deep and wide enough to warrant a separate\nexamination. When done beautifully, successful visualizations are deceptive in\ntheir simplicity, offering the viewer insight and new understanding at a\nglance. We hoped to help those new to this growing field uncover the methods\nand decision-making processes experts use to achieve this end.\n\nParticularly intriguing when assembling a list of potential contributors was\nhow many ways the word beautiful can be interpreted. The book that founded\nthis series, Andy Oram and Greg Wilson’s [Beautiful\nCode](http://oreilly.com/catalog/9780596510046/) (O’Reilly), defined beauty as\na simple and elegant solution to some kind of problem. But visualization—as a\ncombination of information and art—naturally combines both problem solving and\naesthetics, allowing us to consider beauty in both the intellectual and\nclassic senses.\n\nWe hope you will be as delighted as we are by the diversity of backgrounds,\nprojects, and approaches represented in this book. Different as they are, the\nchapters do offer some themes to the thoughtful and observant. Look for ideas\nabout storytelling, color use, levels of granularity in the data, and user\nexploration woven throughout the book. Tug on these threads, and see where\nthey take you in your own work.\n\nThe royalties for this book are being donated to Architecture for Humanity\n(<http://www.architectureforhumanity.org>), an organization dedicated to\nmaking the world better by bringing design, construction, and development\nservices to the places where they are most critically needed. We hope you’ll\nconsider how your own design processes shape the world.\n\nHow This Book Is Organized\n\nHere’s a preview of what you’ll find in this book:\n\nChapter 1, [On Beauty](bv_ch01.xhtml#anchor-10-anchor), by Noah Iliinsky,\noffers an examination of what we mean by beauty in the context of\nvisualization, why it’s a worthy goal to pursue, and how to get there.\n\nChapter 2, [Once Upon a Stacked Time Series](bv_ch02.xhtml#anchor-anchor): The\nImportance of Storytelling in Information Visualization, by Matthias Shapiro,\nexplains the importance of storytelling to visualization and walks readers\nthrough the creation of a simple visualization project they can do on their\nown.\n\nChapter 3, [Wordle](bv_ch03.xhtml#anchor-anchor), by Jonathan Feinberg,\nexplains the inner workings of his popular method for visualizing a body of\ntext, discussing both the technical and aesthetic choices the author made\nalong the way.\n\nChapter 4, [Color: The Cinderella of Data Visualization](bv_ch04.xhtml#anchor-\nanchor), by Michael Driscoll, shows how color can be used effectively to\nconvey additional dimensions of data that our brains are able to recognize\nbefore we’re aware of it.\n\nChapter 5, [Mapping Information: Redesigning the New York City Subway\nMap](bv_ch05.xhtml#anchor-anchor), by Eddie Jabbour, explores the humble\nsubway map as a basic visualization tool for understanding complex systems.\n\nChapter 6, [Flight Patterns: A Deep Dive](bv_ch06.xhtml#anchor-anchor), by\nAaron Koblin with Valdean Klump, visualizes civilian air traffic in the United\nStates and Canada to reveal a method to the madness of air travel.\n\nChapter 7, [Your Choices Reveal Who You Are: Mining and Visualizing Social\nPatterns](bv_ch07.xhtml#anchor-anchor), by Valdis Krebs, digs into behavioral\ndata to show how the books we buy and the people we associate with reveal\nclues about our deeper selves.\n\nChapter 8, [Visualizing the U.S. Senate Social Graph\n(1991–2009)](bv_ch08.xhtml#anchor-anchor), by Andrew Odewahn, uses\nquantitative evidence to evaluate a qualitative story about voting coalitions\nin the United States Senate.\n\nChapter 9, [The Big Picture: Search and Discovery](bv_ch09.xhtml#anchor-\nanchor), by Todd Holloway, uses a proximity graphing technique to explore the\ndynamics of search and discovery as they apply to YELLOWPAGES.COM and the\nNetflix Prize.\n\nChapter 10, [Finding Beautiful Insights in the Chaos of Social Network\nVisualizations](bv_ch10.xhtml#anchor-anchor), by Adam Perer, empowers users to\ndig into chaotic social network visualizations with interactive techniques\nthat integrate visualization and statistics.\n\nChapter 11, [Beautiful History: Visualizing Wikipedia](bv_ch11.xhtml#anchor-\nanchor), by Martin Wattenberg and Fernanda Viégas, takes readers through the\nprocess of exploring an unknown phenomenon through visualization, from initial\nsketches to published scientific papers.\n\nChapter 12, [Turning a Table into a Tree: Growing Parallel Sets into a\nPurposeful Project](bv_ch12.xhtml#anchor-anchor), by Robert Kosara, emphasizes\nthe relationship between the visual representation of data and the underlying\ndata structure or database design.\n\nChapter 13, [The Design of “X by Y”: An Information-Aesthetic Exploration of\nthe Ars Electronica Archives](bv_ch13.xhtml#anchor-65-anchor), by Moritz\nStefaner, describes the process of striving to find a representation of\ninformation that is not only useable and informative but also sensual and\nevocative.\n\nChapter 14, [Revealing Matrices](bv_ch14.xhtml#anchor-85-anchor), by\nMaximilian Schich, uncovers nonintuitive structures in curated databases\narising from local activity by the curators and the heterogeneity of the\nsource data.\n\nChapter 15, [This Was 1994: Data Exploration with the NYTimes Article Search\nAPI](bv_ch15.xhtml#anchor-101-anchor), by Jer Thorp, guides readers through\nusing the API to explore and visualize data from the New York Times archives.\n\nChapter 16, [A Day in the Life of the New York\nTimes](bv_ch16.xhtml#anchor-92-anchor), by Michael Young and Nick Bilton,\nrelates how the New York Times R&D group is using Python and Map/Reduce to\nexamine web and mobile site traffic data across the country and around the\nworld.\n\nChapter 17, [Immersed in Unfolding Complex\nSystems](bv_ch17.xhtml#anchor-93-anchor), by Lance Putnam, Graham Wakefield,\nHaru Ji, Basak Alper, Dennis Adderton, and Professor JoAnn Kuchera-Morin,\ndescribes the remarkable scientific exploration made possible by cutting-edge\nvisualization and sonification techniques at the AlloSphere.\n\nChapter 18, [Postmortem Visualization: The Real Gold\nStandard](bv_ch18.xhtml#anchor-100-anchor), by Anders Persson, examines new\nimaging technologies being used to collect and analyze data on human and\nanimal cadavers.\n\nChapter 19, [Animation for Visualization: Opportunities and\nDrawbacks](bv_ch19.xhtml#anchor-101-anchor), by Danyel Fisher, attempts to\nwork out a framework for designing animated visualizations.\n\nChapter 20, [Visualization: Indexed.](bv_ch20.xhtml#anchor-109-anchor), by\nJessica Hagy, provides insight into various aspects of the “elephant” we call\nvisualization such that we come away with a better idea of the big picture.\n\nConventions Used in This Book\n\nThe following typographical conventions are used in this book:\n\nItalic\n\nIndicates new terms, URLs, email addresses, filenames, and file extensions.\nAlso used for emphasis in the text.\n\nConstant width\n\nUsed for program listings, as well as within paragraphs to refer to program\nelements such as variable or function names, databases, data types,\nenvironment variables, statements, and keywords.\n\nConstant width bold\n\nUsed for emphasis within code listings.\n\nConstant width italic\n\nShows text that should be replaced with user-supplied values or by values\ndetermined by context.\n\nUsing Code Examples\n\nThis book is here to help you get your job done. In general, you may use the\ncode in this book in your programs and documentation. You do not need to\ncontact us for permission unless you’re reproducing a significant portion of\nthe code. For example, writing a program that uses several chunks of code from\nthis book does not require permission. Selling or distributing a CD-ROM of\nexamples from O’Reilly books does require permission. Answering a question by\nciting this book and quoting example code does not require permission.\nIncorporating a significant amount of example code from this book into your\nproduct’s documentation does require permission.\n\nWe appreciate, but do not require, attribution. An attribution usually\nincludes the title, author, publisher, and ISBN. For example: “Beautiful\nVisualization, edited by Julie Steele and Noah Iliinsky. Copyright 2010\nO’Reilly Media, Inc., 978-1-449-37987-2.”\n\nIf you feel your use of code examples falls outside fair use or the permission\ngiven above, feel free to contact us at\n[permissions@oreilly.com](mailto:permissions@oreilly.com).\n\nHow to Contact Us\n\nPlease address comments and questions concerning this book to the publisher:\n\nO’Reilly Media, Inc.  \n1005 Gravenstein Highway North  \nSebastopol, CA 95472  \n800-998-9938 (in the United States or Canada)  \n707-829-0515 (international or local)  \n707-829-0104 (fax)\n\nWe have a web page for this book, where we list errata, examples, and any\nadditional information. You can access this page at:\n\n[http://www.oreilly.com/catalog/0636920000617\n](http://www.oreilly.com/catalog/0636920000617)\n\nTo comment or ask technical questions about this book, send email to:\n\n[bookquestions@oreilly.com](mailto:bookquestions@oreilly.com)\n\nFor more information about our books, conferences, Resource Centers, and the\nO’Reilly Network, see our website at:\n\n<http://www.oreilly.com>\n\nSafari® Books Online\n\n![Safari_Logo_BW.png](images/Safari_Logo_BW.png)\n\nSafari Books Online is an on-demand digital library that lets you easily\nsearch over 7,500 technology and creative reference books and videos to find\nthe answers you need quickly.\n\nWith a subscription, you can read any page and watch any video from our\nlibrary online. Read books on your cell phone and mobile devices. Access new\ntitles before they are available for print, and get exclusive access to\nmanuscripts in development and post feedback for the authors. Copy and paste\ncode samples, organize your favorites, download chapters, bookmark key\nsections, create notes, print out pages, and benefit from tons of other time-\nsaving features.\n\nO’Reilly Media has uploaded this book to the Safari Books Online service. To\nhave full digital access to this book and others on similar topics from\nO’Reilly and other publishers, sign up for free at\n<http://my.safaribooksonline.com>.\n\nAcknowledgments\n\nFirst and foremost, we both wish to thank the contributors who gave of their\ntime and expertise to share their wisdom with us. Their collective vision and\nexperience is impressive, and has been an inspiration in our own work.\n\nFrom Julie: Thanks to my family—Guy, Barbara, Pete, and Matt—for your constant\nsupport, and for being the first encouragers of my curiosity about the world.\nAnd Martin, for your companionship and never-ending flow of ideas; you inspire\nme.\n\nFrom Noah: Thanks to everyone who has supported me in this particular line of\ninquiry over the years, especially my teachers, colleagues, and family, and\neveryone who has asked good questions and made me think.\n\n\nChapter One\n\nOn Beauty\n\nNoah Iliinsky\n\nThis chapter is an examination of what we mean by beauty in the context of\nvisualization, why it’s a worthy goal to pursue, and how to get there. We’ll\nstart with a discussion of the elements of beauty, look at some examples and\ncounterexamples, and then focus on the critical steps to realize a beautiful\nvisualization.[1]\n\nWhat Is Beauty?\n\nWhat do we mean when we say a visual is beautiful? Is it an aesthetic\njudgment, in the traditional sense of the word? It can be, but when we’re\ndiscussing visuals in this context, beauty can be considered to have four key\nelements, of which aesthetic judgment is only one. For a visual to qualify as\nbeautiful, it must be aesthetically pleasing, yes, but it must also be novel,\ninformative, and efficient.\n\nNovel\n\nFor a visual to truly be beautiful, it must go beyond merely being a conduit\nfor information and offer some novelty: a fresh look at the data or a format\nthat gives readers a spark of excitement and results in a new level of\nunderstanding. Well-understood formats (e.g., scatterplots) may be accessible\nand effective, but for the most part they no longer have the ability to\nsurprise or delight us. Most often, designs that delight us do so not because\nthey were designed to be novel, but because they were designed to be\neffective; their novelty is a byproduct of effectively revealing some new\ninsight about the world.\n\nInformative\n\nThe key to the success of any visual, beautiful or not, is providing access to\ninformation so that the user may gain knowledge. A visual that does not\nachieve this goal has failed. Because it is the most important factor in\ndetermining overall success, the ability to convey information must be the\nprimary driver of the design of a visual.\n\nThere are dozens of contextual, perceptive, and cognitive considerations that\ncome into play in making an effective visual. Though many of these are largely\noutside the scope of this chapter, we can focus on two particulars: the\nintended message and the context of use. Keen attention to these two factors,\nin addition to the data itself, will go far toward making a data visualization\neffective, successful, and beautiful; we will look at them more closely a\nlittle later.\n\nEfficient\n\nA beautiful visualization has a clear goal, a message, or a particular\nperspective on the information that it is designed to convey. Access to this\ninformation should be as straightforward as possible, without sacrificing any\nnecessary, relevant complexity.\n\nA visual must not include too much off-topic content or information. Putting\nmore information on the page may (or may not) result in conveying more\ninformation to the reader. However, presenting more information necessarily\nmeans that it will take the reader longer to find any desired subset of that\ninformation. Irrelevant data is the same thing as noise. If it’s not helping,\nit’s probably getting in the way.\n\nAesthetic\n\nThe graphical construction—consisting of axes and layout, shape, colors,\nlines, and typography—is a necessary, but not solely sufficient, ingredient in\nachieving beauty. Appropriate usage of these elements is essential for guiding\nthe reader, communicating meaning, revealing relationships, and highlighting\nconclusions, as well as for visual appeal.\n\nThe graphical aspects of design must primarily serve the goal of presenting\ninformation. Any facet of the graphical treatment that does not aid in the\npresentation of information is a potential obstacle: it may reduce the\nefficiency and inhibit the success of a visualization. As with the data\npresented, less is usually more in the graphics department. If it’s not\nhelping, it’s probably getting in the way.\n\nOften, novel visual treatments are presented as innovative solutions. However,\nwhen the goal of a unique design is simply to be different, and the novelty\ncan’t be specifically linked to the goal of making the data more accessible,\nthe resulting visual is almost certain to be more difficult to use. In the\nworst cases, novel design is nothing more than the product of ego and the\ndesire to create something visually impressive, regardless of the intended\naudience, use, or function. Such designs aren’t useful to anyone.\n\nLearning from the Classics\n\nThe vast majority of mundane information visualization is done in completely\nstandard formats. Basic presentation styles, such as bar, line, scatter, and\npie graphs, organizational and flow charts, and a few other formats are easy\nto generate with all sorts of software. These formats are ubiquitous and\nprovide convenient and conventional starting points. Their theory and use are\nreasonably well understood by both visual creators and consumers. For these\nreasons, they are good, strong solutions to common visualization problems.\nHowever, their optimal use is limited to some very specific data types, and\ntheir standardization and familiarity means they will rarely achieve novelty.\n\nBeautiful visualizations that go on to fame and fortune are a different breed.\nThey don’t necessarily originate with conventions that are known to their\ncreators or consumers (though they may leverage some familiar visual elements\nor treatments), and they usually deviate from the expected formats. These\nimages are not constrained by the limits of conventional visual protocols:\nthey have the freedom to effectively adapt to unconventional data types, and\nplenty of room to surprise and delight.\n\nMost importantly, beautiful visualizations reflect the qualities of the data\nthat they represent, explicitly revealing properties and relationships\ninherent and implicit in the source data. As these properties and\nrelationships become available to the reader, they bring new knowledge,\ninsight, and enjoyment. To illustrate, let’s look at two very well-known\nbeautiful visualizations and how they embrace the structure of their source\ndata.\n\nThe Periodic Table of the Elements\n\nThe first example we’ll consider is Mendeleev’s periodic table of the\nelements, a masterful visualization that encodes at least four, and often nine\nor more, different types of data in a tidy table (see Figure 1-1). The\nelements have properties that recur periodically, and the elements are\norganized into rows and columns in the table to reflect the periodicity of\nthese properties. That is the key point, so I’ll say it again: the genius of\nthe periodic table is that it is arranged to reveal the related, repeating\nphysical properties of the elements. The structure of the table is directly\ndictated by the data that it represents. Consequently, the table allows quick\naccess to an understanding of the properties of a given element at a glance.\nBeyond that, the table also allows very accurate predictions of undiscovered\nelements, based on the gaps it contains.\n\n![bvis_0101.png](images/bvis_0101.png)\n\nFigure 1-1. A basic example of Mendeleev’s periodic table of the elements\n\nThe periodic table of the elements is absolutely informative, arguably\nefficient, and was a completely new approach to a problem that previously\nhadn’t had a successful visual solution. For all of these reasons, it may be\nconsidered one of the earlier beautiful visualizations of complex data.\n\nIt should be noted that the efficacy and success of the periodic table were\nachieved with the absolute minimum of graphical treatment; in fact, the\nearliest versions were text-only and could be generated on a typewriter.\nStrong graphic design treatment isn’t a requirement for beauty.\n\nThe London Underground Map\n\nThe second classic beautiful visualization we’ll consider is Harry Beck’s map\nof the London Underground (aka the Tube map—see Figure 1-2). The Tube map was\ninfluenced by conventions and standards for visuals, but not by those of\ncartography. Beck’s background was in drafting electrical circuits: he was\nused to drawing circuit layout lines at 45° and 90° angles, and he brought\nthose conventions to the Tube map. That freed the map of any attachment to\naccurate representation of geography and led to an abstracted visual style\nthat more simply reflected the realities of subway travel: once you’re in the\nsystem, what matters most is your logical relationship to the rest of the\nsubway system. Other maps that accurately show the geography can help you\nfigure out what to do on the surface, but while you’re underground the only\nsurface features that are accessible are the subway stations.\n\n![bvis_0102.png](images/bvis_0102.png)\n\nFigure 1-2. The London Underground (“Tube”) map; 2007 London Tube Map © TfL\nfrom the London Transport Museum collection (used with permission)\n\nThe London Underground map highlighted the most relevant information and\nstripped away much of the irrelevant information, making the pertinent data\nmore easily accessible. It was executed with a distinctive and unique\ngraphical style that has become iconic. It is widely recognized as a\nmasterpiece and is undoubtedly a beautiful visualization.\n\nOther Subway Maps and Periodic Tables Are Weak Imitations\n\nDue to the success of the periodic table and the London Underground map, their\nformats are often mimicked for representations of other data. There are\nperiodic tables of just about everything you can imagine: foods, drinks,\nanimals, hobbies, and, sadly, visualization methods.[2] These all miss the\npoint. Similarly, Underground-style maps have been used to represent movies of\ndifferent genres,[3] relationships among technology companies,[4] corporate\nacquisition timelines,[5] and the subway systems of cities other than London.\n\nOf these examples, the only reasonable alternate use of the latter format is\nto represent subways in other cities (many of these—Tokyo, Moscow, etc.—are\nquite well done). All the other uses of these formats fail to understand what\nmakes them special: their authentic relationships to and representations of\nthe source data. Putting nonperiodic data into a periodic table makes as much\nsense as sorting your socks by atomic number; there’s no rational reason for\nit because the structure you’re referencing doesn’t exist. Casting alternate\ndata into these classic formats may be an interesting creative exercise, but\ndoing so misses the point and value of the original formats.\n\nHow Do We Achieve Beauty?\n\nGiven the abundance of less-than-beautiful visualizations, it’s clear that the\npath to beauty is not obvious. However, I believe there are ways to get to\nbeauty that are dependable, if not entirely deterministic.\n\nStep Outside Default Formats\n\nThe first requirement of a beautiful visualization is that it is novel, fresh,\nor unique. It is difficult (though not impossible) to achieve the necessary\nnovelty using default formats. In most situations, well-defined formats have\nwell-defined, rational conventions of use: line graphs for continuous data,\nbar graphs for discrete data, pie graphs for when you are more interested in a\npretty picture than conveying knowledge.\n\nStandard formats and conventions do have their benefits: they are easy to\ncreate, familiar to most readers, and usually don’t need to be explained. Most\nof the time, these conventions should be respected and leveraged. However, the\nnecessary spark of novelty is difficult to achieve when using utilitarian\nformats in typical ways; defaults are useful, but they are also limiting.\nDefaults should be set aside for a better, more powerful solution only with\ninformed intent, rather than merely to provide variety for the sake of\nvariety.\n\nDefault presentations can also have hidden pitfalls when used in ways that\ndon’t suit the situation. One example that I encountered was on a\nmanufacturer’s website, where its retailers were listed alphabetically in one\ncolumn, with their cities and states in a second column. This system surely\nmade perfect sense to whoever designed it, but the design didn’t take into\naccount how that list would be used. Had I already known the names of the\nretailers in my area, an alphabetical list of them would have been useful.\nUnfortunately, I knew my location but not the retailer names. In this case, a\nlist sorted by the most easily accessible information (location) would have\nmade more sense than a default alphabetic sort on the retailer name.\n\nMake It Informative\n\nAs I mentioned earlier, a visualization must be informative and useful to be\nsuccessful. There are two main areas to consider to ensure that what is\ncreated is useful: the intended message and the context of use. Considering\nand integrating insight from these areas is usually an iterative process,\ninvolving going back and forth between them as the design evolves. Conventions\nshould also be taken into consideration, to support the accessibility of the\ndesign (careful use of certain conventions allows users to assume some things\nabout the data—such as the use of the colors red and blue in visuals about\nAmerican politics).\n\nIntended message\n\nThe first area to consider is what knowledge you’re trying to convey, what\nquestion you’re trying to answer, or what story you’re trying to tell. This\nphase is all about planning the function of the visual in the abstract; it’s\ntoo early to begin thinking about specific formats or implementation details.\nThis is a critical step, and it is worth a significant time investment.\n\nOnce the message or goal has been determined, the next consideration is how\nthe visualization is going to be used. The readers and their needs, jargon,\nand biases must all be considered. It’s enormously helpful in this phase to be\nspecific about the tasks the users need to achieve or the knowledge they need\nto take away from the visualization. The readers’ specific knowledge needs may\nnot be well understood initially, but this is still a critical factor to bear\nin mind during the design process.\n\nIf you cannot, eventually, express your goal concisely in terms of your\nreaders and their needs, you don’t have a target to aim for and have no way to\ngauge your success. Examples of goal statements might be “Our goal is to\nprovide a view of the London subway system that allows riders to easily\ndetermine routes between stations,” or “My goal is to display the elements in\nsuch a way that their physical properties are apparent and predictions about\ntheir behaviors can be made.”\n\nOnce you have a clear understanding of your message and the needs and goals of\nyour audience, you can begin to consider your data. Understanding the goals of\nthe visualization will allow you to effectively select which facets of the\ndata to include and which are not useful or, worse, are distracting.\n\nContext of use. It’s also important to recognize the distinction between\nvisuals designed to reveal what the designer already knows, and visuals\nintended to aid research into the previously unknown (though the designer may\nsuspect the outcome in advance). The former are tools for presentation; the\nlatter are tools for examination. Both may take standard or unconventional\nformats, and both benefit from the same process and treatments. However, it is\nimportant to be clear about which type of visual is being designed, as that\ndistinction affects all subsequent design choices.\n\nVisualizations designed to reveal what is already known are ubiquitous,\nappearing wherever one party has information to convey to another using more\nthan just text. Most graphs and charts that we encounter are meant to\ncommunicate a particular insight, message, or knowledge that is evident in the\nunderlying data: how a team is performing, how a budget is divided, how a\ncompany is organized, how a given input affects a result, how different\nproducts compare to each other, and so on. The data might reveal other\nknowledge or insights as well, but if they aren’t important for the purpose at\nhand, the design need not focus on revealing these other messages or trends.\nThe process of designing these visualizations is therefore aided by having a\nwell-defined goal.\n\nVisualizations designed to facilitate discovery are commonly found in more\nspecific, research-oriented contexts in science, business, and other areas. In\nthese cases, the goal is typically to validate a hypothesis, answer a specific\nquestion, or identify any trends, behaviors, or relationships of note.\nDesigning these visualizations can be more challenging if it’s unclear what\ninsights the data may reveal. In contexts where the shape of the answer is\nunknown, designing several different visualizations may be useful.\n\nThe periodic table is an interesting hybrid of these purposes, in that it was\nused to visualize both known and unknown information. The structure of the\ntable was defined by the properties of the elements known at the time, so in\nthat way it was a reference to existing knowledge, as it is used today.\nHowever, this structure resulted in gaps in the table, which were then used to\npredict the existence and behavior of undiscovered elements. In this latter\nmode, the table was a tool of research and discovery.\n\nMake It Efficient\n\nAfter ensuring that a visualization will be informative, the next step is to\nensure that it will be efficient. The most important consideration when\ndesigning for efficiency is that every bit of visual content will make it take\nlonger to find any particular element in the visualization. The less data and\nvisual noise there is on the page, the easier it will be for readers to find\nwhat they’re looking for. If your clearly stated goal can’t justify the\nexistence of some of your content, try to live without it.\n\nVisually emphasize what matters\n\nWhen you’ve identified the critically necessary content, consider whether some\nportion of it—a particular relationship or data point—is especially relevant\nor useful. Such content can be visually emphasized in a number of ways. It can\nbe made bigger, bolder, brighter, or more detailed, or called out with\ncircles, arrows, or labels. Alternately, the less-relevant content can be de-\nemphasized with less intense colors, lighter line weight, or lack of detail.\nThe zones in the Tube map, for example, are visually deemphasized: they exist,\nbut clearly aren’t as relevant as the Tube lines and stations.\n\nNote that this strategy of emphasizing relevance typically applies to\npresentation data, not research data: by changing the emphasis, the designer\nis intentionally changing the message. However, highlighting different facets\nor subsets of unknown data is a valid way to discover relationships that might\notherwise be lost in the overall noise.\n\nUse axes to convey meaning and give free information\n\nOne excellent method for reducing visual noise and the quantity of text while\nretaining sufficient information is to define axes, and then use them to guide\nthe placement of the other components of the visualization. The beauty of\ndefining an axis is that every node in a visualization can then assume the\nvalue implied by the axis, with no extra labeling required. For example, the\nperiodic table is made up of clearly defined rows (periods) and columns\n(groups). A lot of information can be learned about an element by looking at\nwhat period and group it occupies. As a result, that information doesn’t have\nto be explicitly presented in the element’s table cell. Axes can also be used\nto locate a portion or member of the dataset, such as looking for an element\nin a particular period, southern states, or a Tube station that is known to be\nin the northwest part of London.\n\nWell-defined axes can be effective for qualitative as well as quantitative\ndata. In qualitative contexts, axes can define (unranked or unordered) areas\nor groupings. As with quantitative axes, they can provide information and\nsupport the search for relevant values.\n\nSlice along relevant divisions\n\nOne last way to reduce visual clutter and make information more accessible is\nto divide larger datasets into multiple similar or related visualizations.\nThis works well if the information available can be used independently and\ngains little (or infrequent) value from being shown in conjunction with the\nother data in the set. The risk here is that there may be relevant,\nunsuspected correlations among seemingly unrelated datasets that will only\nbecome evident when all the data is displayed together.\n\nUse conventions thoughtfully\n\nAfter the influences of the intended message, context of use, and data have\nbeen taken into consideration for your unique situation, it’s worth looking\ninto applying standard representations and conventions. Intentional and\nappropriate use of conventions will speed learning and facilitate retention on\nthe part of your readers. In situations where a convention does exist, and\ndoesn’t conflict with one of the aforementioned considerations, applying it\ncan be extremely powerful and useful. The examples we’ve examined have used\ndefault, conventional representations for element symbols, subway line colors,\nand compass directions. Most of these seem too obvious to mention or notice,\nand that’s the point. They are easily understood and convey accurate\ninformation that is integrated extremely rapidly, while requiring almost no\ncognitive effort from the user and almost no creative effort from the\ndesigner. Ideally, this is how defaults and conventions should work.\n\nLeverage the Aesthetics\n\nOnce the requirements for being informative and efficient have been met, the\naesthetic aspects of the visual design can finally be considered. Aesthetic\nelements can be purely decorative, or they can be another opportunity to\nincrease the utility of the visualization. In some cases visual treatments can\nredundantly encode information, so a given value or classification may be\nrepresented by both placement and color, by both label and size, or by other\nsuch attribute pairings. Redundant encodings help the reader differentiate,\nperceive, and learn more quickly and easily than single encodings.\n\nThere are other ways in which aesthetic choices can aid understanding:\nfamiliar color palettes, icons, layouts, and overall styles can reference\nrelated documents or the intended context of use. A familiar look and feel can\nmake it easier or more comfortable for readers to accept the information being\npresented. (Care should be taken to avoid using familiar formats for their own\nsake, though, and falling into the same traps as the designers of the\nunfortunate periodic tables and Tube-style maps.)\n\nAt times, designers may want to make choices that could interfere with the\nusability of some or all of the visualization. This might be to emphasize one\nparticular message at the cost of others, to make an artistic statement, to\nmake the visualization fit into a limited space, or simply to make the\nvisualization more pleasing or interesting to look at. These are all\nlegitimate choices, as long as they are done with intention and understanding\nof their impact on the overall utility.\n\nPutting It Into Practice\n\nLet’s look at one more example of a successful, data-driven visualization that\nputs these principles to work: a map of the 2008 presidential election results\nfrom the New York Times.[6] Figure 1-3 is a standard map of the United States,\nwith each state color-coded to represent which candidate won that state (red\nstates were won by the Republican candidate, blue states by the Democratic\ncandidate). This seems like a perfectly reasonable visualization making use of\na default framework: a geographic map of the country. However, this is\nactually a situation in which an accurate depiction of the geography is\nirrelevant at best and terribly misleading at worst.\n\n![bvis_0103.png](images/bvis_0103.png)\n\nFigure 1-3. A geographically accurate electoral vote results map of the United\nStates\n\nNew Jersey (that peanut-shaped state east of Pennsylvania and south of New\nYork that’s too small for a label) has an area of a little more than 8,700\nsquare miles. The total combined areas of the states of Idaho, Montana,\nWyoming, North Dakota, and South Dakota is a bit more than 476,000 square\nmiles, about 55 times the area of New Jersey, as shown in Figure 1-4. If we\nwere interested in accurate geography and the shape, size, and position of the\nstates, this would be a fine map indeed. However, in the context of a\npresidential election, what we care about is relative influence based on the\nelectoral vote counts of each state. In fact, the combined total of those five\nstates is just 16 electoral votes, only one more than New Jersey’s 15 votes.\nThe geographically accurate map is actually a very inaccurate map of electoral\ninfluence.\n\n![bvis_0104.png](images/bvis_0104.png)\n\nFigure 1-4. Relative size of five states versus New Jersey\n\nThe surface area of a state has nothing to do with its electoral influence; in\nthis context, an entirely different sort of visualization is needed to\naccurately represent the relevant data and meet the goal of the visualization.\nTo this end, the Times also created an alternate view of the map (Figure 1-5),\nin which each state is made up of a number of squares equivalent to its\nelectoral vote value. This electorally proportionate view has lost all\ngeographic accuracy regarding state size, and almost all of it regarding\nshape. The relative positions of the states are largely retained, though,\nallowing readers to find particular states in which they may have interest and\nto examine regional trends. The benefit of sacrificing geography here is that\nthis visualization is perfectly accurate when it comes to showing the\nelectoral votes won by each party and each state’s relative influence. For\nexample, when we look at this new map, a comparison of the size of the five\nstates previously mentioned versus New Jersey now accurately depicts their 16\nto 15 electoral vote tallies, as shown in Figure 1-6.\n\n![bvis_0105.png](images/bvis_0105.png)\n\nFigure 1-5. A proportionally weighted electoral vote results map of the United\nStates\n\n![bvis_0106.png](images/bvis_0106.png)\n\nFigure 1-6. Relative electoral vote influence of five states versus New Jersey\n\nYou may have noticed that another trade-off was made here: because readers\ncan’t see the outlines of each individual square, they can’t easily count the\n15 or 16 squares in each of the areas we’re comparing. Also, because a\ndecision was made to retain the shape of each state to the extent possible,\nthe aggregated red and blue blocks in Figure 1-6 are shaped very differently\nfrom each other, making it difficult to compare their relative areas at a\nglance. So, this is a great example of the necessary balancing act between\nmaking use of conventions (in this case, the shape of the states) and\npresenting data efficiently and without decoration.\n\nThe success of this visualization is due to the fact that the designers were\nwilling to move away from a standard, default map and instead create a visual\nrepresentation based primarily on the relevant source data. The result is a\nhighly specialized image that is much more accurate and useful for its\nintended purpose, even if it’s not very well suited for typical map tasks such\nas navigation. (In that way, it is similar to the Tube map, which is optimized\nfor a very particular style of information finding, at the expense of general-\npurpose geographical accuracy.)\n\nConclusion\n\nWhile this has been a brief treatment of some of the strategies and\nconsiderations that go into designing a successful visualization, it is a\nsolid foundation. The keys to achieving beauty are focusing on keeping the\nvisualization useful, relevant, and efficient, and using defaults and\naesthetic treatments with intention. Following these suggestions will help\nensure that your final product is novel, informative, and beautiful.\n\n[1] I use the words visualization and visual interchangeably in this chapter,\nto refer to all types of structured representation of information. This\nencompasses graphs, charts, diagrams, maps, storyboards, and less formally\nstructured illustrations.\n\n[2] See <http://www.visual-literacy.org/periodic_table/periodic_table.html>.\n\n[3] See <http://blog.vodkaster.com/2009/06/25/the-top-250-best-movies-of-all-\ntime-map/>.\n\n[4] See <http://informationarchitects.jp/wtm4/>.\n\n[5] See <http://www.meettheboss.com/google-acquisitions-and-investments.html>.\n\n[6] Source: <http://elections.nytimes.com/2008/president/whos-ahead/key-\nstates/map.html>.\n\n\nChapter Two\n\nOnce Upon a Stacked Time Series\n\nThe Importance of Storytelling in Information Visualization\n\nMatthias Shapiro\n\nThe art of information visualization is something of a strange beast. Very few\ndisciplines require such a range of skills from their practitioners. The best\nvisualizations not only require several talents, but may require their\ncreators to move between these different talents quickly. Furthermore, during\nthe process of creating the final visual, the creators may realize that\ncertain information that was discarded early on is vital to a full\nunderstanding, or that a calculation made early in the process did not produce\nan accurate result.\n\nIn his exceptional book [Visualizing\nData](http://oreilly.com/catalog/9780596514556/) (O’Reilly), Ben Fry\nidentifies seven stages of creating an information visualization: acquire,\nparse, filter, mine, represent, refine, and interact. Each stage requires a\ncertain level of technical or artistic talent, and information visualization\nnecessitates the close integration of these talents. When acquiring and\nparsing the data, the information visualization artist may be imagining how to\ninteract with it. As he refines the representation, he may recall a step in\nthe filtering process that excluded data that turns out to be relevant. The\nbest visualizations tend to be dreamed up and executed by either single\nindividuals with abilities across a wide range of disciplines, or small teams\nworking very closely together. In these small, agile environments, the full\nrange of talents can intersect and produce a stunning image or interactive\nproduct that can communicate a concept in a way that is more natural to human\ncomprehension than a string of digits.\n\nWhile many of the talents required for creating good information\nvisualizations are widely recognized, there is one that is commonly overlooked\nin more formal settings—probably because nearly every visualization author\nengages in it subconsciously and because it is such a natural part of the\nprocess that is hardly seems worth mentioning. This talent is the art of\nstorytelling.\n\nStories have a marvelous way of focusing our attention and helping us to\ndiscern why the data presented is important or relevant to some part of our\nlives. It is only inside of a context that data is meaningful, and using the\ndata as part of a story is an excellent way of allowing the data to make a\nlasting impact. The most effective information visualizations will make\nthemselves a pivotal point in a story or narrative within the viewers’ (or\nusers’) minds.\n\nNot every information visualization requires a story. Some are simply\nbeautiful to look at and can exist merely as fine works of art. However, most\nvisualizations have a goal or purpose and present their data in a meaningful\nway, in the context of some kind of story.\n\nQuestion + Visual Data + Context = Story\n\nMost visualization stories begin with some kind of question that orients the\nviewer to the topic and context within which the data is most meaningful. This\ncan be done explicitly or implicitly, but the context must be clear. The\nquestion contains the premise and introduction to the story, and leads us up\nto the point at which the data can take over the storyline.\n\nMany of the key parts of a story are related as part of the process of placing\nthe visualization in a context. We frequently find the visualization context\nas part of an introductory text to an infographic or visualization. The\ncontext provides information that answers questions such as:\n\n  * What data are we looking at?\n  * In what time frame does this data exist?\n  * What notable events or variables influenced the data?\n\nConsider the visualization in Figure 2-1. Assuming the user is coming to this\nfrom a place of relative ignorance, we can be confident only that he will\nunderstand that the data is mapped along a timeline and that the timeline is\nin some way relevant to an election. Outside of that, there is almost no\nvaluable context to guide the user in making sense of this visualization.\n\n![bvis_0201.png](images/bvis_0201.png)\n\nFigure 2-1. Visualization from Designer Silverlight[1]\n\nIf we take a step forward and assume that our user is familiar with some of\nthe more famous names on the visualization, we can assume he will know that\nthis visualization measures some metric related to presidential candidates in\nthe two years preceding the 2008 U.S. presidential election.\n\nThe full context is only revealed if the user clicks on the question mark in\nthe upper-right corner, at which point he is informed that the visualization\nmaps the number of times each presidential candidate was mentioned in the New\nYork Times in a given week. Once this information is revealed, the user can\nsee that this is a rough map of newsworthiness as determined by the New York\nTimes writers.\n\nReturning to the questions listed previously, we now know what data we’re\nlooking at and what the time frame is. This visualization is interactive: if\nthe user presses the “Play” button at the top, dots along the timeline pop out\nto reveal important events that may have influenced the data one way or\nanother (Figure 2-2).\n\n![bvis_0202.png](images/bvis_0202.png)\n\nFigure 2-2. The visual draws attention to important events that may have\ninfluenced the perceived newsworthiness of the candidates\n\nIn addition to these cues, the user can draw on his knowledge of the\npresidential race to supply additional context to the data. He may recall that\nin the Democratic party there was a knock-down, drag-out primary contest\nbetween Hillary Clinton and Barack Obama, which is reflected in the fact that\nthey maintained a high level of newsworthiness into April and May of 2008,\nwhile John McCain (who secured the Republican nomination in early March)\nlagged behind them both.\n\nFrom the question “How often did the New York Times mention each candidate\nduring the course of the 2008 presidential campaign?,” a story emerges. This\nvisualization provides an engaging visual component to that story and helps\nthe user relive the drama of the two-year presidential campaign in the space\nof a minute.\n\nSteps for Creating an Effective Visualization\n\nWhen creating an information visualization, I typically walk through the\nfollowing key steps:\n\n1\\. Formulate the question.\n\n2\\. Gather the data.\n\n3\\. Apply a visual representation.\n\nFormulate the Question\n\nAsking the question that drives the story you’re trying to tell is not\nnecessarily a task that must be done at the beginning of the visualization\njourney. Don’t feel bad if you start digging into the data before you have a\nfinalized question in your head. Often, it is not until we have a good\nunderstanding of the data that we know how to ask a good question about it.\nHowever, asking a question (or at least keeping a question or set of questions\nin mind) can be useful when gathering and filtering the necessary data.\n\nYou may want to start with a topic to focus your data search and refine your\nquestion as you gather more data. For example, let’s say we want to\ncommunicate that carrying out the U.S. Census is an enormous task. This is a\ngood topic to start us out in our data search because it is broad enough that\nthere are many pieces of data that can help give context to this idea. We\ncould find the relevant data and create a visualization based on:\n\n  * The number of surveys filled out\n  * The number of pencils used\n  * The number of miles census workers walked\n\nMy favorite U.S. Census–related data to watch is the number of federal\nemployees over time. Statistics show a spike of 200,000–300,000 federal\nemployees between March and July of a census year. These employment figures\nthen drop off as the census process completes.\n\nThe specific question that we ultimately ask will have a heavy impact on the\nfinal representation of the visual. For example, we might ask “How much paper\ndoes it take to record all the information necessary for a census?” and show\nsheets of paper covering a small city as a representation of the surveys, or\nwe might ask “How many people does it take to count everyone in the country?”\nand use icons of people to represent the spike in federal employment figures\nat census time. These questions both relate to the original topic of the scope\nof the U.S. Census, but they draw from different sets of data and result in\ndrastically different visuals.\n\nWhen asking a question for the purposes of creating an information\nvisualization, we should focus on questions that are as data-centric as\npossible. Questions that begin with “where,” “when,” “how much,” or “how\noften” are generally good starting points: they allow us to focus our search\nfor data within a specific set of parameters, so we’re more likely to find\ndata that lends itself to being mapped visually.\n\nBe especially careful if you find your question starts with “why.” This is a\ngood sign that you are moving from a more formal portrayal of data into data\nanalysis.\n\nGather the Data\n\nFinding exactly the data you want can be a difficult task. Often, instead of\ntrying to gather your own data, you’re better off taking data that is already\navailable and trying to find a way to portray it. That is, it may be better to\nstart (as mentioned earlier) with a dataset and construct a question as you\nfind patterns in the data. If you’re creating a data visualization for a\npurpose other than as a hobby or out of pure curiosity, it is likely that you\nalready have a dataset to work from. However, there are still several datasets\navailable that may inspire or inform some aspect of your work.\n\nThere are many good places to start looking at data. One of the largest and\nmost diverse repositories can be found at Data.gov (<http://www.data.gov>).\nThis site houses an enormous collection of data, from migratory patterns of\nbirds to patent bibliographies to Treasury rate statistics and federal budget\ndata.\n\nOther excellent sources of data include:\n\n  * The Census Bureau (<http://www.census.gov>) for a wide variety of demographic and geographic data \n  * The Bureau of Labor Statistics (<http://www.bls.gov>) for extensive data on employment in the United States (click on the “Databases and Tables” tab and scroll down to the Historical News Release Tables for the easiest access to the data)\n  * The New York Times APIs (<http://developer.nytimes.com>) for easy API access to huge sets of data including congressional votes, bestseller lists, article searches, movie reviews, real estate listings and sales in New York City, and more\n\nOnce you have the raw data, you may want parse it, organize it, group it, or\notherwise alter it so that you can identify patterns or extract the specific\ninformation you wish to portray. This process is known as “data munging” and\nis usually an ad hoc attempt to “play around” with the data until interesting\npatterns emerge. If this process sounds a little opaque or nonspecific, don’t\nworry; we’ll walk through an example of data munging in the hands-on tutorial\nin the next section.\n\nApply a Visual Representation\n\nNow that we have the data, we come to the task of deciding how to portray it.\nThis means making decisions about what kind of visual representation of the\ndata will aid viewers in understanding it.\n\nA visual representation is some kind of visual dimension that can change in\ncorrespondence to the data. For example: an XY graph is a simple visual\npresentation that maps an x, y data point in a two-dimensional plane. Map\nenough points, and an obvious visual pattern may emerge even if there is no\nimmediately identifiable pattern in the raw data itself.\n\nLet’s take a look at the most commonly used visual representations.\n\nSize\n\nSize is probably the most commonly used visual representation, and for good\nreason. When differentiating between two objects, we can judge very quickly\nbetween sizes. Moreover, using size helps cut through the fog of comparing two\nunfamiliar numbers. It is one thing to hear or read that methadone is the most\nlethal recreational drug in the UK and quite another to see that information\nin the context of deaths caused by other dangerous drugs, as shown in Figure\n2-3.\n\n![bvis_0203.png](images/bvis_0203.png)\n\nFigure 2-3. From David McCandless’s information visualization “World’s\nDeadliest Drugs”�\n\nWhile size is an extremely useful and intuitive representation, it is also\noften overused. Many poorly constructed graphs misinform and confuse simply\nbecause their creators wanted to visualize some data, but knew of only one way\nto visually present it.\n\nColor\n\nColor is a fantastic representation method for enormous sets of data. We can\nidentify many gradations and shades of color and can see differences in a high\nresolution. This makes color a natural choice for representing big-picture\ntrends, like what we might see in weather maps. For this reason, it is\ncommonly used for identifying patterns and anomalies in large datasets.\n\nFigure 2-4 is a zoomed-out view of a set of data about stocks over the course\nof just over three months.\n\n![bvis_0204.png](images/bvis_0204.png)\n\nFigure 2-4. The 30 most watched Motley Fool CAPS stocks tracked over several\nmonths and visualized using a red-to-green color scale\n\nEven though the type is far too small to read, we can easily recognize rows\nthat show positive or negative growth. We can also make an overall assessment\nof the trends in the data with very little intellectual effort expended.\n\nColor is less useful for smaller datasets or data that is differentiated by\nsmall ranges. If there are not stark ranges in the data, it can be difficult\nfor even a trained eye to spot important differences.\n\nAs an example, let’s assume a dataset with a range between 1 and 100 and a\ncolor scheme that ranges from red (representing 1) to yellow (50) to green\n(100). In such a scheme, consider the 10-point difference in Figure 2-5. As\nyou can see, the difference is subtle and may not be easily distinguishable to\nmany viewers.\n\n![bvis_0205.png](images/bvis_0205.png)\n\nFigure 2-5. Color image representing the difference between 45% and 55% in a\ncolor visualization\n\nIf you’re creating a visualization in which it is important for viewers to be\nable to distinguish between data points at 45% and 55%, you may need to alter\nthe points at which the colors change or steer away from using color as your\nprimary representation method.\n\nA word should also be put in for those who suffer from colorblindness, which\naffects nearly 1 out of 10 individuals. If you need your visualization to\nreach the largest possible audience, you may want to consider using ranges\nlike black-to-white instead of green-to-red. For more information about design\nand colorblindness, consider visiting We Are Colorblind\n(<http://wearecolorblind.com>), a website devoted to designing in a way that\nis accessible to the colorblind.\n\nLocation\n\nA location representation method attaches data to some kind of map or visual\nelement corresponding to a real or virtual place. An everyday example of a\nlocative visualization is when we are presented with a simple outline of an\nairplane or a theater in order to choose a seat.\n\nIn Figure 2-6, we see the county-by-county crime rates for 1996 and 2008\nrendered onto a map of Florida.\n\n![bvis_0206.png](images/bvis_0206.png)\n\nFigure 2-6. Florida county map shaded to indicate crime rate by county\n\nLocation presentation methods are especially valuable when the audience has\nsome familiarity with the location being portrayed. Such familiarity allows\nthe audience members to project their personal contexts onto the visualization\nand draw conclusions based on their personal experience with the area.\n\nNetworks\n\nA network presentation shows binary connections between data points and can be\nhelpful in viewing the relationships between those data points. A number of\nonline network visualizations have sprung up that allow people to see maps of\ntheir friends on Facebook or their followers on Twitter.\n\nFigure 2-7 shows a network visualization of my Facebook friends and how many\nof them have “friended” one another.\n\nThrough this network mapping, we can perceive at a glance the different social\nnetworks to which I belong (or belonged). Furthermore, the density of the\ngroups corresponds fairly well to the social intimacy of those groups.\n\nOne thing to keep in mind with network visualizations is that if they are not\ncarefully constructed, the thousands of data points may just turn into a\nvisually messy glob of connections that isn’t helpful in increasing our\nunderstanding of how those connections are meaningful.\n\n![bvis_0207.png](images/bvis_0207.png)\n\nFigure 2-7. Nexus rendering of a network visualization of my Facebook friends\n\nTime\n\nData that changes over time (stock quotes, poll results, etc.) is\ntraditionally portrayed along a timeline. In recent years, though, software\nwith animation capabilities has allowed us to portray such data in a different\nmanner. Animations like the New York Times’s “Twitter Chatter During the Super\nBowl”[2] (shown in Figure 2-8) compress a longer period of time so that we can\nwatch the data change in an accelerated environment.\n\nPressing the “Play” button in the top-left corner starts the animation, and\nthe most popular words used in Super Bowl–related tweets across the country\ngrow and shrink according to their frequency of use through the course of the\ngame.\n\nThis visualization gives users a series of helpful contextual clues along the\ntimeline indicating when major events happened in the game. By doing this, the\nauthors provide valuable context and relieve the users from the task of\nremembering how the game played out. Instead, they can focus on the words\nbeing used in tweets across the country and let the application alert them\nwhen a key event is driving the data.\n\n![bvis_0208.png](images/bvis_0208.png)\n\nFigure 2-8. New York Times visualization of commonly used words in 2009 Super\nBowl–related tweets\n\nUsing multiple visual presentation methods\n\nMany excellent information visualizations use more than one of these visual\npresentation methods to give a full picture of the data. In the online\napplication NameVoyager (<http://www.babynamewizard.com/voyager>), users can\ntype in the first few letters of a name and see a history of how many people\nhave given their child a name beginning with those letters (Figure 2-9).\n\n![bvis_0209.png](images/bvis_0209.png)\n\nFigure 2-9. The NameVoyager baby name explorer charts name frequency by year\n\nHere, two visual dimensions are presented. The first is time: we see the\nfrequency with which names beginning with the entered letters were used\nrepresented along a timeline. The second is size: shaded areas on the graph\nindicate how many children were given certain names in certain years.\n\nThis particular type of graph is called a stacked time series and is a fairly\nstandard way of visualizing several pieces of information in a combined but\nseparate manner.\n\nHands-on Visualization Creation\n\nNow that we’ve covered the basics of information visualization in a general\nmanner, let’s walk through the process of building a visualization. We’ll\ncreate a static visualization, commonly referred to as an infographic.\n\nTo do this walkthrough, we will need the following tools:\n\n  * Microsoft Excel (or Google Documents in a pinch)\n  * Adobe Photoshop (GIMP, a free image-manipulation program, will also work)\n\nIn order to replicate the process as closely as possible, I’ll walk through\nthe discovery process in the order in which it actually happened rather than\nfollowing the “Question-Data-Presentation” method described earlier.\n\nData Tasks\n\nWhen constructing this tutorial visualization, I started out messing around\nwith the data and formulated the question as the shape of the information\nbecame clear. Because the process of sifting through data is often very ad\nhoc, I’ll simply describe my discovery in general terms. We’ll walk through\nthe details later in this section.\n\nGathering the data\n\nI decided to use easily accessible, publicly available data for this tutorial,\nso I started looking at a number of pieces of data collected by the U.S.\ngovernment and placed online in the interest of transparency. I settled on\ndata about vehicles traded in and purchased via the Car Allowance Rebate\nSystem (CARS), commonly referred to as the “Cash for Clunkers” program. The\ndata I used is available in two separate Excel files at\n<http://www.cars.gov/carsreport>. It is also available in CSV or MDB format.\n\nSorting the data: The discovery version\n\nWhen we’re done with this visualization, we want to feel like it provides some\nkind of insight into the individual transactions that make up this dataset. We\ncan imagine someone driving in a beat-up clunker thinking to herself that she\nwill soon be able to rid herself of her old, inefficient vehicle and replace\nit with a beautiful new one.\n\nWhat kind of vehicle is she driving? Is she looking to replace it with\nsomething similar but newer and more efficient (an “old sedan to new sedan”\ntrade)? Or does she want to swap her vehicle for something totally different\n(a trade more along the lines of “SUV for two-door coupe”)?\n\nThe data we’re looking at is the result of over 650,000 individual stories\nthat each required motivation, drive, time, and effort to report. We won’t be\nable to tease out those individual stories from the data, but our\nvisualization will help tell a larger story about those people’s choices. Our\ngoal is to find a way to tell a story that is interesting and new to our\nusers/viewers.\n\nHere are the steps I took in sorting and filtering through the data as I was\ntrying to discover that story.\n\nAfter downloading the dataset, I started looking at the trade-in data and\ntried to group it in many different ways. Grouping it by car model seemed\ninteresting at first, but this was somewhat tedious because the vehicles are\ngrouped by engine and transmission type, so the same model might have several\ndifferent entries.\n\nHowever, in the process of looking at the vehicles by model, I was struck by\nthe fact that several makes had a fairly high number of trade-ins. I became\ncurious to see if people were more eager to trade one make of vehicle over\nanother, so I began sorting the vehicles by make.\n\nWarning: Asking questions like “are people eager to trade in one make over\nanother?” is a dangerous thing to do when creating a visualization. The data\ncan tell us a large number of things, but it is rare that data will give us\ngood information on things that are as complex as human motivation. It is one\nthing to portray the data as it is and another thing to interpret what the\ndata means. It would be a mistake to state as a part of your visualization\nthat, because more Ford vehicles were traded in than any other make, people\nwere eager to get rid of Fords. Such a statement would dismiss dozens of\nimportant variables, including things like market share, type of vehicles\nsold, Ford’s position in large vehicle sales, age of the vehicles, etc. It is\na good rule of thumb to restrict a visualization to stating things that can be\nseen from the data alone and allow the users or viewers to draw their own\nconclusions.\n\nWith all of that said, asking these kinds of questions internally can be an\neffective driver for discovery, so don’t shy away from asking them at this\nearly stage—just shy away from answering them in the final visual.\n\nI began sorting vehicles by make and tallying up the sums for the trade-in\nvehicles, and I thought it would be interesting to see a comparison of the\nmakes of the trade-ins (Honda, Toyota, GM, Ford, Chrysler) versus the makes of\nthe new vehicles purchased. As I started collecting that data, it became clear\nthat there were so many vehicle makes, it would be difficult to clearly\nportray that many separate data points. As a result, I started trying to group\nby “parent make”—i.e., grouping together vehicle makes by the companies that\nowned those makes. For example, Lexus is a division of Toyota, so I grouped\nLexus and Toyota trade-ins together under the parent company, Toyota.\n\nEventually, I decided that the most compelling portrayal of the information\nwould be to group the makes together under the parent country. This approach\nhas the benefit of reducing the number of data points to about a dozen, as\nwell as grouping the information in a way that isn’t immediately apparent in\nthe data. By doing this, we’re able to get a new and fresh look at the data.\n\nSorting the data: The technical version\n\nNow that we’ve walked through the thought process, let’s walk through\nreplicating that process in the files.\n\nIf you download the Excel files, you can open them up and see that the data is\narranged first by vehicle category (with trucks first and cars second) and\nthen alphabetically by vehicle make (Acura, Audi, BMW, and so on). In order to\nsort the data for our purposes, the easiest thing to do will be to categorize\nthe data by vehicle make. Later, we will determine which makes correspond to\nthe various countries in which the parent companies are based.\n\nTo sort the data in Excel, simply select the New_Vehicle_Make column in the\nnew-vehicles file or the Trade_in_make column in the trade-in-vehicles file\nand select “Sort & Filter->Sort A to Z.” If Excel asks you if you want to\nexpand the selection, accept that option.\n\nYou can add together all the cars purchased or traded for a particular make by\nentering =SUM( and using the mouse to select all the cells in the Count column\nfor a particular make. As a method of checking your first attempt, add up all\nthe Acura purchases. The result should be 991. Gather sums for all the makes\nand, if it helps you to look at the data, move the results to another page.\n\nThis is the perfect time to play around with the data if you’re so inclined.\nTry to figure out which cars sold the best, or which year’s models were traded\nin the most frequently. Even in a dataset as small as this one, there are\ndozens of interesting questions to ask. One of them might pop out at you and\ninspire a new and compelling visualization. At the very least, this is an\nexcellent opportunity to practice looking at data.\n\nThere are many ways to sort this kind of data. It might be more efficient (and\nwould certainly be impressive) to write a script or small program that walks\nthrough the CSV file and pulls the data into a summary file that is easy to\nlook at. The reason for using Excel in this example was to try to help people\nwho are not familiar with programming engage with the data and participate in\ncreating visualizations.\n\nFormulating the Question\n\nAt this point in the process, we should have a firm enough grasp of what we\nwant to do that we can formulate a solid question for this visualization. Our\nquestion is, “In the ‘Cash for Clunkers’ program, what proportion of vehicles\nwere purchased from manufacturers based in which countries?”\n\nWithin the context of this question, we can choose to establish a number of\nrelevant pieces of information as an appropriate setup for the visualization,\nkeeping in mind that our target audience may not be intimately familiar with\nthe topic. Here are a few items that will help contextualize the data:\n\n  * The program cost $2,850,162,500 and provided money for 677,081 vehicle purchases.\n  * For each vehicle that was purchased, a vehicle was traded in and scrapped.\n  * The program ran from July 1, 2009 until August 24, 2009.\n  * Vehicles eligible for trade-in had to get less than 18 miles per gallon (MPG).\n  * Vehicles eligible for purchase had to get more than 22 MPG.\n\nFor the purposes of this visualization, we’re most interested in the fact that\nthere was a correspondence between vehicles purchased and vehicles scrapped.\nThis creates an interesting balance (and hence a certain kind of drama)\nbetween the kinds of vehicles people wanted to get rid of and the vehicles\nthey wanted to purchase. As we put together the data and visualization, we’ll\nkeep this balance in mind and orient the visuals accordingly.\n\nWith the question in hand, we have a solid basis for manipulating the data\nfurther by grouping and sorting it as guided by our question.\n\nGrouping the data\n\nThis step takes a little bit of research. In order to group the makes by\ncountry, we need to find out which vehicle makes correspond to which\ncompanies. There are over 50 makes represented in these two files, so the\nresearch could take some time. In this task, Wikipedia is your friend since it\nwill provide quick answers regarding the ownership of various vehicle makes\n(for example, Chrysler owns or owned six makes that are represented in this\ndataset) as well as the countries in which they are headquartered.\n\nI’ve provided a helpful table containing this data, to save you time (Table\n2-1).\n\nTable 2-1. Vehicles grouped by make, company, and country  \n---  \nMake |  Owned by |  Country |  Make |  Owned by |  Country  \nJaguar |  Tata |  England |  Hyundai |  Hyundai |  South Korea  \nLand Rover |  Tata |  England |  Kia |  Hyundai |  South Korea  \nBMW |  BMW |  Germany |  Volvo |  Volvo |  Sweden  \nMINI |  BMW |  Germany |  Saab |  |  Sweden  \nMercedes-Benz |  Daimler |  Germany |  American Motor |  Chrysler |  U.S.  \nsmart |  Daimler |  Germany |  Chrysler |  Chrysler |  U.S.  \nAudi |  Volkswagen |  Germany |  Dodge |  Chrysler |  U.S.  \nPorsche |  Volkswagen |  Germany |  Eagle |  Chrysler |  U.S.  \nVolkswagen |  Volkswagen |  Germany |  Jeep |  Chrysler |  U.S.  \nAcura |  Honda |  Japan |  Plymouth |  Chrysler |  U.S.  \nHonda |  Honda |  Japan |  Ford |  Ford |  U.S.  \nIsuzu |  Isuzu |  Japan |  Lincoln |  Ford |  U.S.  \nMazda |  Mazda |  Japan |  Mercury |  Ford |  U.S.  \nMitsubishi |  Mitsubishi |  Japan |  Merkur |  Ford |  U.S.  \nInfiniti |  Nissan |  Japan |  Buick |  GM |  U.S.  \nNissan |  Nissan |  Japan |  Cadillac |  GM |  U.S.  \nSubaru |  Subaru |  Japan |  Chevrolet |  GM |  U.S.  \nSuzuki |  Suzuki |  Japan |  GMC |  GM |  U.S.  \nLexus |  Toyota |  Japan |  Hummer |  GM |  U.S.  \nScion |  Toyota |  Japan |  Oldsmobile |  GM |  U.S.  \nToyota |  Toyota |  Japan |  Pontiac |  GM |  U.S.  \n|  |  |  Saturn |  GM |  U.S.  \n  \nKeep in mind, however, that grouping the makes this way raises some questions\nabout the data that we’ll need to answer before we continue. For example,\nJaguar is a quintessentially British company with its headquarters in England.\nNevertheless, it is owned by the Indian company Tata Motors. Should we\ncategorize Jaguar as an English car or an Indian one?\n\nThe “correct” method of dealing with these kinds of questions is largely a\nmatter of personal preference. The important thing to remember is to maintain\nconsistency in the representation of this decision and to indicate to the\nviewer that you have made the decision one way or another. Usually, a footnote\nat the corner of the visualization is sufficient.\n\nApplying the Visual Presentation\n\nAt this point, we should have all of our data in exactly the format we want:\nvehicles traded or purchased, organized by country. It’s time to choose our\nvisual presentation of the data.\n\nWe’ll be representing two dimensions of information in this visualization. The\nfirst is the quantity of cars organized by country, and the second is a visual\ndifferentiation between cars purchased and cars traded in. The differentiation\nbetween purchased vehicles and “clunked” vehicles is an “either-or”\ndifferentiation, so there won’t be any gradations in the information, which\nwill simplify the presentation. To differentiate between vehicles purchased\nand traded, we can use a simple color method: red to represent “traded” and\ngreen to represent “purchased.”\n\nSince we’re dealing with a few points of data with enormous variation, it\nmakes the most sense to use size to represent the information. This\npresentation choice will call attention to the scope of this variation in an\nintuitive and compelling way. The easiest implementation will be to use\ncircles or bars of varying sizes to represent the numbers of trades and\npurchases.\n\nA note about area and circles\n\nIf we’re using circles to represent the data, we need to remember that we’re\ngoing to be varying the area, not the radius or diameter, of the circle. If we\ntake the number of U.S. vehicles purchased (575,073) and choose to represent\nit with a radius of 50 pixels, we will use the following equation in Excel to\ndetermine the size of each of the other circles:\n\nSQRT((US_Baseline_Radius^2 * Target_Vehicles)/US_Vehicles)\n\nI’m taking the time to point this out because this is probably one of the most\ncommon mistakes when creating information visualizations with circles or with\narea in general. Scaling a circle by linearly increasing the radius or\ndiameter will result in exponential increases and decreases of the area of the\ncircle, as shown in Figure 2-11; the correct relationship is shown in Figure\n2-10.\n\n![bvis_0210.png](images/bvis_0210.png)\n\nFigure 2-10. Correct (scaling the area)\n\n![bvis_0211.png](images/bvis_0211.png)\n\nFigure 2-11. Incorrect (scaling the radius)\n\nHaving said all of that, we’re not going to use circles. Don’t worry, I have a\ngood reason.\n\nPresenting the data with country maps\n\nSince our information story centers on countries, we’re going to use shape\nmaps of the various countries and size those maps appropriately. This provides\na couple of valuable additions to our visualization.\n\nFirst, using the shapes of the countries will give this project a visual hook.\nIf their home countries are on the list, the viewers will be able to pick them\nout immediately and it will draw their attention. Along these same lines, we\nwill be able to hook into any emotions our users may have concerning their\nhome countries or any other countries with which they are familiar. A hook\nlike this makes it more likely that the audience will remember or recommend\nthe visualization.\n\nSecond, using country shapes instead of circles will enable the visualization\nto communicate at a number of different sizes. Even at thumbnail size, the\nshape of a country is so recognizable that the users will know that the\nvisualization has something to do with different countries. A set of circles\nreduced down to thumbnail size just looks like a set of circles.\n\nThird, if we used only circles or bars, we would be reliant on text to convey\nthe names of the countries in the visualization. This isn’t necessarily bad,\nbut comprehension time would be increased, as the users would have to read the\ntext before they could understand the visualization. This would increase the\nrisk of reducing the immediate impact of the visualization.\n\nFinally, the audience is accustomed to seeing these different countries in the\ncontext of a world map where the relative sizes are always the same. Taking\nthese familiar shapes out of that context and placing them in a context where\nSouth Korea is larger than Germany or the United States is smaller than Japan\ncreates interest by violating expectations. Think of it as a “twist” in the\nplot of the story.\n\nHaving decided that we should use countries instead of circles, we need to\nfind visual representations of the countries on our list. Our best bet on that\ncount is to search for a country name along with the .svg file extension. SVG\nstands for scalable vector graphics and is an open standard for vector images\nmaintained by the World Wide Web Consortium (W3C). It is a popular vector\nimage standard, particularly for free images and maps, and many vector\nmanipulation applications support it.\n\nWikimedia Commons (<http://commons.wikimedia.org>) has a number of free, high-\nquality maps in vector format. These maps scale very well and are excellent\nfor this kind of project. Some of the countries that are hard to find can also\nbe pulled from vector maps of the world that are available on Wikimedia\nCommons. These files can be opened as editable vector files in Adobe\nIllustrator or Inkscape (<http://www.inkscape.org>) or as bitmaps in GIMP.\nFrom Illustrator, the vector objects can be copied and pasted directly into\nPhotoshop.\n\nIn the interest of simplicity, we’ll display only countries responsible for a\ncertain minimum (1,000+ vehicles) of either the traded-in or purchased cars.\nThis means we should have maps for the United States, Japan, South Korea,\nGermany, Sweden, and the United Kingdom.\n\nOnce we have images of the countries we want, we’re ready to size them for the\nfinal visualization.\n\nBuilding the Visual\n\nHaving moved the visuals into an image-manipulation program, we need to size\nthem so that they appropriately represent the proportions of vehicles traded\nin and purchased.\n\nMy methodology for this is to take the largest piece of data (in this case, it\nis the number of U.S.-made vehicles that were traded in: 575,073) and scale it\nto a size that fits comfortably on the canvas of the infographic. This kind of\nanchor shape is just a practical way of making sure that none of the graphic\nelements becomes too large for elegant display. This piece of data becomes the\nanchor against which we will scale all the other elements.\n\nOnce we have the size of the anchor shape, we need to calculate how many\npixels are in it. There is a trick available in Photoshop and GIMP that lets\nus easily count the pixels we have selected in a particular layer. Both\napplications have a window called “Histogram” that displays the number of\npixels that are currently selected. Using this tool, we can determine the\nnumber of pixels in the anchor shape and calculate how many pixels our other\nshapes need to be using the following formula:\n\nTarget_Size = Target_Number * Anchor_ Size / Anchor_Number\n\nFor example, 81,466 Japanese vehicles were traded in. If we size the U.S. map\nso that it comprises 25,000 pixels, the equation for determining how large to\nmake the map of Japan would be:\n\nJapan_Size = 81,466 * 25,000 / 575,073 = 3,542 pixels\n\nI generally use Excel to make these calculations so that they are easy to\nsave, double-check, and replicate.\n\nUsing the Histogram trick, we can resize the irregular shapes of the target\ncountries and scale them until they contain the number of pixels appropriate\nfor the corresponding data point visualization.\n\nI decided to arrange the countries along a vertical axis in order to\naccommodate the medium in which this visualization will be viewed (a page in\nthis book). This approach also gives symmetry to the color elements and\nreinforces the green/red, bought/clunked dichotomy of the data.\n\nWe now have the core of our visualization done. Providing some context in an\nintroductory blurb and adding a footnote about our decision regarding the\ncountry of origin for Jaguars and Land Rovers gives us the result shown in\nFigure 2-12.\n\nThis visualization now meets our criteria. It sets up the story with an\nintroduction at the top, it provides a compelling layout that draws the\nviewers’ attention, and it is instantly understandable. We’ve set up the\n“bought/clunked” dichotomy with color-coding and reinforced it with\nsymmetrical physical placement (important if we want individuals who are\ncolorblind to be able to understand our infographic). Our visualization tells\nwhat we hope is a compelling story in the minds of our viewers.\n\n![bvis_0212.png](images/bvis_0212.png)\n\nFigure 2-12. Final visualization\n\nConclusion\n\nThis tutorial has touched on only a small subset of the skills that can be\nused to create effective visualizations. A deeper foundation in fields like\ncolor theory, typography, computational data mining, and programming, as well\nas a background in the data subject, will all be valuable aids in creating\ncompelling visualizations.\n\nDespite the variety of fields that inform the visualization creation process,\nthey are unified by the fact that every visualization is part of some kind of\nstory. Even the simplest bar graph displaying a company’s earnings data is\ndrawing from information that is more memorable and more valuable within the\nlarger context (perhaps a change in management style). It is these contexts\nand the stories that we associate with them that give visualizations their\nlong-lasting impact and power.\n\n[1] See <http://tr.im/I2Gb>.\n\n[2] See\n<http://www.nytimes.com/interactive/2009/02/02/sports/20090202_superbowl_twitter.html>.\n\n\nChapter Three\n\nWordle\n\nJonathan Feinberg\n\n![bvis_0301.png](images/bvis_0301.png)\n\nFigure 3-1. A Wordle of this chapter\n\nBy now, even people who have never heard of “information visualization” are\nfamiliar with the colorful word collage known as Wordle, “the gateway drug to\ntextual analysis.”[1] Like any such drug, Wordle was designed for pleasure,\nalthough its roots lie in the utilitarian tag clouds popularized by such sites\nas del.icio.us and Flickr.\n\nWordle’s Origins\n\nIn 2004, my colleague Bernard Kerr and I made a social bookmarking\napplication, which Bernard named “dogear” (Millen, Feinberg, and Kerr, 2006).\nAny application that lets users tag content is bound to provide a tag cloud, a\nvaguely rectangular collection of clickable keywords. So, when we designed\ndogear, we made sure to feature a prominent tag cloud on every page (see\nFigure 3-2).\n\n![bvis_0302.png](images/bvis_0302.png)\n\nFigure 3-2. The author’s tags as they appeared in dogear\n\nI never found tag clouds to be particularly interesting or satisfying,\nvisually. There’s not much evidence that they’re all that useful for\nnavigation or for other interaction tasks, either.[2] But when blogger Matt\nJones[3] posted his del.icio.us tags as a beautiful, typographically lively\nimage (see Figure 3-3), I was thrilled. I thought that there was no reason why\na computer program couldn’t create something similar. At the very least, I\nwanted to end up with something that could—like Jones’s cloud—put the dot of\nan “i” into the lower counter of a “g”, something well beyond what tag clouds\ncould do at the time.\n\n![bvis_0303.png](images/bvis_0303.png)\n\nFigure 3-3. Matt Jones’s typographically aware tag cloud\n\nI spent a week or so creating the code for what I called the “tag explorer”\n(see Figure 3-4), a Java applet that permitted users to navigate through\ndogear by clicking on tags related to the current context.\n\n![bvis_0304.png](images/bvis_0304.png)\n\nFigure 3-4. The dogear tag explorer[4]\n\nIt was immediately clear that the tag explorer was useful as a portrait of a\nperson’s interests, as when a number of my fellow IBMers used screenshots of\nthe tag explorer to illustrate their résumés and email signatures (see Figure\n3-5).\n\n![bvis_0305.png](images/bvis_0305.png)\n\nFigure 3-5. The author’s 2006 work email signature\n\nWhen dogear became an IBM product,[5] the tag explorer did not go with it, and\nI forgot all about it. When I found the tag explorer code by chance a couple\nof years later, I thought it was worth developing.\n\nThe original tag explorer was intimately tied to dogear, and to the idea of\ntag clouds in general. I wanted to find a way to decouple the word-cloud\neffect from the whole idea of “tags,” since the pleasing and amusing qualities\nof the word cloud seemed generally accessible, while “tags” were familiar only\nto a technologically sophisticated crowd. This led to the idea of simply\ncounting words. Once I had decided to build a system for viewing text, rather\nthan tags, it seemed superfluous to have the words do anything other than\nmerely exist on the page. I decided that I would design something primarily\nfor pleasure, in the spirit of Charles Eames’s remark, “Who would say that\npleasure is not useful?” This decision, in turn, made it easy to decide which\nfeatures to keep, which features to reject, and how to design the interface\n(shown in Figure 3-6).\n\n![bvis_0306.png](images/bvis_0306.png)\n\nFigure 3-6. Wordle’s text-analytics user interface\n\nSince Wordle (as it was now called) was meant to be pleasing, I had to give\nsome thought to the expressive qualities of fonts and color palettes (see\nFigure 3-7).\n\n![bvis_0307.png](images/bvis_0307.png)\n\nFigure 3-7. Wordle provides varied palettes, fonts, and layouts\n\nI believe that my efforts to simplify Wordle, and to emphasize pleasure over\nbusiness, have been paid for many times over. Wordle has been used in ways I’d\nnever anticipated, by far more people than I’d dared to expect. Some of\nWordle’s success is due to the design of the web application itself, with its\none-paste/one-click instant gratification. However, to the extent that the\ndesign of the Wordle visualization itself has contributed to its ubiquity, it\nmight be worth looking at what Wordle is not before we examine in detail what\nit is and how it works.\n\nAnatomy of a Tag Cloud\n\nThe typical tag cloud is organized around lines of text.[6] If one word on a\nline is larger than another, the smaller word will have a disproportionate\namount of whitespace overhead, which can look awkward. For example, see Figure\n3-8, where “everett hey” has an enormous expanse of white above, because the\nline height is determined by its neighbor “everett everett”.\n\n![bvis_0308.png](images/bvis_0308.png)\n\nFigure 3-8. Lost in White Space[7]\n\nOne way to mitigate the ragged whitespace caused by such extreme contrasts in\nsize is to squash different word weights into a small number of bins, as\ndel.icio.us does. In Figure 3-9, the “programming” tag has been used 55 times\nand “scripting” only once, but the font for the more frequently used word is\nonly 50% larger. Notice also the use of font weight (boldness) to enhance the\ncontrast between different word weights.\n\n![bvis_0309.png](images/bvis_0309.png)\n\nFigure 3-9. Squashing the scale of differences between word weights\n\nIn effect, del.icio.us is scaling the word weights—roughly—by logarithm. It’s\nsensible to scale weights using logarithms or square roots when the source\ndata follows a power-law distribution, as tags seem to do.[8]\n\nSomewhere between these earnest, useful designs and the fanciful world that\nWordle inhabits, there are other, more experimental interfaces. The WP-\nCumulus[9] blog plug-in, for example, provides a rotating, three-dimensional\nsphere of tags (see Figure 3-10).\n\n![bvis_0310.png](images/bvis_0310.png)\n\nFigure 3-10. WP-Cumulus: can’t…quite…click on “tag cloud”…\n\nThe desire to combine navigation with visualization imposes certain\nconstraints on the design of a word cloud. But once we are liberated from any\npretense of “utility”—once we’re no longer providing navigation—we can start\nto play with space.\n\nFilling a Two-Dimensional Space\n\nThere are lots of computer science PhDs to be garnered in finding incremental\nimprovements to so-called bin-packing problems.[10] Luckily, the easy way has\na respectable name: a randomized greedy algorithm. It’s randomized in that you\nthrow stuff on the screen somewhere near where you want it to be, and if that\nstuff intersects with other stuff, you try again. It’s greedy in that big\nwords get first pick.\n\nWordle’s specific character depends on a couple of constraints. First, we are\ngiven a list of words, with associated (presumably meaningful) weights. We\ncan’t show any word more than once, and we don’t want to distort the shape of\nthe word beyond choosing its font size. If we remove those constraints,\nthough, many other interesting and beautiful effects are possible.\n\nFor example, you can use a randomized greedy strategy to fill almost any\nregion (not just a rectangle) as long as you have a set of words as a palette,\nfrom which you can arbitrarily choose any word, at any size, any number of\ntimes (see Figure 3-11).\n\n![bvis_0311.png](images/bvis_0311.png)\n\nFigure 3-11. Do not underestimate the power of the randomized greedy algorithm\n\nConsider Jared Tarbell’s exquisite Emotion Fractal[11] (see Figure 3-12),\nwhich recursively subdivides a space into ever-smaller random rectangles,\nfilling the space with ever-smaller words. This effect depends on a large set\nof candidate words, chosen at random, with arbitrary weights.\n\n![bvis_0312.png](images/bvis_0312.png)\n\nFigure 3-12. Jared Tarbell’s Emotion Fractal\n\nIf you don’t mind distorting your fonts by elongating or squashing the words\nas needed, other effects are possible. For example, Figure 3-13 shows a\nvariation on the venerable treemap,[12] which uses text, rather than\nrectangles, to fill space. Each word fills an area proportional to its\nfrequency; each rectangular area contains words strongly associated with each\nother in the source text.\n\n![bvis_0313.png](images/bvis_0313.png)\n\nFigure 3-13. Word treemap of an Obama speech\n\nIt must be said that long before there were Processing sketches and Flash\napplets, people were exploring these sorts of typographical constructions in\nmass media and in fine art (Figure 3-14); we have been probing the boundary\nbetween letters as forms and letters as signs for a long time (Figure 3-15).\nThe goal of these algorithmic explorations is to allow the wit and elegance of\nsuch examples to influence the representation of textual data.\n\nGiven this rather brief tour of the technical and aesthetic environment in\nwhich Wordle evolved, we’re now ready to look at Wordle’s technical and\naesthetic choices in a bit more detail.\n\n![bvis_0314.png](images/bvis_0314.png)\n\nFigure 3-14. Herb Lubalin and Lou Dorfsman’s Typographicalassemblage (courtesy\nof the Center for Design Study)\n\n![bvis_0315.png](images/bvis_0315.png)\n\nFigure 3-15. Before we made pictures with words, we made words with pictures\n\nHow Wordle Works\n\nWordle is implemented as a Java applet. Some of the technical details I\nprovide here will be in terms of Java-specific features. Nothing described\nhere is impossible in other languages, using other libraries and frameworks,\nbut Java’s strong support for Unicode text processing and 2D graphics (via the\nJava2D API) makes these things pretty straightforward.\n\nText Analysis\n\nWe’ll now take a step back and consider some of the fundamental assumptions\nthat determine Wordle’s character. In particular, we have to examine what\n“text” is, as far as Wordle is concerned.\n\nWhile this kind of text analysis is crude compared to what’s required for some\nnatural-language processing, it can still be tedious to implement. If you work\nin Java, you might find my cue.language library[13] useful for the kinds of\ntasks described in this section. It’s small enough, it’s fast enough, and\nthousands use it each day as part of Wordle.\n\nRemember that natural-language analysis is as much craft as science,[14] and\neven given state-of-the-art computational tools, you have to apply judgment\nand taste.\n\nFinding words\n\nWordle is in the business of drawing pictures of words, each having some\nweight, which determines its size. What does Wordle consider to be a “word”?\n\nWordle builds a regular expression (regex) that recognizes what it considers\nto be words in a variety of scripts, and then iteratively applies that regex\nto the given text, as illustrated in Example 3-1. The result is a list of\nwords.\n\nExample 3-1. How to recognize “words”\n\nprivate static final String LETTER = \"[@+\\\\\\p{javaLetter}\\\\\\p{javaDigit}]\";\n\nprivate static final String JOINER =\n\"[-.:/''\\\\\\p{M}\\\\\\u2032\\\\\\u00A0\\\\\\u200C\\\\\\u200D~]\";\n\n/*\n\nA word is:\n\none or more \"letters\" followed by\n\nzero or more sections of\n\none or more \"joiners\" followed by one or more \"letters\"\n\n*/\n\nprivate static final Pattern WORD =\n\nPattern.compile(LETTER + \"+(\" + JOINER + \"+\" + LETTER + \"+)*\");\n\nA letter is any character that the Java Character class considers to be either\na “letter” or a “digit,” along with @ (at sign) and + (plus sign). Joiners\ninclude the Unicode M class, which matches a variety of nonspacing and\ncombining marks, other pieces of punctuation commonly found in URLs (since\nWordle users expect to see URLs preserved as “words”), the apostrophe, and\nseveral characters used as apostrophes in the wild (such as U+2032, the PRIME\ncharacter). Wordle accepts the tilde (~) as a word joiner but replaces it with\na space in the output, thereby giving users an easy way to say “keep these\nwords together” without having to find the magical key combination for a real\nnonbreaking space character.\n\nDetermining the script\n\nHaving extracted a list of words (whatever we take “word” to mean), we need to\nknow how to display those words to the viewer. We first need to know what\ncharacters we’ll be expected to display, so that we can choose a font that\nsupports those characters.\n\nWordle’s collection of fonts is organized in terms of what scripts each can\nsupport, where a script is what you might think of as an alphabet: a\ncollection of glyphs that can be used to visually represent sequences of\ncharacters in one or more languages. A given script, in Unicode, is organized\ninto one or more blocks. So, the task now is to determine which fonts the user\nmight want to use by sniffing out which blocks are represented in the given\ntext.\n\nJava provides the static method UnicodeBlock.of(int codePoint) to determine\nwhich block a given code point belongs to. Wordle takes the most frequent\nwords in a text and looks at the first character in each of those words. In\nthe rather common case that the character is in the Latin block, we further\ncheck the rest of the word to see if it contains any Latin-1 Supplement\ncharacters (which would remove certain fonts from consideration) or any of the\nLatin Extended blocks (which would bar even more fonts). The most frequently\nseen block is the winner.\n\nTo keep it responsive and limit its use of network resources, Wordle is\ndesigned to permit the use of only one font at a time. A more full-featured\nword cloud might choose different fonts for different words; this could\nprovide another visual dimension to represent, for example, different source\ntexts.\n\nAs of this writing, Wordle supports the Latin, Cyrillic, Devanagari, Hebrew,\nArabic, and Greek scripts. By design, Wordle does not support the so-called\nCJKV scripts, the scripts containing Chinese, Japanese, Korean, and Vietnamese\nideographs. CJKV fonts are quite large and would take too long for the average\nWordle user to download (and would cost a great deal in bandwidth charges).\nAlso, determining word breaks for ideographic languages requires sophisticated\nmachine-learning algorithms and large runtime data structures, which Wordle\ncannot afford.\n\nknow thy data\n\nUnicode in a Nutshell\n\nSince Wordle understands text in Unicode terms, here’s what you have to know\nin order to understand some of the terms and notations you’ll see here.\n\nThe Unicode[1] standard provides a universal coded character set and a few\nspecifications for representing its characters in computers (as sequences of\nbytes).\n\nA character is an abstract concept, meant to serve as an atom of written\nlanguage. It is not the same thing as a “letter”—for example, some Unicode\ncharacters (accents, umlauts, zero-width joiners) are only meaningful in\ncombination with other characters. Each character has a name (such as GREEK\nCAPITAL LETTER ALPHA) and a number of properties, such as whether it is a\ndigit, whether it is an uppercase letter, whether it is rendered right-to-\nleft, whether it is a diacritic, and so on.\n\nA character set or character repertoire is another abstraction: it is an\nunordered collection of characters. A given character is either in, or not in,\na given character set. Unicode attempts to provide a universal character\nset—one that contains every character from every written language in current\nand historical use—and the standard is constantly revised to bring it closer\nto that ideal.\n\nA coded character set uniquely assigns an integer—a code point—to each\ncharacter. Once you’ve assigned code points to the characters, you may then\nrefer to those characters by their numbers. The convention used is an\nuppercase U, a plus sign, and a hexadecimal number. For example, the PRIME\ncharacter mentioned earlier in this chapter has the code point U+2032.\n\nCoded characters are organized according to the scripts in which they appear,\nand scripts are further organized into blocks of strongly related characters.\nFor example, the Latin script (in which most European languages are written)\nis given in such blocks as Basic Latin (containing sufficient characters to\nrepresent Latin and English), Latin-1 Supplement (containing certain\ndiacritics and combining controls), Latin Extended A, Latin Extended B, and so\non.\n\nWhen it comes time to actually put pixels onto a screen, a computer program\ninterprets a sequence of characters and uses a font to generate glyphs in the\norder and location demanded by the context.\n\n[1] See <http://unicode.org>.\n\nGuessing the language and removing stop words\n\nIt would be neither interesting nor surprising to see that your text consists\nmostly of the words “the,” “it,” and “to.” To avoid a universe of boring\nWordles, all alike, such stop words need to be removed for each recognized\nlanguage. To know which list of stop words to remove for a given text, though,\nwe have to guess what language that text is in.\n\nKnowing the script is not the same as knowing the language, since many\nlanguages might use the same script (e.g., French and Italian, which share the\nLatin script).\n\nWordle takes a straightforward approach to guessing a text’s language: it\nselects the 50 most frequent words from the text and counts how many of them\nappear in each language’s list of stop words. Whichever stop word list has the\nhighest hit count is considered to be the text’s language.\n\nHow do you create a list of stop words? As with the definition of a “word,”\ndescribed earlier, this kind of thing is a matter of taste, not science. You\ntypically start by counting all of the words in a large corpus and selecting\nthe most frequently used words. However, you might find that certain high-\nfrequency words add a desirable flavor to the output while other, lower-\nfrequency words just seem to add noise, so you may want to tweak the list a\nbit.\n\nMany of Wordle’s stop word lists came from users who wanted better support for\ntheir own languages. Those kind folks are credited on the Wordle website.\n\nBy default Wordle strips the chosen language’s stop words from the word list\nbefore proceeding to the next steps, but Wordle users can override this\nsetting via a menu checkbox.\n\nAssigning weights to words\n\nWordle takes the straight path in assigning a numeric weight to each word. The\nformula is: weight = word count.\n\nLayout\n\nOnce you’ve analyzed your text, you’re left with a list of words, each of\nwhich has some numeric weight based on its frequency in the text. Wordle\nnormalizes the weights to an arbitrary scale, which determines the magnitude\nof various constants that affect the resulting image (such as the minimum size\nof a hierarchical bounding box leaf, as described later in this chapter).\nYou’re now ready to turn words into graphical objects and to position those\nobjects in space.\n\nWeighted words into shapes\n\nFor each word, Wordle constructs a font with a point size equal to the word’s\nscaled weight, then uses the font to generate a Java2D Shape (see Example\n3-2).\n\nExample 3-2. How to turn a String into a Shape\n\nprivate static final FontRenderContext FRC\n\n= new FontRenderContext(null, true, true);\n\npublic Shape generate(final Font font, final double weight, final String word,\nfinal double orientation) {\n\nfinal Font sizedFont = font.deriveFont((float) weight);\n\nfinal char[] chars = word.toCharArray();\n\nfinal int direction = Bidi.requiresBidi(chars, 0, chars.length) ?\n\nFont.LAYOUT_RIGHT_TO_LEFT : Font.LAYOUT_LEFT_TO_RIGHT;\n\nfinal GlyphVector gv =\n\nsizedFont.layoutGlyphVector(FRC, chars, 0, chars.length, direction);\n\nShape result = gv.getOutline();\n\nif (orientation != 0.0){\n\nresult =\nAffineTransform.getRotateInstance(orientation).createTransformedShape(result);\n\n}\n\nreturn result;\n\n}\n\nThe playing field\n\nWordle estimates the total area to be covered by the finished word cloud by\nexamining the bounding box for each word, summing the areas, and adjusting the\nsum to account for the close packing of smaller words in and near larger\nwords. The resulting area is proportioned to match the target aspect ratio\n(which is, in turn, given by the dimensions of the Wordle applet at the moment\nof layout).\n\nThe constants used to adjust the size of the playing field, the area in which\nWordles are laid out, were determined by the time-honored tradition of futzing\naround with different numbers until things looked “good” and worked “well.” As\nit happens, the precise size of the playing field is rather important, because\nthe field boundaries are used as constraints during layout. If your playing\nfield is too small, your placement will run slowly and most words will fall\noutside the field, leaving you with a circle (because once a word can’t be\nplaced on the field, Wordle relaxes that constraint and you wind up with\neverything randomly distributed around some initial position). If it’s too\nlarge, you’ll get an incoherent blob (because every nonintersecting position\nis acceptable).\n\nOne “gotcha” to look out for is an especially long word, which could have a\ndimension far larger than the calculated width or height based on area. You\nmust make sure that your playing field is big enough to contain the largest\nword, at least.\n\nRemember that the playing field is an abstract space, a coordinate system not\ncorresponding to pixels, inches, or any other unit of measurement. In this\nabstract space, you can lay out the word shapes and check for intersections.\nWhen it comes time to actually put pixels on the screen, you can do some\nscaling into screen units.\n\nPlacement\n\nHaving created a place to put words, it’s time to position the words in that\nspace. The overall placement strategy is a randomized greedy algorithm in\nwhich words are placed, one at a time, on the playing field. Once a word is\nplaced, its position does not change.\n\nWordle offers the user a choice of placement strategies. These strategies\ninfluence the shape and texture of the completed Wordle, by determining where\neach word “wants” to go. On the Wordle website, the choices are center-line\nand alphabetical center-line. Both strategies place words near the horizontal\ncenter-line of the playing field (not necessarily upon it, but scattered away\nfrom it by a random distribution). The alphabetical strategy sorts the words\nalphabetically and then distributes their preferred x coordinates across the\nplaying field.\n\nInteresting effects are possible through the use of smarter placement\nstrategies. For example, given clustering data—information about which words\ntend to be used near each other—the placement strategy can make sure that each\nword tries to appear near the last word from its cluster that was placed on\nthe field (see Figure 3-16).\n\n![bvis_0316.png](images/bvis_0316.png)\n\nFigure 3-16. The result of a clustering placement strategy\n\nThe word shapes are sorted by their respective weights, in descending order.\nLayout proceeds as in Example 3-3, with the result as illustrated in Figure\n3-17.\n\nExample 3-3. The secret Wordle algorithm revealed at last!\n\nFor each word w in sorted words:\n\nplacementStrategy.place(w)\n\nwhile w intersects any previously placed words:\n\nmove w a little bit along a spiral path\n\n![bvis_0317.png](images/bvis_0317.png)\n\nFigure 3-17. The path taken by the word “Denmark”\n\nTo make matters a bit more complicated, Wordle optionally tries to get the\nwords to fit entirely within the rectangular boundaries of the playing\nfield—this is why it’s important to guess how big the whole thing is going to\nbe. If the rectangular constraint is turned on, the intersection-handling\nroutine looks like Example 3-4.\n\nExample 3-4. Constraining words to the playing field\n\nwhile w intersects any previously placed words:\n\ndo {\n\nmove w a little bit along a spiral path\n\n} while any part of w is outside the playing field and the spiral radius is\nstill smallish\n\nIntersection testing\n\nThe pseudocode in Example 3-4 breezily suggests that you move a word while it\nintersects other words, but it does not suggest how you’d go about determining\nsuch a thing. Testing spline-based shapes for intersection is expensive, and a\nnaïve approach to choosing pairs for comparison is completely unaffordable.\nHere are the techniques that Wordle currently uses to make things fast enough:\n\nHierarchical bounding boxes\n\nThe first step is to reduce the cost of testing two words for intersection. A\nsimple method for detecting misses is to compare the bounding boxes of two\nwords, but it’s not uncommon for two such boxes to intersect when the word\nglyphs do not. Wordle exploits the cheapness of rectangle comparisons by\nrecursively dividing a word’s bounding box into ever-smaller boxes, creating a\ntree of rectangles whose leaf nodes contain chunks of the word shape (see\nFigure 3-18). Although it’s expensive to construct these hierarchical bounding\nboxes, the cost is recovered by an order of magnitude during the layout. To\ntest for collision, you recursively descend into mutually intersecting boxes,\nterminating either when two leaf nodes intersect (a hit) or when all possible\nintersecting branches are excluded (a miss). By taking care with the minimum\nsize of leaf rectangles and by “swelling” the leaf boxes a bit, the layout\ngets a pleasing distance between words “for free.”\n\n![bvis_0318.png](images/bvis_0318.png)\n\nFigure 3-18. Hierarchical bounding boxes\n\nBroadphase collision detection\n\nIn choosing pairs of words to test for intersection, the simplest approach is\nto test the current candidate word against all of the already-placed words.\nThis approach results in a hit test count around the order of N2, which is far\ntoo slow once you get up to 100 words or so. Therefore, Wordle does some extra\nwork to avoid as much collision testing as possible.\n\nCaching\n\nOne very simple improvement stems from the observation that if a word A\nintersects some other word B, it’s very likely that A will still intersect B\nif A is moved slightly. Therefore, Wordle caches a candidate word’s most\nrecently intersected word and tests it first.\n\nSpatial indexing\n\nTo further reduce the number of hit tests, Wordle borrows from computational\ngeometry the region quadtree, which recursively divides a two-dimensional\nspace (in this case, the Wordle playing field) into four rectangular regions.\nHere, a quadtree serves as a spatial index to efficiently cull shapes from the\nlist of words to be compared to some candidate shape. Once a word is placed on\nthe playing field, Wordle searches for the smallest quadtree node that\nentirely contains the word, and adds the word to that node. Then, when placing\nthe next word, many already-placed words can be culled from collision testing\nby querying the quadtree.\n\nThere’s an entire research field around efficient collision detection, much of\nwhich is very well summarized in Christer Ericson’s (2005) book Real-Time\nCollision Detection. I recommend that book to anyone who wants to play with\nrandomized graphics algorithms like Wordle’s; my own quadtree implementation\nis based on my understanding of its discussion.\n\nIs Wordle Good Information Visualization?\n\nIf you consider Wordle strictly as an information visualization tool, certain\naspects of its design could be criticized for their potential to mislead or\ndistract its users. Here are some of my own Wordle caveats.\n\nWord Sizing Is Naïve\n\nWordle does not take into account the length of a word, or the glyphs with\nwhich it’s drawn, when calculating its font size. The result is that, given\ntwo words used the same number of times, the word with more letters will take\nup more space on the screen, which may lead to the impression of the longer\nword being more frequent.\n\nOn the other hand, I don’t know of any studies on how relative word size\ncorresponds to perceived relative weight. What’s more, the commonly used trick\nof scaling by the square root of the word’s weight (to compensate for the fact\nthat words have area, and not mere length) simply makes a Wordle look boring.\n\nColor Is Meaningless\n\nIn a medium—your computer screen—that provides precious few dimensions, Wordle\nis shockingly free with its use of color. Color means absolutely nothing in\nWordle; it is used merely to provide contrast between word boundaries and for\naesthetic appeal.\n\nColor could be used to code various dimensions, such as clustering (indicating\nwhich words tend to be used near each other) or statistical significance (as\nin the inaugural address word clouds—see Figure 3-19). Wordle could also use\ncolor to let two or more different texts be represented in the same space.\n\n![bvis_0319.png](images/bvis_0319.png)\n\nFigure 3-19. “Government” was used a lot in this speech, but not much more\nthan in the other speeches; “pleasing” was used only a couple of times but is\nan unusual word in the corpus; “people” was used a lot and is unusually\nfrequent\n\nIt should also be mentioned that Wordle makes no provision for colorblind\nusers, although one can always create a custom palette via the applet’s Color\nmenu.\n\nFonts Are Fanciful\n\nMany of Wordle’s fonts strongly favor aesthetics and expressiveness over\nlegibility. This has to do, partly, with the design of the Wordle website—the\ngallery pages would be monotonous without fairly broad letter-form diversity.\nMost importantly, a font has to look good in a Wordle, which may mean that it\nwouldn’t necessarily work well for body text.\n\nFor applications where legibility is paramount, Wordle provides Ray Larabie’s\nExpressway font, which is modeled on the U.S. Department of Transportation’s\nStandard Alphabets.\n\nWord Count Is Not Specific Enough\n\nI have seen Wordle used to summarize each book of the New Testament, leading\nto one page after another of “Lord,” which tells you nothing about how the\nchapters are distinct from one another. Merely counting words does not permit\nmeaningful comparisons of like texts. Consider, for example, a blog post. It\nmight be most revealing to emphasize how the post differs from other blog\nposts by the same author, or to show how it differs from posts on the same\ntopic by other bloggers, or even to show how it differs from the language of\nnewspaper reporting.\n\nThere are plenty of statistical measures that one may apply to a “specimen”\ntext versus some “normative” body of text to reveal the specific character of\nthe specimen, with proper attention paid to whether some word use is\nstatistically significant. Given a more nuanced idea of word weight, beyond\nmere frequency, one could then apply the Wordle layout algorithm to display\nthe results.\n\nI explored this idea in an analysis of every presidential inaugural\naddress,[15] in which each speech was compared to the 5 speeches nearest to it\nin time, the 10 nearest speeches, and all other inaugural addresses. Such an\nanalysis has the advantage of revealing the unexpected absence of certain\nwords. For example, Figure 3-20 is a visualization of Harry Truman’s 1948\ninaugural address. On the left is a Wordle-like representation of the words he\nused, and on the right are the words that his contemporaries used more than he\ndid. This visualization reveals Truman’s emphasis on foreign policy.\n\n![bvis_0320.png](images/bvis_0320.png)\n\nFigure 3-20. Harry Truman’s 1948 inaugural address: the words in red were\nconspicuously absent from Harry Truman’s speech, relative to those of his\ncontemporaries\n\nHow Wordle Is Actually Used\n\nWordle was not designed for visualization experts, text analysis experts, or\neven experienced computer users. I tried to make Wordle as appliance-like as\npossible.\n\nAs of this writing, people have created and saved over 1,400,000 word clouds\nin the Wordle gallery. They have been used to summarize and decorate business\npresentations and PhD theses, to illustrate news articles and television news\nbroadcasts, and to distill and abstract personal and painful memories for\nvictims of abuse. Wordle has also found an enthusiastic community in teachers\nof all stripes, who use Wordles to present spelling lists, to summarize\ntopics, and to engage preliterate youngsters in the enjoyment of text.\n\nAs the survey results in Table 3-1 (Viégas, Wattenberg, and Feinberg, 2009)\nillustrate, when people use Wordle they feel creative, as though they’re\nmaking something.\n\nTable 3-1. How people feel when they make a Wordle  \n---  \n|  Agree % |  Neutral % |  Disagree %  \nI felt creative |  88 |  9 |  4  \nI felt an emotional reaction |  66 |  22 |  12  \nI learned something new about the text |  63 |  24 |  13  \nIt confirmed my understanding of the text |  57 |  33 |  10  \nIt jogged my memory |  50 |  35 |  15  \nThe Wordle confused me |  5 |  9 |  86  \n  \nSo, by one traditional academic measure of a visualization’s efficacy—“I\nlearned something new about the text”—Wordle can at least be considered\nmoderately successful. But where Wordle shines is in the creation of\ncommunicative artifacts. People who use Wordle feel as though they have\ncreated something, that the created thing succeeds in representing something\nmeaningful, and that it accurately reflects or intensifies the source text.\nThis sense of meaningfulness seems to be mostly intuitive, in that many people\ndo not realize that word size is related to word frequency (guessing, instead,\nthat the size indicates “emotional importance” or even “word meaning”).\n\nThe special qualities of Wordle are due to the special qualities of text.\nSimply putting a single word on the screen, in some font that either\ncomplements or contrasts with the sense of the word, immediately resonates\nwith the viewer (indeed, there have been many thousands of single-word Wordles\nsaved to the public gallery). When you juxtapose two or more words, you begin\nto exploit the tendency of a literate person to make sense of words in\nsequence. Wordle’s serendipitous word combinations create delight, surprise,\nand perhaps some of the same sense of recognition and insight that poetry\nevokes intentionally.\n\nUsing Wordle for Traditional Infovis\n\nNotwithstanding Wordle’s special emotional and communicative properties, the\nanalytic uses of information visualization are certainly available to the\nexpert user. To serve those who want to use Wordle as a visualization for\ntheir own weighted text, where the weights are not necessarily based on word\nfrequency, the Wordle website provides an “advanced” interface, where one can\nenter tabular data containing arbitrarily weighted words or phrases, with\n(optional) colors.\n\nStill more advanced use is possible through the “Word Cloud Generator” console\napplication, available through IBM’s alphaWorks website.[16]\n\nThe ManyEyes collaborative data visualization site also provides Wordle as a\ntext-visualization option beside its innovative Phrase Net and Word Tree\nvisualizations (and a more traditional tag cloud).[17]\n\nConclusion\n\nPeople often want to preserve and share the Wordles they make; they use\nWordles to communicate. A beautiful visualization gives pleasure as it reveals\nsomething essential.\n\nAcknowledgments\n\nI would like to thank Martin Wattenberg and Irene Greif at IBM CUE for making\npossible my participation in this book. I am very grateful to Ben Fry,\nKatherine McVety, Fernanda Viégas, and Martin Wattenberg, who each read this\nchapter with great care and suggested many improvements. Please see\n<http://www.wordle.net/credits> for information about the many people who have\nhelped me create and improve Wordle.\n\nReferences\n\nEricson, Christer. 2005. Real-Time Collision Detection. San Francisco, CA:\nMorgan Kaufmann.\n\nMillen, D. R., J. Feinberg, and B. Kerr. 2006. “Dogear: Social bookmarking in\nthe enterprise.” Proceedings of the SIGCHI Conference on Human Factors in\nComputing Systems (Montréal, Québec, Canada, April 22–27, 2006).\n<http://doi.acm.org/10.1145/1124772.1124792>.\n\nViégas, Fernanda B., Martin Wattenberg, and Jonathan Feinberg. 2009.\n“Participatory visualization with Wordle.” IEEE Transactions on Visualization\nand Computer Graphics 15, no. 6 (Nov/Dec 2009): 1137–1144.\ndoi:10.1109/TVCG.2009.171.\n\n[1] See <http://www.profhacker.com/2009/10/21/wordles-or-the-gateway-drug-to-\ntextual-analysis/>.\n\n[2] See <http://doi.acm.org/10.1145/1240624.1240775>.\n\n[3] See <http://magicalnihilism.com/2004/07/04/my-delicious-tags-july-2004/>.\n\n[4] See\n<http://www.flickr.com/photos/koranteng/526642309/in/set-72157600300569893>.\n\n[5] See\n<http://www-01.ibm.com/software/lotus/products/connections/bookmarks.html>.\n\n[6] For a thorough survey of tag cloud designs, with thoughtful commentary,\nsee <http://www.smashingmagazine.com/2007/11/07/tag-clouds-gallery-examples-\nand-good-practices/>.\n\n[7] See <http://manyeyes.alphaworks.ibm.com/manyeyes/page/Tag_Cloud.html>.\n\n[8] See <http://www.citeulike.org/user/andreacapocci/article/1326856>.\n\n[9] See <http://wordpress.org/extend/plugins/wp-cumulus/>.\n\n[10] See\n[http://en.wikipedia.org/wiki/Bin_packing_problem](http://en.wikipedia.org/wiki/Bin_packing_problem.).\n\n[11] See <http://levitated.net/daily/levEmotionFractal.html>.\n\n[12] See <http://www.cs.umd.edu/hcil/treemap-history/>.\n\n[13] See <http://github.com/vcl/cue.language>.\n\n[14] For an illuminating demonstration of this craft, see Peter Norvig’s\nchapter on natural-language processing in the sister O’Reilly book [Beautiful\nData](http://oreilly.com/catalog/9780596157111/).\n\n[15] See <http://researchweb.watson.ibm.com/visual/inaugurals/>.\n\n[16] See <http://www.alphaworks.ibm.com/tech/wordcloud>.\n\n[17] See\n<http://manyeyes.alphaworks.ibm.com/manyeyes/page/Visualization_Options.html>.\n\n\nChapter Four\n\nColor: The Cinderella of Data Visualization\n\nMichael Driscoll\n\nAvoiding catastrophe becomes the first principle in bringing color to\ninformation: Above all, do no harm.\n\nEdward Tufte, Envisioning Information (Graphics Press)\n\nColor is one of the most abused and neglected tools in data visualization: we\nabuse it when we make poor color choices, and we neglect it when we rely on\npoor software defaults. Yet despite its historically poor treatment at the\nhands of engineers and end users alike, if used wisely, color is unrivaled as\na visualization tool.\n\nMost of us would think twice before walking outside in fluorescent red\nUnderoos®. If only we were as cautious in choosing colors for infographics!\nThe difference is that few of us design our own clothes, while we must all be\nour own infographics tailors in order to get colors that fit our purposes (at\nleast until good palettes—like ColorBrewer—become commonplace).\n\nWhile obsessing about how to implement color on the Dataspora Labs PitchFX\nviewer, I began with a basic motivating question: why use color in data\ngraphics? We’ll consider that question next.\n\nWhy Use Color in Data Graphics?\n\nFor a simple dataset, a single color is sufficient (even preferable). For\nexample, Figure 4-1 shows a scatterplot of 287 pitches thrown by Major League\npitcher Oscar Villarreal in 2008. With just two dimensions of data to\ndescribe—the x and y locations in the strike zone—black and white is\nsufficient. In fact, this scatterplot is a perfectly lossless representation\nof the dataset (assuming no data points overlap perfectly).\n\n![bvis_0401.png](images/bvis_0401.png)\n\nFigure 4-1. Location of pitches indicated in an x/y plane\n\nBut what if we’d like to know more? For instance, what kinds of pitches\n(curveballs, fastballs) landed where? Or what was their speed? Visualizations\noccupy two dimensions, but the world they describe is rarely so confined.\n\nThe defining challenge of data visualization is projecting high-dimensional\ndata onto a low-dimensional canvas. As a rule, one should never do the reverse\n(visualize more dimensions than already exist in the data).\n\nGetting back to our pitching example, if we want to layer another dimension of\ndata—pitch type—into our plot, we have several methods at our disposal:\n\n1\\. Plotting symbols. We can vary the glyphs that we use (circles, triangles,\netc.).\n\n2\\. Small multiples. We can vary extra dimensions in space, creating a series\nof smaller plots.\n\n3\\. Color. We can color our data, encoding extra dimensions inside a color\nspace.\n\nWhich technique you employ in a visualization should depend on the nature of\nthe data and the media of your canvas. I will describe these three by way of\nexample.\n\n1\\. Vary Your Plotting Symbols\n\nIn Figure 4-2, I’ve layered the categorical dimension of pitch type into our\nplot by using four different plotting symbols.\n\n![bvis_0402.png](images/bvis_0402.png)\n\nFigure 4-2. Location and pitch type indicated by plotting symbols\n\nI consider this visualization an abject failure. There are two reasons why\ngraphs like this one make our heads hurt: because distinguishing glyphs\ndemands extra attention (versus what academics call “preattentively processed”\ncues like color), and because even after we’ve visually decoded the symbols,\nwe must map those symbols to their semantic categories. (Admittedly, this can\nbe mitigated with Chernoff faces or other iconic symbols, where the\ncategorical mapping is self-evident).\n\n2\\. Use Small Multiples on a Canvas\n\nWhile Edward Tufte has done much to promote the use of small multiples in\ninformation graphics, folding additional dimensions into a partitioned canvas\nhas a distinguished pedigree. This technique has been employed everywhere from\nGalileo’s sunspot illustrations to William Cleveland’s trellis plots. And as\nScott McCloud’s unexpected tour de force on comics makes clear, panels of\npictures possess a narrative power that a single, undivided canvas lacks.\n\nIn Figure 4-3, plots of the four types of pitches that Oscar throws are\narranged horizontally. By reducing our plot sizes, we’ve given up some\nresolution in positional information. But in return, patterns that were\ninvisible in our first plot and obscured in our second (by varied symbols) are\nnow made clear (Oscar throws his fastballs low, but his sliders high).\n\n![bvis_0403.png](images/bvis_0403.png)\n\nFigure 4-3. Location and pitch type indicated by facets\n\nMultiplying plots in space works especially well on printed media, which can\ndisplay more than 10 times as many dots per square inch as a screen.\nAdditional plots can be arranged in both columns and rows, with the result\nbeing a matrix of scatterplots (in R, see the splom function).\n\n3\\. Add Color to Your Data\n\nIn Figure 4-4, I’ve used color as a means of encoding a fourth dimension of\nour pitching data: the speed of pitches thrown. The palette I’ve chosen is a\ndivergent palette that moves along one dimension (think of it as the “redness-\nblueness” dimension) in the Lab color space,[1] while maintaining a constant\nlevel of luminosity.\n\n![bvis_0404.png](images/bvis_0404.png)\n\nFigure 4-4. Location and pitch type, with pitch velocity indicated by a one-\ndimensional color palette\n\nOn the one hand, holding luminosity constant has advantages, because\nluminosity (similar to brightness) determines a color’s visual impact. Bright\ncolors pop, and dark colors recede. A color ramp that varies luminosity along\nwith hue will highlight data points as an artifact of color choice.\n\nOn the other hand, luminosity—unlike hue—possesses an inherent order that hue\nlacks, making it suitable for mapping to quantitative (and not categorical)\ndimensions of data.\n\nBecause I am going to use luminosity to encode yet another dimension later, I\ndecided to use hue for encoding speed here; it suits our purposes well enough.\nI chose only seven gradations of color, so I’m downsampling (in a lossy way)\nour speed data. Segmentation of our color ramp into many more colors would\nmake it difficult to distinguish them.\n\nI’ve also chosen to use filled circles as the plotting symbol in this version,\nas opposed to the open circles used in all the previous plots. This improves\nthe perception of each pitch’s speed via its color: small patches of color are\nless perceptible. However, a consequence of this choice—compounded by the\ndecision to work with a series of smaller plots—is that more points overlap.\nHence, we’ve further degraded some of the positional information. (We’ll\nattempt to recover some of this information in just a moment.)\n\nSo Why Bother with Color?\n\nAs compared to most print media, computer displays have fewer units of space\nbut a broader color gamut. So, color is a compensatory strength.\n\nFor multidimensional data, color can convey additional dimensions inside a\nunit of space, and can do so instantly. Color differences can be detected\nwithin 200 milliseconds, before you’re even conscious of paying attention (the\n“preattentive” concept I mentioned earlier).\n\nBut the most important reason to use color in multivariate graphics is that\ncolor is itself multidimensional. Our perceptual color space—however you slice\nit—is three-dimensioned.\n\nWe’ve now brought color to bear on our visualization, but we’ve only encoded a\nsingle dimension: speed. This leads us to another question.\n\nIf Color Is Three-Dimensional, Can I Encode Three Dimensions with It?\n\nIn theory, yes—Colin Ware (2000) researched this exact question using red,\nblue, and green as the three axes. (There are other useful ways of dividing\nthe color spectrum, as we will soon see.) In practice, though, it’s difficult.\nIt turns out that asking observers to assess the amount of “redness,”\n“blueness,” and “greenness” of points is possible, but doing so is not\nintuitive.\n\nAnother complicating factor is that a nontrivial fraction of the population\nhas some form of colorblindness (also known as dichromacy, in contrast to\nnormal trichromacy). This effectively reduces color perception to two\ndimensions.\n\nAnd finally, the truth is that our sensation of color is not equal along all\ndimensions: there are fewer perceptible shades of yellow than there are\n“blues.” It’s thought that the closely related “red” and “green” receptors\nemerged via duplication of the single long wavelength receptor (useful for\ndetecting ripe from unripe fruits, according to one just-so story).\n\nBecause of the high level of colorblindness in the population, and because of\nthe challenge of encoding three dimensions in color, I believe color is best\nused to encode no more than two dimensions of data.\n\nLuminosity As a Means of Recovering Local Density\n\nFor the last iteration of our pitching plot data visualization, shown in\nFigure 4-5, I will introduce luminosity as a means of encoding the local\ndensity of points. This allows us to recover some of the data lost by\nincreasing the sizes of our plotting symbols.\n\n![bvis_0405.png](images/bvis_0405.png)\n\nFigure 4-5. Location and pitch type, with pitch velocity and local density\nindicated by a two-dimensional color palette (see inset for details)\n\nHere we have effectively employed a two-dimensional color palette, with\nblueness-redness varying along one axis to denote speed, luminosity varying\nalong the other to denote local density. As detailed in the “Methods” section,\nthese plots were created using the color space package in R, which provides\nthe ability to specify colors in any of the major color spaces (RGB, HSV,\nLab). Because the Lab color space varies chromaticity independently from\nluminosity, I chose it for creating this particular two-dimensional palette.\n\nOne final point about using luminosity is that observing colors in a data\nvisualization involves overloading, in the programming sense. That is, we rely\non cognitive functions that were developed for one purpose (seeing lions) and\nuse them for another (seeing lines).\n\nWe can overload color any way we want, but whenever possible we should choose\nmappings that are natural. Mapping pitch density to luminosity feels right\nbecause the darker shadows in our pitch plots imply depth. Likewise, when\nsampling from the color space, we might as well choose colors found in nature.\nThese are the palettes our eyes were gazing at for millions of years before\nthe RGB color space showed up.\n\nLooking Forward: What About Animation?\n\nThis discussion has focused on using static graphics in general, and color in\nparticular, as a means of visualizing multivariate data. I’ve purposely\nneglected one very powerful dimension: time. The ability to animate graphics\nmultiplies by several orders of magnitude the amount of information that can\nbe packed into a visualization (a stunning example is Aaron Koblin’s\nvisualizations of U.S. and Canadian flight patterns, explored in Chapter 6).\nBut packing that information into a time-varying data structure involves\nconsiderable effort, and animating data in a way that is informative, not\nsimply aesthetically pleasing, remains challenging. Canonical forms of\nanimated visualizations (equivalent to the histograms, box plots, and\nscatterplots of the static world) are still a ways off, but frameworks like\nProcessing[2] are a promising start toward their development.\n\nMethods\n\nAll of the visualizations here were developed using the R programming language\nand the Lattice graphics package. The R code for building a two-dimensional\ncolor palette follows:\n\n## colorPalette.R\n\n## builds an (m x n) 2D palette\n\n## by mixing 2 hues (col1, col2)\n\n## and across two luminosities (lum1,lum2)\n\n## returns a matrix of the hex RGB values\n\nmakePalette <\\- function(col1,col2,lum1,lum2,m,n,...) {\n\nC <\\- matrix(data=NA,ncol=m,nrow=n)\n\nalpha <\\- seq(0,1,length.out=m)\n\n## for each luminosity level (rows)\n\nlum <\\- seq(lum1,lum2,length.out = n)\n\nfor (i in 1:n) {\n\nc1 <\\- LAB(lum[i], coords(col1)[2], coords(col1)[3])\n\nc2 <\\- LAB(lum[i], coords(col2)[2], coords(col2)[3])\n\n## for each mixture level (columns)\n\nfor (j in 1:m) {\n\nc <\\- mixcolor(alpha[j],c1,c2)\n\nhexc <\\- hex(c,fixup=TRUE)\n\nC[i,j] <\\- hexc\n\n}\n\n}\n\nreturn(C)\n\n}\n\n## plot a vector or matrix of RGB colors\n\nplotPalette <\\- function(C,...) {\n\nif (!is.matrix(C)) {\n\nn <\\- 1\n\nC <\\- t(matrix(data=C))\n\n} else {\n\nn <\\- dim(C)[1]\n\n}\n\nplot(0, 0, type=\"n\", xlim = c(0, 1), ylim = c(0, n), axes = FALSE,\n\nmar=c(0,0,0,0),...)\n\n## helper function for plotting rectangles\n\nplotRectangle <\\- function(col, ybot=0, ytop=1, border = \"light gray\") {\n\nn <\\- length(col)\n\nrect(0:(n-1)/n, ybot, 1:n/n, ytop, col=col, border=border, mar=c(0,0,0,0))\n\n}\n\nfor (i in 1:n) {\n\nplotRectangle(C[i,], ybot=i-1, ytop=i)\n\n}\n\n}\n\n## Let's put it all together.\n\n## We make two colors in the LAB space, and then plot a 2D palette\n\n## going from 60 to 25 luminosity values.\n\nlibrary(colorspace)\n\nlightRed <\\- LAB(50,48,48)\n\nlightBlue <\\- LAB(50,-48,-48)\n\nC <\\- makePalette(col1=lightBlue, col2=lightRed, lum1=60, lum2=25, m=7, n=7)\n\nplotPalette(C, xlab='speed', ylab='density'\n\nConclusion\n\nAs this example has demonstrated, color—used thoughtfully and responsibly—can\nbe an incredibly valuable tool in visualizing high-dimensional data. The final\nproduct—five-dimensional pitch plots for all available data for the 2008\nseason—can be explored via the PitchFX Django-driven web tool at Dataspora\nlabs (<http://labs.dataspora.com/gameday/>).\n\nReferences and Further Reading\n\nFew, Stephen. 2006. Information Dashboard Design, Chapter 4. Sebastopol, CA:\nO’Reilly Media.\n\nIhaka, Ross. Lectures 12–14 on Information Visualization. Department of\nStatistics, University of Auckland.\n<http://www.stat.auckland.ac.nz/~ihaka/120/lectures.html>.\n\nSarkar, Deepayan. 2008. Lattice: Multivariate Data Visualization with R. New\nYork: Springer-Verlag.\n\nTufte, Edward. 2001. Envisioning Information, Chapter 4. Cheshire, CT:\nGraphics Press.\n\nWare, Colin. 2000. Information Visualization, Chapter 4. San Francisco, CA:\nMorgan Kaufmann.\n\n[1] See <http://en.wikipedia.org/wiki/CIELUV_color_space>.\n\n[2] See <http://processing.org>.\n\n\nChapter Five\n\nMapping Information: Redesigning the New York City Subway Map\n\nEddie Jabbour, as told to Julie Steele\n\nMaps are one of the most basic data visualizations that we have; we’ve been\nmaking them for millennia. But we still haven’t perfected them as a tool for\nunderstanding complex systems—and with 26 lines and 468 stations across five\nboroughs, the New York City subway system certainly is complex. The KickMap™\nis the result of my quest to design a more effective subway map, and\nultimately to encourage increased ridership.\n\nThe Need for a Better Tool\n\nI was born in Queens and raised in Brooklyn. The first subway map I saw was my\nfather’s, circa 1960. It made a vivid impression on me because it intimidated\nme. I saw a gray New York with red, green, and black lines running all over it\nlike a grid (see Figure 5-1), and hundreds of station names attached.[1] It\nreminded me of a complex electrical diagram that I couldn’t understand; it\nlooked very “adult-serious” and even a little scary. I hoped I’d never have to\ndeal with it.\n\n![bvis_0501.png](images/bvis_0501.png)\n\nFigure 5-1. The 1958 New York City Subway map designed by George Salomon. 1958\nNew York City Subway Map © MTA New York City Transit. Used with permission.\n\nLondon Calling\n\nIn college I majored in design, and I spent half a year studying at the\nUniversity of London. I was all on my own in a huge city I had never been to\nbefore. I quickly learned that the London Underground was the way to get\naround and that the “Tube map” was the key to understanding it. That map\n(which of course is the acclaimed Beck map seen in Figure 5-2) was brilliantly\nfriendly: simple, bright, functionally colorful, designed to help users easily\nunderstand connections between lines, and physically tiny. Folded, it fit\neasily into my pocket, to be whipped out at a second’s notice for immediate\nreference (which I did often!).\n\n![bvis_0502.png](images/bvis_0502.png)\n\nFigure 5-2. Harry Beck’s map of the London Underground makes a complex system\nappear simple and elegant. 1933 London Tube Map © TfL from the London\nTransport Museum collection. Used with permission.\n\nLondon was a medieval city, and therefore its street pattern is random. You\ncross a crooked intersection and the name of the street you’re on changes.\nThere’s no numbered grid to provide a frame of reference (like in New York),\nand moving through the city can be a disorienting experience. The genius of\nthe Beck map is that it makes order out of this random complexity, with the\nRiver Thames as the only visual (and geographic) point of reference to the\naboveground world. And for that reason, the map’s layout is iconic: when you\nthink of London, you probably think of that Tube map. But even as a design\nstudent, I didn’t think much about the form of it at the time—it was just so\nsimple and easy to use that travel felt effortless.\n\nThe combination of that effective little map and my unlimited monthly “Go As\nYou Please” pass allowed me to use the Underground daily to explore London. I\nwent anywhere and everywhere with ease and got the most that I could out of\nthat great city. The Tube map imparted information so quickly and clearly that\nit became an indispensible tool and an integral part of my experience. It made\nme feel that London was “mine” after only a couple of weeks of living there.\nWhat a fantastic and empowering feeling!\n\nIn fact, I formed such a warm attachment to that valuable tool that at the end\nof my stay, just before I left the city, I went to my local Underground\nstation and got a brand new Tube map, and when I returned home to New York I\nhad it framed.\n\nNew York Blues\n\nWhen you come back to your own city after six months away, you look at\neverything with new eyes. When I got back to New York, I saw our subway\nmap—really saw it—for the first time since I was a kid. And I thought,\ncompared to London’s, our subway map is poorly designed.\n\nI remember thinking that the New York subway map was the opposite of the Beck\nmap: huge in size, unruly in look, cluttered, and very nonintuitive. I\nrealized that this map was in many ways a barrier to using our great subway\nsystem—the opposite of the Tube map, whose simplicity was a key to\nunderstanding and using the Underground.\n\nEven as a designer, however, if I ever thought of creating my own subway map I\nmust have quickly dismissed the idea. This was in the late 1970s, and I’m not\na T-square kind of guy. The amount of discipline and mechanical time it would\nhave required for anyone but an experienced draftsman to undertake such an\nendeavor was unthinkable in that precomputer era.\n\nThe map’s deficiencies left my mind as I pursued my design career. Like most\nNew Yorkers, I used the subway map rarely and never carried it. This was in\npart because of its size: it was as large as a foldout road map. If I needed\nthe map’s information to get to a new location, I would tear out the relevant\nsix-inch square portion from a free map in the station and throw the rest of\nit in the trash! I often saw tourists struggling with the physical map and\nfelt bad for them, remembering my great experience as a student in London.\n\nBetter Tools Allow for Better Tools\n\nNow, fast-forward to one night years later when I was taking an out-of-town\nclient to dinner at a downtown restaurant. As we waited for the train, he\nconfided to me that New York’s subway intimidated him. I was surprised: the\ncrime and grime of the 1970s–1990s were virtually gone from the system, and I\nwas proud of our shiny new air-conditioned cars and clean stations. But in our\nconversation on the way downtown, I realized that his fear lay in not being\nable to decipher the complexity of the system: all the lines and connections.\nThat’s when I realized that the problem for him, too, was the map. My client\nwas very well traveled and urbane; if he found the system intimidating, then\nthere really was something wrong with the communicator of that system—the map.\n\nAt that moment the subway map re-entered my consciousness, and it hasn’t left\nsince.\n\nAt that point, it was 2002. I had my own design agency and my own staff, each\nof us with our own computer loaded with a copy of the greatest and most\nelegant graphic design tool available. I realized that now, just one person\nusing a graphic design program like Adobe Illustrator had the power to create\nhis own subway map! And I challenged myself to do something about the map.\n\nSize Is Only One Factor\n\nWhen I decided to try making a new map as a weekend project (ha!), the first\nthing I considered was the size. Since the New York City subway system has\nabout twice as many stations as London’s, I decided to give myself twice as\nmuch space as the Tube map takes. (Even doubling the size of the Tube map, the\nresult was about one-fifth the size of the existing New York subway map.)\n\nFirst, I took a paper version of the official Metropolitan Transit Authority\n(MTA) map (a version of which is shown in Figure 5-3), cut it up with\nscissors, and put it back together in a more efficient way (literally with\nScotch® tape), just to see the possibilities. I was encouraged as I managed to\nreduce the area by more then half. Gone were the 56 bus pop-up boxes and other\nnonsubway information! Then came the laborious task of creating an actual map.\nI entered all the station names and lines into an Illustrator document, and in\ntwo months, voilà! I had my very own smaller map! I folded it and easily put\nit in my wallet, and I carried it around and showed it to all my friends. They\nliked its size, but of course nobody wanted to actually use it, because it\nstill had many of the major design issues that made the MTA map difficult to\nuse.\n\n![bvis_0503.png](images/bvis_0503.png)\n\nFigure 5-3. The 2004 version of the MTA New York City subway map, based on a\ndesign by Michael Hertz. Besides its visual complexity, incomplete information\nmissing on the map itself forces the the user to rely on the complex charts in\nthe lower right section—right where sitting people block its view in the\nsubway cars—and in the stations where this information, displayed on large\nposters, is also difficult to read since it is often less than 18 inches off\nthe ground. New York City Subway Map © Metropolitan Transportation Authority.\nUsed with permission.\n\nIt was one thing to reduce the size, but another thing to realize that the way\nthe data was presented was not the best way to present it. So I asked myself:\nhow would I present all this data?\n\nTo answer this question, I had to ask a few more:\n\n  * What maps came before this map? \n  * Were there any previous conceptions that were discarded but perhaps still relevant? \n  * What was it about New York City and its subway that historically made it so difficult to map clearly and efficiently? \n\nLooking Back to Look Forward\n\nI did a research dive, and I started buying old transit maps on eBay. I\nstudied subway maps, New York City street maps, and transit maps from all over\nthe world that I had collected on my travels. I filtered through all the\ndesign approaches and eclectically took as much as I could from ideas that had\nalready been implemented (some brilliantly).\n\nOf course, in addition to the map designed by George Salomon that had been my\nfather’s subway map, I studied carefully the map designed by Massimo Vignelli\n(see Figure 5-4), which the MTA used from 1972 until 1979, when it was\nreplaced by the Tauranac-Hertz MTA map (which, 30 years later, still\nprevails). Vignelli’s map appealed to me immediately because, although big, it\ntook obvious inspiration from Beck’s Tube map, with its 90- and 45-degree\nangles, explicit station connections, and the use of color to denote\nindividual lines. There were also some smart aspects of the current MTA map\nthat I wanted to keep, despite finding it on the whole unwieldy because there\nis so much information crammed onto it. In addition, I borrowed liberally from\nother past efforts that had been discarded or forgotten.\n\n![bvis_0504.png](images/bvis_0504.png)\n\nFigure 5-4. The 1972 MTA New York City subway map designed by Massimo\nVignelli. Confusingly distorted geography for style’s sake—yet a stunning\ndesign icon. 1972 New York City Subway Map © MTA New York City Transit. Used\nwith permission.\n\nNew York’s Unique Complexity\n\nAs I conducted my research, I started to realize that New York City had its\nown unique set of challenges that made its subway system impossible to\naccurately and clearly map using just a diagrammatic method, as other cities\nlike London, Paris, and Tokyo had done. It was also clear that a pure\ntopographic mapping approach wouldn’t work, either; New York’s unique\ngeography and its gridiron street system both have an impact on mapping its\nsubway system.\n\nThere are four significant and conflicting aspects of the New York City subway\nsystem that make it impossible to successfully map with either a strict\ndiagrammatic or topographic format:\n\n  * The narrow geography of the principal thoroughfare, Manhattan Island, which has 17 separate subway lines running up and down Midtown alone in a width of six city blocks.\n  * The “cut and cover” method used to construct subway tunnels and elevated lines that follow the city’s gridiron street patterns. Because New York City’s subway generally follows its gridded street routes, there is a strong psychological link between the subway and the aboveground topography that is not found in a medieval city like London.\n  * The unique system of many of the subway lines running local, then express, then local again along their routes. \n  * Its formative history, with the current system evolving from three separate and competing subway systems (the IRT, BMT, and IND) that were poorly coordinated to work as a whole system. (The chaotic tangle of these three competing routes, as they meander and fight their way through the dense street plans of lower Manhattan, downtown Brooklyn, and Long Island City, is the most difficult part of the system to map clearly and accurately.)\n\nThe KickMap, shown in Figure 5-5, is based on a combination of ideas I\nselectively borrowed from many earlier maps (some dating back to the 19th\ncentury) and my own innovations. I believe that this unique combination makes\nmy map easier to use than most of the preceding efforts. In the following\nsections, I’ll discuss my inspirations and innovations in more detail.\n\n![bvis_0505.png](images/bvis_0505.png)\n\nFigure 5-5. The KickMap as it was released in 2007.\n\nGeography Is About Relationships\n\nMost of the boroughs—Queens, Brooklyn, Manhattan, and to some extent, the\nBronx—already have a grid on top of the subway system because of the way the\nstreets were planned. This makes the aboveground geography not only an\nintuitive starting point, but also an integral part of the user’s experience.\nKnowing your location—take 42nd Street and 7th Avenue as an example—places you\nin the grid, which makes it easy to judge distances and locations. This is why\nthe numerous geographical errors that appear in New York City subway maps\n(like the Vignelli map infamously placing the 50th Street and Broadway stop\nwest of 8th Avenue instead of east) are so glaring and easy to spot.\n\nOne of the issues I have with some previous versions of the New York subway\nmap is that I have a hard time believing that the designers ever actually rode\nthe subway as an integral part of their lives in the city. There’s a\ndisconnect between many of the decisions they made and the reality of the\nsubway. As part of my design process, I rode the lines and exited the stations\nat every major intersection with which I was unfamiliar. There is a strong\nrelationship in New York between the aboveground and the belowground, and\nsince subway riders don’t cease to exist when they leave the subway, it’s\nimportant for the map to express this relationship as clearly as possible.\nOtherwise, the result is an uncomfortable feeling of disorientation.\n\nInclude the Essentials\n\nConsider the L line in Brooklyn. As a passenger on the train, you’re jostled\naround as you travel and you don’t really notice that the line is curving or\nturning corners along major streets and intersections. But when you get out at\nthe Graham Avenue station, for instance, it’s obvious that Metropolitan Avenue\nand Bushwick Avenue are two major thoroughfares that intersect each other at a\nright angle. Why wouldn’t that show up on the map? If you didn’t know how the\nstreets intersected and you just saw a sign for one or the other as you came\nout of the subway, it would be very difficult to figure out what was going on.\n\nOn the Vignelli map, this portion of the L is depicted as a straight line (see\nFigure 5-6[a]). The Hertz map (Figure 5-6[c]) shows both Metropolitan and\nBushwick Avenues, but the line resembles nothing so much as a wet noodle as it\nhalf-heartedly depicts the route. I chose to carefully draw a stylized but\naccurate line describing the path as it runs along each major avenue there,\nbelieving this to be the best approach because it is the most helpful to\nriders (Figure 5-6[b]).\n\n![bvis_0506.png](images/bvis_0506.png)\n\nFigure 5-6. A portion of the L line in Brooklyn as depicted by (a) the\nVignelli map, (b) the KickMap, and (c) the Tauranac-Hertz map.\n\nConversely, I sometimes made stylistic simplifications to the geography in\norder to help riders. For example, Queens Boulevard, a major thoroughfare in\nQueens, was originally five different farm roads, and as a result it jigs and\njogs a bit as it makes its way from the Queensboro Bridge east across the\nborough. Recent maps didn’t capture its relationship to the subway because\nthey either ignored it entirely (as in the Vignelli map, shown in Figure\n5-7[a]) or obscured it (as in the current MTA map, shown in Figure 5-7[c]). On\nmy map, I styled Queens Boulevard as a straight line; see Figure 5-7(b). I\nchose to do this so that users could easily see its path and identify the\n“trade-off” subway lines that travel along it—where one subway line runs along\nthe road and then veers off and another line takes its place. In this case,\nthe 7 line runs along Queens Boulevard until it veers off along Roosevelt\nAvenue, and the R/V/G/E/F lines come down from Broadway and pick up its path\neast. My stylized approach uses logic to better convey the subway’s\nrelationship to the streets of Queens, which is not clearly apparent on either\nthe Vignelli map or the current MTA map.\n\n![bvis_0507.png](images/bvis_0507.png)\n\nFigure 5-7. The trade-off along Queens Boulevard as depicted by (a) the\nVignelli map, (b) the KickMap, and (c) the current MTA map.\n\nAnother “trade-off” I felt it was important to show clearly is at 42nd Street\nin Midtown Manhattan, where the 4/5/6 line jogs over from Park Avenue to\nLexington Avenue (see Figure 5-8). A would-be rider walking along in Midtown\nor Murray Hill needs to know which street to go to for a subway entrance. The\nVignelli map obscures the shift by treating it as a straight line, relying on\ntext to convey the road switch, and once again the current MTA map is at best\nvague and noodley. In my map, it’s clear which way the user should go.\n\n![bvis_0508.png](images/bvis_0508.png)\n\nFigure 5-8. A portion of the 4/5/6 line in Manhattan as depicted by (a) the\nVignelli map, (b) the KickMap, and (c) the current MTA map.\n\nLeave Out the Clutter\n\nWhile I felt that it was important to show certain shapes aboveground, I also\nfelt that it was important to leave out certain pieces of belowground\ninformation. There are several places where the subway tunnels cross and\noverlap each other beneath the surface. This may be important information for\ncity workers or utility companies trying to make repairs, but for the average\ncommuter, showing these interactions just creates visual noise. I tried to\nreduce that noise by cleanly separating the lines on the map so they don’t\noverlap. Consider the different depictions of the 4 line and the 5 line in the\nBronx (Figure 5-9); sure, the MTA’s paths may be accurate, but they’re also\nconfusing, and riders don’t really need to see those particular details to\nunderstand where they’re going.\n\n![bvis_0509.png](images/bvis_0509.png)\n\nFigure 5-9. The 4 line and the 5 line as depicted by (a) the KickMap and (b)\nthe current MTA map.\n\nColoring Inside the Lines\n\nThe belowground geography is important, but it’s more vital for the users to\nunderstand which belowground lines will take them where they want to go.\n\nIn 1967, the MTA moved past the tricolor theme used on the Salomon and earlier\nmaps and began to use individual colors to illustrate individual lines.\nHowever, this shift didn’t help simplify the system. It essentially had 26\nlines assigned 26 random colors, which didn’t really tell the user anything\nbeyond illustrating the continuity of a given route. Vignelli’s map (Figure\n5-10[a]) continued with this color system.\n\nThe Tauranac-Hertz (current MTA) map attempted to simplify things by\ncollapsing multiple subway lines onto one graphic line, but this actually made\nunderstanding the subway system more complicated, as now you had to read the\ntext next to each and every station to learn whether a specific line stopped\nthere or not; see Figure 5-10(c). What it did get right was that it color-\ncoded sets of subway lines that use the same track—for example, the A/C/E\nlines are all blue, and the 4/5/6 lines are all green. If you look at the\n“trunk” lines that run north and south through Manhattan, the colors move from\nblue to red to orange to yellow to green, creating a spectrum effect. These\ncolors are memorable and help riders discern which lines will take them in the\ngeneral direction they want to go.\n\nIn my map, I preserved the best elements of both approaches; see Figure\n5-10(b). I reused the spectral colors on the trunk lines, highlighting an\nelegance and reality inherent in the system that Tauranac-Hertz understood,\nbut kept it clear by representing each route with its own graphic line.\nTechnically, I did what Vignelli did in that I used 26 distinct colors, but I\ngrouped them in six or seven families of color and used different shades for\neach line in a given family: the A/C/E lines use shades of blue, the 4/5/6\nlines use shades of green, and so on.\n\n![bvis_0510.png](images/bvis_0510.png)\n\nFigure 5-10. The Manhattan “trunk” lines as depicted by (a) the current MTA\nmap, (b) the KickMap, and (c) the Vignelli map.\n\nI also made use of line IDs and colors for the station dots.[2] The crucial\nidea here was that the map should be quickly scannable, rather than just\nreadable. At each station where a line stops, I placed the name of that line\ninside a dot: this way, users can easily see exactly which trains stop at\nwhich stations without having to read a list of lines next to each station\nname. Use of different colored dots enables users to tell at a glance whether\nthe train always stops there or has special conditions, such as\nweekday/weekend or peak hour/off-peak hour restrictions.\n\nFinally, there are about 80 stations in the city where, if you’ve missed your\nstop, you can’t just get out and conveniently switch direction. I highlighted\nthese locations by placing a small red square next to the station name,\nindicating to riders who need to turn around which stations to avoid if they\ndon’t want to have to leave the station, cross the street, and re-enter the\nstation on the opposite side. The current MTA map shows all the heliports in\nthe city but doesn’t provide users with this simple but important piece of\nsubway information—a perfect example of its confused priorities.\n\nI believe that taken together, these decisions highlight the innovations that\nmake the KickMap more useable than those that came before it.\n\nSweat the Small Stuff\n\nThose decisions were easy for me, but other choices were more difficult. Which\ngeographic features did I really need to keep? What angles should I use? How\nmuch bus and ferry information should I include?\n\nSo, after creating my first comprehensive map that met my initial challenges\n(Figure 5-5), I decided to refine it and incorporate all of my learning. I was\nexcited.\n\nTry It On\n\nIn the car industry, it is common to build what is called a test mule, which\nis a prototype or preproduction car into which every possible experimental\nfeature is crammed; that prototype then undergoes a series of drivability\ntests to determine what should be removed (because it’s not essential or\ndoesn’t work quite right). I did the same thing with my map: I created a\nversion (shown in Figure 5-11) into which I put every feature that I might\npossibly want. Illustrator’s layers feature really came in handy here; I put a\nlot in this map that I ultimately turned off or toned down.\n\n![bvis_0511.png](images/bvis_0511.png)\n\nFigure 5-11. My version of a test mule for the map: I put lots of information\nin and then edited it down.\n\nThe mule map allowed me to evaluate a variety of trade-offs, such as:\n\nThe street grid\n\nI wanted to present the structure of the streets without interfering with the\nsubway info wherever I could. You’ll notice that the mule map includes a lot\nmore streets and street names than the final design.\n\nBeaches\n\nI thought green spaces were important, and that New Yorkers should be able to\nfind their way to beaches by subway rather than by car. My mule map included\nmunicipal swimming pools as well, but ultimately I decided to remove them.\n\nCoastline features\n\nIt was important that real people—like, say, my mom—could easily use this map,\nand she couldn’t care less about certain geographic details (like Steinway\nCreek or Wallabout Bay) that I included in the mule map. That was a reason to\nsimplify and stylize. But I also wanted to make something any map geek or\nlover of New York City (like me!) could appreciate. So, there were instances\nwhere I let my passion take over. I decided to pay homage to certain subway\nfeats, so I included features like the Gowanus Canal, which the Smith/9th\nStreet station crosses and has to clear (at 91 feet, it’s the highest elevated\nstation in the system).\n\nAngular design\n\nIn the final design I standardized a lot of the angles, but I broke that\nstandardization if I had to for clarity’s sake. I wasn’t a slave to the\nangles. Stylization is fine, but my goal was to take the stylization and make\nit work so that riders can always understand what’s going on aboveground. I\nalso decided to consistently place station names on the horizontal for easier\nreading, like on the London Tube map, instead of cramming them in at arbitrary\nangles.\n\nBridges and tunnels\n\nOne of my goals for this project was to come up with a tool that would\nencourage people to take the subway instead of a car. For this reason, I\ndecided to leave out all the car bridges and tunnels (except for the iconic\nBrooklyn Bridge). I wanted to keep the experience of navigating the subway as\nclean and easy as possible, without the temptation of using a car, to\nencourage users to keep riding.\n\nMany of these choices were influenced by the following principle.\n\nUsers Are Only Human\n\nThere are certain New York icons that help orient the rider and are\nreassuring. To the extent that they represent something familiar, maps can be\nquite emotional. So, I saw preserving such icons as a way to build\nfriendliness into this tool. I did not design a geographically precise\ntopographical map; I designed a map that is emotionally and geographically\naccurate in a relational sense—Manhattan looks like Manhattan, Central Park is\ngreen, the Hudson River is blue, and the subway stations are positionally\naccurate in relation to one another and the streets (Delancey Street is shown\neast of the Bowery, etc.).\n\nFor the same humanistic reason, I included certain celebrated landmarks—the\nStatue of Liberty, Ellis Island, and the Brooklyn Bridge. And I didn’t just\ninclude them with nametags; I actually included their familiar shapes, as was\ndone on subway maps back in the 1930s.[3]\n\nA City of Neighborhoods\n\nWhen I travel on the subway to see my mom, I’m not going to see her at the\n95th Street subway station; I’m going to see her at her home, which is in Bay\nRidge, Brooklyn. This is an important aspect of New York: it is a city made up\nof neighborhoods, and native New Yorkers think of the city in those terms.\nThat’s our frame of reference: we travel from, say, Washington Heights to Bay\nRidge.\n\nThe current MTA subway map includes some neighborhood names, but they are just\ndark blue words that compete with the station names and do little to describe\nthe areas. There’s no hierarchy of information. By color-coding the\nneighborhoods—which has been done on maps of the city since at least the\n1840s—in an unobtrusive way (using pastel tones) and writing their labels in\nwhite text so they wouldn’t visually interfere with the black text of the\nstation names, I was able to provide layers of information without\ncompromising the clarity and functionality of the subway map.\n\nAgain, these elements were literally created in separate digital layers in\nIllustrator. This allowed me to turn the neighborhoods on and off to determine\nwhat really needed to be there and to make several variations of the subway\nmap with and without them.\n\nOne Size Does Not Fit All\n\nI believe that separating functions is an important key to any useful\nvisualization or tool.\n\nAnother benefit of the layered approach was that it allowed me to custom-\ntailor the map to the user interface later. The KickMap is available as iPhone\nand iPad applications, and in that context, the map’s detail automatically\nchanges as the user zooms in or out. Besides the apps, commuters still read\nsubway maps in many different contexts: there is the foldout printed version,\nthe huge ones they hang in the stations, the ones they post in the train cars\n(right behind the seats so that you have to peer past someone’s ear to read\nthem), and the one that is posted online. Currently, you get basically the\nsame map in each place, but that shouldn’t be the case: in each context, a\nslightly different version, optimized just for that specific environment,\nshould be available.\n\nEach version should have its own design, tailored to the context in which it\nappears. The big maps that hang in the stations, for instance, should show you\nthe neighborhoods, but the one in the subway car that riders reference to make\nquick decisions, like whether to get off at the next station, need not. And\nwhy does the map in the subway car have to give you all that bus information?\n\nContexts aren’t just physical, either. After 11:00 pm in New York, 26 routes\nreduce to 19. So, in addition to the main day/evening KickMap, I made the\nnight map shown in Figure 5-12. Instead of relying on a text-heavy, hard-to-\nread chart at the bottom of a one-size-fits-all map to determine when a\ncertain route is available, a night map should be available to riders (not\nonly on their iPhones, but also in the subway cars).\n\n![bvis_0512.png](images/bvis_0512.png)\n\nFigure 5-12. The night version of the KickMap shows only the lines that run\nbetween 11:00 p.m. and 6:30 a.m.\n\nWhen it came to making a night map, I simplified the day/evening version and\ntook out most of the street and neighborhood information, as it seemed\nredundant.\n\nAlso, I do love the simple and elegant aesthetic of Beck’s Underground map,\nand keeping the night map’s form simple pays homage to it!\n\nConclusion\n\nUltimately, I do think the KickMap accomplished most of my goals: to make the\nsubway lines and their connections as clear as possible for easier navigation,\nand to provide users with a clear representation of where they are once they\nexit a station so that the subway feels familiar and welcoming to all.\n\nMy main goal, however, was to get my map out there into the hands of subway\nriders. After the MTA rejected my design, I found an alternative way to\ndistribute it, via Apple’s iTunes—two apps, one free and one paid, for the\niPhone, iPod Touch, and iPad.\n\nAll of the choices I made were aimed at trying to make the user experience as\nseamless and pleasant as possible. Clearly I’m striking a chord, as over\n250,000 people (and counting) have now downloaded copies of the KickMap from\niTunes. That’s really great but I still want the KickMap—or something\nsuperior—to replace the current one in the subway system. I want people to be\ncomfortable and even happy when using our unbeatable 24-hour subway system. It\nis a complex system, but if people know how easy it can be—if the map becomes\na friend[4] instead of an obstacle—ridership will increase. Ultimately, that\nbenefits not only the system itself, but also all of us who live, work, visit,\nand breathe here.\n\n[1]* I now know that map was an early version of the Salomon map. Years later,\nwhen I was doing research for the creation of the KickMap, I got to appreciate\nthe beauty of the design of this map.\n\n[2] This was a big aha moment in my process.\n\n[3] I wanted to put the Empire State Building in there, but it would have\ncluttered up Midtown, and my goal all along was that it really had to be a\nsimple and functional subway map!\n\n[4] I think many people are passionate about the subway map as a great symbol\nof New York. The map shows the subway as kind of a dynamic capillary system\nnourishing the city. This is true not only conceptually but also historically:\nthe subway was built to “nourish” new residential areas with cheap\ntransportation to and from the central business districts so the City could\ncontinue to grow and thrive.\n\n\nChapter Six\n\nFlight Patterns: A Deep Dive\n\nAaron Koblin with Valdean Klump\n\nThere are roads in the sky. We can’t see them, but they are there: distinct,\nsharply defined avenues, traversed by thousands of airplanes every day. As\nindividual observers we might never guess this was the case, but plotting the\nraw flight data shows us otherwise (Figure 6-1).\n\nFlight Patterns is a project I started in 2005 that visualizes civilian air\ntraffic in the United States and Canada. It exists in two mediums: still\nimagery, which traces aircraft arriving and departing from U.S. and Canadian\nairports over a 24-hour period, and video imagery, which depicts the same data\nin motion. In this chapter, I’ll show you some of these images and talk about\nthe techniques I used to render them. I’ll also share some thoughts on why I\nfind this project so compelling, and why I hope you will as well.[1]\n\n![bvis_0601.png](images/bvis_0601.png)\n\nFigure 6-1. Flight Patterns, a visualization of aircraft location data for\nairplanes arriving at and departing from U.S. and Canadian airports\n\nTo begin with, I want to draw your attention to what I believe are the two\nmost striking features of the visualization. The first is the tendency of\nairplanes to follow the exact same flight paths as other planes. When I\noriginally rendered the data, I expected to see tight groupings of planes\nclose to airports and a vast dispersion between them. Instead, I found the\nopposite: flight paths between airports tend to cluster, and then, as the\nplanes get closer to landing or departing, their flight paths tend to disperse\n(Figures 6-2 and 6-3).\n\nWhen you think about it, this is quite interesting. The sky is wide open,\nwithout any natural restrictions whatsoever, so planes can travel by any route\nthey choose. And yet when looking at Flight Patterns, it almost appears as if\nthere’s a map to the sky, a kind of aerial highway system, with designated\nroutes between various destinations. You can even make out the roads.\n\nWhy is this happening? To be honest, I don’t know for sure. The routes may\nsimply be the most efficient flight paths, or—more likely, I think—they may be\ndetermined by a combination of many factors: the airplanes’ autopilot systems,\ngovernment-mandated flight paths, directions from the carriers, air traffic\ncontrol systems, rules meant to limit traffic over areas with large\npopulations, and meteorological factors such as wind direction and air\npressure. Regardless, I think this tendency is striking, because it shows the\nlogical organization of a completely open space. It’s for this reason that I\nchose the word “patterns” for the name of the project.\n\n![bvis_0602.png](images/bvis_0602.png)\n\nFigure 6-2. Closeup of a section of Figure 6-1 that reflects what I expected\nto find throughout the data: flight paths going in every direction\n\n![bvis_0603.png](images/bvis_0603.png)\n\nFigure 6-3. Another closeup that reflects what I found to be common instead:\nclear, bright lines that indicate flight paths followed closely by high\nvolumes of planes\n\nThe second striking feature of Flight Patterns is that it allows us to\nvisualize the vastness of the U.S. and Canadian air transportation system. To\nme, this is what makes data visualization so valuable. We cannot grasp the\ntotality of flight traffic in the U.S. and Canada by looking up at the sky or\nby seeing the raw numbers, but we can understand it through visualization.\nViewed together, the flight paths show us more than the sum of their parts:\nthey show us a system—and the system, I believe, is beautiful. It reveals\nsomething not just about flight paths, but about the geography of human\npopulations, and more broadly, of our species’s clear desire to travel.\n\nTechniques and Data\n\nFlight Patterns was created with Processing,[2] a programming language that is\nparticularly suited for data visualization. Once the flight data was procured\n(always a critical step), I wrote a simple Processing program to translate\neach data point’s latitude and longitude into a 2D map on my computer screen.\nConcurrently, I added selective color to each point to indicate information\nsuch as altitude and aircraft model. I then exported all of these images as\nTGA files.\n\nThe videos were a little trickier. Showing the airplanes as moving dots failed\nto reveal the progress of each flight. So instead I drew lines between each\ndata point, and, after a set time interval (3 minutes or 5 minutes, depending\non the dataset), I added a 4% black opacity layer over the entire map. This\nmeant that older flight paths would fade into the background over time, which\nhelped to show the planes’ progress.\n\nThe data used in Flight Patterns is a processed version of the Aircraft Situation Display to Industry (ASDI) feed, a record of all civilian flight paths that is published by the FAA.[3] The feed is available only to companies with ties to the aviation industry. Thanks to my colleague Scott Hessels, I received 28 hours’ worth of this flight data in 2005. My initial visualization was a contribution to the Celestial Mechanics project completed along with Gabriel Dunne at UCLA’s Design | Media Arts program.\n\nThe initial dataset I worked with was from March 19–20, 2005, and includes\n141,029 flights, sampled every 3 minutes, for a total of 6,871,383 data\npoints. Three years later, in 2008, I worked with Wired magazine to obtain\nanother dataset. This data came from August 12–13, 2008, and includes 205,514\nflights, sampled every minute, for a total of 26,552,304 data points.\n\nThe data I received that was derived from the ASDI feed included the following\ninformation for each data point:\n\n  * Latitude\n  * Longitude\n  * Altitude\n  * Aircraft manufacturer\n  * Aircraft model\n  * Timestamp\n  * Flight number\n\nIf you are interested in seeing some of the data yourself, the FAA presently\nprovides a sample of the ASDI feed in XML format at\n<http://www.fly.faa.gov/ASDI/asdi.html>.\n\nColor\n\nFlight Patterns does not use any complex mapmaking techniques: simply plotting\nthe data speaks for itself. However, color plays an important role in telling\ndifferent stories using the same flight paths. Figures 6-4 through 6-9 show\nsome examples.\n\n![bvis_0604.png](images/bvis_0604.png)\n\nFigure 6-4. In this map, color indicates altitude, with pure white meaning the\nplane is at ground level\n\n![bvis_0605.png](images/bvis_0605.png)\n\nFigure 6-5. A closeup on the Atlanta airport, clearly showing the layout of\nthe runways (again, color indicates altitude)\n\n![bvis_0606.png](images/bvis_0606.png)\n\nFigure 6-6. In this map, color is used to distinguish between different models\nof aircraft\n\n![bvis_0607.png](images/bvis_0607.png)\n\nFigure 6-7. A map of a single aircraft model, showing only flights on Embraer\nERJ 145 regional jets\n\n![bvis_0608.png](images/bvis_0608.png)\n\nFigure 6-8. Another map of a single aircraft model, showing only flights on\nBoeing 737 jets\n\n![bvis_0609.png](images/bvis_0609.png)\n\nFigure 6-9. In this map, separate colors show takeoffs and landings: orange\nindicates a descending plane and blue indicates an ascending plane\n\nMotion\n\nIn motion, Flight Patterns reveals new pieces of information, including\naircraft direction and volume over time. The visualization tracks flights from\none evening to the next in order to show the country falling asleep and waking\nup the following day (Figures 6-10 and 6-11).\n\n![bvis_0610.png](images/bvis_0610.png)\n\nFigure 6-10. The East Coast wakes up: this still image, from 7:31 a.m. EST on\nMarch 20, 2005, shows high activity on the East Coast and virtual stillness on\nthe West Coast (except for a few redeye flights flying northeast from Hawaii)\n\n![bvis_0611.png](images/bvis_0611.png)\n\nFigure 6-11. At 4:10 p.m. EST, we see a very different story: at this moment,\nair traffic peaks with 19,255 planes in the air\n\nOn my website, I’ve also included a video of a 3D visualization that plots\naltitude along the z-axis in a 3D projection. In order for this axis to be\ndiscernible versus the lateral scale of the continent, I’ve exaggerated the\naltitude considerably, and it makes for a dense but interesting visualization.\nIt doesn’t print well, however. I recommend you take a look online if you’re\ninterested.\n\nAnomalies and Errors\n\nLike many datasets, the data I used in Flight Patterns contained a number of\nerrors and anomalies, some of which I removed. For example, while trying to\nfind the fastest flight in the dataset, I identified one flight that crossed\nthe entire country in 6 minutes—clearly an error. Another flight zigzagged\ndramatically (and impossibly) north and south while crossing the\ncountry—another clear error. I removed both of these flights.\n\nThere were other anomalies, however, that I kept. For example, the flight\npaths over the north Atlantic appear jagged (Figure 6-12). I opted to keep\nthis data in the visualization because it was important to show the flights\ncoming from Europe. I don’t know why those errors are there. They could\nindicate problems with the planes’ instruments, the processing of the ASDI, or\nan error by the data supplier. After fretting about it for a long time, I\ndecided to simply leave the data as it was. Also, when looking for the\nshortest flight, I found that over 3,000 aircraft had reported their locations\nwithout ever departing the airport; I kept these anomalies, too.\n\n![bvis_0612.png](images/bvis_0612.png)\n\nFigure 6-12. Flight paths over the north Atlantic show some anomalies in the\ndata\n\nIf you look carefully at the visualization, you will notice some interesting\nfeatures. One obvious example is the restricted no-fly zones over Nevada\n(Figure 6-13). It doesn’t appear as if these no-fly zones are completely\nrestricted, though: a tiny number of flights crossing this dark space are just\ndiscernable.\n\n![bvis_0613.png](images/bvis_0613.png)\n\nFigure 6-13. A closeup look at no-fly zones in the southwest United States\n\nEvery time you work with large, organic datasets, you will find errors and\nanomalies, and I think it’s important to consider how to handle them. For each\ncase, I ask myself, will I harm the integrity of the data by manipulating it?\nIf the answer is yes, it’s best to simply leave the data as it is or, in the\ncase of obvious errors, remove them entirely. If anything, you should\ncelebrate anomalies rather than removing them (and be sure to investigate them\nfor the interesting stories).\n\nConclusion\n\nFlight Patterns is a simple data visualization, and this simplicity makes it\ncompelling for several reasons. For one thing, the project reveals a map of\nour air transit system, which is something that has never before been\nvisualized publicly, as far as I’m aware. Secondly, the visualization is easy\nto understand, even though it is made entirely from data—the airports in the\nvisualization create nodes that conform to our geographical conception of\nNorth America (Figure 6-14). Likewise, the densest flight paths fall over\nareas of high population, just as we’d expect.\n\n![bvis_0614.png](images/bvis_0614.png)\n\nFigure 6-14. A closeup on the southwest United States—how many airports can\nyou identify?\n\nFinally, I find Flight Patterns compelling because it is comforting. This is\nperhaps a strange emotion to associate with a map, but by showing the\norderliness of air transport and by uncovering the mystery of how planes get\nfrom place to place, Flight Patterns reveals a logical system that we are only\na tiny part of when sitting in seat 16A at 34,000 feet. It’s comforting, I\nthink, to see a system that works so well, at such a high volume. With over\n200,000 flights in one day in the U.S. and Canada alone, we truly have created\nroads in the sky, every one of them guiding thousands of people from origin to\ndestination, and with a remarkable safety record. In this sense, Flight\nPatterns is more than a data visualization: it is a showcase for the miracle\nof modern air travel.\n\nAcknowledgments\n\nI owe the idea and inspiration for Flight Patterns to two colleagues at UCLA,\nGabriel Dunne and Scott Hessels. In 2005, we started an art project called\nCelestial Mechanics (<http://cmlab.com>) that depicts air and space systems in\nmotion. A small part of the project was devoted to aircraft flight data, and\nthey provided me with the data so I could build what became Flight Patterns.\nThanks also to Mark Hansen, of UCLA, and Wired magazine (especially Carl\nDeTorres) for further assistance in procuring the data for these images.\n\n[1] All of the images in this chapter are available in high resolution online,\nso if you find them intriguing, I recommend that you visit my website to get a\nbetter look at them: <http://www.aaronkoblin.com/work/flightpatterns/>. On the\nsite, you may zoom in to the visualizations as well as view them in colors\nindicating aircraft altitude, model, and manufacturer. You may also view\nvideos of the flight data in motion.\n\n[2] See <http://processing.org>.\n\n[3] “Civilian” means all nonmilitary commercial and private flights tracked by\nthe FAA.\n\n\nChapter Seven\n\nYour Choices Reveal Who You Are: Mining and Visualizing Social Patterns\n\nValdis Krebs\n\nData mining and data visualization go hand in hand. Finding complex patterns\nin data and making them visible for further interpretation utilizes the power\nof computers, along with the power of the human mind. Used properly, this is a\ngreat combination, enabling efficient and sophisticated data crunching and\npattern recognition.\n\nIn this chapter, we will explore several datasets that reveal interesting\ninsights into the human behaviors behind them. Patterns formed by event\nattendance and object selection will give us clues into the thinking and\nbehavior of the humans attending the events and choosing the objects. Often,\nour simple behaviors and choices can reveal who we are, and whom we are like.\n\nEarly Social Graphs\n\nIn the 1930s, a group of sociologists and ethnographers did a small “data\nmining” experiment. They wanted to derive the social structure of a group of\nwomen in a small town in the southern United States. They used public data\nthat appeared in the local newspaper. Their dataset was small: 18 women\nattending 14 different social events.\n\nThey wondered: could we figure out the social structure (today we call it a\nsocial graph) of this group of women? To this end, they posed the following\nquestions:\n\n  * Who is a friend of whom? \n  * Which social circles are they all in? \n  * Who plays a key role in the social structure? \n\nIdentifying network structures normally involves invasive interviews and\nsurveys. Would it be possible to derive network structures by just examining\npublic behaviors? The real question was: do public choices reveal who you are\nand whom you are like?\n\nBeing able to see actual connections inside any human system, organization, or\ncommunity is critical to understanding how groups work and how their members\nbehave. Social network analysis (SNA) is a currently popular set of social\nscience methods used for marketing, improving organizational effectiveness,\nbuilding economic networks, tracking disease outbreaks, uncovering fraud and\ncorruption, analyzing patterns found in online social networks, and disrupting\nterrorist networks. SNA techniques can also reveal underlying network\nstructures in the Southern Women dataset, as we will see in a bit.\n\nSNA started as sociometry in the early 20th century. Jacob Moreno’s drawings\nof friendship links (or sociograms) between students in his school are very\npopular amongst social science historians, and business scholars point to the\nfamous Hawthorne factory worker studies from earlier in the century and the\nsketches of work interactions between the “Bank Wiring Room” employees.\nFriendship ties amongst the Wiring Room employees are illustrated in Figure\n7-1.\n\n![bvis_0701.png](images/bvis_0701.png)\n\nFigure 7-1. Early 20th-century social graph used in studying workflows amongst\nemployees\n\nSNA maps a human system as nodes and links. The nodes are usually people, and\nthe links are either relationships between people or flows between people. The\nlinks can be directional. When the nodes are of only one type—for example,\npeople, as in the Moreno and Hawthorne studies—it is called one-mode analysis.\n\nHowever, the Southern Women study began as a slightly more complex form of\nsocial analysis: two-mode. There were two sets of nodes—people and events—and\nthe links showed which people attended which events. The social graph for the\ntwo data modes are shown in Figure 7-2. The women are the blue nodes on the\nleft, while the events that each attended are the green nodes on the right.\nPeople are represented by circles, while events are represented by squares.\n\n![bvis_0702.png](images/bvis_0702.png)\n\nFigure 7-2. Two-mode view of the Southern Women social event dataset\n\nThis diagram reveals various types of conclusions, such as:\n\n  * Woman #3 attended more events than woman #18.\n  * Event #8 had the most attendees.\n\nOther than these simple observations, the two-mode view does not reveal any\nobvious patterns, such as the women’s social structure or the relationships\namong the events. To see these deeper insights, we can transform the two-mode\ndata into one-mode data by using a popular social network analysis technique:\ntransforming nodes to links. In the first transformation, we’ll take the event\nnodes and view them as links instead:\n\nWoman X is connected to woman Y as they both attended Event Z.\n\nThe more events the women attended together, the stronger their tie is. We can\nalso shift the focus to look at the network of events:\n\nEvent A is connected to event B if they were both attended by the same woman,\nC.\n\nThe more women who attended the same two events, the stronger the connection\nis between the two events. There are many methods to calculate the link\nstrength when transforming a two-mode network to a one-mode network. In this\nexample, we use the simplest method: adding up the co-occurrences.\n\nThe network of events is shown in Figure 7-3. A thicker line reveals a\nstronger relationship between two events—i.e., that more women attended both\nevents. The SNA software organizes the network according to who is connected\nto whom using an advanced graph layout algorithm: a node’s place in the\nnetwork is determined by its connections and the connections of those\nconnections.\n\n![bvis_0703.png](images/bvis_0703.png)\n\nFigure 7-3. Layout of events based on attendance by people in common\n\nThe center of the graph attracts the better-connected nodes, while the less-\nconnected nodes are pushed toward the periphery. Thus, it is obvious at a\nglance which events were most important in this social calendar. However, we\nstill do not have a picture of what interests us the most: the emergent social\nnetwork of the women in this small town. To begin to reveal that network, I\nused my gradual inclusion method, which focuses initially on the strongest\nties in the structure and then gradually lowers the membership threshold to\nreveal weaker ties in the network, allowing more people to connect to whoever\nis there already. This method usually ignores the very weak ties in the data,\ndismissing them as social noise. In this case, with the small dataset, the\ndismissal of light connectivity must be done carefully. In a dataset with\nmillions of nodes and millions of choices, adjusting the bar for social noise\nis usually a less delicate operation.\n\nUsing a five-point scale, with 5 indicating the strongest tie between two\nnodes and 1 indicating the weakest, I started using my gradual inclusion\nmethod with strength = 5 links—in other words, identifying those women who had\nattended the most events in common. Figure 7-4 reveals the strongest ties\nbased on event attendance.\n\nI immediately saw two clusters form: one with women #1, #2, #3, and #4, and\nthe other with women #12, #13, and #15. I colored the nodes using two\ndifferent colors to distinguish the membership in each group.\n\nNext, I included the next lower level of ties: strength = 4 links. This\nresulted in new members being included in each cluster, but did not reveal any\nconnection between the two clusters. As you can see in Figure 7-5, we still\nhave two distinct groups.\n\n![bvis_0704.png](images/bvis_0704.png)\n\nFigure 7-4. Strongest ties amongst women based on common event attendance\n\n![bvis_0705.png](images/bvis_0705.png)\n\nFigure 7-5. The two strongest link levels between women attending common\nsocial events\n\nIncluding the strength = 3 ties revealed bridging between the groups, as\nFigure 7-6 illustrates. This is common in most social structures: the\nstrongest ties occur within a group, while the weaker, less frequent ties\noccur between groups. There were also some weaker ties within each group,\nindicating that not everyone within a given group has a strong tie to all\nmembers of that group.\n\n![bvis_0706.png](images/bvis_0706.png)\n\nFigure 7-6. The two groups are bridged with gradual inclusion of weaker ties\n\nOur social structure is still missing a few nodes: women #16, #17, and #18.\nThey have not met the criteria for attachment in any of the previous waves of\ninclusion using the gradual inclusion method. Perhaps they are new in town, or\nare just less social and have attended fewer events, making it more difficult\nto determine their membership. These three women attach to the network when I\nlower the threshold to strength = 2 links. Now all women are attached to the\nnetwork, while the original two-cluster structure remains. Woman #16 is the\nonly one that does not obviously belong to one cluster or the other; she has\nequal infrequent ties to both clusters. I therefore classify her as a member\nof neither cluster (not both clusters!) and color her purple. The final\nemergent social graph is shown in Figure 7-7.\n\n![bvis_0707.png](images/bvis_0707.png)\n\nFigure 7-7. Emergent social graph of women based on common attendance at\nsocial events\n\nAll 18 women have now been placed in the social network based on their\nattendance of local social events. This social network reveals a few\ninteresting things about this small town’s social structure:\n\n  * Two distinct social clusters exist.\n  * The clusters are connected. This social overlap reveals some possible commonality in interests and relations between the two clusters.\n  * Various network roles emerge. Some women are connectors, bridging the two clusters, while others act as internal core members, connecting only to their own groups.\n\nSocial graphs like that in Figure 7-7 can be used for marketing purposes or\nword-of-mouth campaigns. More information can usually be gathered than this\nsimple example provides, but some deductions can nonetheless be drawn from\nthis data:\n\n  * Woman #6 will probably not be influenced by what woman #12 does or says.\n  * Woman #4 probably has the highest internal influence within the blue cluster. She may be the one that reinforces the status quo with everyone in her group.\n  * Woman #9 in the blue cluster is the boundary spanner—the person bridging the two clusters—and probably brings new ideas and opinions into the group. It is good that she has at least one strong tie within the group, to woman #4, who is well connected within the group. People who bring new ideas into a group often need at least one strong, internally well-connected ally.\n  * Women #16, #17, and #18 may be new in town or may not be “joiners.” They have some access to what is happening in the groups, but they may not have access to the real private information in either group because of their weaker connections.\n\nDifferent data-mining algorithms often produce different results, even with a\nsmall dataset such as this one. Over the years, various sociologists and\nnetwork scientists have re-examined this interesting little dataset, applying\ntheir fresh new algorithms to see what patterns emerge. Figure 7-8 shows the\nresults from 21 of the most popular studies. Our results match those of study\n#13, by Linton Freeman (Freeman 2003): women #1–9 are in one group, women\n#10–15 and #17–18 are in the other group, and woman #16 belongs to both\ngroups. Freeman was a key player in establishing the field of social network\nanalysis (Freeman 2004) and was especially important in establishing some\nearly network metrics that are still popular today (Freeman 1979).\n\n![bvis_0708.png](images/bvis_0708.png)\n\nFigure 7-8. Results of 21 studies of the Southern Women social event dataset\nby network scientists (Freeman 2003)\n\nLook at the various membership groupings in Table 7-1. Most of the studies\ncame to highly similar conclusions, and all found two distinct clusters in the\ndata. However, there is not total agreement about who is in each cluster,\nespecially for women #8–18.\n\nThis table illustrates membership groupings well, but it does not reveal\nnetwork roles and social distances. The network map in Figure 7-7 does reveal\nthe nuances of the social structure and shows the points of failure in the\nnetwork—that is, where it is most likely to break down. For instance, if woman\n#3 were to move away, the network would be disrupted the most. It would be\ninteresting to see how both woman #4 and woman #9 would respond to the exit of\nwoman #3.\n\nSocial Graphs of Amazon Book Purchasing Data\n\nAmazon.com allows easy access to summary purchase data (transaction data is\naggregated to prevent individual identification). The book purchasing data\nAmazon provides forms a similar network dataset to the event network in Figure\n7-3. Instead of attending the same social events, on Amazon, people are\nconnected to one another by purchasing the same books. In both cases,\nconnections are made because certain people make the same choices as others.\n\nOn each item’s page, Amazon provides the following information:\n\nCustomers Who Bought This Item Also Bought\n\nWhen people buy two items, an association is formed between those items. The\nmore people purchase both items, the stronger the association is and the\nhigher on the list the also bought item appears. Although usually people are\nrepresented by nodes, in this case Amazon’s customers are the links in the\nnetwork, and the items they purchase are the nodes. Consequently, Amazon is\nable to generate a network that provides significant information about its\ncustomers’ choices and preferences, without revealing any personal data about\nthe individual customers. Patterns are revealed, while privacy is maintained.\nWith a little data mining and some data visualization, we can get great\ninsights into the habits and choices of Amazon’s customers—that is, we can\ncome to understand groups of people without knowing about their individual\nchoices.\n\nDetermining the Network Around a Particular Book\n\nOne of the cardinal rules of human networks is “birds of a feather flock\ntogether.” Friends of friends become friends, and coworkers of coworkers\nbecome colleagues. Dense clusters of connections emerge throughout the social\nspace. In the social networks we visualize, we see those birds of a feather\nnear each other on the map.\n\nLet’s take a look at a popular computer book available via Amazon: Toby\nSegaran and Jeff Hammerbacher’s [Beautiful\nData](http://oreilly.com/catalog/9780596157111/) (O’Reilly). Among other\ninformation, the book’s Amazon page provides a product description,\npublication details, and a brief list of “also bought” books. What does this\nlist tell us about the book we are viewing? Being a student of networks, my\ninquiry about this book did not stop at the also bought books listed on this\nweb page (one step in the network). I wanted to know what would happen if I\nfollowed the links to each of those books and joined the lists I found there\ninto a network (one and two steps in the network).\n\nKey to understanding the dynamics of networks is the ability to perceive the\nemergent patterns of connections that surround an individual node, or that are\npresent within and around a community of interest. I wanted to see the network\nin which my book of interest was embedded. Seeing those connections can\nprovide insight into the network neighborhood—the network surrounding this\nbook—which can help a consumer make a smarter purchase.\n\nTracing the network out two steps from the focus node is a common procedure in\nsocial network analysis when studying ego networks. An ego network allows us\nto see who is in one’s network neighborhood, how they are interconnected, and\nhow this structure may influence the ego—the focus node.\n\nAs I collected the also bought books around Beautiful Data, I wondered:\n\n  * What themes would I see in the books and in their connections?\n  * What other topics interest the readers of Beautiful Data?\n  * Will Beautiful Data end up in the center of one large, massively interconnected cluster or be a part of one distinct community of interest amongst several?\n\nFigure 7-9 shows the book network surrounding Beautiful Data. Each node\nrepresents a book purchased on Amazon. A gray line links books that were\npurchased together, with the arrowhead pointing in the direction of the also\nbought book. The red nodes represent other books published by O’Reilly Media,\nwhile the yellow nodes represent books from other publishers.\n\nIn networks, it is not the number of connections one has, but where those\nconnections lead, that creates advantage. The golden rule in networks is the\nsame as in real estate: location, location, location. In real estate, what\nmatters is physical location: geography. In networks, it is virtual location,\ndetermined by the pattern of connections surrounding a node.\n\nThe nodes in Figure 7-9 self-organize, in the graph space, by their ties to\nalso bought books. This allows similar books to self-organize together to form\nclusters of like topics, which reveal the human communities of interest behind\nthe book clusters. In Figure 7-9, two obvious groupings cling together by\ntopic:\n\n  * The bottom-right grouping is all about programmers and programming.\n  * The grouping at the top of the graph is all about the Semantic Web.\n\nAlthough clusters emerge in Figure 7-9, they are not as obvious as some others\nthat we will see later; these clusters are intermixed and overlap, especially\naround other books about modern programming methods and processes.\n\n![bvis_0709.png](images/bvis_0709.png)\n\nFigure 7-9. The network neighborhood of books surrounding Beautiful Data\n\nIn addition to clusters of like topics, in Figure 7-9 there are clusters\naround the publishers, designated by the node colors: red books connect to\nother red books and yellows connect to other yellows. This indicates that\npeople who like O’Reilly books tend to buy other O’Reilly books. Node size\nalso appears to form a weak pattern of connectivity across similarly sized\nnodes. Large nodes, the nonlocal influence across the graph, connect to other\nlarge nodes, while medium and small nodes often connect to one another. This\nis a pattern we often see in human networks—again, birds of a feather flock\ntogether. It is not a pattern we see with the physical structure of the\nInternet, though, where many small nodes connect to a few very large nodes,\ncreating an obvious hub-and-spoke pattern. That is often referred to as a\nscale-free network.\n\nNext, I examined the network measures of each node/book, to see which nodes\nwere well positioned in the web of connections. Since this is a directed\nnetwork, much like the World Wide Web, I calculated influence metrics similar\nto Google’s PageRank. These metrics were calculated using both direct and\nindirect links around each node. Like on the Web, a better-connected node\ntransfers more influence. These metrics do not reflect sales volumes or the\npopularity that quantity conveys; rather, they reveal what thousands of Amazon\npurchasers feel belong together—what the “birds of a feather” books are. The\nlarger nodes have greater influence in this community of interest based on the\npattern of also bought purchases.\n\nAnother common network measure is structural equivalence. This measure reveals\nwhich nodes play a similar role in a network. Equivalent nodes may be\nsubstitutable for one another in the network. As an author, I would not like\nmy book to be substitutable with many other books! As a reader, however, I\nwould like equivalent choices. In Figure 7-9, the two books with the most\nsimilar link pattern to Beautiful Data are Cloud Application Architectures and\nProgramming the Semantic Web.\n\nAnother value-added service that Amazon provides is reader-submitted book\nreviews. A person considering the purchase of a particular book may be aided\nby the many reviews that accumulate. Unfortunately, the reviews can be skewed:\nan author with a large personal network can quickly get a dozen or more\nglowing reviews of his latest book posted to Amazon, and a reader with a\ngrudge can do the opposite. Doing comparison shopping based on reader reviews\nalone may, therefore, be misleading.\n\nThe book network map may be a better indicator than individual reviews of\nwhich other books to buy. Books linked from many other similar books reflect\ncritical choices made by purchasers, who spent money on those books. Surely\nthis behavior is not random; it is executed on the basis of thought and\ncomparisons. A purchase decision is the best review of all, even if it is\nnever written.\n\nThe book network maps I’ve shown are designed to eliminate the peripheral\nnodes in the network (i.e., those with very few connections). The network map\nin Figure 7-9 shows a 3-core network—a network in which each node has a\nminimum of three connections to other nodes. To achieve this, all nodes with\nonly one or two incoming links were removed. These were nodes that led to\nother communities of interest, that represented new or very old books, or that\nhad very few also bought links from this community.\n\nPutting the Results to Work\n\nThese community-of-interest maps can also work in a similar capacity with\nother consumer items. If I am not familiar with a product, an author, an\nartist, a vintage, a brand, a movie, or a song, I would like to be able to\njudge it by the company it keeps—its network neighborhood. Here are the\nrelevant questions to ask:\n\n  * What nodes point to this item?\n  * What communities is it a member of?\n  * Is it central in the community?\n  * Does it bridge communities?\n  * Are there equivalent alternatives?\n\nIt appears that as a customer of Amazon, I can make smarter decisions by\nviewing the embeddedness—the context within the network—of various items\nAmazon sells in different communities of interest. Other vendors, such as\nNetflix and Apple’s iTunes, probably do similar analysis before recommending a\nmovie or a new song or artist. By gathering information on thousands of\ncustomers and what they choose and organize together, a vendor can form a\nproduct-to-product network like that in Figure 7-9, or even a person-to-person\nnetwork like that in Figure 7-7. Both maps will indicate likely influence\npatterns and what it makes sense for customers to purchase/rent/download\ntogether.\n\nHere are some network rules of thumb that we can distill from the Amazon\nanalysis:\n\n  * If you have read one nonfiction book of a structurally equivalent pair, you may not be in a rush to read the second, since the second book probably covers the same information as the first book. On the other hand, you may wish to read a large number of structurally equivalent fiction titles (can’t get enough of those cyber-thrillers!).\n  * If you liked books A, B, and C and want to read something similar, find which books are linked to A and B as well as C. You can only see this in the network diagram; you cannot see these linkages in Amazon’s individual lists unless you open three browser windows and compare the lists yourself.\n  * If you want to read just one book about topic X, find the book with the highest network influence score in the cluster of topic-X books. This follows the Google PageRank approach and may reveal a book with excellent “word of mouth” appeal.\n  * If the book you are looking for is not in stock, find which other books are structurally equivalent to that book. These will provide similar content and may be available.\n\nA book author and/or publicist could use her knowledge of existing book\nnetworks to position a book where there is a hole, or gap in the network. A\npublisher could review evolving book networks, which may change weekly, to\nadapt its marketing efforts. Amazon, of course, is still the big winner: it\nhas all the data, and a rich upside of hitherto untapped possibilities for\nanalyzing the data and applying the findings.\n\nSocial Networks of Political Books\n\nVisualizing book networks on Amazon not only helps us choose which books to\npurchase, but also gives us insights into larger trends and patterns in a\nparticular sphere of interest. One area that is ripe for exploration is\npolitics. Purchase patterns on Amazon often reflect the results of countrywide\nsurveys of political beliefs and choices.\n\nTwo books are connected in the book network if Amazon reports that they were\nfrequently bought together by the same consumer. I don’t arrange or color the\nnodes before feeding the also bought data through my social network analysis\nsoftware, InFlow 3.1.[1] The software has an algorithm that arranges the\nlayout of the nodes based on each node’s connections. Once the software finds\nthe emergent pattern and identifies any clusters, I review the books in each\ncluster and then see whether they naturally cluster as blue, red, or purple\n(my coloring scheme follows the conservative-as-red and liberal-as-blue\nconvention that became popular in the United States during the 2000\npresidential election; purple is a combination of red and blue and is used to\ndescribe books that fall between the two popular political camps).\n\nI have been doing a social network analysis of the purchase patterns of\npolitical books since 2003. Unsurprisingly, from my very first mapping I saw\ntwo distinct political clusters: a red one designating those who read right-\nleaning books and a blue one designating those who read left-leaning books. In\nmy 2003 network analysis, I saw just one book holding the red and blue\nclusters together. Ironically, that book was named What Went Wrong. This map\nis shown in Figure 7-10.\n\n![bvis_0710.png](images/bvis_0710.png)\n\nFigure 7-10. Divide of political books in 2003\n\nIn the 2004 map (Figure 7-11), constructed several months before the 2004 U.S.\npresidential election, several books held the two clusters together. Again, at\nleast with the better-selling books, there was very little crossover between\nthe right and left camps: people on each side appeared to be reading more and\nmore books that supported their existing frames of mind. This is not to say\nthat no readers were reading both red and blue books, but they appeared to be\nin the minority. I looked only at Amazon’s best-selling books and at the most\ncommon also boughts for each book, focusing on the most frequent and intense\ninteractions (as when examining the strong ties in a human network). A deeper\nlook into the Amazon data (if Amazon permitted it) might reveal these weaker,\nless frequent, connections amongst blue and red books. I would expect to see a\nsmall minority reading books on both sides—many might be in academia, teaching\nor taking courses where both sides of an issue are presented and debated.\n\n![bvis_0711.png](images/bvis_0711.png)\n\nFigure 7-11. Divide of political books in 2004\n\nI continued to create these political book maps using Amazon data from 2005\nthrough 2007, and I kept getting the same strong red/blue divide. The books\nchanged over time, but the overall network pattern remained the same. How\nstrong was this pattern? To test it, I experimented with my data collection\napproaches—were the strong patterns an artifact of my methods? No! Regardless\nof the data collection method, as long as I followed accepted practices—such\nas “snowball sampling” (Heckathorn 1997)—the results showed strong red and\nblue clustering. Occasionally a different collection method would result in a\nfew new books sneaking into the mix, but the overall pattern remained stable.\nThe emergent political book network pattern was not sensitive to data\ncollection methods and cutoffs, indicating that the pattern was strong and\npersistent.\n\nIn 2008, with the U.S. presidential election approaching, I decided to take\nseveral snapshots of the political network. How would it change as we moved\ncloser to Election Day? I captured the network at three critical junctures:\n\n  * At the end of the primary season\n  * After the last convention\n  * Right before Election Day in November\n\nI expected the red/blue divide to persist, but wondered if any interesting\npatterns would appear as the presidential election process moved through its\nphases.\n\nIn June 2008, after the major party candidates had been chosen via the primary\nprocess, I turned again to the predictive patterns of partisan political\npolemics. At the Iowa caucus in January of that year, Obama had said, “we are\nnot a collection of red states and blue states, we are the United States of\nAmerica,” and McCain proclaimed his purple “maverick” roots. But what did the\nbook data tell us?\n\nFigure 7-12 was created during June 2008. As a little experiment, I added a\nnew color: light blue. According to the Amazon sales data, these books cluster\nwith the other blues. But looking at the titles and authors, they do not fit\nin with the common blue themes and the supporters of previous iterations of\nblue nodes. At this point in time, popular conservatives, independents, and\nlibertarians were all finding more connection with the blue readers than with\nthe red readers. The reds had only George Will bridging them to the rest of\nthe U.S. political world, and a split on the right between the “old\nconservatives” and the “neo-cons” emerged, with the old conservatives more\naligned with the progressives than with the neo-cons in the summer of 2008.\n\n![bvis_0712.png](images/bvis_0712.png)\n\nFigure 7-12. Political book purchase patterns during June 2008\n\nIn August 2008, several anti-Obama books appeared. A new pro-Obama book, with\na foreword written by Obama himself, was also in prerelease and being sold on\nAmazon. Figure 7-13 reveals who was reading these books. The pro-Obama book,\nChange We Can Believe In, is solidly in the blue cluster, indicating that\npeople who had already purchased pro-Obama books were also purchasing this\npositive book. Similarly, the anti-Obama books—The Obama Nation and The Case\nAgainst Barack Obama—were primarily being purchased by people who had already\npurchased other anti-Obama books. One of the anti-Obama books, though, is\nconnected to one of the purple books, The Late Great USA. Could some undecided\nvoters, not happy with the state of the country, have been reading this book\nto make up their minds about Obama?\n\n![bvis_0713.png](images/bvis_0713.png)\n\nFigure 7-13. Political book purchase patterns during August 2008\n\nNo books on McCain, either pro or con, were amongst Amazon’s best-selling\npolitical polemics. Did people already know enough about him at this point in\nthe election cycle, or were they not interested in him? The pattern of\nconnections between the books in the map in Figure 7-13 indicate that the most\ninfluential political books at the end of the summer of 2008 were What\nHappened and The Post American World—neither addressed the current election!\nWhat Happened was written by the former press secretary for George W. Bush,\nbut it was being purchased by the blue readers only.\n\nSocial network analysis and data mining/visualization provide us with two\ncategories of outcomes:\n\n  * Expected versus unexpected results and insights\n  * Positive versus negative results and insights\n\nThese categories intersect, as illustrated in Figure 7-14. In the hundreds of\nsocial network analysis projects I have participated in, I have found that\nclients typically most enjoy seeing what they did not anticipate—the\nunexpected (and especially negative unexpected) patterns that can lead to\nproblems.\n\n![bvis_0714.png](images/bvis_0714.png)\n\nFigure 7-14. Discovery matrix for social network analysis\n\nLet’s examine our last graph using the discovery matrix in Figure 7-14. In\nlate October 2008, as both presidential campaigns sprinted toward the finish\nline, I took one more look at the political books being purchased and the\npatterns they created. The pre-election network map is shown in Figure 7-15. A\nfew unexpected patterns emerge in this map, along with one expected pattern.\n\n![bvis_0715.png](images/bvis_0715.png)\n\nFigure 7-15. Political book purchase patterns a few weeks before the November\n2008 election\n\nUnlike in all the previous maps, there are no bridging books between the red\nand blue clusters—the two sides are totally separate! Red and blue have\nnothing in common! This pattern reflects the immense polarization and\nanimosity evidenced in the campaign rallies in the run up to the election.\nPolitical issues and the great economic problems of the time were not being\ndiscussed. This pattern can be classified as a negative expected based on the\ndaily actions of each campaign.\n\nAnother revelation of the visualization in Figure 7-15 was that right-leaning\nreaders had been buying the key book of community organizers, Rules for\nRadicals. This same group had mocked community organizing! Why were right-of-\ncenter readers buying this book, which was normally popular with a left-of-\ncenter audience? Was the right trying to figure out why Obama’s campaign,\nbased on community organizing principles, had been so successful? This was an\nunexpected pattern, but whether you think it should be classed as positive or\nnegative probably depends on which side you are on.\n\nA final unexpected pattern was that those buying positive books about Obama\nwere not buying other political books. The “about Obama” cluster is\ndisconnected from the other clusters that contain political polemics. This\npattern may indicate that these readers are interested only in Obama and this\nelection, not in politics in general.\n\nAn expected pattern also jumps out from this pre-election political book\nnetwork map. Since 2004, there have been more registered Democrats than\nRepublicans, so it makes intuitive sense that there are more blue books. In\ncontrast, the right focuses on fewer books to get its message across (the book\nnetwork map does not reflect volume of books sold, so it is possible that\nreaders on the right actually buy a greater volume of fewer books—we don’t\nknow, as Amazon does not reveal this data). This is probably viewed as a\npositive expected pattern by both sides, but for different reasons. The right\nis likely to view its approach as more focused, while the left interprets it\nas the opposition lacking a variety of opinions. Conversely, the left is\nlikely to view the larger number of books on its side positively, as\nrepresenting a diversity of opinions, while the right may view it as\nindicating a scattered and unfocused message.\n\nConclusion\n\nAs the visualizations presented in this chapter have illustrated, our choices\nreveal who we are, and whom we are like. The decisions we make identify not\nonly certain aspects of ourselves, but also what groups we belong to. Since\n“birds of a feather flock together,” our choices provide many insights into\nthe behaviors of others in our groups. In the future (on the Web, for\nexample), many of our choices may not be conscious: our smartphones will\ncommunicate with other nearby smart devices looking for ways to connect with\ntheir owners. These devices may be programmed to look for the patterns we have\nexamined here. A few brave souls may program their devices to selectively\nbreak the typical patterns in which they are embedded—for instance, a red-book\nreader could strike up a conversation with a blue-book reader after their\ndevices reveal the opportunity to exchange viewpoints.\n\nThe Amazon data illustrated that we can gain deep insights into the political\nchoices and behaviors of different groups without knowing anything about the\nindividuals belonging to those groups. Private data does not need to be\nrevealed for us to understand large-scale political patterns based on book\npurchases. Even more amazing, this data, along with the simple visualizations\ncreated to display it, matched the findings of expensive nationwide surveys of\npotential voters. An hour collecting and mapping Amazon data gave some of the\nsame insights as thousands of hours spent collecting and analyzing voter\nsurvey and interview data. The Pareto 80/20 rule works well here: we get 80%\nof the insight for much less than 20% of the time invested—an excellent payoff\nwhen properly matching data mining with data visualization!\n\nReferences\n\nDavis, Allison, B.B. Gardner, and M.R. Gardner. 1941. Deep South: An\nAnthropological Study of Caste and Class. Chicago: University of Chicago\nPress.\n\nFreeman, Linton C. 1979. “Centrality in social networks: I. Conceptual\nclarification.” Social Networks 1: 215–239. <http://moreno.ss.uci.edu/27.pdf>.\n\nFreeman, Linton C. 2003. “Finding social groups: A meta-analysis of the\nsouthern women data.” In Dynamic Social Network Modeling and Analysis, eds.\nRonald Breiger, Kathleen Carley, and Philippa Pattison. Washington, DC: The\nNational Academies Press. <http://moreno.ss.uci.edu/85.pdf>.\n\nFreeman, Linton C. 2004. The Development of Social Network Analysis: A Study\nin the Sociology of Science. Vancouver, Canada: Empirical Press.\n<http://aris.ss.uci.edu/~lin/book.pdf>.\n\nHeckathorn, D.D. 1997. “Respondent-driven sampling: A new approach to the\nstudy of hidden populations.” Social Problems 44: 174–199.\n\nMayo, Elton. 1933. The Human Problems of an Industrial Civilization. New York:\nMacMillan.\n\nMoreno, Jacob L. 1934. Who Shall Survive? A New Approach to the Problem of\nHuman Interrelations. Foreword by Dr. W.A. White. Washington, DC: Nervous and\nMental Disease Publishing Company.\n\n[1] See <http://orgnet.com/inflow3.html>.\n\n\nChapter Eight\n\nVisualizing the U.S. Senate Social Graph (1991–2009)\n\nAndrew Odewahn\n\nIn early 2009, many news stories emphasized the collapse of bipartisanship.\nAlthough much of this reporting was of the typical “he said, she said”\nvariety, one article in particular caught my attention. Chris Wilson, an\nassociate editor at Slate, wrote a great piece in which he used voting\naffinity data and graph visualization to help explain Senator Arlen Specter’s\nparty switch (Wilson 2009). The graph showed two large party clusters\n(Democrats in blue, Republicans in red), connected by a few tenuous threads of\nsenators who consistently voted across party lines.[1] One of these was\nSpecter.\n\nThe piece got me thinking on several dimensions. First, it was really cool to\nsee quantitative evidence making the case for what was an essentially\nqualitative story. With one glance, you could see that something interesting\nwas happening with Specter that presaged his break with his party. It made me\nwonder if there was similar evidence about other stories in the news. For\nexample, a lot of reporting fixated on various Senate coalitions—the “Gang of\nFourteen,” the “New England Moderates,” and the “Southern Republicans”—and how\nthey were aiding or thwarting some initiative or another.\n\nBasic civics would have you believe that the Senate, unlike the House, was\ndesigned by the Founders to dampen coalitions like these. It’s a simple body:\nthere are 100 senators, two from each state, who stand for election every six\nyears. Elections are staggered so that roughly a third of the Senate is up for\nreelection every two years, which implies that Senate coalitions can change,\nbut not drastically. While senators can switch parties, retire, or even die\nmid-term, these events don’t happen that often. Finally, incumbency itself\nconveys huge advantages. Once in office, senators simply aren’t voted out very\noften.\n\nI was curious about whether I could use graph visualization to paint a broad\npicture that revealed the structural dynamism in the Senate over time. If the\nhigh school story is really true—that the Senate is an inherently conservative\nbody, in the literal sense of tending to oppose change—then the graphs should\nremain relatively stable. If it’s not, then perhaps a visual representation\nmight provide some insights into the incredibly important events that were\nshaping America in 2009, and the way reporters were covering them.\n\nIn this chapter, I’ll describe how I used voting data to explore these\nquestions visually. I’ll begin by walking you through the steps required to\nactually produce the visualization. Next, I’ll show you the results, discuss\nhow the graphs change over the 18-year period I examined, provide a bit of\nhistorical context, and draw some general conclusions about the merits of the\n“high school civics” view of the Senate. After that, I’ll discuss why this is\na beautiful (and not merely interesting) visualization, as well as explore the\nmany warts it picked up along the way. Finally, I’ll share some general\ninsights I’ve gleaned through this process that I hope you can put to use in\nyour own work.\n\nBuilding the Visualization\n\nI started with the basic guidelines suggested in Wilson’s article:\n\n  * Nodes represent senators; each node has a numerical label that corresponds to an alphabetical list of senators.\n  * Nodes are colored based on party affiliation. They follow the standard convention of blue for Democrats and red for Republicans. (I also used green for Independents and yellow when a party affiliation wasn’t included in the data source.)\n  * Nodes are connected with an edge if those two senators voted together more than 65% of the time over the course of the selected timeframe.\n\nIn addition, I decided to orient the graphs so that the Democrats were on the\nleft and the Republicans were on the right. And, because I wanted to\nunderstand how the Senate had evolved, I chunked the data into meaningful\ntimeframes and created a plot for each one.\n\nI settled on the legislative session as my basic unit of time. A legislative\nsession lasts two years, begins and ends on January 3, and is often referred\nto as “Congress.” Each Congress is numbered consecutively. For example, the\n104th Congress covers the period from January 3, 1995 to January 3, 1997; the\n105th Congress covers the period from January 3, 1997 to January 3, 1999; and\nso on. (At the time of this writing, the 111th Congress is in session.)\n\nThe session was an attractive unit for two reasons. First, it’s the shortest\nconsistent time span. The Senate is a dynamic body whose membership can change\nat any time, particularly during election years, so using a period longer than\ntwo years would have risked muddying the relationships by introducing new\nsenators partway through the voting record. Second, and more prosaically, it’s\nthe level at which the data was reported, so it was a very convenient choice.\n\nWith these preliminary choices out of the way, there were three steps involved\nin building the visualization: gathering the raw data about senators and their\nvotes, computing an affinity matrix that described how tightly the senators\nwere aligned, and then putting the information into GraphViz (a toolkit for\ngraph visualization) to turn the relationships into a picture. The following\nsections describe each of these steps in depth.\n\nGathering the Raw Data\n\nMy visualization required two main types of data: metadata about individual\nsenators (name, party affiliation, etc.), and a record of their votes over an\nextended time. Initially, as many of the big government data sites (data.gov,\nthomas.com, etc.) publish information via feeds, the lack of history appeared\nto be a major obstacle. A particular vote in a session of Congress will be\npublished as it happens, but it is difficult to go back in time to retrieve a\nfull voting record.\n\nFortunately, I discovered the site GovTrack (<http://govtrack.us>), which\nbills itself as “a civic project to track Congress.” While it largely provides\nthe same data as the other big government sites, it also performs (among other\nthings) the very valuable function of aggregating the feeds into XML files\ngoing back to 1991, with partial records available for sessions predating that\none. My project therefore included full records of everything from the 102nd\nsession going forward, but the pre-1991 data was incomplete. You can download\nany and all of the data I used for free from the site’s “Source Data” page.[2]\nThe site has great documentation that clearly describes how to download the\ndata and how it is structured.\n\nOn GovTrack, senator metadata is kept in a file called people.xml. There are\ntwo versions of this file: a current file, which contains data on just the\npeople serving in Congress now, and an historical file, which contains data on\neveryone who has ever served in Congress. I used the historical version for\nthis project.\n\nIn both of these files, information about individual senators (or\nrepresentatives) appears in a <person> element; each person had a unique ID\nthat is used consistently for that person across the GovTrack datasets.\nInformation about party affiliation is in a child element called <role>. For\nexample, here is the entry for John Kennedy, who was both a representative and\na senator (and president, of course):\n\n<person id='406274'\n\nlastname='Kennedy' firstname='John' middlename='Fitzgerald'\n\nbirthday='1917-05-29' ... >\n\n<role type='rep'\n\nstartdate='1947-01-01' enddate='1948-12-31'\n\nparty='Democrat' state='MA' district='11' />\n\n<role type='rep'\n\nstartdate='1949-01-01' enddate='1950-12-31'\n\nparty='Democrat' state='MA' district='11' />\n\n...\n\n<role type='sen'\n\nstartdate='1959-01-01' enddate='1960-12-31'\n\nparty='Democrat' state='MA' district='' />\n\n</person>\n\nVoting data in GovTrack is organized by two-year legislative sessions. The\nvotes are recorded by roll call, which is when the senators come together to\nvote “Yea” or “Nay” on an issue before them. There are typically several\nhundred roll calls over the course of a session.\n\nGovTrack records each roll call as an XML file. The next listing, for example,\nis an excerpt of the roll call file s1995-247.xml, which was a vote taken in\nthe 104th Congress on whether to permit the Bell operating companies to\nprovide interLATA commercial mobile services. (Some of these votes are pretty\ndull.) Note that each <voter> element has an id that links back to the\npeople.xml file:\n\n<roll\n\nwhere=\"senate\" session=\"104\" year=\"1995\" roll=\"247\"\n\nwhen=\"802710180\" datetime=\"1995-06-09T11:03:00-04:00\"\n\nupdated=\"2008-12-30T13:34:55-05:00\"\n\naye=\"83\" nay=\"4\" nv=\"13\" present=\"0\">\n\n...\n\n<voter id=\"400566\" vote=\"+\" value=\"Yea\" state=\"MN\"/>\n\n<voter id=\"300016\" vote=\"-\" value=\"Nay\" state=\"WV\"/>\n\n<voter id=\"400559\" vote=\"-\" value=\"Nay\" state=\"WA\"/>\n\n<voter id=\"300011\" vote=\"0\" value=\"Not Voting\" state=\"CA\"/>\n\n<voter id=\"400558\" vote=\"0\" value=\"Not Voting\" state=\"GA\"/>\n\n...\n\n</roll>\n\nThese files—the historical people file and all of the various roll call\nfiles—contained all the data I wanted. However, with over 6 MB of data in the\npeople.xml file and several thousand roll call votes across the full GovTrack\ndataset, I wanted this data in a more convenient format. So, I wrote some\nscripts to extract only the part of the data I needed for my visualization and\nstored it in a SQLite database. The schema is shown in Figure 8-1. In the\ninterests of simplicity, I assigned a party based on only the most recent\n<role>, a decision that would come back to haunt me.\n\n![bvis_0801.png](images/bvis_0801.png)\n\nFigure 8-1. Simple database schema for representing the raw data required for\nthe visualization\n\nComputing the Voting Affinity Matrix\n\nWith the raw data munged into a more pliant format, I was ready to tackle the\nproblem of computing the affinities that would represent the edges in the\ngraph. This entailed building an affinity matrix (Figure 8-2) that tallied the\nnumber of times different senators voted the same way on the same bills. I\ncould use this matrix to back out the edge conditions.\n\n![bvis_0802.png](images/bvis_0802.png)\n\nFigure 8-2. An affinity matrix\n\nThe following pseudocode illustrates the basic logic:\n\n# Select all distinct roll calls from the vote table\n\nroll_list =\n\nselect\n\ndistinct roll\n\nfrom\n\nvotes\n\n# Process each roll call vote in roll_list\n\nfor roll_idx in roll_list:\n\n# Process \"Yea\" votes, then \"Nay\" votes\n\nfor vote_idx in [\"Yea\", \"Nay\"]:\n\n# Find the senators that cast this vote on this roll call\n\nsame_vote_list =\n\nselect\n\nsenator_id\n\nfrom\n\nvotes\n\nwhere\n\nroll = roll_idx and\n\nvote = vote_idx\n\n# Now tally all the pairs of senators in the list\n\nfor senator_a in same_vote_list:\n\nfor senator_b in same_vote_list:\n\naffinity_matrix [senator_a, senator_b] += 1\n\naffinity_matrix [senator_b, senator_a] += 1\n\n# Translate the raw matrix into edges\n\nN = length(roll_list) # Represents the number of votes in the session\n\nfor senator_a in affinity_matrix.rows:\n\nfor senator_b in affinity_matrix.columns:\n\nif (affinity_matrix[senator_a,senator_b] / N) > 0.65 then:\n\nadd an edge between Senator A and Senator B\n\nBecause this is a fairly intensive set of computations, I saved the results in\nanother table in my database.\n\nVisualizing the Data with GraphViz\n\nThe final step was to turn all this data—the senator metadata and voting\nrecords—into a series of images. GraphViz (<http://www.graphviz.org>), an open\nsource graph visualization package, was a perfect tool for this job.\n\nGraph visualization is the study of various layout algorithms that take an\nabstract representation of the nodes and edges in a graph and turn it into a\npicture. I used GraphViz’s “neato” layout algorithm, which works by simulating\nnodes as positively charged particles and edges as springs. Nodes push each\nother apart, and the edges pull related nodes together. Initially, everything\nis plopped down randomly on a plane, and then the algorithm simulates the push\nand pull of these counterbalancing forces to compute final x, y coordinates\nfor each node that represent the “best” overall layout. (For this reason,\nalgorithms like this are called “force-directed layout” algorithms.) Figure\n8-3 illustrates the concept.\n\n![bvis_0803.png](images/bvis_0803.png)\n\nFigure 8-3. Neato, a force-directed layout algorithm included in GraphViz,\nsimulates nodes as charged particles and edges as springs\n\nThe structures that emerge from this process are proportional to the density\nof connections within the underlying data. So, a tightly connected group of\nsenators should create a subcluster that repels other subclusters. It’s also\nworth noting that, because it controls the presence or absence of edges, the\ncutoff value for assigning an edge based on voting affinity determines the\ndegree of clustering observed in the graph. A very low value (say, 20%) would\nresult in relatively few substructures, because many of the votes within a\nsession are routine procedural matters on which most senators agree.\nConversely, a very high value (say, 95%) would result in a very fragmented\ngraph, because only the most strongly connected pairs would emerge; this graph\nwould simply look like a collection of random dots that were occasionally\nconnected. The 65% cutoff seemed to be the point that best balanced these\ncompeting tensions.\n\nA language called DOT describes the nodes and edges to GraphViz. DOT is\nstraightforward: nodes are declared using unique labels, and edges are\ndeclared by connecting two (or more) of these node labels together with a ->\nsymbol. Various other attributes (color, label, etc.) are defined by placing\nthem in square brackets next to the object they modify.\n\nHere is an example DOT file (Gansner, Koutsofios, and North 2006):\n\ndigraph G{\n\na[shape=polygon,sides=5,peripheries=3,color=lightblue,style=filled];\n\nc[shape=polygon,sides=4,skew=.4,label=\"helloworld\"]\n\nd[shape=invtriangle];\n\ne[shape=polygon,sides=4,distortion=.7];\n\na -> b -> c;\n\nb -> d;\n\n}\n\nFigure 8-4 shows the corresponding image generated in GraphViz.\n\n![bvis_0804.png](images/bvis_0804.png)\n\nFigure 8-4. A sample image generated by GraphViz\n\nSo, to create the Senate visualization, I just had to create a DOT file and\nfeed it into GraphViz. This required another script that packaged all the\ninformation saved in the database in the preceding steps—the senator’s IDs,\nthe labels in an alphabetical list, node colors based on party affiliation,\nand the edges from the affinity matrix—and fed them into a templating engine\nthat would produce a DOT representation. Here’s the template:\n\n1 Digraph {\n\n3 #for $senator in $vote_data.nodes:\n\n4 $senator['id'] [\n\n5  shape=\"circle\",\n\n6  style=\"filled\",\n\n7  color = $senator['color'],\n\n8  label = \"$senator['label']\"\n\n9  fontsize = \"128\",\n\n10  fontname = \"Arial\",\n\n11  ];\n\n12 #end for\n\n14 #for $e in $vote_data.edges:\n\n15 \"$e['senator_a']\" -> \"$e['senator_b']\" [arrowhead = none];\n\n16 #end for\n\n17 }\n\nNote that the for loops on lines 3 and 14 are used to loop through the nodes\nand edges, respectively. The items in bold are variables that are replaced on\neach iteration.\n\nThe Story That Emerged\n\nOnce I’d pieced together all the scripts I needed and turned them into images,\na remarkably coherent story emerged.\n\nFigure 8-5 shows the structure of the 102nd Senate session, which ran from\nJanuary 3, 1991 to January 3, 1993. During this session, President George H.W.\nBush served as president for a year, the first Gulf War was fought, and Bill\nClinton was elected president (in 1992, midway through the session). Although\ntwo distinct voting blocks emerge, a considerable degree of overlap in the\ncenter is apparent, both in terms of the number of senators (i.e., nodes in\nthe middle region) and the edges (i.e., number of cross connections).\n\n![bvis_0805.png](images/bvis_0805.png)\n\nFigure 8-5. Structure of the 102nd Senate session (January 3, 1991 to January\n3, 1993)\n\nFigure 8-6 shows the structure of the 104th session, just two years later.\nThis (and the preceding two years) represents the “Republican Revolution,” in\nwhich the Republicans retook both the House and the Senate for the first time\nin almost 40 years. It was a period marked by intense partisanship, and it saw\nsuch events as the government shutdown, voting on the Republicans’ “Contract\nwith America,” and (on the national scene) the bombing of the Murrah federal\nbuilding in Oklahoma City. The Senate graph reflects the deep divisions, with\nboth parties locked into separate, tight little balls.\n\n![bvis_0806.png](images/bvis_0806.png)\n\nFigure 8-6. Structure of the 104th Senate session (January 3, 1995 to January\n3, 1997)\n\nFigure 8-7 is a composite of the next six sessions.\n\n![bvis_0807.png](images/bvis_0807.png)\n\nFigure 8-7. Structures of the 105th through the 110th Senate sessions (January\n3, 1997 to January 3, 2009)\n\nSome of the events and notable structures that occurred over these sessions\ninclude:\n\n  * 105th session (January 3, 1997 – January 3, 1999). The Republican-controlled House votes to impeach President Clinton during this session. Note the distinct split in the Democratic block, which occurs regularly with the Democrats over the sample period.\n  * 106th session (January 3, 1999 – January 3, 2001). The impeachment trial of President Clinton is held in the Senate over this term. Although the Senate, like the House, is held by the Republicans, it votes to acquit. It’s interesting that the Republican block shows a clearly defined and significant split in this session; this is one of the few times this happens so clearly with the Republicans over the entire 18-year period surveyed. \n  * 107th session (January 3, 2001 – January 3, 2003). The attacks of September 11th (and the later anthrax attacks directed against the Senate itself) occur during this session; the Iraq war is also authorized. Although there is a small split in the Democratic block that consists mostly of a few senators thought of as more liberal, it’s a period of renewed strength in the center, as more connections are made across party lines than at any time since 1991.\n  * 108th session (January 3, 2003 – January 3, 2005). The Iraq war begins in this session. This session is almost a return to the 104th Congress, with the exception of Ben Nelson (D, NE), who votes with a small group of moderate Republicans consisting of Olympia Snowe (ME), Susan Collins (ME), and Norm Coleman (MN). While the remaining Republicans stay fairly cohesive, the small Democratic fracture remains. \n  * 109th session (January 3, 2005 – January 3, 2007). The annus horribilis for the Republican party—the Tom Delay and Jack Abramoff scandals, a deeply divisive vote on the Terry Schiavo case, and the disastrous response to Hurricane Katrina (“You’re doin’ a heckuva job, Brownie!”) all occur during this session. Despite this, the Republican senatorial block remains remarkably close-knit. The Democratic block, on the other hand, continues to fracture, with a larger group of senators shifting toward the small, more liberal block.\n  * 110th session (January 3, 2007 – January 3, 2009). The Democrats take control of both the House and the Senate in this session. Unlike in previous sessions, the Democratic block looks remarkably unified, while the Republican block is fragmented and diffuse.\n\nAlthough none of the sessions depicted in Figure 8-7 shows as dramatic a break\nas the one between the 102nd and the 104th, there is a consistent pattern of a\nfracture in one (or both) of the main blocks over the six sessions. The first\nsix months of the 111th Congress (the session in progress at the time this was\nwritten) continues this pattern even more distinctly. As shown in Figure 8-8,\nthe Democratic unity from the 110th session has given way to an almost even\nsplit in the block. The Republican Party shows a conservative core surrounded\nby a fragmented periphery of moderates.\n\n![bvis_0808.png](images/bvis_0808.png)\n\nFigure 8-8. Structure of the first six months of the 111th Senate session\n(January 3, 2009 – around July 1, 2009)\n\nSo, it does appear that the coalition story that was the talk of the summer of\n2009 is backed up in the data. In fact, the Senate has been a dynamic place\nsince at least 1991, with alternating coalitions, parties, and even\nindividuals shaping the directions of key decisions.\n\nOf course, in retrospect, this is hardly news. This pattern of alternating\ncoalitions probably goes back to the very founding of the United States, as\nGeorge Washington warned in his Farewell Address of 1796 (Figure 8-9).\n\n![bvis_0809.png](images/bvis_0809.png)\n\nFigure 8-9. George Washington’s Farewell Address of 1796, from the Rare Book\nand Special Collections division of the Library of Congress[3]\n\nHere’s what our first president had to say about the tendency of political\nparties to form factions:[4]\n\nThis spirit, unfortunately, is inseparable from our nature, having its root in\nthe strongest passions of the human mind. It exists under different shapes in\nall governments, more or less stifled, controlled, or repressed; but, in those\nof the popular form, it is seen in its greatest rankness, and is truly their\nworst enemy.\n\nThe alternate domination of one faction over another, sharpened by the spirit\nof revenge, natural to party dissension, which in different ages and countries\nhas perpetrated the most horrid enormities, is itself a frightful despotism.\n\nWashington’s warning, directed as it is toward “different ages and countries,”\nstrikes me as being as true today as it was back then. So, while the coalition\nstory of 2009 might be news, the fundamental pattern is actually quite old.\nThe characters come and go, but the story stays the same.\n\nWhat Makes It Beautiful?\n\nWhen I was asked to contribute to this book, one of my first thoughts was “But\nmy graphs are so ugly!” The labels are inconsistent across time and somewhat\naskew, and there are a few glaring inaccuracies in the way I assigned\npolitical parties. (I’ll describe these flubs in detail shortly.) But as I\nthought about it further, I decided that the work gets one fundamental thing\nright, and this makes the warts forgivable.\n\nThe choice of a network of related senators as the visual framework was the\nkey element in making this a beautiful visualization. Perhaps the best way to\nsee why is to compare it with another depiction that shows pretty much the\nsame thing, but in a different way. Consider Figure 8-10, which is a time-\nseries chart of a partisanship index that appeared in McCarty, Poole, and\nRosenthal (2008).\n\n![bvis_0810.png](images/bvis_0810.png)\n\nFigure 8-10. An interesting, but not particularly beautiful, visualization of\nbipartisanship\n\nNow, there is absolutely nothing wrong with this chart, and it does a\nfantastic job of showing that conservatism took off among Republicans in the\nmid-1970s. It gets even more interesting when you consider how well it\nreflects the impact of Nixon’s “Southern Strategy,” which cynically exploited\nfears about civil rights to turn the once solidly Democratic South into a\nRepublican stronghold. However, while it accurately makes its point, it\ndoesn’t provide additional elements that resonate with the viewer, and it\ntakes some studying to see the story.\n\nThis is not the case with the social graph approach. For example, knowing that\neach dot represents a senator, you’re naturally drawn in to wonder, “Who is\nthat person so far off from the main group?” and then delighted to discover\nthat it’s John McCain being all “mavericky.” It’s also interesting to see the\nrise in partisanship not as a simple line on a chart, but as two opposing\ncamps pitted against each other, connected by only a few people across the\nmiddle; or to see the complete breakdown of bipartisanship in the 104th\nCongress, when both parties balled up into a hedgehog defense; or to see the\ninternal conflicts within each block as they responded to the broader events\nof the times.\n\nThe possibility for such resonances is what makes my graphs beautiful, rather\nthan just interesting. A line graph can illustrate a fact, and can do so very\nclearly, but it rarely incites you to probe further and engage with the\ninformation. Like a good story, a beautiful visualization should draw you in,\nprovoke questions, and offer a sense of exploration and discovery.\n\nIf you can get this element right, viewers will overlook some warts. And my\nproject had several of these.\n\nAnd What Makes It Ugly?\n\nAlthough I’m pretty happy with what my graphs ended up showing, there are a\nfew things I would have changed, in hindsight. Most of the problems resulted\nfrom me making too many assumptions about the data, as I’ll discuss in the\nnext sections.\n\nLabels\n\nA key goal of the visualization was to reveal the global structures among the\nsenators, rather than to reveal details about particular individuals.\nOccasionally, though, it can be useful to know whom a particular node\nrepresents—for example, when a node appears as a central “bridge” or connector\nbetween the parties (like Olympia Snowe or Ben Nelson), or off by itself (like\nJohn McCain). I wanted it to be possible to quickly identify these\n“interesting” nodes, while still keeping the focus on the overall pattern. My\nsolution was to assign each senator a label based on alphabetical order, and\nthen use these labels on the corresponding nodes.\n\nWhile this worked well for an individual session, it failed miserably to\npreserve any sense of continuity across the sessions. To see why, consider\nTable 8-1, which shows the senators who were assigned to the labels 1, 50, and\n100 across the 11 sessions.\n\nTable 8-1. Senators occupying the labels 1, 50, and 100 over the 11 sessions\nin the visualization  \n---  \nSession |  Label 1 |  Label 50 |  Label 100  \n101 |  Alan Cranston |  Pete Domenici  |  Wyche Fowler  \n102 |  Alan Cranston |  Paul Simon |  Wyche Fowler  \n103 |  Alan Simpson |  Paul Wellstone |  William Roth  \n104 |  Alan Simpson |  Sam Nunn |  William Roth  \n105 |  Alfonse D’Amato |  Daniel Akaka |  William Roth  \n106 |  Ben Campbell |  Evan Bayh |  William Roth  \n107 |  Ben Campbell |  Evan Bayh |  Zell Miller  \n108 |  Ben Campbell |  Jeff Bingaman |  Zell Miller  \n109 |  Barack Obama |  John Ensign |  William Frist  \n110 |  Charles Hagel |  John Thune |  Wayne Allard  \n111 |  Kirsten Gillibrand |  Joseph Lieberman |  Tom Udall  \n  \nIdeally, each senator should have the same label across all the graphs in\nwhich he or she appears. However, a quick look at the table shows just how\npoorly my method reflects this. For example, consider Joseph Lieberman, who\nhas been Connecticut’s senator since 1988. Based on my simple alphabetical\nordering process, he appeared as labels 50, 54, 59, 65, 66, 73, 76, and 77\nacross the 11 graphs. The story was the same for many of the other senators:\nwith the exception of Barack Obama, most of them spent multiple terms in the\nSenate, but in my system the labels assigned to them were wildly inconsistent.\n\nA better system would have been to create a single list that represented all\nthe senators over the 11 sessions, and then to assign a unique label to each\nsenator based on that list. The trade-off, of course, is that I would have had\nmore than 100 labels, but this would seem to be an acceptable downside,\nespecially if such a list were arranged chronologically based on the year of\neach senator’s first election rather than alphabetically. Another solution\nwould have been to make a dynamic, interactive visualization where the user\ncould (for example) hover over each node and see a pop-up window presenting\nadditional metadata. However, as I designed the visualization for print, this\nwasn’t a viable option for me.\n\nOrientation\n\nIn addition to labeling the senators, I wanted my visualization oriented so\nthat Democrats would appear on the left and Republicans on the right. As well\nas following the established conventions, the idea was that this consistent\nplacement would create some continuity across the various charts. However,\nthis strategy proved difficult to implement because of the nature of the Neato\nlayout algorithm.\n\nThe force-directed process described earlier is a great way to reveal the\ncomplex structures hidden inside abstract graph data. However, because it\ndepends on a certain amount of randomness, it doesn’t produce the same results\nevery time: while the general structure is the same, the orientation will vary\nconsiderably. For example, Figure 8-11 shows three different, yet equally\nvalid, layouts for a simple graph.\n\n![bvis_0811.png](images/bvis_0811.png)\n\nFigure 8-11. Three equivalent force-directed layouts for the same graph\n\nIn the end, I resorted to opening the image files and rotating them manually.\nWhile this workaround achieved the desired orientation, it had the unfortunate\nside effect of rotating the label text as well, leaving the whole thing\nlooking a bit odd. The schematic in Figure 8-12 illustrates why.\n\n![bvis_0812.png](images/bvis_0812.png)\n\nFigure 8-12. Rotating the raw image from the graph layout algorithm so that\nthe Democrats were on the left and the Republicans were on the right had some\nunexpected side effects on the labels\n\nIn retrospect, it would have been better to invest the time in fixing the\norientation programmatically. For example, I could have added an intermediate\nstep to calculate the centroids of the two clusters, and then calculated a\nrotational angle around the centroid of the entire graph that would produce\nthe orientation I wanted. This extra step would have saved considerable effort\nin the long run, but it seemed like overkill at the time.\n\nParty Affiliation\n\nThe last major wart was the result of a foolish assumption: since senators\nchange parties so infrequently, it seemed safe to assume that each senator’s\nmost recent party affiliation could be used for all the graphs. In my\nvisualization, this mistake stood out like a sore thumb.\n\nFor instance, consider Joseph Lieberman (again!), who became an Independent in\n2006 after losing the Democratic primary to insurgent candidate Ned Lamont.\nHere’s a sample of his entry in the people.xml file:\n\n<person id='300067' lastname='Lieberman' firstname='Joseph' ... >\n\n<role startdate='1989-01-01' enddate='1994-12-31' party='Democrat' .../>\n\n<role startdate='1995-01-01' enddate='2000-12-31' party='Democrat' .../>\n\n<role startdate='2001-01-01' enddate='2006-12-31' party='Democrat' .../>\n\n<role startdate='2007-01-01' enddate='2012-12-31' party='Independent' .../>\n\n...\n\n</person>\n\nAs you can see, Lieberman spent 18 years as a Democratic senator before\nchanging his affiliation. However, the last entry in this file lists him as an\nIndependent, so that’s the party I assigned him in my ETL (extract, transform,\nand load) process. As a result, he appears (incorrectly) as a consistent green\ndot in a sea of Democratic blue in the graphs visualizing the 102nd through\n109th Congresses.\n\nTo avoid this problem, I should have designed my ETL process to check party\naffiliation based on the date ranges provided in the <role> element from\nGovTrack. As with the orientation issue, this didn’t seem worth the trouble at\nthe time. In retrospect, it serves as a cautionary tale on making “simplifying\nassumptions” about unfamiliar data.\n\nConclusion\n\nI’ll end this piece with a few observations I made while working through this\nproject that I hope you might find useful in your own work:\n\nBe prepared to spend a lot of time data munging\n\nWhen I discovered GovTrack, I thought it would make this project a snap. After\nall, the data was all right there, neatly packaged up in clear XML. However,\nactually getting this raw data into a form I was able to use for the project\nrequired a considerable amount of time. I’d estimate that 80% of the time I\nspent on this project was taken up by simply transforming the data—extracting\nthe pieces I wanted, writing database loaders and schemas, and writing the\nscripts to calculate the affinity data all took much more time than creating\nthe DOT templates. This is apparently a very common phenomenon, so if you find\nyourself struggling with the data portion of your project, don’t get\nfrustrated. It just seems to be part of the territory.\n\nAutomate what you can\n\nWhen you’re first getting a handle on the data, it’s tempting to bang out a\nquick and dirty solution. So you string together a series of shell scripts,\nSQL statements, and maybe some work in Excel to get the data how you want it.\nThis is fine if you’re really, really, really only going to use your dataset\none time. But chances are, if your work is at all successful or interesting,\nyou’re going to want to go back and change it, reproduce it, or enhance it.\nAnd when that time comes, you’ll find yourself scratching your head and asking\nyourself, “Now, which script did I run to calculate that?” So, even if you may\njust think you’re slapping together a one-time hack for a quick project, take\nthe time to develop automated scripts and do some minimal documentation. Your\nfuture self will thank you.\n\nThink carefully about how you’ll represent time\n\nBecause people are often interested in how things have changed from the past\nor what they may look like in the future, be sure to think about how you’ll\nrepresent time in your visualization. Sometimes time is revealed explicitly,\nas in the time series example in Figure 8-10. Sometimes, though, it’s in the\nbackground. For example, in my project, the sense of movement through time is\nconveyed cinematically through a progression of images. In any case, just as\nit does in a movie, a clear sense of pacing and moving through time will help\nmake your work more engaging.\n\nDecide when “good” is “good enough”\n\nAlthough it’s important to spend some time up front working through your data\nso that you’re not bitten by embarrassing problems later, it’s also good to\nknow when enough is enough. Unless you’re working on a system that truly\nrequires complete accuracy (a heads-up display for a jet aircraft, for\nexample), it’s often better to “release early, release often.” Show your work\nto people, get their reactions, see if it’s generating the types of responses\nyou’d hoped for, and then iterate.\n\nApproach the problem like a journalist\n\nA lot of other chapters in this book have made the point that a great\nvisualization should tell a story, and I generally agree. However, inherent in\nthis framing is the idea that the people who create visualizations are\nstorytellers. To me, this can have a ring of someone inventing a story,\ncomplete with characters and situations to fit a plot. Rather than\n“storyteller,” I think “journalist” is a more accurate metaphor. A journalist\ntells a story, but it’s (ideally) an objective story—the journalist’s goal is\nto uncover the facts piece by piece, untangle messy complexities, and try to\nweave them into a coherent picture. Ultimately, the fidelity of your\nvisualization’s story to the underlying facts in the data is what will truly\ndetermine its beauty.\n\nReferences\n\nGansner, Emden, Eleftherios Koutsoﬁos, and Stephen North. 2009. “Drawing\ngraphs with DOT.” <http://bit.ly/4GlYAp>.\n\nMcCarty, Nolan, Keith T. Poole, and Howard Rosenthal. 2008. Polarized America:\nThe Dance of Ideology and Unequal Riches. Cambridge, MA: MIT Press.\n<http://polarizedamerica.com>.\n\nWilson, Chris. 2009. “The Senate Social Network: Slate presents a Facebook-\nstyle visualization of the Senate.”\n[http://bit.ly/FD5QY.](http://bit.ly/FD5QY)\n\n[1] I should note here that in this context, “graph” means a collection of\nnodes and edges, not an x, y data plot.\n\n[2] See <http://bit.ly/4iZib.>\n\n[3] See <http://en.wikipedia.org/wiki/George_Washingtons_Farewell_Address>.\n\n[4] See <http://avalon.law.yale.edu/18th_century/washing.asp>.\n\n\nChapter Nine\n\nThe Big Picture: Search and Discovery\n\nTodd Holloway\n\nSearch and discovery are two styles of information retrieval. Search is a\nfamiliar modality, well exemplified by Google and other web search engines.\nWhile there is a discovery aspect to search engines, there are more\nstraightforward examples of discovery systems, such as product recommendations\non Amazon and movie recommendations on Netflix.\n\nThese two types of retrieval systems have in common that they can be\nincredibly complex under the hood. The results they provide may depend not\nonly on the content of the query and the items being retrieved, but also on\nthe collective behavior of the system’s users. For example, how and what\nmovies you rate on Netflix will influence what movies are recommended to other\nusers, and on Amazon, reviewing a book, buying a book, or even adding a book\nto your cart but later removing it can affect the recommendations given to\nothers. Similarly, with Google, when you click on a result—or, for that\nmatter, don’t click on a result—that behavior impacts future search results.\n\nOne consequence of this complexity is difficulty in explaining system\nbehavior. We primarily rely on performance metrics to quantify the success or\nfailure of retrieval results, or to tell us which variations of a system work\nbetter than others. Such metrics allow the system to be continuously improved\nupon.\n\nA supplementary approach to understanding the behavior of these systems is to\nuse information visualization. With visualization, we can sometimes gain\ninsights not available from metrics alone. In this chapter, I’ll show how one\nparticular visualization technique can provide large-scale views of certain\nsystem dynamics. The first system we’ll look at is a search engine,\nYELLOWPAGES.COM. The goal will be to get a big-picture view of user query\nactivity on the site—activity that can in turn be used to improve the design\nof the system itself. The second system we will look at is a movie recommender\nbuilt from the dataset of the Netflix Prize, a million-dollar predictive\nmodeling competition that ended recently. That visualization can help us\nunderstand the issues inherent in a discovery model based on user preferences.\n\nThe Visualization Technique\n\nThe technique described in this chapter is all about comparing items of the\nsame type—queries in our first example, and movies in the second. The premise\nis simple: we will place items on the page so that similar items are close to\none another and dissimilar items are far apart. This premise is rooted in the\nGestalt principle of proximity, which claims that when items are placed close\ntogether, people tend to perceive them as belonging to a group.\n\nThe first step in creating these visualizations is therefore to define what\nmakes items similar and dissimilar. This can be anything. In our Netflix Prize\nexample, we’ll define the similarity of movies as being evidenced by like user\nratings. There are very good reasons to use user ratings, but we could\nalternatively have used movie attributes like genre or actors to define\nsimilarity.\n\nOnce similarity is defined, an ordination process is needed to convert those\nsimilarity values into either 2D or 3D coordinates. There are two main ways of\ndoing ordination. The first is to use a formula that converts a higher-\ndimensional space into a lower 2D or 3D one. The alternative approach is to\nview the items as being nodes in a graph, with similar nodes connected by an\nedge. Then, the ordination is an attempt to place connected nodes near one\nanother and disconnected nodes far apart. In this chapter, we’ll use the\nlatter graph-based approach, and we’ll discuss the specific tools and\nalgorithms required of it.\n\nAfter the ordination—that is, after the items are given\ncoordinates—representations of those items (simple circles in these two\nexamples) are placed at those coordinates. The final steps required to create\nthe visualizations include placing labels (which can be quite challenging) and\noverlaying any additional analytics.\n\nYELLOWPAGES.COM\n\nUntil recently, it was quite common to use printed phone books to find people\nand services. The section for services was known as the Yellow Pages. Within\nthose pages, businesses were grouped by category, and the categories were then\nsorted alphabetically. It was simple stuff.\n\nYELLOWPAGES.COM (Figure 9-1), a website owned by my employer, AT&T, is a\nmodern local business search engine with the same basic goal as its print\nancestor. Obviously, though, being online, it’s not limited to organizing its\nmillions of businesses by category and alphabet in the same way the print\nversion was.\n\n![bvis_0901.png](images/bvis_0901.png)\n\nFigure 9-1. YELLOWPAGES.COM: a local business search engine\n\nIndeed, part of designing or refining such a search engine involves\nunderstanding how to organize the business listings given a query, and what\nfeatures of businesses to involve in that organization. To that end, it can be\nhelpful to take a look at the behavior of users, because that behavior can\neither validate or undermine our intuitions.\n\nQuery Logs\n\nYELLOWPAGES.COM keeps a log of every query executed on the site, so it can use\nthat data to improve its service. Here are the top five queries from the log\nfor December 2008:\n\n1\\. Restaurants\n\n2\\. Movie theaters\n\n3\\. Pizza\n\n4\\. Walmart [sic]\n\n5\\. Animal shelters\n\nThe top five are a mix of “browse” queries, where people are browsing within\ncategories (e.g., Restaurants), and “search” queries, where people are\nsearching for specific businesses (e.g., Wal-Mart). We will use the log\nqueries as the “items” in our visualization, and we’ll ordinate them based on\nthe similarity of the behavior of the users executing those queries. In that\nway, we can hope to get a big picture of query activity on the system.\n\nThe query logs for YELLOWPAGES.COM are currently the property of AT&T. If you\nwould like to look at the contents of a major search engine’s query log, AOL\nhas placed a log from 2006 in the public domain. Just Google “AOL query log”\nto find a current mirror from which to download the 500 MB file.\n\nCategorical Similarity\n\nAs stated earlier, we would like our visualization to be based on actual user\nbehavior. For example, we might like two queries to appear near each other if,\nwhen a user enters one query, she is likely to click on the same set of\nbusinesses she would have if she had entered the other query. However, the\ndata is too sparse to achieve this in practice—the overlapping sets of\nbusinesses are very small on average. To handle this sparsity, we’ll back off\na little and say that two queries are similar if, when a user enters one\nquery, she is likely to click on the same category of businesses as she would\nhave if she had entered the other query. It is from this definition of\nsimilarity that we will do the ordination.\n\nVisualization As a Substrate for Analytics\n\nAt AT&T Applied Research, we have built a number of tools for analyzing\nqueries. One such tool is a predictive model that attempts to determine\nwhether a query is intended to reference a specific business (e.g., Walgreens)\nor for browsing among a type of business (e.g., drug stores). We can overlay\nthese predictions on top of our visualization to get a big-picture sense of\nthe breakdown between these “search” vs. “browse” queries.\n\nThere are many visual encodings we could use to show which of these two\nclasses a query belongs to. The most obvious one, and the approach we have\nadopted, is coloring the nodes: in our visualization the green nodes are\nqueries that are predicted to be searches for a specific business, and other\nqueries are left black. There may be some incorrect colorings, reflecting\nerrors in this particular predictive model.\n\nFigure 9-2 shows the queries “Goodwill” and “Salvation Army” in green, meaning\nthey have been (correctly) predicted to be queries for specific businesses.\n\n![bvis_0902.png](images/bvis_0902.png)\n\nFigure 9-2. “Search” queries are colored green in our visualization\n\nThe Visualization\n\nThe final visualization is presented in Figure 9-3. It shows the top 4,600\nqueries from December 2008. When looking at this type of visualization, keep\nin mind that it has no axis. It’s all relative—similar queries are near one\nanother, and dissimilar queries are far apart. Each circle represents a query.\nSome of these circles are labeled with the query terms. Both the size of the\ncircle and the size of the label are based on the number of times the query\noccurs in the log. That way, frequent queries jump out at the viewer.\n\n![bvis_0903.png](images/bvis_0903.png)\n\nFigure 9-3. The Top 4,600 queries made on YELLOWPAGES.COM\n\nLooking at Figure 9-3, it’s easy to identify the regions where the system is\nmost often used. “Restaurants” stand out, as do retail stores such as\n“Walmart” and “Best Buy.” That queries for restaurants and retail stores are\nfrequent may not be surprising, given that this is a business search engine.\nPerhaps less predictable is the large region toward the bottom containing\ncommunity-related queries, including searches for “public schools,”\n“churches,” and “apartments.”\n\nThis type of visualization is large. It doesn’t fit well onto a single printed\npage; the best way to display it is either to print it as a large poster or to\ndisplay it as a zoomable version on a computer screen. To make it zoomable, it\ncan be loaded into an application such as Google Maps, Gigapan, or Microsoft’s\nSeadragon.\n\nSince this visualization is being published in a book, we’ll examine it and\nthe insights it offers by enlarging and discussing a few specific sections.\n\nFigure 9-4 enlarges the cluster of queries that seem to reference community-\nrelated businesses. Seeing a depiction of actual user behavior such as this\none might leave an impression on a search engineer, perhaps validating his\nbeliefs about the system’s usage, or causing surprise and even inspiring\ndesign changes.\n\n![bvis_0904.png](images/bvis_0904.png)\n\nFigure 9-4. A closeup of one cluster in Figure 9-3\n\nThe cluster shown in Figure 9-5 seems fairly straightforward to characterize,\nbut there are a couple of things worth pointing out. Notice the common but\ndifferent spellings of GameStop; it is perhaps to be expected that users would\nbehave the same way with the search results regardless of the spelling, so it\nshould also be expected for those queries to appear near one another in the\nvisualization. Perhaps most interesting is the proximity of pawnshop-related\nqueries to bookstore- and game store–related queries. What user querying and\nclicking behaviors might generate this pattern?\n\n![bvis_0905.png](images/bvis_0905.png)\n\nFigure 9-5. Cluster of largely hobby-related businesses\n\nThis visualization technique is powerful in that it’s not just proximity\nwithin a single cluster that provides insight, but also proximity of clusters\nto one another. In Figure 9-6, there are two clusters, one dealing with\npharmacies and one with liquor stores, that have been placed relatively close\nto each other. This indicates that users tend to click on similar business\nwhether they are searching for pharmacies or liquor stores. Whereas in a\nprinted phone book, these two classes of businesses would be found only under\ntheir separate categories, a search engine can consider these behavioral\nassociations in producing search results.\n\n![bvis_0906.png](images/bvis_0906.png)\n\nFigure 9-6. Two nearby clusters: drug and liquor stores\n\nAdvantages and Disadvantages of the Technique\n\nHaving looked at one of these “big-picture” visualizations, it’s worth\ndiscussing the advantages and disadvantages of this technique.\n\nThe biggest benefit is that it’s scalable and totally algorithmic. The\nvisualization in Figure 9-3 shows 4,600 items, but the algorithms can scale to\nhandle millions. (Obviously, to usefully view millions of items, an interface\nthat allows panning and zooming would be required.)\n\nAnother benefit of this technique is that it works nicely as a stable, global\nsubstrate on which to display other analytics. For example, we used green and\nblack to differentiate between search and browse queries. We could easily\noverlay any number of other analytics. Perhaps it would be interesting to show\nthe average ages of the users making specific queries, assuming we had such\ndata, or a prediction of the likelihood of a user using the system again given\nthe query entered. Overlaying such a prediction might give us a picture of\nwhere the system performs well and poorly.\n\nThe biggest disadvantage (and criticism) of this technique is that it does not\nallow precise comparisons. It is difficult to quantify and explain the\nrelationships between particular pairs of items in this visualization; other\nvisualization techniques are more effective for such narrow analytics. This is\nmore a technique to inspire new questions about the dataset, or to hint at\nwhat the answers to certain questions may be, rather than a source of specific\nanswers.\n\nAnother obvious disadvantage is that people are not already educated as to how\nto interpret such views. Scatterplots, bar charts, pie charts—sure, but not\nlarge-scale graph drawings.\n\nA technical issue, illustrated by the otherwise interesting clusters in Figure\n9-7, is the difficulty of labeling so many items. The visualizations in this\nchapter all use automatic labeling algorithms that optimize the placement of\nthe labels to minimize overlap. All the same, some overlap is inevitable.\nPerhaps as the technique continues to develop, creative new solutions will\naddress this issue.\n\n![bvis_0907.png](images/bvis_0907.png)\n\nFigure 9-7. A cluster with labels that are difficult to read\n\nOne final issue with these visualizations is that, as mentioned earlier, they\ngenerally involve a reduction from a higher-dimensional dataset to a two- or\nthree-dimensional dataset. Information can be lost in the reduction process,\nso it is difficult to be certain whether an interesting-looking grouping truly\nreflects something interesting about the dataset or is merely an artifact of\nthat process.\n\nThe Netflix Prize\n\nThere have long been visions of enabling individuals to tailor their\nexperience of the Web, and efforts to achieve that goal. Ideally, such\npersonalization will enable services on the Web to understand your tastes well\nenough to help you discover restaurants, books, music, movies, and other\nthings that will interest you.\n\nNetflix, a company that rents movies by mail and online, has a system that\nattempts to make appropriate recommendations to its customers. The\nrecommendations are based on the movies that a customer has rated highly, as\nwell as the movies that customers with similar tastes have rated highly. In\nthe fall of 2006, the company started a competition offering a prize of one\nmillion dollars to anyone who could improve its recommendation algorithm by 10\npercent. As part of this competition, Netflix released a dataset containing\n100 million user ratings for 17,700 movies. This dataset can be found online\nat the UCI Machine Learning Repository (<http://archive.ics.uci.edu/ml/>).\n\nThe challenges of building a discovery system from this dataset include the\nfact that there is both too much data and too little data. There is too much\ndata to use simple techniques to explain it all, or even to browse it.\nHowever, from the standpoint of making accurate recommendations, there is less\ndata than we would like. The distribution of ratings is far from uniform—many\nusers have rated few movies, and many movies have few ratings. For those users\nand those movies, accurate predictions are difficult to make.\n\nPreference Similarity\n\nA well-known measure of similarity used in many recommendation systems is\ncosine similarity. A practical introduction to this technique can be found in\nLinden, Smith, and York (2003).\n\nIn the case of movies, intuitively, the measure indicates that two movies are\nsimilar if users who rated one highly rated the other highly or, conversely,\nusers who rated one poorly rated the other poorly.\n\nWe’ll use this similarity measure to generate similarity data for all 17,700\nmovies in the Netflix Prize dataset, then generate coordinates based on that\ndata. If we were interested in building an actual movie recommender system, we\nmight do so simply by recommending the movies that were similar to those a\nuser had rated highly. However, the goal here is just to gain insight into the\ndynamics of such a recommender system.\n\nLabeling\n\nThe YELLOWPAGES.COM visualization was easier to label than this Netflix Prize\nvisualization for a number of reasons, including fewer nodes and shorter\nlabels, but mostly because the nodes were more uniformly distributed. Although\nthe Netflix Prize visualization has a large number of clusters, most of the\nmovies are contained in only a small number of those clusters. This disparity\nis even more apparent when we look at only the movies with the most ratings.\n\nTwo different approaches to labeling were considered:\n\n  * Label the top movies, and a random sample of other movies. This will reveal the clusters containing the most popular films, but because of the density of those clusters, it may be difficult to read the labels.\n  * Divide the page into a grid and label a small sample of nodes in each grid location. This ensures that all clusters will have some labels. \n\nFor the visualization in Figure 9-8, the first strategy was used because it\nillustrates the highly nonuniform distribution both of movies in general and\nof movies with large numbers of ratings (indicated by larger circles).\nHowever, for the enlargements of the visualization in the subsequent figures,\nthe second strategy was used for improved readability.\n\n![bvis_0908.png](images/bvis_0908.png)\n\nFigure 9-8. Visualization of the 17,700 movies in the Netflix Prize dataset\n\nCloser Looks\n\nOther than ratings, the only data in the Netflix Prize dataset is the titles\nand release dates for the movies. However, competitors in the Netflix Prize\nhave found that latent attributes, such as the amount of violence in a movie\nor the gender of the user, are important predictors of preference. Not\nsurprisingly, some of the clusters appear to be explainable by these\nattributes. Why other clusters emerge from user preferences, however, is more\ndifficult to explain.\n\nThe first cluster of movies we’ll look at (Figure 9-9), containing titles such\nas Star Trek, X-Files, and Dune, seems to be largely characterized by a genre:\nscience fiction. Galaxy Quest is also sci-fi, though satiric sci-fi. Monk, a\ndetective comedy, would seem to be the odd member of this collection. However,\nthis is a preference clustering, and preference is by no means defined only by\ngenre. The other possible explanation for this anomaly is that there are very\nfew ratings for Monk (note the small size of the node within the cluster), so\nits placement may be an error; that is, it may not reflect the actual\npreferences of Netflix users. This is a main source of difficulty not just in\ncreating this visualization, but for the Netflix Prize competition itself;\npredicting user preferences for movies with few existing ratings is tough.\n\n![bvis_0909.png](images/bvis_0909.png)\n\nFigure 9-9. Cluster of sci-fi movies\n\nExplaining other clusters can be much more challenging. Consider the example\nin Figure 9-10. It may make intuitive sense that films such as Margaret Cho,\nThe Man Show, and The Rocky Horror Picture Show (all controversial comedies)\nwould be liked by a certain group of users and reviled by others, and thus\nwould appear as a cluster. But if that’s the case, why aren’t other movies\nwith a similar type of humor in this cluster? Why is the pull between these\nparticular movies so strong that they form a cluster rather than being\ndistributed amongst other clusters?\n\n![bvis_0910.png](images/bvis_0910.png)\n\nFigure 9-10. Cluster of movies with similar humor\n\nFigure 9-11 provides another example of a cluster that intuitively makes sense\nas a reflection of preference. If we could have access to additional\nattributes about these movies or the users who rated them highly, which of\nthem might help explain the preferences revealed within this cluster?\n\n![bvis_0911.png](images/bvis_0911.png)\n\nFigure 9-11. Cluster of “family-friendly” movies\n\nAn attempt at explaining the cluster in Figure 9-12 might focus on the fact\nthat most of the films in this cluster are blockbuster action movies. Even if\none considers The Devil’s Advocate something other than an action movie, the\nleading actor (Keanu Reeves) appears in many such films, so other movies he\nstars in may be expected to appeal to the same audience.\n\n![bvis_0912.png](images/bvis_0912.png)\n\nFigure 9-12. Cluster of action movies\n\nThe cluster in Figure 9-13 is larger and a bit more difficult to characterize,\nbut user preference is well reflected. Most of these films have a certain\n“feel-good” appeal; the majority are love stories.\n\n![bvis_0913.png](images/bvis_0913.png)\n\nFigure 9-13. Cluster of “feel-good” movies\n\nAn already-mentioned issue is that the movie recommendations might not be as\ngood for users who haven’t already rated many movies, because the system\ndoesn’t yet know those users’ preferences. We call this the cold start\nproblem. In fact, we can still have this problem even for users who have rated\na lot of movies, if those ratings were spread across a number of contexts. For\nexample, say the user is a guy who doesn’t really like the kind of movies in\nthe last cluster but has started renting them for date nights with his\ngirlfriend, and rating the movies based on how well each date goes. If he then\nstarts renting movies for himself, he may not have made enough ratings\nreflecting his own preferences to be able to discover movies that he will\nactually like. More broadly, we can describe this issue as context amplifying\nthe issue of data sparsity.\n\nCreating Your Own\n\nYou may be interested in creating similar visualizations to the ones shown\nhere for your favorite datasets. There are many tool stacks that can be used\nto accomplish this. We first used Perl to parse the data and compute the\nsimilarities (of course, another language could be substituted for Perl).\nThese similarities were then passed to Shawn Martin’s freely available DrL\nsoftware (<http://www.cs.sandia.gov/~smartin/software.html>). DrL converts the\nsimilarities into coordinates for each node using the graph method mentioned\nearlier. DrL’s strength is that it works recursively, so the coordinates\nreflect a higher-level organization. A good alternative to DrL is GraphViz\n(<http://www.graphviz.org>).\n\nAt this point, we returned to Perl to merge the coordinates with additional\ninformation, such as the size, color, and labels of the nodes. Finally, the\ncompleted datasets were passed to the commercial graph-drawing library yFiles\n(<http://www.yworks.com/en/index.html>), which applied a layout to the labels\nand rendered the whole visualization as a .png file. yFiles is an incredibly\nuseful package, but you could bypass this step and, for example, use Perl to\ndirectly create an EPS file at the expense of the labels not being laid out.\n\nConclusion\n\nThe two examples shown in this chapter are pretty straightforward applications\nof this visualization technique. If you are interested in viewing more\nexamples of this type, a number are included in the online Places & Spaces\nexhibit (<http://www.scimaps.org/maps/browse/>), a collection of large-scale\nvisualizations curated by Katy Borner of Indiana University.\n\nIt is worth mentioning that this type of visualization is still an active area\nof research. Recent developments have focused on expanding this technique to\nincorporate constraints. A use that would benefit from constraints occurs in\nthe field of systems biology, where one might want to display protein-protein\ninteractions. The similarity measure might be based on the number of\ninteractions between two proteins. The constraints needed might be for some\nproteins within the nucleus to be given coordinates within a particular\ncircular region and for proteins within the cytoplasm to be given coordinates\nwithin a larger circular region, not overlapping with the nucleus region.\nLikewise, proteins on the membrane might be constrained to be on a circular\nline, while still grouped by similarity. Like the search and discovery systems\nvisualizations discussed in this chapter, this visualization could provide a\nbig-picture view that helps inspire or validate current intuitions. Thinking\nup other domains where such visualizations might be useful is left as an\nexercise for the reader.\n\nReferences\n\nLinden, Greg, Brent Smith, and Jeremy York. 2003. “Amazon.com\nrecommendations:Item-to-item collaborative filtering.” IEEE Internet Computing\n7, vol. 1: 76–80.\n\n\nChapter Ten\n\nFinding Beautiful Insights in the Chaos of Social Network Visualizations\n\nAdam Perer\n\nMy purpose throughout is to interpret the material by juxtaposing and\nassembling the notations into a unified, coherent whole.\n\n  * Mark Lombardi, 2000\n\nMark Lombardi was perhaps the perfect network layout algorithm. As an artist\nintent on communicating complex networks of financial and political scandals,\nhe diligently drew networks where nodes never overlap, edges rarely cross, and\nthe connections are smooth and curvy (Figure 10-1). This amount of grace and\nsensitivity is rarely present in the visualizations of social networks created\nby computational means. While advanced computational layout algorithms may be\ngrounded in physical models of springs and forces, they rarely highlight\npatterns and trends like Lombardi’s drawings do. This chapter details my\nattempts to empower users to dig deeper into these chaotic social network\nvisualizations with interactive techniques that integrate visualization and\nstatistics.\n\nVisualizing Social Networks\n\nThe increasing amount of digital information in modern society has ushered in\na golden age for data analysis. Ample data encourages users to conduct more\nfrequent exploratory data analyses to explain scientific, social, cultural,\nand economic phenomena. However, while access to data is important, it is\nultimately insufficient unless we also have the ability to understand\npatterns, identify outliers, and discover gaps. Modern databases are simply\ntoo large to examine without computational tools that allow users to process\nand interact with the data.\n\n![bvis_1001.png](images/bvis_1001.png)\n\nFigure 10-1. An example of the artist Mark Lombardi’s hand-drawn social\nnetworks: “World Finance Corporation, Miami, Florida, c. 1970-79 (6th\nVersion)” (1999); image courtesy of PIEROGI Gallery, Brooklyn, NY.\n\nOur most powerful sensory receptors—our eyes—have far more bandwidth and\nprocessing power than our receptors for smell, sound, taste, or touch.\nPresenting data through information visualizations is therefore an effective\nway to take full advantage of the strong capabilities of our most powerful\nhuman perceptual system. However, choosing an effective presentation is\nchallenging, as not all information visualizations are created equally. Not\nall information visualizations highlight the patterns, gaps, and outliers\nimportant to analysts’ tasks, and furthermore, not all information\nvisualizations “force us to notice what we never expected to see” (Tukey\n1977).\n\nA growing trend in data analysis is to make sense of linked data as networks.\nRather than looking solely at attributes of data, network analysts also focus\non the connections between data and the resulting structures. My research\nfocuses on understanding these networks because they are topical, emergent,\nand inherently challenging for analysts. Networks are difficult to visualize\nand navigate, and, most problematically, it is difficult to find task-relevant\npatterns. Despite all of these challenges, the network perspective remains\nappealing to sociologists, intelligence analysts, biologists, communication\ntheorists, bibliometricians, food-web ecologists, and many other\nprofessionals. The growing popularity of social network analysis (SNA) can be\nseen in, and inspired by, popular bestselling books such as Malcolm Gladwell’s\nThe Tipping Point (Back Bay Books), Albert-László Barabási’s Linked (Plume),\nand Duncan Watts’s Six Degrees (Norton). Countless analysts wish to analyze\ntheir network data, but there are few mature or widely used tools and\ntechniques for doing so.\n\nNetwork analysts focus on relationships instead of just the individual\nelements that can explain social, cultural, or economic phenomena; how the\nelements are connected is just as important as the elements themselves. Prior\nto the social network analysis perspective, many analysts focused largely on\ninherent individual attributes and neglected the social facet of\nbehavior—i.e., how individuals interact and the influence they have on one\nanother (Freeman 2004). Using newer techniques from the social network\ncommunity, analysts can find patterns in the structures, witness the flow of\nresources or messages through a network, and learn how individuals are\ninfluenced by their surroundings.\n\nIn practice, social network visualizations can be chaotic, particularly when\nthe network is large. Visualizations are useful in leveraging the powerful\nperceptual abilities of humans, but cluttered presentations, overlapping\nedges, and illegible node labels often undermine the benefits of visual\nexploration. In these situations, interactive techniques are necessary to make\nsense of such complex static visualizations. Inherent attributes are the\nattributes that exist in the dataset, such as gender, race, salary, or\neducation level. Interactions such as zooming, panning, or filtering by the\ninherent attributes of nodes and edges can simplify complex visualizations.\nUnfortunately, such techniques may only get users so far with complex networks\nand may not tell the whole story, particularly in small-world networks where\ndense connections will rarely untangle (van Ham 2004). Inherent attributes\nlack the structural, topological information critical to social network\nanalysts. Our major contribution is to augment information visualizations with\ncomputed attributes that reflect the tasks of users. Computed attributes can\nbe calculated from relevant statistical importance metrics (e.g., degree or\nbetweenness centrality), clustering algorithms, or data mining strategies.\n\nThis approach of leveraging computed attributes is particularly valuable for\nsocial network analysts, as they have also come to believe that inherent\nattributes do not tell the whole story. In fact, an approach taken by many\nsocial network analysts is to ignore inherent attributes during exploration to\navoid bias, and to only focus on the data’s structural properties. For social\nnetwork analysts, computed attributes can be calculated with a rich set of\nstatistical techniques, from sociology to graph theory, that allow analysts to\nnumerically uncover interesting features within their networks. Analysts might\nseek a tight-knit community of individuals, or the gatekeepers between them,\nor the most centrally powerful entities; there are a variety of sophisticated\nalgorithms for finding these traits.\n\nMost visualization tools aim to project complex data into comprehensible\nviews. However, few tools assist users by providing computed attributes that\nhighlight important properties of their data. Users can switch back and forth\nbetween statistical and visualization packages, but this can result in an\ninefficient flow in the analysis process, which inhibits discovery.\n\nSocialAction is the software tool Ben Shneiderman and I created to explore\nthese issues (<http://www.cs.umd.edu/hcil/socialaction>). It provides\nmeaningful, computed attributes on the fly by integrating both statistics and\nvisualizations to enable users to quickly derive the benefits of both.\nSocialAction embeds statistical algorithms to detect important individuals,\nrelationships, and clusters. Instead of presenting statistical results in\ntypical tabular fashion, the results are integrated in a network visualization\nthat provides meaningful computed attributes of the nodes and edges. With\ncomputed attributes, users can easily and dynamically filter nodes and edges\nto find interesting data points. The visualizations simplify the statistical\nresults, facilitating sensemaking and discovery of features such as\ndistributions, patterns, trends, gaps, and outliers. The statistics simplify\nthe comprehension of sometimes-chaotic visualizations, allowing users to focus\non statistically significant nodes and edges. The presence of these rich\ninteractions within one consistent interface provides a fluid, efficient,\nvisual analytic system that allows users to focus on insights and generating\nhypotheses rather than managing a medley of software packages. I’ll walk you\nthrough this rich interaction of statistics and visualization later, but let’s\nbegin with the motivation for why this is necessary.\n\nWho Wants to Visualize Social Networks?\n\nMy fieldwork with social network analysts, both in academia and industry,\nsuggests that pure statistical analysis is the most commonly used technique\nwhen attempting to interpret social networks. Although network visualizations\nare common in research publications and reports, they are typically created\nfor communicative purposes after the analysis is complete and not necessarily\nvisualizations used during the exploratory analysis.\n\nA history of the use of visual images in social networks is described in\n“Visualizing Social Networks” (Freeman 2000), including one of the earliest\nknown examples of a social network visualization by Jacob Moreno in 1934. In\nFigure 10-2, the triangle nodes are boys and the circle nodes are girls.\nWithout knowing any details about who the individuals in this classroom are,\none quickly learns from the visualization that 1) boys are friends with boys,\n2) girls are friends with girls, 3) one brave boy chose a girl as his friend\n(although this was not reciprocated), and 4) there is an isolated group of two\ngirls. This visualization typifies how a legible and well-positioned network\ncan explain the social structure of individuals.\n\n![bvis_1002.png](images/bvis_1002.png)\n\nFigure 10-2. One of the earliest social network visualizations: Jacob Moreno’s\nFriendship Choices Among Fourth Graders (Moreno 1934).\n\nSocial network data is extremely complex, as the dimensionality of the data\nincreases with each relationship. Those familiar with network visualizations\nmight sympathize with these statistically attuned practitioners, as it is very\ndifficult to design a useful network visualization when the number of nodes or\nedges is large. Large network visualizations are typically a tangled set of\nnodes and edges, and rarely achieve “NetViz Nirvana” (a phrase coined by Ben\nShneiderman to describe the ability to see each node and follow its edges to\nall other nodes). Network visualizations may offer evidence of clusters and\noutliers, but in general it is hard to gather deeper insights from these\ncomplex visualizations.\n\nMy first argument is that it is hard to find patterns and trends using purely\nstatistical methods. My second argument is that network visualizations usually\noffer little utility beyond a small set of insights. So what should a social\nnetwork researcher do? Use both—in a tightly integrated way—to arrive at\nbeautiful visualizations. The design of SocialAction centers on this goal.\n\nThe Design of SocialAction\n\nStructural analysts have proposed numerous measures for statistically\nassessing social networks. However, there is no systematic way to interpret\nsuch networks, as those measures can have different meanings in different\nnetworks. This is problematic, as analysts want to be certain they are not\noverlooking critical facets of the network. In order to make exploration\neasier, I interviewed social network analysts and reviewed social network\njournals to tabulate the most commonly used measurements. I then organized\nthese measures into six user-centered tasks: Overview, Rank Nodes, Rank Edges,\nPlot Nodes, Find Communities, and Edge Types. In the following sections, I’ll\ndescribe each of these tasks and their associated features in detail. However,\nlet’s first begin with an illustration of the main goals of the process.\n\nShneiderman’s Visual Information-Seeking Mantra—“Overview first, zoom and\nfilter, then details on demand” (Shneiderman 1996)—serves as guidance for\norganizing the complex tasks of a social network analyst. Analysts begin with\nan overview of the network, both statistically and visually; see Figure\n10-3(a). Measurements of the entire network, such as the density, diameter,\nand number of components, are computed and presented alongside a force-\ndirected layout of the network. The visualization gives users a sense of the\nstructure, clusters, and depth of a network, while the statistics provide a\nway to both confirm and quantify the visual findings. If the network is small,\nor the analysts are interested purely in the topology of the network, this\nstep may be enough.\n\nA more capable analyst will wish to gain a deeper understanding of the\nindividual elements of the network. Users can apply statistical importance\nmetrics common in social network analysis to measure the nodes (also known as\nvertices) and edges (also known as links). For instance, analysts can rank the\nnodes by degree (the most connected nodes), betweenness (the gatekeepers),\ncloseness (nodes that are well positioned to receive information), or other\nmetrics. After users select a metric, a table lists the nodes in rank order.\nSocialAction assigns each node a color, ranging from green (low ranking) to\nblack (average ranking) to red (high ranking). This helps illustrate each\nnode’s position among all ranked entities. The network visualization is\nupdated simultaneously, painting each node with the corresponding color. Users\nnow can scan the entire network to see where the important nodes reside; see\nFigure 10-3(a).\n\nTo gain further insights, SocialAction allows users to continue on to step 2\nof the Visual Information Seeking Mantra (“filter and zoom”). This is where\nmost other social network analysis packages strand users. Panning and zooming\nnaïvely is not enough to empower users: zooming into sections of the network\nforces users to lose the global structure, and dense networks may never\nuntangle. SocialAction allows user-controlled statistics to drive the\nnavigation. Users can dismiss portions of the network that do not meet their\ncriteria by using range sliders. Filtering by attributes or importance metrics\nallows users to focus on the types of nodes they care about, while\nsimultaneously simplifying the visualization; see Figure 10-3(b).\n\nAfter analysts can make sense of global trends through statistical\nmeasurements and visual presentations, but their analyses often are incomplete\nwithout an understanding of what the individual nodes represent. Contrary to\nmost other network visualizations, labels are always present in SocialAction.\nThe controls for font size and length allow the analysts to decide their\nemphasis. In line with step 3 of the Visual Information Seeking Mantra\n(“details on demand”), users can select a node to see all of its attributes.\nHovering over a node also highlights each node’s edges and neighbors,\nachieving NetViz Nirvana for the node of interest; see Figure 10-3(c).\n\n![bvis_1003.png](images/bvis_1003.png)\n\nFigure 10-3. (a) The Statistics side of the interface allows users to choose\nstatistical algorithms to find important nodes, detect clusters, and more. The\nVisualization side is integrated with the statistics. Nodes are colored\naccording to their ranking, with red nodes being the most statistically\nimportant. (b) The gatekeepers are found using a statistical algorithm. Users\nfilter out the unimportant nodes using a dynamic slider that simplifies the\nvisualization while maintaining the node positions and structure of the\nnetwork. (c) Labels are always given priority so users can understand what the\ndata represents. When a user selects a node, neighbors are highlighted and\ndetails appear on the left.\n\nFor another, albeit more lighthearted, example, let’s take a look at my\npersonal social network on Facebook. If I visualize the connections using a\nstandard network layout algorithm, I get a Jackson Pollack–like mess; there is\nsomething intriguing about the mess, but it certainly lacks the grace of a\nLombardi piece. However, if I make use of some statistics (in this case, a\nclustering algorithm designed to detect communities), I get a much more\nsensible output. What used to be a bunch of tangled nodes and edges is now my\nsocial network grouped into meaningful categories. I can see clusters of my\nhigh school friends, my college friends, my graduate school friends, my\nMicrosoft colleagues, and so on (Figure 10-4). An image devoid of meaning\nbecomes beautiful, thanks to our dear algorithmic friends.\n\n![bvis_1004.png](images/bvis_1004.png)\n\nFigure 10-4. A visualization of my Facebook social network. By running a\nclustering algorithm on top of the network, seven meaningful communities of\nfriends were found representing different facets of my life. Without\nclustering, the network was too tangled to provide any meaning.\n\nIn summary, bringing together statistics and visualizations yields an elegant\nsolution for exploratory data analysis. The visualizations simplify the\nstatistical results, improving the comprehension of patterns and global\ntrends. The statistics, in turn, simplify the comprehension of the sometimes-\nchaotic visualizations, allowing users to focus on statistically significant\nnodes and edges.\n\nCase Studies: From Chaos to Beauty\n\nUltimately, what makes network visualization beautiful? An 18th-century\nScottish philosopher, David Hume (1742), wrote:\n\nBeauty is no quality in things themselves. It exists merely in the mind which\ncontemplates them; and each mind perceives a different beauty.\n\nHowever, Hume’s view of beauty was contested. A Scottish associate, Henry Home\n(Lord Kames), believed that beauty could be broken down to a rational system\nof rules.\n\nWhen it comes to visualizations based on underlying data, I side with Lord\nKames. Insights offered are the measure of success for a beautiful\nvisualization. Analysts may be seeking to confirm their intuitions, detect\nanomalies or outliers, or uncover underlying patterns. Chris North, a\nprofessor at Virginia Tech, characterizes insights as complex, deep,\nqualitative, unexpected, and relevant findings. While a helpful\ncharacterization, the impression is that measuring insights is perhaps as\ncomplicated as measuring beauty. Traditional laboratory-based controlled\nexperiments have proven to be effective for many scientific tests, but do they\nwork for insights? For instance, if I invented new display or input widgets,\ncontrolled experiments could compare two or more treatments by measuring\nlearning times, task performance times, or error rates. Typical experiments\nwould involve 20–60 participants each given 10–30 minutes of training,\nfollowed by all participants doing the same 2–20 tasks during a 1–3-hour\nsession. Statistical methods such as t-tests and ANOVA would then be applied\nto check for significant differences in mean values. These summary statistics\nare effective, especially if there is small variance across users.\n\nHowever, how does someone break insights into a set of measurable tasks? The\nfirst challenge is that analysts often work for days or weeks to carry out\nexploratory data analyses on substantial problems, and their work processes\nwould be nearly impossible to reconstruct in a laboratory-based controlled\nexperiment (even if large numbers of professionals could be obtained for the\nrequisite time periods). A second difficulty is that exploratory tasks are by\ntheir nature poorly defined, so telling the users which tasks to carry out\nwould be incompatible with discovery. Third, each user has unique skills and\nexperience, leading to wide variations in performance that would undermine the\nutility of the summary statistics. In controlled studies, exceptional\nperformance is seen as an unfortunate outlier, but in case studies, these\nspecial events are fruitful critical incidents that provide insight into how\ndiscovery happens. Fourth, I wanted more than quantitative analyses of the\ntool; I also wished to hear about the problems and frustrations users\nencountered, as well as their thrilling tales of success. For such reasons, I\nturned to structured and replicated case study research methods to decide if\nSocialAction could generate beautiful visualizations.\n\nThe following sections summarize a few of my case studies of real analysts\nusing SocialAction to visualize their own data. In homage to Mark Lombardi, I\nhave chosen here to report on the covert networks of politicians and\nterrorists.\n\nThe Social Network of Senatorial Voting\n\nCongressional analysts are interested in partisan unity in the United States\nSenate. For instance, Congressional Quarterly calculates such unity by\nidentifying every vote in which a majority of Democrats voted opposite a\nmajority of Republicans, and then counts, for each senator, the percentage of\nthose votes in which that senator voted with his or her party. This metric can\nbe useful for tracking an individual senator’s party loyalty from year to\nyear, but it does not reveal much about the overall patterns in the body.\n\nChris Wilson, then an associate editor for the US News & World Report, became\ninterested in voting patterns among United States senators in 2007. Wilson set\nout to uncover senatorial patterns such as strategic, bipartisan, or\ngeographic alliances in the dataset. He spent significant effort mining voting\ndata from public databases, but was unable to find any distinct patterns\nthrough his normal methods of analysis.\n\nWilson believed social network analysis could yield the answers he sought. His\ndata included voting results for each senator during the first six months of\n2007, beginning when the Democratic Party assumed control of the chamber with\na one-seat majority. A social network can be inferred from co-occurrences of\nvotes.\n\nWilson constructed the network such that, when a senator votes with another\nsenator on a resolution, an edge connects them. The strength of each edge is\nbased on how often they vote with each other (e.g., Barack Obama and Hillary\nClinton voted together 203 times, whereas Obama and Sam Brownback voted\ntogether only 59 times). This led to a very dense network, because there were\ncertain uncontroversial resolutions that all senators voted for (e.g.,\nResolution RC-20, a bill commending the actions of “the Subway Hero” Wesley\nAutrey). All the senators were connected, resulting in a visualization\nresembling a huge, tangled web.\n\nSocialAction allows users to rank edges according to importance metrics.\nWilson used this feature to compare network visualizations by dynamically\nfiltering out relationships with low importance rankings. For instance, the\n180-vote threshold (about 60 percent voting coincidence) is shown in Figure\n10-5. Partisanship is strong even at this fairly low threshold, and the\nRepublican senators who were most likely to vote with Democrats (Collins,\nSnowe, Specter, and Smith) are evident. This visualization suggests that in\nthis particular Senate, although both parties were partisan, Republicans were\nless so than Democrats.\n\n![bvis_1005.png](images/bvis_1005.png)\n\nFigure 10-5. This visualization shows the voting patterns of U. S. senators\nduring 2007. The red Republicans are on the right and the blue Democrats are\non the left, with two Independents. Links indicate the similarity of voting\nrecords, revealing that Democrats had stronger party loyalty during 2007. Four\nRepublican senators from Northeastern states often voted with Democrats.\nMcCain and Brownback were campaigning for the presidency and did not vote\noften enough to be connected.\n\nAnother unexpected revelation was that the Democrats appeared to stay more\ntightly unified than the Republicans as the threshold increased, as evidenced\nby the much denser and darker connections on the Democrat side. Each edge is\nslightly transparent, but the constant overlapping of Democrats yields a dark\nmass, whereas the Republican side is much sparser. Wilson believed this\ninteraction beautifully illustrated the Democratic caucus’s success in keeping\nmembers in line, an important fact when reviewing legislative tactics. The\nintegration of statistics and visualization made this discovery possible.\n\nTo determine the voting patterns of individual politicians, Wilson used\nSocialAction’s statistical importance metrics. The capability to rank all\nnodes, visualize the outcome of the ranking, and filter out the unimportant\nnodes led to many discoveries. Wilson stated, for instance, that the\nbetweenness centrality statistic turned out to be “a wonderful way to\nquantitatively measure the centers of gravity in the Senate.” SocialAction\nmade it evident that only a few senators centrally link their colleagues to\none another. Wilson was also able to use the interactive clustering algorithms\nof SocialAction to “uncover geographic alliances among Democrats.” These\nfindings are just a sample of the sorts of insights that had eluded Wilson\nprior to his analysis with SocialAction.\n\nWilson was impressed with the discoveries that SocialAction helped reveal. The\ntight integration of statistics and visualization allowed him to uncover\nfindings and communicate them to his peers both at the US News & World Report\nand on Capitol Hill. SocialAction received so much attention internally that\nthe magazine hopes to replicate some of its functionality for its online\nreaders. Since completing the case study Wilson has moved to Slate magazine,\nbut he still uses SocialAction for investigative reporting. Analysis using\nSocialAction has already led to an interactive feature analyzing the social\nnetworks of steroids users in Major League Baseball\n(<http://www.slate.com/id/2180392>), and more stories are planned for the\nfuture.\n\nThe Social Network of Terrorists\n\nThe National Consortium for the Study of Terrorism and Responses to Terror\n(START) is a U.S. Department of Homeland Security Center of Excellence. START\nhas a worldwide research team that “aims to provide timely guidance on how to\ndisrupt terrorist networks, reduce the incidence of terrorism, and enhance the\nresilience of U.S. society in the face of the terrorist threat.” One member of\nthis team is James Hendrickson, a criminologist PhD candidate who is\ninterested in analyzing the social networks of “Global Jihad.”\n\nPrevious research has pointed to the importance of radicalization informing\nand sustaining terrorist organizations. While the radicalization process has\nbeen well described from a psychological standpoint, Hendrickson believes\ntheories regarding the group dynamics of terrorism have largely failed to\nproperly measure the size, scope, and other dynamics of group relations. He\nproposes to systematically compare the density and type of relationships held\nby members of Global Jihad to evaluate their predictive ability in determining\ninvolvement in terrorist attacks. Marc Sageman, a visiting fellow at START,\nassembled a database of over 350 terrorists involved in jihad when researching\nhis bestselling book, Understanding Terror Networks (University of\nPennsylvania Press). Hendrickson plans to update and formally apply social\nnetwork analysis to this data as a part of his PhD dissertation.\n\nThe Sageman database has over 30 variables for each suspected terrorist. Among\nthese variables are different types of relationships, including friends,\nfamily members, and educational ties. Hendrickson hypothesized that the types\nof relationships connecting two individuals will hugely affect their\nparticipation in terrorist attacks. He began his analysis using UCINET and was\nable to analyze some of his hypotheses. However, he believed UCINET did not\nfacilitate exploring and generating new hypotheses. Hendrickson initially was\nskeptical of using visualizations for his analysis. He preferred being able to\nprove statistical significance quantitatively rather than relying on a human’s\njudgment of an image. However, he says the quick access to the statistical\ncounterparts of SocialAction’s visualizations eased his concerns.\n\nIn particular, SocialAction’s multiplexity feature aided Hendrickson’s\nexploration. SocialAction allows users to analyze different relationship types\nwithout forcing users to load new datasets. The visualization shows the\nselected relationship edges, but keeps node positions stable in order to aid\ncomprehension. The statistical results are also automatically recomputed based\non the newly selected structure. For instance, only the “Friend” relationships\namong jihadists are selected in Figure 10-6(a). (Compare this to the denser\nFigure 10-3(a), which shows all relationship types.) The nodes here are ranked\nby degree, so red nodes have the most friends. Jihadists Osama Bin Laden and\nMohamed Atta (known for his role in the 9/11 attacks) are ranked the highest.\nHowever, when the religious ties are invoked, a different set of key jihadists\nemerges; see Figure 10-6(b).\n\n![bvis_1006.png](images/bvis_1006.png)\n\nFigure 10-6. The multiplexity of the “Global Jihad” social network is\ndemonstrated. The upper visualization (a) shows the Friendship network, with\nbin Laden the most popular individual. The bottom network (b), showing\nreligious ties, offers a much different view of the terrorist organization.\n\nAfter analyzing the statistical attributes of nodes, Hendrickson became\ninterested in understanding the individuals’ attributes. For example, he was\ninterested in answering questions like, “Does an individual’s socioeconomic\nstatus or education level impact his position in the terrorist network?” Of\ncourse, social network data does not allow users to infer causation, but it\nmay show correlation. Like statistical rankings in SocialAction, users can\nrank and filter based upon attributes. Hendrickson filtered out individuals\nwithout college degrees, religious backgrounds, or engineering expertise, and\nanalyzed the results. The combination of nodal attributes with statistical\nfiltering and plotting streamlined his accustomed workflow, and he commented\nthat he might not have been as free in his thinking if it weren’t for the ease\nof exploration in SocialAction. This analysis inspired Hendrickson to think of\nnew, not-yet-coded attributes to test additional hypotheses. He is currently\naugmenting Sageman’s database with new attributes so he can look for patterns\nin SocialAction, visually and statistically.\n\nHendrickson’s experience with SocialAction has led to new inspiration for his\ndissertation thesis. Although he had access to the dataset long before the\ncase study began and had conducted analyses with other SNA software, the\nintegration of statistics and visualization in SocialAction allowed\nexploration in new, interesting ways. As a result, the START center is\ninterested in making SocialAction the default network analysis tool for\ninternal and external users who wish to access its databases.\n\nOne other use of SocialAction by the START center was to look at networks that\nevolve over time. In their global terrorism network, nodes can be connected\nbased on whether two people committed a terrorist attack in the same area, or\nused the same weapons, or came from the same region. Edges can also have\ntemporal characteristics; for example, an edge could represent an attack in a\ncertain year. The types of edges used depend on what types of questions the\nanalyst is trying to answer. In tandem with a network diagram, users can see a\nstacked histogram, as in Figure 10-7. Each node is represented as a line and\neach column represents an edge type. The node’s thickness in each column\nrepresents the node’s ranking in the network of that edge type. The color is\nbased on the node’s overall ranking across all edge types.\n\nIn Figure 10-7, two stacked histograms are shown that demonstrate the\nevolution of a terrorist network over time. This particular network had two\ntypes of nodes: terrorist groups and the countries in which they had committed\nattacks. The country nodes are alphabetized and stacked in Figure 10-7(a),\nwhereas all the terrorist groups appear in Figure 10-7(b). The thickness of\nthe node at each year is based on the node’s degree in the network. Nodes are\ncolored based on their degree (red implies high degree, green implies low\ndegree) and are labeled in their peak years (there is a clear peak of attacks\nin 1992). Various trends can be interpreted from this image, such as that\nItaly had many different groups attacking in the earlier years, whereas India\nhad peak activity in the later years.\n\nSince there are many more terrorist groups than countries, Figure 10-7(b) is a\nbit more difficult to interpret. However, these visualizations are\ninteractive, and users can filter them according to name. So, if an analyst\ntyped the word “Armenia,” only the nodes with terrorist groups whose names\ncontain the word Armenia (such as the Armenian Secret Army for the Liberation\nof Armenia, and Justice Commandos for the Armenian Genocide) would be shown.\n\n![bvis_1007.png](images/bvis_1007.png)\n\nFigure 10-7. Stacked histograms highlight the temporal trends of two evolving\nnetworks. The upper visualization (a) displays the evolution of the country\nnodes, whereas (b) displays the evolution of the terrorist group nodes.\n\nIn 2007, the temporal visualizations shown in Figure 10-7 were on display at\nthe New York Hall of Science as a part of the Competition on Visualizing\nNetwork Dynamics (<http://vw.indiana.edu/07netsci/>). I’ll end this chapter\nwith a quote by one of the judges that emphasizes some of the goals of\nSocialAction and perhaps the essence of creating beautiful visualizations:\n\nNetworks are best read if they are not only “technically accurate” and\nvisually attractive but when they employ a type of rendering that creates a\nlandscape. That creates a bridge for the uninitiated audience to cross into\nthe field of expertise. Dataland travels have now become so enjoyable, they\nmay soon appear as special fare destinations at a travel agency near you.\nPerer’s visuals make that trip into the land of terror networks absurdly\nattractive. Having intellectual entertainment and visual pleasure with\nterrorism analysis is perhaps one way to diffuse the very essence of terror—by\nanalyzing it without being terrified. And in the end it leads to a hopefully\nmore rational dealing with it, which is the opposite of what terrorism is\ntrying to instill.\n\n  * Ingo Günther,   \nTokyo National University for Fine Arts & Music, Japan\n\nReferences\n\nFreeman, Linton. 2000.”Visualizing Social Networks.” Journal of Social\nStructure. <http://www.cmu.edu/joss/content/articles/volume1/Freeman.html>.\n\nFreeman, Linton. 2004. The Development of Social Network Analysis: A Study in\nthe Sociology of Science. Vancouver, BC, Canada: Empirical Press.\n\nHume, David. 1742. Essays: Morale, Political, and Literary.\n\nMoreno, J.L. 1934. Who Shall Survive? Washington, DC: Nervous and Mental\nDisease Publishing Co.\n\nShneiderman, Ben. 1996. “The Eyes Have It: A Task by Data Type Taxonomy for\nInformation Visualizations.” In Proceedings of the IEEE Symposium on Visual\nLanguages. Washington, DC: IEEE Computer Society.\n\nTukey, John. 1977. Exploratory Data Analysis. Boston: Addison-Wesley.\n\nvan Ham, Frank. 2004. “Interactive Visualization of Small World Graphs.” In\nProceedings of the IEEE Symposium on Information Visualization. Washington,\nDC: IEEE Computer Society.\n\n\nChapter Eleven\n\nBeautiful History: Visualizing Wikipedia\n\nMartin Wattenberg and Fernanda Viégas\n\nIn the early years of Wikipedia, we created several visualizations to\nilluminate the workings of the online encyclopedia. This chapter will take you\nthrough our process, from initial sketches to working programs to scientific\npapers. The messages to take away are the importance of working with real data\nat all steps; the benefits of starting with rough, preliminary visualizations;\nand finally, that visualization is just one piece of a larger analysis. The\nstory also illustrates the intuitions that can guide a successful\nvisualization project, from sensing when an area could benefit from\nvisualization to determining when a visualization might be “done.”\n\nDepicting Group Editing\n\nOur story begins in 2003. The two of us were working at IBM’s Collaborative\nUser Experience Research Lab, which studies how people work together online.\nWe saw that new forms of collaboration were taking place on the Internet and\nwanted to investigate them. There were many to choose from—this was the time\nthat “Web 2.0” was just beginning to take off—but Wikipedia particularly\nfascinated us.\n\nIn 2003, just two years after the online encyclopedia’s birth, the site was\nstill not well known, and among those aware of it there was serious skepticism\nabout its open authorship model. We felt some of this skepticism ourselves,\nyet many of the articles were interesting and helpful. What was going on? How\nwas such a haphazard process yielding a quality product? Aside from raw\ncuriosity, such a feeling of puzzlement is often a sign of a fertile research\narea. We decided to investigate. How did the articles on Wikipedia achieve\nsuch a high level of quality? Why didn’t we see the level of craziness,\nsilliness, and juvenile behavior that touched so many other online\ncommunities?\n\nThe Data\n\nTo answer these questions, we needed to know more. The first step (as in any\nof our visualization projects) was to find raw data. In the case of Wikipedia,\nthe data wasn’t a table of numbers in a database, but a set of document\nversions and edit histories. One of the initial brilliant decisions by\nWikipedia’s founders was to keep a full version history of every page\navailable to the public. As we eventually learned, this has critical\nimplications for the resilience of Wikipedia—but as we started the\ninvestigation, our main feeling was delight that the data was available.\n\nThat feeling of delight soon was mingled with a slight dizziness. Sifting\nthrough so much data by hand became confusing. Our database contained an\nembarrassment of riches, so it was time to bring in visualization technology.\n\nTo a casual reader, Wikipedia is just a big collection of articles, much like\na traditional encyclopedia. But under the surface, the structure is complex.\nAs most people now know, on each page is a link that lets readers edit the\narticle. Less widely appreciated are two other links labeled discussion and\nhistory. The former goes to a talk page where readers and editors can discuss\nan article. These pages, which hold everything from arguments about page\ncontent to requests for homework help, represent the “non-content” pages of\nWikipedia. Of immediate interest to us, however, was the link to a page’s edit\nhistory.\n\nThe edit history (see Figure 11-1) contains a list of links to the full edit\ntext of all previous versions, along with data on the edit’s author, the time\nat which it was made, and a comment. The comment is optional—a chance for the\nauthor to explain the purpose of the edit—but the time and author are\nautomatically logged. When an editor is not signed into the system, that\nuser’s IP address is recorded in place of a username.\n\nThe edit histories were large in 2003 and are vast today. Of course, different\nnumbers of edits were made in different articles. When we did our initial\nscrape, the article on “Microsoft” had 198 versions (for a total of 6.3\nmegabytes of text) while the article on “Cat” had only 54 versions. We began\nby writing a program to download the histories directly from the site.\nHowever, we soon realized this was poor etiquette since it puts a strain on\nthe Wikipedia servers, and instead used a single large file kindly provided by\nWikipedia for free. If you’d like to play with visualizing any of this data,\nthe best way is to download the latest version of this snapshot yourself.[1]\n\n![bvis_1101.png](images/bvis_1101.png)\n\nFigure 11-1. Discussion page for “Chocolate” on Wikipedia: the page lists\nevery change made to the article, including who made the edit, when it was\ndone, etc.\n\nHistory Flow: Visualizing Edit Histories\n\nWikipedia can display diffs between pairs of versions, highlighting added and\ndeleted words, but we wanted to be able to see an overview of all the article\nedits that had been made over time. To this end, we set out to create a new\nvisualization technique that we called history flow.\n\nEven with our data in hand, we couldn’t jump to writing graphics code. We\nneeded to be able to compute the diffs between successive articles ourselves.\nDetermining where and how two files differ seems like a routine operation,\nused in consumer programs like Microsoft Word as well as in developer tools\nsuch as version control software. Yet it is subtler than it appears, and\ndespite (or perhaps because of) the fact that this problem has been studied\nfor so long, it turns out there is no single best way to do this.\n\nThe challenge is that there is not a unique way to describe the differences\nbetween texts. For instance, consider the following two sentences:\n\n  * The quick brown fox jumped over the big post. \n  * The big brown fox jumped over the clay pots.\n\nMost algorithms will tell you that the word “quick” has been deleted and the\nword “clay” has been inserted. But what about “big”? Was it inserted in one\nplace and deleted in another, or simply moved from the end to the beginning?\nSimilarly, was the word “post” removed and replaced by “pots,” or were the\nletters in “post” rearranged to make “pots”?\n\nThe different interpretations are all logically consistent, so the goal is to\nchoose an algorithm that makes sense in a particular context. In our case, we\ndecided that editors might well shift chunks of text—moving a word or sentence\nfrom one part of an article to another—but were unlikely to shift letters to\nanagram individual words. So, we chose an algorithm written by Paul Heckel\nthat would let us track the movement of large passages, but that operated on\nword-size tokens as atomic units.[2] The output of the algorithm was a set of\ncorrespondences between two sequences, of the form “word #5 in File A\ncorresponds to word #127 in File B.”\n\nHeckel’s algorithm is straightforward to implement, and we soon had everything\nin place to begin our analysis. For every article, we had the text of each\nversion, along with a set of “correspondences” between the versions. But how\nto display this? To start with, since this is time-based data, it made sense\nto use the x-axis for the sequence, with the first version on the left, the\nsecond to its right, and so on. This fit with the way we viewed the history of\nan article, as a “river” with different “currents” for each section of the\ndocument. Initially we used the x-axis for sequence information alone, with an\nidentical number of pixels between each version’s position; later we added an\noption to space the versions by date of edit, so that versions that occurred\nclose in time were also close in space. Both ways of viewing the data turned\nout to be important later.\n\nNext, we needed to encode the document positions and correspondences between\npassages. We decided to draw versions as vertical lines whose lengths\ncorresponded to the lengths of each version. In effect, the y-axis encoded the\ndocument position within each version. Once we made this decision, it was easy\nto see how to depict correspondences by drawing lines directly from one\nversion to the next to show matches, much as in Figure 11-2 (an example of the\nkind of hand-drawn sketch we made on a whiteboard before starting to code).\n\nOur first computed version looked roughly like Figure 11-3, which shows the\npage for “Abortion” as of 2003. It’s crude and a little confusing, but there\nis a clear structure and even some features that made us wonder if there was a\nbug in our code. You’ll notice a striking gap at version 4, for instance. We\nchecked the data by hand, and this was not an error: we were looking at a\nversion where a malicious user had erased most of the article. Aha! The\nvisualization had already drawn our attention to a critical episode in the\narticle’s history.\n\n![bvis_1102.png](images/bvis_1102.png)\n\nFigure 11-2. Schematic of history flow’s visualization mechanism\n\n![bvis_1003.png](images/bvis_1003.png)\n\nFigure 11-3. An early version of history flow, with simple lines connecting\npieces of text that survive intact over consecutive versions\n\nBecause going back to the original source by hand had been cumbersome, we\nquickly added the ability to see the original text of each version in a panel\nat the right. This is typical in visualization development: after getting a\nprototype visual overview in place, it’s often a good idea to make a way to\nsee details. Not only is this a feature that users always want, but it\nprovides an essential way to check the correctness of the overview.\n\nThe skeletal visualization was still difficult to read, so we decided to “fill\nin” the correspondences—i.e., to fill in the interior of each pair of parallel\nlines. Figure 11-4 shows the result.\n\n![bvis_1104.png](images/bvis_1104.png)\n\nFigure 11-4. History flow diagram showing text age on the “Chocolate” article\nin Wikipedia: darker patches represent older passages\n\nThe resulting pictures were easier to read and seemed less complex. In fact,\nwe now felt that we had a natural way to show another variable, through the\ncolor of the polygons connecting corresponding passages.\n\nAge of Edit\n\nWe were curious whether edits that remained on the site for a long time were\nof better quality than edits with a short history, or whether they could be\ndistinguished in any other way. Age is a simple numeric variable, and it made\nsense to portray it using grayscale, as in Figure 11-4. This was the first\ncoloration effect we added, and it had two benefits: not only did it convey\nthe dimension of age, but the varying shades of gray actually made the overall\nshape of the diagram more legible. This is a counterintuitive but common\nphenomenon in visualizations: adding extra information can actually help\nclarify the reading of a complex diagram.\n\nAuthorship\n\nOur real goal, however, was to see the human dynamics behind group editing.\nFor this, we needed to portray authorship. We had the necessary data, since\neach edit came with authorship information (a username for logged-in editors,\nor an IP address for anonymous contributors). How should we assign colors to\nindividual editors? We wanted a wide range of colors, so that different\ncontributors would be distinguishable, and we wanted any given contributor to\nhave the same color across different pages. At the same time, we wanted to\ndistinguish anonymous from logged-in contributors.[3]\n\nWe settled on an unusual choice of encoding in which our software chose random\nbright, saturated colors for each user. These weren’t genuinely random, but\nwere based on the Java “hashcode” of an author’s name. This technique ensured\nthat the colors were consistent across diagrams, and that there was the widest\npossible range of variation. For anonymous editors, we chose a light shade of\ngray.\n\nThe overall effect was visually dramatic (see Figure 11-5). At a quick glance,\na viewer could tell immediately the difference between a page with many\nanonymous editors (a sea of gray) and a page edited entirely or primarily by\nlogged-in users (fully in color). It was also easy to see when a few editors\nhad dominated the writing of an article. To link author names to their colors,\nwe added a legend at the left of the screen.\n\n![bvis_1105.png](images/bvis_1105.png)\n\nFigure 11-5. History flow in color: each color represents text from a given\nauthor\n\nIndividual Authors\n\nNext, we wanted to make it easier to see just the contributions of individual\nauthors. To this end, we made the author legend clickable: selecting an author\nrecolored the diagram so that the selected author’s contributions were\nhighlighted in a bright cream color, while the other areas of the diagram\nbecame much darker (see Figure 11-6). We tried several variations before\nsettling on this scheme. The alternative of keeping the selected author’s\ncolor bright and simply fading the other authors didn’t always make the\nselection stand out, while using white for the selected author became\nconfusing since shades of gray represent anonymous editors in the main view.\n\n![bvis_1106.png](images/bvis_1106.png)\n\nFigure 11-6. Diagram showing, in cream, the contributions from a single author\nover time\n\nWe added a few other small features and encodings after this, but the truth is\nthat development slowed because our program had become fun to play with.[4] In\nfact, it was possibly too much fun! Instead of coding, we both spent time\nlooking at article after article, fascinated by the variety of patterns. This\nis a always a good sign in visualization development, and it was reinforced by\nthe fact that people passing by our desks ended up stopping for long\nconversations, drawn in by the pictures on our screens.\n\nOur visualization allowed us to quickly get a sense of the group of editors\ninvolved in each article, the kinds of changes each person made, and even the\neventual disagreements on how to proceed. Rather than fight the urge to\nvisualize an endless number of articles, we decided that the visualization\ntechnique was, at least for the moment, done. Clearly, it satisfied our\ninitial goal of pointing to patterns of collaboration that seemed to warrant\ninvestigation. Next, we turned our attention to using it to obtain scientific\nresults.\n\nHistory Flow in Action\n\nAs we examined articles, we began in exploratory mode. As we looked at diagram\nafter diagram, we slowly began to get a sense of what was normal and what was\nstrange. We also began to see several distinct classes of behavior, such as\n“edit wars” in which authors repeatedly reverted one another’s changes,\nshowing up in the visualization as striking zigzags. More importantly, we\nbegan to follow up on some of the leads that the pictures showed us.\n\nA good example of how we pursued a visual lead and moved from qualitative to\nquantitative research was our investigation of often-vandalized articles such\nas “Abortion.” It became clear from the pictures that the vandalism often\nremained on the site for only a few minutes. When we looked at a history flow\ndiagram in which the versions were equally spaced (Figure 11-7), we saw\ncharacteristic black gashes indicating malicious deletions; when we spaced the\nversions by date of edit, these often disappeared (Figure 11-8).\n\n![bvis_1107.png](images/bvis_1107.png)\n\nFigure 11-7. Editing history for “Abortion” showing versions equally\nspaced—black gutters represent “mass deletions,” an act of vandalism whereby a\nuser deletes all content in a given article\n\n![bvis_1108.png](images/bvis_1108.png)\n\nFigure 11-8. Editing history for “Abortion” showing versions spaced by time\n\nEven seeing this pattern many times, however, did not constitute scientific\nevidence. Perhaps the articles that came to mind happened to be particularly\ncontroversial or well policed. To show that vandalism and its quick repair\nwere truly widespread, we would need to take into account many more pages. To\ndo so, we performed a scan of the entire database of Wikipedia edits. With the\nhelp of our colleague Kushal Dave, we created a set of criteria that\nidentified particularly egregious vandalism[5] and wrote a program to examine\nall the edits that met these criteria. It turned out that the majority of\nthese edits were reverted within minutes, indicating that Wikipedia editors\nwere monitoring the changes closely.\n\nCommunicating the Results\n\nThe statistical confirmation of our subjective impressions was the final piece\nof the puzzle, and provided a satisfying resolution to our initial question\nabout Wikipedia. The reason we didn’t see evidence of destructive behavior\nwasn’t that this behavior didn’t exist, but that it tended to be erased\nquickly from public view. We wrote up our results and submitted a scientific\npaper, but we did not stop there.\n\nIn addition to helping the scientific case for our argument, there was\nsomething about having a few specific numbers that made it easy to explain our\nresults. The visualizations, in turn, gave the numbers credibility by adding\ndepth and detail. We found that there was a great deal of interest in our\nresults outside the academic world. Those unfamiliar with the inner workings\nof Wikipedia were quickly drawn to the magic and drama of editing an online,\npublic encyclopedia. Scholars, on the other hand, cognizant of the open source\nstyle of editing, marveled at the clarity of the images and the wealth of\ninformation being presented at once. History flow proved the value of\nvisualizing online communities for both cultural curiosity and scientific\nresearch.\n\nChromogram: Visualizing One Person at a Time\n\nIn 2006, we revisited Wikipedia. The encyclopedia was thriving, and we wanted\nto find out more about the people involved—especially the small core of active\nusers who contributed many edits. What were their strategies for allocating\ntime and energy? We were particularly interested in whether the data matched\nYochai Benkler’s model of “peer production,” which unified activities ranging\nfrom Wikipedia to the creation of Linux.\n\nWorking with a talented intern, Kate Hollenbach, we decided to analyze the\nedit histories of the site administrators (“admins”), superusers with special\nprivileges such as the ability to block other users and delete pages. Admins\ntypically have long edit histories on the site and represent a committed core\nof the Wikipedia community.\n\nOur first attempts to understand this data led to the creation of a series of\ncharts and graphs showing activity levels over time. Creating charts of\nactivity in itself is straightforward. The standard way to display this data\nis a line chart with time on the x-axis and number of edits on the y-axis. We\nworked with a series of such charts that were clear but, we felt,\nuninformative. Unlike the history flow diagrams, we did not see unexpected\npatterns or obvious leads for future investigation.\n\nOne problem seemed to be that simple graphs summarized too much of the data;\nby compressing tens of thousands of edits into a single numeric time series,\nwe ended up removing important information. We were facing a classic decision\nin a visualization project: as we traveled through the data, how close to the\nground should we fly? There was no way to know a priori whether there were\ninteresting small-scale patterns. But since we were not seeing anything of use\nfrom 30,000 feet in the air, our only choice was to look more closely.\n\nShowing All the Data\n\nTo get closer to the “ground,” we decided to look at the individual pages each\neditor touched. Editing Wikipedia is a repetitive, complex business, and we\nfelt our visualization needed to reflect that. The challenge was that some\nadmins had contributed more than 100,000 edits! (The most active user\nperformed an average of one edit every 10 minutes over the course of two\nyears.) Few visualization techniques can display that number of data points as\nan understandable picture.\n\nOne technique, however, excels at rendering vast datasets. A family of methods\nknown in the academic literature as pixel-filling visualizations represent\neach data point as either a single pixel or, at most, a very small rectangle.\nPixel-filling visualizations pack information on the screen to its maximum\ncapacity, and their very density can often lead to an ethereal beauty. Indeed,\nartist Jason Salavon’s beautiful work on displaying an entire movie as a set\nof pixels is what inspired us to explore them further.[6]\n\nWe applied this technique by representing each edit in an admin’s history as a\nsmall rectangle on the screen. We arranged these rectangles in a block,\nreading from left to right and top to bottom over time. Then, since spatial\nposition showed sequence information, we had only one variable left to play\nwith: color. This is true, essentially by definition, for all pixel-filling\nvisualizations. Usually, color is defined by a gradient that represents a\nnumeric dimension. Our challenge was that the most important variables—article\ntitles and editor comments—were raw text.\n\nTo convert these pieces of text to color, it seemed natural to try the same\nhashcode technique we had used in history flow. When we applied it, we did\nbegin to see patterns: histories in which an editor tackled the same page many\ntimes in a row showed up as long bars of color, while in other cases we could\nsee no repetition at all, indicating editors who tended to float between\npages, applying a single change to each and leaving for good.Although we were\nnow seeing more detail than before, we continued to feel that useful\ninformation was hidden. For one thing, the names of the articles had structure\nnot captured by the hashcode trick. Often, related articles began with the\nsame phrase (e.g., “List of” or “USS”). We realized that this structure would\nbe preserved by an alphabetical color scheme in which the first letters of\neach string determined the color. Figure 11-9 provides an explanation of the\ncolor scheme, while Figure 11-10 shows how a diagram is constructed.\n\n![bvis_1109.png](images/bvis_1109.png)\n\nFigure 11-9. Example colors given to typical words found in Wikipedia edit\ncomments\n\n![bvis_1110.png](images/bvis_1110.png)\n\nFigure 11-10. Construction of a Chromogram visualizing user comments per edit\n\nWhat We Saw\n\nOnce we applied this new color scheme, the pictures snapped into focus.\nAlthough the edit histories remained complex and required some squinting, we\nsaw many more types of patterns. The next few images give a sense of what we\nwere looking at.\n\nFigure 11-11 shows an article-title edit history made up of two main colors.\nThese turn out to correspond to the words “births” and “deaths.” A typical\ntitle is “Births in 1893.” What this editor is doing is adding information\nabout the births and deaths of notable people to different year pages.\n\n![bvis_1111.png](images/bvis_1111.png)\n\nFigure 11-11. Edits to “birth” and “death” articles\n\nSome editors found a subject they liked and stuck to it. Figure 11-12 is a sea\nof purple, a color corresponding to the prefix “USS,” or “United States Ship.”\nThis editor was working on pages describing specific vessels in the United\nStates Navy.\n\n![bvis_1112.png](images/bvis_1112.png)\n\nFigure 11-12. More than 1,000 edits, mostly to articles whose titles begin\nwith “USS”\n\nAfter looking through several of these diagrams, we had become accustomed to\ndense and random-seeming arrays of colors, occasionally interrupted by runs of\nidentical hues. So we were taken aback when we saw Figure 11-13, with several\nregions where the colors form a kind of rainbow.\n\n![bvis_1113.png](images/bvis_1113.png)\n\nFigure 11-13. Rainbows\n\nThis visually striking pattern represents sequences of article titles arranged\nin alphabetical order. While a short alphabetical run could occur by chance,\nwe saw many, some quite long. This was a perfect example of a lead worth\ninvestigating. Why did it happen, and what were the effects on Wikipedia?\n\nSome rainbows were subtle. Others were like Figure 11-14. Who could perform\nsuch a methodical series of edits? When we checked the user page, we realized\nthat this was the work of a “bot”: a software program that was designed to\nexecute automated edits. In this case, the edits included a massive set of\nroutine categorizations of articles on geographic locations.\n\n![bvis_1114.png](images/bvis_1114.png)\n\nFigure 11-14. A “bot”\n\nAnalyzing the Data\n\nAs with history flow, we decided to verify some of our visual impressions\nthrough statistics—for example, the issue of the rainbows representing\nalphabetically sequenced edits. First, we wrote a program that identified\nthese sequences and calculated their probability of occurring by chance,\nverifying that this was no random accident. We then went a step further. If\nmany users edit in alphabetical order, might that mean that articles whose\ntitles begin with a letter occurring early in the alphabet receive more\nattention? It seemed likely that some editors would optimistically begin long\nprojects of editing many pages, only to give up halfway through. After\ncollecting the data to test this hypothesis, we found an inverse correlation\nbetween alphabetical position of article title and number of edits, confirming\nour intuition that articles whose titles start with “a” are edited more\nfrequently than those whose titles start with “z.” The relationship wasn’t\nperfect—for instance, the letter L had the most article edits, due to the\nnumber of lists it included—but it was strong enough to count as statistically\nsignificant.\n\nThe rainbows led us to look more closely at how editors used lists to organize\ntheir own work as well as the work of others. This phenomenon fit well with\nBenkler’s model of peer production, in which work is divided into small units\nand people allocate their own time. The visualization had led us to a\nsatisfying resolution of our initial research question.\n\nConclusion\n\nAs our story shows, creating a visualization can entail a path of false starts\nand dead ends. But while the path is winding, it’s not a random walk. Both of\nour examples follow a consistent process, which we’ve refined through dozens\nof past visualizations. Here are three maxims we have found to be essential in\nall of our visualization projects:\n\nWork with real data\n\nGetting good data is often difficult and annoying. Whether you’re negotiating\na legal contract for access to a database or writing a program to scrape\ninformation from the Web, acquiring the raw material for visualizations is\nhard. Perhaps for that reason, many people try to multitask, designing\nvisualizations even while they are still working on acquiring data. In our\nexperience, that’s almost always a mistake. In the Chromogram project, for\ninstance, it was only after looking at sets of related article titles that we\nrealized an alphabetical coloring scheme might make sense.\n\nVisualize early and often—but know when to say when\n\nAs with other types of software development, working iteratively is important.\nEach of our projects began with a series of sketches. For history flow, these\nsketches eventually grew to become the final visualizations. For Chromogram,\nwe threw the sketches away and took a look at the data from a different\nperspective. In each case, we adjusted the level of detail (i.e., the amount\nof “granularity”). With history flow, adding author colors and edit-age\nindications snapped our diagrams into focus. For Chromogram, we saw nothing\nuseful until we showed the data at the finest level possible. The iteration\ndid not last forever, though, because we paid attention to signs that we were\ndone. Both history flow and Chromogram could have been polished much further,\nbut each reached a stage where we felt like we were seeing what we had come to\nsee.\n\nBe aware of the larger process\n\nVisualization is just one step in a larger chain of analysis. The chain begins\nwith a question (why does Wikipedia work?) or a vague area of inquiry (how do\nthose Wikipedia editors do it?) and ends with analysis, documentation, and\npresentation of results. A good visualization respects the links in the chain,\nencoding the right information to drive the initial inquiry and maintaining\nthe right perspective to help lead later analysis and communicate the results.\n\n[1] See <http://en.wikipedia.org/wiki/Wikipedia:Snapshots>.\n\n[2] For the technically minded, the algorithm works by first finding\nunambiguous matches between tokens found only once in each sequence, and then\nextending those matches to larger contiguous chunks.\n\n[3] Assigning anonymous users distinct colors based on their IP addresses\nseemed possibly deceptive, since there is no clear correlation between\naddresses and actual users. Different people logging in through a corporate\nnetwork at different times may have the same IP address; conversely, it’s not\nuncommon for the same person to edit from different IP addresses.\n\n[4] There still were plenty of alternatives we had not explored. We saw a\nglimpse of one such parallel visualization universe when Ben Fry independently\ncreated a version history diagram, revisionist, to show the evolution of the\nProcessing environment. Instead of adding color and interactivity, he worked\nwith the overall shape, using elegant curves and varying the placement of\ndocuments on the y-axis to make it easy to follow changes over time.\n\n[5] We looked for cases where article length dropped dramatically, as well as\nfor the presence of obscenities on the page. This certainly did not identify\nall vandalism, but the edits it picked out were indeed largely malicious.\n\n[6] In 2000, Salavon portrayed the movie Titanic as a print named “The Top\nGrossing Film of All Time, 1 × 1.” Each frame of the movie was shown as a\nsingle dot, whose color was the average of all colors in the frame.\n\n\nChapter Twelve\n\nTurning a Table into a Tree: Growing Parallel Sets into a Purposeful Project\n\nRobert Kosara\n\nAcademic software projects tend to grow organically from an initial idea into\nsomething complex and unwieldy that is novel enough to publish a paper about.\nFeatures often get added at the last minute so they can be included in the\npaper, without much thought about how to integrate them well or how to adapt\nthe program’s underlying architecture to make them fit.\n\nThe result is that many of these programs are hacked together, buggy, and\nfrankly embarrassing. Consequently, they do not get released together with the\npaper, which leads to a fundamental problem in visualization: reproducibility\nis possible in theory, but in practice rarely happens. Many programs and new\ntechniques are also built from scratch rather than based on existing ones.\n\nThe optimal model would be to release the software right away, then come back\nto it later to refine and rearchitect it so that it reflects the overall\ndesign goals of the project. This is seldom done, though, because there is no\nacademic value in a reimplementation (or thorough refactoring). Instead,\npeople move on to the next project.\n\nThe original prototype implementation of Parallel Sets\n(<http://eagereyes.org/parallel-sets>) was no different, but we decided that\nin order to get the idea out of academia into actual use, we would need a\nworking program. So we set out to rethink and redesign it, based on a better\nunderstanding of the necessary internal structures that we had gained over\ntime. In the process, we not only re-engineered the program, but also revised\nits generated visualization to clarify its underlying idea.\n\nCategorical Data\n\nHundreds of visualization techniques are described in the literature (with\nmore added every year), but only a few specifically work with categorical\ndata. Such data consists of only a few values that have special meanings (as\nopposed to continuous numerical data, where the numbers stand for themselves).\nExamples include typical census data, like values for sex (male or female),\nethnicity, type of building, heating fuel used, etc. In fact, categorical data\nis crucial for many real-world analysis tasks. The data we originally designed\nour technique for was a massive customer survey consisting of 99 multiple-\nchoice questions with almost 100,000 respondents. People were asked questions\nabout consumer goods, like detergents and other household items, as well as\ndemographic questions about household income, number of kids, ages of kids,\netc. Even in cases where it would have been possible to gather precise\ninformation (like age), the survey combined the values into groups that would\nbe useful for later analysis. That made all the dimensions strictly\ncategorical, and almost impossible to visualize using traditional means.\n\nThe dataset we will use to illustrate Parallel Sets in this chapter describes\nthe people on board the Titanic. As shown in Table 12-1, we know each\npassenger’s travel class (first, second, or third passenger class, or crew),\nsex, age (adult or child), and whether they survived or not.\n\nTable 12-1. The Titanic dataset  \n---  \nDimension |  Values  \nClass |  First, Second, Third, Crew  \nSex |  Female, Male  \nAge |  Child, Adult  \nSurvived |  Yes, No  \n  \nThere are really only three visualization techniques that work particularly\nwell for categorical data: treemaps (Shneiderman 2001), mosaic plots (Theus\n2002), and Parallel Sets. The reason for this is that there is a mismatch\nbetween the discrete domain of the data and the continuous domain of most\nvisual variables (position, length, etc.). Treating categorical data as if it\nwere numerical is acceptable when all but a few dimensions are continuous, but\nbecomes entirely useless when all of them are categorical (Figure 12-1). While\nthe natural distribution of data in most numerical datasets makes it possible\nto glean the rough distribution of at least the number of values, this becomes\nentirely impossible when there are only a few different values that are\nexactly the same between data points.\n\n![bvis_1201.png](images/bvis_1201.png)\n\nFigure 12-1. Using classical visualization techniques for categorical data:\nScatterplot (left) and Parallel Coordinates (right) lead to massive\noverplotting and do not provide much information even when tricks (such as\njittering the data points) are used\n\nParallel Sets\n\nParallel Sets, or ParSets (Bendix 2005, Kosara 2006), is a visualization\ntechnique that was designed specifically for interpreting categorical data.\nWhen talking to the experts analyzing the customer survey data, we realized\nthat most of the questions they were asking were not based on individual\nsurvey responses, but on classes of answers, or sets and set intersections.\nHow many people with more than three children under five years of age buy\nbrand-name detergent? Or, put differently, how many members of Set A are also\nin Set B? How many first-class passengers on the Titanic survived (i.e., how\nmany were in category first class on the class dimension, and in the yes\ncategory on survived)? How many of them were women (i.e., how many also had\nthe value female in the sex dimension)?\n\nThis approach means that instead of plotting thousands of individual points,\nwe only need to show the possible sets and subsets that exist in the data, as\nwell as their sizes. If the numbers and relative sizes of those sets stayed\nthe same, we reasoned, we could even show that the technique was independent\nof the actual dataset size.\n\nIn addition to the idea of showing the data as sets, ParSets was heavily\ninfluenced by Parallel Coordinates (Inselberg 2009), a popular visualization\ntechnique for high-dimensional numerical data. The parallel layout of axes\nmakes them easier to read and compare than the nested structures of treemaps\nand mosaic plots, especially as the number of dimensions increases. It is also\neasier to design effective interactions for this kind of layout.\n\nThe first version of Parallel Sets (see Figure 12-2) was based on the\ncategories first, then on the intersections. For each axis, we showed each\ncategory as a box, with its size corresponding to the fraction of all the data\npoints that each category represented. In terms of statistics, this is called\nthe marginal distribution (or marginal probability). Each axis is essentially\na bar chart, with the bars tipped over rather than standing next to each\nother.\n\n![bvis_1202.png](images/bvis_1202.png)\n\nFigure 12-2. The original Parallel Sets design\n\nReading just the bars in Figure 12-2, it is easy to see that the crew was the\nlargest class of people on the Titanic, with the third class close behind. The\nfirst class was much smaller than the third class, but was actually larger\nthan the second class. It is also quite obvious that there was a majority of\nmen (almost 80%) on the ship, and that only roughly one-third of all people on\nboard survived.\n\nRibbons connect categories that occur together, showing how often, for\nexample, first class and female intersect, thus making it possible to tell\nwhat proportion of the passengers in first class were women. The ribbons are\nwhat makes Parallel Sets more than a bunch of bar charts: being able to see\ndistributions on several axes at the same time allows the user to identify and\ncompare patterns that would otherwise be difficult to spot.\n\nIn the case of the Titanic, there was clearly an uneven distribution of women\namong the different classes. While the first class was close to 50% female,\nthe second and third classes had progressively larger majorities of men. The\ncrew consisted of over 95% men.\n\nWhile the ribbons are clearly useful, they also pose some challenges. They\nmust be sorted and the wider ones drawn first, so that the smaller ones end up\non top and are not hidden. Also, when there are many categories there tend to\nbe a lot of ribbons, resulting in a very busy display that is difficult to\nread and interact with.\n\nInteraction is an important aspect of ParSets. The user can mouse over the\ndisplay to see actual numbers, and can reorder categories and dimensions and\nadd dimensions to (and remove them from) the display. There are also means of\nsorting categories on an axis by their size, as well as combining categories\ninto larger ones (e.g., to add up all the passenger classes to better compare\nthem with the crew).\n\nVisual Redesign\n\nOne aspect of ParSets that required us to experiment quite a bit was the\nquestion of how to order the ribbons going from one axis to the next. We came\nup with two different orderings that seemed to make good sense, which we\ncalled standard and bundled. Standard mode ordered ribbons only by the\ncategory on top, which led to a branching structure but resulted in a rather\nvisually busy display when large numbers of dimensions and categories were\nincluded. Bundled mode kept ribbons as parallel as possible by grouping them\nby both the top and bottom categories, which meant detaching parts of the\nribbons from one another vertically.\n\nIt was only when we started to reimplement the technique a while later and\nwere looking for a good representation of the visual structures that we\nrealized that we had been looking at a tree structure all along (and that\nstandard mode was the way to go). The entire set of data points is the root\nnode of the tree, and each axis subdivides it into the categories on that axis\n(Figure 12-3). The ribbons display the tree; the nodes just look different\nthan expected because we collect them on each axis to form the bars.\n\n![bvis_1203.png](images/bvis_1203.png)\n\nFigure 12-3. The tree structure in Parallel Sets: nodes on each level are\ncollected into bars, and the ribbons are the connections between the nodes\n\nWe went ahead with our reimplementation without making any major changes to\nthe visual display, but the idea of the tree stuck in my head. So one day, I\nasked myself: what if we reduced the bars and focused on the ribbons? And lo\nand behold, I was looking at a much clearer tree structure (Figure 12-4).\n\n![bvis_1204.png](images/bvis_1204.png)\n\nFigure 12-4. The new Parallel Sets design, showing the tree structure much\nmore clearly\n\nA simple change had shifted the focus from the category boxes to the ribbon\ntree. In the new design, the boxes still appear when the user mouses over the\nlines (to suggest to the user that she can interact with them), but they are\nonly a means to an end. The key information we are interested in is really the\ndecomposition into subsets.\n\nIn addition to improved structural clarity, the new design also makes much\nbetter use of typography to communicate the hierarchy of dimension and\ncategory labels and is much more pleasant to look at.\n\nLooking at data in terms of aggregation and sets is not a new idea. Polaris\n(Stolte, Tang, and Hanrahan 2002) and, by extension, Tableau[1] were built on\na similar idea: aggregation of individual values and decomposition into\nsubsets. The use of treemaps for nonhierarchical data (which is what treemaps\nare mostly used for today) is based on the same transformation. Creating a\ntree of subsets from the data enables one to use any hierarchy visualization\nto show that data. The treemap, with its emphasis on node size rather than\ntree structure, is a natural choice for this.\n\nThe initial design change required only a few small changes in the program,\nbut it was clear from this point on (and from the rather lackluster\nperformance of our reimplementation) that the perceived need for a visual\nchange had just been a symptom of a fundamental design issue with the\nprogram’s data model.\n\nA New Data Model\n\nIn the original program, the data had been stored the way it came in: as one\nbig table. We later added the ability to create additional dimensions from the\ndata, but the principle did not change. With every change to the display, the\nprogram had to work its way through the entire dataset and count the\ncombinations of categories. With larger datasets, this became quite slow and\nrequired a lot of memory.\n\nThe big advantage of looking at data in terms of sets is that the individual\ndata points are really of no interest; what counts are the subsets. So, the\nnatural next step was to look at all possible aggregations of the data into\nsets, which could then be used to compute any subsets the user was interested\nin.\n\nIn statistics, this is called a cross-tabulation or pivot table. In the case\nof two dimensions, the result is a table with the categories of one dimension\nbecoming the columns, and the other becoming the rows (Figure 12-5).\n\n![bvis_1205.png](images/bvis_1205.png)\n\nFigure 12-5.  A cross-tabulation of the class and sex dimensions of the\nTitanic dataset\n\nThere are two kinds of numbers in this table: counts and percentages. Each\ncell contains the count of people for its combination of criteria at the top\nleft, and the percentage that number is of the entire dataset at the lower\nright. That latter percentage is called the a priori percentage (or\nprobability). What is generally of more interest, though, are the conditional\npercentages (or probabilities), which tell us the composition of the different\nclasses. In the top-right corner of each cell is the chance of finding the\ncolumn’s criterion given that we know the row (e.g., how many of the\npassengers in first class were women); at the lower left is the percentage\nlikelihood of finding the row criterion given the column (e.g., what percent\nof women were in first class).\n\nBecause the data is purely categorical, the cross-tabulation contains all the\ninformation about it and is all we need to store. If we wanted to recreate the\noriginal data from it, we could do that by simply generating as many rows with\neach combination of categories as are given by the cell. The only case where\nadditional data is needed is when the dataset also contains numerical columns.\n\nA cross-tabulation for more than two dimensions is a bit more involved, but\nfollows basically the same principle. A high-dimensional array is constructed\nthat has as many dimensions as the dataset, with each cell in the array\nholding the count of how often that combination of values occurred.\n\nUnfortunately, the number of possible combinations gets rather large quite\nquickly, and is actually much larger than the number of rows in most datasets.\nIn the case of the census data, for example, taking only the dimensions owned\nor rented, building size, building type, year built, year moved in, number of\nrooms, heating fuel, property value, household/family type, and household\nlanguage (out of over 100 dimensions) would result in 462,000,000\ncombinations, while the 1% microdata census sample has only 1,236,883 values\nfor the entire U.S.!\n\nThe key here is that in the high-dimensional case, most combinations never\nactually occur in the data. So, it makes sense to only count those that do and\nstore only their information. This is done in our current implementation by\nsimply using an array of integers to hold all the values for each row, and\nusing that as the key for a hash table. In almost all cases, that hash table\ntakes up less space than the original data.\n\nThe Database Model\n\nThe database is essentially a direct mapping of the hash table that contains\nthe counts for each combination of categories. Each dataset is stored in a\nseparate table, with a column for each dimension in the dataset. Each row\ncontains the values for the categories that describe the cell in the cross-\ntabulation, as well as the count of how often that combination occurs. There\nis an additional field, called the key, which is unique for each row and is\nused for joining the table when looking at numerical data.\n\nAggregating the data is done with a SQL query that simply selects the\ndimensions the user is interested in plus the total counts, and groups the\nresults by those same dimensions (Table 12-2):\n\nselect class, sex, survived, sum(count) from titanic_dims\n\ngroup by class, sex, survived;\n\nThe database thus aggregates the counts and returns a lower-dimensional cross-\ntabulation containing only the values needed for the visualization.\n\nTable 12-2. The result of querying the Titanic dataset to include only the\ndimensions class, sex, and survived  \n---  \nClass |  Sex |  Survived |  Count  \nFirst |  Male |  Yes |  62  \nFirst |  Male |  No |  118  \nFirst |  Female |  Yes |  141  \nFirst |  Female |  No |  4  \nSecond |  Male |  Yes |  25  \nSecond |  Male |  No |  154  \nSecond |  Female |  Yes |  93  \nSecond |  Female |  No |  13  \nThird |  Male |  Yes |  88  \nThird |  Male |  No |  422  \nThird |  Female |  Yes |  90  \nThird |  Female |  No |  106  \nCrew |  Male |  Yes |  192  \nCrew |  Male |  No |  670  \nCrew |  Female |  Yes |  20  \nCrew |  Female |  No |  3  \n  \nThis model is very similar in principle to data warehousing and Online\nAnalytical Processing (OLAP). Most databases have a special cube or rollup\nkeyword to create an aggregation from a regular table. This has the advantage\nthat no special processing is needed beforehand, but the disadvantage of being\nslower and requiring more disk space to store all the original values.\nStructuring the data specifically for fast read and aggregation performance\n(as is done in data warehouses and our database schema) considerably speeds up\nthe most common operation at the expense of more processing being required\nwhen new data is added.\n\nWhile the ParSets program does not currently show numerical dimensions, it\ndoes store them in the database. They are stored in a separate table,\ncontaining the key of the row the values correspond to and one column per\nnumerical dimension. Instead of using the count, a simple join query can\ntherefore be used to aggregate any numerical dimension by the cross-tabulation\ncells. Any standard SQL aggregation (sum, avg, min, max) can be used for this\npurpose. Eventually, the program will allow the user to select a numerical\ndimension to use to scale the bars and ribbons, and to also select the\naggregation used.\n\nThe current version of Parallel Sets stores its data in a local SQLite\ndatabase. SQLite is a very interesting open source database that operates on a\nsingle file. It is used in many embedded applications and is extremely\nresilient against data corruption (such devices have to expect power failure\nat any moment). While it does not have all the features of commercial\ndatabases, it is small, fast, and does not require any setup. This makes it a\nperfect data store that has a query language as an added benefit.\n\nGrowing the Tree\n\nThe cross-tabulation that the database stores and that can be retrieved is\nonly a part of the story, though. To show the user the Parallel Sets display,\nwe need a tree. Whenever the user changes the dimensions or reorders them, the\nprogram queries the database to retrieve the new cross-tabulation. It then\nwalks through the resulting data to build the tree. If you look closely, you\ncan actually already see it in Table 12-2. Whenever the same value appears\nseveral times in the same column, we’re looking at the same node of the tree,\nand only the nodes to the right of it change, as shown in Table 12-3.\n\nTable 12-3. The tree structure inherent in the query result in Table 12-2  \n---  \nClass |  Sex |  Survived |  Count  \nFirst |  Male |  Yes |  62  \nNo |  118  \nFemale |  Yes |  141  \nNo |  4  \nSecond |  Male |  Yes |  25  \nNo |  154  \nFemale |  Yes |  93  \nNo |  13  \nThird |  Male |  Yes |  88  \nNo |  422  \nFemale |  Yes |  90  \nNo |  106  \nCrew |  Male |  Yes |  192  \nNo |  670  \nFemale |  Yes |  20  \nNo |  3  \n  \nAll the program needs to do is go through the result set line by line and\nbuild the tree by following the existing nodes from left to right until it\nencounters a node that does not exist yet. That node is added and its count is\ntaken from the database row.\n\nThe database contains only the counts for the tree’s leaves, though, not its\ninternal nodes (other databases, such as Oracle, have queries that also return\ninternal nodes when performing cube queries). However, it is easy enough to\ncalculate those by simply summing the values of each node’s child nodes\nrecursively, from the leaves to the root node.\n\nThe counts themselves are also only the raw material of the fractions, which\nare calculated in the same step once all counts for a node are known. To\nactually display the bars and ribbons, percentages are used: the a priori\npercentage of each category becomes the length of the bar, by using it as the\nfraction of the total width, and the conditional percentages (the lower\ncategory on a ribbon given the upper category) are used to determine the width\nof the ribbon as a fraction of the category bar length (Figure 12-6).\n\n![bvis_1206.png](images/bvis_1206.png)\n\nFigure 12-6. The width of each ribbon represents its marginal probability\n(proportional fraction) of the total data set, and also its conditional\nprobability within each category\n\nParallel Sets in the Real World\n\nSince the program was released in June 2009, it has been downloaded over 750\ntimes (as of January 2010). We have heard from many users who have had success\nusing it with their own data. We even won a prize at VisWeek 2010’s Discovery\nExhibition (<http://discoveryexhibition.org>) for our entry talking about\nthree case studies using the program. This was written together with Joe Mako\n(Mako Metrics), Jonathan Miles (Gloucestershire City Council, UK), and Kam Tin\nSeong (Singapore Management University).\n\nJoe Mako’s use of the program was especially interesting, because he used it\nto show a kind of data flow through many processing stages. Putting the last\nstage on top meant that the ribbons were colored by final result, which let\nhim easily see where problems occurred. There actually is a visualization\ntechnique that is visually (though not conceptually) similar to Parallel Sets\nthat is used for flows, called a Sankey diagram. ParSets can emulate these\ndiagrams for flows that move strictly in one direction and only split up (but\nnever merge). Jonathan Miles and Kam Tin Seong’s uses were closer to the\noriginal aim of the program, providing interesting insights into survey\nresults and bank customers, respectively.\n\nConclusion\n\nAcademia values novelty, but there is clearly a case to be made for letting\nideas develop over time, so they become clearer and more refined. The result\nis not just a better understanding of the issues and techniques, but better\ntools that are easier to understand and provide more insights to the user.\n\nRedesigning Parallel Sets illustrated how visual representation and data\nrepresentation (as well as database design) go hand in hand. Understanding the\nunderlying model of our own technique led to a better visual design, which in\nturn led to a much-improved database and program model.\n\nReferences\n\nBendix, Fabian, Robert Kosara, and Helwig Hauser. 2005. “Parallel Sets: Visual\nanalysis of categorical data.” In Proceedings of the IEEE Symposium on\nInformation Visualization, 133–140. Los Alamitos, CA: IEEE Press.\n\nInselberg, Alfred. 2009. Parallel Coordinates: Visual Multidimensional\nGeometry and Its Applications. New York: Springer.\n\nKosara, Robert, Fabian Bendix, and Helwig Hauser. 2006. “Parallel Sets:\nInteractive exploration and visual analysis of categorical data.” IEEE\nTransactions on Visualization and Computer Graphics 12, no. 4: 558–568.\n\nShneiderman, Ben, and Martin Wattenberg. 2001. “Ordered treemap layouts.” In\nProceedings of the IEEE Symposium on Information Visualization, 73–78. Los\nAlamitos, CA: IEEE Press.\n\nStolte, Chris, Diane Tang, and Pat Hanrahan. 2002. “Polaris: A system for\nquery, analysis, and visualization of multidimensional relational databases.”\nIEEE Transactions on Visualization and Computer Graphics 8, no. 1: 52–65.\n\nTheus, Martin. 2002. “Interactive data visualization using Mondrian.” Journal\nof Statistical Software 7, no. 11: 1–9. <http://www.theusrus.de/Mondrian/>.\n\n[1] See <http://www.tableausoftware.com>.\n\n\nChapter Thirteen\n\nThe Design of “X by Y”\n\nAn Information-Aesthetic Exploration of the Ars Electronica Archives\n\nMoritz Stefaner\n\nThis chapter presents the project “X by Y,” a visualization of all entries to\nthe Prix Ars Electronica, a well-known media art award, from 1987 to 2009. The\nfinal version of the visualization consists of a series of large-scale prints,\nsplitting up the submissions according to different criteria. This chapter\ndescribes the process leading up to the final piece, and the rationale for\nspecific design decisions.\n\nBriefing and Conceptual Directions\n\nThe Ludwig Boltzmann Institute for media.art.research contacted me in spring\n2009 to work on the submission databases for the Prix Ars Electronica. The\nmedia art festival Ars Electronica had its 30th anniversary that year, and\ntogether, we decided to take on the challenge of trying to visually analyze\nall the submissions to the Prix over its 22-year history. The databases\ncontaining the submission information had never before been analyzed in their\nentirety.\n\nIn the kickoff meeting for the project, we discussed our objectives. The\ncreative lead of the whole visualization project, Dietmar Offenhuber,\nexplained that different visualizations were to be developed in order to study\nthree different angles on the festival’s history:\n\nQuantitative analysis\n\nWhat can we say about the festival by looking at the submissions over the\nyears? How do the various categories differ, where do the submissions come\nfrom, and how do the values change over time?\n\nSocial networks\n\nWho were the jury members throughout the years? How are they—as well as the\nawarded artists—connected to one another?\n\nArt historical context\n\nWhat impact have the awarded projects had? Where have they been referenced,\nand how have they influenced the field of media arts?\n\nThe project I was to work on would belong to the first category. Specifically,\nI was to investigate what hypotheses and insights we could generate by looking\ninto the submission data, and whether we could find an appropriate visual to\nconvey the characteristics of the “ars world” to visitors of the exhibition.\n\nTogether with the art historians working on the Ars Electronica archives, I\ntried to define some first directions of interest, reflected in the matrix in\nFigure 13-1. Without looking at the databases in detail, it was assumed that\nwe should be able to work on basic dimensions like the submission’s author,\ncountry, year, prize category, and keywords, as well as whether it received a\nprize. The matrix reflects the a priori interest in certain combinations of\nthese factors—i.e., where the experts expected interesting findings to emerge.\nFor instance, it was assumed that we might want to split winners by country\n(and compare this data to the overall submission statistics) and look at the\nrelationships between authors and categories.\n\n![bvis_1301.png](images/bvis_1301.png)\n\nFigure 13-1. Matrix of initial interest in attribute combinations\n\nUnderstanding the Data Situation\n\nNext, I began to look into the available data, together with Sandor Herramhof.\nOver the years, a number of database schemas with different conventions and\nvarying degrees of modeling detail had been used, which made it very difficult\nto get an early overview of the existing data. For instance, one database\nfeatured additional information stored in an XML format inside a text field,\nbut only for some of the submissions. In order to facilitate the process of\nacquiring an overview of the data, I developed dbcounter,[1] a small nodebox\nscript that would enable us to quickly get an overview of large sets of\ncategorical data. dbcounter walks over a CSV file, determines all the unique\nvalue attributes, counts how often they occur, and plots the output as an area\nchart. The gray areas (see Figure 13-2) indicate missing or NULL values.\nOverall, the tool proved useful for understanding the contents of our\ndatabases, especially in finding missing values and getting an idea of the\ndata diversity.\n\n![bvis_1302.png](images/bvis_1302.png)\n\nFigure 13-2. First overview of the database contents with dbcounter, a custom\nnodebox script\n\nFrom these plots, some facts about the databases quickly became clear:\n\n  * There were a number of apparently redundant fields, such as “Land” (German for “country”) and “sYear,” caused by the merging of database schemas over the years.\n  * Names, years, and categories were present fairly completely.\n  * Much less country, company, and web address information was present than expected.\n\nOn the one hand, this quick first analysis allowed us to understand what types\nof attribute combinations could be expected to be meaningful and to cover at\nleast a large part of the data. As the database migration was an ongoing\nprocess, it also provided us with a useful overview of the areas in which we\nshould seek to improve the data, and which fields could be combined or filled\nup more completely. For instance, the team working on the databases containing\nthe representation country field was in fact trying to complete as much of the\ninformation as possible (“It seems like really interesting information, and we\nare already almost there”).\n\nExploring the Data\n\nAfter the first quantitative analysis of the individual fields, the next step\nwas to slice and dice a preliminary subset of the data, to investigate\ncorrelations and get some hints about the reasons for some of the gaps in the\ndata. For this step we used the commercial software Tableau,[2] which allowed\nus to explore the data in the spreadsheets we imported and the databases we\nconnected to using interactive charts in a flexible and expressive workspace.\nFor instance, we used Tableau to characterize the submissions missing country\ninformation by year and category (see Figure 13-3), in order to identify the\nbiggest gaps and facilitate the search for the missing information in other\nmedia, such as catalog texts. Questions like “How does the number of\nsubmissions relate to the submission categories?” and “Has this changed over\nthe years?” can also be answered quite easily in a graphical user interface.\n\nOther explorations included a characterization of companies in terms of the\ncategories in which they had submitted entries. The chart in Figure 13-4, for\ninstance, revealed the potential for some interesting stories. However, it\nalso quickly became clear that a large amount of manual work would be required\nto clean up all the variations in the spellings of the company names in the\ndifferent databases if we wanted to be able to make accurate statements.\n\nWe also used Tableau to produce an initial world map of the submissions (see\nFigure 13-5), with the pie charts for each country indicating the category\ndistributions. This early map reveals the European/U.S.-centric nature of the\nfestival. It soon became clear that this simplistic approach to producing a\ncartogram would be inefficient for this skewed data distribution, motivating\nthe more elaborate approach presented later.\n\n![bvis_1303.png](images/bvis_1303.png)\n\nFigure 13-3. A plot of submissions with missing country information, split up\nby year and category\n\n![bvis_1304.png](images/bvis_1304.png)\n\nFigure 13-4. Submissions by company or institution, colored by categories\n\n![bvis_1305.png](images/bvis_1305.png)\n\nFigure 13-5. World map with submissions per country, split up by category\n\nI also explored some of the data in Microsoft Excel, as it seemed superior at\nproducing stacked charts we could use for investigating trends over the years\nor comparing attribute distributions in subsets of the data. For instance,\nFigure 13-6 shows the relative proportion of submissions and the different\ntypes of prizes won by each country. From this chart, it appeared as if the\nU.S. were responsible for about 30% of all submissions but won over 60% of all\nGolden Nicas (the highest prize awarded). However, this trend turned out to be\nmuch less pronounced in the full and verified set of data analyzed later. We\nwere also aware that the relation of countries to prizes won is a complex and\nsensitive matter that can only be fully understood by considering various\nother aspects of the data, such as the number of submissions in each category\n(for instance, the computer graphics categories in the 1980s had staggering\nnumbers of submissions compared to other categories). So, while there was\npotential for some interesting insights, we decided that we would present this\nstory only if we were able to provide some context and explanation.\n\n![bvis_1306.png](images/bvis_1306.png)\n\nFigure 13-6. Prizes won by different countries\n\nFirst Visual Drafts\n\nThe analytic process delivered some initial insights into the data, and gave\nmy collaborators enough opportunities—maybe more than they desired—to correct,\nclean, and complete the databases. On that basis, borrowing terminology from\nTom Armitage’s BERG blog post “Toiling in the data-mines: What data\nexploration feels like,”[3] I had a good sense of what was available,\nsignificant, and interesting, and of the scale of the data. The next step was\nto work on the visualization principles.\n\nTo quickly prototype some different visual options, I switched to Flash\nActionScript 3 using the flare library,[4] an advanced general-purpose\nframework for producing interactive visualizations, and I explored more of the\nstacked charting options using the Excel charts I started with. One insight I\ngleaned from these charts was that we should try harder to emphasize the\nindividual data points (e.g., the individual years on the vertical axis in\nFigure 13-7), rather than producing continuous stacked area charts. In the Ars\nElectronica case, submissions are made on an annual basis only, so a visual\ninterpolation between years would have been misleading and a distortion of\nreality. These considerations led to the development of more fragile charts,\nwith the interpolation areas toned down to support the notion of them being\nonly connectors between more “solid” yearly events.\n\n![bvis_1307.png](images/bvis_1307.png)\n\nFigure 13-7. A first attempt at displaying categories by country\n\nExploring stacked area charts for categories over the years revealed some\nadditional issues to tackle from a conceptual point of view. The category\nstructure of Ars Electronica underwent a continuous evolution over the years.\nFor instance, the “Computer Music” category was not present in 1991, yet it\nwas in the years before and after. Then, in 1999, it was discontinued and a\nnew category, “Digital Musics,” was added. How best to treat this situation is\na tricky conceptual question: on the one hand, these are clearly related\ncategories, but on the other hand, it might be too simplistic to unify them\nand treat them as the same category with a different label. For decisions like\nthese, expert opinions and the designer’s view have to be taken into account\nto formulate an accurate, yet pragmatic and understandable, approach. After\nsome discussions, we resolved the issue by treating these as independent\ncategories but giving them identical colors in the different visualizations\n(Figure 13-8).\n\n![bvis_1308.png](images/bvis_1308.png)\n\nFigure 13-8. Categories over the years\n\nI also became more interested in the evocative, implicit communication aspects\nof the visualization as I explored the existing charts. I felt uncomfortable\nwith their character; from a visual point of view the Flare charts looked\nappealing, yet a bit too fragile. However, there was also a much bigger\nconcern: while it is interesting to approach a cultural phenomenon like a\nmedia art prize in purely quantitative terms, we felt as though we were losing\na sense of the scale and diversity of the data and characterizing it in\nstrokes that were too broad. Effective visualization has a strong relation to\nsummarization and prioritization; however, simply creating some rather\nabstract charts would not have done the topic itself justice. Might not there\nbe a way to display the totals, fractions, and interrelationships without\nneglecting or even hiding the individual submissions?\n\nThe Visual Principle\n\nThis motivation led me first to explore dense pixel mosaic displays (Keim\n2000), following the idea that I would like to see one visual marker for each\nindividual submission. To get a sense of how many points I could fit on a\nstandard screen, I did some quick tests using random data (see Figure 13-9).\n\n![bvis_1309.png](images/bvis_1309.png)\n\nFigure 13-9. Experimenting with dense pixel displays\n\nI found the results quite encouraging and decided to investigate further by\nlooking at QR codes.[5] Could we actually build QR codes with meaningful URLs\nthat also worked as area- or pixel-based data graphics? Another idea was to do\nsomething along the lines of Wattenberg’s (2005) colored segments of space-\nfilling curves to produce diagrams similar to treemaps (so-called “jigsaw\nmaps”).\n\nThe real eureka moment, however, came when I remembered a placement algorithm\nI had used in an earlier project. Computed on the basis of the golden angle\n(the angle corresponding to a “golden section” of a full circle, or 137.5\ndegrees), it imitates the arrangement of sunflower seeds—the most efficient\nand visually mesmerizing way of packing small elements into a large circle.\nFigure 13-10 shows a first try I produced in a few hours, wherein rings of\nalternating darkness would indicate years (reminding the viewer of annual age\nrings in tree trunk cross-sections) and the omitted points would indicate the\nsubmissions that were awarded prizes.\n\n![bvis_1310.png](images/bvis_1310.png)\n\nFigure 13-10. Submissions as dots, packed like sunflower seeds\n\nDespite its visual complexity, the underlying procedure for creating these\ntypes of arrangements can be described by simple rules: for placing the nth\npoint, choose a radius of the square root of n, multiplied by a constant\nscaling factor. The angle at which the point is placed is the angle of the\npreceding point, incremented by the golden angle (2*pi/phi = ca. 137.5\ndegrees).\n\nTo distribute the points in a homogenous and uniform manner, it is very\nimportant to use precisely this number: if we used, say, 137.4 degrees, the\ncharacteristic double spiral would be replaced by spirals in only one\ndirection and the point distances would begin to vary. Using the golden angle,\nwe can add points indefinitely, and each point will be a uniform distance from\nits neighbors. Why is this the case? Each rational number we pick for\ndissecting the circle will result in a repetition of angles sooner or later.\nIn the simplest case, if we always move a half-circle ahead, we will only end\nup with two different angles. It can be shown that for any rational fraction,\nthere will be a repetition and thus a limited set of angles used. Accordingly,\nif we want to optimize the filling and the distribution of points, we have to\nuse an irrational number—ideally, the most irrational number there is (that\nis, the one that is the least well approximated by a fraction). This number is\nphi, the number representing the golden section.\n\nThe Final Product\n\nHaving found a guiding visual principle, many of the open questions and\npossible combinations were now naturally reduced to what worked within the\nself-imposed constraints—for instance, the principle dictates circular shapes\nfor all groups of items. As the category distributions were of importance in\nall the perspectives we discussed, we decided to color-code the categories\nacross all the visualizations to be displayed, with identical colors used for\ngroups of categories that could reasonably be treated as “families” (for\ninstance, the categories in the field of computer animation and film are all\nshown as orange). In addition, I introduced a shape encoding to indicate\nwhether a submission had received a prize or not (circles for nonwinners,\ndiamonds for winners).\n\nAs discussed earlier, on a conceptual level, I became interested in the\nrelation of the totals and sums to the individual submissions. Consequently, I\nlooked for a way to incorporate this information into the final visualization.\nAfter some unsuccessful experiments with putting additional labels for the\ntotal counts around the circles and overlaying the count numbers on top of the\ncircles, which led to quite cluttered displays, I found a much more satisfying\nalternative: the numbers could actually be created by the dot pattern itself!\nAs the decision to color-code the categories ruled out all modifications to\nthe points themselves, I decided to skip all positions in the sequence that\nwould occlude the number, if it were overlaid on the circle (see Figure\n13-11). That dot would simply go in the next available precalculated position,\nso the total number of dots would remain the same but the circle size would\nincrease marginally. Obviously, this principle only works for circles with\nenough dots to create the number; accordingly, the number is only displayed\nfor circles containing a minimum of 100 items.\n\n![bvis_1311.png](images/bvis_1311.png)\n\nFigure 13-11. Numbers created by skipping points in the placement sequence\n\nAll Submissions\n\nFigure 13-12 shows all submissions to the Prix Ars Electronica over the last\n22 years. Resembling a tree trunk cross-section, the oldest submissions are\nlocated at the center, surrounded by the more recent ones. This constitutes\nthe starting point for all the other graphics, each of which is a split-up\nversion of this one, with data analyzed according to different criteria.\n\n![bvis_1312.png](images/bvis_1312.png)\n\nFigure 13-12. All 37,432 submissions, colored by category and arranged from\ninside (least recent) to outside (most recent) by submission year\n\nBy Prize\n\nThe diagram shown in Figure 13-13 is enough to motivate the whole project:\nsplitting the submissions by the prize received (or not) reveals that only 4%\nof all submissions have received an honorary mention, a distinction, or a\nGolden Nica. The remaining 96% of submissions remained invisible—up to now.\nFor this, and all the following, more analytical views, I decided to show the\ncategory distribution within the groups of data in a pie chart fashion, in\norder to avoid the perceptual distortions introduced by the concentric rings\nin the overview graphic.\n\n![bvis_1313.png](images/bvis_1313.png)\n\nFigure 13-13. Submissions by prize\n\nBy Category\n\nFigure 13-14 shows a quantitative analysis of the submissions by category. At\nthe same time, it provides a sense of the fraction of awarded projects per\ncategory in a fainter section of the pie, composed of diamond shapes in the\nright part of each circle. It shows, for instance, that the computer graphics\ncategory has the highest number of submissions (per single category), but that\na low number of prizes has been awarded per submission (a result of the fact\nthat the category has been around for only seven years). Following Wang et al.\n(2006), the layout of the circles was calculated using Flare’s\nCirclePackingLayout algorithm.\n\n![bvis_1314.png](images/bvis_1314.png)\n\nFigure 13-14. Submissions by category\n\nBy Country\n\nFigure 13-15 shows a map of the submitters’ countries of origin. Inspired by\nthe New York Times’s map of Olympic medals,[6] the layout is calculated with a\nphysical rigid body model and attempts to approximate the exact locations,\nwhile avoiding circle overlap (see Figure 13-16 for snapshots of the iterative\noptimization process).\n\n![bvis_1315.png](images/bvis_1315.png)\n\nFigure 13-15. Submissions by country\n\n![bvis_1316.png](images/bvis_1316.png)\n\nFigure 13-16. �Snapshots of the iterative map optimization\n\nTo get coordinates for the country names I used the online application\nmapspread,[7] which allows users to batch-query tabular data for\ngeocoordinates. However, some manual correction was required, as some of the\ncountry names could not be resolved (the Eastern European political landscape,\nin particular, has changed quite a bit over the last few decades), and others\nwere ambiguous: in fact, even in the final version, the label “Georgia” was\nmistakenly placed next to the United States instead of over the Eastern\nEuropean country located between Russia and Turkey.\n\nInspecting the map in detail reveals the European/U.S.-centric nature of media\nart, with very few contributions from South America, Africa, Russia, or Asia\n(with the exception of Japan). Historically, a large number of submissions\nfrom France and Spain have been made in the field of computer animation and\nfilm (orange). Italy, Sweden, and the UK show a tendency toward music\ncategories (purple), while Japan seems more into interactive art (blue). In\ncontrast, Germany and the U.S. leaned toward computer graphics (red), at least\nin the early years of the festival. Almost two-thirds of Austria’s submissions\nhave been in the (Austrian-only) U19 categories.\n\nBy Year\n\nThe sequence of pie charts in Figure 13-17 shows a clear division of the prize\nhistory in three eras. In 1995 there was a sudden decrease in submissions,\ncoinciding with the discontinuation of the computer graphics category and the\nintroduction of the World Wide Web category. One possible explanation for this\ndrop is that it was more common to submit multiple pieces per year in the\ncomputer graphics category. The years after 2004 show a stronger\ndiversification in categories and a sudden increase in submissions, largely\ndue to the introduction of the U19 categories for Austrian artists under 19\nyears of age.\n\n![bvis_1317.png](images/bvis_1317.png)\n\nFigure 13-17. �Submissions by year\n\nBy Year and Category\n\nFigure 13-18 shows a matrix version of the timeline, to allow inspection of\nthe development of individual groups of categories. In both color-coding and\nrow selection, we decided to group corresponding categories even if their\ntitles were changed over the years. (Conversely, it should be noted that some\ncategories whose names did not change had different orientations in different\nyears.) Compared to the single-year chart, this version makes it easier to see\nhow animation/film, music, and later interactive art have become the long-term\nbackbones of the Prix.\n\n![bvis_1318.png](images/bvis_1318.png)\n\nFigure 13-18. Submissions by category and year\n\nExhibition\n\n“Mapping the Archive” was located at the history lounge exhibition in the\nBrucknerhaus, and featured six different data visualization perspectives\ncreated by Dietmar Offenhuber, Evelyn Münster, Jaume Nualart, Gerhard\nDirmoser, and me (Figure 13-19).[8]\n\n![bvis_1319.png](images/bvis_1319.png)\n\nFigure 13-19. The poster in the exhibition\n\nTo facilitate the discovery of individual stories in the data, we added little\nannotation arrows to highlight interesting facts (Figure 13-20). Visitors were\nalso encouraged to add their own annotations, resulting in a couple of\ninteresting questions and remarks.\n\n![bvis_1320.png](images/bvis_1320.png)\n\nFigure 13-20. Sticky arrow notes with handwritten annotations\n\nConclusion\n\nThe visualizations presented here were developed over the summer of 2009,\nthrough a continuous exchange of ideas and information not only with the\ntechnical staff in charge of the archive databases, but also with media art\nexperts commenting on the semantic perspective of the represented information.\n\nI see the work as part of a young tradition of information aesthetics.[9] The\nscientific discipline of information visualization is usually concerned with\ncharacterizing methods of visual mapping in general, and optimizing the\nreadability and understandability of the resulting visualizations. Information\naesthetics builds on results from that area; however, being a design\ndiscipline, it strives to find a sensory representation of information based\non a specific dataset that not only is useable and readable on the explicit\ndata-representation level but, in addition, increases the “propositional\ndensity”[10] of the design piece—in short, the evocative character of a\nvisualization and what can be read “between the lines.” This approach places\nthe discipline between the traditional fields of information visualization,\nuser interface design, and art.\n\nI hope this chapter demonstrates some key features of the discipline. First,\nit is important to look at the process of creating information aesthetic\nworks. In my experience, it is crucial to work with realistic data, already\neven in the early stages of the design. In principle, many visualization ideas\ndeveloped by theory early on could work well on real-life data structures, but\nwhether they deliver interesting information and are useful for answering the\nquestions in mind—or for provoking new questions—can only be determined when\nworking with the actual data. Developing visualizations has to be a\nbootstrapping process: you must use them early on to understand which\nvisualizations and data treatments to pursue further. In our case, early\nvisualization experiments with standard tools put us in a position to\nunderstand which data fields to use and which combinations of data “smelled”\ninteresting, and provided a good basis for discussing the design features of\nthe future visualization with reference to concrete, realistic examples. If\nthe designer does not allow his own visual explorations to change his mind on\nthe way to the final product, chances are high that the result will only state\nthe obvious, without provoking new questions or revealing interesting stories.\n\nMoreover, it is crucial to be aware of the semantic context of the information\ndisplayed, and the semiotic character of the final piece. To give an analogy,\nin linguistics, the field of semantics is concerned with the study of sentence\nmeaning as it can be constructed from its constituents and their combination.\nHowever, it is widely acknowledged that language can only be fully understood\nby also looking at pragmatics: the study of how language is actually used in a\nsocial context. What is the connotation of a word or expression? What\nassociations does it evoke? And what is expressed by not saying anything? What\nform of expression is expected in a given context, and what goes against the\nnorms?\n\nMuch effort has been invested in understanding the syntax and semantics of\nvisual language for information presentation, and now information aesthetics\nis opening the door for an investigation of the pragmatics of visual language.\nIn the work presented here, for instance, the chosen visual principle was born\nout of the inherent tension induced by approaching a complex social phenomenon\nfrom a purely quantitative angle. What statement were we making in breaking\ndown a tremendously rich and varied dataset, representing 22 years of media\nart history, in all its facets, into “a couple of numbers”? The form of the\nvisualization tries to capture this tension and resolve parts of it.\n\nGiven these considerations, the notion of “aesthetics” in visualization is\nabout much more than “pretty pictures.” Surely, joy of use is an important and\nlong-underestimated factor—on many occasions, research on the user experience\nhas shown the importance of interacting in pleasant, stimulating environments.\nBut, as Steve Jobs famously remarked, “Design is not how it looks and feels,\nbut how it works.” A truly aesthetic visualization, in addition to being\nbeautiful, “works” by expressing inexplicit features of the phenomenon at\nhand, and inviting the user/viewer to explore a rich and multifaceted world.\n\nAs a final remark, looking at the meaning and context of the information\npresented in a visualization, one point is often neglected (even in the work\npresented here): how can we characterize that information in the larger scheme\nof things? Could we find explanations for some of the patterns observed by\nconnecting to external databases? In the Ars Electronica example, it might\nhave been informative to compare, for instance, submission statistics per\ncountry with more information about each country. Is the number of submissions\ncorrelated to economic power? Or digital literacy? Or other, less obvious\nfactors? As more and more open data sources for these types of information\nbecome available, it is increasingly important to provide the proper context\nand baselines for actually understanding the significance of patterns arising\nin the datasets we analyze and present.\n\nAcknowledgments\n\nThanks go to the Ludwig Boltzmann Institute for media.art.research (Linz), and\nespecially to Dieter Daniels and Katja Kwastek for providing the opportunity\nand expert input, Sandor Herramhof for the extensive data collecting and\nprocessing, Dietmar Offenhuber for creative coordination of the visualization\nactivities, and Ule Münster for the exhibition poster design and the color\npalette used for the categories.\n\nReferences\n\nKeim, D.A. 2000. “Designing pixel-oriented visualization techniques: Theory\nand applications.” IEEE Transactions on Visualization and Computer Graphics 6,\nno. 1: 59–78.\n\nLau, Andrea, and Andrew Vande Moere (2007). “Towards a model of information\naesthetic visualization.” In Proceedings of the International Conference on\nInformation Visualisation. Washington, DC: IEEE Computer Society.\n\nLidwell, William. 2009. “More with less.” ACM interactions 16, no. 6: 72–75.\n\nWang, Weixin, Hui Wang, Guozhong Dai, and Hongan Wang. 2006. “Visualization of\nlarge hierarchical data by circle packing.” In Proceedings of the SIGCHI\nConference on Human Factors in Computing Systems. New York: ACM Press.\n\nWattenberg, Martin. 2005. “A note on space-filling visualizations and space-\nfilling curves.” In Proceedings of the 2005 IEEE Symposium on Information\nVisualization. Washington, DC: IEEE Computer Society.\n\n[1] See <http://well-formed-data.net/archives/306/dbcounter-quick-visual-\ndatabase-stats>.\n\n[2] See <http://www.tableausoftware.com>.\n\n[3] See <http://berglondon.com/blog/2009/10/23/toiling-in-the-data-mines-what-\ndata-exploration-feels-like/>.\n\n[4] See <http://flare.prefuse.org>.\n\n[5] See <http://en.wikipedia.org/wiki/QR_Code>.\n\n[6] See\n<http://www.nytimes.com/interactive/2008/08/04/sports/olympics/20080804_MEDALCOUNT_MAP.html>.\n\n[7] See <http://mapspread.com>.\n\n[8] All visualizations are documented online at\n<http://vis.mediaartresearch.at>.\n\n[9] A term first coined by Lev Manovich and explicated in detail in Lau and\nVande Moere (2007).\n\n[10] As defined by William Lidwell (2009).\n\n\nChapter Fourteen\n\nRevealing Matrices\n\nMaximilian Schich\n\nThis chapter uncovers some nonintuitive structures in curated databases\narising from local activity by the curators as well as from the heterogeneity\nof the source data. Our example is taken from the fields of art history and\narchaeology, as these are my trained areas of expertise. However, the findings\nI present here—namely, that it is possible to visualize the complex structures\nof databases—can also be demonstrated for many other structured data\ncollections, including biological research databases and massive collaborative\nefforts such as DBpedia, Freebase, or the Semantic Web. All these data\ncollections share a number of properties, which are not straightforward but\nare important if we want to make use of the recorded data or if we have to\ndecide where and how our energies and funds should be spent in improving them.\n\nCurated databases in art history and archaeology come in a number of flavors,\nsuch as library catalogs and bibliographies, image archives, museum\ninventories, and more general research databases. All of them can be built on\nextremely complicated data models, and given enough data, even the most boring\nexamples—however simple they may appear on the surface—can be confusingly\ncomplex in any single link relation. The thematic coverage potentially\nincludes all man-made objects: the Library of Congress Classification System,\nfor example, deals with everything from artists and cookbooks to treatises in\nphysics.\n\nAs our example, I have picked a dataset that is large enough to be complex,\nbut small enough to examine efficiently. We are going to visualize the so-\ncalled Census of Antique Works of Art and Architecture Known in the\nRenaissance (<http://www.census.de>), which was initiated in 1947 by Richard\nKrautheimer, Fritz Saxl, and Karl Lehmann-Hartleben. The CENSUS collects\ninformation about ancient monuments—such as Roman sculptures and\narchitecture—appearing in Western Renaissance documents such as sketchbooks,\ndrawings, and guidebooks. We will look at the state of the database at the\npoint just before it was transferred from a graph-based database system\n(CENSUS 2005) to a more traditional relational database format (CENSUS BBAW)\nin 2006, allowing for comparison of the historic state with current and future\nachievements.\n\nThe More, the Better?\n\nHaving worked with art research databases for over a decade, one of the most\nintriguing questions for me has always been how to measure the quality of\nthese projects. Databases in the humanities are rarely cited like scholarly\narticles, so the usual evaluation criteria for publications do not apply.\nInstead, evaluations mostly focus on a number of superficial criteria such as\nthe adherence to standards, quality of user interfaces, fancy project titles,\nand use of recent buzzwords in the project description. Regarding content,\nevaluators are often satisfied with a few basic measures such as looking at\nthe number of records in the database and asking a few questions concerning\nthe subtleties of a handful of particular entries.\n\nThe problem with standard definitions such as the CIDOC Conceptual Reference\nModel (CIDOC-CRM) for data models or the Open Archives Initiative Protocol for\nMetadata Harvesting (OAI-PMH) for data exchange is that they are usually\napplied a priori, providing no information about the quality of the data\ncollected and processed within their frameworks. The same is true of the user\ninterfaces, which give as much indication of the quality of the content as\ndoes the aspect ratio of a printed sheet of paper. Furthermore, both data\nstandards and user interfaces change over time, which makes their significance\nas evaluation criteria even more difficult to judge. As any programmer knows,\nan algorithm written in the old Fortran language can be just as elegant as and\neven faster than a modern Python script. As a consequence, we should avoid any\nform of system patriotism in project evaluation—that is, the users of a\nparticular standard should not have to be afraid of being evaluated by the\nfans of another.\n\nEven the application of standards we all consider desirable, such as Open\nAccess, is of questionable value: while Open Access provides a positive spin\nto many current projects, its meaning within the realm of curated databases is\nnot entirely clear. Should we really be satisfied with a complicated but free\nuser interface (cf. Bartsch 2008, fig. 10), or should we prefer a\nsophisticated API and periodical dumps of the full database (cf. Freebase),\nwhich would allow for serious analysis and more advanced scholarly reuse of\nthe data? And if there is Open Access, who is going to pay the salary of a\nprivate enterprise data curator?\n\nUltimately, we must look at the actual content of any given project. As this\nchapter will demonstrate, when evaluating a database it makes only limited\nsense to focus on the subtleties of a few particular entries, as usually there\nis no average information against which to measure any particular database\nentry. The omnipresent phenomenon of long tails (Anderson 2006; Newman 2005;\nSchich et al. 2009, note 5), which we will encounter in almost all the figures\nin this chapter, suggests that it would be unwise to extrapolate from a few\ndata-rich entries to the whole database—i.e., in the CENSUS, we cannot make\ninferences about all the other ancient monuments based solely on the Pantheon.\n\nThe most neutral of the commonly applied measures remaining for evaluation is\nthe number of records in the database. It is given in almost all project\nspecifications: encyclopedias list the number of articles they contain (cf.\nWikipedia); biomedical databases publish the number of compounds, genes, or\nproteins they contain (cf. Phosphosite 2003–2007 or Flybase 2008); and even\nsearch engines traditionally (but ever more reluctantly) provide the number of\npages in their indexes (Sullivan 2005). It is therefore no wonder that the\nCENSUS project also provides some numbers:\n\nMore than 200.000 entries contain pictorial and written documents, locations,\npersons, concepts of times and styles, events, research literature and\nillustrations. The monuments registered amount to about 6.500, the entries of\nmonuments to about 12.000 and the entries of documents to 28.000.[1]\n\nAlthough these numbers are surely impressive from the point of view of art\nhistory, where large exhibition catalogs usually contain a couple of hundred\nentries, it is easy to disprove the significance of the number of records as a\ngood measure of database quality, if taken in isolation. Just as search\nengines struggle with near duplicates (cf. Chakrabarti 2003, p. 71), research\ndatabases such as the CENSUS aim to normalize data by eliminating apparent\nredundancies arising from uncertainties in the raw data and the ever-present\nmultiplicity of opinion. Figure 14-1 gives a striking example of this\nphenomenon. Note that the total number of links remains stable before and\nafter the normalization, pointing to a more meaningful first approximation of\nquality, using the ratio of the number of links relative to the number of\nentries: 3/6 vs. 3/4 in this example.\n\n![bvis_1401.png](images/bvis_1401.png)\n\nFigure 14-1. Growing dataset quality by shrinking number of records\n\nClearly, more sophisticated measures are required in order to evaluate the\nquality of a given database. If we really want to know the value of a dataset,\nwe have to look at the global emerging structure, which the commonly used\nindicators do not reveal. The only thing we can expect in any dataset is that\nthe global structure can be characterized as a nontrivial, complex system. The\ncomplexity emerges from local activity (Chua 2005), as the availability of and\nattention to the source data are highly hetereogeneous by nature. Furthermore,\nevery curator has a different idea about the a priori data model definitions.\nAs the resulting structural complexity is difficult to predict, we have to\nmeasure and visualize it in a meaningful way.\n\nDatabases As Networks\n\nStructured data in the fields of art history and archaeology, as in any other\nfield, comes in a variety of formats, such as relational or object-oriented\ndatabases, spreadsheets, XML documents, and RDF graphs; semistructured data is\nfound in wikis, PDFs, HTML pages, and (perhaps more than in other fields) on\ntraditional paper. Disregarding the subtleties of all these representational\nforms, the underlying technical structure usually involves three areas:\n\n  * A data model convention, ranging from simple index card separators in a wooden box to complicated ontologies in your favorite representational language\n  * Data-formatting rules, including display templates such as lenses (Pietriga et al. 2006) or predefined query instructions\n  * Data-processing rules that act according to the data-formatting instructions\n\nHere, we are interested first and foremost in how the chosen data model\nconvention interrelates with the available data.\n\nAs Toby Segaran (2009) pointed out in Beautiful Data, there are two ends of\nthe spectrum regarding data model conventions. On one end, the database is\namended with new tables, new fields in existing tables, new indices, and new\nconnections between tables each time a new kind of information is taken into\nconsideration, complicating the database model ever further. On the other end,\none can build a very basic schema (as shown in Figure 14-2) that can support\nany type of data, essentially representing the data as a graph instead of a\nset of tables.\n\n![bvis_1402.png](images/bvis_1402.png)\n\nFigure 14-2. Databases can be mapped to a basic schema of nodes and edges\n\nRepresented in this form, every database can be considered a network. Database\nentries form the nodes of the network, and database relations figure as the\nconnections between the nodes (the so-called edges or links). If we consider\nart research databases as networks, a large number of possible node types\nemerge: the nodes can be the entries representing physical objects such as\nMonuments and Documents, as well as Persons, Locations, Dates, or Events (cf.\nSaxl 1947). Any relation between two nodes—such as “Drawing A was created by\nPerson B”—is a link or edge. Thus, there are a large number of possible link\ntypes, based on the relations between the various node types.\n\nA priori definitions of node and link types in the network correspond to\ntraditional data model conventions, allowing for the collection of a large\namount of data by a large number of curators. In addition, the network\nrepresentation enables the direct application of computational analytic\nmethods taken from the science of complex networks, allowing for a holistic\noverview encompassing all available data. As a consequence, we can uncover\nhidden structures that go far beyond the state of knowledge at the point of\ntime when the database was conceptualized and that are undiscoverable by\nregular local queries. This in turn enables us to reach beyond the common\nmeasures of quality in our evaluations: we can check how well the data\nactually fits the data model convention, whether the applied standards are\nappropriate, and whether it makes sense to connect the database with other\nsources of data.\n\nData Model Definition Plus Emergence\n\nTo get an idea of the basic structure, the first thing we want to see in a\ndatabase evaluation is the data model—if possible, including some indicators\nof how the actual data is distributed within the model. If we’re starting from\na graph representation of the database, as defined in Figure 14-2, this is a\nsimple task. All we need is a nodeset and an edgeset, which can be easily\nproduced from a relational set of tables; it might even come for free if the\ndatabase is available in the form of an RDF dump (Freebase 2009) or as Linked\nData (Bizer, Heath, and Berners-Lee 2009). From there, we can easily produce a\nnode-link diagram using a graph drawing program such as Cytoscape (Shannon et\nal. 2003)—an open source application that has its roots in the biological\nnetworks scientific community. The resulting diagram, shown in Figure 14-3,\ndepicts the given data model in a similar way as a regular Entity-Relationship\n(E-R) data structure diagram (Chen 1976), enriched with some quantitative\ninformation about the actual data.\n\nThe CENSUS data model shown in Figure 14-3 is a metanetwork extracted from the\ngraph database schema according to Figure 14-2: every node type is depicted as\na metanode, and every link type is depicted as a metalink connecting two\nmetanodes. The metanode size reflects the number of actual nodes and the\nmetalink line width corresponds to the number of actual links, effectively\ngiving us a first idea about the distribution of data within the database\nmodel. Note that both node sizes and link line widths are highly heterogeneous\nacross types, spanning four to five orders of magnitude in our example.\nFrequent node and link types occur way more often in reality than the majority\nof less frequent types—a fact that is usually not reflected in traditional E-R\ndata structure diagrams, often leading to lengthy discussions about almost\nirrelevant areas of particular database models.\n\n![bvis_1403.png](images/bvis_1403.png)\n\nFigure 14-3. The CENSUS data model as a weighted node-link diagram\n\nThe heterogeneity of node and link type frequency evidenced in Figure 14-3 is\nnot restricted to our example. It is observable in many datasets, including\nresearch databases (Schich and Ebert-Schifferer 2009), large bibliographies\n(Schich et al. 2009), Freebase, and the Linked Data cloud, regardless of\nwhether the number of types is predefined or expandable by the curators. In\nall cases that I have seen so far, both the number of nodes per node type and\nthe number of links per link type exhibit right-skewed diminishing\ndistributions, which are widely known as long tails (Anderson 2006, Newman\n2005), and lack a shared average as found in a normal Gaussian distribution.\nThe comparable long-tail structure of hyperlinks in web pages—i.e., of a\nsingle link type in only one node type—has been well known for over a decade\n(Science 2009). Figure 14-3 makes clear that the observed heterogeneity is\nalso present at the level of node and link types within more structured data\ngraphs.\n\n![bvis_1404.png](images/bvis_1404.png)\n\nFigure 14-4. The CENSUS data model as a weighted adjacency matrix\n\nNetwork Dimensionality\n\nLooking more closely at Figure 14-3, we can see the central dimensions of the\nCENSUS database, Monuments and Documents, surrounded by an armature of\nadditional information. Both Monuments and Documents are physical objects, but\nthey differ insofar as the former are the targets and the latter are the\nsources of the central documentation links. Whereas in general any physical\nobject can function as a Monument or as a Document, the CENSUS divides them\ninto discrete node types because both groups belong to different periods\n(Classical Antiquity and Western Renaissance): ancient Roman sculptures and\narchitecture as documented by Renaissance drawings, sketchbooks, text, etc.\n\nIn addition to these central dimensions, there is another node type\nrepresenting physical objects called Replica, used for later-known replica\nMonuments that were discovered only after the defined Renaissance time frame.\nIf the CENSUS is to be generalized to encompass the entire time frame from\nAntiquity until today, it would make sense to combine Monuments, Documents,\nand Replicas into a single physical object node type, as all functions are\ndefined by the presence of certain links pointing into or out of a particular\nnode. In the early 1980s, when the data model was initially conceived, its\ndesign was influenced by certain functionality constraints regarding\nrelational databases. These constraints no longer apply, so such a change is\nnow possible.\n\nDistributed around the physical objects in Figure 14-3, we find Persons,\nLocations, and time ranges (such as Date and Style). Relations between all\nthese dimensions are mostly modeled using direct links. For example, each\nPerson is connected directly to a place of birth and a date of birth, making\nit impossible to disambiguate two alleged Birth Events (such as Venice 1573\nand Bologna 1568) in a single Person without further comment.\n\nOther example shortcuts include the document artist attribution and the 1st\nRenaissance state documentation. Again disambiguation is impossible without\nfurther comment. Regarding artist attribution, the CENSUS curators are guided\nto make a decision instead of recording multiple opinions. In the case of 1st\nRenaissance state documentation, there is only a single instance by\ndefinition. Further states are documented as Preservation Events—an obvious\nopportunity to simplify the data model.\n\nPreservation and Provenance Events are a notable exception to the\naforementioned shortcuts. They state that a particular Monument was altered by\na Person or present at a particular Location, at a particular Date, as\ndocumented by a particular Document. Both Preservation and Provenance Events\nallow for easy disambiguation.\n\nDiffering opinions across Documents can be reflected by multiple Events,\ngluing together the respective Monuments, Persons, Locations, and Dates. As\nwith physical objects, the nature of the Events is defined by the presence of\ncertain links. As a consequence, the data model could be generalized further,\nas was done in projects inspired by the CENSUS such as the Winckelmann Corpus\n(2000). In general, Events boil down to so-called star motifs (cf. Milo et al.\n2002) with a particular combination of link types. Today, Event-like\nconstructions are a standard feature of many database models, such as\nFreebase, where they are called compound value types. In principle, we could\nalso look for such Events in other networks with typed links, where they are\nnot consciously explicit but rather inherent as emergent star motifs (as in\nthe Linked Data graph).\n\nThe CENSUS becomes an authoritative—i.e., citable—source of information by\nproviding a variety of metadimensions, such as the (modern) Bibliography. The\nBibliography is subdivided into Citations, which are in turn represented as a\nseparate node type. Another source dimension is the Image node type, which\ncontains photographs taken from major photo libraries. Again, both the\nBibliography and the Images represent functions of physical objects, which are\ndefined by their adjacent links.\n\nThe remaining node types include the Record History, where curators log their\nactions on other nodes, and the Main Entry dimension, which was probably\ndissolved during the conversion of the CENSUS to a relational database. In the\nformer graph-based system, due to the lack of tables the Main Entries figured\nas database chapters, facilitating navigation by bundling together all\nPersons, Locations, etc.\n\nThe Matrix Macroscope\n\nThe node-link diagram in Figure 14-3 is only one possibility for depicting the\nCENSUS data model. As with any network consisting of nodes and links, we can\nalso depict it in the form of a so-called adjacency matrix (cf. Garner 1963;\nBertin 1981; Bertin 2001; Henry 2008), as shown in Figure 14-4. Here, the node\ntypes are represented as the vertical columns and horizontal rows of a table,\nwith link information appearing in the cells. Regarding the place of birth,\nfor example, you can imagine the link pointing from the Person row into the\nLocation column across the respective cell.\n\nAs in the node-link diagram, it is also possible to depict the total number of\nlinks occurring between two node types in the adjacency matrix; in place of\nthe line width in Figure 14-3, now the explicit number appears in the relevant\ncell. This highlights the main difference in switching the representation to a\nmatrix: our attention now focuses on the links, rather than on the nodes. It\nis striking that the matrix in Figure 14-4 not only shows the connections\nbetween node types, but also makes immediately clear which node types are not\ndirectly connected. In other words, the matrix indicates positive as well as\nnegative correlation. One example of this is the absence of links from the\nBibliography node type to authors, publication locations, and publication\ndates; though the CENSUS provides this information, it is only implicit in the\nnode description text and node label abbreviations (e.g., “Nesselrath 1993”).\nOf course, we can also spot this absence of information in the node-link\ndiagram, but the matrix makes it way more obvious.\n\nGoing beyond the total number of links between two node types, we can put a\nvariety of other useful information into the matrix cells. In Figure 14-5, for\nexample, we see a node-link diagram of all the nodes and links occurring\nbetween two node types in a cell. We generate such a diagram using a layout\nalgorithm (such as the yFiles organic layout algorithm, part of the Cytoscape\napplication), which is relatively inexpensive from a computational point of\nview. As a consequence, all of the explicit node-link data in the database\nappears in the data model matrix.\n\n![bvis_1405_left.png](images/bvis_1405_left.png)\n![bvis_1405_right.png](images/bvis_1405_right.png)\n\nFigure 14-5. The CENSUS data model as an adjacency matrix, enriched with node-\nlink diagrams,  \ni.e., actual data\n\nLooking at the result in Figure 14-5, we can learn a lot about the database.\nAt first glance, we can see that there are a few cells in which the structure\nlooks more complex, whereas in the majority of cells we find a rather boring\ncollection of stars and some dyads connecting two nodes exclusively. Another\nthing we can see is that all of the cells contain disconnected networks, in\nthe sense that they are split into discrete components (i.e., groups of\nconnected nodes). It is intriguing that here again we do not find a widespread\naverage for component size. Wherever we look, we see a long tail. A prominent\nexample is the Document-Location cell, wherein we see a clearly diminishing\nsequence of stars, connecting ever fewer Documents to single Locations; but\neven in the flattest cases, such as in the Document-Image cell, we find a few\nlarger connected groups, followed by a huge amount of dyads.\n\nA more diluted form of long tail is found in the Location-Location cell. It\ncontains a hierarchy of geographical places rooted in a node representing the\nworld, subdivided into countries, regions, and towns, down to individual\ncollections. The number of subdivisions per Location is again distributed in a\nheterogeneous way. The majority of subdivisions are found within the country\nof Italy, almost eclipsing the rest of the world. The most prominent Location\nis unsurprisingly the city of Rome, which is subdivided into numerous\ncollections. Its prominence reminds me of the oversized space dedicated to the\nhands in the sensomotory homunculus of the human brain (Penfield and Rasmussen\n1950; Dawkins 2005, pp. 243–244)—the CENSUS seems to have a romunculus. Just\nas an overly large area of our brain’s motor cortex is dedicated to hand–eye\ncoordination and the sense of touch in our hands, the CENSUS Location\nhierarchy seems to be biased toward sculpture collections in Rome. Like a\nmaster pianist, whose centers for dexterity and manual control occupy even\nmore space in the cortex than they would in a regular person, the CENSUS seems\nto be defined by specialization—such as the addition of Ulisse Aldroandi’s\nfamous books (1556 and 1562), which list thousands of sculptures in Roman\ncollections (cf. Schich 2009, pp. 124–125).\n\nAnother interesting feature of Figure 14-5 is the disproportionally large\nstars found in a number of cells. Some of the stars are natural properties of\nthe data, as in the case of the 11,927 Document nodes linked to the\nBibliographic node Bartsch 1854–1870, or the 1,146 Persons born in Italy or\nRome. However, most of the giant stars are artifacts related to unknown\nentries, such as an unidentified Monument, unknown Person, untraced Location,\nunknown Date, or unknown Style; all of these single nodes connect confirmed\ngaps of information in order to facilitate their further curation. There are\n1,350 unidentified Monuments, 5,992 Monuments with unknown creators, 5,531\nMonuments with untraced Locations, 2,752 Monuments with unknown Dates, 2,465\nMonuments with unknown Styles, 483 Preservation Events with unknown actors,\nand 559 Provenance Events with untraced Locations in our dataset. To be sure,\nthe presence of all these unknown entries is not an error; the attribution of\nan unknown Date could, for example, refute an incorrect Renaissance date\nattribution. However, the numbers provide a feeling of how incomplete our\nknowledge is. Another consideration is that, if we want to analyze the network\nstructure of each cell, we have to break (or denormalize) the unknown nodes;\notherwise, the untraced Location shortcut node would, for example, connect\nmany unrelated nodes located at many different unknown places.\n\nReducing for Complexity\n\nIf we look back at Figure 14-3 for a moment, we can see that there are 31,197\nDocument records in the CENSUS database, of which only 3,087 are connected to\nthe document authority under Main Entry. This points to an important fact:\nlarge Documents in the database are represented as trees of nodes. There are\nin fact only 3,087 Documents, including 28,110 subordinate nodes representing\npages, figures, and quadrants within those figures or paragraphs of text—a\nfact until now rarely communicated about this database. The same is true for\nMonuments: here again, a small percentage of the records—in particular, the\nArchitecture category—is subdivided into trees of nodes including building\nparts, rooms, and even tiny individual features of architectural decoration. A\nthird example is the Bibliography, which is subdivided into Citations, such as\nparagraphs of text in modern scholarly books.\n\nThe consequence of all these subdivisions in Figure 14-5 is that particular\nlinks point from and to particular subnodes: from Monument parts to Document\nparts instead of from entire Monuments to entire Documents, or from a feature\nof a decorated column base to a particular quadrant in a sketchbook figure.\nThe function of all these subdivisions is to enable data storage without a\nsignificant loss of information. However, the questions we can resolve in this\nconfiguration are often too specific. In order to uncover more interesting\nglobal properties of the data and answer questions such as how many\nsketchbooks a group of Monuments appears in (not how many figures there are in\ngeneral), or how often they are cited in books (not how many citations there\nare in general), we have to refine the matrix. A solution for this problem is\nto collapse the subdivided Documents, Monuments, and Bibliographic Citation\nnodes as shown in Figure 14-6 and redraw the entire matrix as in Figure\n14-7(a).\n\n![bvis_1406_left.png](images/bvis_1406_left.png)\n![bvis_1406_right.png](images/bvis_1406_right.png)\n\nFigure 14-6. Collapsing subdivided entries in the raw data uncovers\ninteresting complex features\n\n![bvis_1407_left.png](images/bvis_1407_left.png)\n![bvis_1407_right.png](images/bvis_1407_right.png)\n\nFigure 14-7. The refined CENSUS data model matrix, enriched with node-link\ndiagrams (a),  \nand in the basic weighted form (b)\n\n![bvis_1408_left.png](images/bvis_1408_left.png)\n![bvis_1408_right.png](images/bvis_1408_right.png)\n\nFigure 14-8. The refined CENSUS data model matrix, enriched with degree\ndistribution plots\n\nCollapsing the Documents, Monuments, and Bibliographic Citation trees to\nsingle nodes works as follows (cf. Schich 2009, p. 28–37). In Figure 14-6(a),\nwe see a raw Document tree: a book, with pages, which in turn are subdivided\ninto figures. Single links point to multiple Monuments or Monument parts. In\norder to collapse the tree, we represent the book as a single node and combine\nall the links adjacent to the subdivisions, as shown in Figure 14-6(a‘). To\npreserve as much information as possible, we assign a weight to the new node\nreflecting the number of collapsed subdivisions and another weight to the\nlinks, signifying the number of occurrences in the book. Graphically, our\nweights now correspond to the node size and the line width: the larger the\nnode of a book is, the more subnodes it contains in its collapsed tree; the\nbroader a line is, the more links it represents. Exemplified in real data,\nevery Document tree in the Document-Document cell of the raw matrix will be\nreduced to a single node, as shown in Figures 14-6(b)/(b‘). Matrix cells that\nlook boring or simple in the raw state become more complex and interesting\nafter the collapse, as in the case of the Document-Monument cell enlarged in\nFigures 14-6(c)/(c‘).\n\nThe most striking feature of the refined cell in Figure 14-6(c‘) is the\nemergence of a so-called Giant Connected Component (GCC), which connects\nalmost 90% of all Monuments and Documents in the CENSUS—a phase transition\nphenomenon known from many other complex networks and bearing many important\nimplications regarding the propagation of information (Newman, Barabási, and\nWatts 2006, pp. 415–417; Schich 2009, pp. 171–172). In the core of the GCC, we\ncan see a cluster of large architectural Monuments, which are connected to\nlarge overview Documents, such as guidebooks, sketchbooks, and city maps. A\nsurprising feature in the periphery of the GCC is the dominance of brushlike\nstructures connected to large Document nodes: obviously a large percentage of\nall Monuments in the CENSUS are connected to only one single Document, either\nbecause the Documents lack sufficient information or because (for whatever\nreason) the curators did not identify and normalize them.\n\nAs the Document, Monument, and Bibliography trees are collapsed, the\nconsequences affect the whole matrix. Effectively, the diagonal Document-\nDocument and Monument-Monument cells are thinned out, leaving only a few\ninteresting links, such as archetype citation and parallel copy relations. The\nCitation-Bibliography cell collapses completely.\n\nFurther Matrix Operations\n\nBeyond breaking unknown nodes and collapsing the trees of subdivisions, we can\ndo a number of other operations on the raw matrix in Figure 14-5. As with any\nadjacency matrix, we can sort (or permutate) the columns and lines along the\nhorizontal and vertical axes, without losing any information (Bertin 1981;\nBertin 2001). We can also transpose cells such as Monument-Event to Event-\nMonument, or even the whole Bibliography column to a Bibliography line,\neffectively reversing the direction of the links. Finally, we can merge\nequivalent node types—such as Provenance and Preservation Events, Monuments\nand Replicas, or Bibliography and Citation—by creating node supertypes, such\nas Event, Monument, and Bibliography. The merge reduces the number of columns\nand lines in the matrix and allows each cell to occupy more space in the\nvisualization. Beyond that, the literature on matrix visualization contains\nmany more possible operations (cf. Henry 2008).\n\nThe Refined Matrix\n\nFigures 14-7(a) and (b) show the final result of all refining operations\ndiscussed so far. The whole matrix is now more concise, clear, and\ninformative. We can easily see how the CENSUS data is distributed within the\ndata model: Monument- and Document-Bibliography obviously behave like\nMonument-Documentation, exhibiting a wealth of data. For Document-Document and\nMonument-Monument dependency relations (such as citations), on the other hand,\nthere is hardly any data, even though the respective links are explicit in the\ndata model. Apparently the data curation workflow was not set up in the right\nway to collect this kind of information systematically.\n\nAs in the raw matrix, we find a long tail of component sizes in every refined\ncell. Some of the cells still contain mostly stars, as is true for the number\nof Events per Monument, Images per Document/Monument, Inscriptions per\nDocument, or Events per Location. An interesting case involves the Document-\nLocation cell, where we can see that large Documents are spread throughout all\nsizes of collections, from the Uffizi in Florence to individual private\ncollections owning a single sketchbook.\n\nOther cells show more overlapping structures, as is the case with overlapping\nDates (or time ranges) across Documents and Monuments, or Styles across a few\neclectic Monuments such as the Arch of Constantine, which brings together\nreliefs from different periods of the Roman Empire. Unsurprisingly, Monument-\nDocumentation and the related Bibliography contain the most complex overlap,\nas this is the central focus of the CENSUS project.\n\nScaling Up\n\nReaders involved in the network field may point out that the use of node-link\ndiagrams in the matrix, as seen in Figure 14-7(a), is not feasible for\ndatasets an order of magnitude larger than the CENSUS, let alone as large as\nthe entire Semantic Web. Indeed this is a problem, so the question is how to\nscale the presented approach to really large databases. One solution is to use\ndegree distribution plots or even more sophisticated numerical network\nmeasures to get an idea about the actual data within the data model.\n\nIn Figure 14-8, we plot a cumulative IN- and OUT-degree distribution (Broder\net al. 2000; Newman 2005) for every link type occurring in a matrix cell. As\nevery link points OUT of the source node type and IN to a target node type,\nthere are two distributions for every link type in each cell. The x-axis of\neach plot indicates the number of links, k; the y-axis provides the cumulative\nprobability, P(k), that a node has at least k links. Note that the\ndistributions are plotted on a log-log scale, meaning that the tick marks\nindicate a rapid decay from 100% to 0.01% on the y-axis and a rapid increase\nfrom 1 to 3,000 on the x-axis. (In a regular linear projection, the slope of\neach distribution would be so steep that we would not see anything\ninteresting.) It is striking that there is not a single Gaussian bell curve in\nthe plots, as we would expect for, say, the average heights of people.\nInstead, we find a whole zoology of long tails ranging from beautiful power-\nlaws to log-linear curves, with less clean, bumpier distributions in between.\n\nNearly all IN and OUT distribution pairs appear to be asymmetric. Birth Dates,\nfor example, are connected to Persons in a 1:n manner, where n is highly\nheterogeneous. This is no surprise, as this area of information is not subject\nto the multiplicity of opinion, as we would expect in a prosopographic\ndatabase, which would focus on people instead of objects. Other areas, such as\nthe occurrence of Locations in Provenance Events, exhibit a quasi 1:n\nconstraint, as it is highly improbable but not impossible for an event to\ninvolve more than one location. The most interesting asymmetry is found in\ntrue n:n relations, such as the central Monument-Documentation link, where we\nfind distributions with different slopes on both sides of the link. Right now,\nit is not entirely clear how this asymmetry can be fully explained; however,\nby comparing a number of data sources, it becomes apparent that the different\nshapes of these distributions are caused by a variety of factors, such as\nphysical restrictions and accessibility of the source data, as well as\nattention and other cognitive limits on the side of the curators.\n\nThe only symmetric link relationship in the CENSUS can be found in the\nparallel copy and parallel replica links in the Document-Document and\nMonument-Monument cells, respectively. Ideally, the IN- and OUT-degree\ndistributions should be identical, as the relevant nodes are fully connected\nto so-called “cliques.” In reality, both link types become more asymmetric the\nfurther down we go into the tail of the distributions, as large cliques are\nhard to maintain. As I recommended to the CENSUS project in 2003, it makes\nmore sense to connect to an unknown archetype Document with n links than to\nmanually connect n parallel copies with n * (n–1) links amongst each other.\n\nSimilarly, the behavior of certain relationships that we spotted in Figure\n14-7, such as the equivalence of Monument-Bibliography and Monument-\nDocumentation, is confirmed in Figure 14-8 (cf. Schich and Barabási 2009). Not\nonly is there an obvious similarity between these cells, but the same\nfunctional equivalence is found in different link types in a single cell. A\nconvincing example are the almost parallel distribution slopes of general\ndocumentation and 1st Renaissance documentation in the Document-Monument cell;\nthe same is true for provenance and preservation documentation in the Event-\nDocumentation cell. The Location IN degree scales in a very similar way across\nall relevant cells in the Location column. Two exceptions to this observed\nregularity are the steep drop of probability from one to two Monuments per\nLocation (due to the many untraced Monuments) and the accelerating tail in the\nLocation-Location cell (caused by the romunculus phenomenon).\n\nOne last thing we can observe in all the plots is the fraction of nodes per\nnode type, which are inherent in the individual networks constituted by each\nindividual link type. Looking at the value where the respective curve crosses\nthe y-axis shows us, for example, that less than 15% of all Images are\nconnected to Monuments, and less than 40% to Documents. Inversely, we can\nconclude that at least 45% of the 24,000 images scanned by the CENSUS\nproject’s publishing partner in 1994 were still not linked in the database in\n2005.\n\nFurther Applications\n\nThe visualizations presented here can serve as a starting point for a variety\nof activities. Besides the evaluation of particular project goals by funders\nand project leaders, further areas of study include the identification of\ninteresting research topics: every single cell in the matrix could be the\nsubject of an extensive investigation, as illustrated in my PhD dissertation,\nwhich deals with monument documentation and visual document citation (Schich\n2009). Multiple cells that promise an interesting interplay could also be\ncombined within such a study—for example, in order to build trajectories of\nobjects and persons involved in a variety of events across time and space (cf.\nGonzález, Hidalgo, and Barabási 2008), or to study the effects of network\ninteraction (Leicht and D’Souza 2009). Finally, a number of equivalent\nvisualizations could be used to compare entire databases that already use\nsimilar data models, such as the Winckelmann Corpus and the CENSUS, or\ndatabases that can be mapped to the same standard, such as the CIDOC CRM.\n\nInstead of dissecting the databases in the way discussed here, it might also\nbe interesting to combine separate networks in a similar visualization.\nCandidates for such a combination can easily be found in the multipartite\nuniverse of conceivable networks (for example, citation, coauthorship, and\nimage-tagging databases in the social sciences, or gene-transcription,\nprotein-protein interaction, and gene-disease databases in biology).\n\nThe coarse graining we obtained by collapsing the Document, Monument, and\nBibliography trees can also be achieved in many other ways; for example, by\nconcentrating on particular subtrees, or with more sophisticated methods such\nas blockmodelling (cf. Wassermann and Faust 1999, pp. 394–424) or community\nfinding (cf. Lancichinetti and Fortunato 2009; Ahn, Bagrow, and Lehmann 2009),\npractically addressing the question of how nodes and links in a network are\nactually defined (cf. Butts 2009).\n\nFinally, the presented combination of matrix and node-link diagrams can be\nexpanded; for example, by placing node-link/matrix combinations (Henry,\nFekete, and McGuffin 2007) or scalable image matrices (Schich, Lehmann, and\nPark 2008) in relevant cells of the data model matrix.\n\nConclusion\n\nAs this chapter has illustrated, enriched and refined data model matrices are\nvery useful for database project evaluation, exposing many nonintuitive data\nproperties that are hard to uncover by simply using the database or looking at\nthe commonly used indicators of quality. As data becomes more accessible in\nthe form of Linked Data, RDF graphs, or open dumps of relational tables, the\npresented methods can be applied by funders or the projects themselves, within\na very short time frame in a mostly automated process.\n\nThe visualizations shown here present the first comprehensive big picture of\nthe entire CENSUS database, where we can see the initial data model definition\nas well as the emerging complex structure in the collected data. By looking at\nthe visualizations, we found out that many of the numbers given in the project\ndescription were incomplete or even misleading. Some of the new numbers may be\nsmaller than the initially presented ones, but as we have learned from our\nanalysis, sometimes a little less is more—and more is different (Anderson\n1972).\n\nAcknowledgments\n\nFor their useful feedback, I would like to thank my audiences at NetSci09 in\nVenice and SciFoo09 in Mountain View, as well as my colleagues at the\nBarabásiLab at Northeastern University in Boston. Further thanks go to Ralf\nBiering and Vinzenz Brinkmann of Stiftung Archäologie in Munich for providing\nthe data and the German Research Foundation (DFG) for funding my research. For\na comprehensive bibliography regarding the CENSUS database see Schich 2009, p.\n13, notes 20–25.\n\nReferences\n\nThe presented visualizations are available online in large resolution at  \n<http://revealingmatrices.schich.info>.\n\nAhn, Yong-Yeol, James P. Bagrow, and Sune Lehmann. 2009. “Link communities\nreveal multi-scale complexity in networks.”\n<http://arxiv.org/abs/0903.3178v2>.\n\nAldroandi, Ulisse. 1556/1562. “Appresso tutte le statue antiche, che in Roma\nin diversi luoghi, e case particolari si veggono, raccolte e descritte (...)\nin questa quarta impressione ricorretta.” Le antichità della città di Roma.\nEd. Lucio Mauro. Venice.\n\nAnderson, Chris. 2006. The Long Tail. New York: Hyperion.\n<http://www.thelongtail.com>.\n\nAnderson, P.W. 1972. “More is different.” Science 177, no. 4047: 393–396.\n\nBartsch, Adam. 1854–1870. Le Peintre-Graveur, nouvelle edition. v. 1–21.\nLeipzig: Barth.\n\nBartsch, Tatjana. 2008. “Distinctae per locos schedulae non agglutinatae” –\nDas Census-Datenmodell und seine Vorgänger. Pegasus 10: 223–260.\n\nBertin, Jaques. 1981. Graphics and Graphic Information Processing. Berlin: de\nGruyter.\n\nBertin, Jacques. 2001. “Matrix theory of graphics.” Information Design Journal\n10, no. 1: 5–19. doi: 10.1075/idj.10.1.04ber.\n\nBizer, Christian, Tom Heath, and Tim Berners-Lee. 2009. “Linked data—The story\nso Far.” International Journal on Semantic Web & Information Systems 5, no. 3:\n1–22.\n\nBroder, Andrei, Ravi Kumar, Farzin Maghoul, Prabhakar Raghavan, Sridhar\nRajagopalan, Raymie Stata, Andrew Tomkins, and Janet Wiener. 2000. “Graph\nstructure in the Web.” Computer Networks 33, no. 1–6:\n309–319.doi:10.1016/j.physletb.2003.10.071.\n\nButts, Carter. 2009. “Revisiting the foundations of network analysis.” Science\n325, no. 5939: 414–416. doi: 10.1126/science.1171022.\n\nCENSUS. 1997–2005. Census of Antique Works of Art and Architecture Known in\nthe Renaissance. Ed. A. Nesselrath. Munich: Verlag Biering &\nBrinkmann/Stiftung Archäologie. <http://www.dyabola.de>.\n\nCENSUS BBAW. 2006. Census of Antique Works of Art and Architecture Known in\nthe Renaissance. Ed. Berlin-Brandenburgische Akademie der Wissenschaften and\nHumboldt-Universität zu Berlin. <http://www.census.de>.\n\nChakrabarti, Suomen. 2003. Mining the Web: Discovering Knowledge from\nHypertext Data. San Francisco, CA: Morgan Kaufmann.\n\nChen, Peter P.S. 1976. “The entity-relationship model—Toward a unified view of\ndata.” ACM Transactions on Database Systems 1, no.1: 1–36. doi:\n10.1145/320434.320440.\n\nChua, Leon O. 2005. “Local activity is the origin of complexity.”\nInternational Journal of Bifurcation and Chaos 15: 3435–3456. doi:\n10.1142/S0218127405014337.\n\nCrofts, Nick, Martin Doerr, Tony Gill, Stephen Stead, and Matthew Stiff, eds.\n2006. Definition of the CIDOC Conceptual Reference Model (CIDOC-CRM), Version\n4.2.1. <http://www.cidoc-crm.org/docs/cidoc_crm_version_4.2.1.pdf>.\n\nDawkins, Richard. 2005. The Ancestor’s Tale. A Pilgrimage to the Dawn of Life.\nLondon: Phoenix.\n\nDBpedia. 2009. DBpedia. Sören Auer, Christian Bizer, and Kingsley Idehen,\nadmins. Leipzig: Universität Leipizig; Berlin: Freie Universität Berlin;\nBurlington, MA: OpenLink Software. <http://dbpedia.org>.\n\nDoreian, P., V. Batagelj, and A. Ferligoj. 2005. Generalized Blockmodeling\n(Structural Analysis in the Social Sciences). Cambridge: Cambridge University\nPress.\n\nFlybase. 2008. Rachel Drysdale and the FlyBase Consortium. FlyBase.\nDrosophila: 45–59. doi: 10.1007/978-1-59745-583-1_3. See also\n<http://flybase.org/static_pages/docs/release_notes.html>.\n\nFreebase. 2009. Freebase. San Francisco, CA: Metaweb Technologies.\n<http://www.freebase.com>. For data dumps, see\n<http://download.freebase.com/datadumps/>.\n\nGarner, Ralph. 1963. “A computer-oriented graph theoretic analysis of citation\nindex structures.” In Three Drexel Information Science Research Studies, ed.\nBarbara Flood. Philadelphia, PA: Drexel Press.\n\nGonzález, Marta C., César A. Hidalgo, and Albert-László Barabási. 2008.\n“Understanding individual human mobility patterns.” Nature 453: 779–782. doi:\n10.1038/nature06958.\n\nHenry, Nathalie, J-D. Fekete, and M. McGuffin. 2007. “NodeTrix: A hybrid\nvisualization of social networks.” IEEE Transactions on Visualization and\nComputer Graphics 13, no. 6: 1302–1309.\n\nHenry, Nathalie. 2008. “Exploring large social networks with matrix-based\nrepresentations.” PhD diss., Cotutelle Université Paris-Sud and University of\nSydney. <http://research.microsoft.com/en-\nus/um/people/nath/docs/Henry_thesis_oct08.pdf>.\n\nLagoze, Carl, Herbert Van de Sompel, Michael Nelson, and Siemeon Warner. 2008.\nThe Open Archives Initiative Protocol for Metadata Harvesting. Protocol\nVersion 2.0 of 2002-06-14.\n<http://www.openarchives.org/OAI/2.0/openarchivesprotocol.htm>.\n\nLancichinetti, A., and S. Fortunato. 2009. “Community detection algorithms: A\ncomparative analysis.” Physical Review E 80, no. 5, id. 056117. doi:\n10.1103/PhysRevE.80.056117.\n\nLeicht, E.A., and Raissa M. D’Souza. 2009. “Percolation on interacting\nnetworks.” arXiv 0907.0894v1, <http://arxiv.org/abs/0907.0894v1>.\n\nMilo, R., S. Shen-Orr, S. Itzkovitz, N. Kashtan, D. Chklovskii, and U. Alon.\n2002. “Network motifs: Simple building blocks of complex networks.” Science\n298, no. 5594: 824–827.\n\nNesselrath, Arnold. 1993. “Die Erstellung einer wissenschaftlichen Datenbank\nzum Nachleben der Antike: Der Census of Ancient Works of Art Known to the\nRenaissance.” Habilitation thesis, Universität Mainz. Available at the CENSUS\noffice at HU-Berlin.\n\nNewman, Mark E.J. 2005. “Power laws, Pareto distributions and Zipf’s law.”\nContemporary Physics 46: 323–351. doi:10.1080/00107510500052444.\n\nNewman, Mark E.J., Albert-László Barabási, and Duncan J. Watts, eds. 2006. The\nStructure and Dynamics of Networks. Princeton, NJ: Princeton University Press.\n\nPenfield, W., and T. Rasmussen. 1950. The Cerebral Cortex of Man: A Clinical\nStudy of Localization of Function. New York: Macmillan.\n\nPhosphosite. 2003–2007. PhosphoSitePlus™, A Protein Modification Resource.\nDanvers, MA: Cell Signaling Technology. <http://www.phosphosite.org>.\n\nPietriga, Emmanuel, Christian Bizer, David Karger, and Ryan Lee. 2006.\n“Fresnel—A browser-independent presentation vocabulary for RDF.” In The\nSemantic Web—ISWC 2006, vol. 4273, Chapter 12. Eds. I.Cruz, S.Decker,\nD.Allemang, C.Preist, D.Schwabe, P.Mika, M.Uschold, and L.M. Aroyo. Berlin,\nHeidelberg: Springer Berlin Heidelberg.\n\nSaxl, Fritz. 1957. “Continuity and variation in the meaning of images.”\nLecture at Reading University, October 1947. In Lectures. London: Warburg\nInstitute.\n\nSchich, Maximilian. 2009. “Rezeption und Tradierung als komplexes Netzwerk.\nDer CENSUS und visuelle Dokumente zu den Thermen in Rom.” Ph.D. diss.,\nHumboldt-Universität zu Berlin. Munich: Verlag Biering & Brinkmann.  \nurn:nbn:de:bsz:16-artdok-7002.\n\nSchich, Maximilian, and Albert-László Barabási. 2009. “Human activity—from the\nRenaissance to the 21st century.” In Cultures of Change. Social Atoms and\nElectronic Lives. Exhibition Catalogue: Arts Santa Mònica, Barcelona, 11\nDecember 2009 to 28 February 2010. Gennaro Ascione, Cinta Massip, and Josep\nPerelló eds. Barcelona: Arts Santa Monica. urn:nbn:de:bsz:16-artdok-9582.\n\nSchich, Maximilian, and Sybille Ebert-Schifferer. 2009. “Bildkonstruktionen\nbei Annibale Carracci und Caravaggio: Analyse von kunstwissenschaftlichen\nDatenbanken mit Hilfe skalierbarer Bildmatrizen.” Project report. Rome:\nBibliotheca Hertziana (Max-Planck-Institute for Art History).\nurn:nbn:de:bsz:16-artdok-7121.\n\nSchich, Maximilian, César Hidalgo, Sune Lehmann, and Juyong Park. 2009. “The\nnetwork of subject co-popularity in classical archaeology.”\nurn:nbn:de:bsz:16-artdok-7151.\n\nSchich, Maximilian, Sune Lehmann, and Juyong Park. 2008. “Dissecting the\ncanon: Visual subject co-popularity networks in art research.” 5th European\nConference on Complex Systems, Jerusalem (online material).\nurn:nbn:de:bsz:16-artdok-7111.\n\nScience. 2009. Special Issue on Complex Systems and Networks. Science 325, no.\n5939: 357–504. <http://www.sciencemag.org/content/vol325/issue5939/#special-\nissue>.\n\nSegaran, Toby. 2009. “Connecting data.” In [Beautiful\nData](http://oreilly.com/catalog/9780596157111/). Sebastopol, CA: O’Reilly\nMedia.\n\nShannon, Paul, Andrew Markiel, Owen Ozier, Nitin S. Baliga, Jonathan T. Wang,\nDaniel Ramage, Nada Amin, Benno Schwikowski, and Trey Ideker. 2003.\n“Cytoscape: A software environment for integrated models of biomolecular\ninteraction networks.” Genome Research 13, no. 11: 2498–2504. doi:\n10.1101/gr.1239303.  \nSee also <http://www.cytoscape.org>.\n\nSullivan, Danny. 2005. “Search engine sizes.” Search Engine Watch.\n<http://searchenginewatch.com/2156481>.\n\nWassermann, Stanley, and Katherine Faust. 1999. Social Network Analysis:\nMethods and Applications, Fourth Edition. Cambridge: Cambridge University\nPress.\n\nWikipedia. “Wikipedia: Size comparisons.”\n<http://en.wikipedia.org/wiki/Wikipedia:Size_comparisons>.\n\nWinckelmann Corpus. 2000. Corpus der antiken Denkmäler, die J.J. Winckelmann\nund seine Zeit kannten. Winckelmann-Gesellschaft Stendal, ed. DVD and online\ndatabase. Munich: Verlag Biering & Brinkmann/Stiftung Archäologie.\n\n[1] From <http://www.census.de>, retrieved 9/14/2009.\n\n\nChapter Fifteen\n\nThis Was 1994:  \nData Exploration with the NYTimes Article Search API\n\nJer Thorp\n\nIn February of last year, the New York Times announced that it was giving away\nthe keys to 28 years of data—news stories, movie reviews, obituaries, and\npolitical statistics, all for free. Staring at such a huge pile of\ninformation—about 2.6 million articles—we’re faced with three important\nquestions. How do we get the data we need? What can we do with that data? And,\nperhaps most importantly, why should we bother in the first place? In this\nchapter, I’ll try to answer those questions. We’ll see how to access\ninformation from the NYTimes Article Search API\n(<http://developer.nytimes.com/docs/article_search_api>), look at some\npractical visualization examples, and discuss how the new era of open data is\nopening doors for artists, entrepreneurs, designers, and social scientists.\n\nGetting Data: The Article Search API\n\n“API” is one of those three-letter acronyms that means very little as a\ncollection of three letters, and even less once you find out what it stands\nfor: application programming interface. While this rather generic term can be\napplied to all kinds of things within the world of software development, an\nAPI typically exists to allow one piece of software to talk to another. If we\nimagine a database as a physical warehouse that stores information, an API is\nthe shipping and receiving department, and it’s open to the public.\n\nIn general, interaction with an API is fairly straightforward. We send the API\na request (which can be quite simple or very complex), and the API sends us\nback a formatted set of information. The syntax that we use to communicate\nwith an API and the format the API uses to hand the requested information back\nto us varies from API to API. Some APIs are quite limited, whereas others\nunlock all kinds of useful functions. Luckily for us, the NYTimes Article\nSearch API is one of the most robust and well-constructed APIs around.\n\nSo what can we ask it? With a few simple requests, the API can answer any of\nthe following questions, and a nearly infinite number more:\n\n  * How many articles were published in 1982? \n  * What organization is mentioned most in articles about fraud? \n  * How many times was the word “hypercolor” used in fashion articles in 1991? \n\nLet’s start with an easy question: how many articles in 1994 mentioned O.J.\nSimpson?\n\nThere are a few different ways to send our question to the API, but all of\nthem involve sending an HTTP request to a specific URL, with some parameters\nadded to the mix. Here’s the simplest request:\n\nhttp://api.nytimes.com/svc/search/v1/article?query=O.J.+Simpson\n\nThis request will give us all of the articles in the database (articles are\nstored from 1981 to the present) that contain the string “O.J. Simpson”. To\nrestrict it to 1994, we can add a couple of “extras” to the query:\n\nhttp://api.nytimes.com/svc/search/v1/article?query=O.J.+Simpson&begin_date=19940101&end_date=19950101\n\nFinally, the API needs to keep track of who is accessing the information and\nto ensure that no users are overrunning the published limits. Consequently,\nevery time we access the API we must pass along our API key, a string of\ncharacters assigned by the NYTimes that is unique to each individual user:[1]\n\nhttp://api.nytimes.com/svc/search/v1/article?query=O.J.+Simpson&begin_date=19940101&end_date=19950101&api-\nkey=1af81d#######################:##:########\n\nIf you go ahead and paste this request into your browser’s address bar\n(inserting your own API key in place of the # signs), you’ll get some results;\nview the source to see the actual data returned by the API. The data is\nreturned to us packaged in a format called JSON, which we will discuss in more\ndetail later in this chapter.\n\nAt the bottom of this chunk of data, we can find the answer to our question:\n2,218.\n\nWe’re going to wrap all of this up in some fancy packaging, but these requests\nare the root of everything we’re going to do in this chapter. Any request to\nthe Article Search API is constructed the same general way (see Figure 15-1):\n\nURL Base + Query + Facets + Extras + API Key\n\n![bvis_1501.png](images/bvis_1501.png)\n\nFigure 15-1. Requests to the New York Times Article Search API are always\nstructured from the same key parts\n\nSome of these elements are required (Query, API Key), and some are optional\n(Extras, Facets). However, the basic structure never changes, and neither does\nthe basic approach: ask the API a question, and get an answer. What we really\nwant to do, though, is ask the API lots of questions and get lots of answers.\nTo do that, we need to have a better system than copying and pasting into a\nweb browser.\n\nManaging Data: Using Processing\n\nIn the 1990s, American artist Mark Lombardi created a series of hugely complex\ndrawings (which he called narrative structures) exposing connections between\npeople and corporations involved in political and financial frauds. Lombardi\nwould meticulously comb through newspaper articles and magazines, recording\nhis findings by hand. He had neither an API to pose his questions to, nor any\nkind of database or software to store his answers in. Instead, Lombardi\namassed a collection of more than 14,000 index cards, on which all of his\nquestions and answers were written and from which he drew his historical\ndiagrams (see [Figure 10-1](bv_ch10.xhtml#anchor-56-anchor) in Chapter 10).\n\nUnless you happen to have a few thousand index cards and a few weeks of spare\ntime handy, we’re going to need to think of a faster way to manage all of our\nquestions and answers. There are a number of different ways we could approach\nthis on a computer, and a variety of different software tools and programming\nlanguages that would be up to the task. I use a language called Processing to\nwork with data, so that’s what we’ll be using in our examples. Processing is a\nfree download, and it’s relatively easy to use. I’m going to assume in this\nchapter that you have already downloaded and installed Processing (if you need\nhelp with this, visit <http://www.processing.org>).\n\nIn the last section I showed how we can make requests to the Article Search\nAPI and get answers back in JSON format. We’re going to use Processing to\nmanage our requests, parse and store our answers, and display the results\nonscreen. The most complicated part of this process involves dealing with the\nJSON return. Rather than dedicating a few thousand words to showing you how to\nbuild your own engine to handle this, we’ll use some Processing code that I’ve\nwritten to make the process a lot easier. I’ve wrapped up a lot of the key\nfunctionality that we’ll need to deal with the Article Search API into a\nlibrary, which you can download from\n<http://www.blprnt.com/libraries/nytimes>.\n\nInstalling libraries in Processing is straightforward—simply drag the unzipped\nfolder into the libraries directory in your sketchbook (again, if you need\nhelp with this, check out <http://www.processing.org>). If you are interested\nin the guts of these libraries, the project is open source—a bit of Googling\nwill point you in the right direction. For now, though, all you need to know\nis that you can take advantage of their functionality to do some useful\nthings. To get started, let’s take a look at how we can ask our O.J. question\nusing the new libraries.\n\nFirst, we import the NYTArticleSearch libraries from the Sketch®Import Library\ndrop-down menu. Then we set the size of our stage and give it a nice clean\nwhite background:\n\nimport blprnt.nytimes.*;\n\nsize(800,350);\n\nbackground(255);\n\nNow we’re ready to initialize the libraries with our API key:\n\nTimesEngine.init(this, \"YOUR-API-KEY-GOES-HERE\");\n\nNext, we’ll create a TimesArticleSearch object to manage our questions\n(queries) and answers (responses):\n\nTimesArticleSearch mySearch = new TimesArticleSearch();\n\nThis simple little object allows us to do pretty much anything we need to do\nwith the Article Search API. Let’s get a response for a similar query to our\n1994 example, this time asking for results from both 1994 and 1995:\n\nmySearch.addQueries(\"O.J.+Simpson\");\n\nmySearch.addExtra(\"begin_date\",\"19940101\");\n\nmySearch.addExtra(\"end_date\",\"19960101\");\n\nTimesArticleSearchResult r = mySearch.doSearch();\n\nprintln(\"RESULTS ABOUT O.J.:\" + r.total);\n\nThis may seem more complex than our first example, in which we sent a single\nhttp request, but here we don’t have to deal with the JSON, and we also have a\nlot of freedom in how we can customize our search. The Article Search API\ngives us a wealth of options for structuring search requests, allowing us to\nmake both very specific and very general requests.\n\nLet’s consider our search for a moment. We are asking the API to find any\narticles published in 1994 and 1995 that contain the string of characters\n“O.J. Simpson”. What about articles that talk about Orenthal James Simpson? Or\njust O.J.? Or “The Juice”? One of the most powerful things about the Article\nSearch API is that it ties into the editorial structure of the New York Times.\nWhen an article is published by the Times, it is indexed with a set of\neditorial information. This information, added by humans and standardized, is\navailable to the API and makes searching a lot more effective. In our case,\nrather than looking for the phrase “O.J. Simpson”, we can instead look for\narticles labeled with the proper person facet for O.J. Simpson (which is\n“SIMPSON, O J”). The editorial staff will have added this facet to any article\nthat mentions or references O.J., no matter what name is used in the article\nbody. Our search, then, looks like this:\n\nimport blprnt.nytimes.*;\n\nsize(800,350);\n\nbackground(255);\n\nTimesEngine.init(this, \"YOUR-API-KEY-GOES-HERE\");\n\nTimesArticleSearch mySearch = new TimesArticleSearch(\"YOUR-API-KEY-GOES-\nHERE\");\n\nmySearch.addFacetQueries(\"per_facet\",\"SIMPSON, O J\");\n\nmySearch.addExtra(\"begin_date\",\"19940101\");\n\nmySearch.addExtra(\"end_date\",\"19960101\");\n\nTimesArticleSearchResult r = mySearch.doSearch();\n\nprintln(\"RESULTS ABOUT O.J.:\" + r.total);\n\nThe only tricky part in using facets is finding out which facets are available\nand what their standard “names” are. An easy way to access this information is\nto use the NYTimes API Request Tool, located at\n<http://prototype.nytimes.com/gst/apitool/index.html>. This tool lets you test\nout search queries and see the results, all without any fussy code or the need\nfor an API key. To get the proper per_facet for O.J., we can enter “O.J\nSimpson” into the Search Query field and “per_facet” in the Facet Query field,\nas shown in Figure 15-2.\n\n![bvis_1502.png](images/bvis_1502.png)\n\nFigure 15-2. The API Request Tool can be used to find official Times facets\nfor people, topics, and places\n\nOf course, there was more going on in 1994 and 1995 than white Ford Broncos\nand ill-fitting gloves. Using the API Tool, we can gather the correct facets\nfor some other events in that time period, like the end of apartheid in South\nAfrica (geo_facet=SOUTH AFRICA) and the genocide in Rwanda (geo_facet=RWANDA).\nWe can construct a new TimesArticleSearch object for each of those searches,\nor reuse the same one by clearing the facet queries each time. This second\noption makes the most sense, so let’s give it a try:\n\nimport blprnt.nytimes.*;\n\nsize(800,350);\n\nbackground(255);\n\nTimesEngine.init(this, \"YOUR-API-KEY-GOES-HERE\");\n\nTimesArticleSearch mySearch = new TimesArticleSearch();\n\n// OJ search\n\nmySearch.addFacetQuery(\"per_facet\",\"SIMPSON, O J\");\n\nmySearch.addExtra(\"begin_date\",\"19940101\");\n\nmySearch.addExtra(\"end_date\",\"19960101\");\n\nTimesArticleSearchResult r1 = mySearch.doSearch();\n\nprintln(\"OJ:\" + r1.total\n\n// South Africa search\n\nmySearch.clearFacetQueries();\n\nmySearch.addFacetQuery(\"geo_facet\",\"SOUTH AFRICA\");\n\nTimesArticleSearchResult r2 = mySearch.doSearch();\n\nprintln(\"South Africa:\" + r2.total);\n\n// Rwanda search\n\nmySearch.clearFacetQueries();\n\nmySearch.addFacetQuery(\"geo_facet\",\"RWANDA\");\n\nTimesArticleSearchResult r3 = mySearch.doSearch();\n\nprintln(\"Rwanda:\" + r3.total);\n\nThis leaves us with three TimesArticleSearchResult objects, which contain the\ntotal number of articles returned for each result (we’ll see later that these\nobjects can also hold other useful information). It seems like the right time\nto do some (very) simple visualization with this data. Bar graph, anyone? (See\nFigure 15-3.)\n\n// O.J. bar\n\nfill(255,0,0);\n\nrect(0,50,r1.total,50);\n\n// South Africa bar\n\nfill(0,255,0);\n\nrect(0,150,r2.total,50);\n\n// Rwanda bar\n\nfill(0,0,255);\n\nrect(0,250,r3.total,50);\n\n![bvis_1503.png](images/bvis_1503.png)\n\nFigure 15-3. Simple graph comparing the frequency of mentions of O.J. (in\nred), South Africa (in green), and Rwanda (blue) in the New York Times in 1994\nand 1995\n\nOK. I’ll admit it. This isn’t the most exciting visualization ever. However,\nit embodies almost all of the concepts that we’ll need to learn to start\nmaking visual exploration forays into the huge and treasure-filled NYTimes\nArticle Search database. It also provides a very, very simple model for the\nthree-step process that I follow when making even the most complex data\nvisualizations.\n\nThree Easy Steps\n\nLet’s take a short break from tutorializing and think about the basic process\ninvolved in a visualization project:\n\n1\\. Get some data.\n\n2\\. Convert the data into useful structures.\n\n3\\. Visualize the data.\n\nOften, this simple procedure is repeated twice during a project: once during\ndiscovery and once during production. In the research phase, where the\nchallenge is to dig through a set of data and find something useful or\ninteresting, the “getting data” stage might be repeated many times, while the\nvisualization stage might be kept as simple as possible. In contrast, a\nproduction cycle typically occurs once the data has been identified. This\nmeans we spend very little time getting data (since we already have it) and\nmuch more time in the visualization stage.\n\nShared in both research and production cycles is step 2: converting the data\ninto useful structures. What are these structures? What makes them useful? For\nme, this process usually means packaging up individual pieces of data into\nobjects (programming structures that let me store related information\ntogether). It also typically involves filing these objects into some kind of\ncollection—i.e., a list or a grouping that makes sorting and retrieving the\ndata easy.\n\nIn our O.J. example, a lot of this process was handled by the NYTimes\nProcessing libraries that we imported at the very beginning of our sketch. We\ncan see objects being created every time we perform a search. We make a\nTimesArticleSearch object to manage the request to the API:\n\nTimesArticleSearch mySearch = new TimesArticleSearch();\n\nand a TimesArticleSearchResult object to store the response from the API:\n\nTimesArticleSearchResult r1 = mySearch.doSearch();\n\nThese unassuming TimesArticleSearchResult (TASR) objects hold a pile of\nrelated information about each search result. So far all we’ve done is to\naccess the total number of results received, a property stored in each result\nobject as an integer called total:\n\nprintln(\"RESULTS ABOUT O.J.:\" + r.total);\n\nThe TASR object holds much more than that, though! Indeed, for each of the 713\narticles marked with the O.J. facet published by the New York Times in\n1994/1995, we can access the headlines, authors, URLs, excerpts, and more—all\nfrom our little TASR. These individual pieces of data are stored inside each\nTASR as TimesArticleObjects, neatly lined up in an array called articles. By\ndefault, the TASR holds the first 10 search results. If we wanted to get the\nauthor of the first article in the list, we could do this:\n\nprintln(\"FIRST HEADLINE:\" + r.articles[0].title);\n\nOr, to get the web URL for the 10th article:\n\nprintln(\"100th ARTICLE URL:\" + r.articles[9].url);\n\nOr for a list of headlines for each article:\n\nfor (int i = 0; i < r.articles.length; i++) {\n\nprintln(\"AUTHOR #\" + i + \": \" + r.articles[i].author);\n\n};\n\nHere, we are starting to see the tip of the data iceberg that the Article\nSearch API puts at our fingertips. So far, we’ve done three fairly rudimentary\nsearches and ended up with about 2,000 article results, packaged in a few\nhandy TASRs. Now that we know how to access (at least part of) the results of\na search, let’s look at some ways to make the searches and results a bit\nsmarter.\n\nFaceted Searching\n\nIn our examples so far, we’ve seen how we can search with facets to make sure\nthat we are getting the results we want. What I haven’t mentioned up to now is\nthat facets can also be included in the results of our searches. With facet\nresults, we can find out much more from individual searches, and we can also\nuncover relationships between facets (people, countries, topics) that are\ncontained within the article database.\n\nLet’s start with a simple but very useful example of how we can use facet\nresults to optimize our searching. We found out in an earlier example that\nthere were 488 article results labeled with the Rwanda geo_facet in 1994 and\n1995. What if we wanted to break this down further and find out how many\narticles were published in each individual month of 1994? It would be\npossible, using the same method that we have already demonstrated, to do 12\nindividual searches: one for each month. For each of these searches, we could\nuse different values for our begin_date and end_date extras to make sure they\nreturn the results for the appropriate months. But that seems like a lot of\nwork, doesn’t it?\n\nAs you may have suspected by now, a better version of this search can be\nexecuted using facet results. In fact, we can do just one search and get the\nresults we want. We start by building the search in the same way we did in our\nprevious example:\n\nTimesArticleSearch mySearch = new TimesArticleSearch();\n\nmySearch.addFacetQuery(\"geo_facet\",\"RWANDA\");\n\nRather than using the begin/end_date extras to constrain the search to 1994,\nthough, this time we’ll use the publication_year facet:\n\nmySearch.addFacetQuery(\"publication_year\",\"1994\");\n\nAnd now, the magic bit. Along with the usual search return (a giant list of\narticles), we’ll ask the API to return us some facets—in this case,\npublication_year facets:\n\nmySearch.addFacets(\"publication_month\");\n\nWhen we run our search, the facet results will be packaged up along with all\nof our other data into our TASR:\n\nTimesArticleSearchResult r = mySearch.doSearch();\n\nTo access the publication_month results from the TASR, we ask it for an array\nof TimesFacetObjects related to the particular facet we’re interested in\n(TASRs can contain any number of different facet results):\n\nTimesFacetObject[] months = r.getFacetList(\"publication_month\");\n\nNow we can find out how many results were from, say, January (1994):\n\nprintln(\"January results: \" + months[0].count);\n\nWe can also graph the whole year’s worth of results (Figure 15-4):\n\nfor (int i = 0; i < 12; i++) {\n\nfill(random(150,255),0,0);\n\nfloat w = width/12;\n\nrect(i * w, height, w, -months[i].count * 3);\n\n};\n\n![bvis_1504.png](images/bvis_1504.png)\n\nFigure 15-4. Monthly frequency of mentions of Rwanda in the New York Times in\n1994\n\nOn the face of it, we have a really simple program to find mentions of Rwanda\nduring a single year. But this little sketch is actually far more expandable\nthan that. It can graph mentions of any faceted term in any year from 1981 to\nthe present. It wouldn’t be much of a stretch to make a more robust graphing\ntool from this simple code. While I’d love to go over this process in detail\nhere, I’ve saved us all a bit of time and a lot of pages by building the\nsketch for you. You can find a link to download the NYTimes GraphMaker at\n<http://www.blprnt.com/examples/nytimes>.\n\nAs useful as this kind of exploration can be, we have so far limited ourselves\nto discrete searches within the article database. Things get even more\ninteresting when we start to use the API to explore connections among people,\nplaces, and subjects.\n\nMaking Connections\n\nWhen we make any search request to the Article Search API, we can ask it to\nreturn us a list of facets that were mentioned alongside our search term in\nthe articles that the API has found. For example, we could find out which\ncountries were mentioned alongside Rwanda, or which people were talked about\nin articles about O.J., or which topics were most often associated with\nwriting about the end of apartheid in South Africa.\n\nWe can also make more general requests. By omitting a search term altogether\nbut specifying a time frame, we can request all articles for that time period.\nIf we ask for lists of facets along with these articles, we can find out what\nthe top facets were for a given month, year, or decade. For example, let’s\nfind out who were the top personalities mentioned in 1994. First, we’ll create\na search object and give it an empty query (we use a + sign in place of an\nempty space):\n\nTimesArticleSearch mySearch = new TimesArticleSearch();\n\nmySearch.addQueries(\"+\");\n\nNow, let’s restrict the search to 1994 and ask the search object to include\nthe per_facet in its results:\n\nmySearch.addFacetQuery(\"publication_year\", \"1994\");\n\nmySearch.addFacets(\"per_facet\");\n\nand perform the search:\n\nTimesArticleSearchResult r = mySearch.doSearch();\n\nIf we wanted to list the top personalities mentioned in 1994, we could now do\nit like this:\n\nTimesFacetObject[] stars = r.getFacetList(\"per_facet\");\n\nfor (int i = 0; i < stars.length; i++) {\n\nprintln(stars[i].term);\n\n};\n\nwhich outputs this rather mixed group of names:\n\nCLINTON, BILL\n\nGIULIANI, RUDOLPH W\n\nCUOMO, MARIO M\n\nCLINTON, HILLARY RODHAM\n\nPATAKI, GEORGE E\n\nSIMPSON, O J\n\nSIMPSON, NICOLE BROWN\n\nKERRIGAN, NANCY\n\nGINGRICH, NEWT\n\nRABIN, YITZHAK\n\nCORTINES, RAMON C\n\nARAFAT, YASIR\n\nRENO, JANET\n\nWHITMAN, CHRISTINE TODD\n\nBERLUSCONI, SILVIO\n\nThis list reminds us of something about the New York Times: it is at the same\ntime a city paper, a national paper, and an international paper. With this in\nmind, it may be less strange that we see then–Prime Minister of Israel Yitzhak\nRabin (who won the Nobel Peace Prize in 1994) mentioned just slightly more\noften than Ramon Cortines, the Schools Chancellor of New York City. While we\nmay be happy with this broad reach, we might also want to restrict our\nsearches to a certain “version” of the paper. We can do this by again using a\nfacet—this time we’ll ask for articles only published from the Foreign Desk by\nusing the desk_facet:\n\nmySearch.addQueries(\"+\");\n\nmySearch.addFacetQuery(\"publication_year\", \"1994\");\n\nmySearch.addFacetQuery(\"desk_facet\",\"Foreign Desk\");\n\nmySearch.addFacets(\"per_facet\");\n\nTimesArticleSearchResult r = mySearch.doSearch();\n\nTimesFacetObject[] stars = r.getFacetList(\"per_facet\");\n\nfor (int i = 0; i < stars.length; i++) {\n\nprintln(stars[i].term);\n\n};\n\nThis query results in a more worldly cohort:\n\nCLINTON, BILL\n\nARISTIDE, JEAN-BERTRAND\n\nYELTSIN, BORIS N\n\nARAFAT, YASIR\n\nRABIN, YITZHAK\n\nCHRISTOPHER, WARREN M\n\nBERLUSCONI, SILVIO\n\nMANDELA, NELSON\n\nGOLDSTEIN, BARUCH\n\nBOUTROS-GHALI, BOUTROS\n\nCEDRAS, RAOUL\n\nCARTER, JIMMY\n\nPOPE\n\nKIM IL SUNG\n\nMAJOR, JOHN\n\nThis list was generated by a query without a specific keyword or facet search;\nwe could take any or each of these names and ask for a list of the top\npersonalities related to that personality. Here, we’ll ask for a list of the\npersonalities connected in 1994 to Yitzhak Rabin:\n\nmySearch.addQueries(\"+\");\n\nmySearch.addFacetQuery(\"per_facet\",\"RABIN, YITZHAK\");\n\nmySearch.addFacetQuery(\"publication_year\", \"1994\");\n\nmySearch.addFacetQuery(\"desk_facet\",\"Foreign Desk\");\n\nmySearch.addFacets(\"per_facet\");\n\nTimesArticleSearchResult r = mySearch.doSearch();\n\nTimesFacetObject[] stars = r.getFacetList(\"per_facet\");\n\nfor (int i = 0; i < stars.length; i++) {\n\nprintln(stars[i].term);\n\n};\n\nThis query gives us this list:\n\nARAFAT, YASIR\n\nHUSSEIN I\n\nCLINTON, BILL\n\nPERES, SHIMON\n\nGOLDSTEIN, BARUCH\n\nASSAD, HAFEZ AL-\n\nCHRISTOPHER, WARREN M\n\nCHRISTOPHER, WARREN\n\nWAXMAN, NAHSHON\n\nMUBARAK, HOSNI\n\nSHARON, ARIEL\n\nABDELSHAFI, HAIDAR\n\nBHUTTO, BENAZIR\n\nBOUTROS-GHALI, BOUTROS\n\nWe are starting now to get not just simple results with our searches, but also\nconnections between the results. If we were to repeat the process that we used\nfor Rabin with the remaining personalities in our first list, we’d end up with\n225 personalities in our “super list.” This super list, though, would have\nrepeats: as we can see in the Rabin list, some of the personalities have\nalready appeared, in our first list (Arafat, Clinton, Goldstein, and Boutros-\nGhali).\n\nThese relationships are a fascinating part of the data that is available to us\nfrom the NYTimes database. By examining them, we can uncover both obvious and\nhidden relationships among people, places, and topics. In Figure 15-5, the\nsame list of 255 names that we mentioned previously is illustrated as a\nnetwork diagram, with lines showing connections between the personalities\nmentioned.\n\n![bvis_1505.png](images/bvis_1505.png)\n\nFigure 15-5. A network diagram showing the most newsworthy personalities of\n1994\n\nThis image distills a huge amount of news information into a single graphic.\nWith a typical data retrieval system, this kind of diagram would be extremely\ntime-consuming to produce. As we’ve seen, the NYTimes Article Search API makes\nthis process considerably easier for us.\n\nLet’s take the preceding example and make it a little bit more interesting by\ncombining both personalities and organizations. With just 31 queries to the\nAPI, we can create a single image showing how hundreds of people,\ncorporations, and nations were interrelated in the 1994 news year (full source\ncode for this example is available at\n<http://www.blprnt.com/examples/nytimes>). The result is shown in Figure 15-6.\n\n![bvis_1506.png](images/bvis_1506.png)\n\nFigure 15-6. This graphic shows the most frequently mentioned people and\norganizations in the New York Times in 1994\n\nConclusion\n\nThe NYTimes APIs present a wealth of information for researchers of any\nstripe. The database is at the same time a historical record and a live\nfeed—new content is being created every minute of every day. And of course,\nhowever vast the NYTimes database might be, it is but a small part of the huge\ncatalog of open data that is available—a catalog that is growing by leaps and\nbounds with every passing week. Indeed, it seems that we may be sweeping past\nthe first problem of open data—how to make data available—and right into a\nsecond, bigger problem: how can we possibly utilize such mammoth amounts of\ninformation?\n\nPart of the solution to this problem, in my mind, lies in enabling as many\npeople as possible to access and explore the available data. Many large-scale\nopen data initiatives have concentrated on serving the already data-literate:\nsoftware developers, computer scientists, and trained information\nprofessionals. Much of the focus has been on making this data useful on\ncorporate scales. However, as we’ve seen in this tutorial, we can explore at\nleast some of these datasets by using simple tools to ask simple questions.\nThis skill, put in the hands of journalists, sociologists, historians,\nartists, and scientists, will be essential if we want to make really valuable\ndiscoveries in this new territory of open data.\n\nWhat I’m asking of you, then, is to explore. Dig into the Article Search\ndatabase, ask some questions of your own, and share the answers. And that’s\njust the start. Many other APIs can be explored using the skills you’ve\nlearned in this chapter, and there are millions of answers to be found. Good\nluck!\n\n[1] Log into your nytimes.com account, go to <http://developer.nytimes.com>,\nand click “Request an API key” under the “Getting Started” heading.\n\n\nChapter Sixteen\n\nA Day in the Life of the New York Times\n\nMichael Young and Nick Bilton\n\nHave you ever wondered who the readers of the New York Times website are? We\nhave. We also wonder what time of day they tend to visit the site, what\ndevices they use to consume our content, and where they come from. New York,\nParis, Boise? We think about all of these questions, from the who and the when\nto the how and the why.\n\nIn the New York Times Research and Development Labs, a simple lunchtime\nconversation on this very topic led to the development of the research\nvisualization described in this chapter. As you’ll see, we started with a very\nsimple collection of location-based data and quickly became engrossed by the\namount of data and the potential for visualizations. We eventually created a\nvisualization showing a day’s worth of traffic to nytimes.com and\nmobile.nytimes.com on a world and a U.S. map.\n\nThe first phase of our exploration began with data collection. The New York\nTimes website can garner hundreds of millions of page views a month, with the\nnumber of unique visitors fluctuating between 17 and 21 million. Plus, there\nare a number of other gateways to our content, including the mobile website,\nthe Times Reader AIR application, the iPhone application, APIs, and much more.\n\nFor this particular experiment, we chose to stick with the standard\nnytimes.com and the mobile version of the website (mobile.nytimes.com). We\nchose to use two sources for simplicity’s sake, but even limiting ourselves to\nthese two datasets, there was a vast amount of information for us to sift\nthrough and visualize.\n\nThe second phase of our exploration led to the creation of a map-based\nvisualization. The visualization showed the traffic patterns and fluctuations\nof the readers on our web and mobile sites over a 24-hour period.\n\nAs we moved through the stages of the visualization, we were not only\nsurprised by the vast numbers of readers coming to the site, but also by the\ntimes of day at which they arrived. As you can see from the videos at\nhttp://bit.ly/nytdayinlife, the nytimes.com site is relatively active\nthroughout the evening and has a constant heartbeat of users from around\nmidnight to 5 a.m. As the site’s readers begin to wake on the East Coast of\nthe U.S., traffic balloons and the visualization expands; a similar swell\ntakes place around lunchtime as people presumably take a break at work to\ncheck in on the daily news. It’s fascinating to look at the number of readers\naccessing the mobile site versus the website (nytimes.com); as later\nvisualizations revealed, at different times of the day, there tends to be more\nmobile than web traffic, and vice versa.\n\nAs we gain more opportunities to look at this data, there are some interesting\nnext steps we’d like to take. As time permits, we’d like to automate the\nprocess to render the videos on a daily basis, or even at the moments at which\ntraffic spikes, possibly signaling breaking news events. There’s also plenty\nof optimization to be done to the data collection and visualization code (as\nalways). And finally, we’ve talked about visualizing more specific data: for\nexample, showing a day’s worth of traffic coming from a single device such as\nthe iPhone, or taking the users in California and geocoding the stories they\nare reading to see if they are reading about New York or tend to focus on\nlocations closer to themselves. Other possibilities include looking for\npatterns in big news days or important stories to try to understand how news\nspreads throughout the Web, social networks, and geospecific locations.\n\nThe opportunities are endless. We believe that although a single picture can\ntell a thousand words, a single dataset can tell a thousand stories.\n\nCollecting Some Data\n\nBefore jumping into the visualization itself, let’s first discuss the data\nbehind it. To visualize 24 hours of traffic to nytimes.com and\nmobile.nytimes.com, we had to come up with a process to extract and “massage”\nthe data that we needed from the nytimes access logs. Since we knew we wanted\nto create a geographically based visualization showing visits to the site over\nthe period of a day, the data we needed was:\n\n  * The timestamp of each visit to the web and mobile sites, for a 24-hour period\n  * The latitude and longitude of each user/visit\n\nThe raw access logs contain a lot of useful information about people visiting\nthe web and mobile sites (such as which browser each visitor is using);\nhowever, there is a lot of information unnecessary for our purposes that needs\nto be filtered out from the logs. Also, the logs don’t contain the latitude\nand longitude for each user/visit, so this was something we needed to add as\npart of the “massaging” process.\n\nThe New York Times website, a top-five news site in terms of traffic\n(according to Nielsen[1]), has roughly 20 million monthly unique visitors. For\nany single day, that amounts to many millions of page views (or hits) on both\nthe web and mobile sites; this is the data that we are looking to collect for\nour visualization.\n\nLet’s Clean ’Em First\n\nThe first step in processing the raw access logs is to “clean” them up. This a\ncommon process for anyone dealing with web logs of any type. For the\nvisualization, and for other analyses we may do on the log data, we are only\ninterested in hits to the web and mobile sites from humans—not from spiders,\nbots, or scrapers. To remove the irrelevant data, we run some Java code that\nidentifies nonhuman visitors and strips their hits out of the logs. The\noriginal raw access log data for a day amounts to roughly 500–700 MB\n(compressed) for the website and 80–100 MB (compressed) for the mobile site.\nWhile the data is being cleaned, we also do an IP-to-latitude/longitude\nconversion so we can get the exact location of each user visit. The raw access\nlogs contain the users’ IP addresses, which we convert using a commercial\ndatabase. There are many companies that provide GeoIP databases that enable\nthis sort of translation—MaxMind, for example, provides a commercial database,\nas well as a free version with a variety of client libraries that can access\nthe database.\n\nOnce the data was cleaned and properly geocoded, we had to do one last round\nof processing on the data. Because of the way the raw access logs were\ngathered, stored, and then cleaned, the newly cleaned data was located in\nmultiple files and needed to be sorted into a single file containing the day’s\nworth of data that we needed for the visualization. One day’s worth of\n“cleaned” nytimes.com log data is stored in 360 files, each of which is\napproximately 30–40 MB (compressed). The “cleaned” logfiles are larger than\nthe original files due to additional fields in each line, such as GeoIP\ninformation. For the mobile site, since the dataset is much smaller, the\ncleaned data is stored in a single file, which is about 70 MB (compressed). We\nneeded to comb through each of the cleaned logfiles for the day and create a\nsingle file (one for the website and one for the mobile site) that contained a\ntime-sorted list of each hit to the web and mobile sites and the latitude and\nlongitude of each visitor. The resulting file would look something like this\n(line by line):\n\n00:00:00,-18.006,-070.248\n\n00:00:00,-22.917,-047.080\n\n00:00:00,-33.983,0151.100\n\n00:00:00,014.567,0121.033\n\n...\n\nPython, Map/Reduce, and Hadoop\n\nFor this final step, we created a simple map/reduce script in Python that\nfiltered out all of the unneeded data from the cleaned logfiles, output the\ndata we wanted to keep in a comma-delimited format, and then sorted the data\nfor us. (In the R&D group, we typically use Python for our data collection,\nprocessing, and parsing. When visualizing large datasets, we do all of the\nheavy lifting in Python and create files that are easy to read and parse\nwithin the visualization apps.) We ran the map/reduce code using Amazon’s\nElastic MapReduce web service, which allowed us to run a Python map/reduce job\nacross multiple EC2 instances using Hadoop. Amazon EC2 instances come in\ndifferent “sizes” (such as small, medium, and large) that offer differing\namounts of RAM, CPU cores, and memory, so we experimented with running the\nmap/reduce code on a variety of EC2 instances to find the “sweet spot” of\nprocessing time versus cost. The processing took roughly 10–20 minutes (and\ncost a few dollars), depending on the number of machines (we tried anywhere\nfrom 4 to 10) and the size of the EC2 instance (we tried both small and\nmedium).\n\nThe resulting output from the map/reduce (Hadoop) job came in multiple, sorted\nfiles that were saved to Amazon S3 buckets. To get the data into a single file\nfor use in the visualization (again, one file for web and one for mobile), we\ndownloaded the output files from S3 to a local machine and did a good old-\nfashioned sort -m on the files to merge them. Now that we had our data in the\nform we wanted, we were ready to dive into producing the visualization.\n\nThe First Pass at the Visualization\n\nAgain, the goal of the project was to visualize a day’s worth of traffic to\nnytimes.com and mobile.nytimes.com, to see how the visits to our sites played\nout over the day. We wanted to see if there were any interesting patterns\noccurring in specific geographic regions, or even across the globe. Where and\nwhen did mobile traffic spike in the U.S. during the day? Would we see more\naccess to our mobile site in countries like China and India, where mobile\npenetration is higher than in places like the U.S.? How did visits to our web\nand mobile sites look during certain parts of the day, like early morning,\ncommuting time, the lunch hour, and the commute home? Some of these questions\ncan be answered with basic site traffic reports, but we wanted to put a new\nvisual spin on the usual reports and allow people to see how the site traffic\nlooked geographically over the course of a day.\n\nIn our first stab at the visualization, we created a simple global map and\nplotted a small yellow circle for each hit to nytimes.com and a small blue\ncircle for each visit to mobile.nytimes.com as they were happening, second-by-\nsecond, throughout the day. Besides the global view, though, we also wanted to\ncreate a view that was focused on (or zoomed in on) the U.S.\n\nThe first build of our visualization, as we’ll describe in gory detail, was a\nmajor learning experience for us—there were plenty of challenges involved in\ntrying to visualize and make sense of such a large dataset, and we found this\nout firsthand. We reworked the code a few times before we settled on the\ncurrent version, and we are still refining the data gathering and\nvisualization processes as we have time.\n\nProcessing\n\nProcessing (a design-oriented and open source programming language and IDE)\nwas the visualization tool of choice, for a couple of reasons. First, a few of\nus in the NYTimes R&D group already had experience using Processing for small\ndata visualization projects, and to explore using devices with sensors as data\ncollection devices. Additionally, we are big fans of the work Ben Fry and\nCasey Reas (the creators of Processing) and Aaron Koblin have done with this\ntool, so we thought it would be perfect for visualizing our large datasets.\n\nThe first thing we needed for our visualization was some code that would allow\nus to map the latitude/longitude pairs representing the users who visited our\nsites onto the 2D map visualization in Processing. Aaron Koblin was kind\nenough to provide us with some code he has used in a previous project to do\nthis—a nice, compact Java class that converts latitude/longitude pairs to x, y\ncoordinates. All we had to do was pass the lat/long pairs in our data files in\nto the library, and it would give us the x, y coordinates. We could then feed\nthose through Processing’s drawing APIs to draw the points on the map\nindicating the locations of each nytimes.com and mobile.nytimes.com visitor.\n\nThe Underlay Map\n\nCreating the underlay map—just drawing the world map—took more time than you\nmight expect. First we had to find accurate representations of the U.S. and\nthe world. After numerous data explorations, we ended up using a dataset from\nUCLA’s CENS group that plots the lat/long coordinates of every city throughout\nthe world.\n\nThe initial experiments with this dataset rendered it directly in Processing\nwhen the application started up, but this took more time than we wanted just\nfor the underlay; since we knew this data wouldn’t change, we eventually\ncreated a JPEG of the maps and loaded a very small file into the background\n(see Figures 16-1 and 16-2). This saved us minutes of rendering time (which\ncan add up when parsing large datasets) and processing power, and became the\nbackground of all the subsequent data outputs and videos.\n\n![bvis_1601.png](images/bvis_1601.png)\n\nFigure 16-1. U.S. population map\n\n![bvis_1602.png](images/bvis_1602.png)\n\nFigure 16-2. World population map\n\nNow, Where’s That Data We Just Processed?\n\nNow that we had our latitude/longitude projection code and our map outlines,\nwe were ready to start plotting the traffic data onto the map. For the first\ntry at the visualization, we used data from a random day (February 15, 2009)\nthat had no particular breaking news element. The day had average\ntraffic/visits across both the web and mobile sites.\n\nRemember our cleaned up, sorted, and geocoded data files, containing a\ntimestamp and latitude/longitude pair for every view/hit on the web and mobile\nsites for a given day? The idea now was to create a Processing application\nthat would rip through both the web and mobile logfiles and, for each\nview/hit, draw a point on the map indicating where the user was based during\nthat visit.\n\nScene 1, Take 1\n\nProcessing apps, for the most part, are made up of two parts: the setup and\nthe draw loop. In the setup() function in your Processing app, you can do any\ntype of setup work that your app will need, like initializing variables,\nopening input files, loading fonts, etc. The draw loop is where the meat of\nthe Processing code lives. The draw() function in a Processing app is\ntypically called 30 to 60 times per second (this is the frame rate).\n\nOur first attempt looked like this (illustrated in rough pseudocode):\n\nvoid setup()\n\n\\- open up both the mobile and web log files\n\n\\- load the data for the world map\n\nvoid draw()\n\n\\- draw the world map\n\n\\- read a second's worth of log data from the web and mobile log files\n\n\\- draw a yellow point for each visit/hit to nytimes mobile site (during that\nsecond in the log file)\n\n\\- draw a blue point for each visit/hit to nytimes.com website (during that\nsecond in the log file)\n\nThe code, while it had its problems, gave us something to look at on the\nscreen. We were able to run the app and view the points drawn on the map over\ntime, as the day’s web and mobile site traffic played out. It was incredible\nto watch the traffic patterns emerge over time—the map looked like it had come\nalive, with blinking lights scattered across the globe (Figure 16-3).\n\n![bvis_1603.png](images/bvis_1603.png)\n\nFigure 16-3. Original visualization showing traffic from around the world to\nnytimes.com and mobile.nytimes.com—the yellow circles represent traffic to the\nwebsite, while the blue circles represent traffic to the mobile site\n\nThis was a great first step, but we had some things to fix both in our code\nand our approach. The following sections describe the three major areas we\nneeded to work on.\n\nNo Scale\n\nFirst, the visualization didn’t display any sense of scale for the volume of\nweb and mobile site traffic originating at each user location. At any one time\nduring the day, there might be multiple users coming to the web and mobile\nsites from the same location (New York, for example, sees very high traffic\nflows). At times, thousands of people might be on our website, all coming from\nthe same location. Again, think New York!\n\nIn the initial version of the app, we were drawing the same size point on the\nmap for each location (lat/long pair) found in the input logfile. To give some\nindication of scale, we needed to adjust the visual representations of the\ntraffic coming from each location (our blue and yellow points on the map)\nbased on the number of users connecting from that location.\n\nSecond, since the yellow (web) and blue (mobile) points were the same size and\nwe drew the web points before the mobile points (in the draw loop), when both\ntypes of hit came from the same location, the blue mobile points obscured the\nyellow web points.\n\nNot good for a visualization.\n\nNo Sense of Time\n\nIn our first pass at the visualization, we weren’t taking into consideration\nhow much time people spent on the web or mobile site for each visit or page\nview; we simply drew a point on the map for each site visit and left it there\nfor the entire duration of the visualization. Now, no one would have noticed\nthis for some of the larger cities in the world where we have a continuous\nstream of traffic, but for some small, remote locations, where we get only a\nfew views a day, this gave the impression that we had traffic from those spots\nthroughout the day.\n\nWe needed to fix this, in combination with the scale problem—that is, we\nneeded to come up with a way to accurately portray how many people were\nvisiting the site from any one location, and how long they were staying on a\nspecific article, or the site as a whole.\n\nMost importantly, this had to be done for every second of the day!\n\nTime-Lapse\n\nFinally, we wanted to create a time-lapse video for the entire day’s traffic,\nallowing us to easily share the visualization around the New York Times\nCompany. To solve this problem, we decided to use a built-in video library for\nProcessing that saves frames from the draw loop to a video file and creates a\nclean output movie.\n\nScene 1, Take 2\n\nWorking off the code from the first version of our project, we added the\nability to capture the visualization to a file via the Processing MovieMaker\nlibrary.\n\nWe also added support to the app so that each hit to the web or mobile site\nwas properly represented in terms of the lifespan of the visit to the site. On\naverage, a visit to either site lasts three to four minutes. So in this\niteration, instead of drawing a point on the map and leaving it there for the\nentire 24-hour period, we tried slowly fading each point away over the course\nof three minutes.Of course, not every hit to the web or mobile site is from a\nunique user making a three-minute visit—many of the hits in our logfiles are\nfrom repeat users or users who are browsing multiple pages of the site over a\nlonger period of time. But to keep the initial version of the visualization\nfrom getting too complex, we made the blanket statement that each hit would be\na “three-minute visit” to the site.\n\nFor this slightly simplified representation, we needed to keep track of every\nview/hit over the course of a day and fade each one out over the course of\nthree minutes. This meant storing a lot of objects in memory. For each hit to\nthe web and mobile site that occurred every second, we created an object in\nour Processing app whose task was to keep track of that hit’s “lifetime”—i.e.,\nhow long the point should be on the screen (three minutes)—and we used these\nobjects to help fade the points out over the course of this lifespan.\n\nSo, back to our Processing draw loop. We still read in each second of data\nfrom the web and mobile logfiles, but now for each hit that occurred we\ncreated a Hit object with an initial lifetime value of three minutes and an\ninitial opacity of 100% (these values decreased over every draw loop\niteration). After reading in the log data, we iterated through the collection\nof Hit objects in memory. For each Hit, we redrew the point for the hit with\nan opacity based on the lifetime left for the hit, fading it out over the\ncourse of the three-minute lifetime. As each Hit reached the end of its\nlifespan, we removed it from memory and removed the corresponding point from\nthe map (i.e., did not redraw it).\n\nSince we were visualizing roughly 400–500 hits/second, this approach meant\nstoring a lot of objects in memory at any moment in time to keep track of all\nof the hits (or users). We knew this would be problematic and we had some\noptimization ideas, but we wanted to take baby steps and decided to first see\nif this approach would work.\n\nLet’s Run This Thing and See What Happens!\n\nAdding the support for fading each hit out over the three-minute period got us\ncloser to visually representing the traffic to the site, but more work was\nneeded. For one thing, at this point we still didn’t have any sense of scale\nfor the traffic originating from each location worked into the visualization.\nSpeed was another issue—running this version, we were able to produce only\nabout 45 seconds of time-lapse video in 25 minutes! A memory and processor\nhog, this baby was slow to run and to render. We tried running it on a few\ndifferent machines in the lab (Mac Minis with 1 GB of RAM, MacBook Pros with 4\nGB of RAM, and a Mac Pro), but the app was slow to render on each machine. The\nvisualization was one step closer to what we were looking for, but it needed a\nnew round of optimizations—we needed to produce a day’s worth of time-lapse\nvideo, and at this point the best we had was about an hour’s worth!\n\nThe first version of the visualization can be viewed at\n<http://nytlabs.com/dataviz>.\n\nThe Second Pass at the Visualization\n\nNow that we had a taste for the visualization, we needed to get it fully\nworking. Besides adding support to give a sense of scale for the amount of\ntraffic coming from each location, we needed to optimize the app, which\nrequired rethinking how we collected the data.\n\nBack to That Scale Problem\n\nShowing each hit per second didn’t work without any sense of scale. In the\nfirst version of the app, a handful of hits coming from rural Canada had the\nsame visual weight as the thousands coming from New York. Also, showing every\nhit per second was too expensive in terms of the memory and processing power\nneeded to render the visualization.\n\nAfter thinking this through, we decided the answer was to visualize the number\nof hits from each location per minute, instead of per second. For every minute\nof data in the access logfiles, we’d add up the total number of hits per\nlocation. This would give us a sense of the scale of traffic for each\nlocation, and would greatly reduce the amount of raw data input to the\nProcessing app. However, this approach meant a change to our data processing\nand map/reduce jobs.\n\nMassaging the Data Some More\n\nOur Python map/reduce scripts, which originally parsed out the data we needed\nfrom the raw access logs and then sorted the data based on time, needed some\nupdates. Now, the script needed to count each hit per location\n(latitude/longitude pair) per minute and then output that data, sorted by the\naccess time.\n\nIf you aren’t familiar with how map/reduce works, we recommend doing some\nbasic reading through some of the tutorials available online. Basically,\nmap/reduce is a programming model that allows you to process large amounts of\ndata. The processing is split up into two tasks: mapping and reducing. The\nMapper typically takes some input (logfiles in our case), does some minor\nprocessing on the data, and then outputs the data in key/value pairs. The\nReducer’s job is to take the data output from the Mapper and merge or reduce\nthe data into what is usually a smaller dataset.\n\nOur Mapper script read the raw access logfiles and, for each line, output a\nkey/value pair in the following format:\n\nTimestamp of the access (in HH:MM format),latitude,longitude 1\n\nIn this case, the “key” was a comma-delimited string containing the timestamp\nand latitude and longitude for each hit in the logfile, and the “value” was 1\n(a single hit count).\n\nOur Reducer then read in each line from the Mapper and kept track of the\nnumber of hits per location per minute. To do this, it stored each “key”\noutput from the Mapper in a Python dictionary and incremented a counter each\ntime it saw the same “key” in the Mapper output. Here’s an example of what the\nPython dictionary looked like:\n\n{\n\n\"12:00,40.7308,-73.9970\": 128,\n\n\"12:00,37.7791,-122.4200\": 33,\n\n\"12:00,32.7781, -96.7954\": 17,\n\n# cut off for brevity...\n\n\"12:01,40.7308,-73.9970\": 119,\n\n\"12:01,37.7791,-122.4200\": 45,\n\n\"12:01,32.7781, -96.7954\": 27,\n\n# ...\n\n}\n\nOnce our Reducer had collected all of the input data from the Mapper, it\nsorted the data (based on the key) and output it in sorted order.\n\nThe code for our early versions of the Mapper and Reducer is reproduced here:\n\nMapper\n\n#!/usr/bin/env python\n\nimport sys\n\n# input comes from STDIN (standard input)\n\nfor line in sys.stdin:\n\n# remove leading and trailing whitespace\n\nline = line.strip()\n\n# split the line into words\n\nwords = line.split('\\t')\n\ntry:\n\n# output the following:\n\n# time(HH:MM),latitude,longitude 1\n\ntime = words[1]\n\nhours,mins,secs = time.split(\":\")\n\nt = hours+\":\"+mins\n\nprint '%s,%s,%s\\t%s' % (t, words[44], words[45], 1)\n\nexcept Exception:\n\npass\n\nReducer\n\n#!/usr/bin/env python\n\nfrom operator import itemgetter\n\nimport sys\n\nlocations = {}\n\n# input comes from STDIN\n\nfor line in sys.stdin:\n\n# remove leading and trailing whitespace\n\nline = line.strip()\n\n# parse the input we got from mapper.py\n\nkey, count = line.split('\\t')\n\ntry:\n\n# update the count for each location (lat/lng pair)\n\n# per minute of the day\n\ncount = int(count)\n\nlocations[key] = locations.get(key, 0) + count\n\nexcept Exception:\n\n# count was not a number or some other error,\n\n# so silently ignore/discard this line\n\npass\n\n# sort the data and then output\n\nsorted_locations = sorted(locations.items(), key=itemgetter(0))\n\nfor key, count in sorted_locations:\n\ntry:\n\ntime,lat,lng = key.split(',')\n\nprint '%s,%s,%s,%s'% (time, lat, lng, count)\n\nexcept Exception:\n\npass\n\nThe New Data Format\n\nAfter running our new map/reduce scripts on raw access data, we had a more\nprecise dataset to work with. Not only did this process reduce the overall\ndata (from roughly 30 million lines to 3 million lines for the web access\ndata), but it also gave us a hit count for each location. Now we had the scale\nfactor we were looking for. Here is a small sample of the new data—notice the\ntimestamp, latitude, longitude, and hit counts (per minute):\n\n12:00,039.948,-074.905,128\n\n12:00,039.949,-082.057,1\n\n12:00,039.951,-105.045,3\n\n12:00,039.952,-074.995,1\n\n12:00,039.952,-075.164,398\n\n12:00,039.960,-075.270,1\n\n12:00,039.963,-076.728,4\n\n12:00,039.970,-075.832,2\n\n12:00,039.970,-086.160,4\n\n12:00,039.975,-075.048,23\n\nVisual Scale and Other Visualization Optimizations\n\nWith the data in its new form, instead of plotting a small point for each hit\nper second, we could now plot a circle for each location per minute and use\nthe hit count as a basis for the size of the circle. This would provide the\ndesired sense of scale, enabling viewers of the visualization to easily tell\nthe difference between the amount of traffic coming from rural Canada and from\nNew York.\n\nThis approach also greatly reduced the amount of memory needed by the app. We\nstill needed to keep track of all hits to the web and mobile sites in memory\n(so that we could fade out the hits over a three-minute period), but now that\nwe were keeping track of locations per minute, the number of Hit objects we\nneeded to store was greatly reduced. For any given minute, we typically have\ntraffic coming from roughly 2,000 to 3,500 different locations around the\nworld. Hit objects for each location must be stored in memory; each persists\nfor three minutes, so at any given time there may be between 6,000 and 12,000\nobjects in memory—still a lot, but nowhere near the number we had in the\nprevious version.\n\nAt this point, the Processing app logic needed to be updated to keep track of\nthe number of hits per location for any point in time, and to scale the size\nof the circle given the number of hits. Let’s look at a quick example to\nexplain this.\n\nLet’s assume we are talking about access to our website from a specific\nlatitude/longitude in New York (there are many in the dataset). Looking at a\nsmall period during a day, suppose we have the following number of hits\nbeginning at each given time:\n\n12:00 – 100 hits\n\n12:01 – 110 hits\n\n12:02 – 90 hits\n\n12:03 – 80 hits\n\n12:04 – 100 hits\n\nWhen we draw the circle on the map for this location, we want the size of the\ncircle to reflect the hit count, which gives us the sense of scale. However,\nwe cannot simply base the size on the number of hits/views initiated during\nthe current one-minute period. Why not? Remember that a typical visit to the\nsite results in a three-minute stay, so we decided to keep track of the number\nof hits per location for three minutes and drop them from the count only after\nthe three-minute period has passed.\n\nUsing the hit counts above, our total hit count per minute would therefore be:\n\n12:00 – 100 hits (assuming no previous hits)\n\n12:01 – 210 hits (100 + 110)\n\n12:02 – 300 hits (100 + 110 + 90)\n\n12:03 – 280 hits (110 + 90 + 80)\n\n12:04 – 270 hits (90 + 80 + 100)\n\nNotice how, for any given minute, we keep track of new hits during that minute\nplus the previous two minutes’ hit counts.\n\nUpdating the Processing app with code to handle keeping track of total hits\nper location per minute produced the result in Figure 16-4. This new version\nallowed us to show the scale of hits from different locations on the map at\nany given minute, as well as showing how that scale expanded and contracted\nover the day based on the increase or decrease of traffic from each location.\n\n![bvis_1604.png](images/bvis_1604.png)\n\nFigure 16-4.  The updated visualization showing traffic from around the U.S.\nto nytimes.com and mobile.nytimes.com on June 25, 2009—the yellow circles\nrepresent traffic to the website, while the red circles represent traffic to\nthe mobile site\n\nGetting the Time Lapse Working\n\nAfter updating the Processing app to handle the new data input format and\nmethod, we created a full 24-hour time-lapse video. We had been able to run\nour new code for a few hours at a time without the memory and overall machine\nlatency problems that we were seeing before, but now it was time to generate\nthe full time-lapse video. Instead of trying to render both the web and mobile\ndata on the map for the first attempt at our 24-hour time lapse, we used the\nmobile data only (which is about 10% the size of the web data); this way, we’d\nsee results, or possibly problems, sooner than if we tried to render both the\nweb and mobile data.\n\nNot knowing how far we should shrink the 24-hour time lapse (should we show\nthe full 24 hours in a 1-minute video, a 10-minute video, or somewhere in\nbetween?), we settled on 10 minutes as a test. One of the most exciting\nmoments of the project was pushing Processing’s “Run” button when we first\nattempted to render 24 hours of mobile data. Rendering this data into a\n10-minute time-lapse video took about two hours on a MacBook Pro. We had\nresults!\n\nAfter a few fist bumps and congratulations were thrown around, we watched the\nvideo. About two minutes in, we realized it was much too long—the video felt\ntoo slow! Time to reload and create something closer to a 1.5-minute time-\nlapse video.\n\nAfter a few more attempts and some tweaking to the code and frame rates, we\nhad our video. Once we had the app working for rendering the smaller mobile\ndataset, we cut it loose on the combined web and mobile data. Being a much\nlarger dataset, it took much longer to render—instead of 2 hours, this one\ntook between 24 and 36 hours, depending on the machine it was running on.\n\nSemiautomating\n\nUltimately, we want to automate the entire process so that we can easily\nrender the time lapse for any day on command. The process is semiautomated\nnow, and we can fairly easily render multiple time-lapse videos for the same\nday. For example, we can render any of the following:\n\n  * Web and mobile data on a global map\n  * Web and mobile data on a U.S. map\n  * Web-only data on global and U.S. maps\n  * Mobile-only data on global and U.S. maps\n\nHow long does it take to render each? Well, it depends on the date and if it\nwas a big news day (i.e., if there was a lot of traffic). For an average day,\nhere is the approximate amount of input data for our visualization and how\nlong it takes to render:\n\nMobile only\n\nData file is approximately 7 MB and 300,000 lines\n\nRendering takes roughly 2 hours\n\nWeb only\n\nData file is approximately 70 MB and 3 million lines\n\nRendering takes roughly 1 to 2 days\n\nWeb + mobile\n\nData file is approximately 77 MB and 3.3 million lines\n\nRendering takes roughly 1 to 2 days\n\nMath for Rendering Time-Lapse Video\n\nWithin our Processing app, we captured video at 15 frames per second. For each\nframe, we drew one minute’s worth of log data on the screen and then captured\nit to file. For 24 hours’ worth of data, we are capturing 1,440 minutes of\ndata. With 15 minutes’ worth of data rendered every second, rendering 1,440\nminutes gives us 96 seconds of video (roughly a minute and a half).\n\nSo, What Do We Do with This Thing?\n\nAs this book is going to press, we have just finishing rendering videos for a\nfew days’ worth of data. Outside our offices on the 28th floor of the New York\nTimes Building, we have 10 monitors in the hallway where we display some of\nour visualizations, including these traffic maps. On six of the monitors, we\nautoplay the time-lapse videos; on the remaining screens, we display four\nstatic screenshots of the overall traffic for the day for our web and mobile\nsites (in the U.S. and globally). We are starting to share the videos around\nthe company and are exploring more visualizations to see what kinds of\npatterns we can observe throughout the day. We are also looking at the\ndifferences in usage patterns between days that have large breaking news\nstories and “average” news days.\n\nConclusion\n\nWe’ve seen a few interesting patterns from the visualizations we have created\nso far, most of which are illustrated in Figures 16-5 through 16-8.\n\n![bvis_1605.png](images/bvis_1605.png)\n\nFigure 16-5. Traffic to mobile.nytimes.com for the entire day of June 25,\n2009[2]\n\n![bvis_1606.png](images/bvis_1606.png)\n\nFigure 16-6. Traffic to mobile.nytimes.com for the entire day of June 25, 2009\n\n![bvis_1607.png](images/bvis_1607.png)\n\nFigure 16-7. Traffic to nytimes.com for the entire day of June 25, 2009\n\n![bvis_1608.png](images/bvis_1608.png)\n\nFigure 16-8. Traffic to nytimes.com for the entire day of June 25, 2009\n\nFirst, the mobile site traffic bursts first thing in the morning in the U.S.,\nat around 5:00 or 6:00 a.m., when people are waking up and commuting to work\n(especially on the East Coast). It continues to hold strong until people get\ninto the office at around 8:30 or 9:00 a.m.; at this time, the traffic on the\nwebsite surges for the first time in the day. The web traffic, which is strong\nthroughout the day (especially around lunchtime), dips slightly during the\nafternoon, probably around commuting hours, when the mobile traffic pops up\nagain. This was the behavior that we expected before beginning our research,\nbut the visualization helped confirm our hypothesis.\n\nAnother interesting pattern to look at is the strong international traffic to\nboth the web and mobile sites, as well as the mobile traffic coming from parts\nof Africa, China, India, and Japan.\n\nWe think there will be other interesting observations to make from the\ninternational and U.S. traffic patterns, and we’ll explore them as we’re able\nto render more videos from our traffic data. We invite you to watch for\nyourself and let us know what you see! You can view samples of the\nvisualizations at <http://nytlabs.com/dataviz/>.\n\nAcknowledgments\n\nNoriaki Okada (an intern at the NYTimes R&D Lab) contributed a large part of\nthe visualization code and research for this chapter. His work can be found at\n<http://okada.imrf.or.jp>. We would also like to thank Michael Kramer, Ted\n“Chevy’s” Roden, and Dick Lipton for their unwavering support on this project.\n\n[1] See <http://blog.nielsen.com/nielsenwire/online_mobile/msnbc-and-cnn-top-\nglobal-news-sites-in-march/>.\n\n[2] The two large circles are over Dallas, Texas, and Waterloo, Ontario. Both\nof these cities are mobile hubs (e.g., Waterloo is BlackBerry/RIM\nheadquarters) and a lot of mobile traffic is proxied through Dallas and\nWaterloo before arriving at our servers.\n\n\nChapter Seventeen\n\nImmersed in Unfolding Complex Systems\n\nLance Putnam, Graham Wakefield, Haru Ji, Basak Alper, Dennis Adderton, and\nProfessor JoAnn Kuchera-Morin\n\nMedia Arts and Technology,  \nUniversity of California, Santa Barbara\n\nOur Multimodal Arena\n\nWhat would it be like to walk into a real-life “Holodeck” or “Cerebro” and\nexperience a stunning new world unlike anything seen before? Beyond this, what\nif we were able to experience hitherto unobservable aspects of nature, as\nenvironments into which the body cannot actually venture? In fact, these\nquestions are on the minds of scientists and artists working together, right\nnow, in the AlloSphere located in the California NanoSystems Institute at the\nUniversity of California, Santa Barbara. We have in our hands an instrument\nthat allows us to explore and interact with complex, high-dimensional data and\nsystems—whether they be subatomic particles, the human brain, or entire\nsynthetic ecosystems—as if they were fully immersive worlds.\n\nThe AlloSphere is one of the largest scientific/artistic\ninstruments/laboratories in the world for immersive visualization,\nsonification, and multimodal data manipulation. It is a three-story sphere\nfinely tuned for perceptual experiences with a 360-degree, super-black,\nnonreflective screen surrounded by a multichannel loudspeaker array, all\nhoused in an echo-free chamber (see Figure 17-1). Multiple users standing on\nthe central bridge (Figure 17-2) can interact through myriad multimodal\ndevices as they experience stereographic projections and spatial audio.\n\n![bvis_1701.png](images/bvis_1701.png)\n\nFigure 17-1. A virtual real-scale model of the AlloSphere\n\n![bvis_1702.png](images/bvis_1702.png)\n\nFigure 17-2. A full-scale photo of the AlloSphere\n\nThe AlloSphere was conceived by composer JoAnn Kuchera-Morin as a general-\npurpose eye- and ear-limiting multimedia instrument for both new modes of\nartistic expression and scientific discovery. Her intention was to provide a\ncommon meeting ground where diverse researchers can share insights and pursue\nsimilar fundamental questions about symmetry, beauty, pattern formation, and\nemergence. Our attitude to this unique opportunity is to establish a frontier\nof research that is grounded in both art and science, but not constrained to\neither one. This has required a holistic rethinking of the fundamental aspects\nof our creative medium: computation, data, process, perception, interaction,\nimmersion, and evaluation.\n\nWith artists, scientists, and engineers working together in the AlloSphere to\nuncover new worlds through unique and compelling simulations and\nvisualizations, we are implementing our concept of beauty as truth. We help\nresearchers find this truth through the visualization and sonification of\nintriguing equations. These visualizations offer elegant solutions in their\nunfolding, allowing us to discover symmetry—and broken symmetry—as it unfolds\nin these equations.\n\nOur Roadmap to Creative Thinking\n\nThe AlloSphere indeed provides a compelling interactive, multimodal\nenvironment for a new type of interdisciplinary research that, from the start,\ntightly integrates quantitative and qualitative approaches to problem solving\nand discovery. It also offers a unique opportunity for experiencing—using all\nof our senses—how complex systems unfold over time. We have begun to uncover\ncommon themes in how these systems are described in terms of computational\nconstructs and how they can be represented in terms of beauty and symmetry.\nOur challenge and opportunity in composing beautiful visualizations is thus to\nstrike a balance of both mathematical truth and perceptual expression, and to\nintroduce a new form of art and research as epistemological experiment.\n\nBeauty and Symmetry\n\nBeauty no doubt plays a central role in our perceptual engagement, as it is\nclosely related to symmetry. In fact, beauty and symmetry have shared an\nintimate relationship since the time of the ancient Pythagoreans, who stated\nthat the key to beauty lies in the proportions of parts and their\ninterrelationships, and that symmetry and harmony are the interrelationships\nin the domains of sight and hearing, respectively (Tatarkiewicz 1972). This\ntheory has been one of the most enduring throughout our cultural history.\n\nIndeed, symmetry—and its more formal definition as “invariance to\ntransformation” (Weyl 1952)—is the basis of some of the most profound\nscientific theories of nature, including special relativity, the laws of\nconservation, and string theory. Symmetry has also played a less acknowledged\nbut vital role in computational simulation. In ancient times, we could observe\nonly the patterns in nature around us; today, through the control over\nproportion afforded by computation, we can compose systems that generate\ncomplex natural patterns with precision and autonomy. At the heart of these\ncomplex patterns, we do indeed find symmetries. In fact, symmetry often helps\nguide our search for significant patterns in the data.\n\nThe Computational Medium\n\nComputation and mathematics provide an alluring common language between\nscientific models and aesthetic practice. Computation is a vital tool for\nscientific simulation and also an open-ended material for art. By designing\nand instantiating complex autonomous systems, we open the door to a new kind\nof knowledge based on synthesis of parts.[1]\n\nRegardless of the questions we want to ask, computation necessitates a formal\nand discrete description of the basic components of the data and a\nconsideration of the limits of real-time processing. We have found,\nparticularly for physically based models, that the data we work with consists\nprimarily of values associated with positions in space and/or time. Values\nrepresent particular internal intensities, such as velocity, flux, frequency,\nor complex phase, and are typically correlated to positions in space and/or\ntime. Many of the visualization techniques we apply involve filtering out\nvalues at a certain position (such as a cross-section) or positions at a\ncertain value (such as a contour line).\n\nHow the values and positions are instantiated during a program’s execution\nvaries. The values can be explicit (given at regular sampling points or as\nposition/value pairs) or implicit (computed on the fly using an equation or\nalgorithm). Likewise, the positions can be explicit (as position/value pairs)\nor implicit (determined from the dimensions of a regular lattice).\n\nIn working with various computational models, we have observed three general\nparadigms in how data is represented for storage and processing:\n\n  * As a regular lattice of sampled values\n  * As a collection of position/value pairs \n  * As a function of position \n\nThe difference between the first two is the same as the two general ways\nimages can be represented on a computer: raster-based (as a matrix of pixels)\nor vector-based (as a set of points connected with curves). The third paradigm\nis more like a black box that takes in a position and outputs a corresponding\nvalue.\n\nWith each paradigm, there are specific trade-offs. A lattice permits models\nconsisting of unexpected signals and local interactions, but it requires\nsampling, leading to aliasing and the need for potentially large amounts of\nmemory to model systems at an appropriate level of resolution. In contrast,\nthe position/value and function paradigms allow fine or arbitrary spatial\nresolution, but make it computationally difficult to model interactions\nbetween entities.\n\nA conceptual division that follows naturally from these paradigms is between\nspatiotemporal fields and sets of free agents. Fields are a type of regular\nlattice in space (possibly time-varying) and serve as the substrata of complex\nsystems. They provide the underlying architecture of structure and dynamics\nwithin a system. Fields represent things like density distributions, fluids,\nand waves. The concept of a field exists in many disciplines: developmental\nbiology has the morphogenetic field and epigenetic landscape, evolutionary\nbiology has the fitness landscape, and physics has quantum fields and\nwavefunctions. Agents are collections of position/value pairs and serve as the\nsuperstrata of complex systems. Agents represent actual discrete entities,\npossibly mobile, in continuous space. They allow us to observe fields more\nclearly by focusing finely on parts of the entire system and filtering it to\nsee its patterns of invariance. In addition, agents often interact with one\nanother by reading and writing values in a field.\n\nInterpretation As a Filter\n\nOur work involves not only the design and instantiation of complex systems,\nbut also—and just as importantly—the composition of a filter that reduces the\noverwhelming vastness of the computational/mathematical spaces into forms that\nwe can perceive and draw meaning from. In other words, visualization and\nsonification involve both the organization of materials (composition) and the\npresentation of the patterns we are trying to reveal (interpretation).\n\nWe often ask ourselves the question “what are we looking for in the data or\nsystem?” To begin answering this question, we can say that we are looking for\nthe interesting patterns that reveal essential aspects of the system as it\nunfolds. Furthermore, we find that utilizing symmetry helps guide our search\nfor significant patterns. The visualization techniques we commonly apply, such\nas isosurfaces, contours, streamlines, and particle flows, show aspects of a\nsystem where its values (or a derived quantity of them) are equivalent or\ninvariant. These “pockets of symmetry” show the similarities in the system and\ntend to provide a good starting point for more deeply understanding its\nbehaviors and patterns. We know that too much symmetry reduces significance,\nwhile too little symmetry is overwhelming; the filter must fall between these\nextremes of order and disorder. This also applies to time: patterns of\ninterest must maintain identity long enough to be recognized, but also change\nsufficiently to capture attention.\n\nComposing a filter is an adaptive process that occurs within a modality just\nas much as across modalities. We find that multimodal representation is\nimportant for revealing otherwise hidden or nonobvious symmetries and\nasymmetries in data. Sometimes, the most natural sensory modality of a dataset\nor process will not fully depict important aspects of its structure. For\nexample, we find that symmetries of waveforms are better seen and that\nslightly broken symmetries in spatial data are better heard. We use the\ntransformational capacities of computation to map amongst and between\nmodalities, searching for a balance that will give a more complete mental\npicture of the phenomena at hand. In fact, there is evidence that the brain’s\nmemory system consists of an “episodic buffer” that integrates visual and\naural sensory information into a multidimensional code that interfaces with\nlong-term memory and can subsequently affect long-term learning (Baddeley\n2000).\n\nThe agent-based model has played a dominant role in our filtering and\npresentation of data and systems. Agents are appealing from both a visual and\nan aural sense since they can have smoother and more continuous movements,\nversus being restricted to moving on a discrete lattice. In return, they allow\nus to observe dominant patterns in systems through coherent structures, thus\nreducing noise. One example is using agents to show flux across a coarsely\nsampled field using smooth and continuous curves.\n\nProject Discussion\n\nIn this section, six research projects will be discussed that span areas\nranging from artistic/scientific mathematical abstraction to precise\nmultimodal representation of computational models based on real scientific\ndata and theories. We’ll move from real biological data through bio-inspired\nevolutionary developmental algorithms, to the world of atoms; then, moving\nfrom the atomic level down to the electron level in one single hydrogen atom,\nwe will finally arrive at a project that represents the coherent precession of\nan electron spin.\n\nAllobrain\n\nBy Graham Wakefield, John Thompson, Lance Putnam, Wesley Smith, and Charlie\nRoberts (Media Arts and Technology)\n\nFaculty Directors: Professor JoAnn Kuchera-Morin and Professor Marcos Novak\n(Media Arts and Technology)\n\nIn the Allobrain, we fly through the cortex of the human brain (Figure 17-3).\nStructural components of functional magnetic resonance imaging (fMRI) data are\nused to create a space that can be experienced as a “world” through which we\ncan navigate. The raw data maps density values of cerebral metabolic activity\nacross a lattice of spatial coordinates throughout the brain; the\nvisualization contains two isosurfaces through this dataset, selected by the\nintensity of brain tissue response to the fMRI scan. (An isosurface is a 3D\ncontour representing points of a constant value.) Inside this world are\n“search agents” that navigate autonomously to mine the data, indicating their\npresence spatially and visually, clustering in regions of interest and\nreporting back to us through musical sound. “Wanderer agents,” color-coded to\nspecific brain regions, take a random walk through the data looking for high\nblood-density levels. They alert large packs of “cluster agents” to do finer-\ndetailed analysis and visualization in these regions of interest. The wanderer\nagents can also be commanded to report back to the center of the screen and\nsing blood-density levels, where higher pitches correlate to higher levels.\n\n![bvis_1703.png](images/bvis_1703.png)\n\nFigure 17-3. Inside the Allobrain\n\nOne can imagine applications not only for medical diagnostics but also for\npsychological studies in cognition and perception: by revealing many\ndimensions of information in a single viewing, Allobrain facilitates early\ndiscovery of cellular disorder and understanding of how the brain functions.\nIn fact, visual artist and trans-architect Marcos Novak—the creator of this\nworld, and whose brain it is—conceived the project to engage with the\nneurological bases of aesthetic appreciation. He describes his work as\nfollows:\n\nWhen we say that something is “beautiful,” what parts of the brain are\ninvolved in that assessment, and how? Since there is such great variation\namong people in aesthetic matters, a better approach to the question of beauty\nmay be to study one or few instances as closed systems, learn as much as\npossible about them, and then [determine] if what has been learned can be\ngeneralized to others.\n\nIn particular, this work aims to construct a situation in which most of the\nelements that pertain to the making of something beautiful are accessible to\ninvestigation. Specifically:\n\n  * the work to be appraised as beautiful or not \n  * the method and mechanism of its generation \n  * the creator, appraiser, and investigator of the work \n\nFurthermore, the aim (scientifically and artistically) is to create a feedback\nloop in which the art affects the brain and the brain generates new data that\ncreates new art, that in turn affects the brain, that generates new data, and\nso on.\n\nTo seed the process, I wrote a generative algorithm that produced stimuli that\nI could not anticipate in detail, and that triggered in me the reaction of\nbeauty (in terms of visual and spatial composition). The stimuli consisted of\neither a) an interactive/generative moving/changing image, [or] b) video\nrecordings of this so that they could be used in the fMRI machine. While in\nthe fMRI machine, I was presented with this video (which I had not seen\npreviously). Whenever I felt that the visual compositions were beautiful to\nme, I pressed a button. The pressing of the button was timed, so that it could\nbe correlated with the activity of the brain at that instant. The fMRI data\nwas converted into an immersive environment, or “world.” This step allows two\nparallel possibilities: from a scientific viewpoint, it permits the structural\nand functional data to be perceived from within in ways that conventional\nvisualization techniques do not allow. From an artistic viewpoint, it proposes\na novel art form in which the brain (and subsequent mind) produces the world,\nand the world alters the mind, which in turn produces another world, and so\non. In both cases, a feedback loop can be constructed in which the user’s\nresponse itself helps generate the stimuli that trigger that response, thus\namplifying the effect.\n\nPresently, the Allobrain reveals one static snapshot of a thought. As we move\nthe project forward, real-time interactive fMRI data will allow researchers to\nbe immersed in their own thoughts and watch them transform and change, as in\nNovak’s description. The brain will perceive the world and then transform the\nworld through its perception.\n\nArtificial Nature\n\nBy Haru Ji and Graham Wakefield (Media Arts and Technology)\n\n<http://artificialnature.mat.ucsb.edu>\n\nWe move now from raw biological data to the processes and systems at the roots\nof life. Artificial Nature is a transdisciplinary research project and bio-\ninspired immersive art installation based on generative models drawn from\nsystems biology, artificial life, and complexity sciences rather than\nempirical data. The computational world of Artificial Nature is an ecosystem\nconsisting of populations of organisms interacting within a dynamic\nenvironment, with which spectators interact.\n\nThe environment is a spatial field based upon equations of fluid dynamics.\nSimple particles flowing within it represent different nutrient types (hue)\nand energy levels (brightness), and interact kinetically with one another.\nThese particles provide the metabolic fuel for the organisms, which are\nmodeled as autonomous agents. Both ingestion of nutrients and disposal of\nwaste products are necessary for organisms to survive and reproduce.\n\nThe appearance and autonomous activity of organisms is determined through the\ninterpretation of their genetic descriptions according to local (spatial and\nhistorical) conditions. For example, sufficient accumulation of energy\ntriggers some organisms to generate children by asexual reproduction, with\nsmall chances of mutation. The shape of these organisms is based upon the Boy\nsurface equation (Boy 1901) and is gradually varied over their lifetimes to\nindicate gradual growth and development, while health is represented by\nopacity.\n\nActivities such as ingestion, reproduction, and detection of neighbors are\naccompanied by different varieties of chirp-like songs, which are fully\nspatialized in the AlloSphere. These sounds are bright, transient-rich, and\ntightly clustered, making them easier to distinguish from one another,\nlocalize, and connect to visual events.\n\nSpectators can explore this world freely and endlessly using a six-degrees-of-\nfreedom navigator device and can influence it indirectly, creating turbulence\njust as they might have by playing in a stream or sandpit in their childhood.\nSensory data collected through a camera-eye and microphone-ear, and sometimes\nthrough touch, become the environmental conditions to which the organisms must\nadapt. The turbulence of the fluid also feeds back to influence the navigation\nof the spectators. The entire ecosystem, including the spectators themselves,\ngenerates continuous patterns of emergent beauty (Figures 17-4 and 17-5).\n\n![bvis_1704.png](images/bvis_1704.png)\n\nFigure 17-4. Artificial nutrients being produced and dispersed in the fluid\nfields of Artificial Nature (version 1: Infinite Game)\n\n![bvis_1705.png](images/bvis_1705.png)\n\nFigure 17-5. Artificial organisms growing and interacting in Artificial Nature\n(version 2: Fluid Space)\n\nWe asked what form of art could evolve in the space of the AlloSphere.\nArtificial Nature responds consciously to this challenge as an immersive\nartwork, a new kind of experience within an alternative environment—an\ninfinitely unfolding possible world. The open-ended nature of Artificial\nNature is grounded in the embodiment of complex adaptive systems drawn from\nartificial life. These agent-based techniques lend themselves to real-time\nsimulations, and multimodal interaction embeds spectators into the ecosystemic\nnetwork.\n\nArtificial Nature is itself a project within a larger evolution. As we embed\nmore dimensions and relations into it, new potentials for pattern, structure,\nmeaning, and beauty emerge.\n\nHydrogen Bond\n\nBy Basak Alper, Wesley Smith, Lance Putnam, and Charlie Roberts (Media Arts\nand Technology), and Anderson Janotti (Materials Research Laboratory)\n\nFaculty Directors: Professor JoAnn Kuchera-Morin (Media Arts and Technology)\nand Professor Chris G. Van de Walle (Materials Research Laboratory)\n\nAs we move from the biological and macroscopic world, we enter the world of\natoms and a new materials compound for clean technology, the multicenter\nhydrogen bond. This is a very important step for the fabrication of\ntransparent solar cells and low-cost display devices. Normally, hydrogen forms\na covalent bond with other elements (meaning that it bonds by sharing a pair\nof electrons—since hydrogen has only one electron, it can form only one\ncovalent bond at a time), but in a zinc-oxide lattice it bonds anomalously to\nfour zinc atoms, forming a tetrahedral bond structure.\n\nOur materials science colleagues in the Solid State Lighting and Energy Center\nat UCSB discovered this unique type of bond structure and requested that we\nrepresent their simulation data visually and sonically in ways that their\nexisting tools would not permit. The data we received was a three-dimensional\nlattice of electrostatic charge density at the site of the hydrogen bond.\nVisualizing this kind of volumetric data poses a significant challenge as\nthere is no natural way to see inside a solid shape.\n\nA common way of visualizing volumetric data is to draw isosurfaces to reveal\ninternal curvature. By applying isosurfaces to the charge density, we made the\nshape of the bond structure more clearly visible in a way similar to how\ncontour lines are used on a map to reveal changes in height. Locating local\nmaxima/minima in the data field was also an important goal for the scientists,\nas it would help them identify critical regions in the bond. We solved this\nproblem by interpreting the gradient as a volumetric data field. Initially we\ncouldn’t get any results, because the sampling distance of the data was much\nlarger than the regions we were looking for. We explained how the\nvisualization algorithm worked and convinced the scientists to generate\nhigher-resolution data. Once we got the high-resolution data, drawing zero-\nvalue isosurfaces in the gradient field successfully showed the local\nmaxima/minima regions.\n\nTo reveal more of the field’s shape, we used a visualization technique called\nstreamlines that produces curves that run along the flow of a vector field. We\nstarted the streamlines near the center of the hydrogen atom and allowed them\nto flow outward “down” the gradient, where hue indicated fast (red) and slow\n(green) movement. Although our science partners initially regarded the\nstreamlines as strange, they proved themselves effective by converging upon\ncritical locations in the bond structure.\n\nWe extended the standard visualization tools by adding the ability to choose\nbetween different visualization modes and overlay selected visualizations in a\nsingle view (see Figure 17-6). Conveying different layers of information in\none view requires drawing a picture where clutter and ambiguity is minimized.\nTo this end, we utilized a custom lighting algorithm that is less diffused and\ntherefore highlights the curvature of the isosurfaces. We composited both\ntransparent and wireframe renderings to ease perception of multiple\ntransparent surfaces. We found that streamlines and isosurfaces were natural\nvisual complements as they had the ability to show information in\nperpendicular directions. Showing streamlines and isosurfaces together was not\nperceived as being as problematic as showing multiple layers of isosurfaces,\nsince they were easier to visually differentiate.\n\n![bvis_1706.png](images/bvis_1706.png)\n\nFigure 17-6. Closeup view of hydrogen in a tetrahedral bond with four zinc\natoms (blue)\n\nIn addition to visuals, we used spatial audio for localizing the bond location\nand the user’s position in the lattice (Figure 17-7). In order to give a sonic\nidentity to the atoms, we sonified the emission spectra (the relative\nelectromagnetic radiation) of hydrogen, zinc, and oxygen by pitch-shifting\ntheir respective emission frequencies down 10 octaves to the audible range.\n\n![bvis_1707.png](images/bvis_1707.png)\n\nFigure 17-7. Researchers immersed in the hydrogen bond\n\nGiven the time-invariant and three-dimensional nature of the data, deciding\nhow to sonify it was a challenge. One solution we came up with was to scan\nthrough the density field along a parametric curve. We used a Lissajous curve,\nsince it exhibits a high degree of spatial symmetry and smoothness, minimizing\nsonic distortion. While this technique had no visual complement, it produced\ncharacteristic sounds and helped localize the bond, producing a more complete\nmultimodal experience.\n\nHydrogen Atom\n\nBy Lance Putnam and Charlie Roberts (Media Arts and Technology)\n\nFaculty Directors: Professor Luca Peliti (Kavli Institute of Theoretical\nPhysics) and Professor JoAnn Kuchera-Morin (Media Arts and Technology)\n\nWe now move from a lattice of atoms down to the electron cloud of a single\nhydrogen atom. Much is known about the shapes of single hydrogen atom\norbitals, and physicists have little trouble picturing them in their minds.\nHowever, when two or more time-varying orbitals are mixed together in\nsuperposition, the resulting electron cloud is complex and not readily\napparent from the individual equations. Furthermore, mathematical equations\nand static images do not capture the dynamics of its complex temporal\nevolution.\n\nOur aim with this work was to create a multimodal experience of a “hydrogen-\nlike” atom through interactive visualization and sonification of its electron\nwavefunction. We modeled the atomic orbitals as solutions to the time-\ndependent Schrödinger equation with a spherically symmetric potential given by\nCoulomb’s law of electrostatic force. In this model, the relationship between\nthe nucleus and electron is akin to a bowl (the nucleus) filled with liquid\n(the electron), with the difference that the liquid can have many different\nresting shapes and extend outside of the bowl. For computation, the time-\ninvariant structures of the single orbitals were precomputed and stored in a\n3D lattice; then, during the simulation, they evolved individually and were\nmixed together spatially. We programmed several preset orbital superpositions\nto observe dynamic behaviors such as photon emission and absorption.\n\nThe first visualization technique we tried was to render the electron cloud as\na 3D volume. This made it easy to see the global, outer shape of the\nwavefunction, but it was difficult to see its inner and more local structure.\nTo address this, we superimposed collections of agents on the volume rendering\nthat moved along different flows in the wavefunction. This way, we could\nsimultaneously get a sense of the global and local structure of the cloud. We\nfound that using colored lines provided a reasonable compromise among number\nof mapping dimensions, visual complexity, and computational efficiency (Figure\n17-8). Colored line agents gave us three internal dimensions of color and four\nspatial dimensions of orientation and length that we could use for mapping\npurposes. We used hue to distinguish different types of flow and orientation\nto show direction. In addition, the brightness and length of the lines were\nvaried to smoothly fade agents into and out of the scene.\n\n![bvis_1708.png](images/bvis_1708.png)\n\nFigure 17-8. Light emitting configuration of a hydrogen atom\n\nWe also wanted to use sound as a way of notifying us of certain types of\nevents—such as the emergence or dissipation of certain types of\nshapes—occurring within the cloud. To do this, we used a slight variation on a\nsynthesis technique called scanned synthesis. We scanned along the agents like\na read head on an audio tape loop and listened to the wavefunction amplitude\nat their locations. By changing the scan rate, we could change the pitch of\nthe sound. Lower pitches worked best at revealing the local variations in\nshape, while higher pitches worked best at indicating global characteristics.\nWe also found it effective to assign different pitch classes (pitches a whole\nnumber of octaves apart) to the different types of agents so that they could\nbe sonically distinguished from one another. This scanning method was\nsuccessful in alerting us when and where a cluster of agents formed at a\nsingularity or attractor basin, but did not work so well at informing us about\nthe particular shape formed. Our solution to representing the system more\nholistically was not to augment single modalities, but to take a multimodal\napproach, leaving overall shape to visuals and emergence of local structures\nover time to sound.\n\nAn unexpected outcome of doing this representation was seeing a drastic change\nin the complexity and richness of the wavefunction patterns going from single\norbitals to mixtures (Figure 17-9). The composite patterns that emerged had no\nobvious relation to the parts and were not at all evident from the\nmathematical equations. We found that interference of waves, a simple and\nwell-known physical mechanism, can serve as a powerful construct when thinking\nabout the creation of complex patterns and emergent behavior.\n\n![bvis_1709.png](images/bvis_1709.png)\n\nFigure 17-9. Higher-order orbital mixture of a hydrogen atom\n\nHydrogen Atom with Spin\n\nBy Lance Putnam (Media Arts and Technology)\n\nFaculty Directors: Professor Luca Peliti (Kavli Institute of Theoretical\nPhysics) and Professor JoAnn Kuchera-Morin (Media Arts and Technology)\n\nWith this project, we desired to expand on the previous hydrogen atom project\nby using a more complete physical model that included the spin quantum number.\nWe also wanted to move away from the regular sampling in space of the\nwavefunction toward something with finer spatial resolution. We decided it\nwould be best to not precompute and store the orbitals ahead of time, but\ninstead to compute everything on the fly so that we could get the exact values\nof the wavefunction at all points in space. In this sense, the computational\nrepresentation of the wavefunction changed from a lattice of values to a\nfunction of position. This new approach also gave us a new perspective on\nagents as a general-purpose visualization and sonification tool. The agents\ncould not only show the derived flows of the wavefunction through their\nindividual movements, but also represent something about its state, such as\nits oscillation phases. Furthermore, the agents could be programmed to act in\nan ensemble-like manner to create smoother and more connected shapes.\n\nWe started by positioning the line agents on a grid and then modifying their\norientation and length based on the underlying wavefunction amplitude. While\nthis gave us a good sense of global characteristics, we found the spatial\nartifacts (Moiré patterns), due to their regular positioning in space, to be\nvisually disturbing and misleading. To avoid these artifacts, we next tried to\nrandomly position the agents within a cube. This succeeded in eliminating the\nartifacts, but uncovered two more serious and fundamental problems. First of\nall, we found it difficult to visually fuse all the individual agents into a\ncoherent form from their individual line shapes. Second, we found that\ndistributing the agents uniformly in 3D space does not lend itself to a\nnatural method of sonification. While we could use separate spatial structures\nfor visualization and sonification, we had found in previous projects—namely,\nthe hydrogen bond project—that an underlying connectedness between aural and\nvisual representation is important for comprehending the scene.\n\nOur solution to these connectivity problems was to arrange the line agents\ninto a loop and keep the agents connected to one another by putting springs\nbetween them. This gave us an elastic ribbon that would remain smooth and\nconnected, but still have enough freedom to move through the space and show\nlocal properties of the measured field. The width of the loop was mapped to\nthe probability density so that sharp spikes would indicate a high probability\nof finding the electron at that position (Figure 17-10). The loop also worked\nwell for showing wavefunction states that were more distributed throughout\nspace (Figure 17-11).\n\n![bvis_1710.png](images/bvis_1710.png)\n\nFigure 17-10. Constructive interference between orbitals of a hydrogen atom\nwith spin\n\n![bvis_1711.png](images/bvis_1711.png)\n\nFigure 17-11. Outer shell mixture of a hydrogen atom with spin\n\nThe loop, being smooth, also permitted a desirable shape for scanning through\nthe agents for sonification, as was done with the spinless atom. Visually, the\nloop provided a good compromise between transparency, coherency of shape, and\ndepiction of global and local attributes.\n\nCoherent Precession of Electron Spin\n\nBy Dennis Adderton and Lance Putnam (Media Arts and Technology), and Jesse\nBerezovsky (Center for Spintronics and Quantum Computing)\n\nFaculty Directors: Professor JoAnn Kuchera-Morin (Media Arts and Technology)\nand Professor David Awschalom (Center for Spintronics and Quantum Computing)\n\nThe goal of this project was to represent the coherent precession, or change\nin rotation, of an electron spin within a quantum dot. Seeking out the most\ncapable apparatus for measuring the result of quantum coherence in just such a\nnanoscale device, we visited the spintronics lab in the UCSB Physics\ndepartment to learn about Kerr rotation microscopy. This is an optical\nexperiment wherein a very fast laser pulse is focused onto a semiconductor\nquantum device. The polarization of the pulse induces coherent precession of a\nsingle electron spin in the quantum dot. A subsequent pulse measures the\nrotating polarization of the quantum dot to capture a picture of the\nprecessing spin. From this measurement, it is possible to quantify a\ncharacteristic decay time for quantum coherence in the device. Decoherence of\nthe quantum state marks the transition from the quantum to the classical\nworld.\n\nTo represent the phenomena of the experiment through sonification, we slowed\nit down one million times. This allowed us to hear the tone of the electron\nand the buzz of the pulsing laser. To visualize the phenomena of spin\nprecession, we plotted phase angle on the Bloch sphere, a standard graphical\ntool for physicists. At this point, we relied on a simple equation from a\npublished experiment (Berezovsky 2008) to give the three-dimensional dynamics\n(Figure 17-12).\n\n![bvis_1712.png](images/bvis_1712.png)\n\nFigure 17-12. Multiple perspectives on Bloch sphere showing spin precession\n\nThis rudimentary test stimulated our senses but immediately revealed an overly\nsimple aspect of the model that was not obvious from the outset. Although the\nprecession made interesting spherical patterns visually, its temporal\ncomponents were predominantly sinusoidal and quickly became boring to listen\nto. It became clear that a more complex system was required to immerse us in a\nquantum reality.\n\nTo engage our senses, we require a more complete quantum mechanical model of\nnature, rather than a simplified model of the experiment. Representing a\ntheoretical model requires interpretation. Aural and visual analogies are\nmade. As an artist, there is a need to construct an artifact so that something\ntangible can be discussed. The artwork becomes a philosophical apparatus in\nthe discourse of truth—a truth connected directly to the mathematics that is\nbeing visualized and sonified.\n\nThese works serve as a basis for our philosophical premise that beautiful\nvisualization is connected to the visualization and sonification of complex\nmathematical systems that make and break symmetry.\n\nConclusion\n\nIn the AlloSphere, visualization transforms into beautiful immersive\nmultimodal representation, transformation, and creation, resulting in the\nevolution of a unique field. This new field merges the different criteria and\nmetrics of art and science—art as speculation, generation, and transformation,\nand science as model/theory building and validation. As we move forward with\nour research, a new, yet “classical,” style of thought is unfolding that\nintegrates science and art into a new environment: a place where new art and\nnew technology emerge in mutual adaptation. As this emerging field and its\ncomputation-driven medium develop, the distinction among artists, scientists,\nand engineers begins to disappear and we realize that we are all engineers,\nscientists, and artists—we all design, analyze, and create.\n\nReferences\n\nBaddeley, Alan. 2000. “A new component of working memory?” Trends in Cognitive\nSciences 4, no. 11: 417–423.\n\nBerezovsky, J., M.H. Mikkelsen, N.G. Stoltz, L.A. Coldren, and D.D. Awschalom.\n2008. “Picosecond coherent optical manipulation of a single electron spin in a\nquantum dot.” Science 320, no. 5874: 349–352.\n\nBoy, Werner. 1901. “Über die curvatura integra und die topologie der\ngeschlossener flachen.” PhD diss., Universität Göttingen, Göttingen.\n\nTatarkiewicz, Wladyslaw. 1972. “The great theory of beauty and its decline.”\nJournal of Aesthetics and Art Criticism 31, no. 2: 165–180.\n\nWeyl, Hermann. 1952. Symmetry. Princeton, NJ: Princeton University Press.\n\n[1] The field of Artificial Life, for example, attempts to better understand\nlife by attempting to reconstruct its processes in digito, but has brought\nwith it a fascinating discussion of creativity itself.\n\n\nChapter Eighteen\n\nPostmortem Visualization:  \nThe Real Gold Standard\n\nAnders Persson\n\nThis chapter’s topic is extremely important to those who work in the field of\nmedical information visualization. Emerging technologies are enabling visual\nrepresentations and interaction techniques that take advantage of the human\neye’s broad-bandwidth pathway into the mind, allowing users to see, explore,\nunderstand, and validate large amounts of complex information at once.\n\nA striking feature of both clinical routine and medical research today is the\noverwhelming amount of information—particularly, information represented as\nimages. Practitioners are dealing with ever-larger numbers of images (hundreds\nor thousands rather than dozens) and more complex, higher-dimensional\ninformation (vectors or tensors rather than scalar values, arranged in image\nvolumes directly corresponding to the anatomy rather than flat images).\nHowever, they typically still use simple two-dimensional devices such as\nconventional monitors to review this overflow of images, one by one. As the\nbottleneck is no longer the acquisition of data, future progress will depend\non the development of appropriate methods for handling and analyzing the\ninformation, as well as making it comprehensible to users. One of the most\nimportant issues for the future is the workflow. The entire chain from the\nacquisition of data until the point at which the clinician receives the\ndiagnostic information must be optimized, and new methods must be validated.\n\nNormally, performing this validation process on living patients has its\nlimitations. It can in some cases be impossible to know if the acquired\ndiagnostic information is correct as long as the patient is alive; the real\ngold standard is missing. Postmortem imaging has the potential to solve this\nproblem.\n\nThe methodology of autopsy has not undergone any major transformation since\nits introduction in the middle of the 19th century. However, new radiological\ndigital imaging methods, such as multidetector computed tomography (MDCT) and\nmagnetic resonance imaging (MRI), have the potential to become the main\ndiagnostic tools in clinical and forensic pathology in the future. Postmortem\nvisualization may prove to be a crucial tool in shaping tomorrow’s healthcare,\nby validating new imaging technology and for quality assurance issues.\n\nBackground\n\nThe importance of autopsy procedures leading to the establishment of the cause\nof death is well known. In forensic cases, the autopsy can provide key\ninformation and guide the criminal investigation. The decreasing trend in the\nfrequency of autopsies over the past years has become a serious issue.\n\nA recent addition to the autopsy workflow is the possibility of conducting\npostmortem imaging—in its 3D version, also called virtual autopsy (VA)—using\nMDCT or MRI data from scans of cadavers and with direct volume rendering (DVR)\n3D techniques. At the foundation of the VA development are the modern imaging\nmodalities that can generate large, high-quality datasets with submillimeter\nprecision. Interactive visualization of these 3D datasets can provide valuable\ninsight into the corpses and enables noninvasive diagnostic procedures.\nEfficient handling and analysis of the datasets is, however, problematic. For\ninstance, in postmortem CT imaging, not being limited by a certain radiation\ndose per patient means the datasets can be generated with such a high\nresolution that they become difficult to handle in today’s archive retrieval\nand interactive visualization systems, specifically in the case of full body\nscans.\n\nSeveral studies have shown the great potential of virtual autopsy in forensic\ninvestigations. This chapter will investigate several of the reasons for the\nrising interest in VA.\n\nImpact on Forensic Work\n\nThe main questions to be assessed in examinations of the deceased are the\ncause and manner of death and the severity of injuries suffered, as well as\nthe possibility of forensic reconstructions based on the obtained findings.\nForensic documentation of postmortem findings is predominantly based on the\nsame autopsy techniques and protocols that have been used for centuries. The\nmain tools used are scalpels, verbal descriptions, and photographs. A major\ndisadvantage of this approach is that the documentation happens in a\nhaphazard, subjective, and observer-dependent manner. Any findings that have\nnot been documented are irreparably destroyed when the cadaver is sent to the\ncrematory. Modern cross-sectional imaging techniques can overcome these\nshortcomings, as they provide datasets of cadavers that contain the findings\nin real dimensions and are storable for the future (Figures 18-1 and 18-2).\nThe digitally acquired data can be referred to at any time as new questions\narise, or may be sent to additional experts for a second opinion.\n\n![bvis_1801.png](images/bvis_1801.png)\n\nFigure 18-1. Metal objects can easily be located in the body with computed\ntomography. In this murder case, there is a knife that penetrates the face,\nbut CT proved that this was not the cause of death.\n\n![bvis_1802.png](images/bvis_1802.png)\n\nFigure 18-2. This image shows the cause of death in another case, where the\nvictim was stabbed through the heart with a kitchen knife.\n\nSome findings that are difficult to visualize in a conventional autopsy can\neasily be seen in a full body CT, such as air distribution within the\nbody—e.g., in the pneumothorax, pneumopericardium, bloodstream (air embolism),\nand wound channels (Figure 18-3). A CT can also be invaluable for locating\nforeign objects such as metal fragments and bullets, which are of great\nimportance for the forensic pathologist (Figure 18-4).\n\n![bvis_1803.png](images/bvis_1803.png)\n\nFigure 18-3. The acquired CT data can be visualized interactively with\ndifferent parameter settings: in this case, soft tissue to the left and air\ndistribution in the body to the right.\n\n![bvis_1804.png](images/bvis_1804.png)\n\nFigure 18-4. Tiny lead fragments from a shotgun can easily be visualized with\npostmortem CT. In a conventional autopsy, these fragments can be difficult or\neven impossible to find.\n\nThe Virtual Autopsy Procedure\n\nThe Center for Medical Image Science and Visualization (CMIV) at Linköping\nUniversity Hospital in Sweden, in collaboration with the Swedish National\nBoard of Forensic Medicine, has developed a procedure for virtual autopsy that\nis now used routinely for forensic work. This method has been in use since\n2003 and has been applied to over 300 cases so far (mostly homicides). Our\nexperience with VA has shown that full-body, high-resolution DVR\nvisualizations are of great value in criminal investigations and for the\nvalidation of new technologies on living patients. Our work has focused on the\ntotal workflow for postmortem MDCT and on developing a new type of software\nthat can visualize full-body datasets that could previously only be viewed in\nseparate parts and with limited interactivity (Figures 18-5 to 18-7).\n\n![bvis_1805.png](images/bvis_1805.png)\n\nFigure 18-5. After a conventional autopsy, it is impossible to go back.\nFindings that have not been documented are irreparably destroyed when the\ncadaver is sent to the crematory.\n\n![bvis_1806.png](images/bvis_1806.png)\n\nFigure 18-6. With CT and/or MRI added to the pipeline, it is always possible\nto go back and redo the virtual autopsy. The digitally acquired data can be\nreferred to at any time when new questions arise, and may be sent to experts\nfor a second opinion.\n\n![bvis_1807.png](images/bvis_1807.png)\n\nFigure 18-7. There is a turf battle between the CSI guys and the police\nregarding keeping the body in the cold storage room. The police are keen on\nhaving the autopsy done as soon as possible. The CSI guys try to close the\ncrime scene investigation before the autopsy takes place. Postmortem imaging\nsolves this problem. A preliminary report from the postmortem CT examination\nmakes it possible to preserve the body in the cold storage room.\n\nData Acquisition\n\nThe traditional physical autopsy at CMIV is extended by adding the CT and MRI\nas VA activities. In most cases, the forensic pathologist comes to the crime\nscene and oversees the handling of the human cadaver, which is placed in a\nsealed body bag before being transported to the forensic department and put in\ncold storage. The following morning, a full-body dual source CT (DSCT) scan is\nperformed at CMIV with a state-of-the-art SOMATOM Definition Flash scanner\n(from Siemens Medical Solutions in Germany). Currently, both single- and dual-\nenergy modes are used for virtual autopsy cases; see Figure 18-8(a) and (b).\nIn selected cases, an MRI examination is also performed (using an Achieva 1.5T\nscanner, from Philips Medical Systems in The Netherlands). All children are\nroutinely examined with MRI, because it offers superior visualization of the\nbrain compared to DSCT (Figure 18-9). The cadaver remains in the body bag\nthroughout the virtual autopsy procedure to ensure the security of technical\nevidence of forensic value, such as fibers and body fluids, and to avoid\ncontamination.\n\n![bvis_1808a.png](images/bvis_1808a.png)\n![bvis_1808b.png](images/bvis_1808b.png)\n\nFigure 18-8. (a) A state-of-the-art dual source computed tomography scanner\nwith dual energy possibilities. (b) A magnetic resonance scanner. Both\nscanners are used for virtual autopsies at CMIV.\n\n![bvis_1809.png](images/bvis_1809.png)\n\nFigure 18-9. Dual energy CT of a small child who has been shot. Note the\nexcellent visualization of the bullet and the bullet track. Easy to present in\nthe courtroom.\n\nComputed tomography: Use of dual energy CT\n\nDual energy CT (DECT) with two x-ray sources running simultaneously at\ndifferent energies can acquire two datasets showing different attenuation\nlevels. DECT allows additional information about the elementary chemical\ncomposition of CT-scanned material to be obtained. Compton scattering can be\ndetermined by using two different average photo energies, which correspond to\ntwo different tube voltages (80 and 140 kV). In other words, x-ray absorption\nis energy-dependent—e.g., scanning an object with 80 kV results in a different\nattenuation than scanning it with 140 kV. This physics phenomenon can help to\ndiscriminate between materials with similar atomic numbers, such as calcium\nand iodine contrast. Colors can then be assigned according to changes in the\nCT numbers between the two energy settings, and the resulting color-mapped,\ndual-energy image can differentiate between calcifications and iodine\ncontrast.\n\nThis technique can also be used to better visualize postmortem blood clots in\nvessels, and possibly bleeding in soft tissue. The material-specific\ndifference in attenuation shown in the resulting image could facilitate\nclassifications of different tissue types such as blood, soft tissue, tendons,\nand cartilage (Figure 18-10).\n\n![bvis_1810.png](images/bvis_1810.png)\n\nFigure 18-10. Tendons examined with dual energy CT. Tendons and small vessels\ncan be visualized without IV contrast. Ligaments between the carpal bones are\nvisualized.\n\nDECT has the potential to be an important diagnostic tool in the healthcare of\ntomorrow. However, further research needs to be done to explore this new\ntechnique. VA can speed up this research.\n\nMRI: Use of synthetic magnetic resonance imaging\n\nIt is difficult to generate good contrast MRI images on dead, cold bodies—body\ntemperature influences the MR relaxation times of all tissues, and hence\nclinically established protocols need to be adjusted for optimal image quality\nat any given temperature. This problem can be solved by measurement of the\nabsolute MR tissue parameters for tissue characterization, T1, T2, and proton\ndensity (PD).\n\nSince this can be difficult to implement on a clinical MRI scanner, a new\napproach has been invented at CMIV called synthetic MRI. In this approach, the\nthree absolute parameters are translated into ordinary MR contrast images\n(Figures 18-11 and 18-12). A color scale can be used such that each tissue\nacquires a specific color composition depending on its MR tissue parameters,\nindependent of body temperature. Since the MR parameters are absolute, an\nidentical color transformation will lead to a specific color-to-tissue\nrelation, and a visual segmentation of tissue. Especially for postmortem\nimaging, this is important, since the image contrast may vary dramatically\nwith temperature (Figure 18-12).\n\n![bvis_1811.png](images/bvis_1811.png)\n\nFigure 18-11. Example of synthetic MRI on a living patient: the upper row are\nconventional images and the lower row are the synthetic counterpart based on a\nsingle dataset.\n\n![bvis_1812.png](images/bvis_1812.png)\n\nFigure 18-12. Full-body synthetic MRI scan. The contrast can be synthesized,\nthe tissue can be segmented, and based on the MR parameters even temperature\ncan be established.\n\nPostmortem examinations do not suffer from motion artifacts, and high-\nresolution images can be obtained with a long scan time. An example is shown\nin Figure 18-13, which shows a head shot wound in 1.2 mm isotropic resolution.\nSince synthetic MRI is based on absolute values, it can be used to render 3D\nimages with CT postprocessing software, resulting in the volume renderings\ndisplayed in Figures 18-13 and 18-14.\n\n![bvis_1813a.png](images/bvis_1813a.png)\n\n![bvis_1813b.png](images/bvis_1813b.png)\n\nFigure 18-13. Postmortem synthetic MRI examination of a gunshot wound in high\nisotropic resolution. Red color in the lefthand image represents blood.\n\n![bvis_1814.png](images/bvis_1814.png)\n\nFigure 18-14. Automatic segmentation of cerebrospinal fluid (19.8 ml for this\nslice) and pathology (1.9 ml for this slice) with synthetic MRI.\n\nVisualization: Image Analysis\n\nIn preparation for the physical autopsy, the pathologist and the radiologist\nconduct a collaborative DVR session. They can obtain a clear survey of the\nentire body quickly, and localize fractures and air pockets. The full-body\nprocedure permits fast localization of foreign objects such as metal fragments\nor bullets. Another important aspect is the high resolution of the data,\nwhich, in a seamless visualization, allows details such as dental information\nto be extracted for identification purposes (Figure 18-15). This can provide\nessential information in the early part of a police investigation. After\nscanning, the forensic personnel leave CMIV and start the conventional\nautopsy. Data from the collaborative DVR session is transferred to the\nforensic institute for them to use, and if more information is needed later,\nnew contact with the radiologist is made.\n\n![bvis_1815.png](images/bvis_1815.png)\n\nFigure 18-15. With volume rendering 3D, it is possible to interactively change\nsettings so that the body can be visualized seamlessly, from skin to skeleton.\n\nObjective Documentation\n\nAn important added value of the virtual autopsy procedure is that the captured\nDSCT data is stored, which enables the procedure to be iterated. Often,\nfindings during the physical autopsy lead to new questions that the VA can\nanswer. The pathologist and the crime investigators can also—at any point\nduring the investigation—re-examine the cadaver and search for additional\ninformation (Figure 18-16). Moreover, in crime scene investigations, new\nfindings may require other hypotheses to be scrutinized by postmortal imaging.\n\n![bvis_1816.png](images/bvis_1816.png)\n\nFigure 18-16. Dual energy CT of the heart and the coronary arteries. More\nplaque components can be visualized with dual energy compared to conventional\nsingle energy images (red circle).\n\nVA is currently used as a complement to the autopsy procedure. It should,\nhowever, be noted that the workflow overhead introduced is minimal, as the\ntime needed for the DSCT scan and visualization session is short in comparison\nto the physical autopsy, and that it can make the autopsy more efficient\nbecause the pathologist will have prior knowledge of the case before beginning\nthe autopsy. That the cadaver remains in a sealed body bag throughout the VA\nprocedure also secures technical evidence, such as fibers and body fluids,\nwhich in forensic cases may be of great importance.\n\nAdvantages and Disadvantages of Virtual Autopsy\n\nLet’s take a look at the advantages of VA compared with conventional\nautopsies:\n\n  * It is time-saving. The VA can be a complement to standard autopsies, enabling broad, systematic examinations of the whole body that are normally difficult and time consuming; for example, an examination of the entire bone structure or searching for the presence of air in the body (Figures 18-3 and 18-4).\n  * It is noninvasive. Once an invasive traditional autopsy has taken place, the body cannot be reassembled in its original state, thus precluding other forensic pathologists from conducting a fresh analysis on the same body (Figures 18-5 through 18-7). \n  * A traditional autopsy may be rejected by family members, perhaps due to religious beliefs that prohibit the desecration of the remains of a deceased person. For example, Orthodox Judaism prohibits disturbing dead bodies except when such action may save others, and decrees that practices such as organ removal should be avoided. Islam is likewise opposed to desecrating or even exposing the body of a deceased believer.\n  * Autopsy protocols and photographs used as evidence in criminal cases can be difficult for jurors to understand. VA visualizations are typically clearer (Figures 18-4 and 18-9). \n  * Storage of VA data poses few problems, whereas autopsy records such as tissue sections are difficult to store indefinitely (Figure 18-16).\n  * With potential global pandemics such as bird flu (avian influenza A) and swine flu (the H1N1 virus) posing an increasing threat, the practice of eviscerating the victims can pose serious health risks to coroners, pathologists, and medical examiners. With a VA, these risks are minimized.\n\nHowever, virtual autopsies also have several shortcomings:\n\n  * For MDCT, soft tissue discrimination is low. Energy-resolved CT (DECT) has the potential to resolve this problem (Figure 18-10). \n  * The large amount of data produced is a problem to analyze, but better and faster postprocessing programs should solve this.\n  * MRI is a time-consuming investigation and not optimal on a cold body. Synthetic MRI is a promising alternative (Figure 18-14).\n  * Postmortem imaging with MDCT and MRI does not give any color documentation of the body. It may be possible to solve this issue with new volume-rendering 3D methods and body surface scanning (Figure 18-15).\n  * Macro morphology is absent (no histology and chemistry). This can be solved to a certain extent with MDCT guided biopsies or magnetic resonance spectroscopy (Figure 18-16).\n  * Circulation and possible bleeding points are difficult to visualize, although promising results have been achieved with postmortem angiography. As has been shown, postmortem CT angiography can be a feasible way to obtain more information from the VA (Figure 18-17).\n  * Postmortal gas can be difficult to distinguish from other types of gas (bowel gas, gas in wound channels, etc.). Therefore, it is important to execute the postmortem imaging examination soon after death has occurred (Figure 18-18).\n\n![bvis_1817a.png](images/bvis_1817a.png)\n\n![bvis_1817c.png](images/bvis_1817c.png)\n\n![bvis_1817e.png](images/bvis_1817e.png)\n\n![bvis_1817d.png](images/bvis_1817d.png)\n\n![bvis_1817b.png](images/bvis_1817b.png)\n\nFigure 18-17. Contrast injected in arteries postmortem with good results in\nhorse and antelope. Data has been acquired with dual energy CT.\n\n![bvis_1818.png](images/bvis_1818.png)\n\nFigure 18-18. With conventional autopsies, different kinds of body gases are\ndifficult to examine.\n\nThe Future for Virtual Autopsies\n\nBoth MDCT and MRI can be used for postmortem imaging. In principle, it is easy\nto visualize bone, gas, and metal with MDCT. However, it is important to be\naware of not only the capabilities, but also the limitations of these\ntechnologies.\n\nVisualization research in the future must include the overall aim of\nimplementing a virtual autopsy workstation that includes everything needed to\nperform state-of-the-art virtual autopsies. Visualization tools to increase\nthe quality and efficiency of virtual autopsy procedures need to be developed.\nResearch and development efforts focusing on novel rendering and\nclassification techniques are also needed to improve usability and to\nspecifically address forensic questions. Another important goal is to\nestablish designated protocols for the main forensic case categories.\n\nThe data analysis research includes the implementation of computer-aided\ndiagnostic tools that can, once applied to the postmortem data, help search\nfor and characterize relevant forensic findings. These tools can also deliver\ngeneral information about the deceased individual such as height, body weight,\nsex, major injuries, foreign bodies (e.g., projectiles), and likely causes of\ndeath in an automatically generated preliminary, written virtual autopsy\nprotocol.\n\nWhen all of these tasks have been successfully addressed, the technology\ninvolved within all processes of a virtual autopsy can be improved to enable\nautomation of the entire workflow. This will allow for virtual autopsies to be\nperformed in large numbers within a reasonable time frame. This would be\ninvaluable in handling incidents with significant numbers of victims such as\nthose created by the tsunami catastrophe in Asia in 2004, where no autopsies\nwere performed at all.\n\nAs terrorists improve their applied technologies day by day, it is unthinkable\nthat forensic pathologists should not also be able to make use of emerging\ntechnologies in order to gather as much information as possible from their\nvictims (Figure 18-19). In times where no one can really feel safe, we should\nnot only focus on the prevention of catastrophe, but also prepare ourselves to\nhandle disasters adequately when they do occur.\n\n![bvis_1819.png](images/bvis_1819.png)\n\nFigure 18-19. Postmortem CT of a burned person. Metal in the body makes it\nimpossible to use MRI. Before the CT examination, there was no suspicion of\nmurder, but several fractures that could not be explained pointed the\ninvestigators in the right direction—murder!\n\nFor a new era of digital autopsies to truly emerge, several forces must work\nin unison. Medical professionals and legal authorities must determine standard\nprotocols for scanning and storing data. Legal systems around the world must\naccept the admissibility of imaging evidence in determining the cause and\nmanner of death. Also, specialists in new fields such as postmortem radiology\nwill need to be trained. Radiologists are typically trained to interpret\nimages of living patients, but the dead often look different; severe trauma or\nthe effects of decomposition can displace organs. Understanding these\ndifferences will require knowledge and expertise that does not exist on a\nwidespread basis today.\n\nInvasive autopsies will likely remain the norm for at least the next few\nyears. However, in some cases, we may begin to see traditional autopsies being\nreplaced by noninvasive virtual autopsies, with minimally invasive, image-\nguided tissue sampling conducted when necessary. Postmortem VA has the\npotential to gain high acceptance in the population compared with the\ntraditional autopsy, making it possible to maintain high levels of quality\ncontrol in forensic and traditional medicine.\n\nConclusion\n\nThe virtual autopsy is a newly developed procedure that will enhance the\nclassic autopsy, giving it the capacity to achieve more reliable results. In\nsome cases, the virtual autopsy could also replace the normal autopsy.\nResearch on the unique aspects of postmortem radiology must, however, be\nundertaken to identify cases in which its use is most beneficial and to\nvalidate the new procedures. Clearly, the introduction of this new autopsy\nmethod is likely to have a major impact on forensic medicine, the judicial\nsystem, the police, and general medicine in the future.\n\nReferences and Suggested Reading\n\nDonchin, Y., A.I. Rivkind, J. Bar-Ziv, J. Hiss, J. Almog, and M. Drescher.\n1994. “Utility of postmortem computed tomography in trauma victims.” Journal\nof Trauma 37, no. 4: 552–555.\n\nEtlik, Ö., O. Temizöz, A. Dogan, M. Kayan, H. Arslan, and Ö. Unal. 2004.\n“Three-dimensional volume rendering imaging in detection of bone fractures.”\nEuropean Journal of General Medicine 1, no. 4: 48–52.\n\nJackowski, C. 2003. “Macroscopical and histological findings in comparison\nwith CT- and MRI- examinations of isolated autopsy hearts.” Thesis, Institute\nof Forensic Medicine. O.-v.-G.-University of Magdeburg.\n\nJackowski, C., A. Persson, and M. Thali. 2008. “Whole body postmortem\nangiography with a high viscosity contrast agent solution using poly ethylene\nglycol (PEG) as contrast agent dissolver.” Journal of Forensic Sciences 53,\nno. 2: 465–468.\n\nJackowski, C., W. Schweitzer, M. Thali, K. Yen, E. Aghayev, M. Sonnenschein,\nP. Vock, and R. Dirnhofer. 2005. “Virtopsy: Postmortem imaging of the human\nheart in situ using MSCT and MRI.” Forensic Science International 149, no. 1:\n11–23.\n\nJackowski, C., M. Sonnenschein, M. Thali, E. Aghayev, G. von Allmen, K. Yen,\nR. Dirnhofer, and P. Vock. 2005. “Virtopsy: Postmortem minimally invasive\nangiography using cross section techniques—Implementation and preliminary\nresults.” Journal of Forensic Sciences 50, no. 5: 1175–1186.\n\nKerner, T., G. Fritz, A. Unterberg, and K. Falke. 2003. “Pulmonary air\nembolism in severe head injury.” Resuscitation 56, no. 1: 111–115.\n\nLjung, P., C. Winskog, A. Persson, C. Lundstrom, and A. Ynnerman. 2006\\.\n“Full-body virtual autopsies using a state-of-the-art volume rendering\npipeline.” IEEE Transactions on Visualization and Computer Graphics 12, no. 5:\n869–876.\n\nOliver, W.R., A.S. Chancellor, M. Soltys, J. Symon, T. Cullip, J. Rosenman, R.\nHellman, A. Boxwala, and W. Gormley. 1995. “Three-dimensional reconstruction\nof a bullet path: Validation by computed radiography.”Journal of Forensic\nSciences, 40, no. 2: 321–324.\n\nRos, P.R., K.C. Li, P. Vo, H. Baer, and E.V. Staab. 1990. “Preautopsy magnetic\nresonance imaging: Initial experience.” Magnetic Resonance Imaging 8: 303–308.\n\nThali, M., W. Schweitzer, K. Yen, P. Vock, C. Ozdoba, E. Spielvogel, and R.\nDirnhofer. 2003. “New horizons in forensic radiology: The 60-second digital\nautopsy-full-body examination of a gunshot victim by multislice computed\ntomography.” The American Journal of Forensic Medicine and Pathology 24:\n22–27.\n\nThali, M., U. Taubenreuther, M. Karolczak, M. Braun, W. Brueschweiler, W.\nKalender, and R. Dirnhofer. 2003. “Forensic microradiology: Micro-computed\ntomography (Micro-CT) and analysis of patterned injuries inside of bone.”\nJournal of Forensic Sciences 48, no. 6: 1336–1342.\n\nThali, M., K. Yen, W. Schweitzer, P. Vock, C. Boesch, C. Ozdoba, G. Schroth,\nM. Ith, M. Sonnenschein, T. Doernhoefer, E. Scheurer, T. Plattner, and R.\nDirnhofer. 2003. “Virtopsy, a new imaging horizon in forensic pathology:\nVirtual autopsy by postmortem multislice computed tomography (MSCT) and\nmagnetic resonance imaging (MRI)—a feasibility study.” Journal of Forensic\nSciences 48, no. 2: 386–403.\n\nYen, K., P. Vock, B. Tiefenthaler, G. Ranner, E. Scheurer, M. Thali, K.\nZwygart, M. Sonnenschein, M. Wiltgen, and R. Dirnhofer. 2004. “Virtopsy:\nForensic traumatology of the subcutaneous fatty tissue; Multislice Computed\nTomography (MSCT) and Magnetic Resonance Imaging (MRI) as diagnostic tools.”\nJournal of Forensic Sciences 49, no. 4: 799–806.\n\n\nChapter Nineteen\n\nAnimation for Visualization: Opportunities and Drawbacks\n\nDanyel Fisher\n\nDoes animation help build richer, more vivid, and more understandable\nvisualizations, or simply confuse things?\n\nThe use of Java, Flash, Silverlight, and JavaScript on the Web has made it\neasier to distribute animated, interactive visualizations. Many visualizers\nare beginning to think about how to make their visualizations more compelling\nwith animation. There are many good guides on how to make static\nvisualizations more effective, and many applications support interactivity\nwell. But animated visualization is still a new area; there is little\nconsensus on what makes for a good animation.\n\nThe intuition behind animation seems clear enough: if a two-dimensional image\nis good, then a moving image should be better. Movement is familiar: we are\naccustomed to both moving through the real world and seeing things in it move\nsmoothly. All around us, items move, grow, and change color in ways that we\nunderstand deeply and richly.\n\nIn a visualization, animation might help a viewer work through the logic\nbehind an idea by showing the intermediate steps and transitions, or show how\ndata collected over time changes. A moving image might offer a fresh\nperspective, or invite users to look deeper into the data presented. An\nanimation might also smooth the change between two views, even if there is no\ntemporal component to the data.\n\nAs an example, let's take a look at Jonathan Harris and Sep Kamvar's We Feel\nFine animated visualization (<http://wefeelfine.org>). In this visualization,\nblog entries mentioning feelings are represented as bubbles. As users move\nbetween views, the bubbles are reorganized into histograms and other patterns.\nFor example, one screen shows the relative distribution of blog entries from\nmen and women, while another shows the relative distribution of moods in the\nblog entries. While the bubbles fly around the screen freely, there are always\na constant number on the screen. This constancy helps reinforce the idea of a\nsample population being organized in different ways. Animation is also used to\nevoke emotion: the bubbles quiver with energy, with those that represent\n\"happy\" moving differently than bubbles that represent \"sad.\"\n\nNot all animations are successful, though. Far too many applications simply\nborrow the worst of PowerPoint, flying data points across the screen with no\nclear purpose; elements sweep and grow and rotate through meaningless spaces,\nand generally only cause confusion.\n\nI have had several occasions to build animated visualizations. In 2000, I\nworked with fellow grad students building GnuTellaVision, which visualized the\ngrowing Gnutella peer-to-peer network. Since then, I have been involved in a\nvariety of projects that have shed light on animated visualization: for\nexample, I worked on a project that explored animated scatterplots, and I was\na close bystander on the DynaVis project, which looked at transitions between\ndifferent visualizations. In this chapter, I will talk through some of these\nexperiences and to try to develop some principles for animating\nvisualizations.\n\nAnimation can be a powerful technique when used appropriately, but it can be\nvery bad when used poorly. Some animations can enhance the visual appeal of\nthe visualization being presented, but may make exploration of the dataset\nmore difficult; other animated visualizations facilitate exploration. This\nchapter attempts to work out a framework for designing effective animated\nvisualizations. We'll begin by looking at some background material, and then\nmove on to a discussion of one of the most well-known animated visualizations,\nHans Rosling's GapMinder. One of the projects I worked on explored animated\nscatterplots like GapMinder; this makes a fine launching point to discuss both\nsuccesses and failures with animation. As we'll see, successful animations can\ndisplay a variety of types of transformations. The DynaVis project helps\nillustrate how some of these transitions and transformations can work out. The\nchapter concludes by laying out a number of design principles for\nvisualizations.\n\nPrinciples of Animation\n\nAt its core, any animation entails showing a viewer a series of images in\nrapid succession. The viewer assembles these images, trying to build a\ncoherent idea of what occurred between them. The perceptual system notes the\nchanges between frames, so an animation can be understood as a series of\nvisual changes between frames. When there are a small number of changes, it is\nquite simple to understand what has happened, and the viewer can trace the\nchanges easily. When there are a large number of changes, it gets more\ncomplex.\n\nThe Gestalt perceptual principle of common fate states that viewers will group\nlarge numbers of objects together, labeling them all as a group, if they are\ntraveling in the same direction and at the same speed. Individual objects that\ntake their own trajectories will be seen as isolates, and will visually stand\nout. If all the items move in different directions, however, observers have\nfar more difficulty following them. Perception researchers have shown that\nviewers have difficulty tracking more than four or five objects\nindependently—the eye gives up, tracking only a few objects and labeling other\nmovement as noise (Cavanagh and Alvarez 2005).\n\nAnimation in Scientific Visualization\n\nAttendees at the annual IEEE VisWeek conference—the research summit for\nvisualization—are divided into two groups: information visualizers and\nscientific visualizers. The two groups give different talks, sit in different\nrooms, and sometimes sit at different tables at meals. Watching the talks, one\nquickly notices that roughly half of the papers in the scientific\nvisualization room feature animation, while almost no papers in the\ninformation visualization room do. You could say that the difference between\nthe groups is that scientific visualizers are people who understand what the\nx-, y-, and z-axes actually mean: they are very good at picturing the\ndimensions of an image and understand the meaning of depths and distances. The\ndynamic processes they often represent—wind blowing over an airplane wing,\nhurricanes sweeping across maps, blood flowing through veins—also involve an\nadditional dimension: that of time. As it would be difficult to squeeze its\nrepresentation into any of the other three dimensions, animating is an\nattractive method for displaying such processes.\n\nIn contrast, data visualization is less straightforward. Information\nvisualizers usually work with abstract data spaces, where the axes do not\ncorrespond to the real world (if they mean anything at all). Viewers need to\nget acclimated to the dimensions they can see, and learn how to interpret\nthem. Consequently, there are comparatively few examples of animation\npublished in the information visualization community. (We will discuss some of\nthese later.)\n\nLearning from Cartooning\n\nAnimation, of course, appears popularly in places outside of visualizations.\nMovies and cartoons depend on some of the same physical principles as computer\nanimation, so several people have asked whether cartooning techniques might\nbring useful insights to the creation of animated visualizations. As early as\n1946, the Belgian psychologist Albert Michotte noted the \"perception of\ncausality\" (Michotte 1963). It is easy to believe that the movement in an\nanimation shows intent: that this point is chasing another across the screen\n(rather than moving in an equivalent trajectory one second behind it), that\nthis ball hit another (rather than \"this dot stopped at point A, and this\nother dot moved from A to B\"), and so on. Thus, we can ascribe agency and\ncausality where none really exists.\n\nIn cartoons, of course, we wish to communicate causality. Traditional\ncartoonists have described how they endow drawn shapes with the \"illusion of\nlife\" (Johnston and Thomas 1987) in order to convey emotion, and several\nrounds of research papers (Lasseter 1987; Chang and Ungar 1993) have tried to\nsee how to distill those ideas for computer animation and visualization.\n\nTraditional cartoonists use a barrage of techniques that are not completely\ntrue to life. Squash and stretch, for instance, distorts objects during\nmovement to draw the eye toward the direction of motion: objects might stretch\nwhen they fly at their fastest, and squashing them conveys a notion of\nstopping, gathering energy, or changing direction. Moving items along arcs\nimplies a more natural motion; motion along a straight line seems to have\nintent. Before objects begin moving, they anticipate their upcoming motion;\nthey conclude with a follow-through. Ease-in, ease-out is a technique of\ntiming animations: animations start slowly to emphasize direction, accelerate\nthrough the middle, and slow down again at the end. Complex acts are staged to\ndraw attention to individual parts one at a time.\n\nVisualization researchers have adapted these techniques with differing degrees\nof enthusiasm and success—for example, the Information Visualizer framework\n(Card, Robertson, and Mackinlay 1991), an early 3D animated framework,\nintegrated several of these principles, including anticipation, arcs, and\nfollow-through. On the other hand, some elements of this list seem distinctly\ninappropriate. For instance, squashing or stretching a data point distorts it,\nchanging the nature of the visualization; thus, we can no longer describe the\nvisualization as maintaining the consistent rule \"height maps to this, width\nmaps to that\" at each frame of the animation. In their research on slideshows,\nZongker and Salesin (2003) warn that many animation techniques can be\ndistracting or deceptive, suggesting causality where none might exist. Also,\nthey are often meant to give an illusion of emotion, which may be quite\ninappropriate for data visualization. (An exception would be We Feel Fine, in\nwhich the motion is supposed to convey emotion and uses these techniques\neffectively to do so.)\n\nThe Downsides of Animation\n\nAnimation has been less successful for data visualization than for scientific\nvisualization. Two metastudies have looked at different types of\nanimations—process animations and algorithm visualizations—and found that both\nclasses have spotty track records when it comes to helping students learn more\nabout complex processes.\n\nThe psychologist Barbara Tversky found, somewhat to her dismay, that animation\ndid not seem to be helpful for process visualization (i.e., visualizations\nthat show how to use a tool or how a technique works). Her article,\n\"Animation: Can It Facilitate?\" (Tversky, Morrison, and Bétrancourt 2002),\nreviews nearly 100 studies of animation and visualization. In no study was\nanimation found to outperform rich static diagrams. It did beat out textual\nrepresentations, though, and simple representations that simply showed start\nand end state without transitions.\n\nAlgorithm animation is in many ways similar to process visualization: an\nalgorithm can be illustrated by showing the steps that it takes. Some sort\nalgorithms, for example, are very amenable to animation: an array of values\ncan be drawn as a sequence of bars, so the sort operations move bars around.\nThese animations can easily show the differences between, say, a bubble sort\nand an insertion sort. Christopher Hundhausen, Sarah Douglas, and John Stasko\n(2002) tried to understand the effectiveness of algorithm visualization in the\nclassroom, but half of the controlled studies they examined found that\nanimation did not help students understand algorithms. Interestingly, the\nstrongest factor predicting success was the theory behind the animation.\nVisualization was most helpful when accompanied by constructivist\ntheories—that is, when students manipulated code or algorithms and watched a\nvisualization that illustrated their own work, or when students were asked\nquestions and tried to use the visualization to answer them. In contrast,\nanimations were ineffective at transferring knowledge; passively watching an\nanimation was not more effective than other forms of teaching.\n\nGapMinder and Animated Scatterplots\n\nOne recent example of successful animated visualization comes from Hans\nRosling's GapMinder (<http://www.gapminder.org>). Rosling is a professor of\nGlobal Health from Sweden, and his talk at the February 2006 Technology,\nEntertainment, Design (TED) conference[1] riveted first a live audience, then\nmany more online. He collected public health statistics from international\nsources and, in his brief talk, plotted them on a scatterplot. In the\nvisualization, individual points represent countries, with x and y values\nrepresenting statistics such as life expectancy and average number of children\nand each point's area being proportionate to the population of the country it\nrepresents. Rosling first shows single frames—the statistics of the countries\nin a single year—before starting to trace their progress through time,\nanimating between the images with yearly steps in between.\n\nFigure 19-1 shows three frames of a GapMinder-like animation. On the x-axis is\nthe life expectancy at birth; on the y-axis is the infant mortality rate. The\nsize of bubbles is proportionate to the population. Color-coding is per\ncontinent; the largest two dots are China and India.\n\nRosling's animations are compelling: he narrates the dots' movement,\ndescribing their relative progress. China puts public health programs in place\nand its dot floats upward, followed by other countries trying the same\nstrategy. Another country's economy booms, and its dot starts to move rapidly\nrightward. Rosling uses this animation to make powerful points about both our\npreconceptions about public health problems and the differences between the\nfirst and third world, and the animation helps viewers follow the points he is\nmaking.\n\n![bvis_1901a.png](images/bvis_1901a.png)\n\n![bvis_1901c.png](images/bvis_1901c.png)\n\n![bvis_1901b.png](images/bvis_1901b.png)\n\n![bvis_1901d.png](images/bvis_1901d.png)\n\nFigure 19-1. A GapMinder-like visualization showing information about a set of\n75 countries in 1975, 1985, 1995, and 2000; this chart plots life expectancy\n(x axis) against infant mortality (y axis)—countries at the top-left have a\nhigh infant mortality and a short life expectancy\n\nToo many dots?\n\nThe perceptual psychology research mentioned earlier showed that people have\ntrouble tracking more than four moving points at a time. In his presentation,\nRosling is able to guide the audience, showing them where to look, and his\nnarration helps them see which points to focus on. He describes the progress\nthat a nation is making with the assistance of a long pointer stick; it is\nquite clear where to look. This reduces confusion.\n\nIt also helps that many of the two-dimensional scatterplots he uses have\nunambiguously \"good\" and \"bad\" directions: it is good for a country to move\ntoward a higher GDP and a longer life expectancy (i.e., to go up and to the\nright), and bad to move in the opposite direction (down and to the left).\n\nWith Rosling's sure hand guiding the watcher's gaze, the visualization is very\neffective. But if a temporal scatterplot were incorporated into a standard\nspreadsheet, would it be useful for people who were trying to learn about the\ndata?\n\nTesting Animated Scatterplots\n\nAt Microsoft Research, we became curious about whether these techniques could\nwork for people who were not familiar with the data. We reimplemented a\nGapMinder-like animation as a base case, plotting points at appropriate (x, y)\nlocations and interpolating them smoothly by year. We then considered three\nalternative static visualizations that contained the same amount of\ninformation as the animation. First, of course, we could simply take\nindividual frames (as in Figure 19-1). Even in our earliest sketches, however,\nwe realized this was a bad idea: it was too difficult to trace the movement of\npoints between frames. The ability to follow the general trajectories of the\nvarious countries and to compare them is a critical part of GapMinder; we\nwanted users to have a notion of continuity, of points moving from one place\nto another, and the individual frames simply were not helpful.\n\nWe therefore implemented two additional views, using the same set of countries\nand the same axes as Figure 19-1, for the years 1975–2000. The first is a\ntracks view, which shows all the paths overlaid on one another (Figure 19-2).\nThe second is a small multiples view, which draws each path independently on\nseparate axes (Figure 19-3). In the tracks view, we cue time with\ntranslucency; in the small multiples view, we instead show time by changing\nthe sizes of the dots.\n\n![bvis_1902.png](images/bvis_1902.png)\n\nFigure 19-2. Tracks view in which each country is represented as a series of\ndots that become more opaque over time; years are connected with faded streaks\n\n![bvis_1903.png](images/bvis_1903.png)\n\nFigure 19-3. Small multiples view in which each country is in its own tiny\ncoordinate system: dots grow larger to indicate the progression of time\n\nWe wanted to understand how well users performed with the animation, as\ncompared with these static representations. Users can set up their own\nscatterplots at the GapMinder website, but would they be able to learn\nanything new from their data?\n\nWe chose 30 different combinations of (x, y) values based on public health and\ndemographic data from the United Nations, and presented users with fairly\nsimple questions such as \"In this scatterplot, which country rises the most in\nGDP?\" and \"In this scatterplot, which continent has the most countries with\ndiminishing marriage rates?\" We recruited users who were familiar with\nscatterplots, and who dealt with data in their daily work. Some subjects got\nto \"explore\" the data, and sat in front of a computer answering questions on\ntheir own. Others got a \"presentation,\" in which a narrator showed them the\nvisualization or played the animation. We measured both time and accuracy as\nthey then answered the questions.\n\nThe study's numerical results are detailed in Robertson et al. (2008). The\nmajor conclusions, however, can be stated quite simply: animation is both\nslower and less accurate at conveying the information than the other\nmodalities.\n\nExploration with animation is slower\n\nWe found that when users explored the data on their own, they would often play\nthrough the animation dozens of times, checking to see which country would be\nthe correct answer to the question. In contrast, those who viewed a\npresentation and could not control the animation on their own answered far\nmore rapidly: they were forced to choose an answer and go with it. Thus,\nanimation in exploration was the slowest of the conditions, while animation in\npresentation was the fastest.\n\nInterestingly, this might shed light on why the process animations by Tversky\net al. found so little success. In our tests, users clearly wanted to be able\nto move both forward and backward through time; perhaps this is true of\nprocess animations, too. More effort may be required to get the same\ninformation from an animation as opposed to a series of static images, because\nyou have to replay the entire thing rather than just jumping directly to the\nparts you want to see.\n\nAnimation is less accurate\n\nDespite the extra time the users spent with the animation, the users who were\nshown the static visualizations were always more accurate at answering the\nquestions. That is, the animation appeared to detract from the users' ability\nto correctly answer questions. Their accuracy was not correlated with speed:\nthe extra time they spent in exploration did not seem to drive better\noutcomes.\n\nThis seems like bad news for animation: it was slower and less accurate at\ncommunicating the information. On the other hand, we found the animation to be\nmore engaging and emotionally powerful: one pilot subject saw life expectancy\nin a war-torn country plummet by 30 years and gasped audibly. Generally, users\npreferred to work with the animation, finding it more enjoyable and exciting\nthan the other modes. They also found it more frustrating, though: \"Where did\nthat dot go?\" asked one angrily, as a data point that had been steadily rising\nsuddenly dropped.\n\nThese findings suggest that Rosling's talk is doing something different from\nwhat our users experienced. Critically, Rosling knows what the answer is: he\nhas worked through the data, knows the rhetorical point he wishes to make, and\nis bringing the viewers along. He runs much of his presentation on the same\nset of axes, so the viewers don't get disoriented. His data is reasonably\nsimple: few of the countries he highlights make major reversals in their\ntrends, and when he animates many countries at once, they stay in a fairly\nclose pack, traveling in the same direction. He chooses his axes so the\ncountries move in consistent directions, allowing users to track origins and\ngoals easily. He takes advantage of the Gestalt principle of common fate to\ngroup them, and he narrates their transitions for maximum clarity.\n\nIn contrast, our users had to contend with short sessions, had to track\ncountries that suffered abrupt reversals, and did not have a narrator to\nexplain what they were about to see; rather than learning the answer from the\nnarrator, they had to discover it themselves. This suggests to us that what we\nwere asking our users to do was very different from what Rosling is doing—so\ndifferent, in fact, that it deserves its own section.\n\nPresentation Is Not Exploration\n\nAn analyst sitting before a spreadsheet does not know what the data will show,\nand needs to play with it from a couple of different angles, looking for\ncorrelations, connections, and ideas that might be concealed in the data. The\nprocess is one of foraging—it rewards rapidly reviewing a given chart or view\nto see whether there is something interesting to investigate, followed by\nmoving on with a new filter or a different image.\n\nIn contrast, presenters are experts in their own data. They have already\ncleaned errors from the dataset, perhaps removing a couple of outliers or\nhighlighting data points that support the core ideas they want to communicate.\nThey have picked axes and a time range that illustrate their point well, and\nthey can guide the viewers' perception of the data. Most importantly, they are\nless likely to need to scrub back and forth, as we saw users doing with our\nanimation, in order to check whether they have overlooked a previous point. In\nthese conditions, animation makes a lot of sense: it allows the presenter to\nexplain a point vividly and dramatically.\n\nThe experience of exploration is different from the experience of\npresentation. It is easy to forget this, because many of our tools mix the two\ntogether. That is, many packages offer ways to make a chart look glossy and\nready for presentation, and those tools are not clearly separated from the\ntools for making the chart legible and ready for analysis. In Microsoft Excel,\nfor example, the same menu that controls whether my axis has a log scale also\nhelps me decide whether to finish my bar chart with a glossy color. The former\nof these choices is critical to exploration; the latter is primarily useful\nfor presentation. After I finish analyzing data in Excel, I can copy the chart\ndirectly into PowerPoint and show the result. As a result of this\nseamlessness, few people who use this popular software have seriously\ndiscussed the important distinctions between presentation and exploration.\n\nTable 19-1 summarizes major differences between the needs of exploration and\npresentation.\n\nTable 19-1. Differentiating exploration from presentation  \n---  \n|  Exploration |  Presentation  \nCharacteristics |  Data is surprising.  Data may have outliers. Data is likely to move unpredictably. Viewer controls interaction. |  Data is well known to the presenter. Data has been cleaned. Viewer is passive.  \nGoals/procedures |  Analyze multiple dimensions at once. Change mappings many times. Look for trends and holes. |  Present fewer dimensions to make a point.  Walk through dimensions clearly. Highlight critical points. Group points together to show trends and motion.  \n  \nThese two perspectives are not completely disjoint, of course. Many\ninteractive web applications allow users to explore a few dimensions, while\nstill not exposing raw data. The tension between presentation and exploration\nsuggests that designers need to consider the purpose of their visualizations.\nThere are design trade-offs, not only for animation, but more generally.\n\nTypes of Animation\n\nSome forms of animation are most suited to presentation, while others work\nwell for exploration. In this section, we'll discuss a hierarchy of different\ntypes of transformations, ranging from changing the view on a visualization to\nchanging the axes on which the visualization is plotted to changing the data\nof the visualization. Let's begin with an example of a system that needs to\nmanage two different types of changes.\n\nDynamic Data, Animated Recentering\n\nIn 2001, peer-to-peer file sharing was becoming an exciting topic. The\nGnutella system was one of the first large-scale networks, and I was in a\ngroup of students who thought it would make a good subject of study. Gnutella\nwas a little different from other peer-to-peer systems. The earlier Napster\nhad kept a detailed index of everything on the network; BitTorrent would later\nskip indexing entirely. Gnutella passed search requests between peers,\nbouncing around the questions and waiting for replies. When I used a peer-to-\npeer search to track down a song, how many machines were really getting\nchecked? How large a network could my own client see?\n\nWe instrumented a Gnutella client for visualization, and then started\nrepresenting the network. We rapidly realized a couple of things: first, that\nnew nodes were constantly appearing on the network; and second, that knowing\nwhere they were located was really interesting. The appearance of new nodes\nmeant that we wanted to be able to change the visualization stably. There\nwould always be new data pouring into the system, and it was important that\nusers not be disoriented by changes taking place in the visualization as new\ndata came in. On the other hand, we did not want to pause, add data, and\nredraw: we wanted a system where new data would simply add itself to the\ndiagram unobtrusively.\n\nBecause the Gnutella network used a peer-to-peer discovery protocol, it was\noften interesting to focus on a single node and its neighbors. Is this node\nconnected to a central \"supernode\"? Is it conveying many requests? We wanted\nto be able to focus on any single node and its neighbors, and to be able to\neasily estimate the number of hops between nodes. This called for changing the\nviewpoint without changing the remainder of the layout.\n\nOur tool was entitled GnuTellaVision, or GTV (Yee et al. 2001). We addressed\nthese two needs with two different animation techniques. We based the\nvisualization on a radial layout, both to reflect the way that data was\nchanging—growing outward as we discovered more connections—and in order to\nfacilitate estimation of the number of hops between the central node and\nothers. A radial layout has the virtues of a well-defined center point and a\nseries of layers that grow outward. As we discovered new nodes, we added them\nto rings corresponding to the number of hops from the starting node. When a\nnew node arrived, we would simply move its neighbors over by a small amount\n(most nodes in the visualization do not move much). As the visualization ran,\nit updated with new data, animating constantly (Figure 19-4).\n\n![bvis_1904a.png](images/bvis_1904a.png)\n\n![bvis_1904b.png](images/bvis_1904b.png)\n\nFigure 19-4. GTV before (left) and after (right) several new nodes are\ndiscovered on the network—as nodes yield more information, their size and\ncolor can also change\n\nWhen a user wanted to examine a node, GTV recentered on the selection. In our\nfirst design, it did so in the most straightforward way possible: we computed\na new radial layout and then moved nodes linearly from their previous\nlocations to the new ones. This was very confusing, because nodes would cross\ntrajectories getting from their old locations to the new ones. The first fix\nwas to have nodes travel along polar coordinate paths, and always clockwise.\nThus, the nodes remained in the same space as the visualization was drawn, and\nmoved smoothly to their new locations (Figure 19-5). Because GTV is oriented\ntoward examining nodes that may be new to the user, and is constantly\ndiscovering novel information, it was important that this animation facilitate\nexploration by helping users track the node paths.\n\n![bvis_1905a.png](images/bvis_1905a.png)\n\n![bvis_1905b.png](images/bvis_1905b.png)\n\nFigure 19-5. Interpolation in rectangular coordinates (top) causes nodes to\ncross through each others' paths; interpolation in polar coordinates (bottom)\nmakes for smooth motion\n\nA radial layout has several degrees of freedom: nodes can appear in any order\naround the radius, and any node can be at the top. When we did not constrain\nthese degrees of freedom, nodes would sometimes travel from the bottom of the\nscreen to the top. We wanted to ensure that nodes moved as little as possible,\nso we added a pair of constraints: nodes maintained, as much as they could,\nboth the same relative orientation and order. Maintaining relative orientation\nmeans that the relative position of the edge from the old center to the new\ncenter is maintained. Maintaining relative order means that nodes' neighbors\nwill remain in the same order around the rings. Both of these are illustrated\nin Figure 19-6.\n\n![bvis_1906b.png](images/bvis_1906b.png)\n\n![bvis_1906a.png](images/bvis_1906a.png)\n\n![bvis_1906c.png](images/bvis_1906c.png)\n\nFigure 19-6. Animated recentering: the purple highlighted node becomes the\ncenter, and other sets of nodes maintain their relative positions and orders\n(the large blue node stays below, and the set of small yellow nodes spreads\nalong an outer ring)\n\nLast, we adapted the ease-in, ease-out motion from cartooning in order to help\nusers see how the motion was about to happen.\n\nThis section demonstrated some useful principles that are worth articulating:\n\nCompatibility\n\nChoose a visualization that is compatible with animation. In GTV, the radial\nlayout can be modified easily; new nodes can be located on the graph to\nminimize changes, and—like many tree representations—it is possible to\nrecenter on different nodes.\n\nCoordinate motion\n\nMotion should occur in a meaningful coordinate space of the visualization. We\nwant to help the users stay oriented within the visualization during the\nanimation, so they can better predict and follow motion. In GTV, for instance,\ntransforming through rectangular coordinates would be unpredictable and\nconfusing; the radial coordinates, in contrast, mean that users can track the\ntransition and the visualization retains its meaning.\n\nMeaningful motion\n\nAlthough animation is about moving items, unnecessary motion can be very\nconfusing. In general, it is better to have fewer things move than more in a\ngiven transition. Constraining the degrees of freedom of the GTV animation\nallows the visualization to change as little as possible by keeping things in\nroughly the same position.\n\nA Taxonomy of Animations\n\nThere are many sorts of change that might occur within a visualization. In the\ndiscussion of GapMinder, we talked about changes to data; in the example of\nGTV, we examined changes to both the data and the view. There are more types\nof transitions that one might wish to make in a visualization, though. The\nfollowing is a list adapted from one assembled by Heer and Robertson (2007).\nEach type of transition is independent; it should be possible to change just\nthe one element without changing any of the others. Many of these are\napplicable to both presentation and exploration of data:\n\nChange the view\n\nPan over or zoom in on a fixed image, such as a map or a large data space.\n\nChange the charting surface\n\nOn a plot, change the axes (e.g., change from linear to log scale). On a map,\nchange from, for example, a Mercator projection to a globe.\n\nFilter the data\n\nRemove data points from the current view following a particular selection\ncriterion.\n\nReorder the data\n\nChange the order of points (e.g., alphabetize a series of columns).\n\nChange the representation\n\nChange from a bar chart to a pie chart; change the layout of a graph; change\nthe colors of nodes.\n\nChange the data\n\nMove data forward through a time step, modify the data, or change the values\nportrayed (e.g., a bar chart might change from Profits to Losses). As\ndiscussed earlier, moving data through a time step is likely to be more useful\nfor presentations.\n\nThese six types of transitions can describe most animations that might be made\nwith data visualizations. Process visualizations would have a somewhat\ndifferent taxonomy, as would scientific visualizations that convey flow (such\nas air over wings). Next, given this set of transitions, we will discuss some\nexamples of how these animations might be managed.\n\nStaging Animations with DynaVis\n\nTwo people exploring a dataset together on a single computer have a\nfundamental problem: only one of them gets the mouse. While it is perfectly\nintuitive for one of them to click \"filter,\" the other user might not be able\nto track what has just happened. This sits at an interesting place between\nexploration and presentation: one of the major goals of the animation is to\nenable the second user to follow the leader by knowing what change the leader\nhas just invoked; however, the leader may not know specifically what point he\nis about to make. Animation is plausibly a way to transition between multiple\nvisualizations, allowing a second person—or an audience—to keep up. For the\nlast several years, we have been experimenting with ways to show transitions\nof data and representations of well-known charts, such as scatterplots, bar\ncharts, and even pie charts.\n\nDynaVis, a framework for animated visualization, was our starting point. A\nsummer internship visit by Jeff Heer, now a professor at Stanford, gave us a\nchance to work through a long list of possibilities. This discussion is\noutlined in more detail in his paper (Heer and Robertson 2007).\n\nIn DynaVis, each bar, dot, or line is represented as an object in 3D space, so\nwe can move smoothly through all the transitions described in the preceding\nsection. Many transformations are fairly clear: to filter a point from a\nscatterplot, for instance, the point just needs to fade away. There are\nseveral cases that are much more interesting to work through, though: those in\nwhich the type of representation needs to change, and those in which more than\none change needs to happen at a time. When the representation is being\nchanged, we try to follow several basic principles. Here are the first two:\n\nDo one thing at a time\n\nEnsure that the visualization does not entail making multiple simultaneous\nchanges. This might mean staging the visualization, to ensure that each\nsuccessive step is completed before the next one is started.\n\nPreserve valid mappings\n\nAt any given time during a step, ensure that the visualization is a meaningful\none that represents a mapping from data to visualization. It would be invalid,\nfor example, to rename the bars of a bar chart: the fundamental mapping is\nthat each bar represents one x-axis value.\n\nFigure 19-7 shows a first attempt at a transition from bar chart to pie chart.\nThere are some positive aspects to the transition. For example, the bars do\nnot move all at once, so the eye can follow movement fairly easily, and the\nbars maintain their identities and their values across the animation. While\nthere are some issues with occlusion as the bars fly past each other, they\nmove through a smooth trajectory so that it is reasonable to predict where\nthey will end up. Finally, the animation is well staged: all the wedges are\nplaced before they grow together into a full pie.\n\nThis visualization has a critical flaw, though. The length of the bar becomes\nthe length of the pie wedge, so longer bars became longer wedges. However,\nlonger bars will ultimately have to become fatter wedges in the final pie\nchart. That means that bars are becoming both fat and long, or both skinny and\nshort. This, in turn, means that the visualization does not employ a constant\nrule (such as \"number of pixels is proportionate to data value\").\n\nThat leads us to the next principle:\n\nMaintain the invariant\n\nWhile the previous rule referred to the relationship between data elements and\nthe marks on the display, this rule refers to the relationship of the data\nvalues to the visualization. If the data values are not changing, the system\nshould maintain those invariant values throughout the visualization. For\nexample, if each bar's height is proportionate to the respective data point's\nvalue, the bars should remain the same height during the animation.\n\nFigure 19-8 illustrates both of these principles in a more successful bar\nchart to pie chart animation. This chart shows a 1:1 correspondence between\nthe drawn entity—the bar, the curved line, or the pie slice—and the underlying\ndata. This assignment never changes: the bar furthest on the left (\"A\")\nbecomes the leftmost pie slice (also \"A\"). The invariant is maintained by the\nlengths of the bars, which remain proportionate to the data values. While we\ndo not illustrate it here, we follow similar principles in changing a bar\nchart into a line chart: the top-left corner of the bar represents the value,\nso as the bar shrinks into a line, that data point will remain rooted at the\ntop-left corner of the bar.\n\n![bvis_1907c.png](images/bvis_1907c.png)\n\n![bvis_1907d.png](images/bvis_1907d.png)\n\n![bvis_1907e.png](images/bvis_1907e.png)\n\n![bvis_1907f.png](images/bvis_1907f.png)\n\n![bvis_1907a.png](images/bvis_1907a.png)\n\n![bvis_1907b.png](images/bvis_1907b.png)\n\nFigure 19-7. Less successful bar chart to pie chart animation: long bars\nbecome long, fat wedges on the pie; short bars become short, skinny wedges;\nthen all wedges grow to full length\n\n![bvis_1908a.png](images/bvis_1908a.png)\n\n![bvis_1908b.png](images/bvis_1908b.png)\n\n![bvis_1908c.png](images/bvis_1908c.png)\n\n![bvis_1908d.png](images/bvis_1908d.png)\n\n![bvis_1908e.png](images/bvis_1908e.png)\n\n![bvis_1908f.png](images/bvis_1908f.png)\n\nFigure 19-8. Better bar chart to pie chart animation: the lengths of the bars\nare maintained as they are brought into the ring; the ring then fills to\nbecome a pie\n\nAnother interesting case brings back the cartoon notion of staging. In\nGnuTellaVision we were able to recenter in a single motion, but in DynaVis it\noften makes more sense to break a transformation into two steps. For instance,\nin each of these examples, we ensure that we change only one thing at a time:\n\n  * To filter a dataset in a bar chart, we first remove bars we will not use, and then close ranks around them. To unfilter, we open space for the bars that will be added, and then grow the bars up.\n  * To grow or shrink a bar, such as when data changes, we may need to change the axes. Imagine growing a bar chart from the values (1,2,3,4,5) to (1,2,10,4,5)—the y-axis should certainly grow to accommodate the new value. If we grow the bar first, it will extend off the screen; therefore, we must change the axis before changing the bar. \n  * When sorting a selection of bars, sorting them at once could cause all bars to pass through the center at once. This is confusing: it is hard to figure out which bar is which. By staggering the bars slightly, so that they start moving a small amount of time apart, we found that the sort operation was much clearer.\n\nStaging is not always appropriate, though. In Heer and Robertson's report on\nthe project (2007), they found that some staged animations are more\nchallenging to follow. In particular, when resizing segments of a donut or pie\nchart, it was difficult to monitor the changes as the pie turned to\naccommodate the new sizes. DynaVis attempted to stage this transition by\nextracting segments to either an external or an internal ring, adjusting their\nsizes, and then collapsing them back into place. While this made the changes\nmuch more visible, it also added a layer of potentially confusing action.\n\nHeer and Robertson collected both qualitative results—how much users liked the\nanimations—and quantitative ones—finding out which animations allowed users to\nanswer questions most accurately. They found that users were able to answer\nquestions about changes in values over time more easily with the animations\nthan without; furthermore, the animations that were staged but required only\none transition did substantially better than the animations that required many\ntransitions.\n\nEven with these caveats, though, it is clear that these sorts of dynamics\ncould potentially help users understand transitions much more easily: compared\nto a presenter flipping through a series of charts, forcing the audience to\nreorient after each slide, a DynaVis-like framework might allow users to\nremain oriented thoughout the presentation.\n\nPrinciples of Animation\n\nThere have been several attempts to formulate principles for animation.\nTversky, Morrison, and Bétrancourt (2002) offer two general guidelines at the\nend of their article: that visualizations should maintain congruence and\napprehension. The former suggests that the marks on the screen must relate to\nthe underlying data at all times. The latter suggests that the visualization\nshould be easy to understand. The principles we have articulated fit into\nthese categories. (Other, related guidelines have been suggested in Heer and\nRobertson's [2007] discussion of the DynaVis research, by Zongker and Salesin\n[2003] in their discussion of animation for slideshow presentations, and, with\nregard to graph drawing, by Freidrich and Eades [2002].)\n\nThe principles that we have discussed in this chapter are:\n\nStaging\n\nIt is disorienting to have too many things happen at once. If it is possible\nto change just one thing, do so. On the other hand, sometimes multiple changes\nneed to happen at once; if so, they can be staged.\n\nCompatibility\n\nA visualization that will be disrupted by animation will be difficult for\nusers to track. For example, it is not disruptive to add another bar to a bar\nchart (the whole set can slide over), and it may not be disruptive to add\nanother series to a bar chart. However, a squarified treemap is laid out\ngreedily by size; growing a single rectangle will require every rectangle to\nmove to a new location and will look confusing.\n\nNecessary motion\n\nIn particular, avoid unnecessary motion. This implies that we want to ensure\nthat motion is significant—i.e., we should animate only what changes. In\ngeneral, the image should always be understandable. As the DynaVis user tests\nshowed, excess motion—even significant motion—can be confusing.\n\nMeaningful motion\n\nThe coordinate spaces and types of motion should remain meaningful. This also\nentails two points discussed earlier: preserve valid mappings and maintain the\ninvariant.\n\nVerifying that you've adhered to these principles can help you figure out\nwhether an animation is headed in the right direction.\n\nConclusion: Animate or Not?\n\nIn this chapter, we have discussed the difference between presentation and\nexploration of data. We have also discussed the various layers of a\nvisualization that might be altered, and some principles for making a\nvisualization-safe animation.\n\nSo now you're staring at a visualization you're working on, and trying to\ndecide whether to animate it or not. The question that this chapter has\nrepeatedly asked is: what function does the animation serve? If it is meant to\nallow a user to smoothly transition between views, then it is likely to be\nhelpful. On the other hand, if the user is meant to compare the \"before\" to\nthe \"after,\" the animation is less likely to be of use.\n\nUsers want to understand why a change is happening, and what is changing. If\neverything on the screen is going to move around, perhaps it would be better\nto simply switch atomically to a new image; this might spare the user the\ndifficulty of trying to track the differences. Finally, animations mean that\nit can be more difficult to print out visualizations. Individual frames should\nbe meaningful, so that users can capture and share those images. Animation\nimposes a burden of complexity on the user, and that complexity should pay\noff.\n\nFurther Reading\n\nHere are a few animated data visualization projects that have some relevance\nto this discussion, which you may want to explore further:\n\n  * Many researchers begin playing with zooming and panning as basic operations in a visualization with Pad++, a zoomable architecture for laying out data in large spaces (Bederson and Hollan 1994). \n  * Scatterdice (Elmqvist, Dragicevic, and Fekete 2008) explores a way to transition between scatterplots by rotating through the third dimension.\n  * Visualizations of tree data structures include ConeTrees (Card, Robertson, and Mackinlay 1991), CandidTree (Lee et al. 2007), and Polyarchy (Robertson et al. 2002). Researchers have explored animation with treemaps by zooming (distorting) the treemap (Blanch and Lecolinet 2007) and moving through 3D space (Bladh, Carr, and Kljun 2005).\n  * Graph layout is often animated as the layout progresses; in the last 10 years, the graph-drawing community has turned to considering ways to update graphs in response to underlying data. In addition to the work cited earlier (Friedrich and Eades 2002), we note GraphAEL (Erten et al. 2003).\n\nAcknowledgments\n\nI am grateful to Professor Jeffrey Heer of Stanford University, both for his\nvaluable conversations on these topics when we shared an office and for his\npredigested versions of these concepts, produced in his 2007 Infovis paper\n(Heer and Robertson 2007) and his Stanford course notes. Jeff also contributed\na chapter to Beautiful Data, the sister volume to this book, discussing his\nwork with sense.us. My thanks also for feedback and ideas for this paper from\nmy colleagues, Steven Drucker, Roland Fernandez, Petra Isenberg, and George\nRobertson.\n\nReferences\n\nBederson, B.B., and J.D. Hollan. 1994. \"Pad++: A zooming graphical interface\nfor exploring alternate interface physics.\" In Proceedings of the 7th Annual\nACM Symposium on User Interface Software and Technology. New York: ACM Press.\n\nBladh, Thomas, David A. Carr, and Matjaz Kljun. 2005. \"The effect of animated\ntransitions on user navigation in 3D tree-maps.\" In Proceedings of the Ninth\nInternational Conference on Information Visualization. Washington, DC: IEEE\nComputer Society.\n\nBlanch, Renaud, and Eric Lecolinet. 2007. \"Browsing zoomable treemaps:\nStructure-aware multi-scale navigation techniques.\" IEEE Transactions on\nVisualization and Computer Graphics 13, no. 6: 1248–1253.\n\nCard, Stuart K., George G. Robertson, and Jock D. Mackinlay. 1991. \"The\ninformation visualizer, an information workspace.\" In Proceedings of the\nSIGCHI Conference on Human Factors in Computing Systems. New York: ACM Press.\n\nCavanagh, Patrick, and George Alvarez. 2005. \"Tracking multiple targets with\nmultifocal attention.\" TICS 9: 349–354.\n\nChang, Bay-Wei, and David Ungar. 1993. \"Animation: From cartoons to the user\ninterface.\" In Proceedings of the 6th Annual ACM Symposium on User Interface\nSoftware and Technology. New York: ACM Press.\n\nElmqvist, N., P. Dragicevic, and J.-D. Fekete. 2008. \"Rolling the dice:\nMultidimensional visual exploration using scatterplot matrix navigation.\" IEEE\nTransactions on Visualization and Computer Graphics 14, no. 6: 1141–1148.\n\nErten, C., P.J. Harding, S.G. Kobourov, K. Wampler, and G. Yee. 2003.\n\"GraphAEL: Graph animations with evolving layouts.\" In Proceedings of the 11th\nInternational Symposium on Graph Drawing. Springer-Verlag.\n\nFisher, Danyel A. 2007. \"Hotmap: Looking at geographic attention.\" IEEE\nTransactions on Visualization and Computer Graphics 13, no. 6: 1184–1191.\n\nFriedrich, C., and P. Eades. 2002. \"Graph drawing in motion.\" Journal of Graph\nAlgorithms and Applications 6, no. 3: 353–370.\n\nHeer, Jeffrey, and George G. Robertson. 2007. \"Animated transitions in\nstatistical data graphics.\" IEEE Transactions on Visualization and Computer\nGraphics 13, no. 6: 1240–1247.\n\nHundhausen, Christopher D., Sarah A. Douglas, and John T. Stasko. 2002. \"A\nmeta-study of algorithm visualization effectiveness.\" Journal of Visual\nLanguages & Computing 13, no. 3: 259–290.\n\nJohnson, Ollie, and Frank Thomas. 1987. The Illusion of Life. New York: Disney\nEditions.\n\nLasseter, John. 1987. \"Principles of traditional animation applied to 3D\ncomputer animation.\" In Proceedings of the 14th Annual Conference on Computer\nGraphics and Interactive Techniques. New York: ACM Press.\n\nLee, Bongshin, George G. Robertson, Mary Czerwinski, and Cynthia Sims Parr.\n2007. \"CandidTree: Visualizing structural uncertainty in similar hierarchies.\"\nInformation Visualization 6: 233–246.\n\nMichotte, A. 1963. The Perception of Causality. Oxford: Basic Books.\n\nRobertson, George, Kim Cameron, Mary Czerwinski, and Daniel Robbins. 2002.\n\"Polyarchy visualization:Visualizing multiple intersecting hierarchies.\" In\nProceedings of the SIGCHI Conference on Human Factors in Computing Systems.\nNew York: ACM Press.\n\nRobertson, George, Roland Fernandez, Danyel Fisher, Bongshin Lee, and John\nStasko. 2008. \"Effectiveness of animation in trend visualization.\" IEEE\nTransactions on Visualization and Computer Graphics 14, no. 6: 1325–1332.\n\nTversky, Barbara, Julie B. Morrison, and Mireille Bétrancourt. 2002.\n\"Animation: Can it facilitate?\" International Journal of Human-Computer\nStudies 57: 247–262.\n\nYee, Ka-Ping, Danyel Fisher, Rachna Dhamija, and Marti A. Hearst. 2001.\n\"Animated exploration of dynamic graphs with radial layout.\" In Proceedings of\nthe IEEE Symposium on Information Visualization. Washington, DC: IEEE Computer\nSociety.\n\nZongker, Douglas E., and David H. Salesin. 2003. \"On creating animated\npresentations.\" In Proceedings of the 2003 ACM SIGGRAPH/Eurographics Symposium\non Computer Animation. New York: ACM Press.\n\n[1] Available online at\n<http://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen.html>.\nRosling presented similar discussions at TED 2007 and TED 2009.\n\n\nChapter Twenty\n\nVisualization: Indexed.\n\nJessica Hagy\n\nVisualization: It’s an Elephant.\n\nVisualization. To one person, it’s charts and graphs and ROI. To another, it’s\nillustration and colorful metaphor and gallery openings. To a third, it’s that\nwonderfully redundant compound word: infographics. Visualization. It’s a term\nthat’s been pulled and yanked like so much conceptual taffy. It’s like that\nold tale of three blindfolded men who are asked to describe an elephant. One\ntouches the elephant’s tail and says, “An elephant is like a rope.” Another\ntouches the elephant’s leg and says, “An elephant is like a tree trunk.” The\nthird man touches the elephant’s trunk and says, “An elephant is like a\nsnake.” None of them is completely wrong, but none is completely right,\nbecause none of them can see the entire animal (Figure 20-1).\n\nVisualization is only something (and everything) you can see. It’s both the\nentire mosaic and a single, sparkling tessera. It’s not just graphs. It’s not\njust visual metaphors. It’s not just graphic design in service instead of\nbullet points. It’s not just sketching out ideas. It’s not just data analysis.\nThose are just slivers of the larger concept.\n\nReally good, beautiful, powerful visualization—visualization that touches both\nthe mind and the heart—isn’t just about an image, a snapshot, or a glance\nthrough a windowpane (Figure 20-2). Powerful visualization passes the elephant\ntest: it’s practically impossible to describe, but instantly recognizable.\nThis chapter will describe various aspects of that elephant. Together, they’ll\nhelp to paint a clear picture of what visualization really is, from tusk to\ntoe.\n\n![bvis_2001.png](images/bvis_2001.png)\n\nFigure 20-1. There’s always more to it\n\n![bvis_2002.png](images/bvis_2002.png)\n\nFigure 20-2. Knowing and doing go hand in hand\n\nVisualization: It’s Art.\n\nThere’s an image, a message in it. People stare at it and debate it. Framers\nare employed for another day because of it. Quality can be subjective, and\naesthetics are always debatable—but the intrinsic artistry is evident. Like\npornography, art is something you know when you see it, and no sooner (Figure\n20-3). And visualization is widely perceived to be an art.\n\n![bvis_2003.png](images/bvis_2003.png)\n\nFigure 20-3. Visualizing aha moments\n\nVisualization practitioners often have an air of creativity about them: they\ndraw or paint or wear glasses with thick, black frames. Of course, as soon as\nsomething is branded as an artistic endeavor, the barriers to entry rise up\naround it. Those who believe they can’t draw and those who would never assign\nthemselves the label of “creative” shy away from visualization for this\nreason. And that’s too bad—because you don’t have to be a Rembrandt to have an\nidea that can be understood by scrawling a stick figure or two.\n\nThe beauty inherent in visualization (it can be argued) is the idea behind the\nimage: the concept conveyed by the lines and shapes that your rods and cones\nobserve. Just as anyone with a lump of clay can technically sculpt, anyone\nwith an idea that can be conveyed visually can technically create a\nvisualization (Figure 20-4). The quality of the sketch or the visualization\nwill always be debatable. The quality of any piece of art, and of any image,\nwill always be debatable.\n\nVisualization, eye of the beholder—you get the idea.\n\n![bvis_2004.png](images/bvis_2004.png)\n\nFigure 20-4. Don’t outgrow your skills\n\nVisualization: It’s Business.\n\nThere’s this little program out there—you may have heard about it. It’s cheap,\nit’s pretty much universal, and it has turned the idea of the visual aid into\na tool of khaki-loving middle managers. It’s called PowerPoint, and it,\nsingle-handedly, has transported visualization into the land of business\n(Figure 20-5).\n\n![bvis_2005.png](images/bvis_2005.png)\n\nFigure 20-5. Power point = an oxymoronic phrase\n\nThere’s no denying it: visuals are compelling. Want someone to ignore your\nprose? Make sure to include a lot of pictures, or graphs if you took math in\ncollege. When making a presentation to a board of directors, a prospective\nclient, or for a midterm grade in an MBA class, going without PowerPoint is\nseen as quaint at best and ill-prepared at worst (Figure 20-6). Why? Because\nvisualization is an excellent tool of persuasion. And persuasion is just\nanother word for sales.\n\n![bvis_2006.png](images/bvis_2006.png)\n\nFigure 20-6. Ideas can work for you\n\nMergers. Acquisitions. Negotiations. Advertising. Propaganda. Business\ncommunication is being conveyed visually every day. Here’s the back of my\nnapkin. Here’s my whiteboard. Here’s the doodle of my exit strategy that I\ndrew in that last four-hour meeting.\n\nSeeing is believing. And believing—well, when people believe in something,\nthey buy into it. How do you think corporate headquarters, political\ndynasties, and mega-churches get built?\n\nVisualization: It’s Timeless.\n\nThose famous cave paintings in France weren’t to-do lists, sentences, words,\nor even letter forms. They were images. Thousands of years ago, hieroglyphics\nheld images in each character. Written Chinese does the same today. We\nunderstand smiles before we understand words. As powerful as language is, it’s\nnot as instinctive or primal as visualization (Figure 20-7).\n\n![bvis_2007.png](images/bvis_2007.png)\n\nFigure 20-7. Same old story, different authors\n\nWhen we see a photograph or a painting, or the map on the weatherman’s green\nscreen, we learn a lot more a lot faster than we would if such an image were\ndescribed in words. We can listen to an hour-long description of abject\npoverty, or we can look at an image of a vulture hovering near an emaciated\nchild for a fraction of a second. No matter how compelling the verbal argument\nis, the image shares its story faster. While we may have advanced as societies\nto employ complex vocabularies and languages packed with idioms and metaphors\nand grammars that vicious nuns teach us as children, we are still able to\ncommunicate without our languages—with only images (Figure 20-8).\n\n![bvis_2008.png](images/bvis_2008.png)\n\nFigure 20-8. To see is to know\n\nJust imagine: cave paintings and shapes scratched in ancient dirt. Before\npunditry. Before poetry. Before PowerPoint.\n\nVisualization: It’s Right Now.\n\nWhat says more: a name or a logo? How do people recognize you: your avatar or\nyour resume? What’s the more precious piece of real estate: a famous URL or a\nlot in a famous zip code? Today, logos tell epic stories. Screen names equal\nhuman identities. Web addresses fund mansion renovations and the purchase of\nranches, islands, and city blocks.\n\nMore than ever, we are swimming in information. We are pickling in data. More\ninformation than any human world has ever seen before or could ever hope to\ncomprehend is generated every day (Figure 20-9). And so we turn to\nvisualization as a means to collect, condense, and convey this information.\n\n![bvis_2009.png](images/bvis_2009.png)\n\nFigure 20-9. Water, water, everywhere\n\nVisuals crunch data. They take reams of chunky, unwieldy, black and white\nspreadsheets and compact them into sleek, colorful charts. Visuals reveal\npatterns in vast amounts of data; they take complex and difficult-to-\nunderstand theories and elegantly explain them (Figure 20-10). Imagine data\npoints as molecules of ice. Visualizations are the resulting snowflakes:\ngorgeous and organic arrangements of many smaller pieces of information.\n\nWhen we want to make sense of the sea of information around us, we make\nvisualizations. It’s the age of information. And thus, one could argue that\nit’s the age of visualization, too.\n\n![bvis_2010.png](images/bvis_2010.png)\n\nFigure 20-10. Use either to get what you need\n\nVisualization: It’s Coded.\n\nLetters represent sounds. Words represent ideas. We combine and weave our\nsentences to tell stories. The hood ornament on your car represents your tax\nbracket. Your wrinkles speak to your age. We communicate in codes—aural,\nvisual, tactile, and social. Even our DNA is a code—we are built from the\nground up to communicate with representational bits of data (Figure 20-11).\nVisualization is just another form of coded communication, with the axes of\ngraphs as shorthand for correlation, and with characters in editorial cartoons\nstanding in for ideologies. Photographs and paintings represent history.\n\n![bvis_2011.png](images/bvis_2011.png)\n\nFigure 20-11. Wink wink, nudge nudge\n\nAs visualization becomes a larger area of inquiry—in ivory towers, in art\nstudios, and on message boards—the idea of semiotics will be raised more\nfrequently. As we look closer at signs and symbols, we’ll see that we\ncommunicate with visualizations almost as much as we speak in words. From a\nsingle finger raised to the driver who just ran that red light to hearts drawn\non love notes to the use of increasingly trite emoticons, we use symbols to\nexpress ourselves.\n\nMetaphors. Idioms. Inside jokes (or literary allusions, if you’re an English\nmajor). Our communications involve many layers of symbolism, many codes that\nwe interpret in every conversation. Visualizations are another way to\nrepresent ideas; another not-so-secret code. The clearer the visualization is,\nthe more people there are who can crack that code.\n\nGang tattoos, Rorschach tests, pieces of art with multiple\ninterpretations—these are just a few of the many visualizations that hold\nhidden (and sometimes, profound) meanings (Figure 20-12).\n\n![bvis_2012.png](images/bvis_2012.png)\n\nFigure 20-12. Secrets and/or societies\n\nVisualization: It’s Clear.\n\nOne of the beauties often attributed to visualization is simplicity. Pure\nclarity! Marvelous obviousness! Splendid simplicity! An image can set the tone\nfor a presentation, a feature article, an annual report. We look. We see. We\nunderstand. Between first glance and “Oh, I get it,” just a fraction of a\nsecond passes.\n\nWe don’t always have time to dissect meanings or read a 10-page summary. We\nwant to look at a chart, see year-over-year results, and move on. Images are\nincredibly good at conveying information quickly. Clarity allows us to\nunderstand and carry on. Ambiguity takes time to ponder—time that we just\ndon’t have.\n\nWe learn more about a person in the first 10 seconds of meeting him than hours\nof Google-stalking could have ever told us. We judge books by covers and real\nestate by curb appeal. We see a picture of the Statue of Liberty with a noose\naround her neck and we understand that injustice is occurring. We see devil\nhorns drawn on a poster of the jock running for class president and we\nunderstand that someone dislikes him. It’s clear what visuals convey (Figure\n20-13). But just because the message is clear, it might not always be true.\n\n![bvis_2013.png](images/bvis_2013.png)\n\nFigure 20-13. It’s all context\n\nWe don’t trust news from biased sources. When an offer sounds amazing, we know\nthat the fine print will be dense and long and written against us. Truth in\nadvertising is a myth. Remember this when gazing upon a beautiful visual. Its\nmessage may be clear and obvious, but the motivations behind it may take more\ntime to see (Figure 20-14).\n\n![bvis_2014.png](images/bvis_2014.png)\n\nFigure 20-14. Ask why you are seeing what’s in front of you\n\nVisualization: It’s Learnable.\n\nThe display of information, in any and all forms, is open to everyone to both\ncreate and consume. From the way you wear your hair to the color of your coat,\nyou are sending visual signals and conveying visual information. Anyone can\npick up a pen and draw a line on the wall or a sheet of paper. Pixels can\nlikewise be rearranged to express the thoughts of anyone with access to a\ncomputer.\n\nYou don’t have to speak Italian to appreciate the art of Michelangelo. Anyone\ncan visit the Louvre and leave inspired. Likewise, an infant can recognize\nhuman faces and expressions without knowing so much as a word.\n\nAnd just like learning to read and to communicate with words, it’s possible\nthrough practice to become a skilled visual communicator. Drawing is the\nability to translate scenes onto paper—making a direct translation.\nVisualization is the ability to put ideas onto paper—taking data and\ndistilling it into a concept. Don’t confuse the two. The thinking process is\ndifferent, even if a pen and paper unite the two skills. Ideas (concepts,\ntheories, equations, opinions, processes) behave differently than a still life\npainting of a bowl of fruit (Figure 20-15).\n\n![bvis_2015.png](images/bvis_2015.png)\n\nFigure 20-15. Know more, do more\n\nSketching symbols and metaphors can be done in a sloppy, messy fashion, and\nstill be powerful and clear. Remember that the next time you trace a heart in\nthe steam on a windowpane (Figure 20-16).\n\n![bvis_2016.png](images/bvis_2016.png)\n\nFigure 20-16. You are what you do\n\nVisualization: It’s a Buzzword.\n\nSo, is this a meme (Figure 20-17)? Is visualization merely the latest turn of\nphrase that’s sweeping the feature pages of business magazines, RFPs, and\ncourse syllabi? Is it another word that marketers are batting around to sound\nsmart? Or is it less of a fad, and more of a response to our current data-\nsaturated environment?\n\n![bvis_2017.png](images/bvis_2017.png)\n\nFigure 20-17. Welcome to the Internet\n\nVisualization is getting a lot of attention: it helps us cope with information\noverload, saves us time, and reaches us on an innate level. Well-crafted\nvisualizations are compelling and beautiful to look at and to intellectually\nenjoy. And with software at the disposal of so many, there has never been an\neasier time to turn ideas into images. And so it seems that the popularity of\nvisualization is a function of necessity: the more data we have to sift\nthrough, the easier it is to convert that data to images, the easier it is to\njuxtapose images with text, the more we want to persuade others and promote\nourselves, the more visualizations we’ll see all around us.\n\nThe word is popular. The idea is popular. The applications are popular.\nVisualization helps us communicate. It enables and fosters connections. And as\nlong as those last two statements are true, we can but hope that visualization\nis popular like the Beatles, and not the Monkees (Figure 20-18).\n\n![bvis_2018.png](images/bvis_2018.png)\n\nFigure 20-18. Are you joining a revolution or a fad?\n\nVisualization: It’s an Opportunity.\n\nIf you want to connect, compel, and communicate, you need to use visuals. You\ncan combine art and business. You can reach people quickly, powerfully, and\nemotionally with visuals. Even if you don’t think of yourself as creative, or\nas an artist, you can be a visualizer (Figure 20-19).\n\n![bvis_2019.png](images/bvis_2019.png)\n\nFigure 20-19. Your excuses aren’t valid\n\nJust as writers read to sculpt their skill, visualizers look. They stare with\nintensity and peer into places others would rather ignore. They look not only\nat images, but also at events. They gawk at causes and effects and motives and\nmeans. And sometimes, they close their eyes and wonder how to illustrate the\nuniverse in a Word document, or the depth of their feelings in an email, or\nthe scope of their business in a single slide (Figure 20-20).\n\n![bvis_2020.png](images/bvis_2020.png)\n\nFigure 20-20. Look closer and go further\n\nObservation is the first step toward visualization, and you are doing it at\nthis very minute. If you can think it, you can visualize it. If you can\nvisualize it, you can share it. And if you can share it, you can change the\nworld.\n\nBut first: look around you. You’re looking at opportunity.\n\n",
    "book_id": "beautiful_visualization",
    "book_title": "Beautiful Visualization",
    "book_author": "Edited by Julie Steele and Noah Iliinsky",
    "topic_id": "design_data_visualization",
    "topic_label": "data visualization",
    "chunk_index": 0
  },
  {
    "chunk_full": "![D3 Tips and Tricks v4.x](images/title_page.png)\n\n\n## D3 Tips and Tricks v4.x\n\n### Interactive Data Visualization in a Web Browser\n\n#### Malcolm Maclean\n\nThis book is for sale at <http://leanpub.com/d3-t-and-t-v4>\n\nThis version was published on 2017-04-12\n\n![publisher's logo](images/leanpub-logo.png)\n\n* * * * *\n\nThis is a [Leanpub](http://leanpub.com) book. Leanpub empowers authors and\npublishers with the Lean Publishing process. [Lean\nPublishing](http://leanpub.com/manifesto) is the act of publishing an in-\nprogress ebook using lightweight tools and many iterations to get reader\nfeedback, pivot until you have the right book and build traction once you do.\n\n* * * * *\n\n© 2016 - 2017 Malcolm Maclean\n\n\n## Table of Contents\n\n  1. [Acknowledgements](chap00.xhtml#leanpub-auto-acknowledgements)\n     1. [Mike](chap00.xhtml#leanpub-auto-mike)\n     2. [Partners, Supporters and Contributors.](chap00.xhtml#leanpub-auto-partners-supporters-and-contributors)\n     3. [Proof Reading](chap00.xhtml#leanpub-auto-proof-reading)\n     4. [The d3.js Community](chap00.xhtml#leanpub-auto-the-d3js-community)\n     5. [Cover art](chap00.xhtml#leanpub-auto-cover-art)\n     6. [Leanpub](chap00.xhtml#leanpub-auto-leanpub)\n     7. [Make sure you get the most up to date copy of D3 Tips and Tricks](chap00.xhtml#leanpub-auto-make-sure-you-get-the-most-up-to-date-copy-of-d3-tips-and-tricks)\n  2. [What is d3.js?](chap01.xhtml#leanpub-auto-what-is-d3js)\n  3. [Introduction](chap02.xhtml#leanpub-auto-introduction)\n  4. [What do we need to get started?](chap03.xhtml#leanpub-auto-what-do-we-need-to-get-started)\n     1. [HTML](chap03.xhtml#leanpub-auto-html)\n     2. [JavaScript](chap03.xhtml#leanpub-auto-javascript)\n     3. [Cascading Style Sheets (CSS)](chap03.xhtml#leanpub-auto-cascading-style-sheets-css)\n     4. [Web Servers](chap03.xhtml#leanpub-auto-web-servers)\n     5. [PHP](chap03.xhtml#leanpub-auto-php)\n     6. [Other Useful Stuff](chap03.xhtml#leanpub-auto-other-useful-stuff)\n        1. [Text Editor](chap03.xhtml#leanpub-auto-text-editor)\n        2. [Getting D3](chap03.xhtml#leanpub-auto-getting-d3)\n           1. [Host d3.js locally](chap03.xhtml#leanpub-auto-host-d3js-locally)\n           2. [Use a remote CDN to always use the latest version of d3.js](chap03.xhtml#leanpub-auto-use-a-remote-cdn-to-always-use-the-latest-version-of-d3js)\n           3. [Potential directory structure](chap03.xhtml#leanpub-auto-potential-directory-structure)\n        3. [Where to get information on d3.js](chap03.xhtml#leanpub-auto-where-to-get-information-on-d3js)\n           1. [d3js.org](chap03.xhtml#leanpub-auto-d3jsorg)\n           2. [Google Groups](chap03.xhtml#leanpub-auto-google-groups)\n           3. [Stack Overflow](chap03.xhtml#leanpub-auto-stack-overflow)\n           4. [Github](chap03.xhtml#leanpub-auto-github)\n           5. [bl.ocks.org](chap03.xhtml#leanpub-auto-blocksorg)\n           6. [Twitter](chap03.xhtml#leanpub-auto-twitter)\n           7. [Books](chap03.xhtml#leanpub-auto-books)\n  5. [Starting with a simple graph](chap04.xhtml#simplegraph)\n     1. [HTML](chap04.xhtml#html)\n     2. [Cascading Style Sheets (CSS)](chap04.xhtml#css)\n     3. [D3 JavaScript](chap04.xhtml#javascript)\n        1. [Setting up the margins and the graph area.](chap04.xhtml#leanpub-auto-setting-up-the-margins-and-the-graph-area)\n        2. [Getting the Data](chap04.xhtml#leanpub-auto-getting-the-data)\n        3. [Formatting the Date / Time.](chap04.xhtml#leanpub-auto-formatting-the-date--time)\n        4. [Setting Scales Domains and Ranges](chap04.xhtml#leanpub-auto-setting-scales-domains-and-ranges)\n        5. [Adding data to the line function](chap04.xhtml#leanpub-auto-adding-data-to-the-line-function)\n        6. [Adding the SVG element.](chap04.xhtml#leanpub-auto-adding-the-svg-element)\n        7. [Actually Drawing Something!](chap04.xhtml#leanpub-auto-actually-drawing-something)\n           1. [Drawing the line](chap04.xhtml#leanpub-auto-drawing-the-line)\n           2. [Drawing the Axes](chap04.xhtml#leanpub-auto-drawing-the-axes)\n     4. [Wrap Up](chap04.xhtml#leanpub-auto-wrap-up)\n  6. [Things we can do with the simple graph](chap05.xhtml#leanpub-auto-things-we-can-do-with-the-simple-graph)\n     1. [Setting up and configuring the Axes](chap05.xhtml#axes)\n        1. [Change the text size](chap05.xhtml#leanpub-auto-change-the-text-size)\n        2. [Changing the number of ticks on an axis](chap05.xhtml#leanpub-auto-changing-the-number-of-ticks-on-an-axis)\n        3. [Rotating text labels for a graph axis](chap05.xhtml#leanpub-auto-rotating-text-labels-for-a-graph-axis)\n        4. [Formatting a date / time axis with specified values](chap05.xhtml#leanpub-auto-formatting-a-date--time-axis-with-specified-values)\n     2. [Adding Axis Labels](chap05.xhtml#axislabels)\n        1. [The x axis label](chap05.xhtml#leanpub-auto-the-x-axis-label)\n        2. [The y axis label](chap05.xhtml#leanpub-auto-the-y-axis-label)\n     3. [How to add a title to your graph](chap05.xhtml#title)\n     4. [Change a line chart into a scatter plot](chap05.xhtml#leanpub-auto-change-a-line-chart-into-a-scatter-plot)\n     5. [Smoothing out graph lines](chap05.xhtml#smoothing)\n     6. [Make a dashed line](chap05.xhtml#leanpub-auto-make-a-dashed-line)\n     7. [Filling an area under the graph](chap05.xhtml#leanpub-auto-filling-an-area-under-the-graph)\n        1. [CSS for an area fill](chap05.xhtml#leanpub-auto-css-for-an-area-fill)\n        2. [Define the area function](chap05.xhtml#leanpub-auto-define-the-area-function)\n        3. [Draw the area](chap05.xhtml#leanpub-auto-draw-the-area)\n        4. [Filling an area above the line](chap05.xhtml#leanpub-auto-filling-an-area-above-the-line)\n     8. [Adding a drop shadow to allow text to stand out on graphics.](chap05.xhtml#leanpub-auto-adding-a-drop-shadow-to-allow-text-to-stand-out-on-graphics)\n        1. [CSS for white shadowy background](chap05.xhtml#leanpub-auto-css-for-white-shadowy-background)\n        2. [Drawing the white shadowy background.](chap05.xhtml#leanpub-auto-drawing-the-white-shadowy-background)\n     9. [Adding grid lines to a graph](chap05.xhtml#leanpub-auto-adding-grid-lines-to-a-graph)\n        1. [The grid line CSS](chap05.xhtml#leanpub-auto-the-grid-line-css)\n        2. [Define the grid line functions](chap05.xhtml#leanpub-auto-define-the-grid-line-functions)\n        3. [Draw the lines](chap05.xhtml#leanpub-auto-draw-the-lines)\n     10. [Adding more than one line to a graph](chap05.xhtml#leanpub-auto-adding-more-than-one-line-to-a-graph)\n     11. [Labelling multiple lines on a graph](chap05.xhtml#leanpub-auto-labelling-multiple-lines-on-a-graph)\n     12. [Multiple axes for a graph](chap05.xhtml#leanpub-auto-multiple-axes-for-a-graph)\n  7. [Elements, Attributes and Styles](chap06.xhtml#leanpub-auto-elements-attributes-and-styles)\n     1. [The Framework](chap06.xhtml#EASframework)\n     2. [Elements](chap06.xhtml#elements)\n        1. [Circle](chap06.xhtml#circle)\n        2. [Ellipse](chap06.xhtml#leanpub-auto-ellipse)\n        3. [Rectangle](chap06.xhtml#leanpub-auto-rectangle)\n        4. [Line](chap06.xhtml#leanpub-auto-line)\n        5. [Polyline](chap06.xhtml#leanpub-auto-polyline)\n        6. [Polygon](chap06.xhtml#leanpub-auto-polygon)\n        7. [Path](chap06.xhtml#leanpub-auto-path)\n        8. [Clipped Path (AKA clipPath)](chap06.xhtml#clipPath)\n        9. [Text](chap06.xhtml#leanpub-auto-text)\n           1. [Anchor at the bottom, middle of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-bottom-middle-of-the-text)\n           2. [Anchor at the bottom, right of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-bottom-right-of-the-text)\n           3. [Anchor at the middle, left of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-middle-left-of-the-text)\n           4. [Anchor in the middle, centre of the text:](chap06.xhtml#leanpub-auto-anchor-in-the-middle-centre-of-the-text)\n           5. [Anchor in the middle, right of the text:](chap06.xhtml#leanpub-auto-anchor-in-the-middle-right-of-the-text)\n           6. [Anchor at the top, left of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-top-left-of-the-text)\n           7. [Anchor at the top, middle of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-top-middle-of-the-text)\n           8. [Anchor at the top, right of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-top-right-of-the-text)\n     3. [Attributes](chap06.xhtml#leanpub-auto-attributes)\n        1. [`x`, `y`](chap06.xhtml#leanpub-auto-x-y)\n        2. [`x1`, `x2`, `y1`, `y2`](chap06.xhtml#leanpub-auto-x1-x2-y1-y2)\n        3. [points](chap06.xhtml#leanpub-auto-points)\n        4. [`cx`, `cy`](chap06.xhtml#leanpub-auto-cx-cy)\n        5. [`r`](chap06.xhtml#leanpub-auto-r)\n        6. [`rx`, `ry`](chap06.xhtml#leanpub-auto-rx-ry)\n        7. [`transform (translate(x,y), scale(k), rotate(a))`](chap06.xhtml#leanpub-auto-transform-translatexy-scalek-rotatea)\n           1. [`transform (translate(x,y))`](chap06.xhtml#leanpub-auto-transform-translatexy)\n           2. [`transform (scale(k))`](chap06.xhtml#leanpub-auto-transform-scalek)\n           3. [`transform (rotate(a))`](chap06.xhtml#leanpub-auto-transform-rotatea)\n        8. [`width`, `height`](chap06.xhtml#leanpub-auto-width-height)\n        9. [`text-anchor`](chap06.xhtml#leanpub-auto-text-anchor)\n        10. [`dx`, `dy`](chap06.xhtml#leanpub-auto-dx-dy)\n        11. [`textLength`](chap06.xhtml#leanpub-auto-textlength)\n        12. [`lengthAdjust`](chap06.xhtml#leanpub-auto-lengthadjust)\n     4. [Styles](chap06.xhtml#leanpub-auto-styles)\n        1. [`fill`](chap06.xhtml#leanpub-auto-fill)\n        2. [`stroke`](chap06.xhtml#leanpub-auto-stroke)\n        3. [`opacity`](chap06.xhtml#leanpub-auto-opacity)\n        4. [`fill-opacity`](chap06.xhtml#leanpub-auto-fill-opacity)\n        5. [`stroke-opacity`](chap06.xhtml#leanpub-auto-stroke-opacity)\n        6. [`stroke-width`](chap06.xhtml#leanpub-auto-stroke-width)\n        7. [`stroke-dasharray`](chap06.xhtml#leanpub-auto-stroke-dasharray)\n        8. [`stroke-linecap`](chap06.xhtml#leanpub-auto-stroke-linecap)\n        9. [`stroke-linejoin`](chap06.xhtml#leanpub-auto-stroke-linejoin)\n        10. [`writing-mode`](chap06.xhtml#leanpub-auto-writing-mode)\n        11. [`glyph-orientation-vertical`](chap06.xhtml#leanpub-auto-glyph-orientation-vertical)\n        12. [Using styles in Cascading Style Sheets](chap06.xhtml#leanpub-auto-using-styles-in-cascading-style-sheets)\n  8. [Manipulating data](chap07.xhtml#leanpub-auto-manipulating-data)\n     1. [How to use data imported from a csv file with spaces in the header.](chap07.xhtml#leanpub-auto-how-to-use-data-imported-from-a-csv-file-with-spaces-in-the-header)\n     2. [Extracting data from a portion of a string.](chap07.xhtml#leanpub-auto-extracting-data-from-a-portion-of-a-string)\n     3. [Grouping and summing data (d3.nest)](chap07.xhtml#nest)\n     4. [Selecting a random string from an array.](chap07.xhtml#leanpub-auto-selecting-a-random-string-from-an-array)\n  9. [Bar Charts and Histograms](chap08.xhtml#leanpub-auto-bar-charts-and-histograms)\n     1. [Bar Chart](chap08.xhtml#leanpub-auto-bar-chart)\n        1. [Histogram](chap08.xhtml#leanpub-auto-histogram)\n     2. [Bar Charts](chap08.xhtml#leanpub-auto-bar-charts)\n        1. [The data](chap08.xhtml#leanpub-auto-the-data)\n        2. [The code](chap08.xhtml#leanpub-auto-the-code)\n        3. [The bar chart explained](chap08.xhtml#leanpub-auto-the-bar-chart-explained)\n     3. [Histograms](chap08.xhtml#leanpub-auto-histograms)\n        1. [The data](chap08.xhtml#leanpub-auto-the-data-1)\n        2. [The code](chap08.xhtml#leanpub-auto-the-code-1)\n        3. [The histogram explained](chap08.xhtml#leanpub-auto-the-histogram-explained)\n  10. [Tree Diagrams](chap09.xhtml#leanpub-auto-tree-diagrams)\n     1. [What is a Tree Diagram?](chap09.xhtml#leanpub-auto-what-is-a-tree-diagram)\n     2. [A simple Tree Diagram explained](chap09.xhtml#leanpub-auto-a-simple-tree-diagram-explained)\n     3. [A horizontal tree diagram explained](chap09.xhtml#leanpub-auto-a-horizontal-tree-diagram-explained)\n     4. [Styling nodes in a tree diagram](chap09.xhtml#leanpub-auto-styling-nodes-in-a-tree-diagram)\n        1. [Changing node and link colours](chap09.xhtml#tree-styling)\n        2. [Changing the nodes to different shapes](chap09.xhtml#leanpub-auto-changing-the-nodes-to-different-shapes)\n        3. [Using images as nodes](chap09.xhtml#leanpub-auto-using-images-as-nodes)\n     5. [Generating a tree diagram from external data](chap09.xhtml#treeFromExternal)\n     6. [Generating a tree diagram from ‘flat’ data](chap09.xhtml#treeFromFlat)\n     7. [Generating a tree diagram from a CSV file.](chap09.xhtml#leanpub-auto-generating-a-tree-diagram-from-a-csv-file)\n     8. [An interactive tree diagram](chap09.xhtml#leanpub-auto-an-interactive-tree-diagram)\n  11. [Sankey Diagrams](chap10.xhtml#leanpub-auto-sankey-diagrams)\n     1. [What is a Sankey Diagram?](chap10.xhtml#leanpub-auto-what-is-a-sankey-diagram)\n     2. [Which Sankey plugin should we use?](chap10.xhtml#leanpub-auto-which-sankey-plugin-should-we-use)\n     3. [How d3.js Sankey Diagrams want their data formatted](chap10.xhtml#sankeydata)\n     4. [Description of the code](chap10.xhtml#leanpub-auto-description-of-the-code)\n     5. [Formatting data for Sankey diagrams](chap10.xhtml#leanpub-auto-formatting-data-for-sankey-diagrams)\n        1. [From a JSON file with numeric link values](chap10.xhtml#leanpub-auto-from-a-json-file-with-numeric-link-values)\n        2. [From a JSON file with links as names](chap10.xhtml#leanpub-auto-from-a-json-file-with-links-as-names)\n        3. [From a CSV with ‘source’, ‘target’ and ‘value’ info only.](chap10.xhtml#leanpub-auto-from-a-csv-with-source-target-and-value-info-only)\n  12. [Assorted Tips and Tricks](chap11.xhtml#leanpub-auto-assorted-tips-and-tricks)\n     1. [Change a line chart into a scatter plot](chap11.xhtml#scatterplot)\n     2. [Adding tooltips.](chap11.xhtml#leanpub-auto-adding-tooltips)\n        1. [Transitions](chap11.xhtml#leanpub-auto-transitions)\n        2. [Events](chap11.xhtml#leanpub-auto-events)\n        3. [Get tipping](chap11.xhtml#leanpub-auto-get-tipping)\n        4. [on.mouseover](chap11.xhtml#leanpub-auto-onmouseover)\n        5. [on.mouseout](chap11.xhtml#leanpub-auto-onmouseout)\n        6. [Including an HTML link in a tool tip](chap11.xhtml#leanpub-auto-including-an-html-link-in-a-tool-tip)\n           1. [Moar Links!](chap11.xhtml#leanpub-auto-moar-links)\n     3. [What are the predefined, named colours?](chap11.xhtml#leanpub-auto-what-are-the-predefined-named-colours)\n     4. [Selecting / filtering a subset of objects](chap11.xhtml#filtering)\n     5. [Select items with an IF statement.](chap11.xhtml#leanpub-auto-select-items-with-an-if-statement)\n     6. [Applying a colour gradient to a line based on value.](chap11.xhtml#leanpub-auto-applying-a-colour-gradient-to-a-line-based-on-value)\n     7. [Applying a colour gradient to an area fill.](chap11.xhtml#leanpub-auto-applying-a-colour-gradient-to-an-area-fill)\n     8. [Transitions](chap11.xhtml#leanpub-auto-transitions-1)\n        1. [Transitioning Chaining](chap11.xhtml#chaining)\n        2. [Transition Easing](chap11.xhtml#leanpub-auto-transition-easing)\n        3. [Looping a Transition](chap11.xhtml#leanpub-auto-looping-a-transition)\n     9. [Show / hide an element by clicking on another element](chap11.xhtml#leanpub-auto-show--hide-an-element-by-clicking-on-another-element)\n        1.            1. [The code](chap11.xhtml#leanpub-auto-the-code-2)\n     10. [Using HTML inputs with d3.js](chap11.xhtml#leanpub-auto-using-html-inputs-with-d3js)\n        1. [What is an HTML input?](chap11.xhtml#leanpub-auto-what-is-an-html-input)\n        2. [Using a `range` input with d3.js](chap11.xhtml#leanpub-auto-using-a-range-input-with-d3js)\n           1. [The code](chap11.xhtml#leanpub-auto-the-code-3)\n           2. [The explanation](chap11.xhtml#leanpub-auto-the-explanation)\n        3. [Using more than one input](chap11.xhtml#leanpub-auto-using-more-than-one-input)\n           1. [The code](chap11.xhtml#leanpub-auto-the-code-4)\n           2. [The explanation](chap11.xhtml#leanpub-auto-the-explanation-1)\n        4. [Rotate text with an input](chap11.xhtml#leanpub-auto-rotate-text-with-an-input)\n           1. [The explanation](chap11.xhtml#leanpub-auto-the-explanation-2)\n        5. [Use a `number` input with d3.js](chap11.xhtml#leanpub-auto-use-a-number-input-with-d3js)\n        6. [Change more than one element with an input](chap11.xhtml#leanpub-auto-change-more-than-one-element-with-an-input)\n           1. [The code](chap11.xhtml#leanpub-auto-the-code-5)\n           2. [The explanation](chap11.xhtml#leanpub-auto-the-explanation-3)\n     11. [Add an HTML table to your graph](chap11.xhtml#tables)\n        1. [HTML Tables](chap11.xhtml#leanpub-auto-html-tables)\n        2. [First the CSS](chap11.xhtml#leanpub-auto-first-the-css)\n        3. [Now the d3.js code](chap11.xhtml#leanpub-auto-now-the-d3js-code)\n        4. [A small but cunning change…](chap11.xhtml#leanpub-auto-a-small-but-cunning-change)\n        5. [Explaining the d3.js code (reloaded).](chap11.xhtml#leanpub-auto-explaining-the-d3js-code-reloaded)\n        6. [Wrap up](chap11.xhtml#leanpub-auto-wrap-up-1)\n     12. [More table madness: sorting, prettifying and adding columns](chap11.xhtml#leanpub-auto-more-table-madness-sorting-prettifying-and-adding-columns)\n        1. [Add another column of information:](chap11.xhtml#leanpub-auto-add-another-column-of-information)\n        2. [Sorting on a column](chap11.xhtml#leanpub-auto-sorting-on-a-column)\n        3. [Prettifying (actually just capitalising the header for each column)](chap11.xhtml#leanpub-auto-prettifying-actually-just-capitalising-the-header-for-each-column)\n        4. [Add borders](chap11.xhtml#leanpub-auto-add-borders)\n     13. [Adding web links to d3.js objects](chap11.xhtml#leanpub-auto-adding-web-links-to-d3js-objects)\n        1. [It’s all about the ‘a’ and the ‘xlink’](chap11.xhtml#leanpub-auto-its-all-about-the-a-and-the-xlink)\n        2. [Adding in the links](chap11.xhtml#leanpub-auto-adding-in-the-links)\n        3. [Making the mouse pointer ignore an object](chap11.xhtml#leanpub-auto-making-the-mouse-pointer-ignore-an-object)\n     14. [Using the Yahoo Query Language (YQL) to get data.](chap11.xhtml#leanpub-auto-using-the-yahoo-query-language-yql-to-get-data)\n        1. [YQL by example](chap11.xhtml#leanpub-auto-yql-by-example)\n     15. [Export an image from a d3.js page as a SVG or bitmap](chap11.xhtml#leanpub-auto-export-an-image-from-a-d3js-page-as-a-svg-or-bitmap)\n        1. [Bitmaps](chap11.xhtml#leanpub-auto-bitmaps)\n        2. [Vector Graphics (Specifically SVG)](chap11.xhtml#svg)\n        3. [Let’s get exporting!](chap11.xhtml#leanpub-auto-lets-get-exporting)\n           1. [Copying the image off the web page](chap11.xhtml#leanpub-auto-copying-the-image-off-the-web-page)\n           2. [Open the SVG Image and Edit](chap11.xhtml#leanpub-auto-open-the-svg-image-and-edit)\n           3. [Saving as a bitmap](chap11.xhtml#leanpub-auto-saving-as-a-bitmap)\n     16. [Understanding JavaScript Object Notation (JSON)](chap11.xhtml#json)\n  13. [D3.js Examples Explained](chap12.xhtml#leanpub-auto-d3js-examples-explained)\n     1. [Multi-line graph with automatic legend and toggling show / hide lines.](chap12.xhtml#leanpub-auto-multi-line-graph-with-automatic-legend-and-toggling-show--hide-lines)\n        1. [Purpose](chap12.xhtml#leanpub-auto-purpose)\n        2. [The Code](chap12.xhtml#leanpub-auto-the-code-6)\n        3. [Description](chap12.xhtml#leanpub-auto-description)\n           1. [Nesting the data](chap12.xhtml#leanpub-auto-nesting-the-data)\n           2. [Applying the colours](chap12.xhtml#leanpub-auto-applying-the-colours)\n           3. [Adding the legend](chap12.xhtml#leanpub-auto-adding-the-legend)\n           4. [Making it interactive](chap12.xhtml#leanpub-auto-making-it-interactive)\n\n## Guide\n\n  1. [Begin Reading](chap00.xhtml)\n\n\n## Acknowledgements\n\n### Mike\n\nFirst and foremost I would like to express my thanks to Mike Bostock, the\ndriving force behind d3.js. His efforts are tireless and his altruism in\nmaking his work open and available to the masses is inspiring.\n\nThe decision for him to leave what must have been an incredible job with the\nNew York Times to return to improving visualisation software (d3.js in\nparticular) has marked him as a very special person indeed. If any reader of\nthis book has the opportunity to support his continuing efforts, please do.\n\n### Partners, Supporters and Contributors.\n\nMike has worked with a crew of like-minded individuals in bringing D3 to the\nWorld. Vadim Ogievetsky and Jeffrey Heer share honours for the work on [D3:\nData-Driven Documents](http://vis.stanford.edu/papers/d3) and while there has\nbeen a cast of over 40 people contributing to the D3 code base, Jason Davies\nstands out as the man who has provided a generous portion especially in the\narea of mapping.\n\nNick Zhu has created a fantastic resource in\n[dc.js](https://github.com/NickQiZhu/dc.js/wiki) (which is built on top of\nd3.js and crossfilter) and has been kind enough to provide good advice and\npermission to include some of his work.\n\nAdvice given by Christophe Viau has been a great help in getting me settled\ninto the on-line world and his energy in managing and directing the D3\ncommunity is amazing.\n\nMike Dewar (_Getting Started with D3_), Scott Murray (_Interactive Data\nVisualization for the Web_) and Sebastian Gutierrez\n([dashingd3js.com](http://www.dashingd3js.com/)) lead the pack for providing\nhigh quality reference material for learning D3. Many thanks gentlemen.\n\n### Proof Reading\n\nI am particularly grateful for the assistance given by Filiep Spyckerelle and\nRobin Bennett who selflessly donated their time and expertise in proofreading\nthe earlier edition of D3 Tips and Tricks (d3.js v3) (where this document\ncontains any errors, they are most certainly mine).\n\nIn fact Robin has been very quick off the mark and is feeding back areas for\nimprovement in the new book already!\n\n### The d3.js Community\n\nBig thanks go out to the D3 community. Whether providing advice on Google\nGroups or Stack Overflow, contributing examples on bl.ocks.org or just giving\nback in the form of time and effort to similar work. Well done all.\n\n### Cover art\n\nOut of the blue and in yet another example of the friendly and giving nature\nof people involved in this community I was contacted by Jose (‘Tactician\nJenro’) who offered to use his skills to design a cover for the original book.\nHe has subsequently designed the cover for this version and I think he did an\nawesome job and was super helpful. If you think that he could help you out\nwith a project, you can get in touch with him at\n[@tacticianjenro](https://twitter.com/mindthetimes) or via his web site at\n<http://mindthetimes.xyz/>.\n\n![A sampling of works by Tactician Jenro](images/banner.jpg) A sampling of\nworks by Tactician Jenro\n\n### Leanpub\n\nLastly, I want to pay homage to [Leanpub](https://leanpub.com/) who have made\nthe publishing of this document possible. They offer an outstanding service\nfor self-publishing and have made the task of providing and distributing\ncontent achievable.\n\n### Make sure you get the most up to date copy of D3 Tips and Tricks\n\nIf you’ve received a copy of this book from any location other than\n[Leanpub](https://leanpub.com/d3-t-and-t-v4) then it’s possible that you\nhaven’t got the latest version. Go to https://leanpub.com/d3-t-and-t-v4 and\ndownload the most recent version. After all, it won’t cost you anything :-).\nIf you find some value in the work, please consider contributing when you\ndownload it so that Leanpub get something for hosting the book (and I’ll think\nof you fondly while I continue adding content :-D).\n\n\n## What is d3.js?\n\n[d3.js](http://d3js.org/) (hereafter abridged as D3) is “ _a JavaScript\nlibrary for manipulating documents based on data_ ”.\n\nBut that description doesn’t do it justice.\n\nD3 is all about helping you to take information and make it more accessible to\nothers via a web browser.\n\nIt’s a JavaScript library. That means that it’s a software tool that can be\nused in conjunction with other software tools to achieve a task. Those other\ntools are based on web standards such as HTML, SVG and CSS but you don’t need\nto know too much about them to start using D3 (although it will help :-)).\n\nIt’s an open framework, which means that there are no hidden mysteries about\nhow it does its magic and it allows others to contribute to a constant cycle\nof improvement.\n\nBeing built to leverage web standards means that modern browsers don’t have to\ndo anything special to use D3, they just have to support the framework that\nthe Internet has adopted for ease of use.\n\nThe beauty of D3 is that it allows you to associate data and what appears on\nthe screen in a way that directly links the two. Change the data and you\nchange the object on the screen. D3’s trick is to let you set what appears on\nthe screen. A circle, a line, a point on a map, a graph, a bouncing ball, a\ngradient (and way, way more). Once the data and the object are linked the\npossibilities are endless.\n\nD3 bridges the gap between the static display of data and the desire of people\nto represent it dynamically. That applies equally to the developer who wants\nto show something cool and to the end user who wants to be able to explore\ninformation interactively.\n\nIt was (and still is being) developed by [Mike\nBostock](http://bost.ocks.org/mike/) who has not just spent time writing the\ncode, but writing the [documentation](https://github.com/mbostock/d3/wiki) for\nD3 as well. There is an extensive community of supporters who also contribute\nto the code, provide technical\n[support](https://groups.google.com/forum/?fromgroups#!forum/d3-js)\n[online](http://stackoverflow.com/questions/tagged/d3.js) and generally have\nfun creating amazing\n[visualizations](https://github.com/mbostock/d3/wiki/Gallery). Their\ncontributions are extraordinary (you only have to look at the work of Jason\nDavies to be amazed).\n\nThis book has been written to incorporate the changes in version 4 of d3.js to\nthe original edition of D3 Tips and Tricks. If you’re looking for the\nequivalent for version 3 you can find it [here](https://leanpub.com/D3-Tips-\nand-Tricks).\n\n\n## Introduction\n\nI never set out to write treatise on D3… But here I am three years after\npublishing the first version of this book and I’m in the process of updating\nit for version 4 of d3.js, while also looking back at a range of other books\nthat have been written as a result of this first foray into publishing.\n\nI am a simple user of this extraordinary framework and when I say simple, I\n_really_ mean I had no idea how to get it to do anything when I started; I\nneeded to do a lot of searching and learned by trial-and-error (emphasis on\nthe errors which were entirely mine). The one thing that I did know was that\nthe example graphics shown by Mike Bostock and others were the sort of\ngraphical goodness that I wanted to play with.\n\nSo to get from the point of having no skills whatsoever to the point where I\ncould begin to code up something to display data in a way I wanted, I had to\ncapture the information as I went. The really cool thing about this sort of\nprocess is that it doesn’t need to occur all at once. You can start with no\nknowledge whatsoever (or pretty close) and by standing on the shoulders of\nother’s work, you can add building blocks to improve what you’re seeing and\nthen change the blocks to adapt and improve.\n\nFor example (and this is pretty much how it started). I wanted to draw a line\ngraph, so I imported an example and then got it running locally on my\ncomputer. Then I worked out how to change the example data for my data. Then I\nworked out how to move the Y axis from the right to the left. Then how to make\nthe axis labels larger, change the tick size, make the lines fatter, change\nthe colour, add a label, fill the area under the graph, put the graph in the\ncentre of the page, add a glow to the text to help it stand out, put it in a\nframework (bootstrap), add buttons to change data sets, animate the\ntransitions between data sets, update the data automatically when it changed,\nadd a pan and zoom feature, turn parts of the graph into hyperlinks to move to\nother graphs… And then I started on bar graphs :-).\n\nThe point to take away from all of this is that any one graph is just a\ncollection of lots of blocks of code, each block designed to carry out a\nspecific function. Pick the blocks you want and implement them.\n\nI found it was much simpler to work on one thing (block) at a time, and this\nhelped greatly to reduce the uncertainty factor when things didn’t work as\nanticipated. I’m not going to pretend that everything I’ve done while trying\nto build graphs employs the most elegant or efficient mechanism, but in the\nend, if it all works on the screen, I walk away happy :-). That’s not to say I\nhave deliberately ignored any best practices – I just never knew what they\nwere. Likewise, wherever possible, I have tried to make things as extensible\nas possible.\n\nD3 has also steered down the road of providing standalone micro-libraries\navailable as components and this flexibility continues to redefine the maxim\nof change being the only constant in the software world.\n\nYou will find that I have typically eschewed a simple “Do this approach” for\nmore of a story telling exercise. This means that some explanations are longer\nand more flowery than might be to everyone’s liking, but there you go, try to\nbe brave :-)\n\nI’m sure most authors try to be as accessible as possible. I’d like to do the\nsame, but be warned… There’s a good chance that if you ask me a technical\nquestion I may not know the answer. So please be gentle with your emails :-).\n\nEmail: ‘d3noobmail+contact@gmail.com’\n\n\n## What do we need to get started?\n\nLet’s be honest with each other. D3 is not the simplest way to draw a graph.\n\nHowever, that doesn’t mean that it’s beyond those with a little computer savy\nand a willingness to experiment. Remember failure is your friend (I am fairly\nsure that I am also related by blood). Just learn from your mistakes and it’ll\nall work out.\n\nSo, here in no particular order is a list of good things to know. None of\nwhich are essential, but any one (or more) of which will make your life\nslightly easier.\n\n  * HyperText Markup Language (HTML)\n  * JavaScript\n  * Cascading Style Sheets (CSS)\n  * Web Servers\n  * PHP\n\n### **DON’T FREAK OUT!**\n\nFirst things first. This isn’t rocket science. It’s just the Internet. We’ll\ntake it gently, and I’ll be a little more specific in the following sections.\n\n### HTML\n\nThis stands for HyperText Markup Language and is the stuff that web pages are\nmade of. Check out the definition and other information on\n[Wikipedia](http://en.wikipedia.org/wiki/HTML) for a great overview. Just\nremember that all you’re going to use HTML for is to hold the code that you\nwill use to present your information. This will be as a .html (or .htm) file\nand they can be pretty simple (we’ll look at some in a moment).\n\n### JavaScript\n\n[JavaScript](http://en.wikipedia.org/wiki/JavaScript) is what’s called a\n‘scripting language’. It is the code that will be contained inside the HTML\nfile that will make D3 do all its fanciness. In fact, D3 is a JavaScript\nLibrary, it’s the native language for using D3.\n\nKnowing a little bit about this would be really good, but to be perfectly\nhonest, I didn’t know anything about it before I started. I read a book along\nthe way ([JavaScript: The Missing\nManual](http://shop.oreilly.com/product/9780596515898.do) from O’Reilly) and\nthat helped with context, but the examples that are available for D3 graphics\nare understandable, and with a bit of trial and error, you can figure out\nwhat’s going on.\n\nIn fact, most of what this collection of information’s about is providing\nexamples and explanations for the JavaScript components of D3.\n\n### Cascading Style Sheets (CSS)\n\n[Cascading Style Sheets](http://en.wikipedia.org/wiki/Css) (everyone tends to\ncall them ‘Style Sheets’ or ‘CSS’) is a language used to describe the\nformatting (or “ _look and feel_ ”) of a document written in a markup\nlanguage. The job of CSS is to make the presentation of the components you\nwill draw with D3 simpler by assigning specific styles to specific objects.\nOne of the cool things about CSS is that it is an enormously flexible and\nefficient method for making everything on the screen look more consistent and\nwhen you want to change the format of something you can just change the CSS\ncomponent and the whole look and feel of your graphics will change.\n\n![The wonderful World of Cascading Style Sheets](images/wordcloud.png) The\nwonderful World of Cascading Style Sheets\n\n### Full disclosure\n\nI know CSS is an incredibly powerful tool that would make my life easier, but\nI use it in a very basic (and probably painful) way. Don’t judge me, just\naccept that the way I’ve learnt was what I needed to get the job done (this\nprobably means that noobs like myself will find it easier, but where possible\ntry and use examples that include what look like logical CSS structures).\n\n### Web Servers\n\nWeb servers can go one of two ways. If you have access to a web server and\nknow where to put the files so that you can access them with your browser,\nyou’re in a good place. If you’re not quite sure, read on…\n\nA web server will allow you to access your HTML files and will provide the\nstructure that allows it to be displayed on a web browser. There are some\nsimple instructions on the main [D3 wiki\npage](https://github.com/mbostock/d3/wiki) for setting up a local server. Or\nyou might have access to a remote one and be able to upload your files.\nHowever, for a little more functionality and a whole lot of ease of use, I can\nthoroughly recommend WampServer (WAMP) as a free and simple way to set up a\nlocal web server that includes PHP and a MySQL database (more on those later).\nGo to the [WampServer web page](http://www.wampserver.com/en/)\n(http://www.wampserver.com/en/) and see if it suits you.\n\nThroughout this document I will be describing the files and how they’re laid\nout in a way that has suited my efforts while using WAMP, but they will work\nequally well on a remote server. I will explain a little more about how I\narrange the files later in the ‘Getting D3’ section.\n\n![WAMP = Windows + Apache + MySQL + PHP](images/wamp.png) WAMP = Windows +\nApache + MySQL + PHP\n\nThere are other options of course. You could host code on\n[GitHub](https://github.com/about) and present the resulting graphics on\n[bl.ocks.org](http://bl.ocks.org/). This is a great way to make sure that your\ncode is available for peer review and sharing with the wider community.\n\nOne such alternative option that I have recently started playing with is\nPlunker (http://plnkr.co/) This is a lightweight collaborative online editing\ntool. It’s so cool I wrote a special section for it which you can find later\nin this document. This is definitely worth trying if you want to use something\nsimple without a great deal of overhead. If you like what you see, perhaps\nconsider an alternative that provides a greater degree of capability if you go\non to greater d3.js things.\n\n### PHP\n\nPHP is a scripting language for the web. That is to say that it is a\nprogramming language which is executed when you load web pages and it helps\nweb pages do dynamic things.\n\nYou might think that this sounds familiar and that JavaScript does the same\nthing. But not quite.\n\nJavaScript is designed so that it travels _with_ the web page when it is\ndownloaded by a browser (the **client**). However, PHP is executed remotely on\nthe **server** that supplies the web page. This might sound a bit redundant,\nbut it’s a big deal. This means that the PHP which is executed doesn’t form\n_part_ of the web page, but it can _form_ the web page. The implication here\nis that the web page you are viewing can be altered by the PHP code that runs\non a remote server. This is the dynamic aspect of it.\n\nIn practice, PHP could be analogous to the glue that binds web pages together.\nAllowing different portions of the web page to respond to directions from the\nend user.\n\nIt is widely recognised not only as a relatively simple language to learn, but\nalso as a fairly powerful one. At the same time it comes into criticism for\nbeing somewhat fragmented and sometimes contradictory or confusing. But in\nspite of any perceived shortcomings, it is a very widely used and implemented\nlanguage and one for which there is no obvious better option.\n\n### Other Useful Stuff\n\n#### Text Editor\n\nA good text editor for writing up your code will be a real boost. Don’t make\nthe fatal mistake of using an office word processor or similar. **THEY WILL\nDOOM YOU TO A LIFE OF MISERY**. They add in crazy stuff that you can’t even\nsee and never save the files in a way that can be used properly.\n\nPreferably, you should get an editor that will provide some assistance in the\nform of syntax highlighting which is where the editor knows what language you\nare writing in (JavaScript for example) and highlights the text in a way that\nhelps you read it. For example, it will change text that might appear as this;\n\n    \n    \n    // Get the data\n    d3.tsv(\"data/data.tsv\", function(error, data) {\n    data.forEach(function(d) {\n        d.date = parseDate(d.date\n        d.close = +d.close;\n    });\n    \n\nInto something like this;\n\n    \n    \n    // Get the data\n    d3.tsv(\"data/data.tsv\", function(error, data) {\n    data.forEach(function(d) {\n        d.date = parseDate(d.date);\n        d.close = +d.close;\n    });\n    \n\nInfinitely easier to use. Trust me.\n\nThere are plenty of editors that will do the trick. I have a preference for\n[Geany](http://www.geany.org/), mainly because it’s what I started with and it\ngrew on me :-).\n\n#### Getting D3\n\nLuckily this is pretty easy and could go one of two ways.\n\n##### Host d3.js locally\n\nGo to the D3 repository on [github](https://github.com/mbostock/d3) and\ndownload the entire repository by clicking on the ‘ZIP’ button.\n\n![Download the repository as a zip file](images/downloadrepository.png)\nDownload the repository as a zip file\n\nWhat you do with it from here depends on how you’re hosting your graphs. If\nyou’re working on them on your local PC, then you will want to have the d3.js\nfile in the path that can be seen by the browser. Again, I would recommend\nWAMP (a local web server) to access your files locally. If you’re using WAMP,\nthen you just have to make sure that it knows to use a directory that will\ncontain the d3 directory and you will be away.\n\n##### Use a remote CDN to always use the latest version of d3.js\n\nThe alternative to downloading d3.js and using it locally is to always\nretrieve it from an online source. For d3.js this could be done via having the\nfollowing line in our JavaScript; `<script\nsrc=\"https://d3js.org/d3.v4.min.js\"></script>`. This method has the advantage\nof always using the latest version of D3 and is especially useful if your\nvisualisations are hosted somewhere like bl.ocks.org.\n\n##### Potential directory structure\n\nThe following image is intended to provide a very crude overview of how we can\nset up the directories for our web server.\n\n![A potential directory structure for your files](images/dirlayout.png) A\npotential directory structure for your files\n\n  * webserver: Use this as our ‘base’ directory where you put our files that we create. That way when we open our browser we point to this directory and it allows us to access the files like a normal web site.\n  * d3: This would be our unzipped d3 directory. It contains all the examples and more importantly the d3.v4.js file that we need to get things going. To do this we would include a line like the following;\n\n    \n    \n    <script type=\"text/javascript\" src=\"d3/d3.v4.js\"></script>\n    \n\nThis tells our browser that from the file it is running (one of the html graph\nfiles) if it goes into the ‘d3’ folder it will find the `d3.v4.js` file that\nit can load.\n\n  * data: I use this directory to hold any data files that I would use for processing. For example, you will see the following line in the code examples that follow `d3.csv(\"data/data.csv\", function(error, data) {`. Again, that’s telling the browser to go into the ‘data’ directory and to load the ‘data.csv’ file.\n  * js: Often we will find that we will want to include other JavaScript libraries to load. This is a good place to put them.\n\n#### Where to get information on d3.js\n\nD3 has made huge advances in providing an extensible and practical framework\nfor manipulating data as web objects. At the same time there has been\nsignificant increase in information available for people to use it. The\nfollowing is a far from exhaustive list of sources, but from my own experience\nit represents a useful subset of knowledge.\n\n##### d3js.org\n\nd3js.org would be the first port of call for people wanting to know something\nabout d3.js.\n\nFrom the overview on the main page you can access a dizzying array of\n[examples](https://github.com/mbostock/d3/wiki/Gallery) that have been\nprovided by the founder of d3 (Mike Bostock) and a host of additional\ndevelopers, artists, coders and anyone who has something to add to the sum\nknowledge of cool things that can be done with D3.\n\nThere is a link to a [documentation page](https://github.com/mbostock/d3/wiki)\nthat serves as a portal to the ever important API reference, contributed\ntutorials and other valuable links (some of which I will mention in paragraphs\nahead).\n\nThe last major link is to the [Github\nrepository](https://github.com/mbostock/d3) where you can download d3.js\nitself.\n\nIt is difficult to overstate the volume of available information that can be\naccessed from d3js.org. It stands alone as the one location that anyone\ninterested in D3 should visit.\n\n##### Google Groups\n\nThere is a Google Group dedicated to [discussions on\nd3.js](https://groups.google.com/forum/?fromgroups#!forum/d3-js).\n\nIn theory this forum is for discussions on topics including visualization\ndesign, API design, requesting new features, etc. With a specific direction\nmade in the main header that “ _If you want help using D3, please use the\nd3.js tag on Stack Overflow!_ ”.\n\nIn practice however, it would appear that a sizeable proportion of the posts\nthere are technical assistance requests of one type or another. Having said\nthat this means that if you’re having a problem, there could already be a\nsolution posted there. However, if at all possible the intention is certainly\nthat people use Stack Overflow, so this should be the first port of call for\nthose types of inquiry.\n\nSo, by all means add this group as a favourite and this will provide you with\nthe opportunity to receive emailed summaries of postings or just an\nopportunity to easily browse recent goings-on.\n\n##### Stack Overflow\n\nStack Overflow is a question and answer site whose stated desire is “ _to\nbuild a library of detailed answers to every question about programming_ ”.\nAmbitious. So how are they doing? Actually really well. Stack overflow is a\nfantastic place to get help and information. It’s also a great place to help\npeople out if you have some knowledge on a topic.\n\nThey have a funny scheme for rewarding users that encourages providing good\nanswers based on readers voting. It’s a great example of gamification working\nwell. If you want to know a little more about how it works, check out this\npage; http://stackoverflow.com/about.\n\nThey have a d3.js tag (http://stackoverflow.com/questions/tagged/d3.js) and\nlike Google Groups there is a running list of different topics that are an\nexcellent source of information.\n\n##### Github\n\n[Github](https://github.com/) is predominantly a code repository and version\ncontrol site. It is highly regarded for its technical acumen and provides a\nfantastic service that is broadly used for many purposes. Not the least of\nwhich is hosting the code (and the wiki) for d3.js.\n\nWhilst not strictly a site that specialises in providing a Q & A function,\nthere is a significant number of repositories which mention d3.js. With the\nhelp from an astute search phrase, there is potentially a solution to be found\nthere.\n\nThe other associated feature of Github is Gist. Gist is a pastebin service (a\nplace where you can copy and past code) that can provide a ‘wiki like’ feature\nfor individual repositories and web pages that can be edited through a Git\nrepository. Gist plays a role in providing the hub for the bl.ocks.org example\nhosting service set up by Mike Bostock.\n\nFor a new user, Github / Gist can be slightly daunting. It’s an area where you\nwill get most value by understanding something about the services before you\nstart using them. This is certainly true if you want to make use of its\nincredible features that are available for hosting code. However, if you want\nto browse other peoples code it’s an easier introduction. Have a look through\nwhat’s available and if you feel so inclined, I recommend that you learn\nenough to use their service. It’s time well spent.\n\n##### bl.ocks.org\n\n[bl.ocks.org](http://bl.ocks.org/) is a viewer for code examples which are\nhosted on Gist. You are able to load your code into Gist, and then from\nbl.ocks.org you can view them.\n\nThis is a really great way for people to provide examples of their work and\nthere are many who do. However, it’s slightly tricky to know what is there.\nThere is a [project](http://blockbuilder.org/search) that will help with\nsearching the bl.ocks for key words. This is an immensely valuable service\nthat should be a highlight for someone wanting inspiration or assistance.\n\nI would describe the process of getting your own code hosted and displaying as\nsomething that will be slightly challenging for people who are not familiar\nwith Github / Gist, but again, in terms of visibility of the code and\nproviding an external hosting solution, it is excellent and well worth the\ntime to get to grips with.\n\n##### Twitter\n\nTwitter provides a great alerting service to inform a large disparate group of\npeople about _stuff_.\n\nIt’s certainly a great way to keep in touch on an hour by hour basis with\npeople who are involved with d3.js and this can be accomplished in a couple of\nways. First, find as many people from the various D3 sites around the web who\nyou consider to be influential in areas you want to follow (different aspects\nsuch as development, practical output, educational (etc) and follow them. Even\nbetter, I found it useful to find a small subset who I considered to be\ninfluential people and I noted who they followed. It’s a bit ‘ _stalky_ ’ if\nyou’re unfamiliar with it, but the end result should be a useful collection of\npeople with something useful to say.\n\n##### Books\n\nThe following books are referenced on the D3 wiki;\n\n  * _[Getting Started with D3](http://shop.oreilly.com/product/0636920025429.do)_ : Mike Dewar, O’Reilly Media, June 2012\n  * _[Interactive Data Visualization for the Web](http://chimera.labs.oreilly.com/books/1230000000345)_ : Scott Murray, O’Reilly Media, November 2012\n  * _[Data Visualization with d3.js](http://www.packtpub.com/data-visualization-with-d3js/book)_ : Swizec Teller, Packt Publishing, October 2013\n  * _[Data Visualization with D3.js Cookbook](http://www.packtpub.com/data-visualization-with-d3-js-cookbook/book)_ : Nick Qi Zhu, Packt Publishing, October 2013\n  * _[Mastering D3.js](https://www.packtpub.com/web-development/mastering-d3js)_ : Pablo Navarro Castillo, Packt Publishing, August 2014\n  * _[D3.js in Action](http://www.manning.com/meeks/)_ : Elijah Meeks, Manning Publications, 2014\n  * _[Learning D3.js Mapping](https://www.packtpub.com/web-development/learning-d3js-mapping)_ : Thomas Newton, Oscar Villarreal, Packt Publishing, 2014\n  * _[Visual Storytelling with D3](http://ritchiesking.com/book/)_ : Ritchie King, Addison-Wesley, 2014\n  * _[D3 on AngularJS](https://leanpub.com/d3angularjs)_ : Ari Lerner + Victor Powell, Leanpub, 2014\n\nOf course, there is also the original paper that launched D3 _[D3: Data-Driven\nDocuments](http://vis.stanford.edu/papers/d3)_ by Michael Bostock, Vadim\nOgievetsky and Jeffrey Heer (IEEE Trans. Visualization & Comp. Graphics (Proc.\nInfoVis), 2011)\n\n\n## Starting with a simple graph\n\nWe’ll start with the full code for a simple graph and then we can go through\nit piece by piece.\n\nHere’s what the basic graph looks like;\n\n![Basic Graph](images/basicgraph.png) Basic Graph\n\nAnd here’s the code that makes it happen;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    .line {\n      fill: none;\n      stroke: steelblue;\n      stroke-width: 2px;\n    }\n    \n    </style>\n    <body>\n    \n    <!-- load the d3.js library -->    \t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // parse the date / time\n    var parseTime = d3.timeParse(\"%d-%b-%y\");\n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n    // append the svg obgect to the body of the page\n    // appends a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Get the data\n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n      // Scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\nPlease note that the `<head></head>` tags are omitted which is a common thing\nfor d3 examples (It’s presumably an effort to reduce potentially distracting\ncode for when modern browsers can cope with the omission).\n\nOnce we’ve finished working through the explanation of the functional blocks\nthat make up the graph, we’ll start looking at what we need to add in and\nadjust so that we can incorporate other useful functions that are completely\nreusable in other diagrams as well.\n\nWorking on the premiss that we can break the file down into component parts we\nwill explain the major blocks as [HTML](chap04.xhtml#html),\n[CSS](chap04.xhtml#css) and [JavaScript](chap04.xhtml#javascript). I’m going\nto play kind of fast and loose here, but never fear, it’ll all make sense.\n\n### HTML\n\nHere’s the HTML portion of the code;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style>\n    \n        The CSS is in here\n    \n    </style>\n    <body>\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n        The D3 JavaScript code is here\n    \n    </script>\n    </body>\n    \n\nCompare it with the full code. It kind of looks like a wrapping for the\n[CSS](chap04.xhtml#css) and [JavaScript](chap04.xhtml#javascript). You can see\nthat it really doesn’t boil down to much at all (that doesn’t mean it’s not\nimportant).\n\nThere are plenty of good options for adding additional HTML stuff into this\nvery basic part of the file, but for what we’re going to be doing, we really\ndon’t need to bother too much.\n\nOne thing probably worth mentioning is the line;\n\n    \n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n\nThat’s the line that identifies the file that needs to be loaded to get D3 up\nand running. In this case the file is sourced from the official d3.js\nrepository on the Internet (that way we are using the most up to date\nversion). The D3 file is actually called `d3.v4.min.js` which may come as a\nbit of a surprise. That tells us that this is version 4 of the d3.js file (the\n`v4` part) which is an indication that it is separate from the v3 release,\nwhich was superseded in the middle of 2016. The other point to note is that\nthis version of d3.js is the minified version (hence `min`). This means that\nany extraneous information has been removed from the file to make it quicker\nto load.\n\nLater when doing things like implementing integration with bootstrap (a pretty\nlayout framework) we will be doing a great deal more, but for now, that’s the\nbasics done.\n\nThe two parts that we left out are the [CSS](chap04.xhtml#css) and the D3\n[JavaScript](chap04.xhtml#javascript).\n\n### Cascading Style Sheets (CSS)\n\nThe CSS is as follows;\n\n    \n    \n    .line {\n      fill: none;\n      stroke: steelblue;\n      stroke-width: 2px;\n    }\n    \n\nCascading Style Sheets (CSS) give you control over the look / feel /\npresentation of web content. The idea is to define a set of properties to\nobjects in the web page.\n\nThey are made up of ‘rules’. Each rule has a ‘selector’ and one or more\n‘declarations’ and each declaration has a property and a value (or a group of\nproperties and values).\n\nFor instance in the example code for this web page we have the following rule;\n\n    \n    \n    .line {\n      fill: none;\n      stroke: steelblue;\n      stroke-width: 2px;\n    }\n    \n\n`line` is the selector. The period (.) in front of `line` indicates that the\nselector is a ‘class’. This tells us that on the web page, any particular\nelement (and we are going to apply this rule to the line of our graph) which\nwe decorate with the ‘class’, `line` will have the various declarations\napplied to it.\n\nThere are three declarations as part of the rule. These are contained within\nthe curly braces and separated by semi-colons.\n\nOne of the declarations is for the width of the graph line (`stroke-width:\n2px;`) The property is `stroke-width:` and the value is `2px` (2 pixels). This\ntells the web page that any element in the web page that has the class `line`\nwill have lines drawn that are (amongst other things) 2 pixels wide.\n\nSure enough if we look at the line of the graph…\n\n![Graph line with stroke-width of 2 pixels](images/stroke-width-01.png) Graph\nline with stroke-width of 2 pixels\n\nThat looks as if the line might _actually_ be 2 pixels wide!\n\nLet’s try a test. We can change that particular declaration to the following;\n\n    \n    \n      stroke-width: 20px;\n    \n\nand the result is…\n\n![Graph line with stroke-width of 20 pixels](images/stroke-width-02.png) Graph\nline with stroke-width of 20 pixels\n\nAhh…. 20 pixels of goodness!\n\nBecause we’re getting the hang of things now, let’s change the colour\ndeclaration to…\n\n    \n    \n      stroke: red;\n    \n\nand we get…\n\n![Graph line with stroke colour changed to red](images/stroke-width-03.png)\nGraph line with stroke colour changed to red\n\nAwesome! I think we can safely say that this has had the desired effect.\n\nSo what else is there?\n\nSince there’s only one declaration left, it seems like a shame not to try\nsomething different with it;\n\n    \n    \n        fill: blue;\n    \n\nWe’ll get…\n\n![Basic Graph with changed CSS](images/basicgraph-02.png) Basic Graph with\nchanged CSS\n\nSo the ‘fill’ property looks like it will change the colour of the area that\nwould be closed by the line. Nice.\n\nThe one thing to take away from this small exercise is that there is a good\ndeal of flexibility in adjusting properties of elements on the web page via\nCSS.\n\n### D3 JavaScript\n\nThe D3 JavaScript part of the code is as follows;\n\n    \n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // parse the date / time\n    var parseTime = d3.timeParse(\"%d-%b-%y\");\n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n    // append the svg obgect to the body of the page\n    // appends a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Get the data\n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n      // Scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n\nAgain there’s quite a bit of detail in the code, but it’s not so long that we\ncan’t work out what’s doing what.\n\nThe first thing to note is that throughout the code we have lines that are\nadding a description of what the code does. These have two forward-stroke\ncharacters (//) preceding them which the computer will recognise as a line\nthat only contains comments. I recommend that you add them into your own code\nwhere you think that you might want reminding of a function or description.\n\nLet’s examine the blocks bit by bit to get a feel for it.\n\n#### Setting up the margins and the graph area.\n\nThe part of the code responsible for defining the canvas (or the area where\nthe graph and associated bits and pieces is placed ) is this part.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nThis is really (**_really_**) well explained on Mike Bostock’s page on margin\nconventions here <http://bl.ocks.org/3019563>, but at the risk of confusing\nyou here’s my crude take on it.\n\nThe first line defines the four margins which surround the block where the\ngraph (as an object) is positioned.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n    \n\nSo there will be a border of 20 pixels at the top, 20 at the right and 30 and\n50 at the bottom and left respectively. Now the cool thing about how these are\nset up is that they use a JavaScript object to define everything. That means\nif you want to do calculations in the JavaScript later, you don’t need to put\nthe numbers in, you just use the variable that has been set up. In this case\nmargin.right = 20!\n\nJavaScript can store variables in arrayts and objects. A simple way to\nconsider them is that an array is defined with square brackets or with `new\nArray()` and an object uses the curly braces. Above we have a JavaScript\nobject with four properties. Each property of an object must have a unique\nname, thus each property can be referred to with dot syntax, such as\nmargin.right, while the elements of an array are unnamed and can only be\nreferred by position, such as myArray[0], myArray[3], etc.\n\nMany thanks to Dave Lampton for providing the clarification above (and others\nfollowing).\n\nSo when we go to the next line;\n\n    \n    \n        width = 960 - margin.left - margin.right,\n    \n\nThe width of the inner block of the area where the graph will be drawn is 960\npixels – margin.left – margin.right or 960-50-20 or 890 pixels wide. Of course\nnow we have another variable ‘width’ that we can use later in the code.\n\nObviously the same treatment is given to height.\n\nAnother cool thing about all of this is that just because we appear to have\ndefined separate areas for the graph and the margins, the whole area in there\nis available for use. It just makes it really useful to have areas designated\nfor the axis labels and graph labels without having to juggle them and the\ngraph proper at the same time.\n\nSo, let’s have a play and change some values.\n\n    \n    \n    var margin = {top: 80, right: 20, bottom: 80, left: 50},\n        width = 400 - margin.left - margin.right,\n        height = 270 - margin.top - margin.bottom;\n    \n\n![The effect of changing the margins](images/squishedgraph.png) The effect of\nchanging the margins\n\nHere we’ve made the graph narrower (400 pixels) but retained the left / right\nmargins and increased the top / bottom margins while changing the overall\nheight of the canvas to 270 pixels. The really cool thing that you can tell\nfrom this is that while we shrank the dimensions of the area that we had to\ndraw the graph in, it was still able to dynamically adapt the axes and line to\nfit properly (Although the x axis values got a bit squished. Don’t worry we’ll\nwork through that shortly). That is the really cool part of this whole\nbusiness. D3 is running in the background looking after the drawing of the\nobjects, while you get to concentrate on how the data looks without too much\nmaths!\n\nYou will have noticed that the axes have certainly not fared too well in this\ntransformation. This is because we are using absolutely no [styling or\nconfiguration for the axes](chap05.xhtml#axes) on this graph at all. We will\nhowever certainly be looking at this in more depth in subsequent chapters.\n\n#### Getting the Data\n\nWe’re going to jump forward a little bit here to the portion of the JavaScript\ncode that loads the data for the graph.\n\nI’m going to go out of the sequence of the code here, because if you know what\nthe data is that you’re using, it will make explaining some of the other\nfunctions much easier.\n\nThe section that grabs the data is this bit.\n\n    \n    \n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n      \n    // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n\nThere’s lots of different ways that we can get data into our web page and turn\nit into graphics. The method that we’ll want to use will probably depend more\non the format that the data is in than the mechanism we want to use for\nimporting.\n\nFor instance, if it’s only a few points of data we could include the\ninformation directly in the JavaScript.\n\nThat would make it look something like;\n\n    \n    \n    var data = [\n        {date:\"1-May-12\",close:\"58.13\"},\n        {date:\"30-Apr-12\",close:\"53.98\"},\n        {date:\"27-Apr-12\",close:\"67.00\"},\n        {date:\"26-Apr-12\",close:\"89.70\"},\n        {date:\"25-Apr-12\",close:\"99.00\"}\n    ];\n    \n\nThe format of the data shown above is called [JSON](chap11.xhtml#json)\n(JavaScript Object Notation) and it’s a great way to include data since it’s\neasy for humans to read what’s in there and it’s easy for computers to parse\nthe data out. For a brief overview of JSON there is a [separate section in the\n“Assorted Tips and Tricks Chapter”](chap11.xhtml#json) that may assist.\n\nBut if you’ve got a fair bit of data or if the data you want to include is\ndynamic and could be changing from one moment to the next, you’ll want to load\nit from an external source. That’s when we call on D3’s ‘Request’ functions.\n\n### Request Functions\n\nA ‘Request’ is a function that instructs the browser to reach out and grab\nsome data from somewhere. It could be stored locally (on the web server) or\nsomewhere out in the Internet. There are different types of requests depending\non the type of data you want to ingest. Each type of data is formatted with\ndifferent rules, so the different requests interpret those rules to make sure\nthat the data is returned to the D3 processing in a format that it\nunderstands. You could therefore think of the different ‘Requests’ as\ntranslators and the different data formats as being foreign languages.\n\nThe different types of data that can be requested by D3 are;\n\n  * **[text](https://github.com/d3/d3-request/blob/master/README.md#text)** : A plain old piece of text that has options to be encoded in a particular way.\n  * **[json](https://github.com/d3/d3-request/blob/master/README.md#json)** : This is the aforementioned JavaScript Object Notation.\n  * **[xml](https://github.com/d3/d3-request/blob/master/README.md#xml)** : Extensible Markup Language is a language that is widely used for encoding documents in a human readable forrm.\n  * **[html](https://github.com/d3/d3-request/blob/master/README.md#html)** : HyperText Markup Language is the language used for displaying web pages.\n  * **[csv](https://github.com/d3/d3-request/blob/master/README.md#csv)** : Comma Separated Values is a widely used format for storing data where plain text information is separated by (wait for it) commas.\n  * **[tsv](https://github.com/d3/d3-request/blob/master/README.md#tsv)** : Tab Separated Values is a widely used format for storing data where plain text information is separated by a tab-stop character.\n\nDetails on these ingestion methods and the formats for the requests are well\nexplained on the [D3 Wiki](https://github.com/mbostock/d3/wiki/Requests) page.\nIn this particular script we will look at the csv request method.\n\nNow, it’s important to note that this is not an exclusive list of what can be\ningested. If you’ve got some funky data in a weird format, you can still get\nit in, but you will most likely need to stand up a small amount of code\nsomewhere else in your page to do the conversion (we will look at this process\nwhen describing getting data from a MySQL database).\n\nBack to our request…\n\n    \n    \n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n      \n    // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n\nThe first line of that piece of code invokes the d3.csv request (`d3.csv`) and\nthen the function is pointed to the data file that should be loaded\n(`data.csv`). This is referred to as the ‘URL’ (Unique Resource Locator) of\nthe file. In this case the file is stored locally (in the same directory as\nthe `simple-graph.html` file), but the URL could just as easily point to a\nfile somewhere on the Internet.\n\nThe format of the data in the data.csv file looks a bit like this (although\nthe file is longer (about 26 data points));\n\n    \n    \n    date,close\n    1-May-12,58.13\n    30-Apr-12,53.98\n    27-Apr-12,67.00\n    26-Apr-12,89.70\n    25-Apr-12,99.00\n    \n\nThe ‘date’ and the ‘close’ heading labels are separated by a comma as are each\nsubsequent date and number. Hence the ‘comma separated values’ :-).\n\nThe next part is part of the coolness of JavaScript. With the request for the\nfile made, the script is told to carry out a function on the data (which will\nnow be called ‘data’).\n\n    \n    \n    function(error, data) {\n    \n\nThe function statement will catch any error that is generated and load the\ndata that is ingested as the array ‘data’. The following line ensures that any\nerrors that are generated are captured and ‘thrown’ to an appropriate ‘catch’\nblock (if it exists) in the function. If it doesn’t exist the program will\nterminate.\n\nThere are actually more things that get acted on as part of the function call\n(which we will examine soon), but the one we will consider here is contained\nin the following lines;\n\n    \n    \n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n\nThis block of code ensures that all the values that are pulled out of the csv\nfile are set and formatted correctly. The first line declares that the data\narray called ‘data’ (confusingly) is being dealt with and tells the block of\ncode that, for each group within the ‘data’ array it should carry out a\nfunction on it. Furthermore, when it carries out the formatting of each part\nof the array, it should designate the equivalent of each row as being ‘d’.\n\n    \n    \n        data.forEach(function(d) { \n    \n\nThe information in the array can be considered as being stored in rows. Each\nrow consists of two values: one value for ‘date’ and another value for\n‘close’.\n\nThe function is pulling out values of ‘date’ and ‘close’ one row at a time.\n\nEach time (Get it? `forEach`?) it gets a value of ‘date’ and ‘close’ it\ncarries out the following operations;\n\n    \n    \n          d.date = parseTime(d.date);\n    \n\nFor each value of date being operated on (d.date), d3.js changes it into a\ndate format that is processed via a separate function ‘parseTime’. (The\n`parseTime` function is defined in a separate part of the script, and we will\nexamine that later.) For the moment, be satisfied that it takes the raw date\ninformation from the CSV file in each row and converts it into a format that\nD3 can recognise as a date/time. That value is then re-saved in the same\nvariable space.\n\nThe next line then sets the ‘close’ variable to a numeric value (if it isn’t\nalready) using the ‘+’ operator.\n\n    \n    \n          d.close = +d.close;\n    \n\nThis appears to be good practice when the format of the number being pulled\nout of the data may not mean that it is automagically recognised as a number.\nThis line will ensure that it is.\n\nAt the end of this section of code, we have gone out and picked up a file with\ndata in it of a particular type (comma separated values) and ensured that it\nis formatted in a way that the rest of the script can use correctly.\n\nNow, the astute amongst you will have noticed that in the first line of that\nblock of code (`d3.csv(\"data.csv\", function(error, data) {`) we opened a\nnormal bracket ( `(` ) and a curly bracket ( `{` ), but we never closed them.\nThat’s because they stay open until the very end of the file. That means that\nall those blocks that occur after the `d3.csv` bit are referenced to the\n`data` array. Or put another way, it uses the data in the `data` array to draw\nstuff!\n\nBut anyway, let’s get back to figuring what the code is doing by jumping back\nto the end of the margins block.\n\n#### Formatting the Date / Time.\n\nOne of the glorious things about the World is that we all do things a bit\ndifferently. One of those things is how we refer to [dates and\ntime](http://en.wikipedia.org/wiki/Date_format_by_country).\n\nIn my neck of the woods, it’s customary to write the date as day - month –\nyear. E.g 23-12-2012. But in the United States the more common format would be\n12-23-2012. Likewise, the data may be in formats that name the months or\nweekdays (E.g. January, Tuesday) or combine dates and time together (E.g.\n2012-12-23 15:45:32). So, if we were to attempt to try to load in some data\nand to try and get D3 to recognise it as date / time information, we really\nneed to tell it what format the date / time is in.\n\n### Does Time Matter?\n\nYou might be asking yourself “What’s the point?” All you want to do is give it\na number and it can sort it out somehow. Well, that is true, but if you want\nto really bring out the best in your data and to keep maximum flexibility in\nrepresenting it on the screen, you will want D3 to play to its strengths. And\none of those is being able to adjust dynamically with variable time values.\n\nTime for a little demonstration (see what I did there).\n\nWe will change our data.csv file so that it only includes two points. The\nfirst one and the last one with a separation of a month and a bit. It will\ntherefore look a little like this;\n\n    \n    \n    date,close\n    1-May-12,58.13\n    26-Mar-12,606.98\n    \n\nThe graph now looks like this;\n\n![Simple line graph](images/straightgraph.png) Simple line graph\n\nNothing too surprising here, a very simple graph (note the time scale on the x\naxis).\n\nNow we will change the later date in the data.csv file so that it is a lot\ncloser to the starting date;\n\n    \n    \n    date,close\n    29-Mar-12,58.13\n    26-Mar-12,606.98\n    \n\nSo, just a three day difference. Let’s see what happens.\n\n![Simple line graph over three days](images/straightgraph2.png) Simple line\ngraph over three days\n\nAhh…. Not only did we not have to make any changes to our JavaScript code, but\nit was able to recognise the dates were closer and fill in the intervening\ngaps with appropriate time / day values. Now, one more time for giggles.\n\nThis time we’ll stretch the interval out by a few years.\n\n    \n    \n    date,close\n    29-Mar-21,58.13\n    26-Mar-12,606.98\n    \n\nand the result is…\n\n![Simple line graph over several years](images/straightgraph3.png) Simple line\ngraph over several years\n\nHopefully that’s enough encouragement to impress upon you that formatting the\ntime is a _REALLY_ good thing to get right. Trust me, it will never fail to\nimpress :-).\n\nBack to formatting.\n\nThe line in the JavaScript that parses the time is the following;\n\n    \n    \n    var parseTime = d3.timeParse(\"%d-%b-%y\");\n    \n\nThis line is used when the `data.forEach(function(d)` portion of the code\n(that we looked at a couple of pages back) used `d.date = parseTime(d.date)`\nas a way to take a date in a specific format and to get it recognised by D3.\nIn effect it said “ _take this value that is supposedly a date and make it\ninto a value I can work with_ ”.\n\nThe function used is the `d3.timeParse(specifier)` function where the\nspecifier in this case is the mysterious combination of characters `%d-%b-%y`.\nThe good news is that these are just a combination of directives specific for\nthe type of date we are presenting.\n\nThe `%` signs are used as prefixes to each separate format type and the ‘`-`’\n(minus) signs are literals for the actual ‘`-`’ (minus) signs that appear in\nthe date to be parsed.\n\nThe `d` refers to a zero-padded day of the month as a decimal number [01,31].\n\nThe `b` refers to an abbreviated month name.\n\nAnd the `y` refers to the year (without the centuries) as a decimal number.\n\nIf we look at a subset of the data from the data.csv file we see that indeed,\nthe dates therein are formatted in this way.\n\n    \n    \n    1-May-12,58.13\n    30-Apr-12,53.98\n    27-Apr-12,67.00\n    26-Apr-12,89.70\n    25-Apr-12,99.00\n    \n\nThat’s all well and good, but what if your data isn’t formatted exactly like\nthat?\n\nGood news. There are multiple different formatters for different ways of\ntelling time and you get to pick and choose which one you want. Check out the\nTime Formatting page on the [D3 Wiki](https://github.com/d3/d3-time-\nformat/blob/master/README.md#locale_format) for the authoritative list and\nsome great detail, but the following is the list of currently available\nformatters (from the d3 wiki);\n\n  * %a - abbreviated weekday name.\n  * %A - full weekday name.\n  * %b - abbreviated month name.\n  * %B - full month name.\n  * %c - date and time, as “%a %b %e %H:%M:%S %Y”.\n  * %d - zero-padded day of the month as a decimal number [01,31].\n  * %e - space-padded day of the month as a decimal number [ 1,31].\n  * %H - hour (24-hour clock) as a decimal number [00,23].\n  * %I - hour (12-hour clock) as a decimal number [01,12].\n  * %j - day of the year as a decimal number [001,366].\n  * %m - month as a decimal number [01,12].\n  * %M - minute as a decimal number [00,59].\n  * %p - either AM or PM.\n  * %S - second as a decimal number [00,61].\n  * %U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].\n  * %w - weekday as a decimal number [0(Sunday),6].\n  * %W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].\n  * %x - date, as “%m/%d/%y”.\n  * %X - time, as “%H:%M:%S”.\n  * %y - year without century as a decimal number [00,99].\n  * %Y - year with century as a decimal number.\n  * %Z - time zone offset, such as “-0700”.\n  * There is also a a literal “%” character that can be presented by using double % signs.\n\nAs an example, if you wanted to input date / time formatted as a generic MySQL\n‘YYYY-MM-DD HH:MM:SS’ TIMESTAMP format the D3 parse script would look like;\n\n    \n    \n    parseTime = d3.timeParse(\"%Y-%m-%d %H:%M:%S\");\n    \n\n#### Setting Scales Domains and Ranges\n\nThis is another example where, if you set it up right, D3 will look after you\nforever.\n\n#### Scales, Ranges and the “Ah Ha!” moment.\n\nThe “Ah Ha!” moment for me in understanding ranges and scales was after\nreading Jerome Cukier’s great page on ‘[d3:scales and\ncolor](http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/)’. I\nthoroughly recommend you read it (and plenty more of the great work by Jerome)\nas he really does nail the description in my humble opinion. I will put my own\ndescription down here, but if it doesn’t seem clear, head on over to Jerome’s\npage.\n\nFrom our basic web page we have now moved to the section that includes the\nfollowing lines;\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n\nThe purpose of these portions of the script is to ensure that the data we\ningest fits onto our graph correctly. Since we have two different types of\ndata (date/time and numeric values) they need to be treated separately (but d3\nmanages them in almost the same way). To examine this whole concept of scales,\ndomains and ranges properly, we will also move slightly out of sequence and\n(in conjunction with the earlier scale statements) take a look at the lines of\nscript that occur later and set the domain. They are as follows;\n\n    \n    \n      // Scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nThe idea of scaling is to take the range of values of data that we have and to\nfit them into the space we have available.\n\nIf we have data that goes from 53.98 to 636.23 (as the data we have for\n‘close’ in our csv file does), but we have a graph that is 450 pixels high\n(`height = 500 - margin.top – margin.bottom;`) we clearly need to make an\nadjustment.\n\nNot only that. Even though our data goes from 53.98 to 636.23, that would look\nslightly misleading on the graph and it should really go from 0 to a bit over\n636.23. It sounds really complicated, so let’s simple it up a bit.\n\nFirst we make sure that any quantity we specify on the x axis fits onto our\ngraph.\n\n    \n    \n    var x = d3.scaleTime().range([0, width]);\n    \n\nHere we set our variable (`x`) that will tell D3 where to draw something on\nthe x axis. By using the `d3.scaleTime()` function we make sure that D3 knows\nto treat the values as date / time entities (with all their ingrained\npeculiarities). Then we specify the range that those values will cover\n(`.range`) and we specify the range as being from 0 to the width of our\ngraphing area (See? Setting those variables for margins and widths are\nstarting to pay off now!).\n\nThen we do the same for the Y axis.\n\n    \n    \n    var y = d3.scaleLinear().range([height, 0]);\n    \n\nThere’s a different function call (`d3.scaleLinear()`) but the `.range`\nsetting is still there. In the interests of drawing a (semi) pretty picture to\ntry and explain, hopefully this will assist;\n\n![Scaling the data to the graph size](images/scales1.png) Scaling the data to\nthe graph size\n\nI know, I know, it’s a little misleading because nowhere have we actually said\nto D3 this is our data from 53.98 to 636.23. All we’ve said is when we get the\ndata, we’ll be scaling it into this space.\n\nNow hang on, what’s going on with the `[height, 0]` part in y axis scale\nstatement? The astute amongst you will note that for the time scale we set the\nrange as `[0, width]` but for this one (`[height, 0]`) the values look\nbackwards.\n\nWell spotted.\n\nThis is all to do with how the screen is laid out and referenced. Take a look\nat the following diagram showing how the coordinates for drawing on your\nscreen work;\n\n![Coordinates that the browser expects](images/scales2.png) Coordinates that\nthe browser expects\n\nThe top left hand of the screen is the origin or 0,0 point and as we go left\nor down the corresponding x and y values increase to the full values defined\nby height and width.\n\nThat’s good enough for the time values on the x axis that will start at lower\nvalues and increase, but for the values on the y axis we’re trying to go\nagainst the flow. We want the low values to be at the bottom and the high\nvalues to be at the top.\n\nNo problem. We just tell D3 via the statement `y =\nd3.scaleLinear().range([height, 0]);` that the larger values (height) are at\nthe low end of the screen (at the top) and the low values are at the bottom\n(as you most probably will have guessed by this stage, the `.range` statement\nuses the format `.range([closer_to_the_origin, further_from_the_origin])`. So\nwhen we put the height variable first, that is now associated with the top of\nthe screen.\n\n![Coordinates with adjusted ranges](images/scales3.png) Coordinates with\nadjusted ranges\n\nWe’ve scaled our data to the graph size and ensured that the range of values\nis set appropriately. What’s with the domain part that was in this section’s\ntitle?\n\nCome on, you remember this little piece of script don’t you?\n\n    \n    \n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nWhile it exists in a separate part of the file from the scale / range part, it\nis certainly linked.\n\nThat’s because there’s something missing from what we have been describing so\nfar with the set up of the data ranges for the graphs. We haven’t actually\ntold D3 what the range of the data is. That’s also the reason this part of the\nscript occurs where it does. It is within the section where the data.csv file\nhas been loaded as ‘data’ and it’s therefore ready to use it.\n\nSo, the `.domain` function is designed to let D3 know what the scope of the\ndata will be. This is what is then passed to the scale function.\n\nLooking at the first part that is setting up the x axis values, it is saying\nthat the domain for the x axis values will be determined by the `d3.extent`\nfunction which in turn is acting on a separate function which looks through\nall the ‘date’ values that occur in the ‘data’ array. In this case the\n`.extent` function returns the minimum and maximum value in the given array.\n\n  * `function(d) { return d.date; }` returns all the ‘date’ values in ‘data’. This is then passed to…\n  * The `.extent` function that finds the maximum and minimum values in the array and then…\n  * The `.domain` function which returns those maximum and minimum values to D3 as the range for the x axis.\n\nPretty neat really. At first you might think it was overly complex, but\nbreaking the function down into these components allows additional\nfunctionality with differing scales, values and quantities. In short, don’t\nsweat it. It’s a good thing.\n\nThe x axis values are dates; so the domain for them is basically from the 26th\nof March 2012 till 1st of May 2012. The y axis is done slightly differently\n\n    \n    \n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nBecause the range of values desired on the y axis goes from 0 to the maximum\nin the data range, that’s exactly what we tell D3. The ‘0’ in the .domain\nfunction is the starting point and the finishing point is found by employing a\nseparate function that sorts through all the ‘close’ values in the ‘data’\narray and returns the largest one. Therefore the domain is from 0 to 636.23.\n\nLet’s try a small experiment. Let’s change the y axis domain to use the\n.extent function (the same way the x axis does) to see what it produces.\n\nThe JavaScript for the y domain will be;\n\n    \n    \n      y.domain(d3.extent(data, function(d) { return d.close; }));\n    \n\nYou can see apart from a quick copy paste of the internals, all I had to\nchange was the reference to ‘close’ rather than ‘date’.\n\nAnd the result is…\n\n![Graph using .extent for data values](images/scales4.png) Graph using .extent\nfor data values\n\nLook at that! The starting point for the y axis looks like it’s pretty much on\nthe 53.98 mark and the graph itself certainly touches the x axis where the\ndata would indicate it should.\n\nNow, I’m not really advocating making a graph like this since I think it looks\na bit nasty (and a casual observer might be fooled into thinking that the x\naxis was at 0). However, this would be a useful thing to do if the data was\nconcentrated in a narrow range of values that are quite distant from zero.\n\nFor instance, if I change the data.csv file so that the values are represented\nlike the following;\n\n![Concentrated data range graph](images/scales5.png) Concentrated data range\ngraph\n\nThen it kind of loses the ability to distinguish between values around the\nmedian of the data.\n\nBut, if I put in our magic .extent function for the y axis and redraw the\ngraph…\n\n![Expanded concentrated data range using .extent](images/scales6.png) Expanded\nconcentrated data range using .extent\n\nHow about that?\n\nThe same data as the previous graph, but with one simple piece of the script\nchanged and D3 takes care of the details.\n\n#### Adding data to the line function\n\nWe’re getting towards the end of our journey through the script now. The next\nstep is to associate the array ‘data’ with a new array that consists of a set\nof coordinates that we are going to plot.\n\nI’m aware that the statement above may be somewhat ambiguous. You would be\njustified in thinking that we already had the data stored and ready to go. But\nthat’s not _strictly_ correct.\n\n    \n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n\nWhat we have is data in a raw format, we have added pieces of code that will\nallow the data to be adjusted for scale and range to fit in the area that we\nwant to draw, but we haven’t actually taken our raw data and adjusted it for\nour desired coordinates. That’s what the code above does.\n\nThe main function that gets used here is the `d3.line()`\n[function](https://github.com/d3/d3-shape/blob/master/README.md#lines). This\nfunction uses accessor functions to store the appropriate information in the\nright area and in the case above they use the `x` and `y` accessors (that\nwould be the bits that are `.x` and `.y`). The `d3.line()` function is called\na ‘path generator’ and this is an indication that it can carry out some pretty\nclever things on its own accord. But in essence its job is to assign a set of\ncoordinates in a form that can be used to draw a line.\n\nEach time this line function is called on, it will go through the data and\nwill assign coordinates to ‘date’ and ‘close’ pairs using the ‘x’ and ‘y’\nfunctions that we set up earlier (which are responsible for scaling and\nsetting the correct range / domain).\n\nOf course, it doesn’t get the data all by itself, we still need to actually\ncall the valueline function with ‘data’ as the source to act on. But never\nfear, that’s coming up soon.\n\n#### Adding the SVG element.\n\nAs the title states, the next piece of script forms and adds the SVG element\nto the web page that D3 will then use to draw on.\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nSo what exactly does that all mean?\n\nWell D3 needs to be able to have a space defined for it to draw things. When\nyou define the space it’s going to use, you can also give the space you’re\ngoing to use an identifying name and attributes.\n\nIn the example we’re using here, we are ‘appending’ an [SVG\nelement](chap11.xhtml#svg) (an element designed for drawing graphics on) to\nthe `<body>` of the HTML page.\n\nIn human talk that means that on the web page and bounded by the `<body>` tag\nthat we saw in the HTML part, we will have an area to draw on. That area will\nbe ‘width’ plus the left and right margins wide and ‘height’ plus the top and\nbottom margins wide.\n\nWe also add a group element ‘g’ that is referenced to the top left corner of\nthe actual graph area on the canvas. ‘g’ is a grouping element in the sense\nthat it is normally used for grouping together several related elements. So in\nthis case those grouped elements will have a common reference.\n\n![Graph area and margins](images/margins.png) Graph area and margins\n\n(the image above is definitely not to scale, but I hope you get the general\nidea)\n\nInteresting things to note about the code. The `.attr(\"stuff in here\")` parts\nare attributes of the appended elements they are part of.\n\nFor instance;\n\n    \n    \n       .append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n    \n\ntells us that the ‘svg’ element has a “width” of width + margin.left +\nmargin.right and the “height” of height + margin.top + margin.bottom.\n\nLikewise…\n\n    \n    \n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\ntells us that the group element ‘g’ has been transformed by moving\n(translating) to the point margin.left, margin.top. Or to the top left of the\ngraph space proper. This way when we tell something to be drawn on our page,\nwe can use this reference point ‘g’ to make sure everything is in the right\nplace.\n\n#### Actually Drawing Something!\n\nUp until now we have spent a lot of time defining, loading and setting up.\nGood news! We’re about to finally draw something!\n\n##### Drawing the line\n\nWe jump lightly over some of the code that we have already explained and land\non the part that draws the line.\n\n    \n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n\nThis area occurs in the part of the code that has the data loaded (via the\n`d3.csv` block) and it’s ready for action.\n\nThe `svg.append(\"path\")` portion adds a new path element . A path element\nrepresents a shape that can be manipulated in lots of different ways (see more\nhere: <http://www.w3.org/TR/SVG/paths.html>).\n\nWe join our array of data (confusingly the array is _called_ ‘data’) to the\npath element with the `.data([data])` line. We could have used an alternative\nmethod here with a line that read `.datum(data)`. Both are completely valid to\nuse, but have different strengths.\n\n##### data vs datum.\n\n`data` takes the specified array and joins it to a selection of data. Joining\ndata allows for dynamic updating of the data via ‘update’, ‘enter’ and ‘exit’\nselections (more on these much later in the book).\n\n`datum` doesn’t join data to any existing array and instead the data will\nexist as static element. The advantage to this is that it allows access to\nHTML5 custom data attributes.\n\nFor more detail on the differences, it is worth reading the [documentation of\njoining\ndata](https://github.com/d3/d3-selection/blob/master/README.md#joining-data).\n\nThe next line down applies the ‘line’ styles from the CSS section that we\n[experimented with earlier](chap04.xhtml#css).\n\nIn the final line (`.attr(\"d\", valueline);`), we add the attribute ‘d’ to the\npath with the data from the `valueline` function that we had declared earlier.\n\nThe `d` attribute is a [mini language](https://developer.mozilla.org/en-\nUS/docs/Web/SVG/Attribute/d) which contains a series of commands for movement\nthat will describe a path in SVG. These commands are written in a shorthand of\nsingle letters such as M-moveto, Z-closepath, L-lineto, C-curveto. The good\nnews is that D3 takes care of the heavy lifting in putting together this set\nof commands.\n\n##### Drawing the Axes\n\nThen we get to draw in the axes;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nBoth axes start by appending a group element (‘g’). Each axis will be bound to\nits own element.\n\nThe y axis can be drawn from the default position at the origin of the svg\nelement (which we recall is 0,0 at the top left of the graph). However the x\naxis needs to be moved to the bottom of our graph.\n\nOn the x axis, we have a transform statement (`.attr(\"transform\",\n\"translate(0,\" + height + \")\")`). If we want our x axis to be on the bottom of\nthe graph, we need to move (transform) it to the bottom by a set amount. The\nset amount in this case is the height of the graph proper (`height`). So, for\nthe point of demonstration we will remove the transform line and see what\nhappens;\n\n![x axis transformed to the top of the graph](images/axistransformed.png) x\naxis transformed to the top of the graph\n\nYep, pretty much as anticipated.\n\nThe last part of the two sections of script ( `.call(d3.axisBottom(x));` and\n`.call(d3.axisLeft(y));` ) call the D3 x and y axis functions respectively and\ninitiate the drawing action.\n\nThe method by which D3 orientates the axes is relatively self-evident and\nthere are four options;\n\n  * `.axisTop`: An axis with values and ticks drawn above a horizontal axis.\n  * `.axisRight`: An axis with values and ticks drawn to the right of a vertical axis.\n  * `.axisBottom`: An axis with values and ticks drawn below a horizontal axis.\n  * `.axisLeft`: An axis with values and ticks drawn to the left of a vertical axis.\n\nJust to illustrate the point, we can reverse the orientation of `.axisBottom`\nto `.axisTop` and `.axisLeft` to `.axisRight` to see what it looks like;\n\n![x and y axes reversed](images/axesreversed.png) x and y axes reversed\n\nThere we go.\n\nIt is worth stating that the axes as presented for this simple graph are very\nmuch a ‘straight out of the box’ configuration. [Later in the\nbook](chap05.xhtml#axes) we will look at options for configuring and styling\naxes in more depth.\n\n### Wrap Up\n\nWell that’s it. In theory, you should now be a complete D3 ninja.\n\nOK, perhaps a slight exaggeration. In fact there is a strong possibility that\nthe information I have laid out here is at best borderline useful and at worst\nladen with evil practices and gross inaccuracies.\n\nBut look on the bright side. Irrespective of the nastiness of the way that any\nof it was accomplished or the inelegance of the code, if the picture drawn on\nthe screen is pretty, you can walk away with a smile. :-)\n\nThis section concludes a very basic description of one type of a graphic that\ncan be built with D3. We will look at adding value to it in subsequent\nchapters.\n\nI’ve said it before and I’ll say it again. This is not a how-to for learning\nD3. This is how I have managed to muddle through and achieve what I wanted to\ndo. If some small part of it helps you. All good. Those with a smattering of\nknowledge of any of the topics I have butchered above (or below) are fully\njustified in feeling a large degree of righteous indignation. To those I say,\nplease feel free to amend where practical and possible, but please bear in\nmind this was written from the point of view of someone with no experience in\nthe topic and therefore try to keep any instructions at a level where a new\nentrant can step in :-).\n\n\n## Things we can do with the simple graph\n\nThe following headings in this section are intended to be a list of relatively\nsimple ‘block’ type improvements that you can do to your graph to add\nfunctionality. The idea is to be able to use the simple graph that was used\nfor the explanation of how D3 worked and just slot in code to add\nfunctionality (let’s hope it works for you :-)).\n\n### Setting up and configuring the Axes\n\nAs referenced in the chapter where we initially developed our simple graph,\nthe axes of that graph had no styling or configuration changes made to them at\nall. One of the results of this is that the font size, type, number of ticks\nand the way that the values are represented is very much at the default\nsettings. This means that when we change our initial graph…\n\n![Basic Graph](images/basicgraph.png) Basic Graph\n\n… and compress the margins or graph size we end up with axes that are not\nreally suitable for the purpose;\n\n![The effect of changing the margins](images/squishedgraph.png) The effect of\nchanging the margins\n\nLuckily, the D3 axis component has a wide range of configuration options and\nwe can make changes simply via either the CSS styling or in the JavaScript\ncode.\n\n#### Change the text size\n\nThe first thing that we will change is the text size for the axes. The default\nsize (built into D3) is 10px with the font type of sans-serif.\n\nThere are a couple of different ways that we could change the font size and\neither one is valid. The first way is to specify the font as a style when\ndrawing an individual axis. To do this we simply add in a font style as\nfollows;\n\n    \n    \n      svg.append(\"g\")\n          .style(\"font\", \"14px times\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n\nThis will increase the x axis font size to 14px and change the font type to\n‘times’. Just like this;\n\n![X axis 14px, times](images/axes-01.png) X axis 14px, times\n\nThere are a few things to notice here.\n\nFirstly, we do indeed have a larger font and it appears to be of the type\n‘times’. Yay!\n\nSecondly, the y axis has remained as 10px sans-serif (which is to be expected\nsince we only added the style to the x axis code block)\n\nLastly, the number of values represented on the x axis has meant that with the\nincrease in font size there is some overlapping going on. We will deal with\nthat shortly…\n\nThe addition of the styling for the x axis has been successful and in a\nsituation where only one element on a page is being adjusted, this is a\nperfectly valid way to accomplish the task. However, in this case we should be\ninterested in changing the font on both the x _and_ y axes. We could do this\nby adding a duplicate style line to the y axis block, but we have a slightly\nbetter way of accomplishing the task by declaring the style in the HTML style\nblock at the start of the code and then applying the same style to both\nblocks.\n\nIn the `<style> ... </style>` section at the start of the file add in the\nfollowing line;\n\n    \n    \n    .axis { font: 14px sans-serif; }\n    \n\nThis will set the font to 14px sans-serif (I prefer this to ‘times’) for\nanything that has the `axis` class applied to it. All we have to do then is to\ntell our x and y axes blocks to use the `axis` class as an attribute. We can\ndo this as follows;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .call(d3.axisLeft(y));\n    \n\nIt could be argued that this doesn’t really conserve more code, but in my\nhumble opinion it adds a more elegant way to alter styling in this case.\n\nThe end result now looks like the following;\n\n![Both axes 14px, sans-serif](images/axes-02.png) Both axes 14px, sans-serif\n\n#### Changing the number of ticks on an axis\n\nNow we shall address the other problem that cropped up when we changed the\nsize of the text. We have overlapping values on the x axis.\n\n![Overlapping axis values](images/axes-03.png) Overlapping axis values\n\nIf I was to be brutally honest, I think that the number of values (ticks) on\nthe graph is a bit too many. The format of the values (especially on the x\naxis) is too wide and this type of overlap was bound to happen eventually.\n\nGood news. D3 has got us covered.\n\nThe [axis component](https://github.com/d3/d3-axis) includes a function to\nspecify the number of ticks on an axis. All we need to do is add in the\nfunction and the number of ticks like so;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .ticks(5));\n    \n\nWith the end result looking like this;\n\n![Nicely spaced axis values](images/axes-04.png) Nicely spaced axis values\n\nWe can see that D3 has picked tick values that seem nice and logical. There’s\none that starts on the 1st of April that’s just labelled ‘April’ and they go\nat a nice interval of one week for the subsequent ticks. Nice.\n\nHopefully you just did a quick count across the bottom of the previous graph\nand went “Yep, five ticks. Spot on”. Well done if you did, but there’s a\nlittle bit of a sneaky trick up D3’s sleeve with the number of ticks on a\ngraph axis.\n\nFor instance, here’s what the graph looks like when the `.ticks(5)` value is\nchanged to `.ticks(4)`.\n\n![Five ticks on the x axis](images/axes-04.png) Five ticks on the x axis\n\nEh? Hang on. Isn’t that some kind of mistake? There are still five ticks. Yep,\nsure is! But wait… we can keep dropping the ticks value till we get to two and\nit will still be the same. At `.ticks(2)` though, we finally see a change.\n\n![Two ticks on the x axis](images/axes-05.png) Two ticks on the x axis\n\nHow about that? At first glance that just doesn’t seem right, then you have a\nbit of a think about it and you go “Hmm… When there were 5 ticks, they were\nseparated by a week each, and that stayed that way till we got to a point\nwhere it could show a separation of a month”.\n\nD3 is making a command decision for you as to how your ticks should be best\ndisplayed. This is great for simple graphs and indeed for the vast majority of\ngraphs. Like all things related to D3, if you really need to do something\nbespoke, it will let you if you understand enough code.\n\nThe following is the\n[list](https://github.com/d3/d3-scale/blob/master/README.md#time_ticks) of\ntime intervals that D3 will consider when setting automatic ticks on a time\nbased axis;\n\n  * 1, 5, 15 and 30-second.\n  * 1, 5, 15 and 30-minute.\n  * 1, 3, 6 and 12-hour.\n  * 1 and 2-day.\n  * 1-week.\n  * 1 and 3-month.\n  * 1-year.\n\nAnd yes. If you increase the number of ticks, you need to wait till you get to\n10 before they change to an axis with interval of two days. And yes, the\noverlap is still there;\n\n![Still overlapping axis values](images/axes-03a.png) Still overlapping axis\nvalues\n\nIf we do a quick count we should also notice that we have 19 ticks!\n\nThe question should be asked. Can we specify our own intervals? Great\nquestion! Yes we can.\n\nWhat we need to do is to use another D3 trick and specify an exact interval\nusing the [d3 time component](https://github.com/d3/d3-time#d3-time). In our\nparticular situation all we need to do is specify an interval inside the\n`.ticks` function. Specifically for an interval of 4 days for example we would\nuse something like;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .ticks(d3.timeDay.every(4)));\n    \n\nHere we use the `timeDay` unit of ‘days’ and specify an interval of 4 days.\n\nThe graph will subsequently appear as follows;\n\n![Axis ticks at 4 day intervals](images/axes-06.png) Axis ticks at 4 day\nintervals\n\nIntervals have a number of [standard\nunits](https://github.com/d3/d3-time#intervals) (including UTC time) such as;\n\n  * `d3.timeMillisecond` : Milliseconds\n  * `d3.timeSecond` : Seconds\n  * `d3.timeMinute` : Minutes\n  * `d3.timeHour` : Hours\n  * `d3.timeDay` : Days\n  * `d3.timeWeek` : This is an alias for `d3.timeSunday` for a week\n  * `d3.timeSunday` : A week starting on Sunday\n  * `d3.timeMonday` : A week starting on Monday\n  * `d3.timeTuesday` : A week starting on Tuesday\n  * `d3.timeWednesday` : A week starting on Wednesday\n  * `d3.timeThursday` : A week starting on Thursday\n  * `d3.timeFriday` : A week starting on Friday\n  * `d3.timeSaturday` : A week starting on Saturday\n  * `d3.timeMonth` : Months starting on the 1st of the month\n  * `d3.timeYear` : Years Starting on the 1st day of the year\n\nBut what if we really wanted that two day separation of ticks without the\noverlap?\n\n#### Rotating text labels for a graph axis\n\nAn answer to the problem of overlapping axis values might be to rotate the\ntext to provide more space.\n\nThe answer I found most usable was provided by Aaron Ward on [Google\nGroups](https://groups.google.com/forum/#!msg/d3-js/CRlW0ISbOy4/1sgrE5uS5ysJ).\n\n#### There might be a better way\n\nNow, I’ll put a bit of a caveat on this solution to the rotating axis label\nproblem. It looks like it’s worked well, but I’ve only carried out this\ninvestigation to the point where I’ve got something that looks like it’s a\nsolution. There may be better or more elegant ways of carrying out the same\ntask, so let Google be your friend if it doesn’t appear to be working out for\nyou.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/3c040800ff6457717cca586ae9547dbf) or\nin the code samples bundled with this book (simple-axis-rotated.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3c040800ff6457717cca586ae9547dbf).\n\nThe first substantive change would be a little housekeeping. Because we are\ngoing to be rotating the text at the bottom of the graph, we are going to need\nsome extra space to fit in our labels. So we should change our bottom margin\nappropriately.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 70, left: 50},\n    \n\nI found that 70 pixels was sufficient.\n\nThe remainder of our changes occur in the block that draws the x axis.\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x).ticks(10))\n          .selectAll(\"text\")\t\n            .style(\"text-anchor\", \"end\")\n            .attr(\"dx\", \"-.8em\")\n            .attr(\"dy\", \".15em\")\n            .attr(\"transform\", \"rotate(-65)\");\t\n    \n\nIt’s pretty standard until the `.call(d3.axisBottom(x).ticks(10))` portion of\nthe code. Here we remove the semicolon that was there so that the block\ncontinues with its function.\n\nThen we select all the text elements that comprise the x axis with the\n`.selectAll(\"text\")`. From this point onwards, we are operating on the text\nelements associated with the x axis. In effect; the following four ‘actions’\nare applied to the text labels.\n\nThe `.style(\"text-anchor\", \"end\")` line ensures that the text label has the\nend of the label ‘attached’ to the axis tick. This has the effect of making\nsure that the text rotates about the end of the date. This makes sure that the\ntext all ends up at a uniform distance from the axis ticks.\n\nThe `dx` and `dy` attribute lines move the end of the text just far enough\naway from the axis tick so that they don’t crowd it and not too far away so\nthat it appears disassociated. This took a little bit of fiddling to ‘look’\nright and you will notice that I’ve used the ‘em’ units to get an adjustment\nif the size of the font differs.\n\nThe final action is kind of the money shot.\n\nThe transform attribute applies itself to each text label and rotates each\nline by -65 degrees. I selected -65 degrees just because it looked OK. There\nwas no deeper reason.\n\nThe end result then looks like the following;\n\n![Rotated x axis labels](images/rotate02.png) Rotated x axis labels\n\nThis was a surprisingly difficult problem to find a solution to that I could\neasily understand (well done Aaron). That makes me think that there are some\nfar deeper mysteries to it that I don’t fully appreciate that could trip this\nsolution up. But in lieu of that, enjoy!\n\n#### Formatting a date / time axis with specified values\n\nOK then. We’ve been very clever in rotating our text, but you will notice that\nD3 has used its own good judgement as to what format the days / date will be\nrepresented as.\n\nNot that there’s anything wrong with it, but what if we want to put a specific\nformat of date / time nomenclature as axis labels?\n\nNo problem. D3 to the rescue again!\n\nThis is actually a pretty easy thing to do, but there are plenty of options\nfor the formatting, so the only really tricky part is deciding what to put\nwhere.\n\nBut, before we start doing anything we are going to have to expand our bottom\nmargin even more than we did with the rotate the axis labels feature.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 100, left: 50},\n    \n\nThat should see us right.\n\nNow the simple part :-). Changing the format of the label is as simple as\ninserting the `tickFormat` command into the xAxis declaration and including a\nD3 [time formatting](https://github.com/d3/d3-time-format) function a little\nlike this;\n\n    \n    \n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .tickFormat(d3.timeFormat(\"%Y-%m-%d\")))\n          .selectAll(\"text\")\t\n            .style(\"text-anchor\", \"end\")\n            .attr(\"dx\", \"-.8em\")\n            .attr(\"dy\", \".15em\")\n            .attr(\"transform\", \"rotate(-65)\");\n    \n\nThe `timeFormat` formatters are the same as those we used when parsing our\ntime values when reading our data with the simple graph;\n\n  * %a - abbreviated weekday name.\n  * %A - full weekday name.\n  * %b - abbreviated month name.\n  * %B - full month name.\n  * %c - date and time, as “%a %b %e %H:%M:%S %Y”.\n  * %d - zero-padded day of the month as a decimal number [01,31].\n  * %e - space-padded day of the month as a decimal number [ 1,31].\n  * %H - hour (24-hour clock) as a decimal number [00,23].\n  * %I - hour (12-hour clock) as a decimal number [01,12].\n  * %j - day of the year as a decimal number [001,366].\n  * %m - month as a decimal number [01,12].\n  * %M - minute as a decimal number [00,59].\n  * %p - either AM or PM.\n  * %S - second as a decimal number [00,61].\n  * %U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].\n  * %w - weekday as a decimal number [0(Sunday),6].\n  * %W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].\n  * %x - date, as “%m/%d/%y”.\n  * %X - time, as “%H:%M:%S”.\n  * %y - year without century as a decimal number [00,99].\n  * %Y - year with century as a decimal number.\n  * %Z - time zone offset, such as “-0700”.\n  * There is also a literal “%” character that can be presented by using double % signs.\n\nSo the format we have specified (`%Y-%m-%d`) will show the year with the\ncentury as a decimal number (`%Y`) followed by a hyphen, followed by a zero\npadded month as a decimal number (`%m`) followed by another hyphen and lastly\nthe day as a zero padded day of the month (`%d`).\n\nThe end result looking a bit like this;\n\n![Rotated x axis labels](images/axes-07.png) Rotated x axis labels\n\nAn example using this code can be found on\n[github](https://gist.github.com/d3noob/0e276dc70bb9184727ee47d6dd06e915) or\nin the code samples bundled with this book (simple-axis-rotated-formatted.html\nand data.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/0e276dc70bb9184727ee47d6dd06e915). The\nexample code also includes the rotating of the x axis text as described in the\nprevious section.\n\nSo how about we try something a little out of the ordinary (extreme)?\n\nHow about the full weekday name (`%A`), the day (`%d`), the full month name\n(`%B`) and the year (`%Y`) as a four digit number?\n\n    \n    \n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .tickFormat(d3.timeFormat(\"%A %d %B %Y\")))\n          .selectAll(\"text\")\t\n            .style(\"text-anchor\", \"end\")\n            .attr(\"dx\", \"-.8em\")\n            .attr(\"dy\", \".15em\")\n            .attr(\"transform\", \"rotate(-65)\");\n    \n\nWe will also need some extra space for the bottom margin, so how about 170?\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 170, left: 50},\n    \n\nAnd….\n\n![Extreme format change for the x axis labels](images/axes-08.png) Extreme\nformat change for the x axis labels\n\nOh yeah… When axis ticks go bad…\n\nBut seriously, that does work as a pretty good example of the flexibility\navailable.\n\n### Adding Axis Labels\n\nWhat’s the first thing you get told at school when drawing a graph?\n\n“ _Always label your axes!_ ”\n\nSo, time to add a couple of labels!\n\nWe’ll start with our default code for our simple graph. The full code for this\ncan be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\n**Preparation** : Because we’re going to be adding labels to the bottom and\nleft of the graph we need to increase the bottom and left margins. Changes\nlike the following should suffice;\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 50, left: 70},\n    \n\n#### The x axis label\n\nFirst things first (because they’re done slightly differently), the x axis. If\nwe begin by describing what we want to achieve, it may make the process of\nimplementing a solution a little more logical.\n\nWhat we want to do is to add a simple piece of text under the x axis and in\nthe centre of the total span. Wow, that does sound easy.\n\nAnd it is, but there are different ways of accomplishing it, and I think I\nshould take an opportunity to demonstrate them. Especially since one of those\nways is a BAD idea.\n\nLets start with the bad idea first :-).\n\nThis is the code we’re going to add to the simple line graph script;\n\n    \n    \n      // text label for the x axis\n      svg.append(\"text\")             \n          .attr(\"x\", 480 )\n          .attr(\"y\",  475 )\n          .style(\"text-anchor\", \"middle\")\n          .text(\"Date\");\n    \n\nWe will put it in between the blocks of script that add the x axis and the y\naxis.\n\n    \n    \n      // Add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // PUT THE NEW CODE HERE!\n    \n      // Add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nBefore we describe what’s happening, let’s take a look at the result;\n\n![Date label on x axis](images/date01.png) Date label on x axis\n\nWell, it certainly did what it was asked to do. There’s a ‘Date’ label as\nadvertised! (Yes, I know it’s not pretty.) Let’s describe the code and then\nwork out why there’s a better way to do it.\n\n    \n    \n      // text label for the x axis\n      svg.append(\"text\")             \n          .attr(\"x\", 480 )\n          .attr(\"y\",  475 )\n          .style(\"text-anchor\", \"middle\")\n          .text(\"Date\");\n    \n\nThe first line appends a “text” element to our svg element. There is a lot\nmore to learn about “text” elements at the home of the [World Wide Web\nConsortium (W3C)](http://www.w3.org/TR/SVG/text.html#TextElement). The next\ntwo lines ( `.attr(\"x\", 480 ) and .attr(\"y\", 475 )` ) set the attributes for\nthe x and y coordinates to position the text on the svg.\n\nThe second last line (`.style(\"text-anchor\", \"middle\")`) ensures that the text\n‘style’ is such that the text is centre aligned and therefore remains nicely\ncentred on the x, y coordinates that we send it to.\n\nThe final line (`.text(\"Date\");`) adds the actual text that we are going to\nplace.\n\nThat seems really simple and effective and it is. However, the bad part about\nit is that we have hard coded the location for the date into the code. This\nmeans if we change any of the physical aspects of the graph, we will end up\nhaving to re-calculate and edit our code. And we don’t want to do that.\n\nHere’s an example. If I decide that I would prefer to decrease the height of\nthe graph by editing the line here;\n\n    \n    \n        height = 500 - margin.top - margin.bottom;\n    \n\nand making the height 490 pixels;\n\n    \n    \n        height = 490 - margin.top - margin.bottom;\n    \n\nThe result is as follows;\n\n![Hard coded Date label](images/date02.png) Hard coded Date label\n\n_EVERYTHING_ about the graph has adjusted itself, except our nasty, hard coded\n‘Date’ label which has been cruelly cut off. This is far from ideal and can be\neasily fixed by using the variables that we set up ever so carefully earlier.\n\nSo, instead of;\n\n    \n    \n          .attr(\"x\", 480 )\n          .attr(\"y\",  475 )\n    \n\nlets let our variables do the walking and use;\n\n    \n    \n          .attr(\"x\", width / 2 )\n          .attr(\"y\",  height + margin.top + 20)\n    \n\nSo with this code we tell the script that the ‘Date’ label will always be\nhalfway across the width of the graph (no matter how wide it is) and at the\nbottom of the graph with respect to its height plus the top margin and 20\npixels (as a fixed offset) (remember it uses a coordinates system that\nincreases from the top down).\n\nThe end result of using variables is that if I go to an extreme of changing\nthe height and width of my graph to;\n\n    \n    \n        width = 560 - margin.left - margin.right,\n        height = 300 - margin.top - margin.bottom;\n    \n\nWe still finish up with an acceptable result;\n\n![Auto adjusting Date label](images/date03.png) Auto adjusting Date label\n\nWell, for the label position at least :-).\n\nSo the changes to using variables is just a useful lesson that variables rock\nand mean that you don’t have to worry about your graph staying in relative\nshape while you change the dimensions. The astute readers amongst you will\nhave learned this lesson very early on in your programming careers, but it’s\nnever a bad idea to make sure that users that are unfamiliar with the concept\nhave an indicator of why it’s a good idea.\n\nNow the third method that I mentioned at the start of our x axis odyssey. This\nis not mentioned because it’s any better or worse way to implement your script\n(The reason that I say this is because I’m not sure if it’s better or worse.)\nbut because it’s sufficiently different to make it look confusing if you\ndidn’t think of it in the first place.\n\nSo, we’ll take our marvellous coordinates code;\n\n    \n    \n          .attr(\"x\", width / 2 )\n          .attr(\"y\",  height + margin.top + 20))\n    \n\nAnd replace it with a single (longer) line;\n\n    \n    \n          .attr(\"transform\",\n                \"translate(\" + (width/2) + \" ,\" + \n                               (height + margin.top + 20) + \")\")\n    \n\nThis uses the `\"transform\"` attribute to move (translate) the point to place\nthe ‘Date’ label to exactly the same spot that we’ve been using for the other\ntwo examples (using variables of course).\n\n### Why does that line look odd?\n\nThe `\"translate”` function is done in a ‘translate(x,y)’ style but it is put\non the page in such a way that the verbatim pieces that get passed back are in\nspeech marks and the variables are in the clear (in a manner of speaking).\nThat’s why the comma is in speech marks. Additionally, the variables are\ncontained within plus signs. I make the assumption that this is a designator\nfor ‘areas where there is variable action going on’. The end result is that if\nyou try to do some maths in that area with a plus sign, it does not appear to\nwork (or at least it didn’t for me). That’s why I put the variable for ( `+\n(height + margin.top + 20) +` ) in parenthesis (then I thought I should make\nthe `+ (width / 2) +` part look the same, but actually you can get away\nwithout them there).\n\n#### The y axis label\n\nSo, that’s the x axis label. Time to do the y axis. The code we’re going to\nuse looks like this;\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"transform\", \"rotate(-90)\")\n          .attr(\"y\", 0 - margin.left)\n          .attr(\"x\",0 - (height / 2))\n          .attr(\"dy\", \"1em\")\n          .style(\"text-anchor\", \"middle\")\n          .text(\"Value\"); \n    \n\nFor the sake of neatness we will put the piece of code in a nice logical spot\nand this would be following the block of code that added the y axis (but\nbefore the closing curly bracket)\n\n    \n    \n      // Add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n      // PUT THE NEW CODE HERE!\n    \n    });\n    \n\nAnd the result looks like this;\n\n![y axis label with rotation!](images/value01.png) y axis label with rotation!\n\nThere we go, a label for the y axis that is nicely centred and (gasp!) rotated\nby 90 degrees! Woah, does the leetness never end! (No. No it does not.)\n\nSo, how do we get to this incredible result?\n\nThe first thing we do is the same as for the x axis and append a text element\nto our svg element (`svg.append(\"text\")`).\n\nThen things get interesting.\n\n    \n    \n          .attr(\"transform\", \"rotate(-90)\")\n    \n\nBecause that line rotates everything by -90 degrees. While it’s obvious that\nthe text label ‘Value’ has been rotated by -90 degrees (from the picture), the\nfollowing lines of code show that we also rotated our reference point (which\ncan be a little confusing).\n\n    \n    \n          .attr(\"y\", 0 - margin.left)\n          .attr(\"x\",0 - (height / 2))\n    \n\nLet’s get graphical to illustrate how this works;\n\n![Reference point pre-rotation](images/value02.png) Reference point pre-\nrotation\n\nHere’s our starting position, with x,y in the 0,0 coordinate of the graph\ndrawing area surrounded by the margins.\n\nWhen we apply a -90 degrees transform we get the equivalent of this;\n\n![Reference point after rotation](images/value03.png) Reference point after\nrotation\n\nHere the 0,0 coordinate has been shifted by -90 degrees and the x,y\ndesignations are flipped so that we now need to tell the script that we’re\nmoving a ‘y’ coordinate when we would have otherwise been moving ‘x’.\n\nHence, when the script runs…\n\n    \n    \n          .attr(\"y\", 0 - margin.left)\n    \n\n… we can see that this is moving the x position to the left from the new 0\ncoordinate by the margin.left value.\n\nLikewise when the script runs…\n\n    \n    \n          .attr(\"x\",0 - (height / 2))\n    \n\n… this is actually moving the y position from the new 0 coordinate halfway up\nthe height of the graph area.\n\nI will be the first to admit that this does seem a little confusing. But\nhere’s the good part. You really don’t need to understand it completely.\nSimply do what I did when I saw the code. Play with it a bit till you get the\nresult you were looking for. If that means putting in some hard coded numbers\nand incrementing them to see which way is the new ‘up’. Good! Once you work it\nout, then work out how to get the right variable expression in there and\nyou’re set.\n\nIn the worst case scenario, simply use the code blocks as shown here and leave\nwell enough alone :-).\n\nRight, we’re not quite done yet. The following line has the effect of shifting\nthe text slightly to the right.\n\n    \n    \n          .attr(\"dy\", \"1em\")\n    \n\nFirstly the reason we do this is that our previous translation of coordinates\nmeans that when we place our text label it sits exactly on the line of 0 –\nmargin.left. But in this case that takes the text to the other side of the\nline, so it actually sits just outside the boundary of the svg element.\n\nThe `\"dy\"` attribute is another coordinate adjustment move, but this time a\nrelative adjustment and the “1em” is a unit of measure that equals exactly one\nunit of the currently specified [text point\nsize](http://en.wikipedia.org/wiki/Em_\\(typography\\)). So what ends up\nhappening is that the ‘Value’ label gets shifted to the right by exactly the\nheight of the text, which neatly places it exactly on the edge of the canvas.\n\nThe two final lines of this part of the script are the same as for the x axis.\nThey make sure the reference point is aligned to the centre of the text\n(`.style(\"text-anchor\", \"middle\")`) and then it prints the text\n(`.text(\"Value\");`). There, that wasn’t too painful.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/23e42c8f67210ac6c678db2cd07a747e) or\nin the code samples bundled with this book (axis-labels.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/23e42c8f67210ac6c678db2cd07a747e).\n\n### How to add a title to your graph\n\nIf you’ve read through the [adding the axis labels](chap05.xhtml#axislabels)\nsection most of this will come as no surprise.\n\nWhat we want to do to add a title to the graph is to add a text element (just\na few words) that will appear above the graph and centred left to right.\n\nWe’ll start with our default code for our simple graph. The full code for this\ncan be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\n**Preparation** : Because we’re going to be adding a title to the top of the\ngraph we need to increase the top margin. Changes like the following should\nsuffice;\n\n    \n    \n    var margin = {top: 40, right: 20, bottom: 50, left: 70},\n    \n\nTo add the title this is the code we’re going to add to the simple line graph\nscript;\n\n    \n    \n      // add a title\n      svg.append(\"text\")\n          .attr(\"x\", (width / 2))\t\t\t\t\n          .attr(\"y\", 0 - (margin.top / 2))\n          .attr(\"text-anchor\", \"middle\")\t\n          .style(\"font-size\", \"20px\") \n          .style(\"text-decoration\", \"underline\") \t\n          .text(\"Value vs Date Graph\");\n    \n\nAnd the end result will look like this;\n\n![Basic graph with title](images/title01.png) Basic graph with title\n\nA nice logical place to put the block of code would be towards the end of the\nJavaScript. In fact I would put it as the last element we add. So here;\n\n    \n    \n      // add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n      // PUT THE NEW CODE HERE!\n    \n    });\n    \n\nNow since the vast majority of the code for this block is a regurgitation of\nthe axis labels code, I don’t want to revisit that and bloat up this document\neven more, so I will direct you [back to that\nsection](chap05.xhtml#axislabels) if you need to refresh yourself on any\nparticular line. But….. There are a couple of new ones in there which could\nbenefit from a little explanation.\n\nBoth of them are style descriptors and as such their job is to apply a very\nspecific style to this element.\n\n    \n    \n            .style(\"font-size\", \"20px\") \n            .style(\"text-decoration\", \"underline\") \t\n    \n\nWhat they do is pretty self explanatory. Make the text a specific size and\nunderline it. But what is perhaps slightly more interesting is that we have\nthis declaration in the JavaScript code and not in the CSS portion of the\nfile.\n\nStrictly speaking, this is the sort of thing that would be placed in the\n`<style>` section of the HTML code, but in this case, since it is only going\nto be used once, we shouldn’t feel too bad putting it here.\n\n### Change a line chart into a scatter plot\n\nConfession time.\n\nI didn’t actually intend to add in a section with a scatter plot in it because\nI thought it would be;\n\n  1. tricky\n  2. not useful\n  3. all of the above\n\nI was wrong on all counts.\n\nI did want to have a scatter plot, because I wanted to display tool tips, but\nthis is too neat to ignore. It was literally a 5 minute job, 3 minutes of\nwhich was taken up by going to the [d3 gallery on the\nwiki](https://github.com/mbostock/d3/wiki/Gallery) and ogling at the cool\nstuff there before snapping out of it and going to the [scatter plot\nexample](http://bl.ocks.org/3887118).\n\nAll you need to do is take the [simple graph](chap04.xhtml#simplegraph)\nexample file. The full code for this can be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\nWe then slot the following block in between the ‘Add the valueline path’ and\nthe ‘add the x axis’ blocks.\n\n    \n    \n      // Add the scatterplot\n      svg.selectAll(\"dot\")\n          .data(data)\n        .enter().append(\"circle\")\n          .attr(\"r\", 5)\n          .attr(\"cx\", function(d) { return x(d.date); })\n          .attr(\"cy\", function(d) { return y(d.close); });\n    \n\nAnd you will get…\n\n![A scatter plot! \\(with a line\\)](images/scatter01.png) A scatter plot! (with\na line)\n\nThe full code for this graph can also be found on\n[github](https://gist.github.com/d3noob/6f082f0e3b820b6bf68b78f2f7786084) or\nin the code samples bundled with this book (scatterplot.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/6f082f0e3b820b6bf68b78f2f7786084).\n\nI deliberately put the dots _after_ the line in the drawing section, because I\nthought they would look better, but you could put the block of code before the\nline drawing block to get the following effect;\n\n![A scatter plot with the line in front of the dots](images/scatter02.png) A\nscatter plot with the line in front of the dots\n\n(just trying to reinforce the concept that ‘order’ matters when drawing\nobjects :-)).\n\nYou could of course just remove the line block all together…\n\n![A scatter plot without the line this time](images/scatter03.png) A scatter\nplot without the line this time\n\nBut in my humble opinion it loses something.\n\nSo what do the individual lines in the scatter plot block of JavaScript do?\n\nThe first line (`svg.selectAll(\"dot\")`) essentially provides a suitable\ngrouping label for the svg circle elements that will be added. The next line\nassociates the range of data that we have to the group of elements we are\nabout to add in.\n\nThen we add a circle for each data point (`.enter().append(\"circle\")`) with a\nradius of 5 pixels (`.attr(\"r\", 5)`) and appropriate x (`.attr(\"cx\",\nfunction(d) { return x(d.date); })`) and y (`.attr(\"cy\", function(d) { return\ny(d.close); });`) coordinates.\n\nThere is lots more that we could be doing with this piece of code (check out\nthe [scatter plot example](http://bl.ocks.org/3887118)) including varying the\ncolour or size or opacity of the circles depending on the data and all sorts\nof really neat things, but for the mean time, there we go. Scatter plot!\n\n### Smoothing out graph lines\n\nWhen you draw a line graph, what you’re doing is taking two (or more) sets of\ncoordinates and connecting them with a line (or lines). I know that sounds\nsimplistic, but bear with me. When you connect these points, you’re telling\nthe viewer of the graph that in between the individual points, you expect the\nvalue to vary in keeping with the points that the line passes through. So in a\nway, you’re trying to interpret the change in values that are not shown.\n\nNow this is not strictly true for all graph types, but it does hold for a lot\nof line graphs.\n\nSo… when connecting these known coordinates together, you want to make the\nbest estimate of how the values would be represented. In this respect,\nsometimes a straight line between points is not the best representation.\n\nFor instance. Earlier, when demonstrating the extent function for graphing we\nshowed a graph of the varying values with the y axis showing a narrow range.\n\n![Expanded values for a narrow range](images/scales6.png) Expanded values for\na narrow range\n\nThe resulting variation of the graph shows a fair amount of extremes and you\ncould be forgiven for thinking that if this represented a smoothly flowing\nanalog system of some kind then some of those sharp peaks and troughs would\nnot be a true representation of how the system or figures varied.\n\nSo how should it look? Ahh… The $64,000 question. I don’t know :-). You will\nhave a better idea since you are the person who will know your data best.\nHowever, what I do know is that D3 has some tricks up its sleeve to help.\n\nWe can easily change what we see above into;\n\n![Smoothing using \"basis\"](images/smooth02.png) Smoothing using “basis”\n\nHow about that? And the massive amount of code required to carry out what must\nbe a ridiculously difficult set of calculations?\n\n    \n    \n        .curve(d3.curveBasis);\n    \n\nNow, that is slightly unfair because that’s the code that WE need to put in\nyour script, but Mike Bostock probably had to do the mental equivalent of\nwalking across hot coals to get it to work so nicely.\n\nSo where does this neat piece of code go? Here;\n\n    \n    \n    // define the line\n    var valueline = d3.line()\n        .curve(d3.curveBasis)\t \t\t// <=== THERE IT IS!\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n\nSo is that it? Nooooo…….. There’s more! This is one form of interpolation\neffect that can be applied to your data, but there is a range and depending on\nyour data you can select the one that is appropriate.\n\nHere’s the list of available options and for more about them head on over to\nthe [D3 wiki](https://github.com/d3/d3-shape/blob/master/README.md#curves).\n\n  * linear (`d3.curveLinear`) – Normal line (jagged).\n  * linear-closed (`d3.curveLinearClosed`) – A normal line (jagged) families of curves available with the start and the end closed in a loop.\n  * step (`d3.curveStep`)- a stepping graph alternating between vertical and horizontal segments. The y values change at the mid point of the adjacent x values\n  * step-before (`d3.curveStepBefore`) - a stepping graph alternating between vertical and horizontal segments. The y values change before the x value.\n  * step-after (`d3.curveStepAfter`) - a stepping graph alternating between horizontal and vertical segments. The y values change after the x value.\n  * basis (`d3.curveBasis`) - a B-spline, with control point duplication on the ends (that’s the one above).\n  * basis-open (`d3.curveBasisOpen`) - an open B-spline; may not intersect the start or end.\n  * basis-closed (`d3.curveBasisClosed`) - a closed B-spline, with the start and the end closed in a loop.\n  * bundle (`d3.curveBundle`) - equivalent to basis, except a separate tension parameter is used to straighten the spline. This could be really cool with varying tension.\n  * cardinal (`d3.curveCardinal`) - a Cardinal spline, with control point duplication on the ends. It looks slightly more ‘jagged’ than basis.\n  * cardinal-open (`d3.curveCardinalOpen`) - an open Cardinal spline; may not intersect the start or end, but will intersect other control points. So kind of shorter than ‘cardinal’.\n  * cardinal-closed (`d3.curveCardinalClosed`) - a closed Cardinal spline, looped back on itself.\n  * monotone (`d3.curveMonotoneX`) - cubic interpolation that makes the graph only slightly smoother.\n  * catmull-Rom (`d3.curveCatmullRom`) - New for v4 - a cubic [Catmull–Rom spline](https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline)\n  * catmull-Rom-closed (`d3.curveCatmullRomClosed`) - New for v4 - a closed cubic Catmull–Rom spline\n  * catmull-Rom-open (`d3.curveCatmullRomOpen`) - New for v4 - an open cubic Catmull–Rom spline\n\nBecause in the course of writing this I took an opportunity to play with each\nof them, I was pleasantly surprised to see some of the effects and it seems\nlike a shame to deprive the reader of the same joy :-). So at the risk of\ndeforesting the planet (so I hope you are reading this in electronic format)\nhere is each of the above interpolation types applied to the same data.\n\nThis is also an opportunity to add some reader feedback awesomeness. Many\nthanks to ‘enjalot’ for the great suggestion to plot the points of the data as\nseparate circles on the graphs. Since the process of interpolation has the\neffect of ‘interpreting’ the trends of the data to the extent that in some\ncases, the lines don’t intersect the actual data much at all.\n\nEach of the following shows the smoothing curve and the data that is used to\nplot the graph (as a scatterplot).\n\n![Smoothing using \"linear\"](images/smooth03.png) Smoothing using “linear”\n![Smoothing using \"linear-closed\"](images/smooth03a.png) Smoothing using\n“linear-closed” ![Smoothing using \"step\"](images/smooth04a.png) Smoothing\nusing “step” ![Smoothing using \"step-before\"](images/smooth04.png) Smoothing\nusing “step-before” ![Smoothing using \"step-after\"](images/smooth05.png)\nSmoothing using “step-after” ![Smoothing using \"basis\"](images/smooth06.png)\nSmoothing using “basis” ![Smoothing using \"basis-open\"](images/smooth07.png)\nSmoothing using “basis-open” ![Smoothing using \"basis-\nclosed\"](images/smooth08.png) Smoothing using “basis-closed” ![Smoothing using\n\"bundle\"](images/smooth09.png) Smoothing using “bundle” ![Smoothing using\n\"cardinal\"](images/smooth10.png) Smoothing using “cardinal” ![Smoothing using\n\"cardinal-open\"](images/smooth11.png) Smoothing using “cardinal-open”\n![Smoothing using \"cardinal-closed\"](images/smooth12.png) Smoothing using\n“cardinal-closed” ![Smoothing using \"monotone\"](images/smooth13.png) Smoothing\nusing “monotone” ![Smoothing using \"catmull-Rom\"](images/smooth14.png)\nSmoothing using “catmull-Rom” ![Smoothing using \"catmull-Rom-\nclosed\"](images/smooth15.png) Smoothing using “catmull-Rom-closed” ![Smoothing\nusing \"catmull-Rom-open\"](images/smooth16.png) Smoothing using “catmull-Rom-\nopen”\n\nJust in case you’re in the mood for another example, feel free to check out\nthe [bl.ock here](http://bl.ocks.org/d3noob/ced1b9b18bd8192d2c898884033b5529)\nwhich shows all of the basic forms of the curve types (I didn’t include the\nopen and closed versions or ‘bundle’ since it is the equivalent of ‘basis’).\nThe full code for this can also be found in the code samples bundled with this\nbook (interpolate.html and data-3.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\n![Comparison of curve types](images/smooth17.png) Comparison of curve types\n\nSo, over to you to decide which format of interpolation is going to suit your\ndata best:-).\n\n### Make a dashed line\n\nDashed lines totally rock!\n\nOK, there may be an element of exaggeration there, but I certainly found it\ninteresting that there didn’t seem to be a lot of explanation for a simple\nperson like myself to make a dashed line in D3. So for me they rocked :-)\n\nOne of the best parts about it is that they’re so simple to do!\n\nLiterally one line!!!!\n\nSo lets imagine that we want to make the line on our [simple\ngraph](chap04.xhtml#simplegraph) dashed. All we have to do is insert the\nfollowing line in our JavaScript code here;\n\n    \n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .style(\"stroke-dasharray\", (\"3, 3\"))  // <== This line here!!\n          .attr(\"d\", valueline);\n    \n\nAnd our graph ends up like this;\n\n![Dashed line for the basic graph](images/dashed01.png) Dashed line for the\nbasic graph\n\nHey! It’s dashtastic!\n\nSo how does it work?\n\nWell, obviously `\"stroke-dasharray\"` is a style for the path element, but the\nmagic is in the numbers.\n\nEssentially they describe the on length and off length of the line. So `\"3,\n3\"` translates to 3 pixels (or whatever they are) on and 3 pixels off. Then it\nrepeats. Simple eh?\n\nSo, experiment time :-)\n\nWhat would the following represent?\n\n`\"5, 5, 5, 5, 5, 5, 10, 5, 10, 5, 10, 5\"`\n\nTry not to cheat…\n\n![Dashed lines for fun](images/dashed02.png) Dashed lines for fun\n\nAhh yes, Mr. Morse would be proud.\n\nAnd you can put them anywhere. Here are our axes perverted with dashes;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .style(\"stroke-dasharray\", (\"3, 3\"))\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .style(\"stroke-dasharray\", (\"3, 3\"))\n          .call(d3.axisLeft(y));\n    \n\n![When dashed lines go bad](images/dashed03.png) When dashed lines go bad\n\nWell… I suppose you can have too much of a good thing. With great power comes\ngreat responsibility. Use your dash skills wisely and only for good.\n\n### Filling an area under the graph\n\nLines are all very well and good, but that’s not the whole story for graphs.\nSometimes you’ve just got to go with a fill.\n\nFilling an area with a solid colour isn’t too hard. I mean we did it by\nmistake back a few pages when we were trying to draw a line.\n\nBut to do it in a nice coherent way is fairly straight forward.\n\nIt takes three sections of code in much the same way that we drew our grid\nlines earlier;\n\n  1. One in the CSS section to define what style the area will have.\n  2. One to define the functions that generate the area. And…\n  3. One to draw the area.\n\nThe end result will looks a bit like this;\n\n![Basic graph with an area fill](images/fill01.png) Basic graph with an area\nfill\n\nWhile we’ll start with our default code for our simple graph, the full code\nfor this area graph can be found on\n[github](https://gist.github.com/d3noob/119a138ef9bd1d8f0a8d57ea72355252) or\nin the code samples bundled with this book (area.html and data.csv). A live\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/119a138ef9bd1d8f0a8d57ea72355252).\n\n#### CSS for an area fill\n\nThis is pretty straight forward and only consists of one rule;\n\n    \n    \n    .area {\n      fill: lightsteelblue;\n    }\n    \n\nPut it at the bottom of your `<style>` section.\n\nThe style (`fill: lightsteelblue;`) sets the colour of our fill (and in this\ncase we have chosen a lighter shade of the same colour as our line to match\nit).\n\n#### Define the area function\n\nWe need a function that will tell the area what space to fill. This is\naccessed from the [`d3.area`\nfunction](https://github.com/d3/d3-shape/blob/master/README.md#areas)\n\nThe code that we will use is as follows;\n\n    \n    \n    // define the area\n    var area = d3.area()\n        .x(function(d) { return x(d.date); })\n        .y0(height)\n        .y1(function(d) { return y(d.close); });\n    \n\nI have placed it in between the range variable definitions and the line\ndefinitions here;\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n                             <==== Put the new code here!\n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n\nYou will notice it looks _INCREDIBLY_ similar to the valueline function\ndefinition. That’s because; while the line definition describes drawing a line\nthat connects a set of coordinates, I imagine the area definition describes\ndrawing two lines that share the same x coordinates, but simultaneously draws\ntwo y coordinates, y0 and y1. Then when it’s finished drawing the resultant\nshape, it fills it with the colour of your choosing.\n\nSo the only changes to the code are the addition of the `y0` line and the\nrenaming of the `y` line `y1`.\n\nHere’s a picture that might help explain;\n\n![How the area is defined](images/fill03.png) How the area is defined\n\nAs should be apparent, the top line (`y1`) follows the valueline line and the\nbottom line is at the constant ‘height’ value. Everything in between these\nlines is what gets filled. The function in this section describes the area.\n\n#### Draw the area\n\nNow to the money maker.\n\nThe final section of code in the area filling odyssey is as follows;\n\n    \n    \n      // add the area\n        svg.append(\"path\")\n           .data([data])\n           .attr(\"class\", \"area\")\n           .attr(\"d\", area);\n    \n\nWe should place this block directly after the domain functions but before the\ndrawing of the valueline path;\n\n    \n    \n      // scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n                                    //   <== Area drawing code here!\n    \n      // add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n\nThis is actually a pretty good idea to put it there since the various bits and\npieces that are drawn in the graph are done so one after the other. This means\nthat the filled area comes first, then the valueline is layered on top and\nthen the axes come last. This is a pretty good sequence since if there are\nareas where two or more elements overlap, it might cause the graph to look\n‘wrong’.\n\nFor instance, here is the graph drawn with the area added last.\n\n![Area overlaps and obscures](images/fill04.png) Area overlaps and obscures\n\nYou should be able to notice that part of the valueline line has been obscured\nand the line for the y axis where it coincides with the area is obscured also.\n\nLooking at the code we are adding here, the first line appends a path element\n(`svg.append(\"path\")`) much like the script that draws the line.\n\nThe second line (`.data([data])`) declares the data we will be utilising for\ndescribing the area and the third line (`.attr(\"class\", \"area\")`) makes sure\nthat the style we apply to it is as defined in the CSS section (under ‘area’).\n\nThe final line (`.attr(\"d\", area);`) declares “d” as the attributer for path\ndata and calls the ‘area’ function to do the drawing.\n\nAnd that’s it!\n\n#### Filling an area above the line\n\nPop Quiz:\n\nHow would you go about filling the area _ABOVE_ the graph?\n\nNow it might sound a little trite, but believe it or not, this could come in\nhandy. For instance, what if you want to highlight an area that was too high\nand an area that was too low for a line of data on a graph with an area in the\ncentre where a projected ‘normal’ set of values should be present?\n\nIn this instance, you could fill the lower area as has been demonstrated here,\nand with a small change you can fill another area with a solid colour above\nanother line.\n\nHow is this incredible feat achieved?\n\nWell, remember the code that defined the area?\n\n    \n    \n    // define the area\n    var area = d3.area()\n        .x(function(d) { return x(d.date); })\n        .y0(height)\n        .y1(function(d) { return y(d.close); });\n    \n\nAll we have to do is tell it that instead of setting the `y0` constant value\nto the height of the graph (remember, this is the bottom of the graph) we will\nset it to the constant value that is at the top of the graph. In other words\nzero (0).\n\n    \n    \n        .y0(0)\n    \n\nThat’s it.\n\n![Fill an area above a line](images/fill05.png) Fill an area above a line\n\nNow, I’m not going to go over the process of drawing two lines and filling\neach in different directions to demonstrate the example I described, but this\nprovides a germ of an idea that you might be able to flesh out :-)\n\n### Adding a drop shadow to allow text to stand out on graphics.\n\nI’ve deliberately positioned this particular tip to follow the ‘filling an\narea’ description because it provides an opportunity to demonstrate the\nprinciple to slightly better effect.\n\nWhile we’ll start with our code for our area graph, the full code for the\ngraph with shadowy text can be found on\n[github](https://gist.github.com/d3noob/aa55e2004abba3c503116b103a1f0ff2) or\nin the code samples bundled with this book (shadow.html and data.csv). A live\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/aa55e2004abba3c503116b103a1f0ff2).\n\nThere have been several opportunities where I have wanted to place text\noverlaid on graphs for convenience sake only to have it look overly messy as\nthe text interferes with the graph.\n\n### Is this evil?\n\nNow, I’ll be the first to say that the principle of overlaying text on a graph\nis probably not best practice, but sometimes you’ve got to do what you’ve got\nto do. Besides. Sometimes it’s a valid idea. If I remember rightly, the first\ntime I came across this idea, it was being used to highlight text when\npositioned on bars of a bar graph. So it’s not always an evil practice :-).\n\nAnyway, what we’ll do is leave the area fill in place and place the title back\non the graph, but position the title so that it lays on top of the fill like\nso;\n\n![Title lost in the area fill](images/drop01.png) Title lost in the area fill\n\nThe additional code for the title is the following and appears just after the\ndrawing of the axes.\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"x\", (width / 2))\t\t\t\t\n          .attr(\"y\", 25 )\n          .attr(\"text-anchor\", \"middle\")\t\n          .style(\"font-size\", \"24px\") \n          .style(\"text-decoration\", \"underline\") \t\n          .text(\"Value vs Date Graph\");\n    \n\n(the only change from the previous title example is the ‘y’ attribute which\nhas been hard coded to 25 to place it inconveniently on the filled area and\nthe size of the font)\n\nSo, what we want to end up with is something like the following…\n\n![A nice white drop shadow effect](images/drop02.png) A nice white drop shadow\neffect\n\nIn my humble opinion, it’s just enough to make the text acceptable :-).\n\nThe method that I’ll describe to carry this out is designed so that the drop\nshadow effect can be applied to any text elements in the graph, not the\nisolated example that we will use here. In order to implement this marvel of\nutility we will need to make changes in two areas. One in the CSS where we\nwill define a style for white shadowy backgrounds and the second to draw it.\n\n#### CSS for white shadowy background\n\nThe code to add to the CSS section is as follows;\n\n    \n    \n    text.shadow {\n      stroke: white;\n      stroke-width: 4px;\n      opacity: 0.8;\n    }\n    \n\nThe first line designates that the style applies to text with a ‘shadow’\nlabel. The stroke is set to white. The width of the line is set to 4px and it\nis made to be slightly see-through. So by setting the line that surrounds the\ntext to be thick, white and see-through gives it a slightly ‘cloudy’ effect.\nIf we remove the black text from over the top we get a slightly better look;\n\n![A closer look at just the drop shadow](images/drop03.png) A closer look at\njust the drop shadow\n\nOf course if you want to have a play with any of these settings, you should\nhave a go and see what works best for your graph.\n\n#### Drawing the white shadowy background.\n\nNow that we’ve set the style for our background, we need to draw it in.\n\nThe code for this should be extremely familiar;\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"x\", (width / 2))\t\t\t\t\n          .attr(\"y\", 25 )\n          .attr(\"text-anchor\", \"middle\")\t\n          .style(\"font-size\", \"24px\") \n          .style(\"text-decoration\", \"underline\") \n          .attr(\"class\", \"shadow\")\t\t\t// <=== Here's the different line\n          .text(\"Value vs Date Graph\");\n    \n\nThat’s because it’s identical to the piece of code that was used to draw the\ntitle except for the one line that is indicated above. The reason that it’s\nidentical is that what we are doing is placing a white shadow on the graph and\nthen the text on top of it, if it deviated by a significant amount it will\njust look silly. Of course a slight amount could look effective, in which case\nadjust the ‘`x`’ or ‘`y`’ attributes.\n\nOne of the things I pointed out in the previous paragraph was extremely\nimportant. That’s the bit that tells you that we needed to place the shadow\n**before** we placed the black text. For the same reason that we placed the\narea fill on first in the area fill example, If black text goes on before the\nshadow, it will look pretty silly. So place this block of code just before the\nblock that draws the title.\n\nSo the line that has been added in is the one that tells D3 that the text that\nis being drawn will have the white cloudy effect. And at the risk of repeating\nmyself, if you have several text elements that could benefit from this effect,\nonce you have the CSS code in place, all you need to do is duplicate the block\nthat adds the text and add in that single line and voila!\n\n### Adding grid lines to a graph\n\nGrid lines are an important feature for some graphs as they allow the eye to\nassociate three analogue scales (the x and y axis and the displayed line).\n\nThere is currently a tendency to use graphs without grid lines online as it\ngives the appearance of a ‘cleaner’ interface, but they are still widely used\nand a necessary component for graphing.\n\nThis is what we’re going to draw;\n\n![Basic graph with gridlines](images/grid01.png) Basic graph with gridlines\n\nWhile we’ll start with our default code for our simple graph, the full code\nfor the graph with grid lines can be found on\n[github](https://gist.github.com/d3noob/c506ac45617cf9ed39337f99f8511218) or\nin the code samples bundled with this book (grid.html and data.csv). A live\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218).\n\nLike pretty much everything in this document, the clever parts of this are not\nmy work. I’ve simply used other peoples cleverness to solve my problems. In\nthis case I think the source of this solution came from the good work of\nJustin Palmer in his excellent description of the design of a line graph\n[here](http://dealloc.me/2011/06/24/d3-is-not-a-graphing-library.html).\nHowever, in retrospect when I’ve looked back, I’m not sure if I got this right\n(as I did this quite a while ago when I was less fastidious about noting my\nsources). In any case, Justin’s work is excellent and I heartily recommend it,\nand here is my implementation of what I think is his work :-)\n\nHow to build grid lines?\n\nWe’re going to use the axis function to generate two more axis elements (one\nfor x and one for y) but for these ones instead of drawing the main lines and\nthe labels, we’re just going to draw the tick lines. Really long tick lines\n(I’m considering calling them [long\ncat](http://knowyourmeme.com/memes/longcat) lines).\n\nTo create them we have to add in 3 separate blocks of code.\n\n  1. One in the CSS section to define what style the grid lines will have.\n  2. One to define the functions that generate the grid lines. And…\n  3. One to draw the lines.\n\n#### The grid line CSS\n\nThis is the total styling that we need to add for the tick lines;\n\n    \n    \n    .grid line {\n      stroke: lightgrey;\n      stroke-opacity: 0.7;\n      shape-rendering: crispEdges;\n    }\n    \n    .grid path {\n      stroke-width: 0;\n    }\n    \n\nJust add this block of code at the end of the current CSS that is in the\nsimple graph template (just before the `</style>` tag).\n\nThe CSS here is done in two parts.\n\nThe first portion sets the line colour (stroke), the opacity (transparency) of\nthe lines and make sure that the lines are narrow (`crispEdges`).\n\n    \n    \n      stroke: lightgrey;\n      stroke-opacity: 0.7;\n      shape-rendering: crispEdges;\n    \n\nThe colour is pretty standard, but in using the opacity style we give\nourselves the opportunity to use a good shade of colour (if grey actually is a\ncolour) and to juggle the degree to which it stands out a little better.\n\nThe second part is the stroke width.\n\n    \n    \n      stroke-width: 0;\n    \n\nNow it might seem a little weird to be setting the stroke width to zero, but\nif you don’t (and we remove the style) this is what happens;\n\n![Axis lines made too thick](images/grid02.png) Axis lines made too thick\n\nIf you look closely (compare with the previous picture if necessary) the grid\nlines for the top and right edges have turned black. The stroke width style is\nobviously adding in new axis lines and we’re not interested in them at the\nmoment. Therefore, if we set the stroke width to zero, we get rid of the\nproblem.\n\n#### Define the grid line functions\n\nWe will need to define two functions to generate the grid lines and they look\na little like this;\n\n    \n    \n    // gridlines in x axis function\n    function make_x_gridlines() {\t\t\n        return d3.axisBottom(x)\n            .ticks(5)\n    }\n    \n    // gridlines in y axis function\n    function make_y_gridlines() {\t\t\n        return d3.axisLeft(y)\n            .ticks(5)\n    }\n    \n\nEach function will carry out its configuration when called from the later part\nof the script (the drawing part).\n\nA good spot to place the code is just before we load the data with the d3.csv\n\n    \n    \n            //   <== Put the functions here!\n    \n    // Get the data\n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n    \n\nBoth functions are almost identical. They give the function a name\n(make_x_gridlines and make_y_gridlines) which will be used later when the\npiece of code that draws the lines calls out to them.\n\nBoth functions also show which parameters will be fed back to the drawing\nprocess when called. Both make sure they use the d3.axis function and then\nthey set individual attributes which make sense.\n\nThey make sure they’ve got the right axes (with the `x` and `y` variables in\nthe function). They set the orientation of the axes to match the incumbent\naxes (`d3.axisBottom(x)` and `d3.axisLeft(y)`). And they set the number of\nticks to match the number of ticks in the main axis (`.ticks(5)` and\n`.ticks(5)`). You have the opportunity here to do something slightly different\nif you want. For instance, think back to when we were setting up the axis for\nthe basic graph and we messed about, seeing how many ticks we could get to\nappear. If we increase the number of ticks that appear in the grid (lets say\nto `.ticks(30)` and `.ticks(10)`)) we get the following;\n\n![Grid lines with greater divisions](images/grid03.png) Grid lines with\ngreater divisions\n\nSo the grid lines can now show divisions of 20 on the y axis and per 2 days on\nthe x axis :-)\n\n#### Draw the lines\n\nThe final block of code we need is the bit that draws the lines.\n\n    \n    \n      // add the X gridlines\n      svg.append(\"g\")\t\t\t\n          .attr(\"class\", \"grid\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(make_x_gridlines()\n              .tickSize(-height)\n              .tickFormat(\"\")\n          )\n    \n      // add the Y gridlines\n      svg.append(\"g\")\t\t\t\n          .attr(\"class\", \"grid\")\n          .call(make_y_gridlines()\n              .tickSize(-width)\n              .tickFormat(\"\")\n          )\n    \n\nThe first two lines of both the x and y axis grid lines code above should be\npretty familiar by now. The first one appends the element to be drawn to the\ngroup “g”. the second line (`.attr(\"class\", \"grid\")`) makes sure that the\nstyle information set out in the CSS is applied.\n\nThe x axis grid lines portion makes a slight deviation from conformity here to\nadjust its positioning to take into account the coordinates system\n`.attr(\"transform\", \"translate(0,\" + height + \")\")`.\n\nThen both portions call their respective make axis functions\n(`.call(make_x_gridlines()` and `.call(make_y_gridlines()`).\n\nNow comes the really interesting bit.\n\nWhat you will see if you go to the [D3 API\nwiki](https://github.com/mbostock/d3/wiki/SVG-Axes#wiki-tickSize) is that for\nthe .tickSize function, the following is the format.\n\n    \n    \n    axis.tickSize([size])\n    \n\nSo in our example we are setting our ticks to a length that corresponds to the\nfull height or width of the graph. Which of course means that they extend\nacross the graph and have the appearance of grid lines! What a neat trick.\n\nThe last thing that is included in the code to draw the grid lines is the\ninstruction to suppress printing any label for the ticks;\n\n    \n    \n              .tickFormat(\"\")\n    \n\nAfter all, that would become a bit confusing to have two sets of labels. Even\nif one was on top of the other. They do tend to become obvious if that occurs\n(they kind of bulk out a bit like bold text).\n\nAnd that’s it. Grid lines!\n\n### Adding more than one line to a graph\n\nAll right, we’re starting to get serious now. Two lines on a graph is a bit of\na step into a different world in one respect. I mean that in the sense that\nthere’s more than one way to carry out the task, and I tend to do it one way\nand not the other mainly because I don’t fully understand the other way :-(.\n\nI should stress that that’s not because it’s more complex, or that it’s a bad\nway, it’s just that once I started doing things one way, I haven’t come across\na need to do things another way. There’s a good chance I will have to revisit\nthis decision in the future, but for now I’ll keep moving.\n\nHow are we going to do this? I think that the best way will be to make the\nexecutive decision that we have suddenly come across more data and that it is\nalso in our data.csv file (which we’ll rename data2.csv just to highlight the\ndifference between the two data sets). In fact it looks a little like this\n(apologies in advance for the big ugly block of data);\n\n    \n    \n    date,close,open\n    1-May-12,68.13,34.12\n    30-Apr-12,63.98,45.56\n    27-Apr-12,67.00,67.89\n    26-Apr-12,89.70,78.54\n    25-Apr-12,99.00,89.23\n    24-Apr-12,130.28,99.23\n    23-Apr-12,166.70,101.34\n    20-Apr-12,234.98,122.34\n    19-Apr-12,345.44,134.56\n    18-Apr-12,443.34,160.45\n    17-Apr-12,543.70,180.34\n    16-Apr-12,580.13,210.23\n    13-Apr-12,605.23,223.45\n    12-Apr-12,622.77,201.56\n    11-Apr-12,626.20,212.67\n    10-Apr-12,628.44,310.45\n    9-Apr-12,636.23,350.45\n    5-Apr-12,633.68,410.23\n    4-Apr-12,624.31,430.56\n    3-Apr-12,629.32,460.34\n    2-Apr-12,618.63,510.34\n    30-Mar-12,599.55,534.23\n    29-Mar-12,609.86,578.23\n    28-Mar-12,617.62,590.12\n    27-Mar-12,614.48,560.34\n    26-Mar-12,606.98,580.12\n    \n\nThree columns, date open and close. The first two are exactly what we have\nbeen dealing with all along and the last (open) is our new made up data. Each\ncolumn is separated by a comma (hence .csv (comma separated values)), which is\nthe format we’re currently using to import data.\n\nWe should save this as a new file so we don’t mess up our previous data, so\n(as mentioned earlier) let’s call it data2.csv.\n\nThere is a copy of this file and the sample code at\n[github](https://gist.github.com/d3noob/4db972df5d7efc7d611255d1cc6f3c4f) and\nin the code samples bundled with this book (multiple-lines.html and\ndata2.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/4db972df5d7efc7d611255d1cc6f3c4f).\n\nWe will build our new code using our [simple graph](chap04.xhtml#simplegraph)\ntemplate to start with, so the immediate consequence of this is that we need\nto edit the line that was looking for ‘data.csv’ to reflect the new name.\n\n    \n    \n    d3.csv(\"data2.csv\", function(error, data) {\n    \n\nSo when you browse to our new graph’s html file, we don’t see any changes. It\nstill happily loads the new data, but because it hasn’t been told to do\nanything with it, nothing new happens.\n\nWhat we need to do now it to essentially duplicate the code blocks that drew\nthe first line for the second line.\n\nThe good news is that in the simplest way possible that’s just two code\nblocks. The first sets up the function that defines the new line;\n\n    \n    \n    // define the 2nd line\n    var valueline2 = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.open); });\n    \n\nYou should notice that this block is identical to the block that sets up the\nfunction for the first line, except this one is called (imaginatively)\nvalueline2 and instead of including the variable ‘close’ for our datapoint we\nare using our new variable (from the extra column in the csv file) ‘open’. We\nshould put it directly after the block that sets up the function for\nvalueline.\n\nThe second block draws our new line;\n\n    \n    \n      // Add the valueline2 path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline2);\n    \n\nAgain, this is identical to the block that draws the first line, except this\none is called valueline2. We should put it directly after the block that draws\nvalueline.\n\nAfter those three small changes, check out your new graph;\n\n![Two lines, but the same colour](images/twolines01.png) Two lines, but the\nsame colour\n\nHey! Two lines! Hmm…. Both being the same colour is a bit confusing. Good\nnews. We can change the colour of the second line by inserting a line that\nadjusts its stroke (colour) very simply.\n\nSo here’s what our new drawing block looks like;\n\n    \n    \n      // Add the valueline2 path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .style(\"stroke\", \"red\")\n          .attr(\"d\", valueline2);\n    \n\nAnd as if by magic, here’s our new graph;\n\n![Two lines with two colours](images/twolines02.png) Two lines with two\ncolours\n\nWow. Right about now, we’re thinking ourselves pretty clever. But there are\ntwo places where we’re not doing things right. We took a simple way, but we\ntook some short cuts that might bite us in the posterior.\n\nThe first mistake we made was not ensuring that our variable `\"d.open\"` is\nbeing treated as a number or a string. We’re fortunate in this case that it\nis, but this can’t always be assumed. So, this is an easy fix and we just need\nto put the following (indicated line) in our code;\n\n    \n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n          d.open = +d.open;         //  <=== Add this line in!\n      });\n    \n\nThe second and potentially more fatal flaw is that nowhere in our code do we\nmake allowance for our second set of data (the second line’s values) exceeding\nour first lines values.\n\nThat might not sound too normal straight away, but consider this. What if when\nwe made up our data earlier, some of the new data exceeded our maximum value\nin our original data? As a means of demonstration, here’s what happens when\nour second line of data has values higher than the first lines;\n\n![Two lines but the domain's not right](images/twolines03.png) Two lines but\nthe domain’s not right\n\nAhh…. We’re not too clever now.\n\nGood news though, we can fix it!\n\nThe problem comes about because when we set the domain for the y axis this is\nwhat we put in the code;\n\n    \n    \n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nSo that only considers `d.close` when establishing the domain. With `d.open`\nexceeding our domain, it just keeps drawing off the graph!\n\nThe good news is that ‘Bill’ has provided a solution for just this problem\n[here](http://stackoverflow.com/questions/12732487/d3-js-dataset-array-w-\nmultiple-y-axis-values);\n\nAll you need to replace the `y.domain` line with is this;\n\n    \n    \n      y.domain([0, d3.max(data, function(d) {\n    \t  return Math.max(d.close, d.open); })]);\n    \n\nIt does much the same thing, but this time it returns the maximum of `d.close`\nand `d.open` (whichever is largest). Good work Bill.\n\nIf we put that code into the graph with the higher values for our second line\nwe are now presented with this;\n\n![Two lines with everything fitting onto the canvas](images/twolines04.png)\nTwo lines with everything fitting onto the canvas\n\nAnd it doesn’t matter which of the two sets of data is largest, the graph will\nalways adjust :-)\n\nYou will also have noticed that our y axis has auto adjusted again to cope.\nClever eh?\n\n### Labelling multiple lines on a graph\n\nOur previous example of a graph with multiple lines is a thing of rare beauty,\nbut which line relates to which set of data? We have data that defines values\nfor `open` and `close`, but we don’t know which line is which.\n\nIn this section we will add labels to our lines so that we know what it what.\n\nThis section was inspired by a question from a reader (Arun b.s) of the\n[d3noob.org](http://www.d3noob.org/2013/01/adding-more-than-one-line-to-graph-\nin.html) blog where the question was asked “How can we put text at the end of\neach line on the graph?”.\n\nThe question was so good I realised that it had to be part of the book, so\nhere you go :-).\n\nIt’s actually not too difficult. What we are trying to achieve is to find the\nposition of the end of each line and to add a text label at that position so\nthat the association of proximity denotes the linkage. Of course we’re going\nto go a little further and colour the text so that it’s really clear which\nlabel belongs with which line, but you get the idea.\n\nEach line requires a single block of script to add the text. The block that\nadds the `open` label is as follows;\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"transform\", \"translate(\"+(width+3)+\",\"+y(data[0].open)+\")\")\n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"start\")\n          .style(\"fill\", \"red\")\n          .text(\"Open\");\n    \n\nSo firstly it appends a textual element to the svg object;\n\n    \n    \n      svg.append(\"text\")\n    \n\nThen it finds the position of the end of the line;\n\n    \n    \n          .attr(\"transform\", \"translate(\"+(width+3)+\",\"+y(data[0].open)+\")\")\n    \n\nTo do this we use the `transform` and `translate` attribute and find the x\nposition that equates to the end of the graph plus 3 pixels (`(width+3)`) (we\nadd in the three pixels to create a small separation between the end of the\nline and the label). The `y` position is far more interesting. We need to find\nthe position of the last point in our line for the `open` data. Because the\ndata is in the form of an indexed array and because the data has the latest\ndate at the start of the array, we only need to find the point at the `0`\nposition of the array. This is `data[0].open`. But of course, we also need to\nadjust our data for our scale and range, so we transform it using the `y`\nfunction (in the same way that we do it for the `valueline` and `valueline2`\npoints. So the script to find the point on the screen in the y direction is\n`y(data[0].open)`.\n\nIf our data was arranged with the last date at the end of our data we would\nhave to find the final index point and we would use\n`y(data[data.length-1].open))`.\n\nThen it’s just a matter of aligning and justifying our text correctly;\n\n    \n    \n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"start\")\n    \n\nThen colouring it the correct colour;\n\n    \n    \n          .style(\"fill\", \"red\")\n    \n\nAnd adding out text;\n\n    \n    \n          .text(\"Open\");\n    \n\nWe put this block of code after the blocks that add in the axes so that they\nmake sure they’re on top of anything else we draw. Of course we will want to\nadd another (almost) duplicate of the block for the ‘close’ column.\n\nThe only other small change we want to make is to change the right margin for\nthe graph that we set at the start of our script from 20 to 40 so that there\nis enough room to add our label without cutting it off.\n\nAfter that you have a marvellously labelled multi-line graph!\n\n![Multi-line graph with labels](images/multiplelabels.png) Multi-line graph\nwith labels\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/9edcd7a67e9ec8c8d24d20f3a47e8879) or\nin the code samples bundled with this book (dual-labels.html and data2.csv). A\nworking example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/9edcd7a67e9ec8c8d24d20f3a47e8879).\n\nNow, I’d like to pretend that this is perfection, but it isn’t. If our lines\nend too close together, the labels will interfere with each other, so in the\nideal world I would include a bit of fanciness to prevent that, but for the\npurposes of this exercise we can consider ourselves happy.\n\n### Multiple axes for a graph\n\nAlrighty… Let’s imagine that we want to show our wonderful graph with two\nlines, much like we already have, but imagine that the data that the lines are\nmade from is significantly different in magnitude from the original data (in\nthe example below, the data for the second line has been reduced by\napproximately a factor of 10 from our original data).\n\n    \n    \n    date,close,open\n    1-May-12,58.13,3.41\n    30-Apr-12,53.98,4.55\n    27-Apr-12,67.00,6.78\n    26-Apr-12,89.70,7.85\n    25-Apr-12,99.00,8.92\n    24-Apr-12,130.28,9.92\n    23-Apr-12,166.70,10.13\n    20-Apr-12,234.98,12.23\n    19-Apr-12,345.44,13.45\n    18-Apr-12,443.34,16.04\n    17-Apr-12,543.70,18.03\n    16-Apr-12,580.13,21.02\n    13-Apr-12,605.23,22.34\n    12-Apr-12,622.77,20.15\n    11-Apr-12,626.20,21.26\n    10-Apr-12,628.44,31.04\n    9-Apr-12,636.23,35.04\n    5-Apr-12,633.68,41.02\n    4-Apr-12,624.31,43.05\n    3-Apr-12,629.32,46.03\n    2-Apr-12,618.63,51.03\n    30-Mar-12,599.55,53.42\n    29-Mar-12,609.86,57.82\n    28-Mar-12,617.62,59.01\n    27-Mar-12,614.48,56.03\n    26-Mar-12,606.98,58.01\n    \n\nNow this isn’t a problem in itself. D3 will still make a reasonable graph of\nthe data, but because of the difference in range, the detail of the second\nline will be lost.\n\n![One line is dominating the other](images/multiaxes01.png) One line is\ndominating the other\n\nWhat I’m proposing is that we have a second y axis on the right hand side of\nthe graph that relates to the red line.\n\nThe mechanism used is based on the great examples put forward by Ben\nChristensen [here](http://benjchristensen.com/2012/05/02/line-graphs-\nusing-d3-js/).\n\nNow… You’ll need to concentrate a bit since there are quite a few different\nbits to change and adapt, but don’t despair, they’re all quite logical and\nmake sense.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/814a2bcb3e7d8d8db74f36f77c8e6b7f) or\nin the code samples bundled with this book (dual-axes.html and data4.csv). A\nworking example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/814a2bcb3e7d8d8db74f36f77c8e6b7f).\n\nFirst things first, there won’t be space on the right hand side of our graph\nto show the extra axis, so we should make our right hand margin a little\nlarger.\n\n    \n    \n    var margin = {top: 20, right: 40, bottom: 30, left: 50},\n    \n\nI went for 40 and it seems to fit pretty well.\n\nThen (and here’s where the main point of difference for this graph comes in)\nyou want to amend the code to separate out the two scales for the two lines in\nthe graph. This is actually a lot easier than it sounds, since it consists\nmainly of finding anywhere that mentions `y` and replacing it with `y0` and\nthen adding in a reciprocal piece of code for `y1`.\n\nThe idea here is that we will be creating two references for the y axis. One\nfor each column of data. Then when we draw the lines the scales will\nautomatically scale the data correctly (and separately) to our svg element and\nwe will draw two different y axes with the different scales. Believe it or\nnot, it sounds a lot harder than it is.\n\nLet’s get started.\n\nIn order to colour the text on the two different y axes we will need to\ndeclare their styles in the `<style>` section at the start of the code. In the\ndeclaration shown below we are calling the two different classes\n‘axisSteelBlue’ and ‘axisRed’. The style that we set for each is ‘fill’ since\nthis is the style that will colour the text\n\n    \n    \n    .axisSteelBlue text{\n      fill: steelblue;\n    }\n    \n    .axisRed text{\n      fill: red;\n    }\n    \n\nThen into the JavaScript and we want to change the variable declaration for\n`y` to `y0` and add in `y1`.\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y0 = d3.scaleLinear().range([height, 0]);\n    var y1 = d3.scaleLinear().range([height, 0]);\n    \n\nNow change our valueline declarations so that they refer to the `y0` and `y1`\nscales.\n\n    \n    \n    // define the 1st line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y0(d.close); });\n    \n    // define the 2nd line\n    var valueline2 = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y1(d.open); });\n    \n\nThere are a few different ways for the scaling to work, but we’ll stick with\nthe fancy max method we used in the dual line example (although technically\nit’s not required).\n\n    \n    \n      y0.domain([0, d3.max(data, function(d) {return Math.max(d.close);})]);\n      y1.domain([0, d3.max(data, function(d) {return Math.max(d.open); })]); \n    \n\nAgain, here’s the `y0` and `y1` changed and added and the maximums for\n`d.close` and `d.open` are separated out).\n\nThe final piece of the puzzle is to draw the new axis, but we also want to\ncolour code the text in the axes to match the lines. We do this using the\nstyling that we declared earlier\n\n    \n    \n      // Add the Y0 Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axisSteelBlue\")\n          .call(d3.axisLeft(y0));\n    \n      // Add the Y1 Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axisRed\")\n          .attr(\"transform\", \"translate( \" + width + \", 0 )\")\n          .call(d3.axisRight(y1));\t\n    \n\nIn the above code you can see where we have added in a ‘style’ change for the\naxisLeft to make it ‘steelblue’ and a complementary change in the new section\nfor axisRight to make that text red.\n\nThe yAxisRight section obviously needs to be added in, but the only\nsignificant difference is the transform / translate attribute that moves the\naxis to the right hand side of the graph.\n\nAnd after all that, here’s the result…\n\n![Two lines with full range of the domain and two\naxes](images/multiaxes02.png) Two lines with full range of the domain and two\naxes\n\nNow, let’s not kid ourselves that it’s a thing of beauty, but we should\nconsole our aesthetic concerns with the warm glow of understanding how the\nfunction works :-).\n\n\n## Elements, Attributes and Styles\n\nThis chapter is intended to provide an overview of some of the simpler things\nthat d3.js can do, but in a way that may help some understand a little more\nabout how images can be added to a web page and how they can be manipulated.\n\nLoosely speaking we will look at how objects (elements (like circles,\nrectangles, lines and even text)) can be declared and added to a page, how\ntheir attributes in relation to the page (position, size, shape, actions) can\nbe changed and how their style (colour, width, transparency) can be applied.\n\nAs we go through the explanation of different changes that can be applied to\ndifferent elements there will be a small amount of repetition where there is\ncross-over with related drawing features. Please be patient :-). The aim is to\nhave each section as complete in its own right as practical.\n\n### The Framework\n\nTo be able to demonstrate how these three related aspects of drawing objects\nwork we will have to use a small, simple script to draw them in your web\nbrowser.\n\nWe will just take a moment to explain the script that draws a circle.\n\nHere’s the contents of the file in its entirety. I have imaginatively called\nit `circle.html` and you can find it in the code samples that can be\ndownloaded with the book.\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n     \n    var holder = d3.select(\"body\") // select the 'body' element\n          .append(\"svg\")           // append an SVG element to the body\n          .attr(\"width\", 449)      // make the SVG element 449 pixels wide\n          .attr(\"height\", 249);    // make the SVG element 249 pixels high\n    \n    // draw a circle\n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n    </script>\n    \n    </body>\n    \n\nPlease feel free to jump ahead slightly if you understand how a HTML file with\nJavaScript goes together :-).\n\nThe HTML part of the file can be thought of as a wrapper for the JavaScript\nthat will draw our circle. These are the HTML parts here…\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n     \n    </script>\n    \n    </body>\n    \n\nThis portion of the file is built using HTML ‘tags’. These will set up the\nenvironment for the JavaScript.\n\nThe tags tell the web browser what sort of language is being used and the type\nof characters used to write the code…\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n\nAreas of the code are labelled.\n\nLike the body…\n\n    \n    \n    <body>\n    \n    In this area we can put the stuff that will be \n    displayed on our web page.\n    \n    </body>\n    \n\nAnd the place where we put the JavaScript…\n\n    \n    \n    <script>\n    \n    Our d3.js code will go here.\n    \n    </script>\n    \n\nWe even load an external file that contains JavaScript that will help run our\ncode.\n\n    \n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n\nYes, that’s the line that loads d3.js. Once it’s loaded we can use the\ninstructions that it makes available to make other JavaScript code (in this\ncase ours) work.\n\nThen we have the JavaScript code that allows us to _use_ the functions made\npossible by d3.js.\n\n    \n    \n    var holder = d3.select(\"body\") // select the 'body' element\n          .append(\"svg\")           // append an SVG element to the body\n          .attr(\"width\", 449)      // make the SVG element 449 pixels wide\n          .attr(\"height\", 249);    // make the SVG element 249 pixels high\n    \n    // draw a circle\n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nI’ve broken the code into two separate blocks to provide some clarity to their\nfunction. We could make it one block, but that wouldn’t necessarily make it\neasier to understand.\n\nFirstly we add a ‘holder’ for our graphics on the web page. I’ve named it\n`holder` but we could just as easily named it anything we wanted.\n\n    \n    \n    var holder = d3.select(\"body\") // select the 'body' element\n          .append(\"svg\")           // append an SVG element to the body\n          .attr(\"width\", 449)      // make the SVG element 449 pixels wide\n          .attr(\"height\", 249);    // make the SVG element 249 pixels high\n    \n\nThe first thing we do when declaring our holder is to select the `body`\nelement of our web page (Remember those `<body>` tags in the HTML part\nearlier?).\n\nThen we append a Scalable Vector Graphic (SVG) object to the body and we make\nit 449 pixels wide and 249 pixels high.\n\nThe `width` and `height` are ‘attributes’ of the SVG object. That is to say\nthey describe a property of the object.\n\nBelieve it or not, I have made the container size unusual (not nice round\nnumbers like 450 x 250) for a good reason. Later I will introduce a grid to\nour diagram so we can see where everything is laid out and this size makes the\ngrid look better.\n\nThe second block of our JavaScript finally draws our circle.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThe first line appends a new element (a circle) to our SVG ‘holder’.\n\nIf you like, you can think of having the `holder` declaration in front of the\n`.append(\"circle\")` as being a nice short-hand way of writing the code. We\ncould have had a much longer line that selected the `body`, appended the svg\nelement and then appended our circle in one line, but it’s actually a far\nbetter scheme for building multiple objects to break the sequences up which\nwill allow us to manipulate groupings of objects in future code.\n\nThe second and third lines declare the attribute of our circle that specify\nwhere the centre of the circle is. In this case it’s at the x/y position\n200/100 (`cx`/`cy`).\n\nThe last line adds the radius attribute `r`. Here it is set to 50 pixels.\n\nThe three attributes `cx`, `cy` and `r` are all required when drawing a\ncircle. There are other attributes we can put in there (and when we look at\nsome of the upcoming elements, you should get a feel for them), but these are\nthe minimum.\n\nThe purpose of describing this block of code that draws a circle isn’t to show\nyou how to draw a circle. This has only been a way of showing you how the code\nin the following sections is laid out and how it works. The elements we are\ngoing to generate can be drawn with exactly the same file but with just the\nsection that adds the circle altered.\n\nFor example if you were to change this block of code;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nFor this block of code;\n\n    \n    \n    holder.append(\"rect\")          // attach a circle\n        .attr(\"x\", 150)            // x position of the top-left corner\n        .attr(\"y\", 50)             // y position of the top-left corner\n        .attr(\"width\", 100)        // set the rectangle width\n        .attr(\"height\", 100);      // set the rectangle height\n    \n\nInstead of drawing a circle we would be drawing a rectangle.\n\nSo this is what our circle will look like;\n\n![Circle](images/EAS-01.png) Circle\n\nBecause it will help a great deal to have a common frame of reference, I’m\ngoing to display the elements on a grid that looks a little like this;\n\n![Circle with Grid](images/EAS-02.png) Circle with Grid\n\nThe grid won’t form part of the code that gets explained, but I will take the\ntime out to describe how it’s generated in another section, because it’s quite\ncool in its own way :-).\n\nWith the grid in place it’s far easier to see that the centre of our circle is\nindeed at the coordinates x = 200, y = 100 and that the radius is 50.\n\nThe circle is still somewhat plain, but bear with me because as we start to\nexplore what we can do with styles and attributes we can add some variation to\nour elements.\n\n![Fancier Circle](images/EAS-03.png) Fancier Circle\n\nWith that explanation behind us we should begin our odyssey into the world of\nd3 elements.\n\n### Elements\n\nWe will begin by describing what we mean when we talk about an ‘element’.\n\nThere is considerable scope for confusion when talking about elements on a web\npage. Are we talking about [HTML\nelements](http://reference.sitepoint.com/html/page-structure), [SVG\nelements](https://developer.mozilla.org/en-US/docs/Web/SVG/Element) or\nsomething different?\n\nIn fact we are going to be describing a subset of SVG elements. Specifically a\ncollection of common shapes and objects which include circles, ellipses,\nrectangles, lines, polylines, polygons, text and paths.\n\n“Text?” I hear you say. “Doesn’t sound like a shape.” I suppose it depends on\nhow you think of it. We can use text in different ways in d3, but for this\nparticular exercise we _can_ regard text as an SVG element.\n\n#### Circle\n\nA [circle is a simple SVG shape](http://www.w3schools.com/svg/svg_circle.asp)\nthat is described by three required attributes.\n\n  * `cx`: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.\n  * `cy`: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.\n  * `r`: The radius of the circle from the `cx`, `cy` position to the perimeter of the circle.\n\nThe following is an example of the code section required to draw a circle in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThis will produce a circle as follows;\n\n![Circle](images/EAS-02.png) Circle\n\nThe centre of the circle is at x = 200 and y = 100 and the radius is 50\npixels.\n\n#### Ellipse\n\nAn [ellipse](http://www.w3schools.com/svg/svg_ellipse.asp) is described by\nfour required attributes;\n\n  * `cx`: The position of the centre of the ellipse in the x direction (left / right) measured from the left side of the screen.\n  * `cy`: The position of the centre of the ellipse in the y direction (up / down) measured from the top of the screen.\n  * `rx`: The radius of the ellipse in the x dimension from the `cx`, `cy` position to the perimeter of the ellipse.\n  * `ry`: The radius of the ellipse in the y dimension from the `cx`, `cy` position to the perimeter of the ellipse.\n\nThe following is an example of the code section required to draw an ellipse in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter;\n\n    \n    \n    holder.append(\"ellipse\")       // attach an ellipse\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"rx\", 100)           // set the x radius\n        .attr(\"ry\", 50);           // set the y radius\n    \n\nThis will produce an ellipse as follows;\n\n![Ellipse](images/EAS-04.png) Ellipse\n\nThe centre of the ellipse is at x = 200 and y = 100 and the radius is 50\npixels vertically and 100 pixels horizontally.\n\n#### Rectangle\n\nA [rectangle](http://www.w3schools.com/svg/svg_rect.asp) is described by four\nrequired attributes and two optional ones;\n\n  * `x`: The position on the x axis of the left hand side of the rectangle (required).\n  * `y`: The position on the y axis of the top of the rectangle (required).\n  * `width`: the width (in pixels) of the rectangle (required).\n  * `height`: the height (in pixels) of the rectangle (required).\n  * `rx`: The radius curve of the corner of the rectangle in the x dimension (optional).\n  * `ry`: The radius curve of the corner of the rectangle in the y dimension (optional).\n\nThe following is an example of the code section required to draw a rectangle\n(using only the required attributes) in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a rectangle as follows;\n\n![Rectangle](images/EAS-05.png) Rectangle\n\nThe top left corner of the rectangle is at 100, 50 and the rectangle is 200\npixels wide and 100 pixels high.\n\nThe following code section includes the optional attributes for the curved\ncorners;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200)     // set the width\n        .attr(\"rx\", 10)         // set the x corner curve radius\n        .attr(\"ry\", 10);        // set the y corner curve radius\n    \n\nThis will produce a rectangle (with curved corners) as follows;\n\n![Rectangle with curved corners](images/EAS-06.png) Rectangle with curved\ncorners\n\nThe corners are curved with radii in the x and y direction of 10 pixels.\n\n#### Line\n\nA [line](http://www.w3schools.com/svg/svg_line.asp) is a simple line between\ntwo points and is described by four required attributes.\n\n  * `x1`: The x position of the first end of the line as measured from the left of the screen.\n  * `y1`: The y position of the first end of the line as measured from the top of the screen.\n  * `x2`: The x position of the second end of the line as measured from the left of the screen.\n  * `y2`: The y position of the second end of the line as measured from the top of the screen.\n\nThe following is an example of the code section required to draw a line in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code is the `style`\ndeclaration. In this case the line has no colour and this can be added with\nthe `stroke` style which applies a colour to a line;\n\n    \n    \n    holder.append(\"line\")          // attach a line\n        .style(\"stroke\", \"black\")  // colour the line\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nThis will produce a line as follows;\n\n![Line](images/EAS-07.png) Line\n\nThe line extends from the point 100,50 to 300,150.\n\n#### Polyline\n\nA [polyline](http://www.w3schools.com/svg/svg_polyline.asp) is a sequence of\nconnected lines described with a single attribute, `points`.\n\n  * `points`: The `points` attribute is a list of x,y coordinates that are the locations of the connecting points of the polyline.\n\nThe following is an example of the code section required to draw a polyline in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code are the `style`\ndeclarations. In this case the line of the polyline has no colour and this can\nbe added with the `stroke` style which applies the colour black to a line.\nLikewise the area that is bounded by the polyline will be automatically filled\nwith black unless we explicitly tell the object not to. This is achieved in\nthis example by addition of the `fill` style to `none`.\n\n    \n    \n    holder.append(\"polyline\")      // attach a polyline\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points\n    \n\nThis will produce a polyline as follows;\n\n![Polyline](images/EAS-08.png) Polyline\n\nThe polyline extends from the point 100,50 to 200,150 to 300,50.\n\n#### Polygon\n\nA [polygon](http://www.w3schools.com/svg/svg_polygon.asp) is a sequence of\nconnected lines which form a closed shape described with a single attribute,\n`points`.\n\n  * `points`: The `points` attribute is a list of x,y coordinates that are the locations of the connecting points of the polygon. The last point is in turn connected to the first point.\n\nThe following is an example of the code section required to draw a polygon in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code are the `style`\ndeclarations. In this case the line of the polygon has no colour and this can\nbe added with the `stroke` style which applies the colour black to a line.\nLikewise the area that is bounded by the polygon will be automatically filled\nwith black unless we explicitly tell the object not to. This is achieved in\nthis example by addition of the `fill` style to `none`.\n\n    \n    \n    holder.append(\"polygon\")       // attach a polygon\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points \n    \n\nThis will produce a polygon as follows;\n\n![Polyline](images/EAS-09.png) Polyline\n\nThe polygon extends from the point 100,50 to 200,150 to 300,50 and then back\nto 100,50.\n\n#### Path\n\nA [path](http://www.w3schools.com/svg/svg_path.asp) is an outline of an SVG\nshape which is described with a ‘mini-language’ inside a single attribute.\n\n  * `d`: This attribute is a list of instructions that allow a shape to be drawn in a complex way using a [‘mini-language’ of commands](http://www.w3.org/TR/SVG/paths.html#PathData). These commands are written in a shorthand of single letters such as `M`-moveto, `Z`-closepath, `L`-lineto, `C`-curveto. These commands can be absolute (normally designated by capital letters) or relative (lower case).\n\nThe following is an example of the code section required to draw a triangle in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code are the `style`\ndeclarations. In this case the line of the path has no colour and this can be\nadded with the `stroke` style which applies the colour black to a line.\nLikewise the area that is bounded by the path will be automatically filled\nwith black unless we explicitly tell the object not to. This is achieved in\nthis example by addition of the `fill` style to `none`.\n\n    \n    \n    holder.append(\"path\")          // attach a path\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"d\", \"M 100,50, L 200,150, L 300,50 Z\");  // path commands \n    \n\nThis will produce a path as follows;\n\n![Path](images/EAS-10.png) Path\n\nThe path mini-language first moves (`M`) to 100,50 then draws a line (`L`) to\n200,150 then draws another line (`L`) to 300,50 then closes the path (`Z`).\n\n#### Clipped Path (AKA clipPath)\n\nA [clipPath](https://developer.mozilla.org/en-\nUS/docs/Web/SVG/Element/clipPath) is the path of a SVG shape that can be used\nin combination with another shape to remove any parts of the combined shape\nthat doesn’t fall within the clipPath. That sounds slightly confusing, so we\nwill break it down a bit to hopefully clarify the explanation.\n\nLet’s imagine that we want to display the intersection of two shapes. What we\nwill do is define our `clipPath` which will act as a ‘cookie cutter’ which can\ncut out the shape we want (we will choose an ellipse). Then we will draw our\nbase shape (which is analogous to the dough) that we will use our cookie\ncutter on (our dough will be shaped as a rectangle). The intersection of the\ncookie cutter and the dough is our clipped path.\n\nOur clipPath (cookie cutter) element is an ellipse;\n\n![clipPath \\(cookie cutter\\)](images/EAS-44.png) clipPath (cookie cutter)\n\nOur shape that we will be clipping (the dough) is a rectangle;\n\n![Rectangle element \\(dough\\)](images/EAS-45.png) Rectangle element (dough)\n\nThe intersection of the two is the clipped path (shaded grey);\n\n![Combination of the ellipse and the rectangle](images/EAS-46.png) Combination\nof the ellipse and the rectangle\n\nThe graphic examples above are misleading in the sense that the two basic\nshapes are not actually displayed. All that results from the use of the\n`clipPath` is the region that is the intersection of the two.\n\n![The clipped path](images/EAS-47.png) The clipped path\n\nThe following is an example of the code section required to draw the clipped\npath in conjunction with [the HTML file](chap06.xhtml#EASframework) outlined\nat the start of this chapter. The `clipPath` element is given the `ID`\n‘ellipse-clip’ and a specified size and location. Then when the rectangle is\nappended. the `clipPath` is specified as an attribute (via a URL) using `clip-\npath`.\n\n    \n    \n    // define the clipPath\n    holder.append(\"clipPath\")       // define a clip path\n    \t.attr(\"id\", \"ellipse-clip\") // give the clipPath an ID\n      .append(\"ellipse\")            // shape it as an ellipse\n    \t.attr(\"cx\", 175)            // position the x-centre\n    \t.attr(\"cy\", 100)            // position the y-centre\n    \t.attr(\"rx\", 100)            // set the x radius\n    \t.attr(\"ry\", 50);            // set the y radius\n    \n    // draw clipped path on the screen\n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 125)         // position the left of the rectangle\n        .attr(\"y\", 75)          // position the top of the rectangle\n        .attr(\"clip-path\", \"url(#ellipse-clip)\") // clip the rectangle\n        .style(\"fill\", \"lightgrey\")   // fill the clipped path with grey\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a path as follows;\n\n![The clipped path](images/EAS-47.png) The clipped path\n\nAn example of this in use can bee seen in the difference chart explanation\nlater in the book.\n\n#### Text\n\nA [text](http://www.w3schools.com/svg/svg_text.asp) element is an SVG object\nwhich is shaped as text. It is described by two required attributes and three\noptional ones.\n\n  * `x`: This attribute designates the anchor point location for the text in the x dimension (required).\n  * `y`: This attribute designates the anchor point location for the text in the y dimension (required).\n  * `dx`: This attribute designates the offset of the text from the anchor point in the x dimension (optional). There are several different sets of units that can be used to designated the offset of the text from an anchor point. These include `em` which is a scalable unit (used in these examples), `px` (pixels), `pt` (points (kind of like pixels)) and `5` (percent (scalable and kind of like `em`)) \n  * `dy`: This attribute designates the offset of the text from the anchor point in the y dimension (optional).\n  * `text-anchor`: This attribute controls the horizontal text alignment (optional). It has three values; `start` (left aligned), `middle` (centre aligned) and `end` (right aligned).\n\nThe following is an example of the code section required to draw the text\n“Hello World” in conjunction with [the HTML file](chap06.xhtml#EASframework)\noutlined at the start of this chapter. A notable addition to this code is the\n`style` declaration which applies a `black` `fill` to the text. Additionally\nthere is the declaration `.text` which defines the text that will be\ndisplayed.\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text \n        .text(\"Hello World\");     // define the text to display \n    \n\nThis will produce text as follows;\n\n![Text](images/EAS-11.png) Text\n\nIt can be seen from the image that the anchor point for the text is at 200,100\nand that the text is positioned with this anchor point at the bottom, left of\nthe text.\n\nThe following examples will demonstrate the various options for positioning\nand aligning text so that you can arrange it correctly.\n\n##### Anchor at the bottom, middle of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Bottom-middle](images/EAS-12.png) Text: Anchored Bottom-\nmiddle\n\n##### Anchor at the bottom, right of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"end\")  // set anchor y justification \n        .text(\"Hello World\");        // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Bottom-Right](images/EAS-13.png) Text: Anchored Bottom-Right\n\n##### Anchor at the middle, left of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"start\")  // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Left](images/EAS-15.png) Text: Anchored Middle-Left\n\n##### Anchor in the middle, centre of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Centre](images/EAS-14.png) Text: Anchored Middle-\nCentre\n\n##### Anchor in the middle, right of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")         // set offset y position\n        .attr(\"text-anchor\", \"end\")  // set anchor y justification \n        .text(\"Hello World\");        // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Right](images/EAS-16.png) Text: Anchored Middle-Right\n\n##### Anchor at the top, left of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".71em\")           // set offset y position\n        .attr(\"text-anchor\", \"start\")  // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Top-Left](images/EAS-17.png) Text: Anchored Top-Left\n\n##### Anchor at the top, middle of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".71em\")            // set offset y position\n        .attr(\"text-anchor\", \"middle\")  // set anchor y justification \n        .text(\"Hello World\");           // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Top-Middle](images/EAS-18.png) Text: Anchored Top-Middle\n\n##### Anchor at the top, right of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".71em\")          // set offset y position\n        .attr(\"text-anchor\", \"end\")   // set anchor y justification \n        .text(\"Hello World\");         // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Top-Right](images/EAS-19.png) Text: Anchored Top-Right\n\n### Attributes\n\nAt the start of writing this section I was faced with the question “What’s an\nattribute?”. But a reasonable answer has eluded me, so I will make the\nassumption that the answer will be something of a compromise :-). I like to\nthink that an attribute of an element is something that is a characteristic of\nthe object without defining it, and/or it may affect the object’s position or\norientation on the page. There could be a strong argument to say that the\nfollowing section on styles could be seen to cross-over into attributes and I\nagree. However, for the purposes of providing a description of the syntax and\neffects, I’m happy with the following list :-).\n\nBecause not all attributes are applicable to all elements, there will be a bit\nof variation in the type of shapes we deal with in the description below, but\nthere won’t be any that are different to those that we’ve already looked at.\nThere will be some repetition with recurring information from the elements\nsection. This is intentional to hopefully allow each section to exist in its\nown right.\n\n####  `x`, `y`\n\nThe `x` and `y` attributes are used to designate a position on the web page\nthat is set from the top, left hand corner of the web page. Using the `x` and\n`y` attributes places the anchor points for these elements at a specified\nlocation. Of the elements that we have examined thus far, the rectangle\nelement and the text element have anchor points to allow them to be\npositioned.\n\nFor example the following is a code section required to draw a rectangle\n(using only the required attributes) in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a rectangle as follows;\n\n![Rectangle with `x`,`y` at 100,50](images/EAS-05.png) Rectangle with `x`,`y`\nat 100,50\n\nThe top left corner of the rectangle is specified using `x` and `y` at 100 and\n50 respectively.\n\n####  `x1`, `x2`, `y1`, `y2`\n\nThe `x1`, `x2`, `y1` and `y2` attributes are used to designate the position of\ntwo points on a web page that are set from the top, left hand corner of the\nweb page. These two points are connected with a line as part of the `line`\nelement.\n\nThe attributes are described as follows;\n\n  * `x1`: The x position of the first end of the line as measured from the left of the screen.\n  * `y1`: The y position of the first end of the line as measured from the top of the screen.\n  * `x2`: The x position of the second end of the line as measured from the left of the screen.\n  * `y2`: The y position of the second end of the line as measured from the top of the screen.\n\nThe following is an example of the code section required to draw a line in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. The attributes connect the point 100,50 (`x1`, `y1`)\nwith 300,150 (`x2`, `y2`);\n\n    \n    \n    holder.append(\"line\")          // attach a line\n        .style(\"stroke\", \"black\")  // colour the line\n        .attr(\"x1\", 100)     // x1 position of the first end of the line\n        .attr(\"y1\", 50)      // y1 position of the first end of the line\n        .attr(\"x2\", 300)     // x2 position of the second end of the line\n        .attr(\"y2\", 150);    // y2 position of the second end of the line\n    \n\nThis will produce a line as follows;\n\n![Line](images/EAS-07.png) Line\n\nThe line extends from the point 100,50 to 300,150.\n\n#### points\n\nThe `points` attribute is used to set a series of points which are\nsubsequently connected with a line and / or which may form the bounds of a\nshape. These are specifically associated with the `polyline` and `polygon`\nelements. Like the `x`, `y` and `x1`, `x2`, `y1`, `y2` attributes, the\ncoordinates are set from the top, left hand corner of the web page.\n\nThe data for the points is entered as a sequence of x,y points in the\nfollowing format;\n\n    \n    \n        .attr(\"points\", \"100,50, 200,150, 300,50\"); \n    \n\nWhere 100,50 is the first x,y point then 200,150 is the second.\n\nThe following is an example of the code section required to draw a polyline in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. The additional `style` declarations are included to\nillustrate the shape better. The `points` values can be compared with the\nsubsequent image.\n\n    \n    \n    holder.append(\"polyline\")      // attach a polyline\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points\n    \n\nThis will produce a polyline as follows;\n\n![Polyline using `points` attribute](images/EAS-08.png) Polyline using\n`points` attribute\n\nThe polyline extends from the point 100,50 to 200,150 to 300,50.\n\n####  `cx`, `cy`\n\nThe `cx`, `cy` attributes are associated with the circle and ellipse elements\nand designate the centre of each shape. The coordinates are set from the top,\nleft hand corner of the web page.\n\n  * `cx`: The position of the centre of the element in the x axis measured from the left side of the screen.\n  * `cy`: The position of the centre of the element in the y axis measured from the top of the screen.\n\nThe following is an example of the code section required to draw an ellipse in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. In it the centre of the ellipse is set by `cx`, `cy` as\n200, 100.\n\n    \n    \n    holder.append(\"ellipse\")       // attach an ellipse\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"rx\", 100)           // set the x radius\n        .attr(\"ry\", 50);           // set the y radius\n    \n\nThis will produce an ellipse as follows;\n\n![Ellipse with Centre at 200, 100](images/EAS-04.png) Ellipse with Centre at\n200, 100\n\nThe centre of the ellipse is at x = 200 and y = 100 and the radius is 50\npixels vertically and 100 pixels horizontally.\n\n####  `r`\n\nThe `r` attribute determines the radius of a circle element from the `cx`,\n`cy` position (the centre of the circle) to the perimeter of the circle.\n\nThe following is an example of the code section required to draw a circle in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThis will produce a circle with a radius of 50 pixels as follows;\n\n![Circle with Radius of 50 Pixels](images/EAS-02.png) Circle with Radius of 50\nPixels\n\nThe centre of the circle is at x = 200 and y = 100 and the radius is 50\npixels.\n\n####  `rx`, `ry`\n\nThe `rx`, `ry` attributes are associated with the ellipse element and\ndesignate the radius in the x direction (`rx`) and the radius in the y\ndirection (`ry`).\n\n  * `rx`: The radius of the ellipse in the x direction from the `cx`, `cy` position to the perimeter of the ellipse.\n  * `ry`: The radius of the ellipse in the y direction from the `cx`, `cy` position to the perimeter of the ellipse.\n\nThe following is an example of the code section required to draw an ellipse in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. In it, the centre of the ellipse is set by `cx`, `cy`\nas 200, 100 and the radius in the x direction (`rx`) is 100 pixels and the\nradius in the y direction (`ry`) is 50 pixels.\n\n    \n    \n    holder.append(\"ellipse\")       // attach an ellipse\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"rx\", 100)           // set the x radius\n        .attr(\"ry\", 50);           // set the y radius\n    \n\nThis will produce an ellipse as follows;\n\n![Ellipse with x Radius of 100 and y Radius of 50](images/EAS-04.png) Ellipse\nwith x Radius of 100 and y Radius of 50\n\nThe centre of the ellipse is at x = 200 and y = 100 and the radius is 50\npixels vertically and 100 pixels horizontally.\n\n####  `transform (translate(x,y), scale(k), rotate(a))`\n\nThe transform attribute is a powerful one which allows us to change the\nproperties of an element in several different ways.\n\n  * `translate`: Where the element is moved by a relative value in the x,y direction. \n  * `scale`: Where the element’s attributes are increased or reduced by a specified factor.\n  * `rotate`: Where the element is rotated about its reference point by an angular value.\n\nWithout a degree of prior understanding, these transforms can appear to behave\nin unusual ways, but hopefully we’ll explain it sufficiently here so that you\ncan appreciate the logic in the way they work.\n\n#####  `transform (translate(x,y))`\n\nThe transform-translate attribute will take an element’s position and adjust\nit based on a specified value(s) in the x,y directions.\n\nThe best way to illustrate this is with an example;\n\nThis is the code snippet from [the HTML file](chap06.xhtml#EASframework)\noutlined at the start of this chapter which draws a circle at the position\n200,100 (`cx`,`cy`);\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThis will produce a circle as follows;\n\n![Circle](images/EAS-02.png) Circle\n\nIf we add in a `transform (translate(*x*,*y*))` attribute for values of x,y of\n50,50 this will shift our circle by an additional 50 pixels in the x direction\nand 50 pixels in the y direction.\n\nHere’s the code snippet that will draw our new circle;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"transform\", \"translate(50,50)\") // translate the circle\n        .attr(\"r\", 50);            // set the radius\n    \n\nAnd here’s the resulting change;\n\n![Circle](images/EAS-20.png) Circle\n\nThe circle was positioned at the point 200,100 and then translated by 50\npixels in both axes to 250,150.\n\nThe original code snippet could in fact be written as follows;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"transform\", \"translate(200,100)\") // translate the circle\n        .attr(\"r\", 50);            // set the radius\n    \n\nSince by default our starting position is 0,0 if we apply a translation of\n200,100 we will end up at 200,100.\n\n#####  `transform (scale(k))`\n\nThe translate-scale attribute will take an element’s attributes and scale them\nby a factor _k_.\n\nOriginally I thought that this attribute would affect the size of the element,\nbut it affects more than that! As with the transform-translate attribute, the\nbest way to illustrate this is with an example;\n\nThe following code snippet (in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) which\ndraws a circle at the position 150,50 with a radius of 25 pixels;\n\n    \n    \n    holder.append(\"circle\")     // attach a circle\n        .attr(\"cx\", 150)        // position the x-centre\n        .attr(\"cy\", 50)         // position the y-centre\n        .attr(\"r\", 25);         // set the radius\n    \n\nThis will produce a circle as follows;\n\n![Circle](images/EAS-21.png) Circle\n\nIf we now introduce a transform-scale attribute with a scale of 2 we will see\nall three of the other attributes (`cx`, `cy` and `r`) scaled by a factor of\ntwo to 300, 100 and 50 respectively.\n\nHere is the code;\n\n    \n    \n    holder.append(\"circle\")             // attach a circle\n        .attr(\"cx\", 150)                // position the x-centre\n        .attr(\"cy\", 50)                 // position the y-centre\n        .attr(\"r\", 25)                  // set the radius\n        .attr(\"transform\", \"scale(2)\"); // scale the circle attributes\n    \n\nWhich will produce a circle as follows;\n\n![Circle](images/EAS-22.png) Circle\n\nIn this example we can see that the position (`cx`, `cy`) and the radius (`r`)\nhave been scaled up by a factor of 2.\n\n#####  `transform (rotate(a))`\n\nThe translate-rotate attribute will rotate an element and its attributes by a\ndeclared angle in degrees.\n\nThe ability to rotate elements is obviously a valuable tool. The transform-\nrotate attribute does a great job of it, but the key to making sure that you\nknow exactly what will happen to an object is to remember where the anchor\npoint is for the object and to ensure that the associated attributes are set\nappropriately. As with the transform translate & scale attributes, the best\nway to illustrate this is with an example;\n\nThe following is the code snippet (in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) which\ndraws the text “Hello World” at the position 200,100 with the anchor point\nbeing the the middle of the text;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Centre](images/EAS-14.png) Text: Anchored Middle-\nCentre\n\nIf we then apply a transform-rotate of 10 degrees as follows;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .attr(\"transform\", \"rotate(10)\")\n        .text(\"Hello World\");          // define the text to display\n    \n\nWe will see the following on the screen;\n\n![Text: Anchored Middle-Centre](images/EAS-23.png) Text: Anchored Middle-\nCentre\n\nObviously the text has been rotated, but hopefully you’ll have noticed that\nit’s also been displaced. This is because the transform-rotate attribute has\nbeen applied to both the text element (which _has_ been rotated by 10 degrees)\n_and_ the `x`,`y` attributes. If you imagine the origin point for the element\nbeing at 0,0, the centre, middle of the text element has been rotated about\nthe point 0,0 by 10 degrees (hopefully slightly better explained in the\nfollowing picture).\n\n![Text: All positioning Attributes Rotated](images/EAS-24.png) Text: All\npositioning Attributes Rotated\n\nThis could be seen as an impediment to getting things to move / change as you\nwant to, but instead it’s an indication of a different way of doing things.\nThe solution to this particular feature is to combine the transform-rotate\nwith the transform-translate that we used earlier so that the code looks like\nthis;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .attr(\"transform\", \"translate(200,100) rotate(10)\")\n        .text(\"Hello World\");          // define the text to display\n    \n\nAnd the image on the page looks like this;\n\n![Text: Rotated by 10 Degrees Anchored Middle-Centre](images/EAS-25.png) Text:\nRotated by 10 Degrees Anchored Middle-Centre\n\nWhich leads us to the final example which is a combination of all three\naspects of the transform attribute.\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .attr(\"transform\", \"translate(200,100) scale(2) rotate(10)\")\n        .text(\"Hello World\");          // define the text to display\n    \n\n![Text: Translated, Scaled and Rotated](images/EAS-26.png) Text: Translated,\nScaled and Rotated\n\nHere we have a text element translated to its position on the page, rotated by\n10 degrees about the centre of the text and scaled by a factor of two.\n\n####  `width`, `height`\n\n`width` and `height` are required attributes of the rectangle element. `width`\ndesignates the width of the rectangle and `height` designates the height (If\nyou’re wondering, I often struggle defining the obvious).\n\nThe following is an example of the code section required to draw a rectangle\n(using only the required attributes) in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a rectangle as follows;\n\n![Rectangle](images/EAS-05.png) Rectangle\n\nThe width of the triangle is 200 pixels and the height is 100 pixels.\n\n####  `text-anchor`\n\nThe `text-anchor` attribute determines the justification of a text element\n\nText can have one of three `text-anchor` types;\n\n  * `start` where the text is left justified.\n  * `middle` where the text is centre justified.\n  * `end` where the text is right justified.\n\nThe following is an example of code that will draw three separate lines of\ntext with the three different `text-anchor` types in conjunction with [the\nHTML file](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 50)            // set y position of bottom of text\n        .attr(\"text-anchor\", \"start\") // set anchor y justification\n        .text(\"Hello World - start\"); // define the text to display\n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .text(\"Hello World - middle\"); // define the text to display\n        \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 150)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"end\") // set anchor y justification\n        .text(\"Hello World - end\"); // define the text to display\n    \n\nThis will produce an output as follows;\n\n![Text with Different `text-anchor` Attributes](images/EAS-27.png) Text with\nDifferent `text-anchor` Attributes\n\n####  `dx`, `dy`\n\n`dx` and `dy` are optional attributes that designate an offset of text\nelements from the anchor point in the x and y dimension . There are several\ndifferent sets of units that can be used to designate the offset of the text\nfrom an anchor point. These include `em` which is a scalable unit, `px`\n(pixels), `pt` (points (kind of like pixels)) and `%` (percent (scalable and\nkind of like `em`))\n\nWe can demonstrate the offset effect by noting the difference in two examples.\n\nThe first is a simple projection of SVG text that aligns the text “Hello\nWorld” above and to the right of the anchor point at 200,100 (It does this in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter.).\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text \n        .text(\"Hello World\");     // define the text to display \n    \n\nWhich produces the following on the page;\n\n![Text with the Anchor at the Bottom Left Corner](images/EAS-11.png) Text with\nthe Anchor at the Bottom Left Corner\n\nThe second example introduces the `dx` attribute setting the offset to 50\npixels. This adds another 50 pixels to the x dimension. We also introduce the\n`dy` attribute with an offset of `.35em`. This scalable unit allows the text\nto be set as a factor of the size of the text. In this case `.35em` will add\nhalf the height of the text to the y dimension placing the text so that it is\nexactly in the middle (vertically) of the 100 pixel line on the y dimension.\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text \n        .attr(\"dx\", \"50px\")       // set offset x position\n        .attr(\"dy\", \".35em\")      // set offset y position\n        .text(\"Hello World\");     // define the text to display \n    \n\nWhich produces the following on the page;\n\n![Text with 50 Pixel x Offset and Half Height y Offset](images/EAS-28.png)\nText with 50 Pixel x Offset and Half Height y Offset\n\nThe text has been moved 50 pixels to the right and half the height of the text\ndown the page.\n\n####  `textLength`\n\nThe `textLength` attribute adjusts the length of the text to fit a specified\nvalue.\n\nThe following is a code snippet that prints the text “Hello World” above and\nto the right of the anchor point at 200,100 (It does this in conjunction with\n[the HTML file](chap06.xhtml#EASframework) outlined at the start of this\nchapter.). The addition of the `textLength` attribute declaration in the code\nstretches the “Hello World” out so that it fills 150 pixels.\n\n    \n    \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 100)            // set y position of bottom of text \n        .attr(\"textLength\", \"150\") // set text length\n        .text(\"Hello World\");      // define the text to display \n    \n\nWhich produces the following on the page;\n\n![Text Stretched to 150 Pixels Wide](images/EAS-29.png) Text Stretched to 150\nPixels Wide\n\nIt is worth noting that while the text has been spread out, the individual\nletters remain un-stretched. Only the letter and word spacing has been\nadjusted. However, using the `lengthAdjust` attribute can change this.\n\n####  `lengthAdjust`\n\nThe `lengthAdjust` attribute allows the `textLength` attribute to have the\nspacing of a text element controlled to be either `spacing` or\n`spacingAndGlyphs`;\n\n  * `spacing`: In this option the letters remain the same size, but the spacing between the letters and words are adjusted.\n  * `spacingAndGlyphs`: In this option the text is stretched or squeezed to fit.\n\nThe attribute can be best illustrated via an example. The following code\nsnippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) shows\nthree versions of the text element. The top line is the standard text. The\nmiddle line is the `textLength` set to 150 and the `lengthAdjust` set to\n`spacing` (which is the default). The bottom line is the `textLength` set to\n150 and the `lengthAdjust` set to `spacingAndGlyphs`.\n\n    \n    \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 50)             // set y position of bottom of text \n        .text(\"Hello World\");      // define the text to display \n        \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 100)            // set y position of bottom of text \n        .attr(\"textLength\", \"150\") // set text length\n        .attr(\"lengthAdjust\", \"spacing\")\n        .text(\"Hello World\");      // define the text to display \n    \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 150)            // set y position of bottom of text \n        .attr(\"textLength\", \"150\") // set text length\n        .attr(\"lengthAdjust\", \"spacingAndGlyphs\")\n        .text(\"Hello World\");      // define the text to display \n    \n\nThe image on the screen will look like the following;\n\n![Text Stretched in Three Ways](images/EAS-30.png) Text Stretched in Three\nWays\n\nThe image shows that the top line looks normal, the middle line has had the\nspaces increased to increase the length of the text and the bottom line has\nbeen stretched.\n\n### Styles\n\nWhat’s a style?\n\nBelieve it or not, that’s as difficult a question to answer as “What’s an\nattribute?”. I like to think that an element can be selected and arranged on a\nweb page with `select` and `attr`, but once it’s there, changes to how it\nlooks are a matter for `style`. We will cover a range of qualities that neatly\nfit into this definition in the following section (such as fill, opacity and\nstroke-width) but there are also a range of unusual style declarations that\nmany may not have come across (I certainly hadn’t before writing this).\n\nThe other important thing to mention about setting styles for elements is that\nthere are different ways to accomplish the task. We’ll go through the process\nof describing different styles as they can be applied to individual elements\nin isolation, but there is a more powerful way to manage styles across a range\nof elements via Cascading Style Sheets (CSS) in the `<style>` section of a web\npage or even via an external style sheet. We will examine these possibilities\nat the end of the section.\n\nFull disclosure: I have not figured out how to work some of the styles for\nd3.js I’m afraid that `clip-path` and `mask` have exceeded my skill-set and I\nwill have to leave them for another day :-(. I found that there are several\ngood examples that make use of these styles, but I have struggled\n(unsuccessfully) to present them in a simple example.\n\n####  `fill`\n\nThe `fill` style will fill the element being presented with a specified\ncolour.\n\nBy default, most elements will be filled with black (the majority of the\nexamples used in this chapter make no `fill` declaration).\n\nThe following example (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) shows\nthe syntax for filling a simple circle with the colour red;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"fill\", \"red\");     // set the fill colour \n    \n\nWhich results in the following image;\n\n![Circle with Red Fill](images/EAS-31.png) Circle with Red Fill\n\nAs we saw with the `polyline` and `polygon` examples earlier in the chapter\nsome shapes may need to have their `fill` colour turned off in some\ncircumstances and this can be accomplished by declaring the colour to be\n`none` (`.style(\"fill\", \"none\");`).\n\nThere are several different ways to define exactly what colour we want as a\nfill. The example above uses a ‘named colour code’ to declare the colour as\n“red” but we could also have defined it as rgb (`.style(\"fill\",\n\"rgb(255,0,0)\");`) or in hexadecimal (`.style(\"fill\", \"#f00\");`)\n\n####  `stroke`\n\nThe `stroke` style applies a colour to lines.\n\nBy default many elements do not have a stroke colour set, so it’s a matter of\ndeclaring the colour with either a named colour code (“red”), an rgb value\n(“rgb(255,0,0)”) or the appropriate hex (“#f00”).\n\nThe following example (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) shows\nthe syntax for applying the colour red to a simple circle. The fill has been\nset to `none` to help the colour stand out.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"stroke\", \"red\")    // set the line colour\n        .style(\"fill\", \"none\");    // set the fill colour \n    \n\nWhich results in the following image;\n\n![Circle with Red Border](images/EAS-32.png) Circle with Red Border\n\n####  `opacity`\n\nThe `opacity` style has the effect of varying an element’s transparency.\n\nThe valid range for `opacity` is from 0 (completely transparent) to 1 (solid\ncolour). We should make the distinction at this point that `opacity` affects\nthe entire element, whereas the following `fill-opacity` and `stroke-opacity`\naffect only the fill and stroke respectively.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a green circle with a red border. The opacity value of .2 creates a\ndegree of transparency which will show the grid lines underneath the element.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"opacity\", .2)      // set the element opacity\n        .style(\"stroke\", \"red\")    // set the line colour\n        .style(\"fill\", \"green\");   // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with opacity](images/EAS-33.png) Circle with opacity\n\n####  `fill-opacity`\n\nThe `fill-opacity` style changes the transparency of the fill of an element.\n\nThe valid range for `fill-opacity` is from 0 (completely transparent) to 1\n(solid colour). We should make the distinction at this point that `fill-\nopacity` affects only the fill of an element, whereas `opacity` will affect\nthe entire element.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a green circle with a red border. The opacity value of .2 creates a\ndegree of transparency for the fill which will show the grid lines underneath.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"fill-opacity\", .2) // set the fill opacity\n        .style(\"stroke\", \"red\")    // set the line colour\n        .style(\"fill\", \"green\");   // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Semi-Transparent Fill](images/EAS-34.png) Circle with Semi-\nTransparent Fill\n\nThe distinction between this image and the one for the `opacity` style clearly\nshows the line around the outside of the object as still a solid (opaque)\ncolour.\n\n####  `stroke-opacity`\n\nThe `stroke-opacity` style changes the transparency of the stroke (line) of an\nelement.\n\nThe valid range for `stroke-opacity` is from 0 (completely transparent) to 1\n(solid colour). We should make the distinction at this point that `stroke-\nopacity` affects only the line or border of an element, whereas `opacity` will\naffect the entire element.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates an empty circle with a red border. The opacity value of .2 creates a\ndegree of transparency for the stroke which will show the grid lines\nunderneath (or at least make it appear more ‘muted’).\n\n    \n    \n    holder.append(\"circle\")          // attach a circle\n        .attr(\"cx\", 200)             // position the x-centre\n        .attr(\"cy\", 100)             // position the y-centre\n        .attr(\"r\", 50)               // set the radius\n        .style(\"stroke-opacity\", .2) // set the stroke opacity\n        .style(\"stroke\", \"red\")      // set the line colour\n        .style(\"fill\", \"none\");      // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Red Border and opacity](images/EAS-35.png) Circle with Red\nBorder and opacity\n\nAlthough it is not necessarily easy to see in this example because the line is\nquite thin, the lines of the grid behind the circle will be showing through\nthe line of the circle.\n\n####  `stroke-width`\n\nThe `stroke-width` style adjusts the width of the line of an element.\n\nThe value specified when setting `stroke-width` is in pixels.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates an empty circle with a red border. The `stroke-width` is set to 5\nwhich equates to 5 pixels (it can also be specified as “5px”).\n\n    \n    \n    holder.append(\"circle\")          // attach a circle\n        .attr(\"cx\", 200)             // position the x-centre\n        .attr(\"cy\", 100)             // position the y-centre\n        .attr(\"r\", 50)               // set the radius\n        .style(\"stroke-width\", 5)    // set the stroke width\n        .style(\"stroke\", \"red\")      // set the line colour\n        .style(\"fill\", \"none\");      // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Thicker Red Border](images/EAS-36.png) Circle with Thicker Red\nBorder\n\nThe width of the line that forms the border of the circle is now 5 pixels wide\n:-).\n\n####  `stroke-dasharray`\n\nThe `stroke-dasharray` style allows us to form element lines with dashes\ninstead of solid lines.\n\nWe have covered dashed lines in practical way in a previous section of the\nbook (‘Make a Dashed Line’) but for the sake of completeness I will include\ndashed lines here as well.\n\nWe create a dashed line by specifying the length of a dash and then the length\nof a space. We can include a long list of dashes and spaces and once complete\nour line will simply repeat the pattern we have specified.\n\nFor example the following code snippet (which works in conjunction with [the\nHTML file](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a line with a dash of 10 pixels followed by a space of 3 pixels;\n\n    \n    \n    holder.append(\"circle\")       // attach a circle\n        .attr(\"cx\", 200)          // position the x-centre\n        .attr(\"cy\", 100)          // position the y-centre\n        .attr(\"r\", 50)            // set the radius\n        .style(\"stroke-dasharray\", (\"10,3\")) // make the stroke dashed\n        .style(\"stroke\", \"red\")   // set the line colour\n        .style(\"fill\", \"none\");   // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Dashed Red Border](images/EAS-37.png) Circle with Dashed Red\nBorder\n\nMore complex combinations of dashes and spaces are possible as are complex\nanimation sequences that leverage the ability to move objects along a path\n(these are certainly more advanced examples).\n\n####  `stroke-linecap`\n\nThe `stroke-linecap` style allows control of the shape of the ends of lines in\nd3.js.\n\nThere are three shape options;\n\n  * `butt` where the line simply butts up to the starting or ending position and is cut off squarely.\n  * `round` where the line is rounded in proportion to its width.\n  * `square` where the line is squared off but extended in proportion to its width.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ngenerates three lines showing each `stroke-linecap` style option. The top line\nuses `butt`. The middle line uses `round` and the bottom line uses `square`.\n\n    \n    \n    holder.append(\"line\")                 // attach a line\n        .style(\"stroke\", \"black\")         // colour the line\n        .style(\"stroke-width\", 20)        // adjust line width\n        .style(\"stroke-linecap\", \"butt\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 50);     // y position of the second end of the line\n    \n    holder.append(\"line\")                  // attach a line\n        .style(\"stroke\", \"black\")          // colour the line\n        .style(\"stroke-width\", 20)         // adjust line width\n        .style(\"stroke-linecap\", \"round\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 100)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 100);    // y position of the second end of the line\n    \n    holder.append(\"line\")                   // attach a line\n        .style(\"stroke\", \"black\")           // colour the line\n        .style(\"stroke-width\", 20)          // adjust line width\n        .style(\"stroke-linecap\", \"square\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 150)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nWhich results in the following image;\n\n![Three Lines with Different End Shapes](images/EAS-38.png) Three Lines with\nDifferent End Shapes\n\nThe shapes are quite distinct for each type and it is useful to note the\ndegree to which the lines extend beyond their start and end points.\n\n####  `stroke-linejoin`\n\nThe `stroke-linejoin` style specifies the shape of the join of two lines. This\nwould be used on `path`, `polyline` and `polygon` elements (and possibly\nmore).\n\nThere are three line join options;\n\n  * `miter` where the join is squared off as would be expected at the join of two lines. \n  * `round` where the outside portion of the join is rounded in proportion to its width.\n  * `bevel` where the join has a straight edged outer portion clipped off to provide a slightly more contoured effect while still being angular.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ngenerates a poly line where the join has the connection shaped using the\n`stroke-linejoin` `round` style.\n\n    \n    \n    holder.append(\"polyline\")       // attach a polyline\n        .style(\"stroke\", \"black\")   // colour the line\n        .style(\"fill\", \"none\")      // remove any fill colour\n    \t.style(\"stroke-width\", 20)  // colour the line\n    \t.style(\"stroke-linejoin\", \"round\")  // shape the line join\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points \n    \n\nWhich results in the following image;\n\n![Polyline with Round Join](images/EAS-39.png) Polyline with Round Join\n\nNote the curve on the outer of the join.\n\nChanging the shape of the line join to `bevel` produces the following;\n\n![Polyline with Bevel Join](images/EAS-40.png) Polyline with Bevel Join\n\nHere we can see the clipping of the outer portion of the join.\n\nAnd using `miter` produces a standard connection;\n\n![Polyline with Miter Join](images/EAS-41.png) Polyline with Miter Join\n\nThis is the default setting for line joins and does not need to be added\nunless the line join type has already been set to a different default.\n\n####  `writing-mode`\n\nThe `writing-mode` style changes the orientation of the text so that it prints\nout top to bottom. It has a single option “tb” that accomplishes this. It is\nrelatively limited in scope compared to the equivalent for CSS, but for the\npurposes of generating some text it has a definite use.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a line of text that is now printed from top to bottom instead of left\nto right.\n\n    \n    \n    holder.append(\"text\")            // append text\n        .style(\"fill\", \"black\")      // make the text black\n        .style(\"writing-mode\", \"tb\") // set the writing mode\n        .attr(\"x\", 200)         // set x position of left side of text\n        .attr(\"y\", 100)         // set y position of bottom of text\n        .text(\"Hello World\");   // define the text to display\n    \n\nWhich results in the following image;\n\n![Text rotated using writing-mode](images/EAS-42.png) Text rotated using\nwriting-mode\n\nIt is significant to note that while it looks like the text has been rotated\nabout its anchor point, this actually isn’t the case since the anchor point\nshould be at 200,100. Also, the `glyph-orientation-vertical` style (which\nfollows) will allow the text to be orientated vertically which will be useful.\n\n####  `glyph-orientation-vertical`\n\nThe `glyph-orientation-vertical` style changes the rotation of the individual\nglyphs (characters) in text and if used in conjunction with the `writing-mode`\nstyle (and set to 0) will allow the text to be displayed vertically with the\nletters orientated vertically as well.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a line of text that is now printed from top to bottom with letters\norientated vertically.\n\n    \n    \n    holder.append(\"text\")            // append text\n        .style(\"fill\", \"black\")      // make the text black\n        .style(\"writing-mode\", \"tb\") // set the writing mode\n        .style(\"glyph-orientation-vertical\", 0)\n        .attr(\"x\", 200)         // set x position of left side of text\n        .attr(\"y\", 25)          // set y position of bottom of text\n        .text(\"Hello World\");   // define the text to display\n    \n\nWhich results in the following image;\n\n![Text rotated and orientated](images/EAS-43.png) Text rotated and orientated\n\nIt is worth noting that the text spacing increases dramatically as the spacing\nfor each letter relies on the normal distance between the bottom and top of a\nline of text.\n\n#### Using styles in Cascading Style Sheets\n\nDeclaring styles on an element by element basis is an OK way to apply styles,\nbut when our visualizations become more complex, this can be an inefficient\nuse of code.\n\nA smarter way to provide a common set of styles to elements is to declare them\nin the `<style>` section of our HTML document using Cascading Style Sheets\n(CSS). These will then be automatically applied to our elements.\n\nWe start with an example script that draws our three lines that have different\nstyles of linecaps. Our previous example looked like the following (in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter)\n\n    \n    \n    holder.append(\"line\")                 // attach a line\n        .style(\"stroke\", \"black\")         // colour the line\n        .style(\"stroke-width\", 20)        // adjust line width\n        .style(\"stroke-linecap\", \"butt\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 50);     // y position of the second end of the line\n    \n    holder.append(\"line\")                  // attach a line\n        .style(\"stroke\", \"black\")          // colour the line\n        .style(\"stroke-width\", 20)         // adjust line width\n        .style(\"stroke-linecap\", \"round\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 100)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 100);    // y position of the second end of the line\n    \n    holder.append(\"line\")                   // attach a line\n        .style(\"stroke\", \"black\")           // colour the line\n        .style(\"stroke-width\", 20)          // adjust line width\n        .style(\"stroke-linecap\", \"square\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 150)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nWhich resulted in the following image;\n\n![Three Lines with Different End Shapes](images/EAS-38.png) Three Lines with\nDifferent End Shapes\n\nThe block of code for each of the three lines contains three separate `style`\ndeclarations. Two of which are identical for all three blocks of code;\n\n    \n    \n        .style(\"stroke\", \"black\")         // colour the line\n        .style(\"stroke-width\", 20)        // adjust line width\n    \n\nTo make these styles available from a common point, we declare them in the\n`<style>` section of our HTML file as follows;\n\n    \n    \n    <style>\n    line.linecap {\n      stroke: black;\n      stroke-width: 20;  \n    }\n    </style>\n    \n\nThe `<style>` tags simply tell our browser which part of [the HTML\nfile](chap06.xhtml#EASframework) we are using to define our styles.\n\nThe `line.linecap` portion identifies the following styles as belonging to the\n`line` elements that are also identified as belonging to the ‘class’ `linecap`\n(We have used the `linecap` name as a convenience only and it could just as\neasily have been `foobar`.).\n\nThe two styles are enclosed within curly braces and are declared in the form\n`<style-name>: <style-value>;`. So for our example here, the stroke is black\nand its width is 20 pixels.\n\nThen our example script can have the two styles removed from each of the\nblocks that draws the lines and in their place we add a new attribute `class`\nthat assigns a class to the element (in this case the class `linecap`). Our\nnew code will look like this;\n\n    \n    \n    holder.append(\"line\")           // attach a line\n        .style(\"stroke-linecap\", \"butt\")  // stroke-linecap type\n        .attr(\"class\", \"linecap\")   // inherits styles from CSS\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 50);     // y position of the second end of the line\n    \n    holder.append(\"line\")           // attach a line\n        .style(\"stroke-linecap\", \"round\")  // stroke-linecap type\n        .attr(\"class\", \"linecap\")   // inherits styles from CSS\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 100)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 100);    // y position of the second end of the line\n    \n    holder.append(\"line\")           // attach a line\n        .style(\"stroke-linecap\", \"square\")  // stroke-linecap type\n        .attr(\"class\", \"linecap\")   // inherits styles from CSS\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 150)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nWhile this has only replaced two lines with one in our code, the potential for\nuse in far more complex examples should be obvious. There is significantly\nmore detail that can be gone into with regard to CSS, but that would be beyond\nmy meagre abilities.\n\n\n## Manipulating data\n\n### How to use data imported from a csv file with spaces in the header.\n\nWhen importing data from a csv file (dataSpace.csv) that has headers with\nspaces in the middle of some of the fields there is a need to address the data\nslightly differently in order for it to be used easily in your JavaScript.\n\nFor example the following csv data has a column named ‘Date Purchased’;\n\n    \n    \n    Date Purchased,close\n    1-May-12,58.13\n    30-Apr-12,53.98\n    27-Apr-12,67.00\n    26-Apr-12,89.70\n    25-Apr-12,99.00\n    \n\nThis is not an uncommon occurrence since [RFC\n4180](http://tools.ietf.org/html/rfc4180) which specifies csv content allows\nfor it and d3.js supports the RFC;\n\n> Within the header and each record, there may be one or more fields,\n> separated by commas. Each line should contain the same number of fields\n> throughout the file. Spaces are considered part of a field and should not be\n> ignored.\n\nWhen we go to import the data using the d3.csv function, we need to reference\nthe ‘Data Purchased’ column in a way that makes allowances for the space. The\nfollowing piece of script (with grateful thanks to [Stephen Thomas for\nanswering my Stack Overflow\nquestion](http://stackoverflow.com/questions/21715201/unable-to-\nreference-d3-js-data-imported-from-a-csv-file-with-spaces-in-the-heade))\nappears to be the most basic solution.\n\n    \n    \n    d3.csv(\"dataSpace.csv\", function(error, data) {\n      if (error) throw error;\n    \n      data.forEach(function(d) {\n          d.date = parseTime(d['Date Purchased']);\n      });\n    ...\n    });\n    \n\nIn the example above the ‘Date Purchased’ column is re-declared as ‘date’\nmaking working in the following script much easier.\n\n### Extracting data from a portion of a string.\n\nSuppose we have a set of values we want to extract from a string because they\ncannot be used in their original form.\n\nFor example, the following csv file contains the column ‘value’ and the values\nof the data in that column are prefixed with a dollar sign ($).\n\n    \n    \n    value,date,score\n    $1234,2011-03-23,99\n    $2234,2011-03-24,100\n    $3234,2011-03-25,99\n    $4235,2011-03-26,100\n    \n\nWe can use the JavaScript substring() method to easily remove the leading\ncharacter from the data.\n\nThe following example processes our csv file after loading it and for each\n‘value’ entry on each row takes a substring of the entry that removes the\nfirst character and retains the rest.\n\n    \n    \n    d3.csv(\"dataSample.csv\", function(error, data) {\n      if (error) throw error;\n    \n        data.forEach(function(d) {\n            d.value = +d.value.substring(1);\n        });\n    ...\n    });\n    \n\nThe substring() function includes a ‘start’ index (as used above) and\noptionally a ‘stop’ index. More on how these can be configured can be found on\nthe [w3schools](http://www.w3schools.com/jsref/jsref_substring.asp) site.\n\n### Grouping and summing data (d3.nest)\n\nOften we will wish to group elements in an array into a hierarchical structure\nsimilar to the `GROUP BY` operator in SQL (but with the scope for multiple\nlevels). This can be achieved using the\n[`d3.nest`](https://github.com/d3/d3-collection/blob/master/README.md#nests)\noperator. Additionally we will sometimes wish to collapse the elements that we\nare grouping in a specific way (for instance to sum values). This can be\nachieved using the `rollup` function.\n\nThe example we will use is having the following csv file consisting of a\ncolumn of dates and corresponding values;\n\n    \n    \n    date,value\n    23-Mar-11,3\n    23-Mar-11,2\n    24-Mar-11,3\n    24-Mar-11,3\n    24-Mar-11,6\n    24-Mar-11,2\n    24-Mar-11,7\n    25-Mar-11,4\n    25-Mar-11,5\n    25-Mar-11,1\n    25-Mar-11,4\n    \n\nWe will nest the data according to the date and sum the data for each date so\nthat our data is in the equivalent form of;\n\n    \n    \n    key,values\n    23-Mar-11,5\n    24-Mar-11,21\n    25-Mar-11,14\n    \n\nWe will do this with the following script;\n\n    \n    \n    d3.csv(\"source-data.csv\", function(error, csv_data) {\n      if (error) throw error;\n    \n    var data = d3.nest()\n        .key(function(d) { return d.date;})\n        .rollup(function(d) { \n            return d3.sum(d, function(g) {return g.value; });\n        }).entries(csv_data);\n    \n    });\n    \n\nWe are assuming the data is in a csv file and is named `source-data.csv`.\n\nThe first thing we do is load that file and assign the loaded array the\nvariable name `csv_data`.\n\n    \n    \n    d3.csv(\"source-data.csv\", function(error, csv_data) {\n      if (error) throw error;\n    \n\nThen we declare our new array’s name will be `data` and we initiate the `nest`\nfunction;\n\n    \n    \n    var data = d3.nest()\n    \n\nWe assign the `key` for our new array as `date`. A ‘key’ is like a way of\nsaying “ _This is the thing we will be grouping on_ ”. In other words our\nresultant array will have a single entry for each unique `date` value.\n\n    \n    \n        .key(function(d) { return d.date;})\n    \n\nThen we include the `rollup` function that takes all the individual `value`\nvariables that are in each unique `date` field and sums them;\n\n    \n    \n        .rollup(function(d) { \n            return d3.sum(d, function(g) {return g.value; });\n    \n\nLastly we tell the entire nest function which data array we will be using for\nour source of data.\n\n    \n    \n        }).entries(csv_data);\n    \n\nWhat if your data turns out to be unsorted? Never fear, we can easily sort on\nthe key value by tacking on the `sortKeys` function like so;\n\n    \n    \n        .key(function(d) { return d.date;}).sortKeys(d3.ascending)\n    \n\nYou should note that our data will have changed name from `date` and `value`.\nThis is as a function of the `nest` and `rollup` process. But never fear, it’s\na simple task to re-name them if necessary using the following function (which\ncould include a call to parse the date, but I have omitted it for clarity);\n\n    \n    \n    data.forEach(function(d) {\n        d.date = d.key;\n        d.value = d.values;\n    });\n    \n\n### Selecting a random string from an array.\n\nWhat if we had a situation where we wanted to be able to select a random\ncolour for the fill of a set of objects from a restricted set of colour\noptions.\n\n![An array of random colours](images/randomColour.png) An array of random\ncolours\n\nThe colours we want are green, orange, red and blue and the solution uses an\nadaptation of the one [presented by Jacob Relkin on\nstackoverflow](http://stackoverflow.com/questions/4550505/getting-random-\nvalue-from-an-array).\n\nFirst we start by declaring the colours in an array;\n\n    \n    \n    var colorRange = ['green', 'orange', 'red', 'blue']; \n    \n\nFrom there we set up the function that will return one of the elements of the\narray at random by calculating an index number from the array of possible\noptions based on the length of the array;\n\n    \n    \n    function randomColor() {\n        return colorRange[Math.floor(Math.random() * colorRange.length)];\n    }\n    \n\n`colorRange.length` returns the number of elements in the array (in this case\n4). This is multiplied by a random number between 0 and 1 (`Math.random()`).\nThen we get the largest integer that is less than or equal to our generated\nnumber using `Math.floor`. This ‘flattens out’ the result to be one of 0,1,2\nor 3.\n\nThen when we want to find one of our random colours we simply call our\n`randomColour` function a little like the following for a `fill`.\n\n    \n    \n    ...\n        .style(\"fill\", randomColor)\n    ...\n    \n\n\n## Bar Charts and Histograms\n\nYes! There is a difference! I know they look similar but for a bar charts,\neach column represents a group defined by a category and with a histogram,\neach column represents a group defined by a range.\n\n### Bar Chart\n\n![Bar chart](images/bar-01.png) Bar chart\n\n  * Each column is positioned over a label that represents a categorical variable.\n  * The height of the column indicates the size of the group defined by the category.\n\n#### Histogram\n\n![Histogram](images/hist-01.png) Histogram\n\n  * Each column is positioned over a label that represents a quantitative variable.\n  * The column label can be a single value or a range of values.\n\n### Bar Charts\n\nA bar chart is a visual representation using either horizontal or vertical\nbars to show comparisons between discrete categories. There are a number of\nvariations of bar charts including stacked, grouped, horizontal and vertical.\n\nWe will work through a simple vertical bar chart that uses a value on the y\naxis and category in the form of a name on the x axis.\n\nThe end result will look like this;\n\n![Bar chart](images/bar-01.png) Bar chart\n\n#### The data\n\nThe data for this example will be sourced from an external (purely fictional)\ncsv file named `sales.csv`. It consists of a column of names and ‘sales’ and\nits contents are as follows;\n\n    \n    \n    salesperson,sales\n    Bob,33\n    Robin,12\n    Anne,41\n    Mark,16\n    Joe,59\n    Eve,38\n    Karen,21\n    Kirsty,25\n    Chris,30\n    Lisa,47\n    Tom,5\n    Stacy,20\n    Charles,13\n    Mary,29\n    \n\n#### The code\n\nThe full code listing for the example we are going to work through is as\nfollows;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    .bar { fill: steelblue; }\n    \n    </style>\n    <body>\n    \t\n    <!-- load the d3.js library -->    \t\n    <script src=\"//d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // set the ranges\n    var x = d3.scaleBand()\n              .range([0, width])\n              .padding(0.1);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n              \n    // append the svg object to the body of the page\n    // append a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // get the data\n    d3.csv(\"sales.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n        d.sales = +d.sales;\n      });\n    \n      // Scale the range of the data in the domains\n      x.domain(data.map(function(d) { return d.salesperson; }));\n      y.domain([0, d3.max(data, function(d) { return d.sales; })]);\n    \n      // append the rectangles for the bar chart\n      svg.selectAll(\".bar\")\n          .data(data)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", function(d) { return x(d.salesperson); })\n          .attr(\"width\", x.bandwidth())\n          .attr(\"y\", function(d) { return y(d.sales); })\n          .attr(\"height\", function(d) { return height - y(d.sales); });\n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (bar.html and sales.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4).\n\n#### The bar chart explained\n\nIn the course of describing the operation of the file I will gloss over the\naspects of the structure of an HTML file which have already been described at\nthe start of the book. Likewise, aspects of the JavaScript functions that have\nalready been covered will only be briefly explained.\n\nThe start of the file deals with setting up the document’s head and body,\nloading the d3.javascript script and setting up the CSS in the `<style>`\nsection.\n\nThe CSS section sets styling for the colour of the bars. In all reality we\ncould have placed it as a style later in the code, but it’s nice to have\nsomething in the CSS area because you never know, we might want it later.\n\n    \n    \n    .bar { fill: steelblue; }\n    \n\nThen our JavaScript section starts and the first thing that happens is that we\nset the size of the area that we’re going to use for the chart and the\nmargins;\n\n    \n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nThe next section of our code includes some of the functions that will be\ncalled from the main body of the code. This includes the functions to\ndetermine positioning in the x and y domains.\n\n    \n    \n    // set the ranges\n    var x = d3.scaleBand()\n              .range([0, width])\n              .padding(0.1);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n    \n\nThe band scale set up for the x domain is a neat function that allows the\ncreation of a series of uniform bands that can be computed from the assigned\nrange. For the purposes of our bar chart, these will be the equivalent of the\nbars. These bands and their properties (the spacing between them and other\ndetails) can be assigned for display purposes.\n\nFor example, in this case the padding is the space made available between\nbars. This is set to `0.1`, or 1/10th of the width of the space available for\neach band. If we were to alter the padding to `0.5` (or half the width of the\nband) we would have the following;\n\n![Bar chart with 0.5 padding](images/bar-02.png) Bar chart with 0.5 padding\n\nFor the full description of band scales, check out the [D3\nwiki](https://github.com/d3/d3-scale#band-scales).\n\nThe function to set the scaling in the y domain is the same as most of our\nother graph examples;\n\n    \n    \n    var y = d3.scaleLinear()\n              .range([height, 0])\n    \n\nThe next block of code selects the `body` on the web page and appends an svg\nobject to it of the size that we have set up with our `width`, `height` and\n`margin`s.\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\")\n    \n\nIt also adds a `g` element that provides a reference point for adding our\naxes.\n\nThen we begin the main body of our JavaScript. We load our csv file and then\nloop through it making sure that the dates and numerical values are recognised\ncorrectly;\n\n    \n    \n    // get the data\n    d3.csv(\"sales.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n        d.sales = +d.sales;\n      });\n    \n\nWe then work through our x and y data and ensure that it is scaled to the\ndomains we are working in;\n\n    \n    \n      // Scale the range of the data in the domains\n      x.domain(data.map(function(d) { return d.salesperson; }));\n      y.domain([0, d3.max(data, function(d) { return d.sales; })]);\n    \n\nThen we add the bars to our chart;\n\n    \n    \n      // append the rectangles for the bar chart\n      svg.selectAll(\".bar\")\n          .data(data)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", function(d) { return x(d.salesperson); })\n          .attr(\"width\", x.bandwidth())\n          .attr(\"y\", function(d) { return y(d.sales); })\n          .attr(\"height\", function(d) { return height - y(d.sales); });\n    \n\nThis block of code creates the bars (`selectAll(\"bar\")`) and associates each\nof them with a data set (`.data(data)`).\n\nWe then append a rectangle (`.append(\"rect\")`) with the colour assigned by our\nclass (set in the `<style>` section) along with values for x/y position. The\nwidth of the bars is determined from our band scale function we assigned\nearlier and is found by retrieving the value via the `.bandwidth()` call. The\nheight is as configured in our earlier code.\n\nFinally we append our axes;\n\n    \n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nThe end result is our pretty looking bar chart;\n\n![Bar chart](images/bar-01.png) Bar chart\n\n### Histograms\n\nA histogram is a graphical representation of the distribution of numerical\ndata. It is typically formed by creating ‘bins’ of a larger dataset that group\nthe data into a range of values and count the number of pieces of data fall\ninto each bin. Each bin is then represented as a bar showing the relationship\nbetween each range.\n\nThe example we will work through shows the frequency of earthquakes above\nmagnitude 3 between July 2010 and January 2012 in Christchurch, New Zealand (A\ntime of some significant seismic activity). Data was sourced from New\nZealand’s [Geonet](http://www.geonet.org.nz/) site.\n\n![Histogram](images/hist-01.png) Histogram\n\nWe can see that the data has been ‘binned’ by month and that between the 1st\nof September and the 1st of October there were over 1800 earthquakes\nregistering over magnitude 3.\n\n#### The data\n\nThe data for this example will be sourced from an external (purely fictional)\ncsv file named `sales.csv`. It consists of a column of dates in day-month-year\nformat (and magnitudes, which won’t be used in this graph) and its contents\nlooks similar to the following;\n\n    \n    \n    dtg,value\n    01-08-2010,3\n    01-08-2010,3\n    01-08-2010,3\n    01-08-2010,3\n    01-08-2010,3.1\n    01-08-2010,3.2\n    01-08-2010,3.2\n    .\n    .\n    .\n    31-12-2011,3.2\n    31-12-2011,3.3\n    31-12-2011,3.4\n    31-12-2011,3.5\n    31-12-2011,3.5\n    31-12-2011,4.1\n    31-12-2011,4.9\n    \n\n#### The code\n\nThe full code listing for the example we are going to work through is as\nfollows;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    rect.bar { fill: steelblue; }\n    \n    </style>\n    <body>\n    \n    <!-- load the d3.js library -->    \t\n    <script src=\"//d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 10, right: 30, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // parse the date / time\n    var parseDate = d3.timeParse(\"%d-%m-%Y\");\n    \n    // set the ranges\n    var x = d3.scaleTime()\n              .domain([new Date(2010, 6, 3), new Date(2012, 0, 1)])\n              .rangeRound([0, width]);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n    \n    // set the parameters for the histogram\n    var histogram = d3.histogram()\n        .value(function(d) { return d.date; })\n        .domain(x.domain())\n        .thresholds(x.ticks(d3.timeMonth));\n    \n    // append the svg object to the body of the page\n    // append a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // get the data\n    d3.csv(\"earthquakes.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseDate(d.dtg);\n      });\n    \n      // group the data for the bars\n      var bins = histogram(data);\n    \n      // Scale the range of the data in the y domain\n      y.domain([0, d3.max(bins, function(d) { return d.length; })]);\n    \n      // append the bar rectangles to the svg element\n      svg.selectAll(\"rect\")\n          .data(bins)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", 1)\n          .attr(\"transform\", function(d) {\n    \t\t  return \"translate(\" + x(d.x0) + \",\" + y(d.length) + \")\"; })\n          .attr(\"width\", function(d) { return x(d.x1) - x(d.x0) -1 ; })\n          .attr(\"height\", function(d) { return height - y(d.length); });\n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n          \n    });\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/96b74d0bd6d11427dd797892551a103c) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (histogram.html and earthquakes.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/96b74d0bd6d11427dd797892551a103c).\n\n#### The histogram explained\n\nIn the course of describing the operation of the file I will gloss over the\naspects of the structure of an HTML file which have already been described at\nthe start of the book. Likewise, aspects of the JavaScript functions that have\nalready been covered will only be briefly explained.\n\nThe start of the file deals with setting up the document’s head and body,\nloading the d3.javascript script and setting up the CSS in the `<style>`\nsection.\n\nThe CSS section sets styling for the colour of the rectangles that make up the\nbars. Similar to the Bar graph, we could have placed it as a style later in\nthe code, but it’s nice to have something in the CSS area.\n\n    \n    \n    rect.bar { fill: steelblue; }\n    \n\nThen our JavaScript section starts and the first thing that happens is that we\nset the size of the area that we’re going to use for the chart and the\nmargins;\n\n    \n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 10, right: 30, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nThen we declare the code that parses the time;\n\n    \n    \n    // parse the date / time\n    var parseDate = d3.timeParse(\"%d-%m-%Y\");\n    \n\nHere we have it set to look for time that is formatted as day-month-year.\n\nThe next section of our code scales the ranges for x and y.\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime()\n              .domain([new Date(2010, 6, 3), new Date(2012, 0, 1)])\n              .rangeRound([0, width]);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n    \n\n`y` is pretty standard, but for `x` we specify a time scale that has a domain\nthat goes from one date to another. The date specified here is mildly\nartificial in the sense that I selected it to look good with the graph when I\nadjust the bins (you’ll see later), but a bit of experimentation will see you\nright. Lastly for the x range we get it to round itself to logical values\nusing `rangeRound`.\n\nNow we start to setup the function that will apply the D3 magic required to\nform our histogram with the code;\n\n    \n    \n    // set the parameters for the histogram\n    var histogram = d3.histogram()\n        .value(function(d) { return d.date; })\n        .domain(x.domain())\n        .thresholds(x.ticks(d3.timeMonth));\n    \n\nThe `d3.histogram` function allows us to form our data into ‘bins’ that form “\n_discrete samples into continuous, non-overlapping intervals_ ”. In other\nwords in this case we are going to take a data set of close to 10,000 points\nand we are going to form them into bins corresponding to the months that they\noccurred in. The value that we’re going to bin will be the variable `date` and\nthey will fit into the domain that we have already specified in the range\nsection (via `.domain(x.domain())`). Lastly, we apply the thresholds that we\nare going to use for the bins which in this case is monthly via\n`.thresholds(x.ticks(d3.timeMonth));`.\n\nWe can very crudely change our histogram by simply changing that to\n`.thresholds(x.ticks(d3.timeWeek));` to produce the following;\n\n![Histogram with weekly bins](images/hist-02.png) Histogram with weekly bins\n\nAnd we can go slightly more extreme by specifying a daily bin and produce the\nfollowing;\n\n![Histogram with daily bins](images/hist-03.png) Histogram with daily bins\n\n(Although technically I cheated slightly with this version and I removed the\npadding between the bars to allow the data to be presented a bit more\nfaithfully.)\n\nThe next block of code selects the `body` on the web page and appends an svg\nobject to it of the size that we have set up with our `width`, `height` and\n`margin`s.\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nIt also adds a `g` element that provides a reference point for adding our\naxes.\n\nThen we begin the main body of our JavaScript. We load our csv file and then\nloop through it making sure that the dates converted into a time format\ncorrectly;\n\n    \n    \n    // get the data\n    d3.csv(\"earthquakes.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseDate(d.dtg);\n      });\n    \n\nNow that we have our data we can put it into the appropriate bins using the\nhistogram function that we declared earlier;\n\n    \n    \n      // group the data for the bars\n      var bins = histogram(data);\n    \n\nAt this point we have two data sets. The first is our array of information\nfrom our earthquakes.csv file which is called ‘data’. The second is an array\nof grouped data called ‘bins’. We use the ‘bins’ data to draw our histogram.\n\nWe then use our ‘bin’ data to ensure that the y domain is scaled to the\nlongest bar in the ‘bins’ data set;\n\n    \n    \n      // Scale the range of the data in the y domain\n      y.domain([0, d3.max(bins, function(d) { return d.length; })]);\n    \n\nThen we add the bars to our chart;\n\n    \n    \n      // append the bar rectangles to the svg element\n      svg.selectAll(\"rect\")\n          .data(bins)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", 1)\n          .attr(\"transform\", function(d) {\n    \t\t  return \"translate(\" + x(d.x0) + \",\" + y(d.length) + \")\"; })\n          .attr(\"width\", function(d) { return x(d.x1) - x(d.x0) -1 ; })\n          .attr(\"height\", function(d) { return height - y(d.length); });\n    \n\nThis block of code selects all the rectangles (`selectAll(\"rect\")`) and\nassociates each of them with our binned data set (`.data(bins)`).\n\nWe then append the rectangles (`.append(\"rect\")`) with the colour assigned by\nour class (set in the `<style>` section) and we offset all the bars by 1 to\nmake sure that we have a nice symmetrical set of bars with a thin separation\n(`.attr(\"x\", 1)`).\n\nThe transform function sets the starting point for where we begin drawing the\nrectangles and the height and width attributes set the height and width of the\nrectangles. If you really want to stop and look at the transform and height\nattributes you will notice that it seems a bit ‘odd’. That is because it draws\nthe graph from the top of the screen down. The origin is at the top left of\nthe screen remember and we are trying to represent bars that appear to extend\nupwards from a ‘0’ point (on the y axis) that exists at a distance ‘height’\nfrom the top of the screen. Sound weird. It is a little, but at the very least\nit’s logical. You can do it in several different ways, some more confusing\nthan this, and I think that this represents a good balance between code\ncomplexity and understandability.\n\nIt’s also useful to note that when our histogram function was creating our\nbins, it also associated some variables with each bin. `x0` and `x1` to denote\nthe start and stop point for each bin in the x domain and `length` for the\nnumber of data points in each bin. You can see more details in the [D3 wiki\nhere](https://github.com/d3/d3-array/blob/master/README.md#histogram).\n\nFinally we append our axes;\n\n    \n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nThe end result is our sharp looking histogram;\n\n![Histogram](images/hist-01.png) Histogram\n\n\n## Tree Diagrams\n\n### What is a Tree Diagram?\n\nThe ‘[Tree\nlayout](https://github.com/d3/d3-hierarchy/blob/master/README.md#_tree)’ is\nnot a distinct type of diagram per se. Instead, it’s representative of D3’s\nfamily of hierarchical layouts.\n\nIt’s designed to produce a ‘node-link’ diagram that lays out the connection\nbetween nodes in a method that displays the relationship of one node to\nanother in a parent-child fashion.\n\nFor example, the following diagram shows a root node (the starting position)\nlabelled ‘Top Node’ which has two children (Bob: Child of Top Node and Sally:\nChild of Top Node). Subsequently, Bob:Child of Top Node has two dependant\nnodes (children) ‘Son of Bob’ and ‘Daughter of Bob’.\n\n![Tree layout diagram](images/tree-01.png) Tree layout diagram\n\nThe clear advantage to this style of diagram is that describing it in text is\ndifficult, but representing it graphically makes the relationships easy to\ndetermine.\n\nThe data required to produce this type of layout needs to describe the\nrelationships, but this is not necessarily an onerous task. For example, the\nfollowing is the data (in JSON form) for the diagram above and it shows the\nminimum information required to form the correct layout hierarchy.\n\n    \n    \n      {\n        \"name\": \"Top Node\",\n        \"children\": [\n          {\n            \"name\": \"Bob: Child of Top Node\",\n            \"children\": [\n              {\n                \"name\": \"Son of Bob\"\n              },\n              {\n                \"name\": \"Daughter of Bob\"\n              }\n            ]\n          },\n          {\n            \"name\": \"Sally: Child of Top Node\"\n          }\n        ]\n      }\n    \n\nIt shows each node as having a name that identifies it on the tree and, where\nappropriate, the children it has (as an array).\n\nThe data shown above is arranged as a hierarchy and it is not always possible\nto source data that is organised so nicely. As we go through examples for this\ntype of diagram we will look at options for importing ‘flat’ data (for example\nfrom a csv file) and converting it into a hierarchical form.\n\nThere is a wealth of examples of tree diagrams on the web, but I would\nrecommend a visit to\n[blockbuilder.org](http://blockbuilder.org/search#d3version=v4;api=d3.tree) as\na starting point to get some ideas.\n\nIn this chapter we’re going to look at a very simple piece of code to generate\na tree diagram before looking at different ways to adapt it. Including\nrotating it to be vertical, adding some dynamic styling to the nodes,\nimporting from a flat file and from an external source. Finally we’ll look at\na more complex example that is more commonly used on the web that allows a\nuser to expand and collapse nodes interactively.\n\n### A simple Tree Diagram explained\n\nWe are going to work through a simple example of the code that draws a tree\ndiagram, This is more for the understanding of the process rather than because\nit is a good example of code for drawing a tree diagram. It is a very limited\nexample that lacks any real interactivity which is one of the strengths of\nd3.js graphics. However, we will outline the operation of an interactive\nversion towards the end of the chapter once we have explored some possible\nconfiguration options that we might want to make.\n\nThe graphic that we are going to generate will look like this…\n\n![Simple tree layout diagram](images/tree-02.png) Simple tree layout diagram\n\nYou might well be asking why, when introducing the topic of tree diagrams we\nshowed a horizontal tree and why we are now going to draw a vertical tree\ndiagram. That would be a good question that deserves a good answer. When we\nlook at the code for drawing a vertical tree diagram it will look logical and\nwe will be able to describe it beautifully. That’s because the default\nstandard when D3 is drawing a tree diagram is to have it going from top to\nbottom. When we look at a horizontal tree diagram, the diagram and the code\nhas to be rotated by 90 degrees. This means that when we go to move or draw\nsomething in the x direction we will need to move in the y direction in the\ncode and vice versa. It has the potential to be quite confusing, so if we\nconsider the vertical diagram first and then rotate everything it seems much\neasier. Trust me.\n\nThe full code for it looks like this;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n        \n    .node circle {\n      fill: #fff;\n      stroke: steelblue;\n      stroke-width: 3px;\n    }\n    \n    .node text { font: 12px sans-serif; }\n    \n    .node--internal text {\n      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #ccc;\n      stroke-width: 2px;\n    }\n    \n    </style>\n    \n    <body>\n    \n    <!-- load the d3.js library -->    \t\n    <script src=\"//d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \t\n    var treeData =\n      {\n        \"name\": \"Top Level\",\n        \"children\": [\n          { \n    \t\t\"name\": \"Level 2: A\",\n            \"children\": [\n              { \"name\": \"Son of A\" },\n              { \"name\": \"Daughter of A\" }\n            ]\n          },\n          { \"name\": \"Level 2: B\" }\n        ]\n      };\n    \n    // set the dimensions and margins of the diagram\n    var margin = {top: 40, right: 30, bottom: 50, left: 30},\n        width = 660 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([width, height]);\n    \n    //  assigns the data to a hierarchy using parent-child relationships\n    var nodes = d3.hierarchy(treeData);\n    \n    // maps the node data to the tree layout\n    nodes = treemap(nodes);\n    \n    // append the svg obgect to the body of the page\n    // appends a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n          .attr(\"width\", width + margin.left + margin.right)\n          .attr(\"height\", height + margin.top + margin.bottom),\n        g = svg.append(\"g\")\n          .attr(\"transform\",\n                \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"C\" + d.x + \",\" + (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" +  (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n    // adds each node as a group\n    var node = g.selectAll(\".node\")\n        .data(nodes.descendants())\n      .enter().append(\"g\")\n        .attr(\"class\", function(d) { \n          return \"node\" + \n            (d.children ? \" node--internal\" : \" node--leaf\"); })\n        .attr(\"transform\", function(d) { \n          return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", 10);\n    \n    // adds the text to the node\n    node.append(\"text\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"y\", function(d) { return d.children ? -20 : 20; })\n      .style(\"text-anchor\", \"middle\")\n      .text(function(d) { return d.data.name; });\n        \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/b024fcce8b4b9264011a1c3e7c7d70dc) or\nin the code samples bundled with this book (simple-vertical-tree-\ndiagram.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/b024fcce8b4b9264011a1c3e7c7d70dc).\n\nIn the course of describing the operation of the file I will gloss over the\naspects of the structure of an HTML file which have already been described at\nthe start of the book. Likewise, aspects of the JavaScript functions that have\nalready been covered will only be briefly explained.\n\nThe start of the file deals with setting up the document’s head and body\nloading the d3.js script and setting up the CSS in the `<style>` section.\n\nThe CSS section sets styling for the circle that represents the nodes, the\ntext alongside them and the links between them.\n\n    \n    \n    .node circle {\n      fill: #fff;\n      stroke: steelblue;\n      stroke-width: 3px;\n    }\n    \n    .node text { font: 12px sans-serif; }\n    \n    .node--internal text {\n      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #ccc;\n      stroke-width: 2px;\n    }\n    \n\nThen our JavaScript section starts and the first thing that happens is that we\ndeclare our array of data in the following code;\n\n    \n    \n    var treeData =\n      {\n        \"name\": \"Top Level\",\n        \"children\": [\n          { \n    \t\t\"name\": \"Level 2: A\",\n            \"children\": [\n              { \"name\": \"Son of A\" },\n              { \"name\": \"Daughter of A\" }\n            ]\n          },\n          { \"name\": \"Level 2: B\" }\n        ]\n      };\n    \n\nAs outlined at the start of the chapter, this data is encoded hierarchically\nin JavaScript Object Notation (JSON). Each node must have a name and if it is\ngoing to have subordinate nodes it must include a ‘children’ element. There\nare many examples of hierarchical data that can be encoded in this way. From\nthe traditional parent - offspring example to directories on a hard drive or a\nbreakdown of materials for a complex object. Any system of encoding where\nthere is a single outcome from multiple sources like an election or an alert\nencoding system dependent on multiple trigger points.\n\nThe next section of our code declares some of the standard features for our\ndiagram such as the size and shape of the svg container with margins included.\n\n    \n    \n    // set the dimensions and margins of the diagram\n    var margin = {top: 40, right: 90, bottom: 50, left: 90},\n        width = 660 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nNow we start to get into the specifics for the diagram. The next block of code\ninvokes the D3 `.tree` component, configures the data and assigns it to the\ntree structure (no actual drawing mind you, just getting the data ready).\n\n    \n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([width, height]);\n    \n    //  assigns the data to a hierarchy using parent-child relationships\n    var nodes = d3.hierarchy(treeData);\n    \n    // maps the node data to the tree layout\n    nodes = treemap(nodes);\n    \n\nThe first part of this is the declaration of `treemap` as using the `d3.tree`\nfunction and assigning the size of the diagram from our earlier variables;\n\n    \n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([width, height]);\n    \n\nThen we assign our data (with the variable `treeData`) to `nodes` using the\n`d3.hierarchy` function.\n\n    \n    \n    //  assigns the data to a hierarchy using parent-child relationships\n    var nodes = d3.hierarchy(treeData, function(d) {\n        return d.children;\n      });\n    \n\nThis assigns a range of properties to each node including;\n\n  * `node.data` \\- the data associated with the node (in our case it will include the name accessible as `node.data.name`)\n  * `node.depth` \\- a representation of the depth or number of hops from the initial ‘root’ node.\n  * `node.height` \\- the greatest distance from any descendant leaf nodes\n  * `node.parent` \\- the parent node, or null if it’s the root node\n  * `node.children` \\- child nodes or undefined for any leaf nodes\n\nWhile we’re telling the function to use the ‘children’ elements from\n‘treeData’, to generate the properties for the nodes, by default it will use\nthe name ‘ _children_ ’ if a name is not specified.\n\nLastly for this block we map the ‘nodes’ data to the tree layout;\n\n    \n    \n    // maps the node data to the tree layout\n    nodes = treemap(nodes);\n    \n\nThe next block of code appends our SVG working area to the body of our web\npage and creates a group element (`<g>`) that will contain our svg objects\n(our nodes, text and links).\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n          .attr(\"width\", width + margin.left + margin.right)\n          .attr(\"height\", height + margin.top + margin.bottom),\n        g = svg.append(\"g\")\n          .attr(\"transform\",\n                \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nNow we’re going to start drawing something! First up is the trickiest part.\nThe links between the nodes.\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"C\" + d.x + \",\" + (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" +  (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n\nI say _tricky_ because we’re going to be using the svg mini language again,\nand while it will work just fine if we simply paste it in and move on, if we\nwant to understand a bit more about how it works, we will need to take a bit\nof a detour.\n\nBut first we need to get the details for this block of code explained. We\ndeclare and select all the ‘links’ and then assign the nodes as ‘data’\n(`.data(nodes.descendants().slice(1))`). When we do this we are using\n`.descendants()` to return the array of ‘descendant’ nodes. We also specify\n`.slice(1)` to not include the main ‘root’ node since the links will be drawn\nby drawing a line from a child node to its parent (which we wouldn’t be able\nto do with the root node).\n\nWe append a path (`.enter().append(\"path\")`) and apply some styling\n(`.attr(\"class\", \"link\")`) and then embark on drawing the link lines with the\nSVG mini language via the ‘d’ attribute.\n\nAs we have mentioned previously the ‘d’ attribute allows for the creation of a\nstring of instructions that describe a path. These instructions include;\n\n  * Moveto : moves the drawing point using `M` for absolute coordinates and `m` for relative movements \n  * Lineto : draws a straight line from the current position to the next specified location using `L` for absolute coordinates and `l` for relative movement.\n  * Curveto : draws a [Bezier curve](https://developer.mozilla.org/en-US/docs/User:Jt_Sandbox/Curves_in_Paths) using control points from the current position to an end point. `C` designates absolute coordinates and `c` is used for relative movement. Either one or two sets of control points are used depending on whether a quadratic or cubic Bezier curve is used. \n  * Arcto : describes a curved path as an elliptical curve rather than a Bezier with additional complexity\n  * ClosePath : draws a straight line from the current position to the first point in the path\n\nIf we look at a single node instance and break down the ‘d’ attribute path we\ncan see the following;\n\n  * `\"M\" + d.x + \",\" + d.y` : Moves to the starting point of our node\n  * `\"C\" + d.x + \",\" + (d.y + d.parent.y) / 2` : Establishes that we are going to draw a Cubic (`C`) Bezier curve and the first control point for it is at `d.x` in the x dimension and halfway between the starting node and its parent.\n  * `\" \" + d.parent.x + \",\" + (d.y + d.parent.y) / 2` : Sets the second control point for the curve in line with the parent node in the x dimension and still halfway between the starting node and its parent in the y dimension.\n  * `\" \" + d.parent.x + \",\" + d.parent.y` : sets the end point for our curve at the parent node location.\n\n![Tree layout node locations for links](images/tree-03.png) Tree layout node\nlocations for links\n\nIf we wanted to make the code easier to follow we could change the curve\nbetween nodes to a straight line with the following code;\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"L\" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n\nWhich would result in lines being drawn with coordinates from the ‘d’\nattribute as follows;\n\n![Tree layout node locations for links](images/tree-03a.png) Tree layout node\nlocations for links\n\nThen we create a variable `node` that creates a group element (`g`) for each\nnode;\n\n    \n    \n    // adds each node as a group\n    var node = g.selectAll(\".node\")\n        .data(nodes.descendants())\n      .enter().append(\"g\")\n        .attr(\"class\", function(d) { \n          return \"node\" + \n            (d.children ? \" node--internal\" : \" node--leaf\"); })\n        .attr(\"transform\", function(d) { \n          return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n    \n\nThis time we can see that;\n\n  * We don’t slice off the root node (`.data(nodes.descendants())`) from our data set.\n  * We apply a different ‘class’ to the node depending on whether it’s an internal node (it has children) or it’s a leaf node (it has no children) `d.children ? \" node--internal\" : \" node--leaf\"`. \n  * We place each node ‘group’ at the appropriate location.\n  * We don’t _actually_ draw anything. All we’re doing is getting the properties for each node set.\n\nOnce we have everything set up we can start to add objects to our node groups.\n\nFirst we add our circle;\n\n    \n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", 10);\n    \n\nAnd then we add the text;\n\n    \n    \n    // adds the text to the node\n    node.append(\"text\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"y\", function(d) { return d.children ? -20 : 20; })\n      .style(\"text-anchor\", \"middle\")\n      .text(function(d) { return d.data.name; });\n    \n\nWhen we’re adding the text, we make sure that we add it on the side\nappropriate for either a leaf node or an internal node.\n\nAnd there’s our tree diagram.\n\n![Simple tree layout diagram](images/tree-02.png) Simple tree layout diagram\n\n### A horizontal tree diagram explained\n\nAs we discussed at the start of the previous section, we wanted to start\ndescribing tree diagrams with a vertical version because there was an added\ndegree of complexity with the horizontal version that might cause some\nconfusion. If you have worked through and understood the vertical version, the\nhorizontal won’t present any problems other than when you go “ _Oh, I see\nwhat’s going on._ ”. If you find yourself part way through this description of\nthe changes to the code and can’t see what’s going on, revisit the vertical\ncode and come back.\n\nThe graphic that we are going to generate will look like this…\n\n![Horizontal tree layout diagram](images/htree-01.png) Horizontal tree layout\ndiagram\n\nThe full code for this is almost identical to the code for the vertical tree\ndiagram with a couple of simple, yet major changes.\n\nThe first change is that the way that we draw the diagram relies on changing\nour reference by rotating everything by 90 degrees.\n\n![Rotate the tree by 90 degrees](images/htree-02.png) Rotate the tree by 90\ndegrees\n\nThe (very simplistic) diagram shows that what used to be our ‘x’ dimension is\nnow our ‘y’ dimension and visa versa.\n\nThe second change is that where we rotated our axes above we are now left with\ny and x dimensions that have an origin in the bottom left of the graph. Of\ncourse when we draw our diagram, the origin is in the top left corner. This\nvertical flip occurs automatically and is the reason the diagram doesn’t\nappear to have ‘just’ rotated.\n\n![Flip the tree vertically](images/htree-03.png) Flip the tree vertically\n\nNow we have our origin in the top left again and the layout of our tree looks\npretty much as the example we will be producing.\n\nBelieve it or not, this is **WAY** more difficult to explain than it is to\nactually do. Again, D3 takes care of the heavy lifting, the explanation of the\nchanges above is just to help us understand _why_ we make some of the changes.\n\nThe first change we make is just to give ourselves some extra margin space\nsince some of the labels extend slightly more left and right with a horizontal\ndiagram;\n\n    \n    \n    var margin = {top: 20, right: 90, bottom: 30, left: 90},\n    \n\nThe second change sets the size of the graphic. Here the width and height are\nswapped as part of the rotation.\n\n    \n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([height, width]);\n    \n\nWhen we add the links we need to incorporate the rotation and the easiest way\nto appreciate the change is to compare the two pieces of code at the same\ntime. In fact it is only when we draw the ‘d’ attribute for the path that we\nsee the changes.\n\nFirstly the vertical tree code;\n\n    \n    \n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"C\" + d.x + \",\" + (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" +  (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n\nThen the horizontal tree code;\n\n    \n    \n        .attr(\"d\", function(d) {\n           return \"M\" + d.y + \",\" + d.x\n             + \"C\" + (d.y + d.parent.y) / 2 + \",\" + d.x\n             + \" \" + (d.y + d.parent.y) / 2 + \",\" + d.parent.x\n             + \" \" + d.parent.y + \",\" + d.parent.x;\n           });\n    \n\nWhile there is a bit of math involved, the easiest way to tell that there is a\ndifference is that for the horizontal tree, each coordinate is being described\nin y,x fashion rather than the conventional x,y.\n\nA similar coordinate change is made when we translate the positions for the\nnodes;\n\n    \n    \n        .attr(\"transform\", function(d) { \n          return \"translate(\" + d.y + \",\" + d.x + \")\"; });\n    \n\nAnd lastly when we place the text next to the circles we need to adjust the\ndefault ‘y’ distance value with an ‘x’ distance value and to ensure that the\nlabels are spaced at an appropriate distance and to align the text to either\nthe left or right depending on whether it has children or not. We adjust the\ntext anchor appropriately with an ‘end’ or ‘start’.\n\n    \n    \n    node.append(\"text\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"x\", function(d) { return d.children ? -13 : 13; })\n      .style(\"text-anchor\", function(d) { \n        return d.children ? \"end\" : \"start\"; })\n      .text(function(d) { return d.data.name; });\n    \n\nAnd there we are….\n\n![Horizontal tree layout diagram](images/htree-01.png) Horizontal tree layout\ndiagram\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/5537fe63086c4f100114f87f124850dd), or\nin the code samples bundled with this book (simple-horizontal-tree-\ndiagram.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/5537fe63086c4f100114f87f124850dd).\n\n### Styling nodes in a tree diagram\n\n#### Changing node and link colours\n\nThe nodes in a tree diagram are objects that exist to provide a representation\nof the structure of data, but on a tree diagram they should also be viewed as\nan opportunity to encode additional information about the underlying data.\n\nFrom the horizontal example shown we have encoded a certain amount of\ninformation already. The position of the text relative to each node is\ndetermined by whether or not the node is the parent of another node (if it’s a\nparent it’s on the left) or a child that is on the edge of the tree (in which\ncase it is on the right of the node).\n\n![Node position on the tree diagram](images/htree-01.png) Node position on the\ntree diagram\n\nNow, that’s nice, but are we going to be satisfied with that??? (The answer is\n“No” by the way.)\n\nThis example is fairly simple, but it is an example of applying different\nstyles to the nodes to convey additional information. I should be clear at\nthis stage that I am not advocating turning your tree diagram into something\nthat looks like it came out of a circus, because that would be a crime against\nstyle, so don’t repeat my upcoming example, but let some of the features be a\ntrigger for developing your own subtle, yet compelling visualizations.\n\nBrace yourself. Here’s a picture of the tree diagram that we’re going to\ngenerate. Those with weaker constitutions should look away and flip forward a\nfew pages;\n\n![Tree diagram with excessive styling](images/tree-07.png) Tree diagram with\nexcessive styling\n\nThe changes that have been made are as a result of additional data fields that\nhave been added to the JSON array and these fields have been applied to\nvarious style options throughout the code.\n\nThe types of style changes we have made are \\- Variation of the diameter of\nnodes \\- Changing the fill and stroke colour of nodes \\- Changing the colour\nof links depending on the associated node they are connected to.\n\nThe code changes we describe from here are assuming that we start with our\nsimple horizontal tree diagram from the previous chapter. We’ll start by\nlooking at the new JSON data set;\n\n    \n    \n      {\n        \"name\": \"Top Level\",\n        \"value\": 10,\n        \"type\": \"black\",\n        \"level\": \"red\",\n        \"children\": [\n          {\n            \"name\": \"Level 2: A\",\n            \"value\": 15,\n            \"type\": \"grey\",\n            \"level\": \"red\",\n            \"children\": [\n              {\n                \"name\": \"Son of A\",\n                \"value\": 5,\n                \"type\": \"steelblue\",\n                \"level\": \"orange\"\n              },\n              {\n                \"name\": \"Daughter of A\",\n                \"value\": 8,\n                \"type\": \"steelblue\",\n                \"level\": \"red\"\n              }\n            ]\n          },\n          {\n            \"name\": \"Level 2: B\",\n            \"value\": 10,\n            \"type\": \"grey\",\n            \"level\": \"green\"\n          }\n        ]\n      }\n    \n\nEach node now has a `value` which might represent a degree of importance (we\nwill use this to affect the radius of the nodes), a `type` which might\nindicate a difference in the type of node (they might be in active, inactive\nor undetermined states) and a `level` which might indicate an alert level for\ndetermining problems (red = bad, orange = caution and green = normal).\n\nIrrespective of the contrived nature of our styling options, they are applied\nto our tree in fairly similar ways with some subtle differences.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/08ecb6ea9bb68ba0d9a7e89f344acec8) or\nin the code samples bundled with this book (tree-styling.html). A working\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/08ecb6ea9bb68ba0d9a7e89f344acec8).\n\nThe first change is to the node radius, stroke colour and fill colour.\n\nWe simply change the portion of the code that appends the circle from this…\n\n    \n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", 10);\n    \n\n… to this …\n\n    \n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", function(d) { return d.data.value; })\n      .style(\"stroke\", function(d) { return d.data.type; })\n      .style(\"fill\", function(d) { return d.data.level; });\n    \n\nThe changes return the radius attribute as a function using `data.value`, the\nstroke colour is returned using `data.type` and the fill colour is returned\nwith `data.level`. This is nice and simple, but we do need to make a slight\nadjustment to the code that sets the distance that the text is from the nodes\nso that when the radius expands or contracts, the text distance from the edge\nof the node adjusts as well.\n\nTo do this we take the clever piece of code that adjusts the distance that the\ntext is in the x dimension from the node that looks like this …\n\n    \n    \n      .attr(\"x\", function(d) { return d.children ? -13 : 13; })\n    \n\n… and we add in a dynamic aspect using the `data.value` field.\n\n    \n    \n      .attr(\"x\", function(d) { return d.children ? \n        (d.data.value + 4) * -1 : d.data.value + 4 })\n    \n\nThe last thing we wanted to do is to change the colour of the link based on\nthe colour of the node. We accomplish this by taking the code that inserts the\nlinks…\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.y + \",\" + d.x\n             + \"C\" + (d.y + d.parent.y) / 2 + \",\" + d.x\n             + \" \" + (d.y + d.parent.y) / 2 + \",\" + d.parent.x\n             + \" \" + d.parent.y + \",\" + d.parent.x;\n           });;\n    \n\n… and adding in a line that styles the link colour (the stroke) based on the\n`data.level` colour of node.\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .style(\"stroke\", function(d) { return d.data.level; })\n        .attr(\"d\", function(d) {\n           return \"M\" + d.y + \",\" + d.x\n             + \"C\" + (d.y + d.parent.y) / 2 + \",\" + d.x\n             + \" \" + (d.y + d.parent.y) / 2 + \",\" + d.parent.x\n             + \" \" + d.parent.y + \",\" + d.parent.x;\n           });\n    \n\nUse the concepts here wisely. I don’t want to see any heinously styled tree\ndiagrams floating around the internet with “Thanks to the help from D3 Tips\nand Tricks” next to them. Be subtle, be thoughtful :-).\n\n#### Changing the nodes to different shapes\n\nMany thanks to Josiah who [asked a\nquestion](http://www.d3noob.org/2014/01/tree-diagrams-\nin-d3js_11.html?showComment=1398062145979#c8289012474475643167) on the\nd3noob.org blog on how the shapes of the nodes could be varied based on an\nassociated value in the data.\n\nThere is more than one way to do this, but perhaps the simplest is to replace\nthe section of the JavaScript that appends the circle with one that appends a\nsymbol from d3’s [symbol\ngenerator](https://github.com/d3/d3-shape/blob/master/README.md#symbols).\n\nThere are six pre-defined symbol types as follows;\n\n  * circle (`d3.symbolCircle`) - a circle.\n  * cross (`d3.symbolCross`) - a Greek cross or plus sign.\n  * diamond (`d3.symbolDiamond`) - a rhombus.\n  * square (`d3.symbolSquare`) - an axis-aligned square.\n  * triangle (`d3.symbolTriangle`) - an upward-pointing equilateral triangle.\n  * star (`d3.symbolStar`) - a five pointed star.\n  * ‘Y’ (`d3.symbolWye`) - a ‘Y’ shape.\n\nIf we start with our ‘[tree-styling](chap09.xhtml#tree-styling)’ script from\nabove we can replace the code block that added the circles with the following\nscript will look at the `value` in the data and assign either a cross or a\ndiamond depending on the `value`\n\n    \n    \n    // adds symbols as nodes\n    node.append(\"path\")\n      .style(\"stroke\", function(d) { return d.data.type; })\n      .style(\"fill\", function(d) { return d.data.level; })\n      .attr(\"d\", d3.symbol()\n         .size(function(d) { return d.data.value * 30; } )\n         .type(function(d) { if\n           (d.data.value >= 9) { return d3.symbolCross; } else if\n           (d.data.value <= 9) { return d3.symbolDiamond;}\n         }));\n    \n\nIt will also adjust the size of the symbol along with the stroke and fill.\n\n![Tree diagram different node shapes](images/tree-12.png) Tree diagram\ndifferent node shapes\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/76d6fa0dff4af77544da9dd69aef9249) or\nin the code samples bundled with this book (tree-symbol.html). A working\nonline example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/76d6fa0dff4af77544da9dd69aef9249).\n\n#### Using images as nodes\n\nMany thanks to nbhatta who [asked a\nquestion](http://www.d3noob.org/2014/01/tree-diagrams-\nin-d3js_11.html?showComment=1399025834455#c4911480988339223702) on the\nd3noob.org blog on how to use images as nodes.\n\n![Tree diagram with images for nodes](images/tree-13.png) Tree diagram with\nimages for nodes\n\nThis was a slightly simpler change and just involved replacing the code\nsnippet that added the circles with one that added an image;\n\n    \n    \n    // adds images as nodes\n    node.append(\"image\")\n      .attr(\"xlink:href\", function(d) { return d.data.icon; })\n      .attr(\"x\", \"-12px\")\n      .attr(\"y\", \"-12px\")\n      .attr(\"width\", \"24px\")\n      .attr(\"height\", \"24px\");\n    \n\nThe images I chose were all 48 x 48 pixel for the sake of consistency and in\nthe code above I formatted them to be half that size and moved them in the x\nand y direction so that they were centred correctly.\n\nThe cool thing that you will notice is that the specific icon that is placed\nat each node position is set by the name of the icon which is gathered from\nthe JSON file with the tree details;\n\n    \n    \n    var treeData = \n      {\n        \"name\": \"Top Level\",\n        \"value\": 10,\n        \"type\": \"black\",\n        \"level\": \"red\",\n        \"icon\": \"earth.png\",\n        \"children\": [\n          {\n            \"name\": \"Level 2: A\",\n            \"value\": 5,\n            \"type\": \"grey\",\n            \"level\": \"red\",\n           \"icon\": \"cart.png\",\n            \"children\": [\n              {\n                \"name\": \"Son of A\",\n                \"value\": 5,\n                \"type\": \"steelblue\",\n                \"icon\": \"lettern.png\",\n                \"level\": \"orange\"\n              },\n              {\n                \"name\": \"Daughter of A\",\n                \"value\": 18,\n                \"type\": \"steelblue\",\n                \"icon\": \"vlc.png\",\n                \"level\": \"red\"\n              }\n            ]\n          },\n          {\n            \"name\": \"Level 2: B\",\n            \"value\": 10,\n            \"type\": \"grey\",\n            \"icon\": \"random.png\",\n            \"level\": \"green\"\n          }\n        ]\n      };\n    \n\nIt’s possible to just have a single image and to hard-code it into the script,\nbut where’s the fun in that?\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/52945c64ab37f9f285c8797bcbf86d16) or\nin the code samples bundled with this book (tree-images.html, cart.png,\nearth.png, lettern.png, random.png and vlc.png). A working online example can\nbe found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/52945c64ab37f9f285c8797bcbf86d16).\n\n### Generating a tree diagram from external data\n\nIn all the examples we have looked at so far we have used data that we have\ndeclared from within the file itself. Being able to import data from an\nexternal file is an important feature that we need to know how to implement.\n\nStarting from the simple tree diagram example that we began with at the start\nof the chapter, the first change that we need to make is to remove the section\nof code that declares our data. But don’t throw it away since we will use it\nto create a separate file called `treeData.json`. Its contents will be;\n\n    \n    \n    {\n      \"name\": \"Top Level\",\n      \"children\": [\n        { \n          \"name\": \"Level 2: A\",\n          \"children\": [\n            { \"name\": \"Son of A\" },\n            { \"name\": \"Daughter of A\" }\n          ]\n        },\n        { \"name\": \"Level 2: B\" }\n      ]\n    }\n    \n\n(don’t include the `treeData =` part, or the semicolon at the end (you _can_\ndelete those))\n\nThen all we need to do is include a section that uses the `d3.json` accessor\nto load the file `treeData.json` (Remember to correctly address the file. This\none assumes that the `treeData.json` file is in the same directory as the html\nfile we are opening).\n\n    \n    \n    // load the external data\n    d3.json(\"treeData.json\", function(error, treeData) {\n      if (error) throw error;\n    \n\nWe can put it somewhere near the start of the JavaScript, but make sure it\ncomes before the ‘nodes’ declaration (when in doubt, check out the sample\ncode).\n\nWe also need to make sure that we include the wrapping, closing curly braces\nand bracket / semicolon (`});`) at the end of the script.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/d316a488cae262ae24e6ca897b209f9e) or\nin the code samples bundled with this book (tree-from-external.html and\ntreeData.json). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/d316a488cae262ae24e6ca897b209f9e).\n\n### Generating a tree diagram from ‘flat’ data\n\nTree diagrams are a fantastic way of displaying information, but one of the\ndrawbacks (to the examples we’ve been using so far) is the need to have your\ndata encoded hierarchically. Most data in a raw form will be flat. That is to\nsay, it won’t be formatted as an array with the parent - child relationships.\nInstead it will be a list of objects (which we will want to turn into nodes)\nthat might describe the relationship to each other, but they won’t be encoded\nthat way. For example, the following is the flat representation of the example\ndata we have been using thus far.\n\n    \n    \n      {\"name\": \"Top Level\", \"parent\": null}, \n      {\"name\": \"Level 2: A\", \"parent\": \"Top Level\" },\n      {\"name\": \"Level 2: B\", \"parent\": \"Top Level\" },\n      {\"name\": \"Son of A\", \"parent\": \"Level 2: A\" },\n      {\"name\": \"Daughter of A\", \"parent\": \"Level 2: A\" }\n    \n\nIt is actually fairly simple and consists of only the name of the node and the\nname of its parent node. It’s easy to see how this data could be developed\ninto a hierarchical form, but it would take a little time and for a larger\ndata set, that would be tiresome.\n\nLuckily computers are built for shuffling data about and with the advent of v4\nof d3.js we now have the `d3.stratify` operator that will convert flat data\ninto a hierarchy suitable for use in our tree diagram.\n\nWe will be using the simple example that we started with at the start of the\nchapter and the first change we need to make is to replace our original data…\n\n    \n    \n    var treeData =\n      {\n        \"name\": \"Top Level\",\n        \"children\": [\n          { \n    \t\t\"name\": \"Level 2: A\",\n            \"children\": [\n              { \"name\": \"Son of A\" },\n              { \"name\": \"Daughter of A\" }\n            ]\n          },\n          { \"name\": \"Level 2: B\" }\n        ]\n      };\n    \n\n… with our flat data array…\n\n    \n    \n    var flatData = [\n      {\"name\": \"Top Level\", \"parent\": null}, \n      {\"name\": \"Level 2: A\", \"parent\": \"Top Level\" },\n      {\"name\": \"Level 2: B\", \"parent\": \"Top Level\" },\n      {\"name\": \"Son of A\", \"parent\": \"Level 2: A\" },\n      {\"name\": \"Daughter of A\", \"parent\": \"Level 2: A\" }\n    ];\n    \n\nIt’s worth noting here that we have also changed the name of the array (to\n`flatData`) since we are going to convert, then declare our newly massaged\ndata with our original variable name `treeData` so that the remainder of our\ncode thinks there have been no changes.\n\nThen we use the `d3.stratify` operator on our flat data;\n\n    \n    \n    // convert the flat data into a hierarchy \n    var treeData = d3.stratify()\n      .id(function(d) { return d.name; })\n      .parentId(function(d) { return d.parent; })\n      (flatData);\n    \n\nThe stratify function requires a unique identifier to be used for each node\nand it will be declared as `.id`. In this example each of our nodes has a\nunique ‘name’, so we are using that as our `id` (`.id(function(d) { return\nd.name; })`). We also need to understand the hierarchy by having each node\nidentify who its parent is. This will be stored as `parentId`\n(`.parentId(function(d) { return d.parent; })`)\n\nThat’s it!\n\nBecause we want to be able to use our code as intact as possible from our\nhorizontal tree example we will want to run through our dataset and assign the\n‘name’ to each node that has been stored as `id`;\n\n    \n    \n    // assign the name to each node\n    treeData.each(function(d) {\n        d.name = d.id;\n      });\n    \n\nThat’s it!\n\nThe brevity of the code to do this is fantastic and well done to Mike Bostock\nfor including the new function in v4. Of course, the end result looks exactly\nthe same;\n\n![Tree diagram \\(but from flat data\\)](images/htree-01.png) Tree diagram (but\nfrom flat data)\n\n… but it adds a significant capability for use of additional data.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/e7e37cfe0e8763cb0915dee33cc2a24b) or\nin the code samples bundled with this book (tree-from-flat.html). A working\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/e7e37cfe0e8763cb0915dee33cc2a24b).\n\n### Generating a tree diagram from a CSV file.\n\nCreating a tree diagram from a csv file is an extension of the sections where\nwe [create a diagram from flat data](chap09.xhtml#treeFromFlat) and where we\n[create a diagram from an external file](chap09.xhtml#treeFromExternal).\n\nBy mashing these together and using a csv file something like the following…\n\n    \n    \n    name,parent\n    Top Level,null\n    Level 2: A,Top Level\n    Level 2: B,Top Level\n    Son of A,Level 2: A\n    Daughter of A,Level 2: A\n    \n\n… we can ingest the name of the nodes and their relationships and then format\nthe data correctly.\n\nThe main piece of code that we would add that is different from the standard\nhorizontal tree diagram is as follows;\n\n    \n    \n    // load the external data\n    d3.csv(\"treeCsv.csv\", function(error, flatData) {\n      if (error) throw error;\n    \n      // assign null correctly\n      flatData.forEach(function(d) {\n          if (d.parent == \"null\") { d.parent = null};\n        });\n    \n      // convert the flat data into a hierarchy \n      var treeData = d3.stratify()\n        .id(function(d) { return d.name; })\n        .parentId(function(d) { return d.parent; })\n        (flatData);\n    \n      // assign the name to each node\n      treeData.each(function(d) {\n          d.name = d.id;\n        });\n    \n\nThe only part of that code which is new is the portion where we look for the\nnode whose parent is ‘“null”’ and change it to null. This is necessary since\nthe script interprets the name as actually being the text ‘null’ so we have to\nforce the code to realise that we want it to refer to a null amount.\n\nThe end result looks very familiar.\n\n![Tree diagram \\(but from csv\\)](images/htree-01.png) Tree diagram (but from\ncsv)\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/https://gist.github.com/d3noob/1dbf3d4abe0ab53f8c4c6bd24192bb6b)\nor in the code samples bundled with this book (tree-from-csv.html and\ntreeCsv.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/1dbf3d4abe0ab53f8c4c6bd24192bb6b).\n\n### An interactive tree diagram\n\nThe examples presented thus far have all been static in the sense that they\npresent information on a web page, but that’s where they stop. One of the\nstrengths of web content is the ability to involve the reader to a greater\nextent. Therefore the following tree diagram example includes an interactive\nelement where the user can click on any parent node and it will collapse on\nitself to make more room for others or to simplify a view. Additionally, any\ncollapsed parent node can be clicked on and it will re-grow to its previous\ncondition.\n\nThe example included here has it’s roots in the is v3 tree diagram of [Mike\nBostock’s example](http://bl.ocks.org/mbostock/4339083). Kudos and thanks also\ngo out to Soumya Ranjan for steering me in the fight direction for the\ndiagonal solution. This was necessary to work around the deprecation of\n`svg.diagonal` in v3.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/43a860bc0024792f8803bba8ca0d5ecd), in\nthe appendices of this book or in the code samples bundled with this book\n(interactive-tree.html). A working online example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/43a860bc0024792f8803bba8ca0d5ecd).\n\nFor a brief visual description of the action. The diagram will initially\ndisplay a partially collapsed tree…\n\n![Partially collapsed tree diagram\\)](images/tree-10.png) Partially collapsed\ntree diagram)\n\nThen when clicking on the ‘Level 2: A’ node, the tree expands to…\n\n![Tree diagram\\)](images/htree-01.png) Tree diagram)\n\nWe could also click on the root node (`Top Level’) to fully collapse the tree…\n\n![Fully collapsed tree diagram\\)](images/tree-11.png) Fully collapsed tree\ndiagram)\n\nThen clicking on the nodes opens the diagram back up again.\n\nOne of the important changes is to allow the diagram to follow the d3.js model\nof enter - update - exit for the nodes with a suitable transition in between.\n\nNodes are coloured (“steelblue”) if they have been collapsed and at the end of\nthe script we have a function that makes use of the `d._children` reference we\nhave been using in most of our examples.\n\n    \n    \n    function click(d) {\n      if (d.children) {\n    \td._children = d.children;\n    \td.children = null;\n      } else {\n    \td.children = d._children;\n    \td._children = null;\n      }\n      update(d);\n    }\n    \n\nThis allows the action of clicking on the nodes to update the data associated\nwith the node and as a consequence change it’s properties in the script based\non if statements (Such as `\"fill\", function(d) { return d._children ?\n\"lightsteelblue\" : \"#fff\"; }` which will fill the node with “lightsteelblue”\nif `d._children` exists, otherwise make it white.)\n\nThe examples we have looked at in the previous sections in this chapter are\nall applicable to this interactive version, so this should provide you with\nthe capability to generate some interesting visualizations.\n\n\n## Sankey Diagrams\n\n### What is a Sankey Diagram?\n\nA Sankey diagram is a type of flow diagram where the ‘flow’ is represented by\narrows of varying thickness depending on the quantity of flow.\n\nThey are often used to visualize energy, material or cost transfers and are\nespecially useful in demonstrating proportionality to a flow where different\nparts of the diagram represent different quantities in a system.\n\nProbably the most famous example of a Sankey diagram is Charles Minard’s Map\nof Napoleon’s Russian Campaign of 1812.\n\n![Napoleon's Russian March](images/sankey01.png) Napoleon’s Russian March\n\nFrom Wikipedia;\n\n“ _Étienne-Jules Marey first called notice to this dramatic depiction of the\nfate of Napoleon’s army in the Russian campaign, saying it defies the pen of\nthe historian in its brutal eloquence. Edward Tufte says it “may well be the\nbest statistical graphic ever drawn” and uses it as a prime example in The\nVisual Display of Quantitative Information_.”\n\nWikipedia has a great explanation of the [diagram\ntype](http://en.wikipedia.org/wiki/Sankey_diagram) and there is a wealth of\ninformation dedicated to it on the inter-web. I heartily recommend\nhttp://www.sankey-diagrams.com/ for all things Sankey!\n\nSo it would come as little surprise that Mike Bostock has developed a plugin\nfor Sankey diagrams (http://bost.ocks.org/mike/sankey/) so that we can all\nenjoy Sankey goodness with lashings of D3.\n\n### Which Sankey plugin should we use?\n\nHmmmm…… Good question.\n\nAs at the time of writing there were 4 different sankey plugins listed on the\n[d3 wiki](https://github.com/d3/d3/wiki/Plugins) (including the vertical one).\nThe examples we will walk through have used the plugins from [Stefaan\nLippens](https://github.com/soxofaan/d3-plugin-captain-sankey) and [Jason\nDavies](https://github.com/d3/d3-plugins/tree/master/sankey) without problem.\nI have used the Jason Davies version for no other reason than it appears to be\nthe originator from which others have been derived.\n\n### How d3.js Sankey Diagrams want their data formatted\n\nIf we think of Sankey diagrams consisting of ‘nodes’ and ‘links’…\n\n![A simple Sankey diagram](images/sankey02.png) A simple Sankey diagram\n\n… the data that generates them must be formatted as nodes and links as well.\n\nFor instance a JSON file with appropriate data to build the diagram above\ncould look like the following;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"node\":0,\"name\":\"node0\"},\n    {\"node\":1,\"name\":\"node1\"},\n    {\"node\":2,\"name\":\"node2\"},\n    {\"node\":3,\"name\":\"node3\"},\n    {\"node\":4,\"name\":\"node4\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nIn the file above we have 6 nodes (0-5) sequentially numbered and with names\nappropriate to their position in the list.\n\nThe sequential numbering is only for the purpose of highlighting the structure\nof the data, since when we get D3 running, it will automatically index each of\nthe nodes according to its position. In other words, we could have omitted the\n“node”:n parts since D3 will know where each node is anyway. The big deal is\nthat _WE_ need to know what each node is as well. Especially if we’re going to\nbe building the data by hand (doing it dynamically would be cool, but let’s\nnot get ahead of ourselves just yet).\n\nThe ‘links’ part of the data can be broken down into individual source to\ntarget ‘links’ that have an associated value (could be a quantity or strength,\nbut at least a numeric value).\n\nThe ‘source’ and ‘target’ numbers are references to the list of nodes. So,\n“source”:1, “target”:2 means that this link is whatever node appears at\nposition 1 going to whatever node appears at position 2. The important point\nto make here is that D3 will not be interested in the numerical value of the\nnode, just its position in the list (starting at zero).\n\n### Description of the code\n\nThe code for the Sankey diagram is significantly different to that for a [line\ngraph](chap04.xhtml#simplegraph) although it shares the same core language and\nprogramming methodology.\n\nThe code we’ll go through is an adaptation of the [version first demonstrated\nby Mike Bostock](http://bost.ocks.org/mike/sankey/) so it’s got a pretty good\npedigree. We will begin with a version that uses data that is formatted so\nthat it can be used directly with no manipulation, then in subsequent sections\nwe will work on different techniques for getting data from different formats\n(and with different structures) to work.\n\nI found that getting data in the correct format was the biggest hurdle for\ngetting a Sankey diagram to work. We will start off assuming that the data is\nperfectly formatted, then where only the link data is available, then where\nthere is just names to work with (no numeric node values) and lastly, one that\ncan be used for people with changeable data from a MySQL database.\n\nWe won’t try to go over every inch of the code as we did with the [simple\ngraph example](chap04.xhtml#simplegraph) (I’ll skip things like the HTML\nheader) and will focus on the style sheet (CSS) portion and the JavaScript.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/013054e8d7807dff76247b81b0e29030) or\nin the code samples bundled with this book (sankey-formatted-json.html,\nsankey.js and sankey.json). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/013054e8d7807dff76247b81b0e29030).\n\nOn to the code…\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>SANKEY Experiment</title>\n    <style>\n    \n    .node rect {\n      cursor: move;\n      fill-opacity: .9;\n      shape-rendering: crispEdges;\n    }\n    \n    .node text {\n      pointer-events: none;\n      text-shadow: 0 1px 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #000;\n      stroke-opacity: .2;\n    }\n    \n    .link:hover {\n      stroke-opacity: .5;\n    }\n    \n    </style>\n    <body>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script src=\"sankey.js\"></script>\n    <script>\n    \t\n    var units = \"Widgets\";\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 10, right: 10, bottom: 10, left: 10},\n        width = 700 - margin.left - margin.right,\n        height = 300 - margin.top - margin.bottom;\n    \n    // format variables\n    var formatNumber = d3.format(\",.0f\"),    // zero decimal places\n        format = function(d) { return formatNumber(d) + \" \" + units; },\n        color = d3.scaleOrdinal(d3.schemeCategory20);\n    \n    // append the svg object to the body of the page\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Set the sankey diagram properties\n    var sankey = d3.sankey()\n        .nodeWidth(36)\n        .nodePadding(40)\n        .size([width, height]);\n    \n    var path = sankey.link();\n    \n    // load the data\n    d3.json(\"sankey.json\", function(error, graph) {\n    \n      sankey\n          .nodes(graph.nodes)\n          .links(graph.links)\n          .layout(32);\n    \n    // add in the links\n      var link = svg.append(\"g\").selectAll(\".link\")\n          .data(graph.links)\n        .enter().append(\"path\")\n          .attr(\"class\", \"link\")\n          .attr(\"d\", path)\n          .style(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n          .sort(function(a, b) { return b.dy - a.dy; });\n    \n    // add the link titles\n      link.append(\"title\")\n            .text(function(d) {\n        \t\treturn d.source.name + \" → \" + \n                    d.target.name + \"\\n\" + format(d.value); });\n    \n    // add in the nodes\n      var node = svg.append(\"g\").selectAll(\".node\")\n          .data(graph.nodes)\n        .enter().append(\"g\")\n          .attr(\"class\", \"node\")\n          .attr(\"transform\", function(d) { \n    \t\t  return \"translate(\" + d.x + \",\" + d.y + \")\"; })\n          .call(d3.drag()\n            .subject(function(d) {\n              return d;\n            })\n            .on(\"start\", function() {\n              this.parentNode.appendChild(this);\n            })\n            .on(\"drag\", dragmove));\n    \n    // add the rectangles for the nodes\n      node.append(\"rect\")\n          .attr(\"height\", function(d) { return d.dy; })\n          .attr(\"width\", sankey.nodeWidth())\n          .style(\"fill\", function(d) { \n    \t\t  return d.color = color(d.name.replace(/ .*/, \"\")); })\n          .style(\"stroke\", function(d) { \n    \t\t  return d3.rgb(d.color).darker(2); })\n        .append(\"title\")\n          .text(function(d) { \n    \t\t  return d.name + \"\\n\" + format(d.value); });\n    \n    // add in the title for the nodes\n      node.append(\"text\")\n          .attr(\"x\", -6)\n          .attr(\"y\", function(d) { return d.dy / 2; })\n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"end\")\n          .attr(\"transform\", null)\n          .text(function(d) { return d.name; })\n        .filter(function(d) { return d.x < width / 2; })\n          .attr(\"x\", 6 + sankey.nodeWidth())\n          .attr(\"text-anchor\", \"start\");\n    \n    // the function for moving the nodes\n      function dragmove(d) {\n        d3.select(this)\n          .attr(\"transform\", \n                \"translate(\" \n                   + d.x + \",\" \n                   + (d.y = Math.max(\n                      0, Math.min(height - d.dy, d3.event.y))\n                     ) + \")\");\n        sankey.relayout();\n        link.attr(\"d\", path);\n      }\n    });\n    \n    </script>\n    \n    </body>\n    \n\nSo, going straight to the style sheet bounded by the `<style>` tags;\n\n    \n    \n    .node rect {\n      cursor: move;\n      fill-opacity: .9;\n      shape-rendering: crispEdges;\n    }\n    \n    .node text {\n      pointer-events: none;\n      text-shadow: 0 1px 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #000;\n      stroke-opacity: .2;\n    }\n    \n    .link:hover {\n      stroke-opacity: .5;\n    }\n    \n\nThe CSS in this example is mainly concerned with formatting of the mouse\ncursor as it moves around the diagram.\n\nThe first part…\n\n    \n    \n    .node rect {\n      cursor: move;\n      fill-opacity: .9;\n      shape-rendering: crispEdges;\n    }\n    \n\n… provides the properties for the node rectangles. It changes the icon for the\ncursor when it moves over the rectangle to one that looks like it will move\nthe rectangle (there is a range of different icons that can be defined here\nhttp://www.echoecho.com/csscursors.htm), sets the fill colour to mostly opaque\nand keeps the edges sharp.\n\nThe next block…\n\n    \n    \n    .node text {\n      pointer-events: none;\n      text-shadow: 0 1px 0 #fff;\n    }\n    \n\n… sets the properties for the text at each node. The mouse is told to\nessentially ignore the text in favour of anything that’s under it (in the case\nof moving or highlighting something else) and a slight shadow is applied for\nreadability).\n\nThe following block…\n\n    \n    \n    .link {\n      fill: none;\n      stroke: #000;\n      stroke-opacity: .2;\n    }\n    \n\n… makes sure that the link has no fill (it actually appears to be a bendy\nrectangle with very thick edges that make the element appear to be a solid\nblock), colours the edges black (`#000`) and makes the edges almost\ntransparent.\n\nThe last block….\n\n    \n    \n    .link:hover {\n      stroke-opacity: .5;\n    }\n    \n\n… simply changes the opacity of the link when the mouse goes over it so that\nit’s more visible. If so desired, we could change the colour of the\nhighlighted link by adding in a line to this block changing the colour like\nthis `stroke: red;`.\n\nJust before we get into the JavaScript, we do something a little different for\nd3.js. We tells it to use a plug-in with the following line;\n\n    \n    \n    <script src=\"sankey.js\"></script>\n    \n\nThe concept of a plug-in is that it is a separate piece of code that will\nallow additional functionality to a core block (which in this case is d3.js).\nThere are a range of [plug-ins\navailable](https://github.com/d3/d3/wiki/Plugins) and we will need to source\nthe `sankey.js` file from [the\nrepository](https://github.com/d3/d3-plugins/tree/master/sankey) and place\nthat somewhere where our HTML code can access it. In this case I have put it\nin the same directory as the main sankey web page.\n\nThe start of our JavaScript begins by defining a range of variables that we’ll\nbe using.\n\nOur units are set as ‘Widgets’ (`var units = \"Widgets\";`), which is just a\nconvenient generic (nonsense) term to provide the impression that the flow of\nitems in this case is widgets being passed from one person to another.\n\nWe then set our canvas size and margins…\n\n    \n    \n    var margin = {top: 10, right: 10, bottom: 10, left: 10},\n        width = 700 - margin.left – margin.right,\n        height = 300 - margin.top – margin.bottom;\n    \n\n… before setting some formatting.\n\n    \n    \n    var formatNumber = d3.format(\",.0f\"),    // zero decimal places\n        format = function(d) { return formatNumber(d) + \" \" + units; },\n        color = d3.scaleOrdinal(d3.schemeCategory20);\n    \n\nThe `formatNumber` function acts on a number to set it to zero decimal places\nin this case. In the original Mike Bostock example it was to three places, but\nfor ‘widgets’ I’m presuming we don’t divide :-).\n\n`format` is a function that returns a given number formatted with\n`formatNumber` as well as a space and our units of choice (‘Widgets’). This is\nused to display the values for the links and nodes later in the script.\n\nThe `color = d3.scaleOrdinal(d3.schemeCategory20);` line is really interesting\nand provides access to a colour scale that is [pre-defined for your\nconvenience](https://github.com/d3/d3-scale/blob/master/README.md#schemeCategory20)!\nLater in the code we will see it in action.\n\nOur next block of code positions our svg element onto our page in relation to\nthe size and margins we have already defined;\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nThen we set the variables for our sankey diagram;\n\n    \n    \n    var sankey = d3.sankey()\n        .nodeWidth(36)\n        .nodePadding(40)\n        .size([width, height]);\n    \n\nWithout trying to state the obvious, this sets the width of the nodes\n(`.nodeWidth(36)`), the padding between the nodes (`.nodePadding(40)`) and the\nsize of the diagram(`.size([width, height]);`).\n\nThe following line defines the `path` variable as a pointer to the sankey\nfunction that makes the links between the nodes do their clever thing of\nbending into the right places;\n\n    \n    \n    var path = sankey.link();\n    \n\nI make the presumption that this is a defined function within `sankey.js`.\n\nThen we load the data for our sankey diagram with the following line;\n\n    \n    \n    d3.json(\"sankey.json\", function(error, graph) {\n    \n\nAs we have seen in previous usage of the `d3.json`, `d3.csv` and `d3.tsv`\nfunctions, this is a wrapper that acts on all the code within it bringing the\ndata in the form of `graph` to the remaining code.\n\nI think it’s a good time to take a slightly closer look at the data that we’ll\nbe using;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"node\":0,\"name\":\"node0\"},\n    {\"node\":1,\"name\":\"node1\"},\n    {\"node\":2,\"name\":\"node2\"},\n    {\"node\":3,\"name\":\"node3\"},\n    {\"node\":4,\"name\":\"node4\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nI want to look at the data now, because it highlights how it is accessed\nthroughout this portion of the code. It is split into two different blocks,\n‘nodes’ and ‘links’. The subset of variables available under ‘nodes’ is ‘node’\nand ‘name’. Likewise under ‘links’ we have ‘source’, ‘target’ and ‘value’.\nThis means that when we want to act on a subset of our data we define which\npiece by defining the hierarchy that leads to it. For instance, if we want to\ndefine an action for all the links, we would use graph.links (they’re kind of\nchained together).\n\nLet me take this opportunity to apologise to all those programmers who\n_actually_ know exactly what is going on here. It’s a mystery to me, but this\nis how I like to tell myself it works to help me get by :-).\n\nNow that we have our data loaded, we can assign the data to the sankey\nfunction so that it knows how to deal with it behind the scenes;\n\n    \n    \n      sankey\n          .nodes(graph.nodes)\n          .links(graph.links)\n          .layout(32);\n    \n\nIn keeping with our previous description of what’s going on with the data, we\nhave told the sankey function that the nodes it will be dealing with are in\n`graph.nodes` of our data structure.\n\nI’m not sure what the `.layout(32);` portion of the code does, but I’d be\ninterested to hear from any more knowledgeable readers. I’ve tried changing\nthe values to no apparent effect and googling has drawn a blank. Internally to\nthe `sankey.js` file it seems to indicate ‘iterations’ while it establishes\ncomputeNodeLinks, computeNodeValues, computeNodeBreadths, computeNodeDepths\n(iterations) and computeLinkDepths.\n\nThen we add our links to the diagram with the following block of code;\n\n    \n    \n      var link = svg.append(\"g\").selectAll(\".link\")\n          .data(graph.links)\n        .enter().append(\"path\")\n          .attr(\"class\", \"link\")\n          .attr(\"d\", path)\n          .style(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n          .sort(function(a, b) { return b.dy - a.dy; });\n    \n\nThis is an analogue of the block of code we examined way back in the section\nthat we covered in explaining the code of our first [simple\ngraph](chap04.xhtml#simplegraph).\n\nWe append svg elements for our links based on the data in `graph.links`, then\nadd in the paths (using the appropriate CSS). We set the stroke width to the\nwidth of the value associated with each link or ‘1’. Whichever is the larger\n(by virtue of the Math.max function). As an interesting sideline, if we force\nthis value to ‘10’ thusly…\n\n    \n    \n          .style(\"stroke-width\", 10)\n    \n\n… the graph looks quite interesting.\n\n![stroke-width 10 for Sankey links](images/sankey03.png) stroke-width 10 for\nSankey links\n\nThe sort function (`.sort(function(a, b) { return b.dy - a.dy; });`) makes\nsure the link for which the target has the highest y coordinate departs first\nout of the rectangle. Meaning if you have flows of 30,40,50 out of node 1,\nheading towards nodes 2, 3 and 4, with node 3 located above node 2 and that\nabove node 4, the outflow order from node 1 will be 40,50,30. This makes sure\nthere are a minimum of flow crosses. It’s slightly confusing and for a long\ntime it was a mystery (big thanks and kudos to ‘napicool’ who was able to\n[explain it on d3noob.org](http://www.d3noob.org/2013/02/formatting-data-for-\nsankey-diagrams-in.html).\n\nThe next block adds the titles to the links;\n\n    \n    \n      link.append(\"title\")\n            .text(function(d) {\n        \t\treturn d.source.name + \" → \" + \n                    d.target.name + \"\\n\" + format(d.value); });\n    \n\nThis code appends a text element to each link when moused over that contains\nthe source and target name (with a neat little arrow in between and the value)\nwhich, when applied with the `format` function, adds the units.\n\nThe next block appends the node objects (but not the rectangles or text) and\ncontains the instructions to allow them to be arranged with the mouse.\n\n    \n    \n      var node = svg.append(\"g\").selectAll(\".node\")\n          .data(graph.nodes)\n        .enter().append(\"g\")\n          .attr(\"class\", \"node\")\n          .attr(\"transform\", function(d) { \n    \t\t  return \"translate(\" + d.x + \",\" + d.y + \")\"; })\n          .call(d3.drag()\n            .subject(function(d) {\n              return d;\n            })\n            .on(\"start\", function() {\n              this.parentNode.appendChild(this);\n            })\n            .on(\"drag\", dragmove));\n    \n\nWhile it starts off in familiar territory with appending the node objects\nusing the `graph.nodes` data and putting them in the appropriate place with\nthe `transform` attribute, I can only assume that there is some trickery going\non behind the scenes to make sure the mouse can do what it needs to do with\nthe `d3.behaviour,drag` function. There is some excellent documentation on the\n[wiki](https://github.com/d3/d3-drag), but I can only presume that it knows\nwhat it’s doing :-). The `dragmove` function is laid out at the end of the\ncode, and we will explain how that operates later. Kudos for [this code\nportion](http://bl.ocks.org/syntagmatic/77c7f7e8802e8824eed473dd065c450b)\nshould go to @syntagmatic.\n\nI really enjoyed the next block;\n\n    \n    \n     node.append(\"rect\")\n          .attr(\"height\", function(d) { return d.dy; })\n          .attr(\"width\", sankey.nodeWidth())\n          .style(\"fill\", function(d) { \n    \t\t  return d.color = color(d.name.replace(/ .*/, \"\")); })\n          .style(\"stroke\", function(d) { \n    \t\t  return d3.rgb(d.color).darker(2); })\n        .append(\"title\")\n          .text(function(d) { \n    \t\t  return d.name + \"\\n\" + format(d.value); });\n    \n\nIt starts off with a fairly standard appending of a rectangle with a height\ngenerated by its value `{ return d.dy; }` and a width dictated by the\n`sankey.js` file to fit the area (`.attr(\"width\", sankey.nodeWidth())`).\n\nThen it gets interesting.\n\nThe colours are assigned in accordance with our earlier colour declaration and\nthe individual colours are added to the nodes by finding the first part of the\nname for each node and assigning it a colour from the palate (the script looks\nfor the first space in the name using a regular expression). For instance:\n‘Widget X’, ‘Widget Y’ and ‘Widget’ will all be coloured the same even if the\n‘Widget X’ and ‘Widget Y’ are inputs on the left and ‘Widget’ is a node in the\nmiddle.\n\nThe stroke around the outside of the rectangle is then drawn in the same\nshade, but `darker`. Then we return to the basics where we add the title of\nthe node in a tool tip type effect along with the value for the node.\n\nFrom here we add the titles for the nodes;\n\n    \n    \n      node.append(\"text\")\n          .attr(\"x\", -6)\n          .attr(\"y\", function(d) { return d.dy / 2; })\n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"end\")\n          .attr(\"transform\", null)\n          .text(function(d) { return d.name; })\n        .filter(function(d) { return d.x < width / 2; })\n          .attr(\"x\", 6 + sankey.nodeWidth())\n          .attr(\"text-anchor\", \"start\");\n    \n\nAgain, this looks pretty familiar. We position the text titles carefully to\nthe left of the nodes. All except for those affected by the filter function\n(`return d.x < width / 2;`). Where if the position of the node on the x axis\nis less than half the width, the title is placed on the right of the node and\nanchored at the start of the text. Very neat.\n\nThe last block is also pretty neat, and contains a little surprise for those\nwho are so inclined.\n\n    \n    \n      function dragmove(d) {\n        d3.select(this)\n          .attr(\"transform\", \n                \"translate(\" \n                   + d.x + \",\" \n                   + (d.y = Math.max(\n                      0, Math.min(height - d.dy, d3.event.y))\n                     ) + \")\");\n        sankey.relayout();\n        link.attr(\"d\", path);\n    \n\nThis declares the function that controls the movement of the nodes with the\nmouse. It selects the item that it’s operating over (`d3.select(this)`) and\nthen allows translation in the y axis while maintaining the link connection\n(`sankey.relayout(); link.attr(\"d\", path);`).\n\nBut that’s not the cool part. A quick look at the code should reveal that if\nyou can move a node in the y axis, there should be no reason why you can’t\nmove it in the x axis as well!\n\nSure enough, if you replace the code above with this…\n\n    \n    \n      function dragmove(d) {\n        d3.select(this).attr(\"transform\", \n            \"translate(\" + (\n                d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))\n            )\n            + \",\" + (\n                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))\n            ) + \")\");\n        sankey.relayout();\n        link.attr(\"d\", path);\n    \n\n… you can move your nodes anywhere on the canvas.\n\n![Move your nodes in x *and* y!](images/sankey04.png) Move your nodes in x\n_and_ y!\n\nI know it doesn’t seem to add anything to the diagram (in fact, it could be\nargued that there is a certain aspect of detraction) however, it doesn’t mean\nthat one day the idea doesn’t come in handy :-). You can see a live version on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3337957c360d55c245f6057ab0866c05).\n\n### Formatting data for Sankey diagrams\n\n#### From a JSON file with numeric link values\n\nAs explained in the [previous section](chap10.xhtml#sankeydata), data to form\na Sankey diagram needs to be a combination of nodes and links.\n\n    \n    \n    {\n    \"nodes\":[\n    {\"node\":0,\"name\":\"node0\"},\n    {\"node\":1,\"name\":\"node1\"},\n    {\"node\":2,\"name\":\"node2\"},\n    {\"node\":3,\"name\":\"node3\"},\n    {\"node\":4,\"name\":\"node4\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nAs we also noted earlier, the `\"node\"` entries in the `\"nodes\"` section of the\nJSON file are superfluous and are really only there for our benefit since D3\nwill automatically index the nodes starting at zero. As a test to check this\nout we can change our data to the following;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"name\":\"Barry\"},\n    {\"name\":\"Frodo\"},\n    {\"name\":\"Elvis\"},\n    {\"name\":\"Sarah\"},\n    {\"name\":\"Alice\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nThis will produce the following graph;\n\n![Sankey graph with names](images/sankey05.png) Sankey graph with names\n\nAs you can see, essentially the same, but with easier to understand names.\n\nAs you can imagine, while the end result is great, the creation of the JSON\nfile manually would be painful at best. Doing something similar but with a\ngreater number of nodes / links would be a nightmare.\n\nLet’s see if we can make the process a bit easier and more flexible.\n\n#### From a JSON file with links as names\n\nIt would make thing much easier, if you are building the data from hand, to\nhave nodes with names, and the ‘source’ and ‘target’ links to have those same\nname values as identifiers.\n\nIn other words a list of unique names for the nodes (and perhaps some details)\nand a list of the links between those nodes using the names for the nodes.\n\nSo, something like this;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"name\":\"Barry\"},\n    {\"name\":\"Frodo\"},\n    {\"name\":\"Elvis\"},\n    {\"name\":\"Sarah\"},\n    {\"name\":\"Alice\"}\n    ],\n    \"links\":[\n    {\"source\":\"Barry\",\"target\":\"Elvis\",\"value\":2},\n    {\"source\":\"Frodo\",\"target\":\"Elvis\",\"value\":2},\n    {\"source\":\"Frodo\",\"target\":\"Sarah\",\"value\":2},\n    {\"source\":\"Barry\",\"target\":\"Alice\",\"value\":2},\n    {\"source\":\"Elvis\",\"target\":\"Sarah\",\"value\":2},\n    {\"source\":\"Elvis\",\"target\":\"Alice\",\"value\":2},\n    {\"source\":\"Sarah\",\"target\":\"Alice\",\"value\":4}\n    ]}\n    \n\nOnce again, D3 to the rescue!\n\nThe little piece of code that can do this for us is here;\n\n    \n    \n        var nodeMap = {};\n        graph.nodes.forEach(function(x) { nodeMap[x.name] = x; });\n        graph.links = graph.links.map(function(x) {\n          return {\n            source: nodeMap[x.source],\n            target: nodeMap[x.target],\n            value: x.value\n          };\n        });\n    \n\nThis elegant solution comes from [Stack\nOverflow](http://stackoverflow.com/questions/14629853/json-representation-\nfor-d3-networks) and was provided by Chris Pettitt (nice job).\n\nSo if we sneak this piece of code into here…\n\n    \n    \n    d3.json(\"sankey-names.json\", function(error, graph) {\n    \n                //  <= Put the code here.\n    \n      sankey\n          .nodes(graph.nodes)\n          .links(graph.links)\n          .layout(32);\n    \n\n… and this time we use our JSON file with just names (sankey-names.json) and\nour new html file (sankey-formatted-names.html) we find our Sankey diagram\nworking perfectly!\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/d7800f34062b116f9ec0588f2e85e549) or\nin the code samples bundled with this book (sankey-formatted-names.html,\nsankey.js and sankey-names.json). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/d7800f34062b116f9ec0588f2e85e549).\n\n![Sankey graph with names again](images/sankey06.png) Sankey graph with names\nagain\n\nLooking at our new piece of code…\n\n    \n    \n        var nodeMap = {};\n        graph.nodes.forEach(function(x) { nodeMap[x.name] = x; });\n    \n\n… the first thing it does is create an object called `nodeMap` (The difference\nbetween an array and an object in JavaScript is one that is still a little\nblurry to me and judging from online comments, I am not alone).\n\nThen for each of the `graph.node` instances (where `x` is a range of numbers\nfrom 0 to the last node), we assign each node name to a number.\n\nThen in the next piece of code…\n\n    \n    \n        graph.links = graph.links.map(function(x) {\n          return {\n            source: nodeMap[x.source],\n            target: nodeMap[x.target],\n            value: x.value\n          };\n    \n\n… we go through all the links we have and for each link, we map the\nappropriate number to the correct name.\n\nVery clever.\n\n#### From a CSV with ‘source’, ‘target’ and ‘value’ info only.\n\nIn the first iteration of this section of the book I had no solution to\ncreating a Sankey diagram using a csv file as the source of the data.\n\nBut cometh the hour, cometh the man. Enter @timelyportfolio who, while\nclaiming no expertise in D3 or JavaScript was able to demonstrate a\n[solution](http://bl.ocks.org/timelyportfolio/5052095) to exactly the problem\nI was facing! Well done Sir! I salute you and name the technique the\ntimelyportfolio csv method!\n\nObservant readers will notice that there is a tiny difference between the\nsolution that timelyportfolio demonstrates (using d3.js v3) and the example\nbelow (using v4). Using v4 I found that I had to use `.object` when nesting\nthe data instead of `.map`.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/06e72deea99e7b4859841f305f63ba85) or\nin the code samples bundled with this book (sankey-formatted-csv.html,\nsankey.js and sankey.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/06e72deea99e7b4859841f305f63ba85).\n\nSo here’s the cleverness that @timelyportfolio demonstrated;\n\nUsing a csv file (in this case called `sankey.csv`) that looks like this;\n\n    \n    \n    source,target,value\n    Barry,Elvis,2\n    Frodo,Elvis,2\n    Frodo,Sarah,2\n    Barry,Alice,2\n    Elvis,Sarah,2\n    Elvis,Alice,2\n    Sarah,Alice,4\n    \n\nWe take this single line from our original Sankey diagram code;\n\n    \n    \n    d3.json(\"sankey-formatted.json\", function(error, graph) {\n    \n\nAnd replace it with the following block;\n\n    \n    \n    d3.csv(\"sankey.csv\", function(error, data) {\n     \n      //set up graph in same style as original example but empty\n      graph = {\"nodes\" : [], \"links\" : []};\n    \n      data.forEach(function (d) {\n        graph.nodes.push({ \"name\": d.source });\n        graph.nodes.push({ \"name\": d.target });\n        graph.links.push({ \"source\": d.source,\n                           \"target\": d.target,\n                           \"value\": +d.value });\n       });\n    \n      // return only the distinct / unique nodes\n      graph.nodes = d3.keys(d3.nest()\n        .key(function (d) { return d.name; })\n        .object(graph.nodes));\n    \n      // loop through each link replacing the text with its index from node\n      graph.links.forEach(function (d, i) {\n        graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);\n        graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);\n      });\n    \n      // now loop through each nodes to make nodes an array of objects\n      // rather than an array of strings\n      graph.nodes.forEach(function (d, i) {\n        graph.nodes[i] = { \"name\": d };\n      });\n    \n\nThe comments in the code (and they are fuller in @timelyportfolio’s [original\ngist solution](http://bl.ocks.org/timelyportfolio/5052095)) explain the\noperation;\n\n    \n    \n    d3.csv(\"sankey.csv\", function(error, data) {\n    \n\n… Loads the csv file from the data directory.\n\n    \n    \n      graph = {\"nodes\" : [], \"links\" : []};\n    \n\n… Declares `graph` to consist of two empty arrays called `nodes` and `links`.\n\n    \n    \n          data.forEach(function (d) {\n          graph.nodes.push({ \"name\": d.source });\n          graph.nodes.push({ \"name\": d.target });\n          graph.links.push({ \"source\": d.source,\n                             \"target\": d.target,\n                             \"value\": +d.value });\n         });\n    \n\n… Takes the `data` loaded with the csv file and for each row loads variables\nfor the `source` and `target` into the `nodes` array. Then for each row it\nloads variables for the `source` `target` and `value` into the `links` array.\n\n    \n    \n         graph.nodes = d3.keys(d3.nest()\n           .key(function (d) { return d.name; })\n           .object(graph.nodes));\n    \n\n… Is a routine that Mike Bostock described on [Google\nGroups](https://groups.google.com/forum/#!msg/d3-js/pl297cFtIQk/Eso4q_eBu1IJ)\nthat (as I understand it) nests each node name as a key so that it returns\nwith only unique nodes.\n\n    \n    \n         graph.links.forEach(function (d, i) {\n           graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);\n           graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);\n         });\n    \n\n… Goes through each `link` entry and, for each `source` and `target`, it finds\nthe unique index number of that name in the nodes array and assigns the link\nsource and target an appropriate number.\n\nAnd finally…\n\n    \n    \n         graph.nodes.forEach(function (d, i) {\n           graph.nodes[i] = { \"name\": d };\n         });\n    \n\n… Goes through each node and (in the words of @timelyportfolio) “ _make nodes\nan array of objects rather than an array of strings_ ” (I don’t really know\nwhat that means :-(. I just know it works :-).)\n\nThere you have it. A Sankey diagram from a csv file. Well played\n@timelyportfolio!\n\n\n## Assorted Tips and Tricks\n\n### Change a line chart into a scatter plot\n\nConfession time.\n\nIn the original book I didn’t actually intend to add in a section with a\nscatter plot in it for its own sake because I thought it would be;\n\n  1. tricky\n  2. not useful\n  3. all of the above\n\nI was wrong on all counts.\n\nI did want to have a scatter plot, because I wanted to display tool tips, but\nthis is too neat to ignore. It was literally a 5 minute job, 3 minutes of\nwhich was taken up by going to the [d3 gallery on the\nwiki](https://github.com/mbostock/d3/wiki/Gallery) and ogling at the cool\nstuff there before snapping out of it and going to the [scatter plot\nexample](http://bl.ocks.org/3887118) (that’s the v3 example by the way).\n\nAll we need to do is take the [simple graph](chap04.xhtml#simplegraph) example\nfile and slot the following block in between the ‘Add the valueline path’ and\nthe ‘add the x axis’ blocks.\n\n    \n    \n      // add the dots\n      svg.selectAll(\"dot\")\n         .data(data)\n         .enter().append(\"circle\")\n           .attr(\"r\", 5)\n           .attr(\"cx\", function(d) { return x(d.date); })\n           .attr(\"cy\", function(d) { return y(d.close); });\n    \n\nAnd we will get…\n\n![A scatter plot! \\(with a line\\)](images/scatter01.png) A scatter plot! (with\na line)\n\nThe full code for this graph can also be found on\n[github](https://gist.github.com/d3noob/2505b09d0feb51d0c9873cc486f10f67) or\nin the code samples bundled with this book (simple-scatterplot.html and\ndata.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/2505b09d0feb51d0c9873cc486f10f67).\n\nI deliberately put the dots _after_ the line in the drawing section, because I\nthought they would look better, but we could put the block of code before the\nline drawing block to get the following effect;\n\n![A scatter plot with the line in front of the dots](images/scatter02.png) A\nscatter plot with the line in front of the dots\n\n(just trying to reinforce the concept that ‘order’ matters when drawing\nobjects :-)).\n\nWe could of course just remove the line block all together…\n\n![A scatter plot without the line this time](images/scatter03.png) A scatter\nplot without the line this time\n\nBut in my humble opinion it loses something.\n\nSo what do the individual lines in the scatter plot block of JavaScript do?\n\nThe first line (`svg.selectAll(\"dot\")`) essentially provides a suitable group\nlabel for the svg circle elements that will be added. The next line associates\nthe range of data that we have to the group of elements we are about to add\nin.\n\nThen we add a circle for each data point (`.enter().append(\"circle\")`) with a\nradius of 5 pixels (`.attr(\"r\", 5)`) and appropriate x (`.attr(\"cx\",\nfunction(d) { return x(d.date); })`) and y (`.attr(\"cy\", function(d) { return\ny(d.close); });`) coordinates.\n\nThere is lots more that we could be doing with this piece of code including\nvarying the colour or size or opacity of the circles depending on the data and\nall sorts of really neat things, but for the mean time, there we go. Scatter\nplot!\n\n### Adding tooltips.\n\nTooltips have a marvellous duality. They are on one hand a pretty darned\nuseful thing that aids in giving context and information where required and on\nthe other hand, if done with a bit of care, they can look very stylish :-).\n\nTechnically, they represent a slight deviation from what we have been playing\nwith so far into a mildly more complex arena of ‘transitions’ and ‘events’.\nYou will probably regard this one of two ways. Either accepting that it just\nworks and using it as shown, or you will actually know what’s going on in\nwhich case feel free to deride my efforts as those of a rank amateur :-).\n\nThe original (d3.js v3) source for the implementation was taken from Mike\nBostock’s example on [bl.ocks.org](http://bl.ocks.org/1087001). This was\ncombined with a few other bit’s and pieces (the trickiest being working out\nhow to format the displayed date correctly and inserting a line break in the\ntooltip (which I found on [Google\nGroups](https://groups.google.com/forum/?fromgroups=#!topic/d3-js/GgFTf24ltjc);\n(well done to all those participating in that discussion)). I make the\nassumption that any or all errors that occur in the implementation will be\nmine, whereas, any successes will be down to the original contributors.\n\nJust in case there is some confusion, a tooltip (one word or two?) is a\ndiscrete piece of information that will pop into view when the mouse hovers\nover somewhere specific. Most of us have seen and used them, but I suppose we\nall tend to call them different things such as ‘infotip’, ‘hint’ or ‘hover\nbox’ I don’t know if there’s a right name for them, but here’s an example of\nwhat we’re trying to achieve;\n\n![A tooltip magically appears over a dot](images/tips01.png) A tooltip\nmagically appears over a dot\n\nWe can see the mouse has hovered over one of the scatter plot circles and a\ntip has appeared that provides us with the exact date and value for that\npoint.\n\nWe can also notice that there’s a certain degree of ‘fancy’ here as the\ninformation is bound by a rectangular shape with rounded corners and a slight\nopacity. The other piece of ‘fancy’ which you don’t see in a PDF (or whatever\nformat this distinguished tome will be published in on its 33rd reprint in the\nyear 2034), is that when these tool tips appear and disappear, they do so in\nan elegant fade-in, fade-out way. Pretty!\n\nBefore we get started describing how the code goes together, let’s take a\nquick look at the two technique specifics that I mentioned earlier,\n‘transitions’ and ‘events’.\n\n#### Transitions\n\nFrom the main d3.js web page (d3js.org) transitions are described as gradually\ninterpolating styles and attributes over time. So what I take that to mean is\nthat if you want to change an object, you can do so by simply specifying the\nattribute / style end point that you want it to end up with and the time you\nwant it to take and go!\n\nOf course, it’s not quite that simple, but luckily, smarter people than I have\ndone some fantastic work describing different aspects of transitions so please\nsee the following for a more complete description of the topic;\n\n  * Mike Bostock’s [Transition tutorial](https://bost.ocks.org/mike/transition/)\n  * Christophe Viau’s [‘Try D3 Now!’ tutorial](http://christopheviau.com/d3_tutorial/)\n\nHopefully observing the mouseover and mouseout transitions in the tooltips\nexample will whet your appetite for more!\n\n#### Events\n\nThe other technique is related to mouse ‘events’. This describes the browser\nwatching for when ‘something’ happens with the mouse on the screen and when it\ndoes, it takes a specified action. A (probably non-comprehensive) list of the\ntypes of events are the following;\n\n  * mousedown: Triggered by an element when a mouse button is pressed down over it\n  * mouseup: Triggered by an element when a mouse button is released over it\n  * mouseover: Triggered by an element when the mouse comes over it\n  * mouseout: Triggered by an element when the mouse goes out of it\n  * mousemove: Triggered by an element on every mouse move over it.\n  * click: Triggered by a mouse click: mousedown and then mouseup over an element\n  * contextmenu: Triggered by a right-button mouse click over an element.\n  * dblclick: Triggered by two clicks within a short time over an element\n\nHow many of these are valid to use within d3 I’m not sure, but I’m willing to\nbet that there are probably more than those here as well. Please go to\n<http://javascript.info/tutorial/mouse-events> for a far better description of\nthe topic if required.\n\n#### Get tipping\n\nSo, bolstered with a couple of new concepts to consider, let’s see how they\nare enacted in practice.\n\nThe full code for this graph can also be found on\n[github](https://gist.github.com/d3noob/257c360b3650b9f0a52dd8257d7a2d73) or\nin the code samples bundled with the book (simple-tooltips.html and data.csv).\nA live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/257c360b3650b9f0a52dd8257d7a2d73).\n\nIf we start with our simple-scatter plot graph there are 4 areas in it that we\nwill want to modify (it may be easier to check the simple-tooltips.html file\nin the code samples bundled with this book).\n\nThe first area is the CSS. The following code should be added just before the\n`</style>` tag;\n\n    \n    \n    div.tooltip {\n      position: absolute;\n      text-align: center;\n      width: 60px;\n      height: 28px;\n      padding: 2px;\n      font: 12px sans-serif;\n      background: lightsteelblue;\n      border: 0px;\n      border-radius: 8px;\n      pointer-events: none;\n    }\n    \n\nThese styles are defining how our tooltip will appear . Most of them are\nfairly straight forward. The position of the tooltip is done in absolute\nmeasurements, not relative. The text is centre aligned, the height, width and\ncolour of the rectangle is `28px`, `60px` and `lightsteelblue` respectively.\nThe ‘padding’ is an interesting feature that provides a neat way to grow a\nshape by a fixed amount from a specified size.\n\nWe set the border to `0px` so that it doesn’t show up and a neat style\n(attribute?) called `border-radius` provides the nice rounded corners on the\nrectangle.\n\nLastly, but by no means least, the `pointer-events: none` line is in place to\ninstruct the mouse event to go ‘through’ the element and target whatever is\n‘underneath’ that element instead (Read more\n[here](https://developer.mozilla.org/en-US/docs/CSS/pointer-events)). That\nmeans that even if the tooltip partly obscures the circle, the code will still\nact as if the mouse is only over the circle.\n\nThe second addition is a simple one-liner that should (for forms sake) be\nplaced under the `parseTime` variable declaration;\n\n    \n    \n    var formatTime = d3.timeFormat(\"%e %B\");\n    \n\nThis line formats the date when it appears in our tooltip. Without it, the\ntime would default to a disturbingly long combination of temporal details. In\nthe case here we have declared that we want to see the day of the month (`%e`)\nand the full month name(`%B`).\n\nThe third block of code is the function declaration for ‘div’.\n\n    \n    \n    var div = d3.select(\"body\").append(\"div\")\n        .attr(\"class\", \"tooltip\")\n        .style(\"opacity\", 0);\n    \n\nWe can place that just after the `valueline` definition in the JavaScript.\nAgain there’s not too much here that’s surprising. We tell it to attach a\n`div` element to the body element, we set the class to the tooltip class (from\nthe CSS) and we set the opacity to zero. It might sound strange to have the\nopacity set to zero, but remember, that’s the natural state of a tooltip. It\nwill live unseen until it’s moment of revelation arrives and it pops up!\n\nThe final block of code is slightly more complex and could be described as a\nmutant version of the neat little bit of code that we used to do the drawing\nof the dots for the scatter plot. That’s because the tooltips are all about\nthe scatter plot circles. Without a circle to ‘mouseover’, the tooltip never\nappears :-).\n\nSo here’s the code that includes the scatter plot drawing (it’s included since\nit’s pretty much integral);\n\n    \n    \n      // add the dots with tooltips\n      svg.selectAll(\"dot\")\n         .data(data)\n       .enter().append(\"circle\")\n         .attr(\"r\", 5)\n         .attr(\"cx\", function(d) { return x(d.date); })\n         .attr(\"cy\", function(d) { return y(d.close); })\n         .on(\"mouseover\", function(d) {\n           div.transition()\n             .duration(200)\n             .style(\"opacity\", .9);\n           div.html(formatTime(d.date) + \"<br/>\" + d.close)\n             .style(\"left\", (d3.event.pageX) + \"px\")\n             .style(\"top\", (d3.event.pageY - 28) + \"px\");\n           })\n         .on(\"mouseout\", function(d) {\n           div.transition()\n             .duration(500)\n             .style(\"opacity\", 0);\n           });\n    \n\nThe first six lines of the code are a repeat of the scatter plot drawing\nscript. The only changes are that we’ve removed the semicolon from the `cy`\nattribute line since the code now has to carry on.\n\nSo the additions are broken into two areas that correspond to the two events.\n`mouseover` and `mouseout`. When the mouse moves over any of the circles in\nthe scatter plot, the mouseover code is executed on the `div` element. When\nthe mouse is moved off the circle a different set of instructions are\nexecuted.\n\n### There is only one!\n\nIt would be a mistake to think of tooltips in the plural because there aren’t\na whole series of individual tooltips just waiting to appear for their\nspecific circle. There is only one tooltip that will appear when the mouse\nmoves over a circle. And depending on what circle it’s over, the properties of\nthe tooltip will alter slightly (in terms of its position and contents).\n\n#### on.mouseover\n\nThe `.on(\"mouseover\"` line initiates the introduction of the tooltip. Then we\ndeclare the element we will be introducing (‘`div`’) and that we will be\napplying a transition to its introduction (`.transition()`). The next two\nlines describe the transition. It will take 200 milliseconds\n(`.duration(200)`) and will result in changing the element’s opacity to .9\n(`.style(\"opacity\", .9);`). Given that the natural state of our tooltip is an\nopacity of 0, this make sense for something appearing, but it doesn’t go all\nthe way to a solid object and it retains a slight transparency just to make it\nlook less permanent.\n\nThe following three lines format our tooltip. The first one adds an html\nelement that contains our x and y information (the `date` and the `close`\nvalue). Now this is done in a slightly strange way. Other tooltips that I have\nseen have used a ‘`.text`’ element instead of a ‘`.html`’ one, but I have used\n‘`.html`’ in this case because I wanted to include the line break tag `<br/>`\nto separate the date and value. I’m sure there are other ways to do it, but\nthis worked for me. The other interesting part of this line is that this is\nwhere we call our time formatting function that we described earlier. The next\ntwo lines position the tooltip on the screen and to do this they grab the x\nand y coordinates of the mouse when the event takes place (with the\n`d3.event.pageX` and `d3.event.pageY` snippets) and apply a correction in the\ncase of the y coordinate to raise the tooltip up by the same amount as its\nheight (28 pixels).\n\n#### on.mouseout\n\nThe `.on(\"mouseout\"` section is slightly simpler in that it doesn’t have to do\nany fancy text / html / coordinate stuff. All it has to do is to fade out the\n‘div’ element. And that is done by simply reversing the opacity back to 0 and\nsetting the duration for the transition to 500 milliseconds (being slightly\nlonger than the fade-in makes it look slightly cooler IMHO).\n\nRight, there you go. As a description it’s ended up being a bit of a wall of\ntext I’m afraid. But hopefully between the explanation and the example code\nyou will get the idea. Please take the time to fiddle with the settings\ndescribed here to find the ones that work for you and in the process you will\nreinforce some of the principles that help D3 do its thing.\n\n#### Including an HTML link in a tool tip\n\nThere was an interesting question on\n[d3noob.org](http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html)\nabout adding an HTML link to a tooltip. While the person asking the question\nhad the problem pretty much solved already, I thought it might be useful for\nothers.\n\nThe premise is that you want to add a tool tip to your visualization using the\nmethod described here, but you also want to include an HTML link in the\ntooltip that will link somewhere else. This might look a little like the\nfollowing;\n\n![Tool tip with an HTML Link](images/tool-01.png) Tool tip with an HTML Link\n\nIn the image above the date has been turned into a link. In this case the link\ngoes to google.com, but that can obviously be configurable.\n\nThe full code for this example can be found on\n[github](https://https://gist.github.com/d3noob/036d13e5173de69f7758091ba9a2df2b)\nor in the code samples bundled with this book (simple-tooltips-link.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/036d13e5173de69f7758091ba9a2df2b).\n\nThere are a few changes that we would want to make to our original tooltip\ncode to implement this feature.\n\nFirst of all, we’ll add the link to the date element. Adding an HTML link can\nbe as simple as wrapping the ‘thing’ to be used as a link in [`<a>`\ntags](http://www.w3schools.com/tags/tag_a.asp) with an appropriate URL to go\nto.\n\nThe following adaptation of the code that prints the information into our\ntooltip code does just that;\n\n    \n    \n           div .html(\n             '<a href= \"http://google.com\">' + // The first <a> tag\n             formatTime(d.date) +\n             \"</a>\" +                          // closing </a> tag\n             \"<br/>\"  + d.close)     \n             .style(\"left\", (d3.event.pageX) + \"px\")             \n             .style(\"top\", (d3.event.pageY - 28) + \"px\");\n    \n\n`<a href= \"http://google.com\">` places our first `<a>` tag and declares the\nURL and the second tag follows after the date.\n\nThe second change we will want to make is to ensure that the tooltip stays in\nplace long enough for us to actually click on the link. The problem being\nsolved here is that our original code relies on the mouse being over the dot\non the graph to display the tooltip. if the tooltip is displayed and the\ncursor moves to press the link, it will move off the dot on the graph and the\ntooltip vanishes (Darn!).\n\nTo solve the problem we can leave the tooltip in place adjacent to a dot while\nthe mouse roams freely over the graph until the next time it reaches a dot and\nthen the previous tooltip vanishes and a new one appears. The best way to\nappreciate this difference is to check out the live example on\n[bl.ocks.org](http://bl.ocks.org/d3noob/036d13e5173de69f7758091ba9a2df2b).\n\nThe code is as follows (you may notice that this also includes the link as\ndescribed above);\n\n    \n    \n      // add the dots with tooltips\n      svg.selectAll(\"dot\")\n         .data(data)\n       .enter().append(\"circle\")\n         .attr(\"r\", 5)\n         .attr(\"cx\", function(d) { return x(d.date); })\n         .attr(\"cy\", function(d) { return y(d.close); })\n         .on(\"mouseover\", function(d) {\n           div.transition()\n             .duration(200)\n             .style(\"opacity\", .9);\n           div .html(\n             '<a href= \"http://google.com\">' + // The first <a> tag\n             formatTime(d.date) +\n             \"</a>\" +                          // closing </a> tag\n             \"<br/>\"  + d.close)     \n             .style(\"left\", (d3.event.pageX) + \"px\")             \n             .style(\"top\", (d3.event.pageY - 28) + \"px\");\n           });\n    \n\nWe have removed the `.on(\"mouseout\"` portion and moved the function that it\nused to carry out to the start of the `.on(\"mouseover\"` portion. That way the\nfirst thing that occurs when the mouse cursor moves over a dot is that it\nremoves the previous tooltip and then it places the new one.\n\nThe last change we need to make is to remove from the `<style>` section the\nline that told the mouse to ignore the tooltip;\n\n    \n    \n        pointer-events: none;   /* This line needs to be removed */\n    \n\n##### Moar Links!\n\nOne link is interesting, but let’s face it, we didn’t go to all the trouble of\nputting a link into a tool tip to just go to one location. Now we shift it up\na gear and start linking to different places depending on our data. At the\nsame time (and because someone asked) we will make the link open in a new tab!\n\nThe changes to the script are fairly minor, but one fairly large change is the\nneed to have links to go to. For this example I have added a range of links to\nvisit to our csv file so it now looks like this;\n\n    \n    \n    date,close,link\n    1-May-12,58.13,http://bl.ocks.org/d3noob/c37cb8e630aaef7df30d\n    30-Apr-12,53.98,http://bl.ocks.org/d3noob/11313583\n    27-Apr-12,67.00,http://bl.ocks.org/d3noob/11306153\n    26-Apr-12,89.70,http://bl.ocks.org/d3noob/11137963\n    25-Apr-12,99.00,http://bl.ocks.org/d3noob/10633856\n    24-Apr-12,130.28,http://bl.ocks.org/d3noob/10633704\n    23-Apr-12,166.70,http://bl.ocks.org/d3noob/10633421\n    20-Apr-12,234.98,http://bl.ocks.org/d3noob/10633192\n    19-Apr-12,345.44,http://bl.ocks.org/d3noob/10632804\n    18-Apr-12,443.34,http://bl.ocks.org/d3noob/9692795\n    17-Apr-12,543.70,http://bl.ocks.org/d3noob/9267535\n    16-Apr-12,580.13,http://bl.ocks.org/d3noob/9211665\n    13-Apr-12,605.23,http://bl.ocks.org/d3noob/9167301\n    12-Apr-12,622.77,http://bl.ocks.org/d3noob/8603837\n    11-Apr-12,626.20,http://bl.ocks.org/d3noob/8375092\n    10-Apr-12,628.44,http://bl.ocks.org/d3noob/8329447\n    9-Apr-12,636.23,http://bl.ocks.org/d3noob/8329404\n    5-Apr-12,633.68,http://bl.ocks.org/d3noob/8150631\n    4-Apr-12,624.31,http://bl.ocks.org/d3noob/8273682\n    3-Apr-12,629.32,http://bl.ocks.org/d3noob/7845954\n    2-Apr-12,618.63,http://bl.ocks.org/d3noob/6584483\n    30-Mar-12,599.55,http://bl.ocks.org/d3noob/5893649\n    29-Mar-12,609.86,http://bl.ocks.org/d3noob/6077996\n    28-Mar-12,617.62,http://bl.ocks.org/d3noob/5193723\n    27-Mar-12,614.48,http://bl.ocks.org/d3noob/5141528\n    26-Mar-12,606.98,http://bl.ocks.org/d3noob/5028304\n    \n\nThe code change is to the piece of JavaScript where we add the HTML. This is\nwhat we end up with;\n\n    \n    \n        div .html(\n            '<a href= \"'+d.link+'\" target=\"_blank\">' + //with a link\n            formatTime(d.date) +\n            \"</a>\" +\n            \"<br/>\"  + d.close)     \n            .style(\"left\", (d3.event.pageX) + \"px\")             \n            .style(\"top\", (d3.event.pageY - 28) + \"px\");\n    \n\nWe’ve replaced the URL `http://google.com` with the variable for our `link`\ncolumn `d.link` and we’ve also added in the `target=\"_blank\"` statement so\nthat our link opens in a new tab.\n\nA quick word of warning on this piece of code. it can look a little messy\nbecause it includes nested speech-marks and quotation marks. This makes it a\nbit confusing if you’re unused to the idea of nesting this type of\ninformation. If things aren’t working in this part of your code, I recommend\ngoing back to basics and adding one piece at a time, getting it right and then\nadd the next piece. Take it slow :-).\n\nThe full code for this multi link example can be found on\n[github](https://gist.github.com/d3noob/a04a5897a92c046563017c7590f0c12c) or\nin the code samples bundled with this book (tooltips-link-multi.html and data-\nlink.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/a04a5897a92c046563017c7590f0c12c).\n\nHopefully that helps people with a similar desire to include links in their\ntooltips. Many thanks to the reader who suggested it :-).\n\n### What are the predefined, named colours?\n\nThroughout this document I generally use colours defined by name. This is\nmainly because I can, and not for any other reason. In fact there several\ndifferent ways to define colours used in D3 / JavaScript / CSS and HTML. I\nhave no idea what the limitations for use are and / or how their use in\ndifferent browsers impacts on correct representation. But I do know that\nthey’re used widely.\n\nThere seem to be several different standards for what constitutes an\nauthoritative list of named colours. After a cursory search I was able to find\na great list on\n[about.com](http://webdesign.about.com/od/colorcharts/l/bl_namedcolors.htm)\nand there are some nice representations on\n[Wikipedia](http://en.wikipedia.org/wiki/Web_colors#X11_color_names).\n\nThe overriding point of all this is that there’s more than one way to define\ncolours in your graphs.\n\nIt means that considering… `.style(\"fill\", \"steelblue\")`  \nand…  \n`.style(\"fill\", \"#4682b4\")`  \nand…  \n`.style(\"fill\", \"rgb(70,130,180)\")`\n\nAll three alternatives result in the same colour being applied.\n\nFor a long time I didn’t actually have the images of the colours represented\nhere in D3 Tips and Tricks, but like all things, one day I thought ‘Hey, I\ncould just write a simple script that placed them on the screen’. So here they\nare :-).\n\nI have tried to group them as ‘like’ colours per the entry in Wikipedia.\n\n![](images/colour-01.png) ![](images/colour-02.png) ![](images/colour-03.png)\n![](images/colour-04.png) ![](images/colour-05.png) ![](images/colour-06.png)\n![](images/colour-07.png) ![](images/colour-08.png) ![](images/colour-09.png)\n![](images/colour-10.png) ![](images/colour-11.png) ![](images/colour-12.png)\n![](images/colour-13.png) ![](images/colour-14.png) ![](images/colour-15.png)\n![](images/colour-16.png) ![](images/colour-17.png) ![](images/colour-18.png)\n![](images/colour-19.png) ![](images/colour-20.png) ![](images/colour-21.png)\n![](images/colour-22.png) ![](images/colour-23.png) ![](images/colour-24.png)\n![](images/colour-25.png) ![](images/colour-26.png) ![](images/colour-27.png)\n![](images/colour-28.png) ![](images/colour-29.png) ![](images/colour-30.png)\n![](images/colour-31.png) ![](images/colour-32.png) ![](images/colour-33.png)\n![](images/colour-34.png) ![](images/colour-35.png) ![](images/colour-36.png)\n![](images/colour-37.png) ![](images/colour-39.png) ![](images/colour-40.png)\n![](images/colour-41.png) ![](images/colour-42.png) ![](images/colour-43.png)\n![](images/colour-44.png) ![](images/colour-45.png) ![](images/colour-46.png)\n![](images/colour-47.png)\n\nYou can also see a live page with the script that produces the rectangles at\n[bl.ocks.org](http://bl.ocks.org/d3noob/11313583).\n\n### Selecting / filtering a subset of objects\n\nImagine a scenario where you want to select (or should we say **filter**) a\nparticular range of objects from a larger set.\n\nFor example, what if we wanted to use our scatter plot example to show the\nline as normal, but we are particularly interested in the points where the\nvalues of the points fall below 400. Therefore, when the value falls below 400\nwe want them highlighted with a circle as we have done with *the scatter plot\npoints previously.\n\nSo that we end up with something that looks a little like this…\n\n![Only the points below 400 are selected](images/filter01.png) Only the points\nbelow 400 are selected\n\nErr… Yes, for those among you who are of the observant persuasion, I have\ndeliberately coloured them red as well (red for **DANGER**!).\n\nThis is a fairly simple example, but serves to illustrate the principle\nadequately. From our simple scatter plot example we only need to add in two\nlines to the block of code that draws the circles as follows;\n\n    \n    \n      // Add the scatterplot\n      svg.selectAll(\"dot\")\n          .data(data)\n        .enter().append(\"circle\")\n          .filter(function(d) { return d.close < 400 })  // <== This line\n          .style(\"fill\", \"red\")                          // <== and this one\n          .attr(\"r\", 5)\n          .attr(\"cx\", function(d) { return x(d.date); })\n          .attr(\"cy\", function(d) { return y(d.close); });\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/47b319ec0250b4063063942c64f0f949) or\nin the code samples bundled with this book (filter-selection.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/47b319ec0250b4063063942c64f0f949).\n\nThe first added line uses the `.filter` function to act on the data points and\naccording to the arguments passed to it in this case, only return those where\nthe value of d.close is less than 400 (`return d.close < 400`).\n\nThe second added line simply colours the circles red (`.style(\"fill\",\n\"red\")`).\n\nThat’s all there is to it. Pretty simple, but the filter function can be very\npowerful when used wisely.\n\n### Select items with an IF statement.\n\nThe [filtering – selection section](chap11.xhtml#filtering) above is a good\nway to adapt what you see on a graph, but so is a more familiar friend… The\n‘if’ statement.\n\nAn ‘if’ statement will act to carry out a task in a particular way dependant\non a condition that you specify.\n\nHere’s an example, what if we wanted to show our scatter plot as normal, but\nall those with a ‘close’ value less than 400 should be coloured red. Sound\nfamiliar? Yes, I know it’s similar to the example above, with the subtle\ndifference that it is leaving the circles above 400 in place (more on that to\nfollow).\n\nStarting with the [simple scatter plot](chap11.xhtml#scatterplot) example all\nwe have to do is include the if statement in the block of code that draws the\ncircles. Here’s the entire block with the additions highlighted;\n\n    \n    \n      // Add the scatterplot\n      svg.selectAll(\"dot\")\n          .data(data)\n        .enter().append(\"circle\")\n          .attr(\"r\", 5)\n          .style(\"fill\", function(d) {            // <== Add these\n              if (d.close <= 400) {return \"red\"}  // <== Add these\n              else { return \"black\" }             // <== Add these\n          ;})                                     // <== Add these\n          .attr(\"cx\", function(d) { return x(d.date); })\n          .attr(\"cy\", function(d) { return y(d.close); });\t\n    \n\nOur first added line introduces the style modifier and the rest of the code\nacts to provide a return for the ‘fill’ attribute.\n\nThe second line introduces our if statement. There’s very little difference\nusing `if` statements between languages. Just look out for maintaining the\ncorrect syntax and you should be fine. In this case we’re asking if the value\nof ‘d.close’ is less than or equal to 400 and if it is it will return the\n`\"red\"` statement for our fill.\n\nThe third line covers our rear and make sure that if the colour isn’t going to\nbe red, it’s going to be black. The last line just closes the style and\nfunction statements.\n\nThe result?\n\n![Points above 400 black and points below 400 red](images/if01.png) Points\nabove 400 black and points below 400 red\n\nAww….. nice.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/491c32149571faef2750632d4620e7ce) or\nin the code samples bundled with this book (if-selection.html and data.csv). A\nworking example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/491c32149571faef2750632d4620e7ce).\n\nCould it be any cooler? I’m glad you asked.\n\nWhat if we wanted to have all the points where close was less than 400 red and\nall those where close was greater than 620 green? Oh yeah! Now we’re talking.\n\nSo with one small change to the if statement;\n\n    \n    \n          .style(\"fill\", function(d) {   \n             if (d.close <= 400) {return \"red\"}  \n             else if (d.close >= 620) {return \"lawngreen\"} // <== Right here \n             else { return \"black\" }  \n          ;})  \t\n    \n\nCheck it out…\n\n![Points coloured differently depending on their value](images/if02.png)\nPoints coloured differently depending on their value\n\nNice.\n\n### Applying a colour gradient to a line based on value.\n\nI know that we were impressed with the changing dots in a scatter plot based\non the value. But could we go one better?\n\nHow about we try to reproduce the same effect but by varying the colour of the\nplotted line. This is a neat feature and a useful example of the flexibility\nof d3.js and SVG in general. I used the appropriate bits of code from Mike\nBostock’s [Threshold Encoding example](http://bl.ocks.org/3970883). And I\nshould take the opportunity to heartily recommend browsing through his\ncollection of examples on [bl.ocks.org](http://bl.ocks.org/mbostock).\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/d3a22ef27b253ab8d49e97699a8e84b1) or\nin the code samples bundled with this book (line-graph-gradient.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/d3a22ef27b253ab8d49e97699a8e84b1).\n\nHere then is a plotted line that is red below 400, green above 620 and black\nin between.\n\n![Line colour varied with gradient](images/gradientline01.png) Line colour\nvaried with gradient\n\nHow cool is that?\n\nEnough beating around the bush, how is the magic line produced?\n\nStarting with our [simple line graph](chap04.xhtml#simplegraph), there are\nonly two blocks of code to go in. One is CSS in the `<style>` area and the\nsecond is a tricky little piece of code that deals with gradients.\n\nFirst the CSS.\n\n    \n    \n    .line {\t\t\t\t\t\t\t\n      fill: none;\t\t\t\t\t\n      stroke: url(#line-gradient);\t\n      stroke-width: 2px;\t\t\t\n    }\t\n    \n\nThis block will go in the `<style>` area.\n\nThere’s the fairly standard fill of none and a stroke width of 2 pixels, but\nthe `stroke: url(#line-gradient);` is something different.\n\nIn this case the stroke (the colour of the line) is being determined at a link\nwithin the page which is set by the anchor `#line-gradient`. We will see\nshortly that this is in our second block of code, so the colour is being\ndefined in a separate portion of the script.\n\nAnd now the JavaScript gradient code;\n\n    \n    \n      // set the gradient\n      svg.append(\"linearGradient\")\t\t\t\t\n        .attr(\"id\", \"line-gradient\")\t\t\t\n        .attr(\"gradientUnits\", \"userSpaceOnUse\")\t\n        .attr(\"x1\", 0).attr(\"y1\", y(0))\t\t\t\n        .attr(\"x2\", 0).attr(\"y2\", y(1000))\t\t\n      .selectAll(\"stop\")\t\t\t\t\t\t\n        .data([\t\t\t\t\t\t\t\t\n          {offset: \"0%\", color: \"red\"},\t\t\n          {offset: \"40%\", color: \"red\"},\t\n          {offset: \"40%\", color: \"black\"},\t\t\n          {offset: \"62%\", color: \"black\"},\t\t\n          {offset: \"62%\", color: \"lawngreen\"},\t\n          {offset: \"100%\", color: \"lawngreen\"}\t\n        ])\t\t\t\t\t\n      .enter().append(\"stop\")\t\t\t\n        .attr(\"offset\", function(d) { return d.offset; })\t\n        .attr(\"stop-color\", function(d) { return d.color; });\t\t\n    \n\nThere’s our anchor on the third line!\n\nBut let’s not get ahead of ourselves. This block should be placed after the x\nand y domains are set, but before the line is drawn.\n\nSeems a bit strange doesn’t it? This block is all about defining the actions\nof an element, but the element in this case is a gradient and the gradient\nacts on the line. This is one of the cool things about writing code and\nregarding that code as a set of building blocks of the final product. There\nare many supporting components for the final product.\n\nOur second line adds our linear gradient. Gradients consist of continuously\nsmooth colour transitions along a vector from one colour to another. We can\nhave a linear or radial gradient and depending on which you select, there are\na few options to define. There is some great information on gradients at\n<http://www.w3.org/TR/SVG/pservers.html> (more than I ever thought existed).\n\nThe third line (`.attr(\"id\", \"line-gradient\")`) sets our anchor for the CSS\nthat we saw earlier.\n\nThe fourth, fifth and sixth lines define the bounds of the area over which the\ngradient will act. Since the coordinates `x1`, `y1`, `x2`, `y2` will describe\nan area. The values for `y1` (0) and `y2` (1000) are used more for convenience\nto align with our data (which has a maximum value around 630 or so). For more\ninformation on the ‘gradientUnits’ attribute I found this page useful\n<https://developer.mozilla.org/en-US/docs/SVG/Attribute/gradientUnits>. We’ll\ncome back to the coordinates in a moment.\n\nThe next block selects all the ‘stop’ elements for the gradients. These stop\nelements define where on the range covered by our coordinates the colours\nstart and stop. These have to be defined as either percentages or numbers\n(where the numbers are really just percentages in disguise (i.e. 45% =0.45)).\n\nThe best way to consider the stop elements is in conjunction with the\n`gradientUnits`. The image following may help.\n\n![Varying colours for varying values make a\ngradient](images/gradientline02.png) Varying colours for varying values make a\ngradient\n\nIn this case our coordinates describe a vertical line from 0 to 1000. Our\ncolours transition from red (0) to red (400) at which point they change to\nblack (400) and this will continue until it gets to black (620). Then this\nchanges to green (620) and from there, any value above that will be green.\n\nNow, it might seem a little convoluted to be doubling up on the colours and\nvalues, but the reason is that the gradient functions have a lot more to them\nthan meets the eye and we’ll have a look at the possibilities once the\nexplanation of the code is done.\n\nAfter defining the stop elements, we enter and append the elements to the\ngradient (`.enter().append(\"stop\")`) with attributes for offset and colour\nthat we defined in the stop elements area.\n\nNow, that _IS_ cool, but by now, I hope that you have picked that a gradient\nfunction really does mean a gradient, and not just a straight change from one\ncolour to another.\n\nSo, let’s try changing the stop element offsets to the following (and making\nthe stroke-width slightly larger to see more clearly what’s going on);\n\n    \n    \n        .data([\t\t\t\t\t\t\t\t\n          {offset: \"0%\", color: \"red\"},\t\t\n          {offset: \"30%\", color: \"red\"},\t\n          {offset: \"45%\", color: \"black\"},\t\t\n          {offset: \"55%\", color: \"black\"},\t\t\n          {offset: \"60%\", color: \"lawngreen\"},\t\n          {offset: \"100%\", color: \"lawngreen\"}\t\n        ])\t\t\n    \n\nAnd here we go…\n\n![Line with a gradually changing gradient](images/gradientline03.png) Line\nwith a gradually changing gradient\n\nAhh… A real gradient.\n\nI have tended to find that I need to have a good think about how I set the\noffsets and bounds when doing this sort of thing since it can get quite\ncomplicated quite quickly :-)\n\n### Applying a colour gradient to an area fill.\n\nThe previous example of a varying gradient on a line is neat, but hopefully\nyou’re already thinking “Hang on, can’t that same thing be applied to an area\nfill?”.\n\nDamn! You’re catching on.\n\nTo do this there’s only a few things we need to change;\n\nFirst of all the CSS for the line needs to be amended to refer to the area. So\nthis…\n\n    \n    \n    .line {\t\t\t\t\t\t\t\n      fill: none;\t\t\t\t\t\n      stroke: url(#line-gradient);\t\n      stroke-width: 2px;\t\t\t\n    }\t\t\n    \n\n…gets changed to this…\n\n    \n    \n    .area {\t\t\t\t\t\t\t\n      fill: url(#area-gradient);\t\t\t\t\t\n      stroke-width: 0px;\t\t\t\n    }\t\t\n    \n\nWe’ve defined the styles for the area this time, but instead of the stroke\nbeing defined by the separate script, now it’s the area. While we’ve changed\nthe url name, it’s actually the same piece of code, with a different id\n(because it seemed wrong to be talking about an area when the label said\nline). We’ve also set the stroke width to zero, because we don’t want any\nlines around our filled area.\n\nNow we want to take the block of code that defined our line…\n\n    \n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\t\t\n    \n\n… and we need to replace it with the standard block that defined an area fill.\n\n    \n    \n    // define the area\n    var\tarea = d3.area()\t\n        .x(function(d) { return x(d.date); })\t\n        .y0(height)\t\t\t\t\t\n        .y1(function(d) { return y(d.close); });\t\t\n    \n\nSo we’re not going to be drawing a line at all. Just the area fill.\n\nNext, as I mentioned earlier, we change the id for the `linearGradient` block\nfrom `\"line-gradient\"` to `\"area-gradient\"`\n\n    \n    \n          .attr(\"id\", \"area-gradient\")\t\t\t\n    \n\nAnd lastly, we remove the block of code that drew the line and replace it with\na block that draws an area. So change this….\n\n    \n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n\n… to this;\n\n    \n    \n      // Add the area.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"area\")\n          .attr(\"d\", area);\n    \n\nAnd then sit back and marvel at your creation;\n\n![Area fill with a gradually changing gradient](images/gradientarea01.png)\nArea fill with a gradually changing gradient\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/49570a3cd70390c257c80ac75c5049f1) or\nin the code samples bundled with this book (area-graph-gradient.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/49570a3cd70390c257c80ac75c5049f1).\n\nFor a slightly ‘nicer’ looking example, you could check out a variation of one\nof Mike Bostock’s (v3) originals here; <http://bl.ocks.org/4433087>.\n\n### Transitions\n\nA transition in d3 is an application of an animation to an\n[element](chap06.xhtml#elements) on the page. For the purpose of demonstration\nwe can think of an [element](chap06.xhtml#elements) being one of the common\nshapes and objects which include circles, ellipses, rectangles, lines,\npolylines, polygons, text and paths. This is a gross oversimplification as\ntransitions can be applied in far more complex ways, but this will help us get\nstarted. An animation could be described as a change in an attribute or style\nof an element over time.\n\nIf we use a [circle](chap06.xhtml#circle) as an example we know that a\n[circle](chap06.xhtml#circle) is described by three required attributes;\n\n  * `cx`: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.\n  * `cy`: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.\n  * `r`: The radius of the circle from the `cx`, `cy` position to the perimeter of the circle. \n\nTo animate a [circle](chap06.xhtml#circle) we would therefore be _changing_\n(or transitioning) one of those attributes over time.\n\nThe following JavaScript will draw a simple blue circle with radius 20 pixels\nat the position 40,250\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a cicle to the svg\n    \t.attr(\"style\", \"blue\")   // fill the circle with 'blue'\n    \t.attr(\"r\", 20)          // set the radius to 10 pixels\n    \t.attr('cx', 40)         // position the circle at 40 on the x axis\n    \t.attr('cy', 250);       // position the circle at 250 on the y axis\n    \n\nTo transition that circle from left to right we would change the `cx`\nattribute by simply including the transition instruction the new value of the\nattribute to be changed and the time that it should be completed in;\n\n    \n    \n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('cx', 920);       // new horizontal position at 920 on x axis\n    \n\nThe total amount of code required is;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n    \t.attr(\"style\", \"blue\")   // fill the circle with 'blue'\n    \t.attr(\"r\", 20)          // set the radius to 10 pixels\n    \t.attr('cx', 40)         // position the circle at 40 on the x axis\n    \t.attr('cy', 250)        // position the circle at 250 on the y axis\n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('cx', 920);       // new horizontal position at 920 on x axis\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can also be found on\n[github](https://gist.github.com/d3noob/c3cbb8af554eb848d09ab97306bb5583) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (transition-circle.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/c3cbb8af554eb848d09ab97306bb5583).\n\nAnd seen on the web page our circle moves from left to right.\n\n![Circle Transition](images/transition-01.png) Circle Transition\n\nA transition can be of more than one attribute at the same time. If we add\nlines to change the radius and fill colour as well we will have some\nJavaScript that looks a bit like this;\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n        .style(\"fill\", \"blue\")  // fill the circle with 'blue'\n        .attr(\"r\", 20)          // set the radius to 10 pixels\n        .attr('cx', 40)         // position the circle at 40 on the x axis\n        .attr('cy', 250)        // position the circle at 250 on the y axis\n        .transition()           // apply a transition\n        .duration(4000)         // apply it over 4000 milliseconds\n        .attr('cx', 920)        // new horizontal position at 920 on x axis\n        .attr('r', 40)          // new radius of 40 pixels\n        .style('fill', \"red\");  // new colour red\n    \n\nAnd when we load the page we see our circle move from left to right wile at\nthe same time increasing in radius and changing colour from blue to red.\n\n![Multi Attribute Circle Transition](images/transition-02.png) Multi Attribute\nCircle Transition\n\n#### Transitioning Chaining\n\nInstead of having multiple attributes / styles changing at once we can stagger\nthem using transition chaining. This is where we can employ several different\ntransitions to an element one after the other.\n\nFor example, the following JavaScript will move our circle from left to right\n_then_ it will increase the radius from 20 to 40 and _then_ it will change\nit’s colour from blue to red.\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n    \t.style(\"fill\", \"blue\")  // fill the circle with 'blue'\n    \t.attr(\"r\", 20)          // set the radius to 10 pixels\n    \t.attr('cx', 40)         // position the circle at 40 on the x axis\n    \t.attr('cy', 250)        // position the circle at 250 on the y axis\n        // 1st transition  \n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('cx', 920)        // new horizontal position at 920 on x axis\n        // 2nd transition\n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('r', 40)          // new radius of 40 pixels\n        // 3rd transition\n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.style('fill', \"red\");  // new colour red\n    \n\n![Transition Chaining](images/transition-03.png) Transition Chaining\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/899a0b2490318a96f9ebd40a5a84e4a7) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (transition-chaining.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/899a0b2490318a96f9ebd40a5a84e4a7).\n\n#### Transition Easing\n\nThe reader who runs the code or checks out the simple example\n[here](http://bl.ocks.org/d3noob/c3cbb8af554eb848d09ab97306bb5583) will notice\nthat our circle does not move from one side to the other at a constant speed.\nIt starts off slowly, builds up speed towards the middle of its travels and\nthen slows down before stopping. This gives the movement a pleasing\nappearance, but it is an example of the\n‘[easing](https://github.com/d3/d3-ease)’ of the transition from one point to\nanother.\n\nTo apply a linear motion to the movement we can introduce\n`.ease(d3.easeLinear)` to the code as follows;\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n        .style(\"fill\", \"blue\")  // fill the circle with 'blue'\n        .attr(\"r\", 20)          // set the radius to 10 pixels\n        .attr('cx', 40)         // position the circle at 40 on the x axis\n        .attr('cy', 250)        // position the circle at 250 on the y axis\n        .transition()           // apply a transition\n        .ease(d3.easeLinear)    // control the speed of the transition\n        .duration(4000)         // apply it over 4000 milliseconds\n        .attr('cx', 920);       // new horizontal position at 920 on x axis\n    \n\nThe easing of an element describes a distortion in the apparent flow of time.\nThere are a range of different types of easing described in the [d3\nwiki](https://github.com/d3/d3-ease). Most are representative of a function\nalthough there are some which are intended to represent specific real-world\nmotions.\n\n  * linear\n  * quad\n  * cubic\n  * poly\n  * sin\n  * exp\n  * circle\n  * bounce\n  * back\n  * elastic\n\nEach easing (except linear) can be further modified using ‘In’, ‘Out’ or\nInOut’ which allows for variations in the animation that can give the\nappearance of starting or stopping at different points in the curves or in the\ncase of ‘InOut’ of going through a complete transition. For example,\n`.ease(d3.easeExpIn)` or `.ease(d3.easePolyInOut)`.\n\nIf an easing function is not specified, the default used is cubic and if ‘In’,\n‘Out’ or InOut’ aren’t specified, the default is ‘InOut’ except for bounce and\nelastic which use ‘Out’. Therefore we can use `.ease(d3.easePoly)` which is an\nalias for `.ease(d3.easePolyInOut)`. ‘easePoly’ is also an alias for\n‘easeCubic’ (and vice versa).\n\nTo get a good impression of the way that each easing method is represented,\nMike Bostock has an ‘[Easing\nExplorer](http://bl.ocks.org/mbostock/248bac3b8e354a9103c4)’ block set up\nhere. There is also a block to do a side by side comparison\n[here](http://bl.ocks.org/d3noob/1ea51d03775b9650e8dfd03474e202fe) (this is\nalso in the code samples bundled with [this\nbook](https://leanpub.com/d3-t-and-t-v4) (transition-easing-multiple.html)).\n\n#### Looping a Transition\n\nWe can use a transition to create a convincing impression of an element that\nis in a constant rate of change in a looping condition. We achieve this by\ncreating a [transition chain](chap11.xhtml#chaining) that starts and ends in\nthe same state and then we instruct the transition code to repeat itself.\n\nIn the example we will have a circle that moves from left to right and then\nback again constantly.\n\n![Looping Transitionn](images/transition-04.png) Looping Transitionn\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/bf44061b1d443f455b3f857f82721372) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (transition-looping.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/bf44061b1d443f455b3f857f82721372).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n    var svg = d3.select(\"body\")\n            .append(\"svg\")\n            .attr(\"width\", 960)\n            .attr(\"height\", 500);\n    \n    function circleTransition() { \n    \n        var timeCircle = svg.append(\"circle\")\n            .attr(\"fill\", \"steelblue\")\n            .attr(\"r\", 20);\n        repeat();\n        \n        function repeat() {\n          timeCircle\n            .attr('cx', 40)      // position the circle at 40 on the x axis\n            .attr('cy', 250)     // position the circle at 250 on the y axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 920)     // move the circle to 920 on the x axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 40)      // return the circle to 40 on the x axis\n            .on(\"end\", repeat);  // when the transition finishes start again\n        };\n    \n    };\n    \n    circleTransition();\n    \n    </script>\n    </body>\n    \n\nThe JavaScript starts by creating an SVG element;\n\n    \n    \n    var svg = d3.select(\"body\")\n            .append(\"svg\")\n            .attr(\"width\", 960)\n            .attr(\"height\", 500);\n    \n\nWe then declare the function `circleTransition` which starts by creating the\ncomponent that defines the circle and gives it a colour and radius;\n\n    \n    \n        var timeCircle = svg.append(\"circle\")\n            .attr(\"fill\", \"steelblue\")\n            .attr(\"r\", 20);\n    \n\nWe then call a sub function `repeat` that performs the transition chaining\nloop. Then the looping transition is declared;\n\n    \n    \n        function repeat() {\n          timeCircle\n            .attr('cx', 40)      // position the circle at 40 on the x axis\n            .attr('cy', 250)     // position the circle at 250 on the y axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 920)     // move the circle to 920 on the x axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 40)      // return the circle to 40 on the x axis\n            .on(\"end\", repeat);  // when the transition finishes start again\n        };\n    \n\nHere we can see the familiar parts of a transition where the attributes and\ntransition details are declared in a chain so that when it completes, the\ncircle has moved from the left to the right and then back to the starting\nposition. At that point the code listens for the `end` of the transformations,\nand when this occurs it calls the transition function `repeat` again. This\nwill continue to cycle indefinitely.\n\nThe last part of the code is the instruction to call our initial function;\n\n    \n    \n    circleTransition();\n    \n\nBecause the code is executing\n[asynchronously](https://www.pluralsight.com/guides/front-end-\njavascript/introduction-to-asynchronous-javascript), it can continue to\noscillate while other code could be carrying out other tasks.\n\n### Show / hide an element by clicking on another element\n\nThis is a trick that I found I wanted to implement in order to present a graph\nwith a range of lines and to then provide the reader with the facility to\nclick on the associated legend to toggle the visibility of the lines off and\non as required.\n\nThe example we’ll follow is our friend from earlier, a slightly modified\nexample of the graph with two lines.\n\n![Show / hide lines on a graph](images/show-hide-01.png) Show / hide lines on\na graph\n\nIn this example we will be able to click on either of the two titles at the\nbottom of the graph (‘Blue Line’ or ‘Red Line’) and have it toggle the\nrespective line and Y axis.\n\n##### The code\n\nThe code for the example is available online at\n[bl.ocks.org](http://http://bl.ocks.org/d3noob/4abb9dc578abf070fe62302282a29c41)\nor [GitHub](https://gist.github.com/d3noob/4abb9dc578abf070fe62302282a29c41).\nIt is also available as the file ‘show-hide.html’ that can be a download when\nyou [download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThere are more changes in the example code than we will explain below such as\nthe addition of CSS to the `<style>` area and the code that allows both of the\nlines to be shown / hidden (we’ll only go through the blue line code).\n\nThere are two main parts to implementing this technique. Firstly we have to\nlabel the element (or elements) that we wish to show / hide and then we have\nto give the object that will get clicked on the attribute that allows it to\nrecognise a mouse click and the code that it subsequently uses to show / hide\nour labelled element.\n\nLabelling the element that is to be switched on and off is dreadfully easy. It\nsimply involves including an `id` attribute to an element that identifies it\nuniquely.\n\n    \n    \n      // add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"id\", \"blueLine\")\n          .attr(\"d\", valueline);\n    \n\nIn the example above we have applied the `id` `blueLine` to the path that\ndraws the blue line on our graph.\n\nThe second part is a little trickier. The following is the portion of\nJavaScript that places our text label under the graph. The only part of it\nthat is unusual is the `.on(\"click\", function()` section of the code.\n\n    \n    \n      // add the blue line legend\n      svg.append(\"text\")\n         .attr(\"x\", 0)             \n         .attr(\"y\", height + margin.top + 15)    \n         .attr(\"class\", \"legend\")\n         .style(\"fill\", \"steelblue\")         \n         .on(\"click\", function(){\n           // determine if current line is visible\n           var active = blueLine.active ? false : true,\n           newOpacity = active ? 0 : 1;\n           // hide or show the elements\n           d3.select(\"#blueLine\").style(\"opacity\", newOpacity);\n           // update whether or not the elements are active\n           blueLine.active = active;\n         })\n         .text(\"Blue Line\");\n    \n\nWhen we click on our ‘Blue Line’ text element the `.on(\"click\", function()`\nsection executes.\n\nWe’re using a short-hand version of the `if` statement a couple of times here.\nFirstly we check to see if the variable `blueLine.active` is true or false and\nif it’s true it gets set to false and if it’s false it gets set to true (not\nat all confusing).\n\n    \n    \n           var active = blueLine.active ? false : true,\n           newOpacity = active ? 0 : 1;\n    \n\nThen after toggling this variable we set the value of `newOpacity` to either 0\nor 1 depending on whether `active` is `false` or `true` (the second short-hand\nJavaScript if statement).\n\nWe can then select our identifiers that we have declared using the `id`\nattributes in the earlier pieces of code and modify their opacity to either\n`0` (off) or `1` (on)\n\n    \n    \n           d3.select(\"#blueLine\").style(\"opacity\", newOpacity);\n    \n\nLastly we update our `blueLine.active` variable to whatever the `active` state\nis so that it can toggle correctly the next time it is clicked on.\n\n    \n    \n           blueLine.active = active;\n    \n\nQuite a neat piece of code. Kudos to Max Leiserson for providing the example\non which it is largely based in an [answer to a question on Stack\nOverflow](http://stackoverflow.com/questions/20249215/how-to-display-and-hide-\nlinks-and-nodes-when-clicking-on-a-node-in-d3-javascript).\n\n### Using HTML inputs with d3.js\n\nPart of the attraction of using technologies like d3.js is that it expands the\nscope of what is possible in a web page. At the same time, there are many\ndifferent options for displaying content on a page and plenty of ways of\ninteracting with it.\n\nSome of the most basic of capabilities has been the use of HTML entities that\nallow the entry of data on a page. This can take a range of different forms\n(pun intended) and the `<input>` tag is one of the most basic.\n\n#### What is an HTML input?\n\nAn HTML input is an element in HTML that allows a web page to input data.\nThere are a range of different input types (with varying degrees of\ncompatibility with browsers) and they are typically utilised inside a `<form>`\nelement.\n\nFor example the following code allows a web page to place two fields on a web\npage so that a user can enter their first and last names in separate boxes;\n\n    \n    \n    <form>\n      First name: <input type=\"text\" name=\"firstname\"><br>\n      Last name: <input type=\"text\" name=\"lastname\">\n    </form>\n    \n\nThe page would then display the following;\n\n![A form input](images/input-01.png) A form input\n\nThe range of input types is large and includes;\n\n  * text: A simple text field that a user can enter information into.\n  * radio: Buttons that let a user select only one of a limited number of choices.\n  * button: A clickable button that can activate JavaScript.\n  * range: A slider control for setting a number whose exact value is not important.\n  * number: A field for entering a number or toggling a number up and down.\n\n… and many more. To check out others and get further background, it would be\nworthwhile visiting the[ Mozilla developer](https://developer.mozilla.org/en-\nUS/docs/Web/HTML/Element/Input) pages or\n[w3schools.com](http://www.w3schools.com/tags/tag_input.asp).\n\nWhile d3.js has the power to control and manipulate a web page to an extreme\nextent, sometimes it’s desirable to use a simple process to get a result. The\nfollowing explanations will demonstrate a simple use case linking an HTML\ninput with a d3.js element and will go on to provide examples of using\nmultiple inputs, affecting multiple elements and using different input types.\nThe examples are deliberately kept simple. They are intended to demonstrate\nfunctionality and to provide a starting position for you to go forward :-).\n\n#### Using a `range` input with d3.js\n\nThe first example we will follow will use a `range` input to adjust the radius\nof a circle.\n\n![Adjust the radius of a circle](images/input-02.png) Adjust the radius of a\ncircle\n\n##### The code\n\nThe following is the full code for the example. A live version is available\nonline at\n[bl.ocks.org](http://bl.ocks.org/d3noob/147791d51cf6516715914c49cb869f57) or\n[GitHub](https://gist.github.com/d3noob/147791d51cf6516715914c49cb869f57). It\nis also available as the file ‘input-radius.html’ as a separate download with\nthe book D3 Tips and Tricks v4.x. A copy of the files that appear in the book\ncan be downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>Input test (circle)</title>\n      \n    <p>\n      <label for=\"nRadius\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             radius = <span id=\"nRadius-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"150\" id=\"nRadius\">\n    </p>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw the circle\n    holder.append(\"circle\")\n      .attr(\"cx\", 300)\n      .attr(\"cy\", 150) \n      .style(\"fill\", \"none\")   \n      .style(\"stroke\", \"blue\") \n      .attr(\"r\", 120);\n    \n    // when the input range changes update the circle \n    d3.select(\"#nRadius\").on(\"input\", function() {\n      update(+this.value);\n    });\n    \n    // Initial starting radius of the circle \n    update(120);\n    \n    // update the elements\n    function update(nRadius) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nRadius-value\").text(nRadius);\n      d3.select(\"#nRadius\").property(\"value\", nRadius);\n    \n      // update the circle radius\n      holder.selectAll(\"circle\") \n        .attr(\"r\", nRadius);\n    }\n    \n    </script>\n    \n\n##### The explanation\n\nAs with the other examples in the book I will not go over some of the simpler\nlines of code that are covered in greater detail in earlier sections of the\nbook and will concentrate on those sections that contain new concepts, code or\nlook like they might need expanding :-).\n\nThe first section is the portion that sets out the html `range` input;\n\n    \n    \n    <p>\n      <label for=\"nRadius\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             radius = <span id=\"nRadius-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"150\" id=\"nRadius\">\n    </p>\n    \n\nThe entire block is enclosed in a paragraph (`<p>`) tag so that is appears on\na single line. It can be broken down into the label that occurs before the\ninput slider which is given the id `nRadius-value` and the `input` proper.\n\nThe `for` attribute of the `label` tag equals to the id attribute of the input\nelement to bind them together. This allows us to update the text later as the\nslider is moved.\n\nThe `input` tag can include four attributes that specify restrictions on the\noperation of the slider;\n\n  * `max`: specifies the maximum value allowed\n  * `min`: specifies the minimum value allowed\n  * `step`: specifies the number intervals as you move the slider\n  * `value`: Specifies the default value\n\nThe `id`s supplied for both the label and the input are important since they\nprovide the reference for our d3.js script.\n\nThe first portion of our JavaScript is fairly routine if you’ve been following\nalong with the rest of the book.\n\n    \n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw the circle\n    holder.append(\"circle\")\n      .attr(\"cx\", 300)\n      .attr(\"cy\", 150) \n      .style(\"fill\", \"none\")   \n      .style(\"stroke\", \"blue\") \n      .attr(\"r\", 120);\n    \n\nWe append an SVG element to the `body` of our page and then we append a circle\nwith some particular styling to the SVG element.\n\nThen things start to get more interesting…\n\n    \n    \n    d3.select(\"#nRadius\").on(\"input\", function() {\n      update(+this.value);\n    });\n    \n\nWe select our input using the `id` that we had declared earlier in the html\n(`nRadius`). Then we use the `.on` operator which adds what is called an\n‘[event\nlistener](https://github.com/d3/d3-selection/blob/master/README.md#handling-\nevents)’ to the element so that when there is a change in the element (in this\ncase an adjustment of the slider of the input) a function is called\n(`function()`) that in turn calls the `update` function with the value from\nthe input (`+this.value`). We haven’t seen the `update` function yet, but\nnever fear, it’s coming.\n\nWe also call the update function with a specific value in the next line;\n\n    \n    \n    update(120);\n    \n\nThis might seem slightly redundant, but unless the function gets a value, the\ntext associated with the range input doesn’t get a reading and remains on ‘…’\nuntil the slider is moved.\n\nLastly we have our `update` function;\n\n    \n    \n    function update(nRadius) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nRadius-value\").text(nRadius);\n      d3.select(\"#nRadius\").property(\"value\", nRadius);\n    \n      // update the circle radius\n      holder.selectAll(\"circle\") \n        .attr(\"r\", nRadius);\n    }\n    \n\nThe first part of the function selects the `label` associated with our input\n(with the `id`, `nRadius-value`) and applies the value that has been passed\ninto the function (`nRadius`). The next line selects the input itself and\napplies the value to it (this would be the equivalent of having\n`value=\"<number here>\"` as a property in the html).\n\nLastly, we select the circle element and apply the new radius value based on\nour input value `nRadius` (`.attr(\"r\", nRadius)`).\n\nAnd there we have it, a fully adjustable radius for our circle controlled with\nan HTML input.\n\n![Maximum radius for our circle](images/input-03.png) Maximum radius for our\ncircle\n\n#### Using more than one input\n\nIn this example we will use two separate inputs (range type) to adjust the\nheight and width of a rectangle.\n\n![Dual inputs](images/input-04.png) Dual inputs\n\nThis is not too much of a stretch from the previous single input example with\nthe radius of a circle, but it may be useful to reinforce the concept and\nillustrate something slightly different.\n\n##### The code\n\nThe following is the full code for the example. A live version is available\nonline at\n[bl.ocks.org](http://bl.ocks.org/d3noob/aee9277a3664850501f3d1d0fc731c86) or\n[GitHub](https://gist.github.com/d3noob/aee9277a3664850501f3d1d0fc731c86). It\nis also available as the file ‘input-double.html’ as a separate download with\nD3 Tips and Tricks v4.x. A copy of the files that appear in the book can be\ndownloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>Double Input Test</title>\n    \n    <p>\n      <label for=\"nHeight\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             height = <span id=\"nHeight-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"280\" id=\"nHeight\">\n    </p>\n    \n    <p>\n      <label for=\"nWidth\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             width = <span id=\"nWidth-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"400\" id=\"nWidth\">\n    </p>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw a rectangle\n    holder.append(\"rect\")\n        .attr(\"x\", 300)\n        .attr(\"y\", 150)\n        .style(\"fill\", \"none\")\n        .style(\"stroke\", \"blue\")\n        .attr(\"height\", 150) \n        .attr(\"width\", 200);\n    \n    // read a change in the height input\n    d3.select(\"#nHeight\").on(\"input\", function() {\n      updateHeight(+this.value);\n    });\n    \n    // read a change in the width input\n    d3.select(\"#nWidth\").on(\"input\", function() {\n      updateWidth(+this.value);\n    });\n    \n    // update the values\n    updateHeight(150);\n    updateWidth(100);\n    \n    // Update the height attributes\n    function updateHeight(nHeight) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nHeight-value\").text(nHeight);\n      d3.select(\"#nHeight\").property(\"value\", nHeight);\n    \n      // update the rectangle height\n      holder.selectAll(\"rect\") \n        .attr(\"y\", 150-(nHeight/2)) \n        .attr(\"height\", nHeight); \n    }\n    \n    // Update the width attributes\n    function updateWidth(nWidth) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nWidth-value\").text(nWidth);\n      d3.select(\"#nWidth\").property(\"value\", nWidth);\n    \n      // update the rectangle width\n      holder.selectAll(\"rect\")\n        .attr(\"x\", 300-(nWidth/2)) \n        .attr(\"width\", nWidth);\n    }\n    \n    </script>\n    \n\n##### The explanation\n\nFor the sake of brevity, this explanation will simply concentrate on the\ndifferences between the previous single input example and this one.\n\nThe declarations for the inputs in the HTML at the start of the code are\nsimply duplicates of each other in terms of function;\n\n    \n    \n    <p>\n      <label for=\"nHeight\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             height = <span id=\"nHeight-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"280\" id=\"nHeight\">\n    </p>\n    \n    <p>\n      <label for=\"nWidth\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             width = <span id=\"nWidth-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"400\" id=\"nWidth\">\n    </p>\n    \n\nThe only significant difference is the declaration of the `id`’s for each\ninput and their respective labels.\n\nThe JavaScript selection of the inputs is more duplication;\n\n    \n    \n    d3.select(\"#nHeight\").on(\"input\", function() {\n      updateHeight(+this.value);\n    });\n    \n    d3.select(\"#nWidth\").on(\"input\", function() {\n      updateWidth(+this.value);\n    });\n    \n\nAgain the only substantive difference is the use of the appropriate `id`\nvalues.\n\nThe updating of the width and height is done via two different functions;\n\n    \n    \n    function updateHeight(nHeight) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nHeight-value\").text(nHeight);\n      d3.select(\"#nHeight\").property(\"value\", nHeight);\n    \n      // update the rectangle height\n      holder.selectAll(\"rect\") \n        .attr(\"y\", 150-(nHeight/2)) \n        .attr(\"height\", nHeight); \n    }\n    \n    // Update the width attributes\n    function updateWidth(nWidth) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nWidth-value\").text(nWidth);\n      d3.select(\"#nWidth\").property(\"value\", nWidth);\n    \n      // update the rectangle width\n      holder.selectAll(\"rect\")\n        .attr(\"x\", 300-(nWidth/2)) \n        .attr(\"width\", nWidth);\n    }\n    \n\nThe rectangle is selected using a common `rect` designator, so multiple\nrectangles could be controlled. But each function controls only a specific\nattribute (height or width).\n\n#### Rotate text with an input\n\nThis example is really just a derivative of the adjustment of a single\nattribute of an element.\n\nI happen to think it’s just a little bit ‘neater’ because it includes text,\nbut in reality, it’s just another attribute that can be adjusted.\n\nHere we let our range input adjust the rotation of a piece of text.\n\n![Text rotation with an input](images/input-05.png) Text rotation with an\ninput\n\n##### The explanation\n\nWe’ll dispense with the full code listing since it’s just a regurgitation of\nthe adjusting of the radius of the circle example, but the code for the\nexample is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/d072f01abe615478633f39eb7c383dee) or\n[GitHub](https://gist.github.com/d3noob/d072f01abe615478633f39eb7c383dee). It\nis also available as the file ‘input-text-rotate.html’ as a separate download\nwith D3 Tips and Tricks v4.x. A copy of the files that appear in the book can\nbe downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/leanpub.com/d3-t-and-t-v4).\n\nThe only, thing of even a slight difference (other than some naming\nconventions) is the initial drawing of the text…\n\n    \n    \n    holder.append(\"text\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,150) rotate(0)\")\n      .text(\"d3noob.org\");\n    \n\n… and the update function;\n\n    \n    \n    function update(nAngle) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nAngle-value\").text(nAngle);\n      d3.select(\"#nAngle\").property(\"value\", nAngle);\n    \n      // rotate the text\n      holder.select(\"text\") \n        .attr(\"transform\", \"translate(300,150) rotate(\"+nAngle+\")\");\n    }\n    \n\n#### Use a `number` input with d3.js\n\nThere are obviously different inputs types that can be implemented. The\nfollowing example still rotates our text, but uses a `number` type of input to\ndo it;\n\n    \n    \n    <p>\n      <label for=\"nValue\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             angle = <span id=\"nValue-value\"></span>\n      </label>\n      <input type=\"number\" min=\"0\" max=\"360\" step=\"5\" value=\"0\" id=\"nValue\">\n    </p>\n    \n\nWe have set the `step` value to speed things up a bit when rotating, but it’s\ncompletely optional.\n\nThe input itself can be adjusted up or down using a mouse click or have a\nnumber typed into the input box.\n\n![Text rotation with a number input](images/input-06.png) Text rotation with a\nnumber input\n\nThis type of input is slightly different from the range type since it isn’t\nfully supported under Firefox and as a result when I was testing it the arrow\nkeys for going up and down weren’t present.\n\nThe full code for the example is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/365ab1f8708d245b0ef82ba8afe18370) or\n[GitHub](https://gist.github.com/d3noob/365ab1f8708d245b0ef82ba8afe18370). It\nis also available as the file ‘input-number-text.html’ as a separate download\nwith D3 Tips and Tricks v4.x. A copy of the files that appear in the book can\nbe downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n#### Change more than one element with an input\n\nThe final example looking at using HTML inputs with d3.js incorporates a\nsingle input acting or two different elements. This might seem self evident,\nbut if you’re as unfamiliar with HTML as I am (it’s embarrassing I know, but\nwhat can you do?) it may be of assistance.\n\nThe end result is to produce a single slider as a `range` input that rotates\ntwo separate text objects in different directions simultaneously.\n\n![Dual text rotation](images/input-07.png) Dual text rotation\n\n##### The code\n\nThe following is the full code for the example. A live version is available\nonline at\n[bl.ocks.org](http://bl.ocks.org/d3noob/b901b4c8242e5c2de95d0b6b1656cc33) or\n[GitHub](https://gist.github.com/d3noob/b901b4c8242e5c2de95d0b6b1656cc33). It\nis also available as the file ‘input-text-rotate-2.html’ as a separate\ndownload with D3 Tips and Tricks v4.x. A copy of the files that appear in the\nbook can be downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>Input test</title>\n    \n    <p>\n      <label for=\"nAngle\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             angle = <span id=\"nAngle-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"0\" max=\"360\" id=\"nAngle\">\n    </p>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw d3.js text\n    holder.append(\"text\")\n      .attr(\"class\", \"d3js\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,55) rotate(0)\")\n      .text(\"d3.js\");\n    \n    // draw d3noob.org text\n    holder.append(\"text\")\n      .attr(\"class\", \"d3noob\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,130) rotate(0)\")\n      .text(\"d3noob.org\");\n    \n    // when the input range changes update the rectangle \n    d3.select(\"#nAngle\").on(\"input\", function() {\n      update(+this.value);\n    });\n    \n    // Initial starting height of the rectangle \n    update(0);\n    \n    // update the elements\n    function update(nAngle) {\n    \n    // adjust the range text\n      d3.select(\"#nAngle-value\").text(nAngle);\n      d3.select(\"#nAngle\").property(\"value\", nAngle);\n    \n      // adjust d3.js text\n      holder.select(\"text.d3js\") \n        .attr(\"transform\", \"translate(300,55) rotate(\"+nAngle+\")\");\n    \n      // adjust d3noob.org text\n      holder.select(\"text.d3noob\") \n        .attr(\"transform\", \"translate(300,130) rotate(\"+(360 - nAngle)+\")\");\n    }\n    \n    </script>\n    \n\n##### The explanation\n\nThe explanation for this example differs from the others in the way that the\nd3.js elements (the two pieces of text) are initially appended and then\nupdated.\n\nWhen they are initially drawn…\n\n    \n    \n    holder.append(\"text\")\n      .attr(\"class\", \"d3js\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,55) rotate(0)\")\n      .text(\"d3.js\");\n    \n    holder.append(\"text\")\n      .attr(\"class\", \"d3noob\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,130) rotate(0)\")\n      .text(\"d3noob.org\");\n    \n\n… both elements are declared with a `class` attribute that serves as a\nreference for the future updating. Here, the text ‘d3.js’ is given a `class`\nname of `d3js` and the text ‘d3noob.org’ is given a `class` name of `d3noob`.\n\nThen when we call the `update` function each of the two text elements is\nadjusted seperatly by selecting each based on the `class` name that was\napplied in the initial setup;\n\n    \n    \n    function update(nAngle) {\n    \n    // adjust the range text\n      d3.select(\"#nAngle-value\").text(nAngle);\n      d3.select(\"#nAngle\").property(\"value\", nAngle);\n    \n      // adjust d3.js text\n      holder.select(\"text.d3js\") \n        .attr(\"transform\", \"translate(300,55) rotate(\"+nAngle+\")\");\n    \n      // adjust d3noob.org text\n      holder.select(\"text.d3noob\") \n        .attr(\"transform\", \"translate(300,130) rotate(\"+(360 - nAngle)+\")\");\n    }\n    \n\nSo the ‘d3.js’ text is selected using `text.d3js` and ‘d3noob.org’ is selected\nusing `text.d3noob`. That’s a pretty neat trick and a good lesson for applying\nspecific transformations to specific objects.\n\n### Add an HTML table to your graph\n\nSo graphs and graphics are D3’s bread and butter you’d think. Hmm…\n\nWell yes and no.\n\nYes D3 has extraordinary powers for presenting and manipulating images in a\nweb page. But if you’ve read through the entirety of the d3.js main site\n(haven’t we all) you will recall that D3 actually stands for Data Driven\nDocuments. It’s not necessarily about the pretty pictures and the swirling\ncascade of colour. It’s about generating something in a web browser based on\ndata.\n\nThis transitions nicely into consideration of adding a table of information\nthat can accompany your graph (it could just as easily (or easier) be stand\nalone, but for the sake of continuity, we’ll use the graph).\n\nWhat we’ll do is add the data that we’ve used to make our simple graph under\nthe graph itself. To make sure that it’s all nicely aligned, we’ll place it in\na table.\n\nIt should end up looking a little like this (and this has been cropped\nslightly at the bottom to avoid expanding the page with rows of numbers /\ndates).\n\n![Basic graph with a table of data](images/table01.png) Basic graph with a\ntable of data\n\nThe code was drawn from an example provided by [Shawn\nAllen](http://jsfiddle.net/7WQjr/) on [Google\nGroups](http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-\nto-a-csv-file). In fact, the post itself is an excellent one if you are\nconsidering creating a table straight from a csv file.\n\n#### HTML Tables\n\nI’m walking a fine line here since I have a remarkably small amount of\nknowledge on HTML tables. So I’ll try to provide a brief overview as I\nunderstand it and as I see it represented in the code below, but for a far\nfuller explanation, take a look at some great work by [Peter Cook\nhere](http://prcweb.co.uk/lab/selection/) or let Google be your friend.\n\nTables are made up of rows, columns and data (that goes in each cell). All you\nneed to do to successfully place a table on a web page is to lay out the rows\nand columns in a logical sequence using the appropriate HTML tags and you’re\naway.\n\nFor example here’s the total HTML code for a web page to display a simple\ntable;\n\n    \n    \n    <!DOCTYPE html>\n    <body>\n        <table border=\"1\">\n            <tr>\n                <th>Header 1</th>\n                <th>Header 2</th>\n            </tr>\n            <tr>\n                <td>row 1, cell 1</td>\n                <td>row 1, cell 2</td>\n            </tr>\n            <tr>\n                <td>row 2, cell 1</td>\n                <td>row 2, cell 2</td>\n            </tr>\n        </table>\n    </body>\n    \n\nThis will result in a table that looks a little like this in a web browser;\n\n**Header 1** | **Header 2**  \n---|---  \nrow 1, cell 1 | row 1, cell 2  \nrow 2, cell 1 | row 2, cell 2  \n  \nThe entire table itself is enclosed in `<table>` tags. Each row is enclosed in\n`<tr>` tags. Each row has two items which equate to the two columns. Each\npiece of data for each cell is enclosed in a `<td>` tag except for the first\nrow, which is a header and therefore has a special tag `<th>` that denotes it\nas a header making it bold and centred. For the sake of ease of viewing we\nhave told the table to place a border around each cell and we do this in the\nfirst `<table>` tag with the `border=\"1\"` statement (although in this book\nview it may be absent).\n\nThe good news is that you don’t need to fully understand all this, but it will\nhelp with the explanation of what we’re doing in the code below.\n\nThere are three main things you need to do to the basic line graph to get your\ntable to display.\n\n  1. Add some CSS\n  2. Add some table building d3.js code\n  3. Make a small but cunning change…\n\nThere is a copy of the code and the data file for this example at\n[github](https://gist.github.com/d3noob/3e5138a14cfc1822eedee2963c493399) and\nin the code samples bundled with this book (simple-graph-plus-table.html and\ndata.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3e5138a14cfc1822eedee2963c493399).\n\n#### First the CSS\n\nThis just helps the table with formatting and making sure the individual cells\nare spaced appropriately;\n\n    \n    \n    td, th {\n      padding: 1px 4px;\n    }\n    \n\nThis sets a padding of 1 px around each cell and 4 px between each column.\n\nFeel free to play with the figures to suit your application, I’ve just set\nthem there because I thought they looked appropriate.\n\nI’ve placed this portion of CSS at the end of our `<style>` section.\n\n#### Now the d3.js code\n\nOki doki… Hopefully you have a loose understanding of the html layout of a\ntable as explained above, but if not you can always go with the ‘it just\nworks’ approach.\n\nHere’s what we should add into our simple graph example;\n\n    \n    \n    // The table generation function\n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 400px\"),\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n        // append the header row\n        thead.append(\"tr\")\n            .selectAll(\"th\")\n            .data(columns)\n            .enter()\n            .append(\"th\")\n                .text(function(column) { return column; });\n    \n        // create a row for each object in the data\n        var rows = tbody.selectAll(\"tr\")\n            .data(data)\n            .enter()\n            .append(\"tr\");\n    \n        // create a cell in each row for each column\n        var cells = rows.selectAll(\"td\")\n            .data(function(row) {\n                return columns.map(function(column) {\n                    return {column: column, value: row[column]};\n                });\n            })\n            .enter()\n            .append(\"td\")\n            .attr(\"style\", \"font-family: Courier\") // sets the font style\n                .html(function(d) { return d.value; });\n        \n        return table;\n    }\n    \n    // render the table\n     var peopleTable = tabulate(data, [\"date\", \"close\"]);\n    \n\nAnd we should take care to add it into the code at the end of the portion\nwhere we’ve finished drawing the graph, but before the enclosing curly and\nregular brackets that complete the portion of the graph that has loaded our\ndata.csv file. This is because we want our new piece of code to have access to\nthat data and if we place it after those brackets it won’t know what data to\ndisplay.\n\nSo, right about here;\n\n    \n    \n            // Add the Y Axis\n            svg.append(\"g\")\n                .attr(\"class\", \"y axis\")\n                .call(yAxis);\n                                     // <= Add the code right here!\n    });\n    \n\nNow, we’re going to break with tradition a bit here and examine what our\ncurrent state of code produces. Then we’re going to explain something\ndifferent. _THEN_ we’re going to come back and explain the code…\n\nCheck it out…\n\n![Woah! What happened to the date?](images/table02.png) Woah! What happened to\nthe date?\n\nNot quite as we has originally envisaged?\n\nIndeed, the date has taken it upon itself to expand from a relatively modest\nformat of day-abbreviated month-two digit year (30-Apr-12) to a behemoth of a\nthing (Mon Apr 30 2012 00:00:00 GMT+1200 (New Zealand Standard Time)) that we\ncertainly didn’t intend, let alone have in our data.csv file.\n\nWhat’s going on here?\n\nI’m no expert, but this is what I tell myself is happening. The JavaScript\ncode recognises and deals with the ‘date’ variable as being a date/time (not a\nstring of numbers, letters and characters). Therefore, when we proceed to\ndisplay the variable on the screen, the browser says, “this is a date / time\nvalue, therefore in lieu of any other instructions, I will format it in the\nfollowing way”. This is perfectly valid and we could work through a method of\nre-formatting the code to display in a specific way, but there is a simpler\nway to solve the problem. Hence the third small but cunning change to our\noriginal code.\n\n#### A small but cunning change…\n\nOur table has decided to develop a mind of it’s own and format the date time\nas it sees fit. Well fair enough (I for one welcome our web time formatting\noverlords). How do we convince it to display the values in their natural form?\n\nWell, one solution that we could employ is to not tell the JavaScript that our\n`date` value in the data is actually time. In that condition, the code should\ntreat the values as an ordinary string and print it directly as it appears.\n\nThe good news is that this is pretty easy to do. Where originally we had a\nblock of data that consisted of `date` and `close`, all at different times, we\nwill now add a new variable called `date1` which will be the variable that we\nconvert to a time and draw the graph with. Leaving `date` to be the text\nstring that will be printed in our table.\n\nHow to do it?\n\nIt’s actually remarkably easy. Just change the following lines in the basic\nline graph code to amend `date` to `date1` and you’re good to go.\n\n    \n    \n        .x(function(d) { return x(d.date1); })\n    \n    \n    \n          d.date1 = parseTime(d.date);\n    \n    \n    \n      x.domain(d3.extent(data, function(d) { return d.date1; }));\n    \n\nThe middle line is probably the most significant, since this is the point\nwhere we declare `date1`, assign a time format and bring a new column of data\ninto being. The others simply refer to the data.\n\nSo we’ll make those small changes and now we can return to explain the d3.js\ncode…\n\n#### Explaining the d3.js code (reloaded).\n\nSo back we come to explain what is going on in the d3.js code that we\npresented a page or two back. Obviously it’s a fairly large chunk, and we can\nbreak it down into two chunks.\n\nThe first chunk we’ll look at is in fact the last part of the code that look\nlike this;\n\n    \n    \n    // render the table\n     var peopleTable = tabulate(data, [\"date\", \"close\"]);\n    \n\nThis portion simply calls the `tabulate` function using the `date` and `close`\ncolumns of our `data` array. Simply add or remove whichever columns you want\nto appear in your table (so long as they are in your data.csv file) and they\nwill be in your table. The tabulate function makes up all of the other part of\nthe added code.\n\nSo we come to the first block of the tabulate function;\n\n    \n    \n    // The table generation function\n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 400px\"),\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n\nHere the tabulate function is declared (`function tabulate`) and the variables\nthat the function will be using are specified (`(data, columns)`). In our case\n`data` is of course our `data` array and `columns` refers to `[\"date\",\n\"close\"]`.\n\nThe next line appends the table to the `body` of the web page (so it will\noccur just under the graph in this case). Then we do something slightly\nsneaky. The line `.attr(\"style\", \"margin-left: 400px\"),` is actually not the\ncode that was used to produce the table with the huge date/ time formatted\ninfo on. I deliberately used `.attr(\"style\", \"margin-left: 0px\"),` for the\nhuge date / time table since it’s job is to indent the table by a specified\namount from the left hand side of the page. And since the huge date time\nvalues would have pushed the table severely to the right, I cheated and used\n`0` instead of `400`. For the purposes of the final example where the date /\ntime values are formatted as expected, `400` is a good value.\n\nThe next two lines declare the functions we will use to add in the header\ncells (since they use the `<th>` tags for content) and the cells for the main\nbody of the table (they use `<td>`).\n\nThe next block of code adds in the header row;\n\n    \n    \n        // append the header row\n        thead.append(\"tr\")\n            .selectAll(\"th\")\n            .data(columns)\n            .enter()\n            .append(\"th\")\n                .text(function(column) { return column; });\n    \n\nHere we first append a row tag (`<tr>`), then we gather all the `columns` that\nwe have in our function (remember they were `[\"date\", \"close\"]`) and add them\nto our row using header tags (`<th>`).\n\nThe next block of code assigns the `row` variable to return (append) a row tag\n(`<tr>`) whenever it’s called …\n\n    \n    \n        // create a row for each object in the data\n        var rows = tbody.selectAll(\"tr\")\n            .data(data)\n            .enter()\n            .append(\"tr\");\n    \n\n… and it is in the following block of code…\n\n    \n    \n        // create a cell in each row for each column\n        var cells = rows.selectAll(\"td\")\n            .data(function(row) {\n                return columns.map(function(column) {\n                    return {column: column, value: row[column]};\n                });\n            })\n            .enter()\n            .append(\"td\")\n            .attr(\"style\", \"font-family: Courier\") // sets the font style\n                .html(function(d) { return d.value; });\n    \n\n… where we select each row that we’ve added (`var cells =\nrows.selectAll(\"td\")`). Then the following five lines works out from the\nintersection of the row and column which piece of data we’re looking at for\neach cell.\n\nThe last four lines take that piece of data (`d.value`) and wrap it in table\ndata tags (`<td>`) and place it in the correct cell as HTML.\n\nIt’s a very neat piece of code and I struggle to get my head around it, but\nthat doesn’t mean that I can’t appreciate the cleverness of it :-).\n\n#### Wrap up\n\nSo there we have it. Hopefully enough to explain what is going on and perhaps\nalso enough to convince ourselves that D3 is indeed more than just pretty\npictures. It’s all about the Data Driven Documents.\n\nAs mentioned earlier, there is a copy of the code and the data file for this\nexample at\n[github](https://gist.github.com/d3noob/3e5138a14cfc1822eedee2963c493399) and\nin the code samples bundled with this book (simple-graph-plus-table.html and\ndata.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3e5138a14cfc1822eedee2963c493399).\n\n### More table madness: sorting, prettifying and adding columns\n\nWhen we last left our tables they were happily producing a faithful list of\nthe data points that we had in our graph.\n\nBut what if we wanted more?\n\nFrom the original contributors that bought you tables ([Shawn\nAllen](http://jsfiddle.net/7WQjr/) on [Google\nGroups](http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-\nto-a-csv-file)) and some neat additions from [Christophe\nViau](http://christopheviau.com/d3_tutorial/) comes extra coolness that I\ndidn’t include in the [previous example](chap11.xhtml#tables) :-).\n\nThere is a copy of the code and the data file for this example at\n[github](https://gist.github.com/d3noob/6f41685b1cd675d2d3de4f8a14777774) and\nin the code samples bundled with this book (simple-graph-plus-table-plus-\naddins.html and data2.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/6f41685b1cd675d2d3de4f8a14777774).\n\n#### Add another column of information:\n\nFirstly, lets add another column of data to our table. To do this we want to\nhave something extra in our csv file to use, so let’s resurrect our old friend\ndata2.csv that we used for the graph with two lines previously. All we have to\ndo to make this a reality is change the reference that loads `data.csv` to\n`data2.csv` here;\n\n    \n    \n    d3.csv(\"data2.csv\", function(error, data) {\n    \n\nThis makes the assumption that you still have the data2.csv file in place. If\nnot, rush away and get it from the download of code samples from Leanpub.\n\nFrom here (and as promised in the previous chapter), it’s just a matter of\nadding in the extra column you want (in this case it’s the `open` column) like\nso;\n\n    \n    \n     var peopleTable = tabulate(data, [\"date\", \"close\", \"open\"]);\n    \n\n![Table with extra column](images/table03.png) Table with extra column\n\nYes, if you’re wondering, I have cheated slightly and changed the table indent\nto make it look slightly prettier.\n\nSo can we go further?\n\nYou know we can…\n\nIn the section where we format our data, lets add another column to our array\nin the form of a difference between the `close` value and the `open` value\n(and we’ll call it `diff`).\n\n    \n    \n      // format the data\n      data.forEach(function(d) {\n          d.date1 = parseTime(d.date);\n          d.close = +d.close;\n          d.open = +d.open;  //  <= added this for tidy house keeping\n          d.diff = Math.round(( d.close - d.open ) * 100 ) / 100;\n      });\n    \n\n(the `Math.round` function is to make sure we get a reasonable figure to\ndisplay, otherwise it tends to get carried away with decimal places)\n\nSo now we add in our new column (`diff`) to be tabulated;\n\n    \n    \n     var peopleTable = tabulate(data, [\"date\", \"close\", \"open\", \"diff\"]);\n    \n\n![Table with extra extra column](images/table04.png) Table with extra extra\ncolumn\n\nAnd yes, I changed the table indent again. I am a serial offender and will\ncontinue to change it to suit.\n\n#### Sorting on a column\n\nSo now with our four columns of awesome data, it turns out that we’re really\ninterested in the ones that have the highest `close` values. So we can sort on\nthe `close` column by adding the following lines directly after the line where\nwe declare the `peopleTable` function (which I will include in the code\nsnipped below for reference).\n\n    \n    \n    // render the table\n    var peopleTable = tabulate(data, [\"date\", \"close\", \"open\", \"diff\"]);\n    \n    peopleTable.selectAll(\"tbody tr\") \n               .sort(function(a, b) {\n                 return d3.descending(a.close, b.close);\n               });\n    \n\nWhich works magnificently;\n\n![Table sorted descending on 'close'](images/table05.png) Table sorted\ndescending on ‘close’\n\n#### Prettifying (actually just capitalising the header for each column)\n\nJust a little snippet that capitalises the headers for each row to make them\nlook slightly more authoritative.\n\nAdd the following lines of code directly below the block that you just added\nfor sorting the table;\n\n    \n    \n    peopleTable.selectAll(\"thead th\")\n               .text(function(column) {\n                 return column.charAt(0).toUpperCase() + column.substr(1);\n               });\n    \n\nThis is quite a tidy little piece of script. You can see it selecting the\nheaders (`selectAll(\"thead th\")`), then the first character in each header\n(`column.charAt(0)`), changing it to upper-case (`.toUpperCase()`) and adding\nit back to the rest of the string (`+ column.substr(1)`).\n\nWith the ultimate result…\n\n![Table with capitalised first characters in headers](images/table06.png)\nTable with capitalised first characters in headers\n\n#### Add borders\n\nSure our table looks nice and neatly arranged, but would a border look better?\n\nWell, here’s one way to do it;\n\nAll we need to do is add a border style to our table by adding in this line\nhere;\n\n    \n    \n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 200px\") // <= Remove the comma\n                .style(\"border\", \"2px black solid\"), // <= Add this line in\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n\n(don’t forget to move the comma from the end of the `margin-left` line)\n\nAnd the result is a tidy black border.\n\n![Table with a border](images/table07.png) Table with a border\n\nOK, so what about the individual cells?\n\nNo problem.\n\nIf we remember back to our CSS that we added in, we’ll just tell each cell\nthat we want a 1 pixel border buy amending the CSS for our table to this;\n\n    \n    \n    td, th {\n        padding: 1px 4px;\n        border: 1px black solid;\n    }\n    \n\nSo now each cell has a slightly more subtle border like this;\n\n![Table with cells with individual borders](images/table08.png) Table with\ncells with individual borders\n\nYikes! Not quite as subtle as I would have expected. I suppose it’s another\nexample of the code actually doing what you asked it to do. No problem,\n`border-collapse` to the rescue. Add the following line into here;\n\n    \n    \n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 200px\")\n                .style(\"border-collapse\", \"collapse\")   // <= Add this line in.\n                .style(\"border\", \"2px black solid\"),\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n\nHow does that look?\n\n![Table with cells with collapsed borders](images/table09.png) Table with\ncells with collapsed borders\n\nAhh…. Much more refined.\n\nThe `border-collapse` style tells the table to overlap each cell’s borders,\nrather than treat them as discrete entities. So in this case it looks a bit\nbetter.\n\n### Adding web links to d3.js objects\n\nThe idea with this tip / trick is to be able to add a ‘link’ to an object so\nthat when you click on it, it takes you to a web page that we will pre-define.\n\nWe are going to generate a simple rectangle with some text and look at linking\nfrom the rectangle and the text separately and with some fanciness at the end\n:-).\n\nThe end result will be something that looks a little like this;\n\n![Objects with links](images/xlink-01.png) Objects with links\n\n(Notice the little pointing finger at the bottom that would indicate that\nthere actually _is_ a link there.)\n\nThe code that we will use as a starting point is this simple example that\ndraws a green rectangle and overlays some text on it;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n     \n    var width = 449;\n    var height = 249;\n    var word = \"gongoozler\";\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw a rectangle\n    holder.append(\"rect\")  \n        .attr(\"x\", 100)\n        .attr(\"y\", 50)\n        .attr(\"height\", 100)\n        .attr(\"width\", 200)\n        .style(\"fill\", \"lightgreen\")\n        .attr(\"rx\", 10)\n        .attr(\"ry\", 10);\n    \n    // draw text on the screen\n    holder.append(\"text\")\n        .attr(\"x\", 200)\n        .attr(\"y\", 100)\n        .style(\"fill\", \"black\")\n        .style(\"font-size\", \"20px\")\n        .attr(\"dy\", \".35em\")\n        .attr(\"text-anchor\", \"middle\")\n        .text(word);\n    \n    </script>\n    \n    </body>\n    \n\nThere’s nothing too spectacular about the file. There’s a little bit of\nstyling and tweaking of attributes, but nothing too extreme. The only slightly\n‘odd’ part would be defining the word that is printed out as a variable (`var\nword = \"gongoozler\";`) and then adding it as a variable (`.text(word);`)\ninstead of just putting the word directly in there (which we could do like\nthis `.text(\"gongoozler\");`). We’re going to do this deliberately to explore\nadditional options for making our links a little more dynamic.\n\n#### It’s all about the ‘a’ and the ‘xlink’\n\nThe `<a>` tag in an HTML file defines a\n[hyperlink](http://www.w3schools.com/html/html_links.asp). Items bounded by an\n`<a>` tag will become a link to another web address. So what we will do is\ncreate an `<a>` tag and then append our d3.js, svg object to it.\n\nOf course, as well as including a link, we need to tell it where to go. We do\nthis by setting the `xlink:href` attribute for our tag to point to a specific\npage. Xlink is short for XML Linking Language and it is used to create\nhyperlinks in XML documents. In our case we will be defining the link that we\nwill want our user to go to.\n\n#### Adding in the links\n\nThe following is the adjusted code for our rectangle that adds in the `<a>`\ntag with the `xlink:href` attribute.\n\n    \n    \n    holder.append(\"a\")\n        .attr(\"xlink:href\", \"http://en.wikipedia.org\")\n        .append(\"rect\")  \n        .attr(\"x\", 100)\n        .attr(\"y\", 50)\n        .attr(\"height\", 100)\n        .attr(\"width\", 200)\n        .style(\"fill\", \"lightgreen\")\n        .attr(\"rx\", 10)\n        .attr(\"ry\", 10);\n    \n\nIt’s important to append the link before the object (otherwise it won’t work)\nbut other than that, it’s a pretty simple job.\n\nThe only fly in the ointment is that while we now have a rectangle that links\nto Wikipedia, if we hover our mouse over the text, we lose our link (since we\nhaven’t told the text to link anywhere).\n\nWe can remedy that by doing exactly the same thing with the text element;\n\n    \n    \n    holder.append(\"a\")\n        .attr(\"xlink:href\", \"http://en.wikipedia.org/wiki/\"+word)\n        .append(\"text\")\n        .attr(\"x\", 200)\n        .attr(\"y\", 100)\n        .style(\"fill\", \"black\")\n        .style(\"font-size\", \"20px\")\n        .attr(\"dy\", \".35em\")\n        .attr(\"text-anchor\", \"middle\")\n        .text(word);\n    \n\nThe only slight difference here is that we have used the address for Wikipedia\nas our base and added the variable for our word to the end of it so that the\nresulting web address takes us to Wikipedia and the specific page for the word\n‘gongoozler’. Hopefully this will indicate that if we had a set of variables\nin an array we would make our links a little more dynamic.\n\n#### Making the mouse pointer ignore an object\n\nSo in theory we’re done, but in practice this has been a slightly crude method\nfor adding what should be a _single_ link to two objects when we should be\nable to accomplish it by defining the link once.\n\nWhat we could do as an alternative to linking both the rectangle and the text\nusing two separate links is to make the mouse ignore the text and have it rely\nsolely on the rectangle. We can do this using the `pointer-events` style when\ndrawing our text. By setting it to `none` we are instructing our mouse to\nignore any potential interaction with the text when it hovers over it and\ninstead the pointer will register the link on the rectangle below it.\n\nThe code for the text therefore becomes…\n\n    \n    \n    holder.append(\"text\")\n        .attr(\"x\", 200)\n        .attr(\"y\", 100)\n        .style(\"fill\", \"black\")\n        .style(\"font-size\", \"20px\")\n        .attr(\"dy\", \".35em\")\n        .attr(\"text-anchor\", \"middle\")\n        .style(\"pointer-events\", \"none\")\n        .text(word);\n    \n\nAnd as you can see from the image below, the pointer will happily ignore the\ntext while reading the link from the rectangle.\n\n![Objects with links](images/xlink-02.png) Objects with links\n\nThe complete code for this example is available in the appendices and a live\nversion can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/87d9880fd5ae41b8fb5e309b59031002) and\n[GitHub](https://gist.github.com/d3noob/87d9880fd5ae41b8fb5e309b59031002). The\ncode is also in the downloadable files available from Leanpub with the book in\na file called ‘xlink-rect-pointer-events.html’.\n\n### Using the Yahoo Query Language (YQL) to get data.\n\nOne of the things that I find frustrating is difficulty getting data to play\nwith. Often I will find myself thinking “It would be neat to see if this\ntechnique works” but then I spend a couple of hours looking for data that will\nbe appropriate.\n\nAnother difficulty is that access to dynamic data is also problematic. D3.js\nreally shines when displaying information that is changing and interactive.\nFinding data that is changing and which you can interact with is not easy.\n\nThen, when you do come across a web site that has an interesting data set,\naccessing that data becomes programmatically difficult because of restrictions\nin accessing information that crosses domains. A solution to this problem (and\nthere are a few) is to have a data set that is in a domain that permits\n[Cross-Origin Resource Sharing](http://en.wikipedia.org/wiki/Cross-\norigin_resource_sharing) (CORS). These are not as common as you might hope as\nit presents security concerns that need to be addressed.\n\nOne resource that I have come across is particularly useful for solving the\nproblems outlined above is the [Yahoo! Developer\nNetwork](http://developer.yahoo.com/yql/) which operates a service where you\ncan write a query in an SQL type fashion that will return data as formatted\n[JSON](chap11.xhtml#json) (or others). This query can be formed into an http\nrequest so that you can simply paste a generated URL directly into your\nbrowsers URL bar and it will return the requested data. Better than that,\nbecause it supports CORS (and because d3.js can manage a CORS request without\nbreaking a sweat) all you need to do is put the URL into you code (as a\n`d3.json` call for example) and you will be up and running.\n\n#### YQL by example\n\nI will use an example of looking for current weather information for\nWellington New Zealand from the [Weather\nUnderground](http://www.wunderground.com/) (wunderground).\n\nIn this example, we’re interested in retrieving a JSON ‘blob’ that contains\ndata on the weather conditions (temperature, wind speed / direction, humidity\netc) for a specific location.\n\nStart at the page for the console (<http://developer.yahoo.com/yql/console/>).\nOn the left there is a range of data ‘topics that you can choose from. We will\nwant to access one of the community tables, so select ‘Show Community Tables’\nand scroll down the list until you find ‘wunderground’ and\n‘wunderground.currentobservation’\n\n![Select Community Tables and\nwunderground.currentobservation](images/yql-01.png) Select Community Tables\nand wunderground.currentobservation\n\nThis will bring up a query in the console that is looking for the current\nweather from San Francisco International airport.\n\n![Query for weather from San Francisco](images/yql-02.png) Query for weather\nfrom San Francisco\n\nFor our example we want to be a bit more specific, so we replace the ‘SFO’\n‘location’ with ‘Wellington, New Zealand’.\n\nIf you then click on the ‘Test’ button the query will run and results will be\npresented in the box below it;\n\n![JSON weather from San Francisco](images/yql-03.png) JSON weather from San\nFrancisco\n\nIf that looks like the results you were expecting, fantastic!\n\nThe next gem from YQL is the\n[REST](http://en.wikipedia.org/wiki/Representational_state_transfer) query\nthat is automatically generated at the bottom of the page;\n\n![REST Query](images/yql-04.png) REST Query\n\nIf you select this query and past it in your URL bar, you will have the JSON\ndata returned into your browser.\n\nAt this point it might seem a bit confusing, and if you’re unfamiliar with how\nJSON based data sets are structured it will DEFINITELY be confusing (You will\nneed to do some research to get up to speed there). My advice is to first\nunderstand a bit about JSON and then examine the output from the REST query in\nthe developer console on your browser (this is a fairly long topic in itself,\nso I will not cover it here sorry). Additionally check out the ‘Examples’\nchapter for real world usage.\n\nIf you are comfortable with understanding how the data can be encoded, it is\nthen just a matter of including the REST query in your call when selecting\ndata using `d3.json` and you will be away.\n\nPlease check out the examples I will include in the ‘Examples’ chapter for a\ndeeper look at the use of the data with d3.js (This will also help with\nunderstanding the JSON structure).\n\n### Export an image from a d3.js page as a SVG or bitmap\n\nAt some point you will want to take your lovingly crafted D3 graphical\nmasterpiece and put it in a (close your eyes if you’re squeamish) Power Point\npresentation or Word document or export it for sharing in some other way.\n\nThere could be many reasons for wanting to do this and some may be more\ncomplicated than I will be willing to explore, but for the occasional\nconversion of images I have found what I regard as a fairly easy process.\n\nBefore we begin our exporting odyssey, let’s cover a little bit of\nhousekeeping and describe the difference between a vector graphic (in this\ncase specifically Scalable Vector Graphics) and a bitmap. Please skip ahead if\nyou’re comfortable with the terms.\n\n#### Bitmaps\n\nA bitmap (or raster) image is one that is composed of lots of discrete\nindividual dots (let’s call them pixels) which, when joined together (and\nzoomed out a bit) give the impression of an image. If we use the force layout\nexample we developed, and look at a screen shot (and it’s important to\nremember that this is a screen shot) of the image we see a picture that looks\nfairly benign.\n\n![A bitmap at a normal zoom level](images/prezoom.png) A bitmap at a normal\nzoom level\n\nHowever, as we enlarge the image by doubling its size (x 2) we begin to see\nsome rough edges appear.\n\n![A bitmap at 200%](images/prezoomx2.png) A bitmap at 200%\n\nAnd if we enlarge it by doubling again (x 4) , it starts to look decidedly\nrough.\n\n![A bitmap at 400%](images/prezoomx4.png) A bitmap at 400%\n\nDoubling again (x 8), starts to show the pixels pretty clearly.\n\n![A bitmap at 800%](images/prezoomx8.png) A bitmap at 800%\n\nDoubling again for the last time (x 16) and the pixels are plainly evident.\n\n![A bitmap at 1600%](images/prezoomx16.png) A bitmap at 1600%\n\nBitmaps can be saved in a wide range of formats depending on the users\nrequirements including compression, colour depth, transparency and a host of\nother attributes. Typically they can be identified by the file suffix .jpg,\n.png or .bmp (and there are an equally large number of other suffixes).\n\nThis will be the type of format that most people will be familiar with for\nimages and their ubiquity with the advent of digital cameras almost makes it\nredundant to describe them.\n\nHowever, there is another type of image and it is even more important to d3.js\nusers.\n\n#### Vector Graphics (Specifically SVG)\n\nScalable Vector Graphics (SVG) use a technique of drawing an image that relies\nmore on a description of an image than the final representation that a user\nsees. Instead of arranging individual pixels, an image is created by\ndescribing the way the image is created.\n\nFor instance, drawing a line would be accomplished by defining two sets of\ncoordinates and specifying a line of a particular width and colour be drawn\nbetween the points.\n\nThis might sound a little long winded, and it does create a sense of\nabstraction, but it is a far more powerful mechanism for drawing as there is\nno loss of detail with increasing scale. Changes to the image can be simply\ncarried out by adjusting the coordinates, colour description, line width or\ncurve diameter. If this all sounds a little familiar, you have _definitely_\nbeen paying attention, because this is the heart of the way that d3.js draws\nimages in a browser. It uses a combination of coordinates, shapes and\nattributes to create vector images in a web page.\n\nAs a demonstration of the difference, here is the same original picture which\nI have saved as a SVG image.\n\n![A SVG image at a normal zoom level](images/svgzoom.png) A SVG image at a\nnormal zoom level\n\nEnlarged by doubling its size (x 2) everything looks smooth.\n\n![A SVG at 200%](images/svgzoomx2.png) A SVG at 200%\n\nIf we enlarge it by doubling again (x 4) , it still looks good.\n\n![A SVG at 400%](images/svgzoomx4.png) A SVG at 400%\n\nDoubling again (x 8) and we can see that the text ‘James’ is actually composed\nof a fill colour and a border.\n\n![A SVG at 800%](images/svgzoomx8.png) A SVG at 800%\n\nDoubling again for the last time (x 16) everything still retains its clear\nsharp edges.\n\n![A SVG at 1600%](images/svgzoomx16.png) A SVG at 1600%\n\n#### Let’s get exporting!\n\nWe’ll use a three stage process for exporting our image (assuming the desired\nend result is a bitmap) and usefully, the first stage will result in us having\na vector image as well!\n\nThe sequence will go as follows:\n\n  1. Copy the image from the web page and save it as a SVG file\n  2. Open the SVG image in a program designed to use vector images and edit it if required.\n  3. Export that image as a bitmap\n\n##### Copying the image off the web page\n\nGetting the image out of a web page is made easy by using ‘[SVG\nCrowbar](http://nytimes.github.io/svg-crowbar/)’. This is a “ _A Chrome-\nspecific bookmarklet that extracts SVG nodes and accompanying styles from an\nHTML document and downloads them as an SVG file_ ”. What that means is that\nonce you drag the bookmarklet from the web page to your bookmarks (You need to\nbe using Google Chrome, and I’m told that about 60% of the people who visit\nd3noob.org do) you’re ready to go.\n\n![Drag the 'SVG Crowbar' Object from the web page to your bookmarks\nbar](images/svgcrowbar.png) Drag the ‘SVG Crowbar’ Object from the web page to\nyour bookmarks bar\n\nNow when you have a web page open that’s displaying a D3 creation, all you\nneed to do is click on the SVG Crowbar bookmark and you will be prompted for a\nlocation to save a svg image.\n\nReally. It’s that simple.\n\n##### Open the SVG Image and Edit\n\nObviously now that you have a SVG image, you need to be able to do something\nwith it. My preferred software for this is [Inkscape](http://inkscape.org/).\n\nInkscape is “ _An Open Source vector graphics editor, with capabilities\nsimilar to Illustrator, CorelDraw, or Xara X, using the W3C standard Scalable\nVector Graphics (SVG) file format_ ”.\n\nIt really is an extremely capable drawing program and it is capable of a lot\nmore than the job we’re going to use it for, so you may find it has other uses\nthat may be valuable.\n\nOnce installed, you can open the saved file directly into Inkscape.\n\n![Inkscape with our force diagram](images/inkscape.png) Inkscape with our\nforce diagram\n\nWhile here you can edit the drawing to your hearts delight. I particularly\nrecommend ungrouping the diagram and removing or adjusting individual elements\nif required.\n\nOnce you have finished editing, you are ready for the final step.\n\n##### Saving as a bitmap\n\nWhile still in Inkscape, go to the ‘File’, ‘Export Bitmap…’ menu.\n\n![Inkscape Export Bitmap menu](images/inkscape-export.png) Inkscape Export\nBitmap menu\n\nThis will open a dialog box where you can select an appropriate resolution and\nlocation for your bitmap and then press the export button.\n\n![Inkscape Export Bitmap dialog](images/inkscape-export-dialog.png) Inkscape\nExport Bitmap dialog\n\nThere you go.\n\nIt is worth knowing that the default settings here will export the diagram\nwith a transparent background (using *.png) which will fit in nicely with a\nwide range of graphical end uses.\n\n### Understanding JavaScript Object Notation (JSON)\n\nOne of the most useful things you might want to learn when understanding how\nto present your data with D3 is how to _structure_ your data so that it is\neasy to use.\n\nAs explained earlier in the book, there are several different types of data\nthat can be requested by D3 including text, Extensible Markup Language (XML),\nHyperText Markup Language (HTML), Comma Separated Values (CSV), Tab Separated\nValues (TSV) and JavaScript Object Notation (JSON).\n\nComma separated values and tab separated values are fairly well understood\nforms of data. They are expressed as rows and columns of information that are\nseparated using a known character. While these forms of data are simple to\nunderstand, it is not easy to incorporate a hierarchy structure to the data,\nand when you try, it isn’t natural and makes managing the data difficult.\n\nJavaScript Object Notation (JSON) presents a different mechanism for storing\ndata. A light weight description could read “ _JSON is a text-based open\nstandard designed to present human-readable data. It is derived from the\nJavaScript scripting language, but it is language and platform independent._ ”\n\nUnfortunately, when I first started using JSON, I struggled with the concept\nof how it was structured, in spite of some fine descriptions on the web (start\nwith <http://www.json.org/> in my humble opinion). So the following is how I\ncame to think of and understand JSON.\n\n**Fair Warning:** This advice is no substitute for the correct explanation of\nthe topic of data structures that I’m sure you could receive from a reputable\neducational site or institution. It’s just the way I like to think of it :-).\nIt’s also just the way that I _started_ to understand JSON. There is plenty to\nlearn and understand once you grasp the basics. So this isn’t a complete\nguide. Just the beginnings.\n\nIn the following steps we’ll go through a process that (hopefully)\ndemonstrates that we can transform identifiers that would represent the\nclosing price for a stock of 58.3 on 2013-03-14 into more traditional x,y\ncoordinates.\n\nI think of data as having an identifier and a value.\n\n    \n    \n    identifier: value\n    \n\nIf a point on a graph is located at the x,y coordinates 150,25 then the\nidentifier ‘x’ has a value 150.\n\n    \n    \n    \"x\": 150\n    \n\nIf the x axis was a time-line, the true value for ‘x’ could be “2013-03-14”.\n\n    \n    \n    \"x\": \"2013-03-14\"\n    \n\nThis example might look similar to those seen by users of d3.js, since if\nwe’re using date / time format we can let D3 sort out the messy parts like\nwhat coordinates to provide for the screen.\n\nAnd there’s no reason why we couldn’t give the ‘x’ identifier a more human\nreadable label such as “date”. So our data would look like;\n\n    \n    \n    \"date\": \"2013-03-14\"\n    \n\nThis is only one part of our original x,y = 150,25 data set. The same way that\nthe x value represented a position on the x axis that was really a date, the y\nvalue represents a position on the y axis that is really another number. It\nonly gets converted to 25 when we need to plot a position on a graph at\n150,25. If the ‘y’ component represents the closing price of a stock we could\ntake the same principles used to transform…\n\n    \n    \n    \"x\": 150\n    \n\n… into …\n\n    \n    \n    \"date\": \"2013-03-14\"\n    \n\n… to change ….\n\n    \n    \n    \"y\": 25\n    \n\n… into …\n\n    \n    \n    \"close\": 58.3\n    \n\nThis might sound slightly confusing, so try to think of it this way. We want\nto plot a point on a graph at 150,25, but the data that this position is\nderived from is really “2013-03-14”, 58.3. D3 can look after all the scaling\nand determination of the range so that the point gets plotted at 150,25 and\nour originating data can now be represented as;\n\n    \n    \n    \"date\": \"2013-03-14\", \"close\": 58.3\n    \n\nThis represents two separate pieces of data. Each of which has an identifier\n(“date” or “close”) and a value (“2013-03-14” and 58.3)\n\nIf we wanted to have a series of these data points that represented several\ndays of closing prices, we would store them as an array of identifiers and\nvalues similar to this;\n\n    \n    \n    { \"date\": \"2013-03-14\", close: 58.13 },\n    { \"date\": \"2013-03-15\", close: 53.98 },\n    { \"date\": \"2013-03-16\", close: 67.00 },\n    { \"date\": \"2013-03-17\", close: 89.70 },\n    { \"date\": \"2013-03-18\", close: 99.00 }\n    \n\nEach of the individual elements of the array is enclosed in curly brackets and\nseparated by commas.\n\nI am making the assumption that you are familiar with the concept of what an\n‘array’ is. If this is an unfamiliar word, in the context of data, then I\nstrongly recommend that you do some Goggling to build up some familiarity with\nthe principle.\n\nNow that we have an array, we can apply the same rules to it as we did the the\nitem that had a single value. We can give it an identifier all of its own. In\nthis case we will call it “data”. Now we can use our identifier: value analogy\nto use “data” as the identifier and the array as the value.\n\n    \n    \n    { \"data\": [\n      { \"date\": \"2013-03-14\", close: 58.13 },\n      { \"date\": \"2013-03-15\", close: 53.98 },\n      { \"date\": \"2013-03-16\", close: 67.00 },\n      { \"date\": \"2013-03-17\", close: 89.70 },\n      { \"date\": \"2013-03-18\", close: 99.00 }\n    ] }\n    \n\nThe array has been enclosed in square brackets to designate it as an array and\nthe entire identifier: value sequence has been encapsulated with curly braces\n(much the same way that the subset “date”, “close” values were enclosed with\ncurly braces.\n\nIf we try to convey the same principle in a more graphical format, we could\nshow our initial identifier and value for the x component like so;\n\n![Single identifier and value](images/iv-01.png) Single identifier and value\n\nThe we can add our additional component for the y value;\n\n![Single identifier and value](images/iv-02.png) Single identifier and value\n\nWe can then add several of these combinations together in an array;\n\n![Single identifier and value](images/iv-03.png) Single identifier and value\n\nThen the array becomes a value for another identifier “data”;\n\n![Single identifier and value](images/iv-04.png) Single identifier and value\n\nMore complex JSON files will have multiple levels of identifiers and values\narranged in complex hierarchies which can be difficult to interpret. However,\nlaying out the data in a logical way in a text file is an excellent way to\nstart to make sense of the data.\n\n\n## D3.js Examples Explained\n\nI’ve decided to include an examples chapter because I have occasionally come\nacross things that I wanted to do with data or a technique that didn’t\nnecessarily fall into a specific category or where I had something that I\nwanted to do that went beyond an exercise that I would want to turn into a\nsimple description.\n\nIn other words I think that this will be a place where I can put random\ngraphics that I have made up that don’t necessarily fall into a logical\ncategory but which I think would be worth recording.\n\nIn many cases these examples will combine a range of techniques that have been\nexplained in the book and in some cases they may include new material that\nperhaps I would have struggled to explain without putting the technique into\nbetter context.\n\nWhatever the case, I will try to explain the examples as best I can and to\ninclude a full code listing for each and a link to an electronic version\nwherever possible.\n\n### Multi-line graph with automatic legend and toggling show / hide lines.\n\n#### Purpose\n\nCreating a multi-line graph is a pretty handy thing to be able to do and we\nworked through an example earlier in the book as an extension of our simple\ngraph. In that example we used a csv file that had the data arranged with each\nlines values in a separate column.\n\n    \n    \n    date,close,open\n    1-May-12,68.13,34.12\n    30-Apr-12,63.98,45.56\n    27-Apr-12,67.00,67.89\n    26-Apr-12,89.70,78.54\n    25-Apr-12,99.00,89.23\n    24-Apr-12,130.28,99.23\n    23-Apr-12,166.70,101.34\n    \n\nThis is a common way to have data stored, but if you are retrieving\ninformation from a database, you may not have the luxury of having it laid out\nin columns. It may be presented in a more linear fashion where each lines\nvalues are stores on a unique row with the identifier for the line on the same\nrow. For instance, the data above could just as easily be presented as\nfollows;\n\n    \n    \n    price,date,value\n    close,1-May-12,68.13\n    close,30-Apr-12,63.98\n    close,27-Apr-12,67.00\n    close,26-Apr-12,89.70\n    close,25-Apr-12,99.00\n    close,24-Apr-12,130.28\n    close,23-Apr-12,166.70\n    open,1-May-12,34.12\n    open,30-Apr-12,45.56\n    open,27-Apr-12,67.89\n    open,26-Apr-12,78.54\n    open,25-Apr-12,89.23\n    open,24-Apr-12,99.23\n    open,23-Apr-12,101.34\n    \n\nIn this case, we would need to ‘pivot’ the data to produce the same multi-\ncolumn representation as the original format. This is not always easy, but it\ncan be achieved using the d3 [`nest`](chap07.xhtml#nest) function which we\nwill examine.\n\nAs well as this we will want to automatically encode the lines to make them\ndifferent colours and to add a legend with the line name and the colour of the\nappropriate line.\n\nFinally, because we will build a graph script that can cope with any number of\nlines (within reason), we will need to be able to show / hide the individual\nlines to try and clarify the graph if it gets too cluttered.\n\nAll of these features have been covered individually in the book, so what\nwe’re going to do is combine them in a way that presents us with an elegant\nmulti-line graph that looks a bit like this;\n\n![Multi-line graph with legend](images/super-01.png) Multi-line graph with\nlegend\n\n#### The Code\n\nThe following is the code for the initial example which is a slight derivative\nof the original simple graph. A live version is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/755a069aafbe66f3fd8497b9498df643) or\n[GitHub](https://gist.github.com/d3noob/755a069aafbe66f3fd8497b9498df643). It\nis also available as the files ‘super-multi-lines.html’ and ‘stocks.csv’ as a\ndownload with the book D3 Tips and Tricks (in a zip file) when you [download\nthe book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    body { font: 12px Arial;}\n    \n    path { \n        stroke: steelblue;\n        stroke-width: 2;\n        fill: none;\n    }\n    \n    .axis path,\n    .axis line {\n        fill: none;\n        stroke: grey;\n        stroke-width: 1;\n        shape-rendering: crispEdges;\n    }\n    \n    </style>\n    <body>\n    \n    <!-- load the d3.js library -->    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n    // Set the dimensions of the canvas / graph\n    var margin = {top: 30, right: 20, bottom: 30, left: 50},\n        width = 600 - margin.left - margin.right,\n        height = 270 - margin.top - margin.bottom;\n    \n    // Parse the date / time\n    var parseDate = d3.timeParse(\"%b %Y\");\n    \n    // Set the ranges\n    var x = d3.scaleTime().range([0, width]);  \n    var y = d3.scaleLinear().range([height, 0]);\n    \n    // Define the line\n    var priceline = d3.line()    \n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.price); });\n        \n    // Adds the svg canvas\n    var svg = d3.select(\"body\")\n        .append(\"svg\")\n            .attr(\"width\", width + margin.left + margin.right)\n            .attr(\"height\", height + margin.top + margin.bottom)\n        .append(\"g\")\n            .attr(\"transform\", \n                  \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Get the data\n    d3.csv(\"stocks.csv\", function(error, data) {\n        data.forEach(function(d) {\n            d.date = parseDate(d.date);\n            d.price = +d.price;\n        });\n    \n        // Scale the range of the data\n        x.domain(d3.extent(data, function(d) { return d.date; }));\n        y.domain([0, d3.max(data, function(d) { return d.price; })]);\n    \n        // Nest the entries by symbol\n        var dataNest = d3.nest()\n            .key(function(d) {return d.symbol;})\n            .entries(data);\n    \n        // Loop through each symbol / key\n        dataNest.forEach(function(d) { \n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .attr(\"d\", priceline(d.values));\n    \n        });\n    \n        // Add the X Axis\n        svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n        // Add the Y Axis\n        svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n    </script>\n    </body>\n    \n\n#### Description\n\n##### Nesting the data\n\nThe example code above differs from the simple graph in two main ways.\n\nFirstly, the script loads the file `stocks.csv` which was used by Mike Bostock\nin his [small multiples example](http://bl.ocks.org/mbostock/1157787). This\nmeans that the variable names used are different (`price` for the value of the\nstocks, `symbol` for the name of the stock and good old `date` for the date)\nand we have to adjust the `parseDate` function to parse a modified date value.\n\nSecondly we add the code blocks to take the `stocks.csv` information that we\nload as `data` and we apply the `d3.nest` function to it and draw each line.\n\nThe following code nest’s the data\n\n    \n    \n        var dataNest = d3.nest()\n            .key(function(d) {return d.symbol;})\n            .entries(data);\n    \n\nWe declare our new array’s name as `dataNest` and we initiate the `nest`\nfunction;\n\n    \n    \n    \tvar dataNest = d3.nest()\n    \n\nWe assign the `key` for our new array as `symbol`. A ‘key’ is like a way of\nsaying “ _This is the thing we will be grouping on_ ”. In other words our\nresultant array will have a single entry for each unique `symbol` or stock\nwhich will itself be an array of dates and values.\n\n    \n    \n    \t\t.key(function(d) {return d.symbol;})\n    \n\nThen we tell the nest function which data array we will be using for our\nsource of data.\n\n    \n    \n    \t\t}).entries(data);\n    \n\nThen we use the nested data to loop through our stocks and draw the lines\n\n    \n    \n        dataNest.forEach(function(d) {\n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .attr(\"d\", priceline(d.values));\n    \n        });\n    \n\nThe `forEach` function being applied to `dataNest` means that it will take\neach of the keys that we have just declared with the `d3.nest` (each stock)\nand use the values for each stock to append a line using its values.\n\nThe end result looks like the following;\n\n![A very plain multi-line graph](images/super-02.png) A very plain multi-line\ngraph\n\nYou would be justified in thinking that this is more than a little confusing.\nClearly while we have been successful in making each stock draw a\ncorresponding line, unless we can tell them apart, the graph is pretty\nuseless.\n\n##### Applying the colours\n\nMaking sure that the colours that are applied to our lines (and ultimately our\nlegend text) is unique from line to line is actually pretty easy.\n\nThe code that we will implement for this change is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/ae9786c26d6a821eefeabe60dec350a9) or\n[GitHub](https://gist.github.com/d3noob/ae9786c26d6a821eefeabe60dec350a9). It\nis also available as the files ‘super-multi-colours.html’ and ‘stocks.csv’ as\na download with the book D3 Tips and Tricks v4 (in a zip file) when you\n[download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThe changes that we will make to our code are captured in the following code\nsnippet.\n\n    \n    \n        // set the colour scale\n        var color = d3.scaleOrdinal(d3.schemeCategory10);\n    \n        // Loop through each symbol / key\n        dataNest.forEach(function(d) { \n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .style(\"stroke\", function() { // Add the colours dynamically\n                    return d.color = color(d.key); })\n                .attr(\"d\", priceline(d.values));\n    \n        });\n    \n\nFirstly we need to declare an [ordinal\nscale](https://github.com/d3/d3/blob/master/API.md#ordinal-scales) for our\ncolours with `var color = d3.scaleOrdinal(d3.schemeCategory10);`. This is a\nset of categorical colours (10 of them in this case) that can be invoked which\nare a nice mix of difference from each other and pleasant on the eye.\n\nWe then use the colour scale to assign a unique stroke (line colour) for each\nunique key (symbol) in our dataset.\n\n    \n    \n        .style(\"stroke\", function() {\n            return d.color = color(d.key); })\n    \n\nIt seems easy when it’s implemented, but in all reality, it is the product of\nsome very clever thinking behind the scenes when designing d3.js and even\npicking the colours that are used. The end result is a far more usable graph\nof the stock prices.\n\n![Multi-line graph with unique colours](images/super-03.png) Multi-line graph\nwith unique colours\n\nOf course now we’re faced with the problem of not knowing which line\nrepresents which stock price. Time for a legend.\n\n##### Adding the legend\n\nIf we think about the process of adding a legend to our graph, what we’re\ntrying to achieve is to take every unique data series we have (stock) and add\na relevant label showing which colour relates to which stock. At the same\ntime, we need to arrange the labels in such a way that they are presented in a\nmanner that is not offensive to the eye. In the example I will go through I\nhave chosen to arrange them neatly spaced along the bottom of the graph. so\nthat the final result looks like the following;\n\n![Multi-line graph with legend](images/super-01.png) Multi-line graph with\nlegend\n\nBear in mind that the end result will align the legend completely\nautomatically. If there are three stocks it will be equally spaced, if it is\nsix stocks they will be equally spaced. The following is a reasonable\nmechanism to facilitate this, but if the labels for the data values are of\nradically different lengths, the final result will looks ‘odd’ likewise, if\nthere are a LOT of data values, the legend will start to get crowded.\n\nThe code that we will implement for this change is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/f8b7f107ba25c21971851728520224cb) or\n[GitHub](https://gist.github.com/d3noob/f8b7f107ba25c21971851728520224cb). It\nis also available as the files ‘super-multi-legend.html’ and ‘stocks.csv’ as a\ndownload with the book D3 Tips and Tricks v4 (in a zip file) when you\n[download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThere are three broad categories of changes that we will want to make to our\ncurrent code;\n\n  1. Declare a style for the legend font\n  2. Change the area and margins for the graph to accommodate the additional text\n  3. Add the text\n\nDeclaring the style for the legend text is as easy as making an appropriate\nentry in the `<style>` section of the code. For this example we can choose the\nfollowing;\n\n    \n    \n    .legend {\n        font-size: 16px;\n        font-weight: bold;\n        text-anchor: middle;\n    }\n    \n\nTo change the area and margins of the graph we can make the following small\nchanges to the code.\n\n    \n    \n    var margin = {top: 30, right: 20, bottom: 70, left: 50},\n        width = 600 - margin.left - margin.right,\n        height = 300 - margin.top - margin.bottom;\n    \n\nThe bottom margin is now 70 pixels high and the overall space for the area\nthat the graph (including the margins) covers is increased to 300 pixels.\n\nTo add the legend text is slightly more work, but only slightly more. The\nfollowing code incorporates the changes and there are commented out asterisks\nto the end of the lines that have been added\n\n    \n    \n        legendSpace = width/dataNest.length; // spacing for legend // ******\n    \n        // Loop through each symbol / key\n        dataNest.forEach(function(d,i) {                           // ******\n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .style(\"stroke\", function() { // Add the colours dynamically\n                    return d.color = color(d.key); })\n                .attr(\"d\", priceline(d.values));\n    \n            // Add the Legend\n            svg.append(\"text\")                                    // *******\n                .attr(\"x\", (legendSpace/2)+i*legendSpace) // spacing // ****\n                .attr(\"y\", height + (margin.bottom/2)+ 5)         // *******\n                .attr(\"class\", \"legend\")    // style the legend   // *******\n                .style(\"fill\", function() { // dynamic colours    // *******\n                    return d.color = color(d.key); })             // *******\n                .text(d.key);                                     // *******\n    \n        });\n    \n\nThe first added line finds the spacing between each legend label by dividing\nthe width of the graph area by the number of symbols (`key`’s or stocks).\n\n    \n    \n        legendSpace = width/dataNest.length;\n    \n\nThen there is a small and subtle change that might other wise go unnoticed,\nbut is nonetheless significant. We add an `i` to the `forEach` function;\n\n    \n    \n        dataNest.forEach(function(d,i) {\n    \n\nThis might not seem like much of a big deal, but declaring `i` allows us to\naccess the index of the returned data. This means that each unique `key`\n(stock or symbol) has a unique number. In our example those numbers would be\nfrom 0 to 3 (MSFT = 0, AMZN = 1, IBM = 2 and AAPL = 3 (this is the order in\nwhich the stocks appear in our csv file)).\n\nNow we get to adding our text. Again, this is a fairly simple exercise which\nis following the route that we have taken several times already in the book\nbut using some of our prepared values.\n\n    \n    \n            svg.append(\"text\")\n                .attr(\"x\", (legendSpace/2)+i*legendSpace)\n                .attr(\"y\", height + (margin.bottom/2)+ 5)\n                .attr(\"class\", \"legend\")\n                .style(\"fill\", function() {\n                    return d.color = color(d.key); })\n                .text(d.key);\n    \n\nThe horizontal spacing for the labels is achieved by setting each label to the\nposition set by the index associated with the label and the space available on\nthe graph. To make it work out nicely we add half a `legendSpace` at the start\n(`legendSpace/2`) and then add the product of the index (`i`) and\n`legendSpace` (`i*legendSpace`).\n\nWe position the legend vertically so that it is in the middle of the bottom\nmargin (`height + (margin.bottom/2)+ 5`).\n\nAnd we apply the same colour function to the text as we did to the lines\nearlier;\n\n    \n    \n                .style(\"fill\", function() {\n                    return d.color = color(d.key); })\n    \n\nThe final result is a neat and tidy legend at the bottom of the graph;\n\n![Multi-line graph with legend](images/super-01.png) Multi-line graph with\nlegend\n\nIf you’re looking for an exercise to test your skills you could adapt the code\nto show the legend to the right of the graph. And if you wanted to go one\nbetter, you could arrange the order of the legend to reflect the final numeric\nvalue on the right of the graph (I.e in this case AAPL would be on the top and\nMSFT on the bottom).\n\n##### Making it interactive\n\nThe last step we’ll take in this example is to provide ourselves with a bit of\ncontrol over how the graph looks. Even with the multiple colours, the graph\ncould still be said to be ‘busy’. To clean it up or at least to provide the\nability to more clearly display the data that a user wants to see we will add\ncode that will allow us to click on a legend label and this will toggle the\ncorresponding graph line on or off.\n\nThis is a progression from the example of how to show / hide an element by\nclicking on another element that was introduced in he ‘Assorted tips and\ntricks’ chapter.\n\nThe only changes to our code that need to be implemented are in the `forEach`\nsection below. I have left some comments with asterisks in the code below to\nillustrate lines that are added.\n\n    \n    \n        dataNest.forEach(function(d,i) {\n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .style(\"stroke\", function() {\n                    return d.color = color(d.key); })\n                .attr(\"id\", 'tag'+d.key.replace(/\\s+/g, '')) // assign ID **\n                .attr(\"d\", priceline(d.values));\n    \n            // Add the Legend\n            svg.append(\"text\")\n                .attr(\"x\", (legendSpace/2)+i*legendSpace)\n                .attr(\"y\", height + (margin.bottom/2)+ 5)\n                .attr(\"class\", \"legend\")\n                .style(\"fill\", function() {\n                    return d.color = color(d.key); })\n                .on(\"click\", function(){                     // ************\n                    // Determine if current line is visible\n                    var active   = d.active ? false : true,  // ************\n                    newOpacity = active ? 0 : 1;             // ************\n                    // Hide or show the elements based on the ID\n                    d3.select(\"#tag\"+d.key.replace(/\\s+/g, '')) // *********\n                        .transition().duration(100)          // ************\n                        .style(\"opacity\", newOpacity);       // ************\n                    // Update whether or not the elements are active\n                    d.active = active;                       // ************\n                    })                                       // ************\n                .text(d.key);\n    \n        });\n    \n\nThe full code for the complete working example is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/08af723fe615c08f9536f656b55755b4) or\n[GitHub](https://gist.github.com/d3noob/08af723fe615c08f9536f656b55755b4). It\nis also available as the files ‘super-multi.html’ and ‘stocks.csv’ as a\ndownload with the book D3 Tips and Tricks v4 (in a zip file) when you\n[download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThe first piece of code that we need to add assign an `id` to each legend text\nlabel.\n\n    \n    \n            .attr(\"id\", 'tag'+d.key.replace(/\\s+/g, ''))\n    \n\nBeing able to use our `key` value as the id means that each label will have a\nunique identifier. “ _What’s with adding the`'tag'` piece of text to the\n`id`?_” I hear you ask. Good question. If our key starts with a number we\ncould strike trouble (in fact I’m sure there are plenty of other ways we could\nstrike trouble too, but this was one I came across). As well as that we\ninclude a little regular expression goodness to strip any spaces out of the\nkey with `.replace(/\\s+/g, '')`.\n\nThe `.replace` calls the regular expression action on our `key`. `\\s` is the\nregex for “whitespace”, and `g` is the “global” flag, meaning match ALL `\\s`\n(whitespaces). The `+` allows for any _contiguous_ string of space characters\nto being replaced with the empty string (`''`). This was a late addition to\nthe example and kudos go to the participants in the [Stack Overflow question\nhere](http://stackoverflow.com/questions/5963182/how-to-remove-spaces-from-a-\nstring-using-javascript).\n\nThen we use the `.on(\"click\", function(){` call carry out some actions on the\nlabel if it is clicked on. We toggle the `.active` descriptor for our element\nwith `var active = d.active ? false : true,`. Then we set the value of\n`newOpacity` to either `0` or `1` depending on whether `active` is false or\ntrue.\n\nFrom here we can select our label using its unique id and adjust it’s opacity\nto either `0` (transparent) or `1` (opaque);\n\n    \n    \n            d3.select(\"#tag\"+d.key.replace(/\\s+/g, ''))\n                .transition().duration(100)\n                .style(\"opacity\", newOpacity);\n    \n\nJust because we can, we also add in a `transition` statement so that the\nchange in transparency doesn’t occur in a flash (100 milli seconds in fact\n(`.duration(100)`)).\n\nLastly we update our `d.active` variable to whatever the active state is so\nthat it can toggle correctly the next time it is clicked on.\n\nSince it’s kind of difficult to represent interactivity in a book, head on\nover to the [live example on\nbl.ocks.org](http://bl.ocks.org/d3noob/e99a762017060ce81c76) to see the\ntoggling awesomeness that could be yours!\n\n",
    "book_id": "d3js_tips_and_tricks",
    "book_title": "D3 Tips and Tricks v4.x",
    "book_author": "Malcolm Maclean",
    "topic_id": "design_data_visualization",
    "topic_label": "data visualization",
    "chunk_index": 1
  },
  {
    "chunk_full": "#  **Data Visualization with D3.js Cookbook**\n\n* * *\n\n\n# Table of Contents\n\n[Data Visualization with D3.js\nCookbook](part0003.html#2RHM1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Credits](part0004.html#3Q281-202065c838e4478e8fc6c3f9cbfc683a)\n\n[About the Author](part0005.html#4OIQ1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[About the Reviewers](part0006.html#5N3C1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[www.PacktPub.com](part0007_split_000.html#6LJU1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Support files, eBooks, discount offers and\nmore](part0007_split_001.html#ch00lvl1sec01)\n\n[Why Subscribe?](part0007_split_002.html#ch00lvl2sec01)\n\n[Free Access for Packt account holders](part0007_split_003.html#ch00lvl2sec02)\n\n[Preface](part0008_split_000.html#7K4G1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[What this book covers](part0008_split_001.html#ch00lvl1sec02)\n\n[What you need for this\nbook](part0009.html#8IL21-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Who this book is for](part0010.html#9H5K1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Conventions](part0011.html#AFM61-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Reader feedback](part0012.html#BE6O1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Customer\nsupport](part0013_split_000.html#CCNA1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Downloading the example code](part0013_split_001.html#ch00lvl2sec03)\n\n[Errata](part0013_split_002.html#ch00lvl2sec04)\n\n[Piracy](part0013_split_003.html#ch00lvl2sec05)\n\n[Questions](part0013_split_004.html#ch00lvl2sec06)\n\n[1\\. Getting Started with\nD3.js](part0014_split_000.html#DB7S1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Introduction](part0014_split_001.html#ch01lvl1sec08)\n\n[Setting up a simple D3 development\nenvironment](part0015_split_000.html#E9OE1-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Getting Ready](part0015_split_001.html#ch01lvl2sec07)\n\n[How to do it...](part0015_split_002.html#ch01lvl2sec08)\n\n[How it works...](part0015_split_003.html#ch01lvl2sec09)\n\n[There's more...](part0015_split_004.html#ch01lvl2sec10)\n\n[How to get source code](part0015_split_004.html#ch01lvl3sec01)\n\n[Setting up an NPM-based development\nenvironment](part0016_split_000.html#F8902-202065c838e4478e8fc6c3f9cbfc683a)\n\n[Getting Ready](part0016_split_001.html#ch01lvl2sec11)\n\n[How to do it...](part0016_split_002.html#ch01lvl2sec12)\n\n[How it works...](part0016_split_003.html#ch01lvl2sec13)\n\n[There's more...](part0017.html)\n\n[Setup a local HTTP server](part0017.html)\n\n[Python Simple HTTP Server](part0017.html)\n\n[Node.js HTTP Server](part0017.html)\n\n[Understanding D3-style JavaScript](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Functions are objects](part0017.html)\n\n[Static variable scoping](part0017.html)\n\n[Variable-parameter function](part0017.html)\n\n[Function chaining](part0017.html)\n\n[There's more...](part0017.html)\n\n[Finding and sharing code](part0017.html)\n\n[How to get help](part0017.html)\n\n[2\\. Be Selective](part0017.html)\n\n[Introduction](part0017.html)\n\n[Selecting a single element](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Selecting multiple elements](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Iterating through a selection](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Performing subselection](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Function chaining](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Manipulating the raw selection](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[3\\. Dealing with Data](part0017.html)\n\n[Introduction](part0017.html)\n\n[The enter-update-exit pattern](part0017.html)\n\n[Binding an array as data](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Binding object literals as data](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Binding functions as data](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Working with arrays](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Filtering with data](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Sorting with data](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Loading data from a server](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[4\\. Tipping the Scales](part0017.html)\n\n[Introduction](part0017.html)\n\n[What are scales?](part0017.html)\n\n[Using quantitative scales](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[Using the time scale](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Using the ordinal scale](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Interpolating a string](part0017.html)\n\n[Interpolator](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[Interpolating colors](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Interpolating compound objects](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Implementing a custom interpolator](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[5\\. Playing with Axes](part0017.html)\n\n[Introduction](part0017.html)\n\n[Working with basic axes](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Customizing ticks](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Drawing grid lines](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Dynamic rescaling of axes](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[6\\. Transition with Style](part0017.html)\n\n[Introduction](part0017.html)\n\n[What is Transition?](part0017.html)\n\n[Animating a single element](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Animating multiple elements](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Using ease](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Using tweening](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[Using transition chaining](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Using transition filter](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Listening to transitional events](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Implementing a custom interpolator](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Working with timer](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[7\\. Getting into Shape](part0017.html)\n\n[Introduction](part0017.html)\n\n[What is SVG?](part0017.html)\n\n[Vector](part0017.html)\n\n[Scalability](part0017.html)\n\n[Creating simple shapes](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[D3 SVG shape generators](part0017.html)\n\n[See also](part0017.html)\n\n[Using a line generator](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Using line interpolation](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Changing line tension](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Using an area generator](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Using area interpolation](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Using an arc generator](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Implementing arc transition](part0017.html)\n\n[Getting Ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[8\\. Chart Them Up](part0017.html)\n\n[Introduction](part0017.html)\n\n[Creating a line chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Creating an area chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Creating a scatter plot chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Creating a bubble chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Creating a bar chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[9\\. Lay Them Out](part0017.html)\n\n[Introduction](part0017.html)\n\n[Building a pie chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Building a stacked area chart](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[Expanded area chart](part0017.html)\n\n[Streamgraph](part0017.html)\n\n[See also](part0017.html)\n\n[Building a treemap](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Building a tree](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Building an enclosure diagram](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[10\\. Interacting with your Visualization](part0017.html)\n\n[Introduction](part0017.html)\n\n[Interacting with mouse events](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Interacting with a multi-touch device](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Implementing zoom and pan behavior](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Implementing drag behavior](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[11\\. Using Force](part0017.html)\n\n[Introduction](part0017.html)\n\n[Using gravity and charge](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Charge](part0017.html)\n\n[Gravity](part0017.html)\n\n[Friction](part0017.html)\n\n[Setting up zero force layout](part0017.html)\n\n[Setting up mutual repulsion](part0017.html)\n\n[Setting up mutual attraction](part0017.html)\n\n[Setting up gravity](part0017.html)\n\n[Using gravity with repulsion](part0017.html)\n\n[See also](part0017.html)\n\n[Generating momentum](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Setting the link constraint](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Using force to assist visualization](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Manipulating force](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Building a force-directed graph](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[12\\. Know your Map](part0017.html)\n\n[Introduction](part0017.html)\n\n[Projecting the US map](part0017.html)\n\n[GeoJSON](part0017.html)\n\n[TopoJSON](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Projecting the world map](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Building a choropleth map](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[13\\. Test Drive your Visualization](part0017.html)\n\n[Introduction](part0017.html)\n\n[Introduction to unit testing](part0017.html)\n\n[Getting Jasmine and setting up the test environment](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[Test driving your visualization – chart creation](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Test driving your visualization – SVG rendering](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[Test driving your visualization – pixel-perfect bar rendering](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[See also](part0017.html)\n\n[A. Building Interactive Analytics in Minutes](part0017.html)\n\n[Introduction](part0017.html)\n\n[The crossfilter.js library](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Dimensional charting – dc.js](part0017.html)\n\n[Getting ready](part0017.html)\n\n[How to do it...](part0017.html)\n\n[How it works...](part0017.html)\n\n[There's more...](part0017.html)\n\n[See also](part0017.html)\n\n[Index](part0017.html)\n\n\n#  **Data Visualization with D3.js Cookbook**\n\n* * *\n\n\n# Data Visualization with D3.js Cookbook\n\nCopyright © 2013 Packt Publishing\n\nAll rights reserved. No part of this book may be reproduced, stored in a\nretrieval system, or transmitted in any form or by any means, without the\nprior written permission of the publisher, except in the case of brief\nquotations embedded in critical articles or reviews.\n\nEvery effort has been made in the preparation of this book to ensure the\naccuracy of the information presented. However, the information contained in\nthis book is sold without warranty, either express or implied. Neither the\nauthor, nor Packt Publishing, and its dealers and distributors will be held\nliable for any damages caused or alleged to be caused directly or indirectly\nby this book.\n\nPackt Publishing has endeavored to provide trademark information about all of\nthe companies and products mentioned in this book by the appropriate use of\ncapitals. However, Packt Publishing cannot guarantee the accuracy of this\ninformation.\n\nFirst published: October 2013\n\nProduction Reference: 1171013\n\nPublished by Packt Publishing Ltd.\n\nLivery Place\n\n35 Livery Street\n\nBirmingham B3 2PB, UK.\n\nISBN 978-1-78216-216-2\n\n[www.packtpub.com](http://www.packtpub.com)\n\nCover Image by Martin Bell\n(`<[martinb@packtpub.com](mailto:martinb@packtpub.com)>`)\n\n\n# Credits\n\n**Author**\n\nNick Qi Zhu\n\n**Reviewers**\n\nAndrew Berls\n\nKevin Coughlin\n\nIsmini Lourentzou\n\nPablo Navarro\n\n**Acquisition Editor**\n\nMartin Bell\n\n**Lead Technical Editor**\n\nSweny M. Sukumaran\n\n**Technical Editors**\n\nAkashdeep Kundu\n\nProshonjit Mitra\n\nSonali S. Vernekar\n\n****\n\n**Project Coordinator**\n\nKranti Berde\n\n**Proofreader**\n\nMario Cecere\n\n**Indexer**\n\nTejal Soni\n\n**Graphics**\n\nYuvraj Mannari\n\n**Production Coordinator**\n\nAditi Gajjar\n\n**Cover Work**\n\nAditi Gajjar\n\n\n# About the Author\n\n**Nick Qi Zhu** is a professional programmer and visualization enthusiast with\nmore than a decade of experience in software development. He is the author of\ndc.js—a popular multi-dimensional charting library built on D3. Currently he\nis having fun and learning as a lead consultant at ThoughtWorks.\n\nI would like to thank the folks at Packt Publishing for supporting me through\nmy journey, especially my editors Martin Bell and Sweny Sukumaran for\npolishing up my prose making this book much easier to read. And many thanks to\nmy technical reviewers who had really made this book a much better one through\ntheir constructive criticism.\n\nFinally to my wife Sherry for being supportive and incredibly patient with me\nthrough the last several months; without her support this book would not be\npossible.\n\n\n# About the Reviewers\n\n**Andrew Berls** is a Ruby and JavaScript developer and lives in Santa\nBarbara, CA. He's been building websites ever since he learned what an HTML\ntag was, and has since fallen in love with full-stack application development.\nHe was recently an intern at [Causes.com](http://Causes.com), where he\ndeveloped data dashboards using D3.js for visualizing social networks. Andrew\nis completing his degree in Computer Science at the University of California,\nSanta Barbara, and when he's not programming you can find him learning to cook\n(badly) or hiking up a mountain somewhere.\n\n**Kevin Coughlin** holds both Computer Science and Economics degrees from The\nCollege of New Jersey. He is a JavaScript developer with over two years of\nindustry experience. At work and at home, Kevin combines HTML5 standards with\ncutting-edge client- and server-side technologies such as Angular.js,\nBackbone.js, and Node.js to produce effective modern solutions for the open\nweb.\n\nKevin regularly posts tutorials on emerging web technologies on his website\n<http://kevintcoughlin.com>.\n\n**Ismini Lourentzou** has a Business Administration B.Sc. and a long-standing\ncareer in the banking sector, at National Bank of Greece. Learning programming\nin Java in her spare time and her continuous urge for novelty, drove her to\npursue a second degree in Computer Science from Athens University of Economics\nand Business (AUEB). During her undergraduate studies, she has participated in\nthe Knowledge Discovery and Data Mining Cup 2012, as a member of the Data and\nWeb Mining Group of AUEB, headed by Professor Michalis Vazirgiannis, and\nworked on \"Automated Snippet Generation of Online Advertising\", which led to a\npublication at CIKM 2013. Meanwhile, she also participated at ImageClef 2013\nas a member of the Information Retrieval Group of AUEB, headed by Professor\nTheodore Kalamboukis. Their participation was placed second in the Textual Ad-\nhoc image-based retrieval and fifth in Visual Ad-hoc image-based retrieval.\nDue to her love for research and programming, there was no doubt about\nchanging her career orientation; she is currently a PhD student at University\nof Illinois at Urbana – Champaign, combining Machine Learning and Information\nRetrieval in developing intelligent information systems that will improve a\nuser's productivity by decreasing the amount of manual involvement in\nsearching, organizing, and understanding information from mainly textual\nsources. After completing her PhD, she hopes to continue working in research,\nand to be able to learn more and more each day.\n\nI would like to thank my family for their support and help, for always being\nthere to motivate me, my mother for taking care of me while my free time was\nnonexistent, my sister that is always protective of me, my father to being\npresent during difficult situations. Moreover, I am thankful for my boyfriend\nfor his everlasting patience and love and my friends for their advices and\nhelp during this process.\n\n**Pablo Navarro** is a data visualization consultant from Chile. He earned his\nMaster's degree in Applied Mathematics from École des Mines de Saint-Etienne,\nFrance. After working for some years in operations research and data analysis,\nhe decided to specialize in data visualization for web platforms, in which he\ncurrently works. In his free time, he enjoys doing watercolor illustrations,\nrunning and reading about human evolution. His most recent works can be seen\nat <http://pnavarrc.github.io>.\n\n\n# www.PacktPub.com\n\n\n# Support files, eBooks, discount offers and more\n\nYou might want to visit [www.PacktPub.com](http://www.PacktPub.com) for\nsupport files and downloads related to your book.\n\nDid you know that Packt offers eBook versions of every book published, with\nPDF and ePub files available? You can upgrade to the eBook version at\n[www.PacktPub.com](http://www.PacktPub.com) and as a print book customer, you\nare entitled to a discount on the eBook copy. Get in touch with us at\n`<[service@packtpub.com](mailto:service@packtpub.com)>` for more details.\n\nAt [www.PacktPub.com](http://www.PacktPub.com), you can also read a collection\nof free technical articles, sign up for a range of free newsletters and\nreceive exclusive discounts and offers on Packt books and eBooks.\n\n![Support files, eBooks, discount offers and more](../images/00001.jpeg)\n\n[http://PacktLib.PacktPub.com ](http://PacktLib.PacktPub.com%20)\n\nDo you need instant solutions to your IT questions? PacktLib is Packt's online\ndigital book library. Here, you can access, read and search across Packt's\nentire library of books.\n\n\n## Why Subscribe?\n\n  * Fully searchable across every book published by Packt\n  * Copy and paste, print and bookmark content\n  * On demand and accessible via web browser\n\n\n## Free Access for Packt account holders\n\nIf you have an account with Packt at\n[www.PacktPub.com](http://www.PacktPub.com), you can use this to access\nPacktLib today and view nine entirely free books. Simply use your login\ncredentials for immediate access.\n\n\n# Preface\n\nD3.js is a JavaScript library designed to display digital data in a dynamic\ngraphical form. It helps you to bring data to life using HTML, SVG, and CSS.\nD3 allows great control over the final visual result, and it is the hottest\nand most powerful web-based data visualization technology on the market today.\n\nThis book is packed with practical recipes to help you learn every aspect of\ndata visualization with D3. It is designed to provide you with all the\nguidance you need to get to grips with data visualization with D3. With this\nbook, you will create breathtaking data visualization with professional\nefficiency and precision with the help of practical recipes, illustrations,\nand code samples.\n\nThis cookbook starts off by touching upon data visualization and D3 basics\nbefore gradually taking you through a number of practical recipes covering a\nwide range of topics you need to know about D3.\n\nYou will learn the fundamental concepts of data visualization, functional\nJavaScript, and D3 fundamentals including element selection, data binding,\nanimation, and SVG generation. You will also learn how to leverage more\nadvanced techniques such as custom interpolators, custom tweening, timers, the\nlayout manager, force manipulation, and so on. This book also provides a\nnumber of prebuilt chart recipes with ready-to-go sample code to help you\nbootstrap quickly.\n\n\n# What this book covers\n\n[Chapter 1](part0014_split_000.html#DB7S1-202065c838e4478e8fc6c3f9cbfc683a\n\"Chapter 1. Getting Started with D3.js\"), _Getting Started with D3.js_ , is\ndesigned to get you up and running with D3.js. It covers the fundamental\naspects such as what D3.js is and how to set up a typical D3.js data\nvisualization environment.\n\n[Chapter 2](part0017.html \"Chapter 2. Be Selective\"), _Be Selective_ , teaches\nyou one of the most fundamental tasks you need to perform with any data\nvisualization project using D3—selection. Selection helps you target certain\nvisual elements on the page.\n\n[Chapter 3](part0017.html \"Chapter 3. Dealing with Data\"), _Dealing with Data_\n, explores the most essential question in any data visualization project—how\ndata can be represented both in programming constructs, and its visual\nmetaphor.\n\n[Chapter 4](part0017.html \"Chapter 4. Tipping the Scales\"), _Tipping the\nScales_ , deals with a very important subdomain of data visualization. As a\ndata visualization developer, one key task that you need to perform over and\nover again is to map values in your data domain to visual domain, which is the\nfocus of this chapter.\n\n[Chapter 5](part0017.html \"Chapter 5. Playing with Axes\"),_Playing with Axes_\n, explores the usage of axes' component and some related techniques commonly\nused in Cartesian coordinate system based visualization.\n\n[Chapter 6](part0017.html \"Chapter 6. Transition with Style\"), _Transition\nwith Style_ , deals with transitions. \"A picture is worth a thousand words,\"\nthis age-old wisdom is arguably one of the most important cornerstones of data\nvisualization. This chapter covers transition and animation support provided\nby D3 library.\n\n[Chapter 7](part0017.html \"Chapter 7. Getting into Shape\"), _Getting into\nShape_ , deals with Scalable Vector Graphics (SVG), which is a mature World\nWide Web Consortium (W3C) standard widely used in visualization projects.\n\n[Chapter 8](part0017.html \"Chapter 8. Chart Them Up\"), _Chart Them Up_ ,\nexplores one of the oldest and well trusted companions in data\nvisualization—charts. Charts are well defined and well understood graphical\nrepresentations of data.\n\n[Chapter 9](part0017.html \"Chapter 9. Lay Them Out\"), _Lay Them Out_ , focuses\non D3 Layout. D3 layouts are algorithms that calculate and generate placement\ninformation for a group of elements capable of generating some of the most\ncomplex and interesting visualization.\n\n[Chapter 10](part0017.html \"Chapter 10. Interacting with your Visualization\"),\n_Interacting with your Visualization_ , focuses on D3 human visualization\ninteraction support, or in other words how to add computational steering\ncapability to your visualization.\n\n[Chapter 11](part0017.html \"Chapter 11. Using Force\"), _Using Force_ , covers\none of the most fascinating aspects of D3—Force. Force simulation is one of\nthe most awe-inspiring techniques that you can add to your visualization.\n\n[Chapter 12](part0017.html \"Chapter 12. Know your Map\"), _Know your Map_ ,\nintroduces basic D3 cartographic visualization techniques and how to implement\na fully functional geographic visualization in D3.\n\n[Chapter 13](part0017.html \"Chapter 13. Test Drive your Visualization\"), _Test\nDrive your Visualization_ , teaches you to implement your visualization like a\npro with Test Driven Development (TDD).\n\n[Appendix A](part0017.html \"Appendix A. Building Interactive Analytics in\nMinutes\"), _Building Interactive Analytics in Minutes_ serves as an\nintroduction to Crossfilter.js and dc.js on interactive dimensional charting.\n\n\n# What you need for this book\n\n  * A text editor: To edit and create HTML, CSS, and JavaScript files\n  * A web browser: A modern web browser (Firefox 3, IE 9, Chrome, Safari 3.2 and above)\n  * A local HTTP server: You need a local HTTP server to host data file for some of the more advanced recipes in this book. We will cover how to set up a Node or Python based simple HTTP server in the first chapter.\n  * Git client (Optional): If you would like to check out the recipe source code directly from our Git repository, you need a Git client installed on your computer.\n\n\n# Who this book is for\n\nIf you are a developer or an analyst familiar with HTML, CSS, and JavaScript,\nand you wish to get the most out of D3, then this book is for you. This book\ncan also serve as a desktop quick-reference guide for experienced data\nvisualization developers.\n\n\n# Conventions\n\nIn this book, you will find a number of styles of text that distinguish\nbetween different kinds of information. Here are some examples of these\nstyles, and an explanation of their meaning.\n\nCode words in text are shown as follows: \"We can select HTML elements through\nthe use of the `d3.select` function.\"\n\nA block of code is set as follows:\n\n    \n    \n    instance.description = function (d) {\n        if (!arguments.length) d;\n        description = d;\n        return instance;\n    };\n\nWhen we wish to draw your attention to a particular part of a code block, the\nrelevant lines or items are set in bold:\n\n    \n    \n    instance.description = function (d) {\n        **if (!arguments.length) d;**\n        description = d;\n        return instance;\n    };\n\nAny command-line input or output is written as follows:\n\n    \n    \n    **> npm install http-server –g**\n    \n\n**New terms** and **important words** are shown in bold. Words that you see on\nthe screen, in menus or dialog boxes for example, appear in the text like\nthis: \"clicking the **Next** button moves you to the next screen\".\n\n### Note\n\nWarnings or important notes appear in a box like this.\n\n### Tip\n\nTips and tricks appear like this.\n\n\n# Reader feedback\n\nFeedback from our readers is always welcome. Let us know what you think about\nthis book—what you liked or may have disliked. Reader feedback is important\nfor us to develop titles that you really get the most out of.\n\nTo send us general feedback, simply send an e-mail to\n`<[feedback@packtpub.com](mailto:feedback@packtpub.com)>`, and mention the\nbook title via the subject of your message.\n\nIf there is a topic that you have expertise in and you are interested in\neither writing or contributing to a book, see our author guide on\n[www.packtpub.com/authors](http://www.packtpub.com/authors).\n\n\n# Customer support\n\nNow that you are the proud owner of a Packt book, we have a number of things\nto help you to get the most from your purchase.\n\n\n## Downloading the example code\n\nYou can download the example code files for all Packt books you have purchased\nfrom your account at <http://www.packtpub.com>. If you purchased this book\nelsewhere, you can visit <http://www.packtpub.com/support> and register to\nhave the files e-mailed directly to you.\n\n\n## Errata\n\nAlthough we have taken every care to ensure the accuracy of our content,\nmistakes do happen. If you find a mistake in one of our books—maybe a mistake\nin the text or the code—we would be grateful if you would report this to us.\nBy doing so, you can save other readers from frustration and help us improve\nsubsequent versions of this book. If you find any errata, please report them\nby visiting <http://www.packtpub.com/submit-errata>, selecting your book,\nclicking on the **errata** **submission** **form** link, and entering the\ndetails of your errata. Once your errata are verified, your submission will be\naccepted and the errata will be uploaded on our website, or added to any list\nof existing errata, under the Errata section of that title. Any existing\nerrata can be viewed by selecting your title from\n<http://www.packtpub.com/support>.\n\n\n## Piracy\n\nPiracy of copyright material on the Internet is an ongoing problem across all\nmedia. At Packt, we take the protection of our copyright and licenses very\nseriously. If you come across any illegal copies of our works, in any form, on\nthe Internet, please provide us with the location address or website name\nimmediately so that we can pursue a remedy.\n\nPlease contact us at\n`<[copyright@packtpub.com](mailto:copyright@packtpub.com)>` with a link to the\nsuspected pirated material.\n\nWe appreciate your help in protecting our authors, and our ability to bring\nyou valuable content.\n\n\n## Questions\n\nYou can contact us at\n`<[questions@packtpub.com](mailto:questions@packtpub.com)>` if you are having\na problem with any aspect of the book, and we will do our best to address it.\n\n\n# Chapter 1. Getting Started with D3.js\n\nIn this chapter we will cover:\n\n  * Setting up a simple D3 development environment\n  * Setting up an NPM-based development environment\n  * Understanding D3-style JavaScript\n\n\n# Introduction\n\nThis chapter is designed to get you up and running with D3.js, covering\nfundamental aspects, such as what D3.js is, and how to set up a typical D3.js\ndata visualization environment. One particular section is also devoted in\ncovering some lesser known areas of JavaScript that D3.js relies heavily on.\n\nWhat is D3? D3 refers to **Data-Driven Documents** , and according to the\nofficial D3 Wiki:\n\n> D3.js is a JavaScript library for manipulating documents based on data. D3\n> helps you bring data to life using HTML, SVG, and CSS. D3's emphasis on web\n> standards gives you the full capabilities of modern browsers without tying\n> yourself to a proprietary framework, combining powerful visualization\n> components and a data-driven approach to DOM manipulation.\n>\n> D3 Wiki (2013, August)\n\nIn a sense, D3 is a specialized JavaScript library that allows you to create\namazing data visualizations using a simpler (data driven) approach by\nleveraging existing web standards. D3.js was created by Mike Bostock\n(<http://bost.ocks.org/mike/>) and superseded his previous work on a different\nJavaScript data visualization library called Protovis. For more information on\nhow D3 was created and on the theory that influenced both Protovis and D3.js,\nplease check out links in the following information box. Here in this book we\nwill focus more on how to use D3.js to power your visualization. Initially,\nsome aspects of D3 may be a bit confusing due to its different approach to\ndata visualization using JavaScript. I hope that over the course of this book,\na large number of topics, both basic and advanced, will make you comfortable\nand effective with D3. Once properly understood, D3 can improve your\nproductivity and expressiveness with data visualizations by orders of\nmagnitude.\n\n### Note\n\nFor more formal introduction to the idea behind D3 see the _Declarative\nLanguage Design for Interactive Visualization_ paper published by Mike Bostock\non IEEE InfoVis 2010 <http://vis.stanford.edu/papers/protovis-design>.\n\nIf you are interested to know how D3 came about, I recommend you to check out\nthe _D3: Data-Driven Document_ paper published by Mike Bostock on IEEE InfoVis\n2011 at <http://vis.stanford.edu/papers/d3>.\n\nProtovis, the predecessor of D3.js, also created by Mike Bostock and Jeff Heer\nof the Stanford Visualization Group can be found at\n<http://mbostock.github.io/protovis/>.\n\n\n# Setting up a simple D3 development environment\n\nFirst thing you need when starting a D3 powered data visualization project is\na working development environment. In this recipe, we will show you how a\nsimple D3 development environment can be set up within minutes.\n\n\n## Getting Ready\n\nBefore we start, make sure you have your favorite text editor installed and\nready on your computer.\n\n\n## How to do it...\n\nWe'll start by downloading D3.js:\n\n  1. Download the latest stable version of D3.js from <http://d3js.org/>. You can download the archived, older releases from <https://github.com/mbostock/d3/tags>. Additionally, if you are interested in trying out the bleeding edge D3 build on master branch, then you can fork <https://github.com/mbostock/d3>.\n  2. Once downloaded and unzipped, you will find three files `d3.v3.js`, `d3.v3.min.js`, and its license in the extracted folder. For development it is recommended to use `d3.v3.js`, the \"non-uglified\" (minimized) version, since it can help you trace and debug JavaScript inside D3 library. Once extracted place the `d3.v3.js` file in the same folder with an `index.html` file containing the following HTML:\n         \n         <!-- index.html -->\n         <!DOCTYPE html>\n         <html>\n         <head>\n             <meta charset=\"utf-8\">\n             <title>Simple D3 Dev Env</title>\n             <script type=\"text/javascript\" src=\"d3.v3.js\"></script>\n         </head>\n         <body>\n         \n         </body>\n         </html>\n\n### Tip\n\nIf you download D3 from a source or a tagged version, the JavaScript file name\nwill be slightly different. Instead of `d3.v3.js`, it will simply be called\n`d3.js`.\n\nThis is all you need to create, in its simplest form, a D3-powered data\nvisualization development environment. With this setup you can essentially\nopen the HTML file using your favorite text editor to start your development\nand also view your visualization by opening the file in your browser.\n\n### Note\n\nThe source code for this recipe can be found at\n<https://github.com/NickQiZhu/d3-cookbook/tree/master/src/chapter1/simple-dev-\nenv>.\n\n\n## How it works...\n\nD3 JavaScript library is very self-sufficient. It has no dependency on any\nJavaScript library than other what your browser already provides. In fact, it\ncan even be used in a non-browser environment such as **Node.js** with some\nminimum setup (I will cover this in more detail in later chapters).\n\n### Tip\n\nIf your visualization's target browser environment includes Internet Explorer\n9, it is recommended to use the compatibility library  **Aight** , which can\nbe found at <https://github.com/shawnbot/aight>, and  **Sizzle selector\nengine** at <http://sizzlejs.com/>.\n\nHaving the following character encoding instruction in header section is\ncritical:\n\n    \n    \n        <meta charset=\"utf-8\">\n\nThe character encoding instructs browsers and validators what set of\ncharacters to use when rendering web pages. Otherwise your browser will not be\nable to load D3 JavaScript library since D3 uses utf-8 character for certain\nsymbols such as π.\n\n### Note\n\nD3 is completely open source, and it is open sourced under a custom license\nagreement created by its author Michael Bostock. This license is pretty\nsimilar to the popular MIT license with only one exception where it explicitly\nstates that Michael Bostock's name cannot be used to endorse or promote\nproducts derived from this software without permission.\n\n\n## There's more...\n\nThroughout this cookbook numerous recipe code examples will be provided. All\nexample source code are provided and hosted on GitHub (<https://github.com/>)\na popular open source social coding repository platform.\n\n### How to get source code\n\nThe easiest way to get all the recipe source code that you need is to clone\nthe Git repository (<https://github.com/NickQiZhu/d3-cookbook>) for this book.\nIf you are not planning to set up a development environment for the recipes\nthen you can safely skip this section.\n\n### Tip\n\nIf you are not familiar with Git, clone is similar to the check-out concept in\nother versions of control software. However cloning does a lot more than\nsimply checking out the files. It also copies all branches and histories to\nyour local machine effectively cloning the entire repository to your local\nmachine so you can work completely offline with this cloned repository in your\nown environment.\n\nFirst install a Git client on your computer. You can find a list of Git client\nsoftware here <http://git-scm.com/downloads>, and a detailed guide on how to\ninstall it on different operating systems here <http://git-\nscm.com/book/en/Getting-Started-Installing-Git>.\n\n### Tip\n\nAnother popular way to get Git and GitHub working is to install the GitHub\nclient, which gives you a richer set of features than simply Git. However, at\nthe time of writing, GitHub only offered client software for Windows and Mac\nOS.\n\nGitHub for Windows: <http://windows.github.com/>.\n\nGitHub for Mac: <http://mac.github.com/>.\n\nOnce the Git client is installed, simply issuing the following command will\ndownload all recipe source code to your computer:\n\n    \n    \n    **> git clone git://github.com/NickQiZhu/d3-cookbook.git**\n    \n\n### Tip\n\nOr if you choose to use GitHub client, then simply click the **Fork** button\non the repository page <https://github.com/NickQiZhu/d3-cookbook>. This will\nmake this repository appear in your GitHub client.\n\n\n# Setting up an NPM-based development environment\n\nWhen you are working on a more complex data visualization project that\nrequires the use of a number of JavaScript libraries, the simple solution we\ndiscussed before might become a bit clumsy and unwieldy. In this section, we\nwill demonstrate an improved setup using **Node Packaged Modules** (**NPM**)—a\nde facto JavaScript library repository management system. If you are as\nimpatient as me and want to get to the meaty part of the book—the recipes—you\ncan safely skip this section and come back when you need to set up a more\nproduction-ready environment for your project.\n\n\n## Getting Ready\n\nBefore we start please make sure you have NPM properly installed. NPM comes as\npart of the Node.js installation. You can download Node.js from\n<http://nodejs.org/download/>. Select the correct Node.js binary build for\nyour OS. Once installed the `npm` command will become available in your\nterminal console.\n\n    \n    \n    **> npm -v **\n    **1.2.14**\n    \n\nThe preceding command prints out the version number of your NPM client\nindicating the installation is successful.\n\n\n## How to do it...\n\nWith NPM installed, now we can create a package descriptor file to automate\nsome of the manual setup steps.\n\n  1. First, under your project folder, create a file named `package.json` containing the following code:\n         \n         {\n           \"name\": \"d3-project-template\",\n           \"version\": \"0.1.0\",\n           \"description\": \"Ready to go d3 data visualization project template\",\n           \"keywords\": [\n             \"data visualization\",\n             \"d3\"\n           ],\n           \"homepage\": \"<project home page>\",\n           \"author\": {\n             \"name\": \"<your name>\",\n             \"url\": \"<your url>\"\n           },\n           \"repository\": {\n             \"type\": \"git\",\n             \"url\": \"<source repo url>\"\n           },\n           \"dependencies\": {\n               \"d3\":\"3.x\"\n           },\n           \"devDependencies\": {\n               \"uglify-js\": \"2.x\"\n           }\n         }\n\n  2. Once the `package.json` file is defined, you can simply run:\n         \n         > npm install\n\n\n## How it works...\n\nMost of the fields in the `package.json` file are for informational purpose\nonly, such as the name, description, homepage, author, and the repository. The\nname and version field will be used if you decide to publish your library into\nan NPM repository in the future. What we really care about, at this point, is\nthe `dependencies` and `devDependencies` fields.\n\n  * The `dependencies` field describes the runtime library dependencies that your project has, meaning the libraries your project needs to run properly in a browser. In this simple example we only have one dependency on d3. `d3` is the name that D3 library is published under in the NPM repository. The version number `3.x` signifies that this project is compatible with any version 3 releases, and NPM should retrieve the latest stable version 3 build to satisfy this dependency.\n\n### Tip\n\n\n* * *\n\nEnd of this sample Kindle book.  \nEnjoyed the sample?\n\n[Buy\nNow](https://www.amazon.com/gp/g7g/fws/anchor/buyEbook.xml?asin=XXXXXXXXXX)  \nor  \n[See details for this book in the Kindle\nStore](https://www.amazon.com/gp/g7g/fws/anchor/detailPageEbook.xml?asin=XXXXXXXXXX)\n\n* * *\n\n00000>\n\n\n\n\n",
    "book_id": "data_visualization_with_d3js",
    "book_title": "Data Visualization with D3.js Cookbook",
    "book_author": "Nick Qi Zhu",
    "topic_id": "design_data_visualization",
    "topic_label": "data visualization",
    "chunk_index": 2
  },
  {
    "chunk_full": "[![O'Reilly Strata\nConference](../images/00001.jpeg)](http://strataconf.com?intcmp=il-strata-\nstny13-report-ebook-ad-pa)\n\n\n# Interactive Data Visualization for the Web\n\n###  Scott Murray\n\n![image with no caption](../images/00002.jpeg)\n\nBeijing • Cambridge • Farnham • Köln • Sebastopol • Tokyo\n\n\n## Special Upgrade Offer\n\nIf you purchased this ebook directly from [oreilly.com](http://oreilly.com),\nyou have the following benefits:\n\n  * DRM-free ebooks — use your ebooks across devices without restrictions or limitations\n  * Multiple formats — use on your laptop, tablet, or phone\n  * Lifetime access, with free updates\n  * Dropbox syncing — your files, anywhere\n\nIf you purchased this ebook from another retailer, you can upgrade your ebook\nto take advantage of all these benefits for just $4.99. [Click\nhere](part0022.html#back_of_book_promo) to access your ebook upgrade.\n\n_Please note that upgrade offers are not available from sample content._\n\n\n## A Note Regarding Supplemental Files\n\nSupplemental files and examples for this book can be found at\n<http://examples.oreilly.com/0636920026938/>. Please use a standard desktop\nweb browser to access these files, as they may not be accessible from all\nereader devices.\n\nAll code files or examples referenced in the book will be available online.\nFor physical books that ship with an accompanying disc, whenever possible,\nwe’ve posted all CD/DVD content. Note that while we provide as much of the\nmedia content as we are able via free download, we are sometimes limited by\nlicensing restrictions. Please direct any questions or concerns to\n[booktech@oreilly.com](mailto:booktech@oreilly.com).\n\n\n## Preface\n\nThis is a book about programming data visualizations for nonprogrammers. If\nyou’re an artist or graphic designer with visual skills but no prior\nexperience working with data or code, this book is for you. If you’re a\njournalist or researcher with lots of data but no prior experience working\nwith visuals or code, this book is for you, too.\n\nThis book will introduce you to D3, a JavaScript-based tool for loading data\ninto a web page and generating visuals from that data. I assume that you have\nlittle or no programming experience. Or, perhaps you have programmed before,\nbut D3 and data visualization are bringing you to JavaScript for the first\ntime, and you’ve heard bad things about it. Well, JavaScript _is_ a little\nweird, but it’s not as bad as you’ve heard, and everything is going to be all\nright. Please sit down and make yourself comfortable.\n\nThis book began as [a series of\ntutorials](http://alignedleft.com/tutorials/d3/) posted on my website. At the\ntime (January 2012), there wasn’t much information on D3 available that was\naccessible to beginners. Very quickly, I was getting hundreds, then thousands\nof page views a day — evidence that interest in the field generally (and D3\nspecifically) was growing like gangbusters. If you’ve read the tutorials,\nportions of the book will feel familiar, but there is a _lot_ of new material\nhere, including many more examples, sneaky tips, and warnings of things to\navoid. Also, the book contains 78 percent more bad jokes.\n\nData visualization is an interdisciplinary field, which is just one reason\nit’s impossible to document the breadth of skills needed in a single book.\nFortunately, because the field is exploding in popularity, there are many new\ntitles to choose from, each of which complements this one.\n\nOn design process:\n\n  * [_Designing Data Visualizations: Intentional Communication from Data to Display_](http://shop.oreilly.com/product/0636920022060.do) by Noah Iliinsky and Julie Steele. O’Reilly Media, 2011. \n  * [_Data Visualization: A Successful Design Process_](http://bit.ly/15eJJJj) by Andy Kirk. Packt Publishing, 2012. \n\nOn visual design principles and techniques:\n\n  * [_The Functional Art: An Introduction to Information Graphics and Visualization_](http://bit.ly/VINWSz) by Alberto Cairo. New Riders, 2012. \n  * [_Information Dashboard Design: The Effective Visual Communication of Data_](http://shop.oreilly.com/product/9780596100162.do) by Stephen Few. O’Reilly Media, 2006. \n\nOn the practicalities of working with data:\n\n  * [_Bad Data Handbook: Mapping the World of Data Problems_](http://shop.oreilly.com/product/9780596802363.do) by Q. Ethan McCallum. O’Reilly Media, 2012. \n  * [_Data Analysis with Open Source Tools: A Hands-On Guide for Programmers and Data Scientists_](http://shop.oreilly.com/product/9780596802363.do) by Philipp K. Janert. O’Reilly Media, 2010. \n  * [_Python for Data Analysis: Agile Tools for Real World Data_](http://shop.oreilly.com/product/0636920023784.do) by Wes McKinney. O’Reilly Media, 2012. \n\n\n## Conventions Used in This Book\n\nThe following typographical conventions are used in this book:\n\n_Italic_\n\n> Indicates new terms, URLs, email addresses, filenames, and file extensions.\n\n`Constant width`\n\n> Used for program listings, as well as within paragraphs to refer to program\n> elements such as variable or function names, databases, data types,\n> environment variables, statements, and keywords.\n\n**`Constant width bold`**\n\n> Shows commands or other text that should be typed literally by the user.\n\n_`Constant width italic`_\n\n> Shows text that should be replaced with user-supplied values or by values\n> determined by context.\n\n* * *\n\n### Tip\n\nThis icon signifies a tip, suggestion, or general note.\n\n* * *\n\n* * *\n\n### Warning\n\nThis icon indicates a warning or caution.\n\n* * *\n\n\n## Using Code Examples\n\nThis book is here to help you get your job done. In general, if this book\nincludes code examples, you may use the code in this book in your programs and\ndocumentation. You do not need to contact us for permission unless you’re\nreproducing a significant portion of the code. For example, writing a program\nthat uses several chunks of code from this book does not require permission.\nSelling or distributing a CD-ROM of examples from O’Reilly books does require\npermission. Answering a question by citing this book and quoting example code\ndoes not require permission. Incorporating a significant amount of example\ncode from this book into your product’s documentation does require permission.\n\nWe appreciate, but do not require, attribution. An attribution usually\nincludes the title, author, publisher, and ISBN. For example: “ _Interactive\nData Visualization for the Web_ by Scott Murray (O’Reilly). Copyright 2013\nScott Murray, 978-1-449-33973-9.”\n\nIf you feel your use of code examples falls outside fair use or the permission\ngiven above, feel free to contact us at\n[permissions@oreilly.com](mailto:permissions@oreilly.com).\n\n\n## Safari® Books Online\n\n* * *\n\n### Note\n\n[Safari Books Online](http://my.safaribooksonline.com/?portal=oreilly) is an\non-demand digital library that delivers expert\n[content](http://www.safaribooksonline.com/content) in both book and video\nform from the world’s leading authors in technology and business.\n\n* * *\n\nTechnology professionals, software developers, web designers, and business and\ncreative professionals use Safari Books Online as their primary resource for\nresearch, problem solving, learning, and certification training.\n\nSafari Books Online offers a range of [product\nmixes](http://www.safaribooksonline.com/subscriptions) and pricing programs\nfor [organizations](http://www.safaribooksonline.com/organizations-teams),\n[government agencies](http://www.safaribooksonline.com/government), and\n[individuals](http://www.safaribooksonline.com/individuals). Subscribers have\naccess to thousands of books, training videos, and prepublication manuscripts\nin one fully searchable database from publishers like O’Reilly Media, Prentice\nHall Professional, Addison-Wesley Professional, Microsoft Press, Sams, Que,\nPeachpit Press, Focal Press, Cisco Press, John Wiley & Sons, Syngress, Morgan\nKaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New\nRiders, McGraw-Hill, Jones & Bartlett, Course Technology, and dozens\n[more](http://www.safaribooksonline.com/publishers). For more information\nabout Safari Books Online, please visit us\n[online](http://www.safaribooksonline.com/).\n\n\n## How to Contact Us\n\nPlease address comments and questions concerning this book to the publisher:\n\nO’Reilly Media, Inc.  \n---  \n1005 Gravenstein Highway North  \nSebastopol, CA 95472  \n800-998-9938 (in the United States or Canada)  \n707-829-0515 (international or local)  \n707-829-0104 (fax)  \n  \nWe have a web page for this book, where we list errata, examples, and any\nadditional information. You can access this page at\n<http://oreil.ly/interactive_data_visualization_web>.\n\nTo comment or ask technical questions about this book, send email to\n[bookquestions@oreilly.com](mailto:bookquestions@oreilly.com).\n\nFor more information about our books, courses, conferences, and news, see our\nwebsite at <http://www.oreilly.com>.\n\nFind us on Facebook: <http://facebook.com/oreilly>\n\nFollow us on Twitter: <http://twitter.com/oreillymedia>\n\nWatch us on YouTube: <http://www.youtube.com/oreillymedia>\n\n\n## Acknowledgments\n\nMy name may be on the cover, but as an author, I feel as though I am merely\nfunneling the wisdom of hundreds of other brilliant minds onto the page.\n\nFirst and foremost, I must thank my wife Nora, not least for being the first\nto say “Hey, you should turn those tutorials into a book.” Without her support\nand encouragement, this project never would have happened.\n\nThanks also to [Rosten Woo](http://wehavenoart.net), with whom I collaborated\non my first D3 project, for reaching out and giving me a reason to finally dig\ninto this new tool. Thanks to [Joe Golike](http://golike.com) for several\nearly D3 debugging sessions around that time, and to [Jen\nLowe](http://www.datatelling.com) and [Sha\nHwang](http://postarchitectural.com) for their reviews and feedback on the\ninitial tutorials.\n\nI am extremely grateful to [Casey Reas](http://reas.com), [Dan\nShiffman](http://www.shiffman.net), [Joshua\nNoble](http://thefactoryfactory.com), and [Noah\nIliinsky](http://complexdiagrams.com) — not just for offering advice on the\nbook-creation process, but also for their groundbreaking work in the spheres\nof art, design, code, and data. Their careers have greatly influenced my own.\n\nIn that vein, I should also thank Jan Kubasiewicz at MassArt’s [Dynamic Media\nInstitute](http://www.dynamicmediainstitute.org). Back in 2007, Jan encouraged\nme to check out something called [Processing](http://processing.org), which\neventually led me to a whole new career in code-driven arts, data\nvisualization, and now this book.\n\nIt has been a pleasure working with my editor, Meghan Blanchette, and everyone\nelse on the team at O’Reilly. Thanks to Meghan and her crew for shepherding\nthis project all the way through, from concept to an actual, physical, chunk\nof paper with words and strange diagrams printed on it.\n\nSpecial thanks to [Mike Bostock](http://bost.ocks.org/mike/), [Jen\nLowe](http://www.datatelling.com), [Anna Powell-Smith](http://anna.ps), and\n[Daisy Vincent](http://codenoobcentral.tumblr.com) for agreeing to tech review\nthe book and sending incredibly valuable feedback. The final product is vastly\nimproved, thanks to their input. That said, if you find an error or confusing\ncode example, it is because they begged me to rewrite it, and I steadfastly\nrefused.\n\nMike gets an extra-special thanks for developing D3 in the first place.\nWithout this elegant piece of software, the community of data visualization\npractitioners wouldn’t be quite as vibrant, enthusiastic, and standards-\ncompliant as it is today.\n\nSpeaking of community, many other people — including [Jérôme\nCukier](http://www.jeromecukier.net), [Lynn\nCherny](http://www.ghostweather.com), [Jason\nDavies](http://www.jasondavies.com), [Jeff\nHeer](http://hci.stanford.edu/jheer/), [Santiago Ortiz](http://moebio.com),\n[Kim Rees](http://periscopic.com), [Moritz\nStefaner](http://moritz.stefaner.eu), [Jan Willem\nTulp](http://tulpinteractive.com), and others who I have forgotten to mention\n— on the D3 list and in nearby orbits have also directly contributed to my\nthinking and process. Thank you for your support. I am lucky to get to\ncollaborate with so many talented people.\n\n\n## Chapter 1. Introduction\n\n\n## Why Data Visualization?\n\nOur information age more often feels like an era of information overload.\nExcess amounts of information are overwhelming; raw data becomes useful only\nwhen we apply methods of deriving insight from it.\n\nFortunately, we humans are intensely visual creatures. Few of us can detect\npatterns among rows of numbers, but even young children can interpret bar\ncharts, extracting meaning from those numbers’ visual representations. For\nthat reason, data visualization is a powerful exercise. Visualizing data is\nthe fastest way to communicate it to others.\n\nOf course, visualizations, like words, can be used to lie, mislead, or distort\nthe truth. But when practiced honestly and with care, the process of\nvisualization can help us see the world in a new way, revealing unexpected\npatterns and trends in the otherwise hidden information around us. At its\nbest, data visualization is expert storytelling.\n\nMore literally, visualization is a process of _mapping_ information to\nvisuals. We craft rules that interpret data and express its values as visual\nproperties. For example, the humble bar chart in [Figure\n1-1](part0005_split_001.html#data_values_mapped_to_visuals) is generated from\na very simple rule: larger values are _mapped_ as taller bars.\n\n![Data values mapped to visuals](../images/00003.gif)\n\nFigure 1-1. Data values mapped to visuals\n\nMore complex visualizations are generated from datasets more complex than the\nsequence of numbers shown in [Figure\n1-1](part0005_split_001.html#data_values_mapped_to_visuals) and more complex\nsets of mapping rules.\n\n\n## Why Write Code?\n\nMapping data by hand can be satisfying, yet is slow and tedious. So we usually\nemploy the power of computation to speed things up. The increased speed\nenables us to work with much larger datasets of thousands or millions of\nvalues; what would have taken years of effort by hand can be mapped in a\nmoment. Just as important, we can rapidly experiment with _alternate mappings_\n, tweaking our rules and seeing their output re-rendered immediately. This\nloop of write/render/evaluate is critical to the iterative process of refining\na design.\n\nSets of mapping rules function as _design systems_. The human hand no longer\nexecutes the visual output; the computer does. Our human role is to\nconceptualize, craft, and write out the rules of the system, which is then\nfinally executed by software.\n\nUnfortunately, software (and computation generally) is extremely bad at\nunderstanding what, exactly, people want. (To be fair, many humans are also\nnot good at this challenging task.) Because computers are binary systems,\neverything is either on or off, yes or no, this or that, there or not there.\nHumans are mushier, softer creatures, and the computers are not willing to\nmeet us halfway — we must go to them. Hence the inevitable struggle of\nlearning to write software, in which we train ourselves to communicate in the\nvery limited and precise syntax that the computer can understand.\n\nYet we continue to write code because seeing our visual creations come to life\nis so rewarding. We practice data visualization because it is exciting to see\nwhat has never before been seen. It is like summoning a magical, visual genie\nout of an inscrutable data bottle.\n\n\n## Why Interactive?\n\nStatic visualizations can offer only precomposed “views” of data, so multiple\nstatic views are often needed to present a variety of perspectives on the same\ninformation. The number of dimensions of data are limited, too, when all\nvisual elements must be present on the same surface at the same time.\nRepresenting multidimensional datasets fairly in static images is notoriously\ndifficult. A fixed image is ideal when alternate views are neither needed nor\ndesired, and required when publishing to a static medium, such as print.\n\nDynamic, interactive visualizations can empower people to explore the data for\nthemselves. The basic functions of most interactive visualization tools have\nchanged little since 1996, when Ben Shneiderman of the University of Maryland\nfirst proposed a “Visual Information-Seeking Mantra”: _overview first, zoom\nand filter, then details-on-demand._\n\nThis design pattern is found in most interactive visualizations today. The\ncombination of functions is successful, because it makes the data accessible\nto different audiences, from those who are merely browsing or exploring the\ndataset to those who approach the visualization with a specific question in\nsearch of an answer. An interactive visualization that offers an overview of\nthe data alongside tools for “drilling down” into the details may successfully\nfulfill many roles at once, addressing the different concerns of different\naudiences, from those new to the subject matter to those already deeply\nfamiliar with the data.\n\nOf course, interactivity can also encourage engagement with the data in ways\nthat static images cannot. With animated transitions and well-crafted\ninterfaces, some visualizations can make exploring data feel more like playing\na game. Interactive visualization can be a great medium for engaging an\naudience who might not otherwise care about the topic or data at hand.\n\n\n## Why on the Web?\n\nVisualizations aren’t truly visual unless they are _seen_. Getting your work\nout there for others to see is critical, and publishing on the Web is the\nquickest way to reach a global audience. Working with web-standard\ntechnologies means that your work can be seen and experienced by anyone using\na recent web browser, regardless of the operating system (Windows, Mac, Linux)\nand device type (laptop, desktop, smartphone, tablet).\n\nBest of all, everything covered in this book can be done with freely\naccessible tools, so the only investment required is your time. And everything\nwe’ll talk about uses open source, web-standard technologies.\n\nBy avoiding proprietary software and plug-ins, you can ensure that your\nprojects are accessible on the widest possible range of devices, from typical\ndesktop computers to tablets and even phones. The more accessible your\nvisualization, the greater your audience and your impact.\n\n\n## What This Book Is\n\nThis book is a practical introduction to merging three practices — data\nvisualization, interactive design, and web development — using D3, a powerful\ntool for custom, web-based visualization.\n\nThese chapters grew out of my own process of learning how to use D3. Many\npeople, including myself, come to D3 with backgrounds in design, mapping, and\ndata visualization, but not programming and computer science.\n\nD3 has a bit of an unfair reputation for being hard to learn. D3 itself is not\nso complicated, but it operates in the domain of the Web, and the Web _is_\ncomplicated. Using D3 comfortably requires some prior knowledge of the web\ntechnologies with which it interacts, such as HTML, CSS, JavaScript, and SVG.\nMany people (myself included) are self-taught when it comes to web skills.\nThis is great, because the barrier to entry is so low, but problematic because\nit means we probably didn’t learn each of these technologies from the ground\nup — more often, we just hack something together until it seems to work, and\ncall it a day. Yet successful use of D3 requires understanding some of these\ntechnologies in a fundamental way.\n\nBecause D3 is written in JavaScript, learning to use D3 often means learning a\nlot about JavaScript. For many datavis folks, D3 _is_ their introduction to\nJavaScript (or even web development generally). It’s hard enough to learn a\nnew programming language, let alone a new tool built on that language. D3 will\nenable you to do great things with JavaScript that you never would have even\nattempted. The time you spend learning both the language and the tool will\nprovide an incredible payoff.\n\nMy goal is to reduce that learning time, so you can start creating awesome\nstuff sooner. We’ll take a ground-up approach, starting with the fundamental\nconcepts and gradually adding complexity. I don’t intend to show you how to\nmake specific kinds of visualizations so much as to help you understand the\nworkings of D3 well enough to take those building blocks and generate designs\nof your own creation.\n\n\n## Who You Are\n\nYou may be an absolute beginner, someone new to datavis, web development, or\nboth. (Welcome!) Perhaps you are a journalist interested in new ways to\ncommunicate the data you collect during reporting. Or maybe you’re a designer,\ncomfortable drawing static infographics but ready to make the leap to\ninteractive projects on the Web. You could be an artist, interested in\ngenerative, data-based art. Or a programmer, already familiar with JavaScript\nand the Web, but excited to learn a new tool and pick up some visual design\nexperience along the way.\n\nWhoever you are, I hope that you:\n\n  * Have heard of this new thing called the “World Wide Web” \n  * Are a bit familiar with HTML, the DOM, and CSS \n  * Might even have a little programming experience already \n  * Have heard of jQuery or written some JavaScript before \n  * Aren’t scared by unknown initialisms like CSV, SVG, or JSON \n  * Want to make useful, interactive visualizations \n\nIf any of those things are unknown or unclear, don’t fear. You might just want\nto spend more time with [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), which\ncovers what you really need to know before diving into D3.\n\n\n## What This Book Is Not\n\nThat said, this is definitely not a computer science textbook, and it is not\nintended to teach the intricacies of any one web technology (HTML, CSS,\nJavaScript, SVG) in depth.\n\nIn that spirit, I might gloss over some technical points, grossly\noversimplifying important concepts fundamental to computer science in ways\nthat will make true software engineers recoil. That’s fine, because I’m\nwriting for artists and designers here, not engineers. We’ll cover the basics,\nand then you can dive into the more complex pieces once you’re comfortable.\n\nI will deliberately _not_ address every possible approach to a given problem,\nbut will typically present what I feel is the simplest solution, or, if not\nthe simplest, then the most understandable.\n\nMy goal is to teach you the fundamental concepts and methods of D3. As such,\nthis book is decidedly _not_ organized around specific example projects.\nEveryone’s data and design needs will be different. It’s up to you to\nintegrate these concepts in the way best suited to your particular project.\n\n\n## Using Sample Code\n\nIf you are a mad genius, then you can probably learn to use D3 without ever\nlooking at any sample code files, in which case you can skip the rest of this\nsection.\n\nIf you’re still with me, you are probably still very bright but not mad, in\nwhich case you should undertake this book with the full set of accompanying\ncode samples in hand. Before you go any further, please download the sample\nfiles from [GitHub](http://bit.ly/V25Xw6).\n\nNormal people will want to click the ZIP link to download a compressed ZIP\narchive with all the files. Hardcore geeksters will want to clone the\nrepository using Git. If that last sentence sounds like total gibberish,\nplease use the first option.\n\nWithin the download, you’ll notice there is a folder for each chapter that has\ncode to go with it:\n\n    \n    \n    chapter_04\n    chapter_05\n    chapter_06\n    chapter_07\n    chapter_08\n    …\n\nFiles are organized by chapter, so in [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc) when I\nreference _01_bar_chart.html_ , know that you can find that file in the\ncorresponding location: _d3-book/chapter_9/01_bar_chart.html_.\n\nYou are welcome to copy, adapt, modify, and reuse the example code in these\ntutorials for any noncommercial purpose.\n\n\n## Thank You\n\nFinally, this book has been handcrafted, carefully written, and pedagogically\nfine-tuned for maximum effect. Thank you for reading it. I hope you learn a\ngreat deal, and even have some fun along the way.\n\n\n## Chapter 2. Introducing D3\n\nD3 — also referred to as D3 or d3.js — is a JavaScript library for creating\ndata visualizations. But that kind of undersells it.\n\nThe abbreviation D3 references the tool’s full name, _Data-Driven Documents_.\nThe _data_ is provided by you, and the _documents_ are web-based documents,\nmeaning anything that can be rendered by a web browser, such as HTML and SVG.\nD3 does the _driving_ , in the sense that it connects the data to the\ndocuments.\n\nOf course, the name also functions as a clever allusion to the network of\ntechnologies underlying the tool itself: the W3, or World Wide Web, or, today,\nsimply “the Web.”\n\nD3’s primary author is the brilliant [Mike\nBostock](http://bost.ocks.org/mike/), although there are a few other dedicated\ncontributors. The project is entirely open source and freely available on\n[GitHub](https://github.com/mbostock/d3/).\n\nD3 is released under a BSD license, so you may use, modify, and adapt the code\nfor noncommercial or commercial use at no cost.\n\nD3’s official home on the Web is [_d3js.org_](http://www.d3js.org/).\n\n\n## What It Does\n\nFundamentally, D3 is an elegant piece of software that facilitates generation\nand manipulation of web documents with data. It does this by:\n\n  * _Loading_ data into the browser’s memory \n  * _Binding_ data to elements within the document, creating new elements as needed \n\n  * _Transforming_ those elements by interpreting each element’s bound datum and setting its visual properties accordingly \n  * _Transitioning_ elements between states in response to user input \n\nLearning to use D3 is simply a process of learning the syntax used to tell it\nhow you want it to load and bind data, and transform and transition elements.\n\nThe _transformation_ step is most important, as this is where the _mapping_\nhappens. D3 provides a structure for applying these transformations, but, as\nwe’ll see, you define the mapping rules. Should larger values make taller bars\nor brighter circles? Will clusters be sorted on the x-axis by age or category?\nWhat color palette is used to fill in countries on your world map? All of the\nvisual design decisions are up to you. You provide the concept, you craft the\nrules, and D3 executes it — without telling you what to do. (Yes, it’s like\nthe opposite of Excel’s pushy “Chart Wizard.”)\n\n\n## What It Doesn’t Do\n\nHere is a list of things D3 does not do:\n\n  * D3 doesn’t generate predefined or “canned” visualizations for you. This is on purpose. D3 is intended primarily for _explanatory_ visualization work, as opposed to _exploratory_ visualizations. Exploratory tools help you discover significant, meaningful patterns in data. These are tools like [Tableau](http://bit.ly/13KrhFH) and [ggplot2](http://ggplot2.org/), which help you quickly generate multiple views on the same data set. That’s an essential step, but different from generating an _explanatory_ presentation of the data, a view of the data that highlights what you’ve already discovered. Explanatory views are more constrained and limited, but also focused, and designed to communicate only the important points. D3 excels at this latter step, but is not ideal for the former. (For ideas on other tools, see the section [Alternatives](part0006_split_004.html#alternatives_2) later in this chapter.)\n  * D3 doesn’t even try to support older browsers. This helps keep the D3 codebase clean and free of hacks to support old versions of Internet Explorer, for example. The philosophy is that by creating more compelling tools and refusing to support older browsers, we encourage more people to upgrade (rather than forestall the process, thereby requiring us to continue to support those browsers, and so on — a vicious cycle). D3 wants us to move forward.\n  * D3’s core functionality doesn’t handle bitmap map tiles, such as those provided by Google Maps or Cloudmade. D3 is great with anything vector — SVG images or GeoJSON data — but wasn’t originally intended to work with traditional map tiles. (_Bitmap_ images are made up of pixels, so resizing them larger or smaller is difficult without a loss in quality. _Vector_ images are defined by points, lines, and curves — mathematical equations, really — and can be scaled up or down without a loss in quality.) This is starting to change, with the introduction of the [d3.geo.tile plug-in](http://bit.ly/W8L18u). Prior to this plug-in, geomapping with D3 meant either going all-SVG and avoiding tiles or using D3 to create SVG visuals _on top of_ a base layer of map tiles (which would be managed by another library, like Leaflet or Polymaps — see the section [Alternatives](part0006_split_004.html#alternatives_2) later in this chapter). This question of how to integrate bitmap tiles and vector graphics comes up a lot in the D3 community. As of today, there is no super-simple and perfect answer, but I think you can expect to see lots of work done in this area, and possibly the new tile-handling methods integrated into the D3 core at some point in the future.\n  * D3 doesn’t hide your original data. Because D3 code is executed on the client side (meaning, in the user’s web browser, as opposed to on the web server), the data you want visualized must be sent to the client. If your data can’t be shared, then don’t use D3. Alternatives include using proprietary tools (like Flash) or prerendering visualizations as static images and sending those to the browser. (If you’re not interested in sharing your data, though, why would you bother visualizing it? The purpose of visualization is to communicate the data, so you might sleep better at night by choosing openness and transparency, rather than having nightmares about [data thieves](http://www.datathief.org/).)\n\n\n## Origins and Context\n\nThe first web browsers rendered static pages; interactivity was limited to\nclicking links. In 1996, Netscape introduced the first browser with\nJavaScript, a new scripting language that could be interpreted _by the browser\nwhile the page was being viewed_.\n\nThis doesn’t sound as groundbreaking as it turned out to be, but this enabled\nweb browsers to evolve from merely passive _browsers_ to dynamic frames for\ninteractive, networked experiences. This shift ultimately enabled every\nintrapage interaction we have on the Web today. Without JavaScript, D3 would\nnever exist, and web-based data visualizations would be limited to\nprerendered, noninteractive GIFs. (Yuck. Thank you, Netscape!)\n\nJump ahead to 2005, when Jeffrey Heer, Stuart Card, and James Landay\nintroduced [prefuse](http://prefuse.org/), a toolkit for bringing data\nvisualization to the Web. prefuse (spelled with all lowercase letters) was\nwritten in Java, a compiled language, with programs that could run in web\nbrowsers via a Java plug-in. (Note that _Java_ is a completely different\nprogramming language than _JavaScript_ , despite their similar names.)\n\nprefuse was a breakthrough application — the first to make web-based\nvisualization accessible to less-than-expert programmers. Until prefuse came\nalong, any datavis on the Web was very much a custom affair.\n\nTwo years later, Jeff Heer introduced [Flare](http://flare.prefuse.org/), a\nsimilar toolkit, but written in ActionScript, so its visualizations could be\nviewed on the Web through Adobe’s Flash Player. Flare, like prefuse, relied on\na browser plug-in. Flare was a huge improvement, but as web browsers continued\nto evolve, it was clear that visualizations could be created with native\nbrowser technology, no plug-ins required.\n\nBy 2009, Jeff Heer had moved to Stanford, where he was advising a graduate\nstudent named Michael Bostock. Together, in Stanford’s Vis Group, they created\n[Protovis](http://mbostock.github.com/protovis/), a JavaScript-based\nvisualization toolkit that relied exclusively on native browser technologies.\n(If you have used Protovis, be sure to reference Mike’s [introduction to D3\nfor Protovis users](http://bit.ly/XxebvX).)\n\nProtovis made generating visualizations simple, even for users without prior\nprogramming experience. Yet to achieve this, it created an abstract\nrepresentation layer. The designer could address this layer using Protovis\nsyntax, but it wasn’t accessible through standard methods, so debugging was\ndifficult.\n\nIn 2011, Mike Bostock, Vadim Ogievetsky, and Jeff Heer [officially announced\nD3](http://vis.stanford.edu/papers/d3), the next evolution in web\nvisualization tools. Unlike Protovis, D3 operates directly on the web document\nitself. This means easier debugging, easier experimentation, and more visual\npossibilities. The only downside to this approach is a potentially steeper\nlearning curve, but this book will make that as painless as possible. Plus,\nall the skills you gain while learning about D3 will prove useful even beyond\nthe realm of datavis.\n\nIf you’re familiar with any of these groundbreaking tools, you’ll appreciate\nthat D3 descends from a prestigious lineage. And if you have any interest in\nthe philosophy underlying D3’s elegant technical design, I highly recommend\nMike, Vadim, and Jeff’s [InfoVis\npaper](http://vis.stanford.edu/files/2011-D3-InfoVis.pdf), which clearly\narticulates the need for this kind of tool. The paper encapsulates years’\nworth of learning and insights made while developing visualization tools.\n\n\n## Alternatives\n\nD3 might not be perfect for every project. Sometimes you just need a quick\nchart and you don’t have time to code it from scratch. Or you might need to\nsupport older browsers and can’t rely on recent technologies like SVG.\n\nFor those situations, it’s good to know what other tools are out there. Here\nis a brief, noncomprehensive list of D3 alternatives, all of which use web-\nstandard technologies (mostly JavaScript) and are free to download and use.\n\n### Easy Charts\n\n[DataWrapper](http://datawrapper.de)\n\n> A beautiful web service that lets you upload your data and quickly generate\n> a chart that you can republish elsewhere or embed on your site. This service\n> was originally intended for journalists, but it is helpful for everyone.\n> DataWrapper displays interactive charts in current browsers and static\n> images for old ones. (Brilliant!) You can also download all the code and run\n> it on your own server instead of using theirs.\n\n[Flot](http://www.flotcharts.org/)\n\n> A plotting library for jQuery that uses the HTML canvas element and supports\n> older browsers, even all the way back to Internet Explorer 6. It supports\n> limited visual forms (lines, points, bars, areas), but it is easy to use.\n\n[Google Chart Tools](https://developers.google.com/chart/)\n\n> Having evolved from their earlier [Image Charts\n> API](https://developers.google.com/chart/image/), Google’s Chart Tools can\n> be used to generate several standard chart types, with support for old\n> versions of IE.\n\n[gRaphaël](http://g.raphaeljs.com/)\n\n> A charting library based on Raphaël (see later in this chapter) that\n> supports older browsers, including IE6. It has more visual flexibility than\n> Flot, and — some might say — it is prettier.\n\n[Highcharts JS](http://www.highcharts.com/)\n\n> A JavaScript-based charting library with several predesigned themes and\n> chart types. It uses SVG for modern browsers and [falls back on\n> VML](http://www.highcharts.com/documentation/compatibility) for old versions\n> of IE, including IE6 and later. The tool is free only for noncommercial use.\n\n[JavaScript InfoVis Toolkit](http://thejit.org/)\n\n> The JIT provides several preset visualization styles for your data. It\n> includes lots of examples, but the documentation is pretty technical. The\n> toolkit is great if you like one of the preset styles, but browser support\n> is unclear.\n\n[jqPlot](http://www.jqplot.com/)\n\n> A plug-in for charting with jQuery. This supports very simple charts and is\n> great if you are okay with the predefined styles. jqPlot supports IE7 and\n> newer.\n\n[jQuery Sparklines](http://omnipotent.net/jquery.sparkline/)\n\n> A jQuery plug-in for generating sparklines, typically small bar, line, or\n> area charts used inline with text. Supports most browsers, even back to IE6.\n\n[Peity](http://benpickles.github.com/peity/)\n\n> A jQuery plug-in for very simple and very _tiny_ bar, line, and pie charts\n> that supports only recent browsers. Did I mention that this makes only very\n> _tiny_ visualizations? +10 cuteness points.\n\n[Timeline.js](http://timeline.verite.co/)\n\n> A library specifically for generating interactive timelines. No coding is\n> required; just use the code generator. There is not much room for\n> customization, but hey, timelines are really hard to do well. Timeline.js\n> supports only IE8 and newer.\n\n[YUI Charts](http://yuilibrary.com/yui/docs/charts/)\n\n> The Charts module for the Yahoo! User Interface Library enables creation of\n> simple charts with a goal of wide browser support.\n\n### Graph Visualizations\n\nA “graph” is just data with a networked structure (for example, B is connected\nto A, and A is connected to C).\n\n[Arbor.js](http://arborjs.org/)\n\n> A library for graph visualization using jQuery. Even if you never use this,\n> you should check out how the documentation is presented as a graph, using\n> the tool itself. (It’s so _meta_.) It uses the HTML canvas, so it works only\n> in IE9 or current browsers, although some workarounds are available.\n\n[Sigma.js](http://sigmajs.org/)\n\n> A very lightweight library for graph visualization. You have to visit this\n> website, move your mouse over the header graphic, and then play with the\n> demos. Sigma.js is beautiful and fast, and it also uses canvas.\n\n### Geomapping\n\nI distinguish between _mapping_ (all visualizations are maps) and _geomapping_\n(visualizations that include geographic data, or geodata, such as traditional\nmaps). D3 has a lot of geomapping functionality, but you should know about\nthese other tools.\n\n[Kartograph](http://kartograph.org/)\n\n> A JavaScript-and-Python combo for gorgeous, entirely vector-based mapping by\n> Gregor Aisch with must-see demos. Please go look at them now. I promise\n> you’ve never seen online maps this beautiful. Kartograph works with IE7 and\n> newer.\n\n[Leaflet](http://leaflet.cloudmade.com/)\n\n> A library for tiled maps, designed for smooth interaction on both desktop\n> and mobile devices. It includes some support for displaying data layers of\n> SVG on top\n\nof the map tiles. (See Mike’s demo [“Using D3 with\nLeaflet”](http://bost.ocks.org/mike/leaflet/).) Leaflet works with IE6\n(barely) or IE7 (better!) and of course all current browsers.\n\n[Modest Maps](http://modestmaps.com/)\n\n> The granddaddy of tiled map libraries, Modest Maps has been succeeded by\n> Polymaps, but lots of people still love it, as it is lightweight and works\n> with old versions of IE and other browsers. Modest Maps has been adapted for\n> ActionScript, Processing, Python, PHP, Cinder, openFrameworks…yeah,\n> basically everything. File this under “oldie, but goodie.”\n\n[Polymaps](http://polymaps.org/)\n\n> A library for displaying tiled maps, with layers of data on top of the\n> tiles. Polymaps relies on SVG and thus works best with current browsers.\n\n### Almost from Scratch\n\nThese tools, like D3, provide methods of drawing visual forms, but without\npredesigned visual templates. If you enjoy the creative freedom of starting\nfrom scratch, you might enjoy these.\n\n[Processing.js](http://processingjs.org/)\n\n> A native JavaScript implementation of [Processing](http://processing.org/),\n> the fantastic programming language for artists and designers new to\n> programming. Processing is written in Java, so exporting Processing sketches\n> to the Web traditionally involved clunky Java applets. Thanks to\n> Processing.js, regular Processing code can run natively, in the browser. It\n> renders using canvas, so only modern browsers are supported.\n\n[Paper.js](http://paperjs.org/)\n\n> A framework for rendering vector graphics to canvas. Also, its website is\n> one of the most beautiful on the Internet, and their demos are unbelievable.\n> (Go play with them now.)\n\n[Raphaël](http://raphaeljs.com/)\n\n> Another library for drawing vector graphics, popular due to its friendly\n> syntax and support for older browsers.\n\n### Three-Dimensional\n\nD3 is not the best at 3D, simply because web browsers are historically two-\ndimensional beasts. But with increased support for WebGL, there are now more\nopportunities for 3D web experiences.\n\n[PhiloGL](http://www.senchalabs.org/philogl/)\n\n> A WebGL framework specifically for 3D visualization.\n\n[Three.js](http://mrdoob.github.com/three.js/)\n\n> A library for generating any sort of 3D scene you could imagine, produced by\n> Google’s Data Arts team. You could spend all day exploring the mind-blowing\n> demos on their site.\n\n### Tools Built with D3\n\nWhen you want to use D3 without actually writing any D3 code, you can choose\none of the many tools built on top of D3!\n\n[Crossfilter](http://square.github.com/crossfilter/)\n\n> A library for working with large, multivariate datasets, written primarily\n> by Mike Bostock. This is useful for trying to squeeze your “big data” into a\n> relatively small web browser.\n\n[Cubism](http://square.github.com/cubism/)\n\n> A D3 plug-in for visualizing time series data, also written by Mike Bostock.\n> (One of my favorite demos.)\n\n[Dashku](https://dashku.com/)\n\n> An online tool for data dashboards and widgets updated in real time, by Paul\n> Jensen.\n\n[dc.js](http://nickqizhu.github.com/dc.js/)\n\n> The “dc” is short for _dimensional charting_ , as this library is optimized\n> for exploring large, multidimensional datasets.\n\n[NVD3](http://nvd3.org)\n\n> Reusable charts with D3. NVD3 offers lots of beautiful examples, with room\n> for visual customizations without requiring as much code as D3 alone.\n\n[Polychart.js](http://polychart.com/)\n\n> More reusable charts, with a range of chart types available. Polychart.js is\n> free only for noncommercial use.\n\n[Rickshaw](http://code.shutterstock.com/rickshaw/)\n\n> A toolkit for displaying time series data that is also very customizable.\n\n[Tributary](http://enjalot.com/)\n\n> A great tool for experimenting with live coding using D3, by Ian Johnson.\n\n\n## Chapter 3. Technology Fundamentals\n\nSolid familiarity with the following concepts will make your time with D3 a\nlot less frustrating and a lot more rewarding. Consider this a brief refresher\ncourse on Web-Making 101.\n\n* * *\n\n### Warning\n\nBeware! This is a pretty dense chapter, packed with years’ worth of web\ndevelopment knowledge, and nothing in here is specific to D3. I recommend\nskimming just the sections on information that is new to you, and skipping the\nrest. You can always reference this chapter later as questions arise.\n\n* * *\n\n\n## The Web\n\nIf you’re brand new to making web pages, you will now have to think about\nthings that regular people blissfully disregard every day, such as this: How\ndoes the Web actually work?\n\nWe think of the Web as a bunch of interlinked pages, but it’s really a\ncollection of conversations between web servers and web clients (browsers).\n\nThe following scene is a dramatization of a typical such conversation that\nhappens whenever you or anyone else clicks a link or types an address into\nyour browser (meaning, this brief conversation is had about 88 zillion times\nevery day):\n\n> CLIENT: I’d really like to know what’s going on over at _somewebsite.com_. I\n> better call over there to get the latest info. [Silent sound of Internet\n> connection being established.]\n>\n> SERVER: Hello, unknown web client! I am the server hosting\n> _somewebsite.com_. What page would you like?\n>\n> CLIENT: This morning, I am interested in the page at\n> _somewebsite.com/news/_.\n>\n> SERVER: Of course, one moment.\n>\n> _Code is transmitted from SERVER to CLIENT._\n>\n> CLIENT: I have received it. Thank you!\n>\n> SERVER: You’re welcome! Would love to stay on the line and chat, but I have\n> other requests to process. Bye!\n\nClients contact servers with _requests_ , and servers respond with data. But\nwhat is a server and what is a client?\n\n_Web servers_ are Internet-connected computers running server software, so\ncalled because they _serve_ web documents as requested. Servers are typically\nalways on and always connected, but web developers often also run _local_\nservers, meaning they run on the same computer that you’re working on. _Local_\nmeans here; _remote_ means somewhere else, on any computer but the one right\nin front of you.\n\nThere are lots of different server software packages, but Apache is the most\ncommon. Web server software is not pretty, and no one ever wants to look at\nit.\n\nIn contrast, web _browsers_ can be very pretty, and we spend a lot of time\nlooking at them. Regular people recognize names like Firefox, Safari, Chrome,\nand Internet Explorer, all of which are browsers or _web clients_.\n\nEvery web page, in theory, can be identified by its URL (Uniform Resource\nLocator) or URI (Uniform Resource Identifier). Most people don’t know what\n_URL_ stands for, but they recognize one when they see it. By obsolete\nconvention, URLs commonly begin with _www_ , as in\n<http://www.calmingmanatee.com>, but with a properly configured server, the\n_www_ part is wholly unnecessary.\n\nComplete URLs consist of four parts:\n\n  * An indication of the _communication protocol_ , such as HTTP or HTTPS \n  * The _domain name_ of the resource, such as _calmingmanatee.com_\n  * The _port number_ , indicating over which port the connection to the server should be attempted \n  * Any additional locating information, such as the path of the requested file, or any query parameters\n\nA complete URL, then, might look like this:\n<http://alignedleft.com:80/tutorials/d3/>.\n\nTypically, the port number is excluded, as web browsers will try to connect\nover port 80 by default. So the preceding URL is functionally the same as the\nfollowing: <http://alignedleft.com/tutorials/d3/>\n\nNote that the protocol is separated from the domain name by a colon and two\nforward (regular) slashes. Why two slashes? No reason. The inventor of the Web\n[regrets the error](http://nyti.ms/Xaol4j).\n\nHTTP stands for Hypertext Transfer Protocol, and it’s the most common protocol\nfor transferring web content from server to client. The “S” on the end of\nHTTPS stands for _Secure_. HTTPS connections are used whenever information\nshould be encrypted in transit, such as for online banking or e-commerce.\n\nLet’s briefly step through the process of what happens when a person goes to\nvisit a website.\n\n  1. User runs the web browser of her choice, then types a URL into the address bar, such as _alignedleft.com/tutorials/d3/_. Because she did not specify a protocol, HTTP is assumed, and “http://” is prepended to the URL. \n  2. The browser then attempts to connect to the server behind _alignedleft.com_ across the network, via port 80, the default port for HTTP. \n  3. The server associated with _alignedleft.com_ acknowledges the connection and is taking requests. (“I’ll be here all night.”) \n  4. The browser sends a request for the page that lives at _/tutorials/d3/_. \n  5. The server sends back the HTML content for that page. \n  6. As the client browser receives the HTML, it discovers references to _other files_ needed to assemble and display the entire page, including CSS stylesheets and image files. So it contacts the same server again, once per file, requesting the additional information. \n  7. The server responds, dispatching each file as needed. \n  8. Finally, all the web documents have been transferred over. Now the client performs its most arduous task, which is to _render_ the content. It first parses through the HTML to understand the structure of the content. Then it reviews the CSS selectors, applying any properties to matched elements. Finally, it plugs in any image files and executes any JavaScript code. \n\nCan you believe that all that happens every time you click a link? It’s a lot\nmore complicated than most people realize, but it’s important to understand\nthat client/server conversations are fundamental to the Web.\n\n\n## HTML\n\nHypertext Markup Language is used to structure content for web browsers. HTML\nis stored in plain text files with the _.html_ suffix. A simple HTML document\nlooks like this:\n\n    \n    \n    <!DOCTYPE html>\n    <html>\n        <head>\n            <title>Page Title</title>\n        </head>\n        <body>\n            <h1>Page Title</h1>\n            <p>This is a really interesting paragraph.</p>\n        </body>\n    </html>\n\nHTML is a complex language with a rich history. This overview will address\nonly the current iteration of HTML (formerly known as HTML5) and will touch on\nonly what is immediately relevant for our practice with D3.\n\n### Content Plus Structure\n\nThe core function of HTML is to enable you to “mark up” content, thereby\ngiving it structure. Take, for example, this raw text:\n\n    \n    \n    Amazing Visualization Tool Cures All Ills A new open-source tool designed for\n    visualization of data turns out to have an unexpected, positive side effect:\n    it heals any ailments of the viewer. Leading scientists report that the tool,\n    called D3000, can cure even the following symptoms: fevers chills general\n    malaise It achieves this end with a patented, three-step process. Load in data.\n    Generate a visual representation. Activate magic healing function.\n\nReading between the lines, we can infer that this is a very exciting news\nstory. But as unstructured content, it is very hard to read. By adding\nstructure, we can differentiate between the headline, for example, and the\nbody of the story.\n\n> **Amazing Visualization Tool Cures All Ills**\n>\n> A new open-source tool designed for visualization of data turns out to have\n> an unexpected, positive side effect: it heals any ailments of the viewer.\n> Leading scientists report that the tool, called D3000, can cure even the\n> following symptoms:\n>\n>   * fevers\n>   * chills\n>   * general malaise\n>\n\n>\n> It achieves this end with a patented, three-step process.\n>\n>   1. Load in data.\n>   2. Generate a visual representation.\n>   3. Activate magic healing function.\n>\n\nThat has the same raw text content, but with a _visual structure_ that makes\nthe content more accessible.\n\nHTML is a tool for specifying _semantic structure_ , or attaching hierarchy,\nrelationships, and _meaning_ to content. (HTML doesn’t address the visual\nrepresentation of a document’s structure — that’s CSS’ job.) Here is our story\nwith each chunk of content replaced by a _semantic description_ of what that\ncontent is.\n\n> **Headline**\n>\n> Paragraph text\n>\n>   * Unordered list item\n>   * Unordered list item\n>   * Unordered list item\n>\n\n>\n> Paragraph text\n>\n>   1. Numbered list item\n>   2. Numbered list item\n>   3. Numbered list item\n>\n\nThis is the kind of structure we specify with HTML markup.\n\n### Adding Structure with Elements\n\n“Marking up” is the process of adding _tags_ to create _elements_. HTML tags\nbegin with `<` and end with `>`, as in `<p>`, which is the tag indicating a\nparagraph of text. Tags usually occur in pairs, in which case adding an\nopening and closing pair of tags creates a new _element_ in the document\nstructure.\n\nClosing tags are indicated with a slash that closes or ends the element, as in\n`</p>`. Thus, a paragraph of text may be marked up like the following:\n\n    \n    \n    <p>This is a really interesting paragraph.</p>\n\nSome elements can be _nested_. For example, here we use the `em` element to\nadd _emphasis_.\n\n    \n    \n    <p>This is a <em>really</em> interesting paragraph.</p>\n\nNesting elements introduces hierarchy to the document. In this case, `em` is a\nchild of `p` because it is contained by `p`. (Conversely, `p` is `em`’s\nparent.)\n\nWhen elements are nested, they cannot overlap closures of their parent\nelements, as doing so would disrupt the hierarchy. For example:\n\n    \n    \n    <p>This could cause <em>unexpected</p>\n    <p>results</em>, and is best avoided.</p>\n\nSome tags never occur in pairs, such as the `img` element, which references an\nimage file. Although HTML no longer requires it, you will sometimes see such\ntags written in _self-closing_ fashion, with a trailing slash before the\nclosing bracket:\n\n    \n    \n    <img src=\"photo.jpg\" />\n\nAs of HTML5, the self-closing slash is optional, so the following code is\nequivalent to the preceding code:\n\n    \n    \n    <img src=\"photo.jpg\">\n\n### Common Elements\n\nThere are hundreds of different HTML elements. Here are some of the most\ncommon. We’ll cover additional elements in later chapters. (Reference the\nexcellent [Mozilla Developer Network\ndocumentation](https://developer.mozilla.org/en/HTML/Element) for a complete\nlisting.)\n\n`<!DOCTYPE html>`\n\n> The standard document type declaration. Must be the first thing in the\n> document.\n\n`html`\n\n> Surrounds all HTML content in a document.\n\n`head`\n\n> The document `head` contains all metadata about the document, such as its\n> `title` and any references to external stylesheets and scripts.\n\n`title`\n\n> The title of the document. Browsers typically display this at the top of the\n> browser window and use this title when bookmarking a page.\n\n`body`\n\n> Everything not in the `head` should go in the `body`. This is the primary\n> visible content of the page.\n\n`h1`, `h2`, `h3`, `h4`\n\n> These let you specify headings of different levels. `h1` is a top-level\n> heading, `h2` is below that, and so on.\n\n`p`\n\n> A paragraph!\n\n`ul`, `ol`, `li`\n\n> Unordered lists are specified with `ul`, most often used for bulleted lists.\n> Ordered lists (`ol`) are often numbered. Both `ul` and `ol` should include\n> `li` elements to specify list items.\n\n`em`\n\n> Indicates emphasis. Typically rendered in _italics_.\n\n`strong`\n\n> Indicates additional emphasis. Typically rendered in **boldface**.\n\n`a`\n\n> A link. Typically rendered as underlined, blue text, unless otherwise\n> specified.\n\n`span`\n\n> An arbitrary `span` of text, typically within a larger containing element\n> like `p`.\n\n`div`\n\n> An arbitrary _division_ within the document. Used for grouping and\n> containing related elements.\n\nOur earlier example could be given semantic structure by marking it up using\nsome of these element’s tags:\n\n    \n    \n    <h1>Amazing Visualization Tool Cures All Ills</h1>\n    <p>A new open-source tool designed for visualization of data turns out to have\n    an unexpected, positive side effect: it heals any ailments of the viewer.\n    Leading scientists report that the tool, called D3000, can cure even the\n    following symptoms:</p>\n    <ul>\n        <li>fevers</li>\n        <li>chills</li>\n        <li>general malaise</li>\n    </ul>\n    <p>It achieves this end with a patented, three-step process.</p>\n    <ol>\n        <li>Load in data.</li>\n        <li>Generate a visual representation.</li>\n        <li>Activate magic healing function.</li>\n    </ol>\n\nWhen viewed in a web browser, that markup is rendered as shown in [Figure\n3-1](part0007_split_002.html#Typical_default_rendering_of_simple_HTML).\n\n![Typical default rendering of simple HTML](../images/00004.jpeg)\n\nFigure 3-1. Typical default rendering of simple HTML\n\nNotice that we specified only the _semantic_ structure of the content; we\ndidn’t specify any visual properties, such as color, type size, indents, or\nline spacing. Without such instructions, the browser falls back on its\n_default styles_ , which, frankly, are not too exciting.\n\n### Attributes\n\nAll HTML elements can be assigned _attributes_ by including property/value\npairs in the opening tag.\n\n    \n    \n    <tagname property=\"value\"></tagname>\n\nThe name of the property is followed by an equals sign, and the value is\nenclosed within double quotation marks.\n\nDifferent kinds of elements can be assigned different attributes. For example,\nthe `a` link tag can be given an `href` attribute, whose value specifies the\nURL for that link. (`href` is short for “HTTP reference.”)\n\n    \n    \n    <a href=\"http://d3js.org/\">The D3 website</a>\n\nSome attributes can be assigned to _any_ type of element, such as `class` and\n`id`.\n\n### Classes and IDs\n\nClasses and IDs are extremely useful attributes, as they can be referenced\nlater to identify specific pieces of content. Your CSS and JavaScript code\nwill rely heavily on classes and IDs to identify elements. For example:\n\n    \n    \n    <p>Brilliant paragraph</p>\n    <p>Insightful paragraph</p>\n    <p class=\"awesome\">Awe-inspiring paragraph</p>\n\nThese are three very uplifting paragraphs, but only one of them is truly\nawesome, as I’ve indicated with `class=\"awesome\"`. The third paragraph becomes\npart of a _class_ of _awesome_ elements, and it can be selected and\nmanipulated along with other class members. (We’ll get to that in a moment.)\n\nElements can be assigned multiple classes, simply by separating them with a\nspace:\n\n    \n    \n    <p class=\"uplifting\">Brilliant paragraph</p>\n    <p class=\"uplifting\">Insightful paragraph</p>\n    <p class=\"uplifting awesome\">Awe-inspiring paragraph</p>\n\nNow, all three paragraphs are `uplifting`, but only the last one is both\n`uplifting` _and_ `awesome`.\n\nIDs are used in much the same way, but there can be only one ID per element,\nand each ID value can be used only once on the page. For example:\n\n    \n    \n    <div id=\"content\">\n        <div id=\"visualization\"></div>\n        <div id=\"button\"></div>\n    </div>\n\nIDs are useful when a single element has some special quality, like a `div`\nthat functions as a button or as a container for other content on the page.\n\nAs a general rule, if there will be only _one_ such element on the page, you\ncan use an `id`. Otherwise, use a `class`.\n\n* * *\n\n### Warning\n\nClass and ID names cannot begin with numerals; they must begin with alphabetic\ncharacters. So `id=\"1\"` won’t work, but `id=\"item1\"` will. The browser will\nnot give you any errors; your code simply won’t work, and you will go crazy\ntrying to figure out why.\n\n* * *\n\n### Comments\n\nAs code grows in size and complexity, it is good practice to include comments.\nThese are friendly notes that you leave for yourself to remind you why you\nwrote the code the way you did. If you are like me, you will revisit projects\nonly weeks later and have lost all recollections of it. Commenting is an easy\nway to reach out and provide guidance and solace to your future (and very\nconfused) self.\n\nIn HTML, comments are written in the following format:\n\n    \n    \n    <!-- Your comment here -->\n\nAnything between the `<!--` and `-->` will be ignored by the web browser.\n\n\n## DOM\n\nThe term Document Object Model refers to the hierarchical structure of HTML.\nEach pair of bracketed tags (or, in some cases, a single tag) is an _element_\n, and we refer to elements’ relative relationships to each other in human\nterms: parent, child, sibling, ancestor, and descendant. For example, in this\nHTML:\n\n    \n    \n    <html>\n        <body>\n            <h1>Breaking News</h1>\n            <p></p>\n        </body>\n    </html>\n\n`body` is the parent element to both of its children, `h1` and `p` (which are\nsiblings to each other). All elements on the page are descendants of `html`.\n\nWeb browsers parse the DOM to make sense of a page’s content. As coders\nbuilding visualizations, we care about the DOM, because our code must navigate\nits hierarchy to apply styles and actions to its elements. We don’t want to\nmake _all_ the `div` elements blue; we need to know how to select just the\n`div`s of the class `sky` and make _them_ blue.\n\n\n## Developer Tools\n\nIn the olden days, the web development process went like this:\n\n  1. Write some code in a text editor.\n  2. Save the files. \n  3. Switch to a browser window. \n  4. Reload the page, and see if your code worked. \n  5. If it didn’t work, take a guess at what went wrong inside the magical black box of the web browser, then go back to step 1. \n\nBrowsers were notoriously secretive about what went on _inside_ the rendering\nengine, which made debugging a total nightmare. (Seriously, in the late 1990s\nand early 2000s, I literally had nightmares about this.) Fortunately, we live\nin a more enlightened age, and every modern-day browser has built-in\n_developer tools_ that expose the inner workings of the beast and enable us to\npoke around under the hood (to mix incompatible metaphors).\n\nAll this is to say that developer tools are a big deal and you will rely on\nthem heavily to both test your code and, when something breaks, figure out\nwhat went wrong.\n\nLet’s start with the simplest possible use of the developer tools: viewing the\nraw source code of an HTML page (see [Figure\n3-2](part0007_split_004.html#plain_source_view_window)).\n\nEvery browser supports this, although different browsers hide this option in\ndifferent places. In Chrome 23.0, it’s under View→Developer→View Source. In\nFirefox 17.0, look under Tools→Web Developer→Page Source. In Safari 6.0, it’s\nunder Develop→Show Page Source (although you must first set the “Develop” menu\nto display under Safari→Preferences→Advanced). Going forward, I’m going to\nassume that you’re using the newest version of whatever browser you choose.\n\n![Looking at the source code in a new window](../images/00005.jpeg)\n\nFigure 3-2. Looking at the source code in a new window\n\nThat gets you the raw HTML, but if any D3 or JavaScript code has been\nexecuted, the current DOM may be vastly different.\n\nFortunately, your browser’s developer tools enable you to see the current\nstate of the DOM. And, again, the developer tools are different in every\nbrowser. In Chrome, find them under View→Developer→Developer Tools. In\nFirefox, try Tools→Web Developer. In Safari, first enable the developer tools\n(in Safari→Preferences→Advanced). Then, in the Develop menu, choose Show Web\nInspector. In any browser, you can also use the corresponding keyboard\nshortcut (as shown adjacent to the menu item) or right-click and choose\n“inspect element” or something similar.\n\nUntil recently, Safari and Chrome shared the same developer tools, but with\nSafari 6.0, Apple completely redesigned their dev tools, much to the dismay of\nmany web-developing Safari fans. (The new tools are very hard to navigate, and\nI don’t think I’m the only one who feels that way.) Whichever browser you use\nmight look a bit different from my screenshots, but the functionality will be\nvery similar.\n\n[Figure 3-3](part0007_split_004.html#Safari_web_inspector) shows the Elements\ntab of Chrome’s web inspector. Here we can see the current state of the DOM.\nThis is useful because your code will modify DOM elements dynamically. In the\nweb inspector, you can watch elements as they change.\n\n![Chrome’s web inspector](../images/00006.jpeg)\n\nFigure 3-3. Chrome’s web inspector\n\nIf you look closely, you’ll already see some differences between the raw HTML\nand the DOM, including the fact that Chrome generated the required `html`,\n`head`, and `body` elements. (I was lazy and didn’t include them in my\noriginal HTML.)\n\nOne more thing: why am I focusing on Chrome, Firefox, and Safari? Why not\nInternet Explorer, Opera, or the many other browsers out there? For one, it’s\nbest to develop your projects using a browser with the broadest support for\nweb standards. Internet Explorer made huge progress with versions 9 and 10,\nbut Chrome, Firefox, and Safari are understood to have the broadest standards\nsupport, and they are updated more frequently.\n\nSecond, you’re going to spend a lot of time using the developer tools, so you\nshould develop with a browser that has tools you enjoy using. I was pretty\ndevoted to Safari until the 6.0 update changed everything. Now I’m going back\nand forth between Chrome and Firefox’s new dev tools. I recommend you try them\nall and decide what works best for you.\n\n\n## Rendering and the Box Model\n\n _Rendering_ is the process by which browsers, after parsing the HTML and\ngenerating the DOM, apply visual rules to the DOM contents and draw those\npixels to the screen.\n\nThe most important thing to keep in mind when considering how browsers render\ncontent is this: to a browser, everything is a box.\n\nParagraphs, `div`s, `span`s — all are boxes in the sense that they are two-\ndimensional rectangles, with properties that any rectangle can have, such as\nwidth, height, and positions in space. Even if something looks curved or\nirregularly shaped, rest assured, to the browser, it is merely another\nrectangular box.\n\nYou can see these boxes with the help of the web inspector. Just mouse over\nany element, and the box associated with that element is highlighted in blue,\nas shown in [Figure\n3-4](part0007_split_005.html#Inspector_with_element_box_highlighted).\n\n![Inspector with element box highlighted](../images/00007.jpeg)\n\nFigure 3-4. Inspector with element box highlighted\n\nThere’s a lot of information about the `ul` unordered list here. Note that the\nlist’s total dimensions (width and height) are shown in the yellow box at the\nelement’s lower-left corner. Also, the list’s position in the DOM hierarchy is\nindicated in the lower-left corner of the inspector: `html > body > ul`.\n\nThe box for the `ul` expands to fill the width of the entire window because it\nis a _block-level_ element. (Note how under “Computed Style” is listed\n`display: block`.) This is in contrast to _inline_ elements, which rest _in\nline_ with each other, not stacked on top of each other like blocks. Common\ninline elements include `strong`, `em`, `a`, and `span`.\n\nBy default, block-level elements expand to fill their container elements and\nforce any subsequent sibling elements further down the page. Inline elements\ndo not expand to fill extra space, and happily exist side by side, next to\ntheir fellow inline neighbors. (Discussion question: what kind of element\nwould you rather be?)\n\n\n## CSS\n\nCascading Style Sheets are used to style the visual presentation of DOM\nelements. A simple CSS stylesheet looks like the following:\n\n    \n    \n    body {\n        background-color: white;\n        color: black;\n    }\n\nCSS styles consist of _selectors_ and _properties_. Selectors are followed by\nproperties, grouped in curly brackets. A property and its value are separated\nby a colon, and the line is terminated with a semicolon, like the following:\n\n    \n    \n    selector {\n        property: value;\n        property: value;\n        property: value;\n    }\n\nThe same properties can be applied to multiple selectors at once by separating\nthe selectors with a comma, as in the following:\n\n    \n    \n    selectorA,\n    selectorB,\n    selectorC {\n        property: value;\n        property: value;\n        property: value;\n    }\n\nFor example, you might want to specify that both `p` paragraphs and `li` list\nitems should use the same font size, line height, and color.\n\n    \n    \n    p,\n    li {\n        font-size: 12px;\n        line-height: 14px;\n        color: orange;\n    }\n\nCollectively, this whole chunk of code (selectors and bracketed properties) is\ncalled a _CSS rule_.\n\n### Selectors\n\nD3 uses CSS-style selectors to identify elements on which to operate, so it’s\nimportant to understand how to use them.\n\nSelectors identify specific elements to which styles will be applied. There\nare several different kinds of selectors. We’ll use only the simplest ones in\nthis book.\n\nType selectors\n\n> These are the simplest. They match DOM elements with the same name:\n    \n    \n    h1          /* Selects all level 1 headings           */\n    p           /* Selects all paragraphs                 */\n    strong      /* Selects all strong elements            */\n    em          /* Selects all em elements                */\n    div         /* Selects all divs                       */\n\nDescendant selectors\n\n> These match elements that are contained by (or “descended from”) another\n> element. We will rely heavily on descendant selectors to apply styles:\n    \n    \n    h1 em       /* Selects em elements contained in an h1 */\n    div p       /* Selects p elements contained in a div  */\n\nClass selectors\n\n> These match elements of any type that have been assigned a specific class.\n> Class names are preceded with a period, as shown here:\n    \n    \n    .caption    /* Selects elements with class \"caption\"  */\n    .label      /* Selects elements with class \"label\"    */\n    .axis       /* Selects elements with class \"axis\"     */\n\nBecause elements can have more than one class, you can target elements with\nmultiple classes by stringing the classes together, as in the following:\n\n    \n    \n    .bar.highlight  /* Could target highlighted bars      */\n    .axis.x         /* Could target an x-axis             */\n    .axis.y         /* Could target a y-axis              */\n\n`.axis` could be used to apply styles to both axes, for example, whereas\n`.axis.x` would apply only to the x-axis.\n\nID selectors\n\n> These match the single element with a given ID. (Remember, IDs can be used\n> only once each in the DOM.) IDs are preceded with a hash mark.\n    \n    \n    #header     /* Selects element with ID \"header\"       */\n    #nav        /* Selects element with ID \"nav\"          */\n    #export     /* Selects element with ID \"export\"       */\n\nSelectors get progressively more useful as you combine them in different ways\nto target specific elements. You can string selectors together to get very\nspecific results. For example:\n\n    \n    \n    div.sidebar /* Selects divs with class \"sidebar\", but\n                   not other elements with that class     */\n    #button.on  /* Selects element with ID \"button\", but\n                   only when the class \"on\" is applied    */\n\nRemember, because the DOM is dynamic, classes and IDs can be added and\nremoved, so you might have CSS rules that apply only in certain scenarios.\n\nFor details on additional selectors, see the [Mozilla Developer\nNetwork](http://mzl.la/V27Mcr).\n\n### Properties and Values\n\nGroups of property/value pairs cumulatively form the styles:\n\n    \n    \n    margin: 10px;\n    padding: 25px;\n    background-color: yellow;\n    color: pink;\n    font-family: Helvetica, Arial, sans-serif;\n\nAt the risk of stating the obvious, notice that each property expects a\ndifferent kind of information. `color` wants a color, `margin` requires a\nmeasurement (here in `px` or pixels), and so on.\n\nBy the way, colors can be specified in several different formats:\n\n  * Named colors: `orange`\n  * Hex values: `#3388aa` or `#38a`\n  * RGB values: `rgb(10, 150, 20)`\n  * RGB with alpha transparency: `rgba(10, 150, 20, 0.5)`\n\nYou can find [exhaustive lists of properties\nonline](https://developer.mozilla.org/en/CSS/CSS_Reference); I won’t try to\nlist them here. Instead, I’ll just introduce relevant properties as we go.\n\n### Comments\n\n    \n    \n    /* By the way, this is what a comment looks like\n       in CSS.  They start with a slash-asterisk pair,\n       and end with an asterisk-slash pair.  Anything\n       in between will be ignored. */\n\n### Referencing Styles\n\nThere are three common ways to apply CSS style rules to your HTML document.\n\n#### Embed the CSS in your HTML.\n\nIf you embed the CSS rules in your HTML document, you can keep everything in\none file. In the document `head`, include all CSS code within a `style`\nelement.\n\n    \n    \n    <html>\n        <head>\n            <style type=\"text/css\">\n    \n                p {\n                    font-size: 24px;\n                    font-weight: bold;\n                    background-color: red;\n                    color: white;\n                }\n    \n            </style>\n        </head>\n        <body>\n            <p>If I were to ask you, as a mere paragraph, would you say that I\n            have style?</p>\n        </body>\n    </html>\n\nThat HTML page with CSS renders as shown in [Figure\n3-5](part0007_split_006.html#Rendering_of_an_embedded_CSS_rule).\n\n![Rendering of an embedded CSS rule](../images/00008.jpeg)\n\nFigure 3-5. Rendering of an embedded CSS rule\n\nEmbedding is the simplest option, but I generally prefer to keep different\nkinds of code (for example, HTML, CSS, JavaScript) in separate documents.\n\n#### Reference an external stylesheet from the HTML.\n\nTo store CSS outside of your HTML, save it in a plain-text file with a _.css_\nsuffix, such as _style.css_. Then use a `link` element in the document `head`\nto reference the external CSS file, like so:\n\n    \n    \n    <html>\n        <head>\n            <link rel=\"stylesheet\" href=\"style.css\">\n        </head>\n        <body>\n            <p>If I were to ask you, as a mere paragraph, would you say that\n            I have style?</p>\n        </body>\n    </html>\n\nThis example renders exactly the same as the prior example.\n\n#### Attach inline styles.\n\nA third method is to attach style rules _inline_ directly to elements in the\nHTML. You can do this by adding a `style` attribute to any element. Then\ninclude the CSS rules within the double quotation marks. The result is shown\nin [Figure 3-6](part0007_split_006.html#Rendering_of_an_inline_CSS_rule).\n\n    \n    \n    <p style=\"color: blue; font-size: 48px; font-style: italic;\">Inline styles\n    are kind of a hassle</p>\n\n![Rendering of an inline CSS rule](../images/00009.jpeg)\n\nFigure 3-6. Rendering of an inline CSS rule\n\nBecause inline styles are attached directly to elements, there is no need for\nselectors.\n\nInline styles are messy and hard to read, but they are useful for giving\nspecial treatment to a single element, when that style information doesn’t\nmake sense in a larger stylesheet. We’ll learn how to apply inline styles\nprogrammatically with D3 (which is much easier than typing them in by hand,\none at a time).\n\n### Inheritance, Cascading, and Specificity\n\nMany style properties are _inherited_ by an element’s descendants unless\notherwise specified. For example, this document’s style rule applies to the\n`div`:\n\n    \n    \n    <html>\n        <head>\n            <title></title>\n            <style type=\"text/css\">\n    \n                div {\n                    background-color: red;\n                    font-size: 24px;\n                    font-weight: bold;\n                    color: white;\n                }\n    \n            </style>\n        </head>\n        <body>\n            <p>I am a sibling to the div.</p>\n            <div>\n                <p>I am a descendant and child of the div.</p>\n            </div>\n        </body>\n    </html>\n\nYet when this page renders, the styles intended for the `div` (red background,\nbold text, and so on) are _inherited_ by the second paragraph, as shown in\n[Figure 3-7](part0007_split_006.html#Inherited_style), because that `p` is a\ndescendant of the styled `div`.\n\n![Inherited style](../images/00010.jpeg)\n\nFigure 3-7. Inherited style\n\nInheritance is a great feature of CSS, as children adopt the styles of their\nparents. (There’s a metaphor in there somewhere.)\n\nFinally, an answer to the most pressing question of the day: why are they\ncalled Cascading Style Sheets? It’s because selector matches cascade from the\ntop down. When more than one selector applies to an element, the later rule\ngenerally overrides the earlier one. For example, the following rules set the\ntext of all paragraph elements in the document to be blue _except_ for those\nwith the class of `highlight` applied, which will be black _and_ have a yellow\nbackground, as shown in [Figure\n3-8](part0007_split_006.html#CSS_cascading_and_inheritance_at_work). The rules\nfor `p` are applied first, but then the rules for `p.highlight` override the\nless specific `p` rules.\n\n    \n    \n    p {\n        color: blue;\n    }\n    \n    p.highlight {\n        color: black;\n        background-color: yellow;\n    }\n\n![CSS cascading and inheritance at work](../images/00011.jpeg)\n\nFigure 3-8. CSS cascading and inheritance at work\n\nLater rules generally override earlier ones, but not always. The true logic\nhas to do with the _specificity_ of each selector. The `p.highlight` selector\nwould override the `p` rule even if it were listed first, simply because it is\na more specific selector. If two selectors have the same specificity, then the\nlater one will be applied.\n\nThis is one of the main causes of confusion with CSS. The rules for\ncalculating specificity are inscrutable, and I won’t cover them here. To save\nyourself headaches later, keep your selectors clear and easy to read. Start\nwith general selectors on top, and work your way down to more specific ones,\nand you’ll be all right.\n\n\n## JavaScript\n\nJavaScript is the scripting language that can make pages dynamic by\nmanipulating the DOM after a page has already loaded in the browser. As I\nmentioned earlier, getting to know D3 is also a process of getting to know\nJavaScript. We’ll dig in deeper as we go, but here is a taste to get you\nstarted.\n\n### Hello, Console\n\nNormally, we write JavaScript code (or, a “script”) in a text file, and then\nload that file to the browser in a web page. But you can also just type\nJavaScript code directly into your browser. This is an easy and quick way to\nget your feet wet and test out code. We’ll also use the JavaScript console for\ndebugging, as it’s an essential tool for seeing what’s going on with your\ncode.\n\nIn Chrome, select View→Developer→JavaScript Console. In Firefox, choose\nTools→Web Developer→Web Console. In Safari, go to Develop→Show Error Console\n(see [Figure 3-9](part0007_split_007.html#A_fresh_JavaScript_console)).\n\n![A fresh JavaScript console… delicious!](../images/00012.jpeg)\n\nFigure 3-9. A fresh JavaScript console… delicious!\n\nThe console accepts one line of code at a time, and it always spits back the\nresult of whatever you input. For example, if you enter the number `7`, the\nconsole returns the mind-numbingly obvious result of `7`. Brilliant.\n\nOther times, you’ll want your script to print values out to the console\nautomatically, so you can keep an eye on what’s going on. As you’ll see in\nsome examples that follow, you can use `console.log(\"something\");` to do that.\n\nType the following examples into the console to see how it works.\n\n### Variables\n\nVariables are containers for data. A simple variable holds one value:\n\n    \n    \n    var number = 5;\n\nIn that statement, `var` indicates you are declaring a new variable, the name\nof which is `number`. The equals sign is an _assignment operator_ because it\ntakes the value on the right (`5`) and _assigns_ it to the variable on the\nleft (`number`). So when you see something such as:\n\n    \n    \n    defaultColor = \"hot pink\";\n\ntry to read the equals sign not as “equals” but as “is set to.” So that\nstatement could be stated in plain English as “The variable `defaultColor` _is\nset to_ hot pink.”\n\nAs you’ve just seen, variables can store numeric values as well as strings of\ntext, so called because they are formed by stringing together individual\ncharacters of text. Strings must be enclosed by quotation marks. True or false\n(Boolean) values can also be stored:\n\n    \n    \n    var thisMakesSenseSoFar = true;\n\nAlso note that in JavaScript, statements are concluded with a semicolon.\n\nYou can try making some variables yourself in the console. For example, type\n`var amount = 200`, then press Enter, then on a new line just enter `amount`\nand press Enter. You should see `200` returned to you in the console — proof\nthat JavaScript remembered the value you assigned to `amount`!\n\n### Other Variable Types\n\nA variable is a datum, the smallest building block of data. The variable is\nthe foundation of all other data structures, which are simply different\nconfigurations of variables.\n\nNow we’ll address some of these more complex forms of data, including arrays,\nobjects, and arrays of objects. You might want to skip this section for now,\nbut reference it later, once you’re ready to load your own data into D3.\n\n### Arrays\n\nAn array is a sequence of values, conveniently stored in a single variable.\n\nKeeping track of related values in separate variables is inefficient:\n\n    \n    \n    var numberA = 5;\n    var numberB = 10;\n    var numberC = 15;\n    var numberD = 20;\n    var numberE = 25;\n\nRewritten as an array, those values are much simpler. Hard brackets `[]`\nindicate an array, and each value is separated by a comma:\n\n    \n    \n    var numbers = [ 5, 10, 15, 20, 25 ];\n\nArrays are ubiquitous in data visualization, so you will become very\ncomfortable with them. You can access (retrieve) a value in an array by using\n_bracket notation_ :\n\n    \n    \n    numbers[2]  //Returns 15\n\nThe numeral in the bracket refers to a corresponding position in the array.\nRemember, array positions begin counting at zero, so the first position is 0,\nthe second position is 1, and so on:\n\n    \n    \n    numbers[0]  //Returns 5\n    numbers[1]  //Returns 10\n    numbers[2]  //Returns 15\n    numbers[3]  //Returns 20\n    numbers[4]  //Returns 25\n\nSome people find it helpful to think of arrays in spatial terms, as though\nthey have rows and columns, like in a spreadsheet:\n\nPosition |  Value  \n---|---  \n0| 5  \n1| 10  \n2| 15  \n3| 20  \n4| 25  \n  \nArrays can contain any type of data, not just integers:\n\n    \n    \n    var percentages = [ 0.55, 0.32, 0.91 ];\n    var names = [ \"Ernie\", \"Bert\", \"Oscar\" ];\n    \n    percentages[1]  //Returns 0.32\n    names[1]        //Returns \"Bert\"\n\nAlthough I don’t recommend it, different types of values can even be stored\nwithin the same array:\n\n    \n    \n    var mishmash = [ 1, 2, 3, 4.5, 5.6, \"oh boy\", \"say it isn't\", true ];\n\n### Objects\n\nArrays are great for simple lists of values, but with more complex datasets,\nyou’ll want to put your data into an object. For our purposes, think of a\nJavaScript object as a custom data structure. We use curly brackets `{}` to\nindicate an object. In between the brackets, we include _properties_ and\n_values_. A colon `:` separates each property and its value, and a comma\nseparates each property/value pair:\n\n    \n    \n    var fruit = {\n        kind: \"grape\",\n        color: \"red\",\n        quantity: 12,\n        tasty: true\n    };\n\nTo reference each value, we use _dot notation_ , specifying the name of the\nproperty:\n\n    \n    \n    fruit.kind      //Returns \"grape\"\n    fruit.color     //Returns \"red\"\n    fruit.quantity  //Returns 12\n    fruit.tasty     //Returns true\n\nThink of the value as “belonging” to the object. Oh, look, some fruit. “What\nkind of fruit is that?” you might ask. As it turns out, `fruit.kind` is\n`\"grape\"`. “Are they tasty?” Oh, definitely, because `fruit.tasty` is `true`.\n\n### Objects and Arrays\n\nYou can combine these two structures to create arrays of objects, or objects\nof arrays, or objects of objects or, well, basically whatever structure makes\nsense for your dataset.\n\nLet’s say we have acquired a couple more pieces of fruit, and we want to\nexpand our catalog accordingly. We use hard brackets `[]` on the outside, to\nindicate an array, followed by curly brackets `{}` and object notation on the\ninside, with each object separated by a comma:\n\n    \n    \n    var fruits = [\n        {\n            kind: \"grape\",\n            color: \"red\",\n            quantity: 12,\n            tasty: true\n        },\n        {\n            kind: \"kiwi\",\n            color: \"brown\",\n            quantity: 98,\n            tasty: true\n        },\n        {\n            kind: \"banana\",\n            color: \"yellow\",\n            quantity: 0,\n            tasty: true\n        }\n    ];\n\nTo access this data, we just follow the trail of properties down to the values\nwe want. Remember, `[]` means array, and `{}` means object. `fruits` is an\narray, so first we use bracket notation to specify an array index:\n\n    \n    \n    fruits[1]\n\nNext, each array element is an object, so just tack on a dot and a property:\n\n    \n    \n    fruits[1].quantity   //Returns 98\n\nHere’s a map of how to access every value in the `fruits` array of objects:\n\n    \n    \n    fruits[0].kind      ==  \"grape\"\n    fruits[0].color     ==  \"red\"\n    fruits[0].quantity  ==  12\n    fruits[0].tasty     ==  true\n    \n    fruits[1].kind      ==  \"kiwi\"\n    fruits[1].color     ==  \"brown\"\n    fruits[1].quantity  ==  98\n    fruits[1].tasty     ==  true\n    \n    fruits[2].kind      ==  \"banana\"\n    fruits[2].color     ==  \"yellow\"\n    fruits[2].quantity  ==  0\n    fruits[2].tasty     ==  true\n\nYes, that’s right, we have `fruits[2].quantity` bananas.\n\n#### JSON\n\nAt some point in your D3 career, you will encounter JavaScript Object\nNotation. You can [read up on the details](http://en.wikipedia.org/wiki/Json),\nbut JSON is basically a specific syntax for organizing data as JavaScript\nobjects. The syntax is optimized for use with JavaScript (obviously) and AJAX\nrequests, which is why you’ll see a lot of web-based application programming\ninterfaces (APIs) that return data formatted as JSON. It’s faster and easier\nto parse with JavaScript than XML, and of course D3 works well with it.\n\nAll that, and it doesn’t look much weirder than what we’ve already seen:\n\n    \n    \n    {\n        \"kind\": \"grape\",\n        \"color\": \"red\",\n        \"quantity\": 12,\n        \"tasty\": true\n    }\n\nThe only difference here is that our property names are now surrounded by\ndouble quotation marks `\"\"`, making them string values.\n\nJSON objects, like all other JavaScript objects, can of course be stored in\nvariables like so:\n\n    \n    \n    var jsonFruit = {\n        \"kind\": \"grape\",\n        \"color\": \"red\",\n        \"quantity\": 12,\n        \"tasty\": true\n    };\n\n#### GeoJSON\n\nJust as JSON is just a formalization of existing JavaScript object syntax,\nGeoJSON is a formalized syntax of JSON objects, optimized for storing geodata.\nAll GeoJSON object are JSON objects, and all JSON objects are JavaScript\nobjects.\n\n[GeoJSON](http://geojson.org/geojson-spec.html) can store points in\ngeographical space (typically as longitude/latitude coordinates), but also\nshapes (such as lines and polygons) and other spatial features. If you have a\nlot of geodata, it’s worth it to parse it into GeoJSON format for best use\nwith D3.\n\nWe’ll get into the details of GeoJSON when we talk about geomaps, but for now,\njust know that this is what simple GeoJSON data could look like the following:\n\n    \n    \n    {\n        \"type\": \"FeatureCollection\",\n        \"features\": [\n            {\n                \"type\": \"Feature\",\n                \"geometry\": {\n                    \"type\": \"Point\",\n                    \"coordinates\": [ 150.1282427, -24.471803 ]\n                },\n                \"properties\": {\n                    \"type\": \"town\"\n                }\n            }\n        ]\n    }\n\nConfusingly, longitude is always listed before latitude. Get used to thinking\nin terms of lon/lat instead of lat/lon.\n\n### Mathematical Operators\n\nYou can add, subtract, multiply, and divide values using the following\noperators, respectively:\n\n    \n    \n    +   //Add\n    -   //Subtract\n    *   //Multiply\n    /   //Divide\n\nFor example, type `8 * 2` into the console, press Enter, and you should see\n`16`. More examples:\n\n    \n    \n    1 + 2       //Returns 3\n    10 - 0.5    //Retuns 9.5\n    33 * 3      //Returns 99\n    3 / 4       //Returns 0.75\n\n### Comparison Operators\n\nYou can compare values against each other using the following operators:\n\n    \n    \n    ==  //Equal to\n    !=  //Not equal to\n    <   //Less than\n    >   //Greater than\n    <=  //Less than or equal to\n    >=  //Greater than or equal to\n\nThese all compare some value on the left to some value on the right. If the\nresult is true, then `true` is returned. If the result is false, `false` is\nreturned.\n\nTry it! Type each of the following into the console and see what you get:\n\n    \n    \n    3 == 3\n    3 == 5\n    3 >= 3\n    3 >= 2\n    100 < 2\n    298 != 298\n\n(JavaScript also offers the `===` and `!==` operators, which perform equality\ncomparisons without type coercion, but I won’t be addressing that distinction\nin this book.)\n\n### Control Structures\n\nWhenever your code needs to make a decision or repeat something, you need a\ncontrol structure. There are lots to choose from, but we are primarily\ninterested in `if` statements and `for` loops.\n\n#### if() only\n\nAn `if` statement uses comparison operators to determine if a statement is\ntrue or false:\n\n    \n    \n    if (test) {\n        //Code to run if true\n    }\n\nIf the test between parentheses is `true`, then the code between the curly\nbrackets is run. If the test turns up `false`, then the bracketed code is\nignored, and life goes on. (Technically, life goes on either way.)\n\n    \n    \n    if (3 < 5) {\n        console.log(\"Eureka! Three is less than five!\");\n    }\n\nIn the preceding example, the bracketed code will always be executed, because\n`3 < 5` is always true. `if` statements are more useful when comparing\nvariables or other conditions that change.\n\n    \n    \n    if (someValue < anotherValue) {\n        //Set someValue to anotherValue, thereby restoring\n        //a sense of balance and equilibrium to the world.\n        someValue = anotherValue;\n    }\n\n#### for() now\n\nYou can use `for` loops to repeatedly execute the same code, with slight\nvariations. A `for` loop uses this syntax:\n\n    \n    \n    for (initialization; test; update) {\n        //Code to run each time through the loop\n    }\n\nThey are so-called because they loop through the code _for_ as many times as\nspecified. First, the initialization statement is run. Then, the test is\nevaluated, like a mini `if` statement. If the test is true, then the bracketed\ncode is run. Finally, the `update` statement is run, and the test is\nreevaluated.\n\nThe most common application of a `for` loop is to increase some variable by 1\neach time through the loop. The test statement can then control how many times\nthe loop is run by referencing that value. (The variable is often named `i`,\npurely by convention, because it is short and easy to type.)\n\n    \n    \n    for (var i = 0; i < 5; i++) {\n        console.log(i);  //Prints value to console\n    }\n\nThe preceding `for` loop prints the following to the console:\n\n    \n    \n    0\n    1\n    2\n    3\n    4\n\nThe first time through, a variable named `i` is declared and set to zero. `i`\nis less than five, so the bracketed code is run, printing the current value of\n`i` (zero) to the console. Finally, the value of `i` is increased by one.\n(`i++` is shorthand for `i = i + 1`.) So now `i` is `1`, so the test again\nevaluates as true, the bracketed code is run again, but this time the value\nprinted to the console is 1.\n\nAs you can see, reading prose descriptions of loops is about as interesting as\nexecuting them by hand yourself. This is why we invented computers. So I’ll\nskip to the end and point out that after the final iteration, `i` is increased\nto 5, after which the test returns false, and the loop is over.\n\nIt’s important to note that counting began at zero, and not one. That is, the\n“first” value of `i` was `0`. Why not `1`? This is another arbitrary\nconvention, but it nicely parallels how computers count arrays of values.\n\n#### What arrays are made for()\n\nCode-based data visualization would not be possible without arrays and the\nmighty `for()` loop. Together, they form a data geek’s dynamic duo. (If you do\nnot consider yourself a “data geek,” then may I remind you that you are\nreading a book titled _Interactive Data Visualization for the Web_?)\n\nAn array organizes lots of data values in one convenient place. Then `for()`\ncan quickly “loop” through every value in an array and perform some action\nwith it — such as, express the value as a visual form. D3 often manages this\nlooping for us, such as with its magical `data()` method.\n\nNote this example, which loops through each of the values in an array called\n`numbers`:\n\n    \n    \n    var numbers = [ 8, 100, 22, 98, 99, 45 ];\n    \n    for (var i = 0; i < numbers.length; i++) {\n        console.log(numbers[i]);  //Print value to console\n    }\n\nSee that `numbers.length`? That’s the beautiful part. `length` is a property\nof every array. In this case, `numbers` contains six values, so\n`numbers.length` resolves to `6`, and the loop runs six times. If `numbers`\nwere 10 positions long, the loop would run 10 times. If it were 10 million\npositions long … yeah, you get it. This is what computers are good at: taking\na set of instructions and executing them over and over. And this is at the\nheart of why data visualization can be so rewarding — you design and code the\nvisualization system, and the system will respond appropriately, even as you\nfeed it different data. The system’s mapping rules are consistent, even when\nthe data is not.\n\n### Functions\n\nFunctions are chunks of code that do things.\n\nMore specifically, functions are special because they can take arguments or\nparameters as input, and then return values as output. Parentheses are used to\n_call_ (execute) a function. If that function requires any arguments (input\nvalues), then they are _passed_ to the function by including them in the\nparentheses.\n\nWhenever you see something like the following code, you know it’s a function:\n\n    \n    \n    calculateGratuity(38);\n\nIn fact, you’ve already seen functions at work with `console.log`, as in the\nfollowing:\n\n    \n    \n    console.log(\"Look at me. I can do stuff!\");\n\nBut the best part about functions is that you can define your own. There are\nseveral ways to define functions in JavaScript, but here’s the simplest, which\nI’ll use throughout this book:\n\n    \n    \n    var calculateGratuity = function(bill) {\n        return bill * 0.2;\n    };\n\nThis declares a new variable named `calculateGratuity`. Then, instead of\nassigning a simple number or string, we store an entire function in the\nvariable. In the parentheses, we name `bill`, another variable to be used only\nby the function itself. `bill` is the expected input. When called, the\nfunction will take that input, multiply it by `0.2`, and _return_ the result\nas its output.\n\nSo now if we call:\n\n    \n    \n    calculateGratuity(38);\n\nthe function returns 7.6. Not bad — a 20 percent tip!\n\nOf course, you could store the output to use it elsewhere later, as in:\n\n    \n    \n    var tip = calculateGratuity(38);\n    console.log(tip);  //Prints 7.6 to the console\n\nThere are also _anonymous_ functions that, unlike `calculateGratuity`, don’t\nhave names. Anonymous functions are used all the time with D3, but I’ll\nintroduce them later.\n\n### Comments\n\n    \n    \n    /* JavaScript supports CSS-style comments like this. */\n    \n    // But double-slashes can be used as well.\n    // Anything following // on the same line will be ignored.\n    // This is helpful for including brief notes to yourself\n    // as to what each line of code does, as in:\n    \n    console.log(\"Brilliant\");  //Prints \"Brilliant\" to the console\n\n### Referencing Scripts\n\nScripts can be included directly in HTML, between two `script` tags, as in:\n\n    \n    \n    <body>\n        <script type=\"text/javascript\">\n            alert(\"Hello, world!\");\n        </script>\n    </body>\n\nor stored in a separate file with a _.js_ suffix, and then referenced\nsomewhere in the HTML (could be in the `head`, as shown here, or also just\nbefore the end of the closing `body` tag):\n\n    \n    \n    <head>\n        <title>Page Title</title>\n        <script type=\"text/javascript\" src=\"myscript.js\"></script>\n    </head>\n\n### JavaScript Gotchas\n\nAs a bonus, and at no extra charge, I would like to share with you my top four\nJavaScript gotchas: things that, had I known earlier, would have saved me many\nhours of late-night debugging sessions, anxiety-induced panic, and increased\ncortisol levels. You might want to come back and reference this section later.\n\n#### Dynamic typing\n\nI do love how your fingers flutter across the keyboard, but that’s not what\nI’m talking about. No, JavaScript is a _loosely typed_ language, meaning you\ndon’t have to specify what _type_ of information will be stored in a variable\nin advance. Many other languages, like Java (which is completely different\nfrom Java _Script_), require you to declare a variable’s type, such as `int`,\n`float`, `boolean`, or `String`:\n\n    \n    \n    //Declaring variables in Java\n    int number = 5;\n    float value = 12.3467;\n    boolean active = true;\n    String text = \"Crystal clear\";\n\nJavaScript, however, automatically _types_ a variable based on what kind of\ninformation you assign to it. (Note that `''` or `\"\"` indicate string values.\nI prefer double quotation marks `\"\"`, but some people like singles `''`.)\n\n    \n    \n    //Declaring variables in JavaScript\n    var number = 5;\n    var value = 12.3467;\n    var active = true;\n    var text = \"Crystal clear\";\n\nHow boring — `var`, `var`, `var`, `var`! — yet handy, as we can declare and\nname variables before we even know what type of data will go into them. You\ncan even change a variable’s type on-the-fly without JavaScript freaking out\non you:\n\n    \n    \n    var value = 100;\n    value = 99.9999;\n    value = false;\n    value = \"This can't possibly work.\";\n    value = \"Argh, it does work! No errorzzzz!\";\n\nI mention this because one day a numeric value will be accidentally stored as\na string, and it will cause some part of your code to behave strangely, and\nbasically I don’t want you to come crying to me when that happens. Thus, know\nthat whenever a variable’s type is in doubt, you can employ the `typeof`\noperator:\n\n    \n    \n    typeof 67;              //Returns \"number\"\n    var myName = \"Scott\";\n    typeof myName;          //Returns \"string\"\n    myName = true;\n    typeof myName;          //Returns \"boolean\"\n\n#### Variable hoisting\n\nContrary to what you would expect, JavaScript code is usually, but not always,\nexecuted in linear, top-to-bottom order. For example, in this code, when would\nyou expect the variable `i` to be established?\n\n    \n    \n    var numLoops = 100;\n    for (var i = 0; i < numLoops; i++) {\n        console.log(i);\n    }\n\nIn many other languages, `i` would be declared right when the `for` loop\nbegins, as you’d expect. But thanks to a phenomenon known as _variable\nhoisting_ , in JavaScript, variable declarations are _hoisted_ up to the top\nof the function context in which they reside. So in our example, `i` is\nactually declared _before_ the `for` loop even begins. The following is\nequivalent:\n\n    \n    \n    var numLoops = 100;\n    var i;\n    for (i = 0; i < numLoops; i++) {\n        console.log(i);\n    }\n\nThis can be problematic when you have conflicting variable names, as a\nvariable that you thought existed only later in the code is actually present\nright at the beginning.\n\n#### Function-level scope\n\nIn programming, the concept of _variable scope_ helps us identify which\nvariables are accessible in which contexts. Generally, it is a bad idea to\nhave every value accessible from everywhere else because you’d end up with so\nmany conflicts and accidental value changes that you would just go crazy.\n\nMany languages use _block-level scope_ , in which variables exist only within\nthe current “block” of code, usually indicated by curly braces. With block-\nlevel scope, our `i` would exist only within the context of the `for` loop,\nfor example, so any attempts to read the value of `i` or change `i` outside of\nthe loop would fail. This is nice because you could establish other variables\nfrom within your loop and know that they wouldn’t conflict with variables that\nexist elsewhere.\n\nIn JavaScript, however, variables are scoped at the function level, meaning\nthey are accessible anywhere within the _function_ (not block) in which they\nreside.\n\nThis is primarily something to be aware of if you’re used to other languages.\nBottom line: You can keep values contained by wrapping them within functions.\n\n#### Global namespace\n\nSpeaking of variable conflicts, please do me a favor: open any web page,\nactivate the JavaScript console, type **`window`** , and click the gray\ndisclosure triangle to view its contents.\n\nI know it feels like you just entered the matrix, but this is actually called\n“the global namespace,” which might sound even cooler (see [Figure\n3-10](part0007_split_007.html#The_global_namespace)).\n\n![The global namespace](../images/00013.jpeg)\n\nFigure 3-10. The global namespace\n\n`window` is the topmost object in the browser’s hierarchy of JavaScript\nelements, and all of these objects and values you see beneath `window` exist\nat the _global_ level. What this means is that every time you declare a new\nvariable, you are adding a new value to `window`. Or, as righteous JavaScript\ncoders like to say, you are polluting the global namespace. (Surprisingly,\nmost people who write things like this in online forums are actually quite\nfriendly in person.)\n\nFor example, try typing this into the console: **`var zebras = \"amazing\"`**.\n\nThen type **`window`** again, and scroll all the way down to the bottom, where\nyou should now see `zebras`, as shown in [Figure\n3-11](part0007_split_007.html#The_global_namespace_now_with_zebras).\n\n![The global namespace, now with zebras](../images/00014.jpeg)\n\nFigure 3-11. The global namespace, now with zebras\n\n(Confusingly, it is also possible to define new variables in JavaScript\nwithout using the standard `var` declaration, so typing simply **`zebras =\n\"amazing\"`** would have the same effect as that shown.)\n\nWhat’s so wrong with adding values to `window`? As you get started, nothing at\nall. But as your projects grow in complexity, and especially if you begin to\nincorporate other non-D3 JavaScript code (such as jQuery, Facebook “Like”\nbuttons, or Google Analytics tracking code), at some point you’re bound to run\ninto a conflict because you’re using the variable `zebras` for your project,\nbut zebraTracker.js is _also_ using a variable with the same name! The result:\nchaos. Or at least some bad data, which could lead to unexpected behavior or\nerrors.\n\nThere are two easy workarounds (and, to clarify, you probably don’t have to\nworry about this until later):\n\n  * Declare variables only within other functions. This is not usually feasible, but the function-level scope will prevent local variables from conflicting with others. \n  * Declare a single global object, and attach all of your would-be global variables to that object. For example: \n\n    \n    \n    var Vis = {};  //Declare empty global object\n    Vis.zebras = \"still pretty amazing\";\n    Vis.monkeys = \"too funny LOL\";\n    Vis.fish = \"you know, not bad\";\n\nAll of your weird animal-related variables are no longer polluting the global\nnamespace, but instead they all exist as values stored within your single,\nglobal object, `Vis`. Of course, `Vis` could be named whatever you like, but\n`Menagerie` is harder to type. Regardless, the only naming conflict you’ll\nhave with other scripts is if one of them _also_ wants to have a global object\nwith the same name (`Vis`), which is far less likely.\n\n\n## SVG\n\nD3 is most useful when used to generate and manipulate visuals as Scalable\nVector Graphics (SVG). Drawing with `div`s and other native HTML elements is\npossible, but a bit clunky and subject to the usual inconsistencies across\ndifferent browsers. Using SVG is more reliable, visually consistent, and\nfaster.\n\n[Figure 3-12](part0007_split_008.html#A_small_SVG_circle) shows a small\ncircle, and its SVG code follows.\n\n![A small SVG circle](../images/00015.gif)\n\nFigure 3-12. A small SVG circle\n\n    \n    \n    <svg width=\"50\" height=\"50\">\n        <circle cx=\"25\" cy=\"25\" r=\"22\" fill=\"blue\" stroke=\"gray\" stroke-width=\"2\"/>\n    </svg>\n\nVector drawing software like Illustrator can be used to generate SVG files,\nbut we need to learn how to generate them with code.\n\n### The SVG Element\n\nSVG is a text-based image format. Each SVG image is defined using markup code\nsimilar to HTML, and SVG code can be included directly within any HTML\ndocument, or inserted dynamically into the DOM. Every web browser supports SVG\n_except_ [Internet Explorer versions 8 and\nearlier](http://caniuse.com/#feat=svg). SVG is XML-based, so you’ll notice\nthat elements that don’t have a closing tag must be self-closing. For example:\n\n    \n    \n    <element></element> <!-- Uses closing tag -->\n    <element/>          <!-- Self-closing tag -->\n\nBefore you can draw anything, you must create an SVG element. Think of the SVG\nelement as a canvas on which your visuals are rendered. (In that respect, SVG\nis conceptually similar to HTML’s `canvas` element.) At a minimum, it’s good\nto specify `width` and `height` values. If you don’t specify these, the SVG\nwill behave like a typically greedy, block-level HTML element and take up as\nmuch room as it can within its enclosing element:\n\n    \n    \n    <svg width=\"500\" height=\"50\">\n    </svg>\n\nNote that _pixels_ are the default measurement units, so we can specify\ndimensions of `500` and `50`, not `500px` and `50px`. We could have specified\n`px` explicitly, or any number of other supported units, including `em`, `pt`,\n`in`, `cm`, and `mm`.\n\n### Simple Shapes\n\nThere are a number of visual elements that you can include between those `svg`\ntags, including `rect`, `circle`, `ellipse`, `line`, `text`, and `path`.\n(Sorry, `zebras` is not valid in this context.)\n\nIf you’re familiar with computer graphics programming, you’ll recognize the\nusual pixel-based coordinates system in which `0,0` is the top-left corner of\nthe drawing space. Increasing `x` values move to the right, while increasing\n`y` values move down (see [Figure\n3-13](part0007_split_008.html#The_SVG_coordinates_system)).\n\n![The SVG coordinates system](../images/00016.jpeg)\n\nFigure 3-13. The SVG coordinates system\n\n`rect` draws a rectangle. Use `x` and `y` to specify the coordinates of the\nupper-left corner, and `width` and `height` to specify the dimensions. This\nrectangle fills the entire space of our SVG, as shown in [Figure\n3-14](part0007_split_008.html#An_SVG_rect):\n\n    \n    \n    <rect x=\"0\" y=\"0\" width=\"500\" height=\"50\"/>\n\n![An SVG rect](../images/00017.gif)\n\nFigure 3-14. An SVG rect\n\n`circle` draws a circle. Use `cx` and `cy` to specify the coordinates of the\n_center_ , and `r` to specify the radius. This circle is centered in the\nmiddle of our 500-pixel-wide SVG because its `cx` (“center-x”) value is 250\n(see [Figure 3-15](part0007_split_008.html#An_SVG_circle)):\n\n    \n    \n    <circle cx=\"250\" cy=\"25\" r=\"25\"/>\n\n![An SVG circle](../images/00018.gif)\n\nFigure 3-15. An SVG circle\n\n`ellipse` is similar, but expects separate radius values for each axis.\nInstead of `r`, use `rx` and `ry` to obtain the result shown in [Figure\n3-16](part0007_split_008.html#An_SVG_ellipse):\n\n    \n    \n    <ellipse cx=\"250\" cy=\"25\" rx=\"100\" ry=\"25\"/>\n\n![An SVG ellipse](../images/00019.gif)\n\nFigure 3-16. An SVG ellipse\n\n`line` draws a line, as shown in [Figure\n3-17](part0007_split_008.html#An_SVG_line). Use `x1` and `y1` to specify the\ncoordinates of one end of the line, and `x2` and `y2` to specify the\ncoordinates of the other end. A `stroke` color must be specified for the line\nto be visible:\n\n    \n    \n    <line x1=\"0\" y1=\"0\" x2=\"500\" y2=\"50\" stroke=\"black\"/>\n\n![An SVG line](../images/00020.gif)\n\nFigure 3-17. An SVG line\n\n`text` renders text. Use `x` to specify the position of the left edge, and `y`\nto specify the vertical position of the type’s _baseline_. (Baseline is a\ntypographical term for the invisible line on which the letters appear to rest.\nPortions of letters such as “p” and “y” that extend below the baseline are\ncalled descenders.) The result of the following code is displayed in [Figure\n3-18](part0007_split_008.html#SVG_text):\n\n    \n    \n    <text x=\"250\" y=\"25\">Easy-peasy</text>\n\n![SVG text](../images/00021.gif)\n\nFigure 3-18. SVG text\n\n`text` will inherit the CSS-specified font styles of its parent element unless\nspecified otherwise. (More on styling text in a moment.) We could override\nthat formatting as follows and obtain the result shown in [Figure\n3-19](part0007_split_008.html#More_SVG_text):\n\n    \n    \n    <text x=\"250\" y=\"25\" font-family=\"serif\" font-size=\"25\"\n     fill=\"gray\">Easy-peasy</text>\n\n![More SVG text](../images/00022.gif)\n\nFigure 3-19. More SVG text\n\nAlso note that when any visual element runs up against the edge of the SVG, it\nwill be clipped. Be careful when using `text` so your descenders don’t get cut\noff (ouch!). You can see this happen in [Figure\n3-20](part0007_split_008.html#Even_More_SVG_text) when we set the baseline\n(`y`) to 50, the same as the height of our SVG:\n\n    \n    \n    <text x=\"250\" y=\"50\" font-family=\"serif\" font-size=\"25\"\n     fill=\"gray\">Easy-peasy</text>\n\n![More SVG text](../images/00023.gif)\n\nFigure 3-20. More SVG text\n\n`path` is for drawing anything more complex than the preceding shapes (like\ncountry outlines for geomaps), and will be explained separately. For now,\nwe’ll work with simple shapes.\n\n### Styling SVG Elements\n\nSVG’s default style is a black fill with no stroke. If you want anything else,\nyou’ll have to apply styles to your elements. Common SVG properties are as\nfollows:\n\n`fill`\n\n> A color value. Just as with CSS, colors can be specified as named colors,\n> hex values, or RGB or RGBA values.\n\n`stroke`\n\n> A color value.\n\n`stroke-width`\n\n> A numeric measurement (typically in pixels).\n\n`opacity`\n\n> A numeric value between 0.0 (completely transparent) and 1.0 (completely\n> opaque).\n\nWith `text`, you can also use these properties, which work just like in CSS:\n\n  * `font-family`\n  * `font-size`\n\nIn another parallel to CSS, there are two ways to apply styles to an SVG\nelement: either directly (inline) as an attribute of the element, or with a\nCSS style rule.\n\nHere are some style properties applied directly to a `circle` as attributes,\nwith the result shown in [Figure\n3-21](part0007_split_008.html#An_SVG_circle2):\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"22\"\n     fill=\"yellow\" stroke=\"orange\" stroke-width=\"5\"/>\n\n![An SVG circle](../images/00024.gif)\n\nFigure 3-21. An SVG circle\n\nAlternatively, we could strip the style attributes and assign the `circle` a\nclass (just as if it were a normal HTML element):\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"22\" class=\"pumpkin\"/>\n\nand then put the `fill`, `stroke`, and `stroke-width` rules into a CSS style\nthat targets the new class:\n\n    \n    \n    .pumpkin {\n        fill: yellow;\n        stroke: orange;\n        stroke-width: 5;\n     }\n\nThe CSS approach has a few obvious benefits:\n\n  * You can specify a style once and have it applied to multiple elements. \n  * CSS code is easier to read than inline attributes. \n  * For those reasons, the CSS approach might be more maintainable and make design changes faster to implement. \n\nUsing CSS to apply SVG styles, however, can be disconcerting for some. `fill`,\n`stroke`, and `stroke-width`, after all, are _not_ CSS properties. (The\nnearest CSS equivalents are `background-color` and `border`.) It’s just that\nwe are using CSS selectors to apply SVG-specific properties. If it helps you\nremember which rules in your stylesheet are SVG-specific, consider including\n`svg` in those selectors:\n\n    \n    \n    svg .pumpkin {\n        /* ... */\n     }\n\n### Layering and Drawing Order\n\nThere are no “layers” in SVG and no real concept of depth. SVG does not\nsupport CSS’s `z-index` property, so shapes can be arranged only within the\ntwo-dimensional x/y plane.\n\nAnd yet, if we draw multiple shapes, they overlap:\n\n    \n    \n    <rect x=\"0\" y=\"0\" width=\"30\" height=\"30\" fill=\"purple\"/>\n    <rect x=\"20\" y=\"5\" width=\"30\" height=\"30\" fill=\"blue\"/>\n    <rect x=\"40\" y=\"10\" width=\"30\" height=\"30\" fill=\"green\"/>\n    <rect x=\"60\" y=\"15\" width=\"30\" height=\"30\" fill=\"yellow\"/>\n    <rect x=\"80\" y=\"20\" width=\"30\" height=\"30\" fill=\"red\"/>\n\nThe order in which elements are coded determines their depth order. In [Figure\n3-22](part0007_split_008.html#Overlapping_SVG_elements), the purple square\nappears first in the code, so it is rendered first. Then, the blue square is\nrendered “on top” of the purple one, then the green square on top of that, and\nso on.\n\n![Overlapping SVG elements](../images/00025.gif)\n\nFigure 3-22. Overlapping SVG elements\n\nThink of SVG shapes as being rendered like paint on a canvas. The pixel-paint\nthat is applied later obscures any earlier paint, and thus appears to be “in\nfront.”\n\nThis aspect of drawing order becomes important when you have some visual\nelements that should not be obscured by others. For example, you might have\naxes or value labels that appear on a scatterplot. The axes and labels should\nbe added to the SVG last, so they appear in front of any other elements.\n\n### Transparency\n\nTransparency can be useful when elements in your visualization overlap but\nmust remain visible, or you want to deemphasize some elements while\nhighlighting others, as shown in [Figure\n3-23](part0007_split_008.html#RGBA_SVG_shapes).\n\nThere are two ways to apply transparency: use an RGB color with alpha, or set\nan `opacity` value.\n\nYou can use `rgba()` anywhere you specify a color, such as with `fill` or\n`stroke`. `rgba()` expects three values between 0 and 255 for red, green, and\nblue, plus an alpha (transparency) value between 0.0 and 1.0:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 1.0)\"/>\n    <circle cx=\"50\" cy=\"25\" r=\"20\" fill=\"rgba(0, 0, 255, 0.75)\"/>\n    <circle cx=\"75\" cy=\"25\" r=\"20\" fill=\"rgba(0, 255, 0, 0.5)\"/>\n    <circle cx=\"100\" cy=\"25\" r=\"20\" fill=\"rgba(255, 255, 0, 0.25)\"/>\n    <circle cx=\"125\" cy=\"25\" r=\"20\" fill=\"rgba(255, 0, 0, 0.1)\"/>\n\n![RGBA SVG shapes](../images/00026.jpeg)\n\nFigure 3-23. RGBA SVG shapes\n\nNote that with `rgba()`, transparency is applied to the `fill` and `stroke`\ncolors independently. The following circles’ `fill` is 75 percent opaque, and\ntheir `stroke`s are only 25 percent opaque:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\"/>\n    <circle cx=\"75\" cy=\"25\" r=\"20\" fill=\"rgba(0, 255, 0, 0.75)\"\n            stroke=\"rgba(0, 0, 255, 0.25)\" stroke-width=\"10\"/>\n    <circle cx=\"125\" cy=\"25\" r=\"20\" fill=\"rgba(255, 255, 0, 0.75)\"\n            stroke=\"rgba(255, 0, 0, 0.25)\" stroke-width=\"10\"/>\n\nWith this transparency applied, and the result shown in [Figure\n3-24](part0007_split_008.html#More_RGBA_SVG_shapes), we can see that strokes\nare aligned to the center of each shape’s edge. That is, the stroke is neither\nfully inside nor outside the object, but is both half in and half out. As a\nresult of this transparency, these individual `10px` strokes look more like\ntwo separate `5px` strokes.\n\n![More RGBA SVG shapes](../images/00027.jpeg)\n\nFigure 3-24. More RGBA SVG shapes\n\nTo apply transparency to an entire element, set an `opacity` attribute.\n[Figure 3-25](part0007_split_008.html#Opaque_circles) illustrates some\ncompletely opaque circles.\n\n![Opaque circles](../images/00028.gif)\n\nFigure 3-25. Opaque circles\n\n[Figure 3-26](part0007_split_008.html#Semiopaque_circles) shows the same\ncircles, with `opacity` values:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"purple\" stroke=\"green\" stroke-width=\"10\"\n            opacity=\"0.9\"/>\n    <circle cx=\"65\" cy=\"25\" r=\"20\" fill=\"green\" stroke=\"blue\" stroke-width=\"10\"\n            opacity=\"0.5\"/>\n    <circle cx=\"105\" cy=\"25\" r=\"20\" fill=\"yellow\" stroke=\"red\" stroke-width=\"10\"\n            opacity=\"0.1\"/>\n\n![Semiopaque circles](../images/00029.jpeg)\n\nFigure 3-26. Semiopaque circles\n\nYou can employ `opacity` on an element that also has colors set with `rgba()`.\nWhen doing so, the transparencies are multiplied. The circles in [Figure\n3-27](part0007_split_008.html#More_opaque_circles) use the same RGBA values\nfor `fill` and `stroke`. The first circle has no element `opacity` set, but\nthe other two do:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\"/>\n    <circle cx=\"65\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\" opacity=\"0.5\"/>\n    <circle cx=\"105\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\" opacity=\"0.2\"/>\n\n![More opaque circles](../images/00030.jpeg)\n\nFigure 3-27. More opaque circles\n\nNotice how the third circle’s `opacity` is `0.2`, or 20 percent. Yet its\npurple fill already has an alpha value of `0.75`, or 75 percent. The purple\narea, then, has a final transparency of 0.2 times 0.75 = 0.15, or 15 percent.\n\n\n## A Note on Compatibility\n\nOlder browsers don’t support SVG. So, generally speaking, Internet Explorer\nversion 8 and older will not display SVG images at all. This is a little\nannoying because people could visit your page only to see emptiness in place\nof a gorgeous visualization. On the other hand, D3 also does not work with\nolder browsers (again, meaning IE8 and older), so it never would have worked\nin the first place.\n\n* * *\n\n### Note\n\nD3 _can_ be made to work with IE8 by employing the\n[Aight](https://github.com/shawnbot/aight) compatibility library, but that\ndoesn’t help with older versions of IE.\n[r2d3](https://github.com/mhemesath/r2d3/) is an adaptation of D3 that\nintegrates [Raphaël](http://raphaeljs.com) for drawing visuals, which should\nget you as far back as IE7.\n\n* * *\n\nIn general, your best bet is to encourage people to upgrade and use a web\nbrowser that has been built in the last few years. The more people move to\nmodern browsers, the better their web experiences will be, and the larger our\npotential audiences.\n\nThat said, it’s polite to notify users of older browsers why the piece isn’t\nworking. I recommend using [Modernizr](http://modernizr.com) or a similar\nJavaScript tool to detect whether or not the browser supports SVG. If it does,\nthen you can load your D3 code and proceed as normal. If SVG is _not_\nsupported, then you can display a static, noninteractive version of your\nvisualization alongside a message explaining that a current browser is needed.\n(Be nice and provide links to the [Chrome](http://www.google.com/chrome) and\n[Firefox](http://www.mozilla.org/en-US/firefox/new/) download pages. I used to\nlink to [Safari](http://www.apple.com/safari/) as well, but Apple now\ndistributes it as part of the Mac OS, so it’s no longer available as a\nseparate download.)\n\nFor example, you can use `Modernizr.load()` to check the results of\nModernizr’s tests. Then, if the tests pass (for example, because SVG support\n_is_ detected), then tell Modernizr to go ahead and load D3 and your custom\nJavaScript code. I’d typically have something like this in the `<head>` of my\ndocument:\n\n    \n    \n    <script src=\"js/modernizr.js\"></script>\n    \n    <script type=\"text/javascript\">\n            Modernizr.load({\n                    test: Modernizr.svg && Modernizr.inlinesvg,\n                    yep : [ 'js/d3.v3.min.js',\n                            'js/script.js' ]\n            });\n    </script>\n\nThis loads Modernizr in, performs the tests, and then bothers loading the\nother code only if the tests succeed. (That’s the “`yep`” part.) You can use\nCSS or more JavaScript to define what shows up to the user when the test\n_fails_ , such as a static image of your visualization or a message\nencouraging the user to try a newer browser. Learn more about how to do this\nin the [Modernizr documentation](http://modernizr.com/docs/#load).\n\n_caniuse.com_ is a fantastic resource for supported browser features. See\ntheir list of [browsers with SVG support](http://caniuse.com/#search=svg).\n\nPeople have tried to get D3 working in older browsers, sometimes by mashing it\nup with Raphaël to render to canvas, or other hacky means. It is technically\npossible, but I don’t recommend it.\n\n\n## Chapter 4. Setup\n\nGetting set up with D3 is pretty straightforward — a simple matter of\ndownloading the latest version, creating an empty page in which to write your\ncode, and finally setting up a local web server.\n\n\n## Downloading D3\n\nStart by creating a new folder for your project. Call it whatever you like,\nbut maybe something like _project-folder_.\n\nWithin that folder, I recommend creating a subfolder called _d3_. Then\ndownload the latest version of D3 into that subfolder. [Download the latest\nversion of D3 as a ZIP file](http://d3js.org/d3.v3.zip), and then decompress\nthe ZIP file. As of this writing, the current version of D3 is 3.0.6.\n\nD3 is also provided in a “minified” version,\n[_d3.v3.min.js_](http://d3js.org/d3.v3.min.js), from which whitespace has been\nremoved for smaller file sizes and faster load times. The functionality is the\nsame, but typically you’d use the regular version while working on a project\n(for friendlier debugging), and then switch to the minified version once\nyou’ve launched the project publicly (for optimized load times). The choice is\nup to you, but in this book, I use the standard version.\n\nA third option is to download the entire D3 repository, which gives you not\njust the JavaScript files, but also all of the component source code. You can\n[browse the repository contents](https://github.com/mbostock/d3) first, or\njust [download the whole thing as a compressed ZIP\nfile](https://github.com/mbostock/d3/zipball/master). Of course, once you’ve\ndownloaded everything, make a copy of the file _d3.v3.js_ and move that into\n_project-folder/d3/_.\n\n\n## Referencing D3\n\nNow create a simple HTML page within your project folder named _index.html_.\nRemember, HTML documents are just plain text files, so you can use the text\neditor of your choice. Free editors like TextEdit and Notepad are fine, but\nyour life might be easier if you use an editor designed specifically for\nworking with code, like Coda, Espresso, or Sublime Text (among many, many\nothers).\n\nIf your editor gives you the option to set the file encoding, choose Unicode\n(UTF-8).\n\nYour folder structure should now look something like this:\n\n    \n    \n    project-folder/\n        d3/\n            d3.v3.js\n            d3.v3.min.js (optional)\n        index.html\n\nPaste the following into your new HTML file:\n\n    \n    \n    <!DOCTYPE html>\n    <html lang=\"en\">\n        <head>\n            <meta charset=\"utf-8\">\n            <title>D3 Page Template</title>\n            <script type=\"text/javascript\" src=\"d3/d3.v3.js\"></script>\n        </head>\n        <body>\n            <script type=\"text/javascript\">\n                // Your beautiful D3 code will go here\n            </script>\n        </body>\n    </html>\n\nOr, rather than go through all that manual labor, you could just download the\nsample code files (see [Chapter\n1](part0005_split_000.html#4OIQ2-8a8b0c18aaaf4f5c9d772f6d0c5087fc) for\ninstructions), and take a look at _01_empty_page_template.html_ , which\ncontains almost exactly the same code. (The `src` path to D3 is different in\nmy version.)\n\nHere are a few things to note about this template:\n\n  * The `meta` tag identifies the encoding for this file as `utf-8`, which is needed to ensure that the browser can parse D3’s functions and data properly. \n  * The first `script` tag sets the reference to _d3.v3.js_. You should edit this file path as needed if you’re using the minified version of D3 or decided to locate _d3.v3.js_ somewhere other than the _d3_ directory. \n  * The second `script` tag, in the `body`, is where you will soon key in all your beautiful code. And it will be beautiful. \n\nDone! Your D3 template files and folders are all set up. You might want to\nmake a copy of this template for each new project down the line.\n\n\n## Setting Up a Web Server\n\nIn some cases, you can view local HTML files directly in your web browser.\nHowever, some browsers have restrictions that prevent them from loading local\nfiles via JavaScript, for security reasons. That means if your D3 code is\ntrying to pull in any external datafiles (like CSVs or JSON), it will fail\nwith no good explanation. This isn’t D3’s fault; it’s a browser feature that\nprevents loading of scripts and other external files from third-party,\nuntrusted websites.\n\nFor this reason, it is much more reliable to load your page via a web server.\nAlthough you _could_ use a remote web server, it is much, much faster to store\nand host everything locally (meaning, on the same computer, the one right in\nfront of you). It is a strange idea, to use your local computer to host and\nserve files to itself, but you can think about it as the different programs\ntalking to each other: the browser program requests files from the server\nprogram, which responds by serving them back.\n\nThe good news is that it’s quite easy to get a local server up and running.\nHere are a couple of ways to do that.\n\n### Terminal with Python\n\nIf you’re using Mac OS X or Linux, then you already have Python installed. As\nlong as you’re comfortable entering commands in the terminal, then running a\nminiserver with Python is definitely the quickest option. (If you’re on\nWindows, you’ll need to install Python first.)\n\nTo use Python, you’ll need to open up a terminal window on your system. On a\nMac, open the Terminal application. You can find it in the Utilities folder,\nor by typing **`Terminal`** into Spotlight (the magnifying glass menu item in\nthe upper-right corner of your screen). Linux users are born knowing how to\nopen a terminal window, so I won’t waste your time explaining it here.\n\nTo run a Python web server:\n\n  1. Open up a new terminal window. \n  2. Via the command line, navigate into the directory that you want served. For example, if your project folder is in your Desktop folder on your Mac, you could type: **`cd ~/Desktop/project-folder`**. \n  3. Enter **`python -m SimpleHTTPServer 8888&`**. \n\n(This will work with Python version 2.x, but in Python versions 3.0 and newer,\n`SimpleHTTPServer` has been removed. For Python 3.x, just replace\n`SimpleHTTPServer` with `http.server` in the command.)\n\nThis will activate the server on port `8888`. Switch back to your web browser\nand visit the following URL: <http://localhost:8888/>. Yes, instead of\n_www.something.com_ , you just use _localhost_ , which tells the browser to\nrequest a page from _this machine_.\n\nYou should see the blank “D3 Page Template” page. Given that `body` of the\npage is empty, it won’t look like much. Select View source, and you should see\nthe contents of our HTML template page.\n\n### MAMP, WAMP, and LAMP\n\nThis option takes longer, but is best if you like dragging and dropping to\ninstall things, and want to avoid scary things like the terminal.\n\nAll of the AMPs in this section stand for Apache (the web server software),\nMySQL (popular database software), and PHP (a popular web scripting language).\nWe are really interested only in Apache, the web server, but it usually comes\nbundled with the other two, as they all work well together.\n\nOn a Mac, you can download and install [MAMP](http://mamp.info/en/) or [XAMPP\nfor Mac](http://bit.ly/W8RQa6).\n\nThe Windows equivalents are [WampServer](http://www.wampserver.com/en/) and\n[XAMPP for Windows](http://bit.ly/ZEGJq1).\n\nIf you use Linux, then all of this is probably already installed on your\nmachine, but you could still download [XAMPP for\nLinux](http://bit.ly/126txfk).\n\nInstallation for each of these packages varies somewhat, so follow the\ndocumentation carefully. (I’ve found MAMP to be the easiest to install.)\n\nEach package will designate one folder as the web server directory, so only\nthe files _within that folder_ will be served. You should find out what that\nfolder is, and move your D3 _project-folder_ into it.\n\nOnce the local server is up and running, you can view any pages within the\nserver directory by opening a browser (on the same computer, of course) and\npointing it to _localhost_ , as in the following: <http://localhost/>.\nDepending on your AMP configuration, you might need to append a port number to\nthe URL, as in the following: <http://localhost:8888/>.\n\nIf the server’s port number is `8888` and your project folder is called\n_project-folder_ , then you could view your D3 template page by going to\n<http://localhost:8888/project-folder/>.\n\n### Diving In\n\nAll set? Great! Let’s start working with data.\n\n\n## Chapter 5. Data\n\n_Data_ is an extremely broad term, only slightly less vague than the nearly\nall-encompassing _information_. What is data? (What _isn’t_ data?) What kinds\nof data are there, and what can we use with D3?\n\nBroadly speaking, data is structured information with potential for meaning.\n\nIn the context of programming for visualization, data is stored in a digital\nfile, typically in either text or binary form. Of course, potentially every\npiece of digital ephemera may be considered “data” — not just text, but bits\nand bytes representing images, audio, video, databases, streams, models,\narchives, and anything else.\n\nWithin the scope of D3 and browser-based visualization, however, we will limit\nourselves to _text-based data_. That is, anything that can be represented as\nnumbers and strings of alpha characters. If you can get your data into a\n_.txt_ plain text file, a _.csv_ comma-separated value file, or a _.json_ JSON\ndocument, then you can use it with D3.\n\nWhatever your data, it can’t be made useful and visual until it is _attached_\nto something. In D3 lingo, the data must be _bound_ to elements within the\npage. Let’s address how to create new page elements first. Then attaching data\nto those elements will be a cinch.\n\n\n## Generating Page Elements\n\nTypically, when using D3 to generate new DOM elements, the new elements will\nbe circles, rectangles, or other visual forms that represent your data. But to\navoid confusing matters, we’ll start with a simple example and create a lowly\n`p` paragraph element.\n\nBegin by creating a new document with our simple HTML template from the last\nchapter. You can find it in the sample code files as\n_01_empty_page_template.html_ , and it looks like the following code. (Eagle-\neyed viewers will notice that I’ve modified the `src` path here due to work\nwith the directory structure of the code samples. If that doesn’t mean\nanything to you, don’t worry about it.)\n\n    \n    \n    <!DOCTYPE html>\n    <html lang=\"en\">\n        <head>\n            <meta charset=\"utf-8\">\n            <title>D3 Page Template</title>\n            <script type=\"text/javascript\" src=\"../d3/d3.v3.js\"></script>\n        </head>\n        <body>\n            <script type=\"text/javascript\">\n                // Your beautiful D3 code will go here\n            </script>\n        </body>\n    </html>\n\nOpen that page in your web browser. Make sure you’re accessing the page via\nyour local web server, as we discussed in [Chapter\n4](part0008_split_000.html#setup-chapter4). So the URL in your browser’s\nlocation bar should look something like this:\n\n    \n    \n    http://localhost:8888/d3-book/chapter_05/01_empty_page_template.html\n\nIf not viewed through a web server, the URL path will start with _file:///_\ninstead of _http://_. Confirm that the URL does _not_ look like this:\n\n    \n    \n    file:///…/d3-book/chapter_05/01_empty_page_template.html\n\nOnce you’re viewing the page, pop open the web inspector. (As a reminder, see\n[Developer Tools](part0007_split_004.html#developer_tools_3) on how to do\nthat.) You should see an empty web page, with the DOM contents shown in\n[Figure 5-1](part0009_split_001.html#Web_inspector).\n\n![Web inspector](../images/00031.jpeg)\n\nFigure 5-1. Web inspector\n\nBack in your text editor, replace the comment between the `script` tags with:\n\n    \n    \n    d3.select(\"body\").append(\"p\").text(\"New paragraph!\");\n\nSave and refresh, and voilà! There is text in the formerly empty browser\nwindow, and the web inspector will look like [Figure\n5-2](part0009_split_001.html#Web_inspector_again).\n\n![Web inspector, again](../images/00032.jpeg)\n\nFigure 5-2. Web inspector, again\n\nSee the difference? Now in the DOM, there is a new paragraph element that was\ngenerated on the fly! This might not be exciting yet, but you will soon use a\nsimilar technique to dynamically generate tens or hundreds of elements, each\none corresponding to a piece of your dataset.\n\nLet’s walk through what just happened. (You can follow along with\n_02_new_element.html_.) To understand that first line of D3 code, you must\nfirst meet your new best friend, _chain syntax_.\n\n### Chaining Methods\n\nD3 smartly employs a technique called _chain syntax_ , which you might\nrecognize from jQuery. By “chaining” methods together with periods, you can\nperform several actions in a single line of code. It can be fast and easy, but\nit’s important to understand how it works, to save yourself hours of debugging\nheadaches later.\n\nBy the way, _functions_ and _methods_ are just two different words for the\nsame concept: a chunk of code that accepts an argument as input, performs some\naction, and returns some other information as output.\n\nThe following code:\n\n    \n    \n    d3.select(\"body\").append(\"p\").text(\"New paragraph!\");\n\nmight look like a big mess, especially if you’re new to programming. So the\nfirst thing to know is that JavaScript, like HTML, doesn’t care about\nwhitespace and line breaks, so you can put each method on its own line for\nlegibility:\n\n    \n    \n    d3.select(\"body\")\n        .append(\"p\")\n        .text(\"New paragraph!\");\n\nBoth I and your optometrist highly recommend putting each method on its own\nindented line. But programmers have their own coding style; use whatever\nindents, line breaks, and whitespace (tabs or spaces) are most legible for\nyou.\n\n### One Link at a Time\n\nLet’s deconstruct each line in this chain of code:\n\n`d3`\n\n> References the D3 object, so we can access its methods. Our D3 adventure\n> begins here.\n\n`.select(\"body\")`\n\n> Give the [`select()`](http://bit.ly/12h4SF1) method a CSS selector as input,\n> and it will return a reference to the first element in the DOM that matches.\n> (Use [`selectAll()`](http://bit.ly/WwINKs) when you need more than one\n> element.) In this case, we just want the `body` of the document, so a\n> reference to `body` is handed off to the next method in our chain.\n\n`.append(\"p\")`\n\n> [`append()`](https://github.com/mbostock/d3/wiki/Selections#wiki-append)\n> creates whatever new DOM element you specify and appends it to the end (but\n> _just inside_) of whatever selection it’s acting on. In our case, we want to\n> create a new `p` within the `body`. We specified `\"p\"` as the input\n> argument, but this method also sees the reference to `body` that was passed\n> down the chain from the `select()` method. So an empty `p` paragraph is\n> _appended_ to the `body`. Finally, `append()` hands off a reference to the\n> new element it just created.\n\n`.text(\"New paragraph!\")`\n\n> [`text()`](https://github.com/mbostock/d3/wiki/Selections#wiki-text) takes a\n> string and inserts it between the opening and closing tags of the current\n> selection. Because the previous method passed down a reference to our new\n> `p`, this code just inserts the new text between `<p>` and `</p>`. (In cases\n> where there is existing content, it will be overwritten.)\n\n`;`\n\n> The all-important semicolon indicates the end of this line of code. Chain\n> over.\n\n### The Hand-off\n\nMany, but not all, D3 methods return a selection (actually, a reference to a\nselection), which enables this handy technique of method chaining. Typically,\na method returns a reference to the element that it just acted on, but not\nalways.\n\nSo remember this: when chaining methods, order matters. The output type of one\nmethod has to match the input type expected by the next method in the chain.\nIf adjacent inputs and outputs are mismatched, the hand-off will function more\nlike a dropped baton in a middle-school relay race.\n\nWhen sussing out what each function expects and returns, [the API\nreference](https://github.com/mbostock/d3/wiki/API-Reference) is your friend.\nIt contains detailed information on each method, including whether or not it\nreturns a selection.\n\n### Going Chainless\n\nOur sample code could be rewritten without chain syntax:\n\n    \n    \n    var body = d3.select(\"body\");\n    var p = body.append(\"p\");\n    p.text(\"New paragraph!\");\n\nUgh! What a mess. Yet there will be times you need to break the chain, such as\nwhen you are calling so many functions that it doesn’t make sense to string\nthem all together. Or just because you want to organize your code in a way\nthat makes more sense to you.\n\nNow that you know how to generate new page elements with D3, it’s time to\nattach data to them.\n\n\n## Binding Data\n\nWhat is binding, and why would I want to do it to my data?\n\nData visualization is a process of _mapping_ data to visuals. Data in, visual\nproperties out. Maybe bigger numbers make taller bars, or special categories\ntrigger brighter colors. The mapping rules are up to you.\n\nWith D3, we _bind_ our data input values to elements in the DOM. Binding is\nlike “attaching” or associating data to specific elements, so that later you\ncan reference those values to apply mapping rules. Without the binding step,\nwe have a bunch of data-less, unmappable DOM elements. No one wants that.\n\n### In a Bind\n\nWe use D3’s\n[`selection.data()`](https://github.com/mbostock/d3/wiki/Selections#wiki-data)\nmethod to bind data to DOM elements. But there are two things we need in place\nfirst, before we can bind data:\n\n  * The data \n  * A selection of DOM elements \n\nLet’s tackle these one at a time.\n\n### Data\n\nD3 is smart about handling different kinds of data, so it will accept\npractically any array of numbers, strings, or objects (themselves containing\nother arrays or key/value pairs). It can handle JSON (and GeoJSON) gracefully,\nand even has a built-in method to help you load in CSV files.\n\nBut to keep things simple, for now we will start with a boring array of five\nnumbers. Here is our sample dataset:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nIf you’re feeling adventurous, or already have some data in CSV or JSON format\nthat you want to play with, here’s how to do that. Otherwise, just skip ahead\nto [Please Make Your\nSelection](part0009_split_002.html#please_make_your_selection_5).\n\n#### Loading CSV data\n\nCSV stands for comma-separated values. A CSV data file might look something\nlike this:\n\n    \n    \n    Food,Deliciousness\n    Apples,9\n    Green Beans,5\n    Egg Salad Sandwich,4\n    Cookies,10\n    Vegemite,0.2\n    Burrito,7\n\nEach line in the file has the same number of values (two, in this case), and\nvalues are separated by a comma. The first line in the file often serves as a\nheader, providing names for each of the “columns” of data.\n\nIf you have data in an Excel file, it probably follows a similar structure of\nrows and columns. To get that data into D3, open it in Excel, then choose Save\nas… and select CSV as the file type.\n\nIf we saved the preceding CSV data into a file called _food.csv_ , then we\ncould load the file into D3 by using the `d3.csv()` method:\n\n    \n    \n    d3.csv(\"food.csv\", function(data) {\n        console.log(data);\n    });\n\n`csv()` takes two arguments: a string representing the path of the CSV file to\nload in, and an anonymous function, to be used as a _callback function_. The\ncallback function is “called” only _after_ the CSV file has been loaded into\nmemory. So you can be sure that, by the time the callback is called,\n`d3.csv()` is done executing.\n\nWhen called, the anonymous function is handed the result of the CSV loading\nand parsing process; that is, the data. Here I’m naming it `data`, but this\ncould be called whatever you like. You should use this callback function to do\nall the things you can do only _after_ the data has been loaded. In the\npreceding example, we are just logging the value of the `data` array to the\nconsole, to verify it, as shown in [Figure\n5-3](part0009_split_002.html#Array_logged_to_console). (See\n_03_csv_loading_example.html_ in the example code.)\n\n![Array logged to console](../images/00033.jpeg)\n\nFigure 5-3. Array logged to console\n\nYou can see that `data` is an array (because of the hard brackets `[]` on\neither end) with six elements, each of which is an object. By toggling the\ndisclosure triangles next to each object, we can see their values (see [Figure\n5-4](part0009_split_002.html#Array_elements_expanded)).\n\n![Array elements expanded](../images/00034.jpeg)\n\nFigure 5-4. Array elements expanded\n\nAha! Each object has both a `Food` property and a `Deliciousness` property,\nthe values of which correspond to the values in our CSV! (There is also a\nthird property, `__proto__`, but that has to do with how JavaScript handles\nobjects, and you can ignore it for now.) D3 has employed the first row of the\nCSV for property names, and subsequent rows for values. You might not realize\nit, but this just saved you a _lot_ of time.\n\nOne more thing to note is that each value from the CSV is stored as a string,\neven the numbers. (You can tell because 9 is surrounded by quotation marks, as\nin `\"9\"` and not simply `9`.) This could cause unexpected behavior later, if\nyou try to reference your data as a numeric value but it is still typed as a\nstring.\n\n* * *\n\n### Handling Data Loading Errors\n\nNote that `d3.csv()` is an _asynchronous_ method, meaning that the rest of\nyour code is executed even while JavaScript is simultaneously waiting for the\nfile to finish downloading into the browser. (The same is true of D3’s other\nfunctions that load external resources, such as `d3.json()`.)\n\nThis can potentially be _very_ confusing, because you — as a reasonable human\nperson — might assume that the CSV file’s data is available, when in fact it\nhasn’t finished loading yet. A common mistake is to include references to the\nexternal data _outside of_ the callback function. Save yourself some headaches\nand make sure to reference your data only from _within_ the callback function\n(or from within other functions that you call within the callback function).\n\nPersonally, I like to declare a global variable first, then call `d3.csv()` to\nload the data. Within the callback function, I copy the data into my global\nvariable (so it’s available to all of my subsequent functions), and finally I\ncall any functions that rely on that data being present. For example:\n\n    \n    \n    var dataset;  //Global variable\n    \n    d3.csv(\"food.csv\", function(data) {\n        dataset = data;    //Once loaded, copy to dataset.\n        generateVis();     //Then call other functions that\n        hideLoadingMsg();  //depend on data being present.\n    });\n\nTo further confuse matters, the callback function is executed _whether or not\nthe datafile was loaded successfully_. That’s right, if the network connection\nfails, or the filename is misspelled, or for some reason an error occurs on\nthe web server end, the callback function will _still_ be executed. When the\ndata fails to load, and you call functions that rely on that data being\npresent, you will probably see an error in the console, and the visualization\nwon’t be created. This scenario might happen only rarely, but it’s useful to\nknow how to handle it.\n\nFortunately, you can include an optional `error` parameter in the callback\nfunction definition. If there is a problem loading the file, then `error` will\nbe set to the error message returned by the web server, and `data` will be\n`undefined`. If the file loads successfully and there is no error, then\n`error` will be `null`, and the `data` array will be populated as expected.\nNote that `error` must be the first parameter, and `data` the second:\n\n    \n    \n    var dataset;\n    \n    d3.csv(\"food.csv\", function(error, data) {\n    \n            if (error) {  //If error is not null, something went wrong.\n              console.log(error);  //Log the error.\n            } else {      //If no error, the file loaded correctly. Yay!\n              console.log(data);   //Log the data.\n    \n          //Include other code to execute after successful file load here\n          dataset = data;\n          generateVis();\n          hideLoadingMsg();\n            }\n    \n    });\n\n* * *\n\nVerifying your data is a great use of the `csv()` callback function, but\ntypically this is where you’d call other functions that construct the\nvisualization, now that the data is available, as in:\n\n    \n    \n    var dataset;  //Declare global var\n    \n    d3.csv(\"food.csv\", function(data) {\n    \n        //Hand CSV data off to global var,\n        //so it's accessible later.\n        dataset = data;\n    \n        //Call some other functions that\n        //generate your visualization, e.g.:\n        generateVisualization();\n        makeAwesomeCharts();\n        makeEvenAwesomerCharts();\n        thankAwardsCommittee();\n    \n    });\n\nOne more tip: if you have _tab_ -separated data in a TSV file, try the\n`d3.tsv()` method, which otherwise behaves exactly as the preceding method.\n\n#### Loading JSON data\n\nWe’ll spend more time talking about JSON later, but for now, all you need to\nknow is that the `d3.json()` method works the same way as `csv()`. Load your\nJSON data in this way:\n\n    \n    \n    d3.json(\"waterfallVelocities.json\", function(json) {\n        console.log(json);  //Log output to console\n    });\n\nHere, I’ve named the parsed output `json`, but it could be called `data` or\nwhatever you like.\n\n### Please Make Your Selection\n\nThe data is ready to go. As a reminder, we are working with this simple array:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nNow you need to decide what to select. That is, what elements will your data\nbe associated with? Again, let’s keep it super simple and say that we want to\nmake a new paragraph for each value in the dataset. So you might imagine\nsomething like this would be helpful:\n\n    \n    \n    d3.select(\"body\").selectAll(\"p\")\n\nand you’d be right, but there’s a catch: the paragraphs we want to select\n_don’t exist yet_. And this gets at one of the most common points of confusion\nwith D3: how can we select elements that don’t yet exist? Bear with me, as the\nanswer might require bending your mind a bit.\n\nThe answer lies with `enter()`, a truly magical method. See this code, which\nI’ll explain:\n\n    \n    \n    d3.select(\"body\").selectAll(\"p\")\n        .data(dataset)\n        .enter()\n        .append(\"p\")\n        .text(\"New paragraph!\");\n\nView the example code _04_creating_paragraphs.html_ and you should see five\nnew paragraphs, each with the same content, as shown in [Figure\n5-5](part0009_split_002.html#Dynamic_paragraphs).\n\n![Dynamic paragraphs](../images/00035.jpeg)\n\nFigure 5-5. Dynamic paragraphs\n\nHere’s what’s happening:\n\n`d3.select(\"body\")`\n\n> Finds the `body` in the DOM and hands off a reference to the next step in\n> the chain.\n\n`.selectAll(\"p\")`\n\n> Selects all paragraphs in the DOM. Because none exist yet, this returns an\n> empty selection. Think of this empty selection as representing the\n> paragraphs that _will soon exist_.\n\n`.data(dataset)`\n\n> Counts and parses our data values. There are five values in our array called\n> `dataset`, so everything past this point is executed five times, once for\n> each value.\n\n`.enter()`\n\n> To create new, data-bound elements, you must use `enter()`. This method\n> looks at the current DOM selection, and then at the data being handed to it.\n> If there are more data values than corresponding DOM elements, then\n> `enter()` _creates a new placeholder element_ on which you can work your\n> magic. It then hands off a reference to this new placeholder to the next\n> step in the chain.\n\n`.append(\"p\")`\n\n> Takes the empty placeholder selection created by `enter()` and appends a `p`\n> element into the DOM. Hooray! Then it hands off a reference to the element\n> it just created to the next step in the chain.\n\n`.text(\"New paragraph!\")`\n\n> Takes the reference to the newly created `p` and inserts a text value.\n\n### Bound and Determined\n\nAll right! Our data has been read, parsed, and bound to new `p` elements that\nwe created in the DOM. Don’t believe me? Take another look at\n_04_creating_paragraphs.html_ and whip out your web inspector, shown in\n[Figure 5-6](part0009_split_002.html#new_p_elements_in_the_inspector).\n\n![New p elements in the web inspector](../images/00036.jpeg)\n\nFigure 5-6. New `p` elements in the web inspector\n\nOkay, I see five paragraphs, but where’s the data? Switch to the JavaScript\nconsole, type in the following code, and click Enter. The results are shown in\n[Figure 5-7](part0009_split_002.html#logging_to_from_console):\n\n    \n    \n    console.log(d3.selectAll(\"p\"))\n\n![Logging to the console, from the console](../images/00037.jpeg)\n\nFigure 5-7. Logging to the console, from the console\n\nAn array! Or, really, an array containing another array. Click the gray\ndisclosure triangle to reveal its contents, shown in [Figure\n5-8](part0009_split_002.html#array_of_arrays).\n\n![Array of arrays, expanded](../images/00038.jpeg)\n\nFigure 5-8. Array of arrays, expanded\n\nYou’ll notice the five `p`s, numbered 0 through 4. Click the disclosure\ntriangle next to the first one (number zero), which results in the view shown\nin [Figure 5-9](part0009_split_002.html#the_p_element_expanded).\n\n![The p element, expanded](../images/00039.jpeg)\n\nFigure 5-9. The p element, expanded\n\nSee it? Do you see it? I can barely contain myself. There it is ([Figure\n5-10](part0009_split_002.html#finally_bound_data)).\n\n![Finally, bound data](../images/00040.jpeg)\n\nFigure 5-10. Finally, bound data\n\nOur first data value, the number `5`, is showing up under the first\nparagraph’s `__data__` attribute. Click into the other paragraph elements, and\nyou’ll see they also contain `__data__` values: 10, 15, 20, and 25, just as we\nspecified.\n\nYou see, when D3 binds data to an element, that data doesn’t exist in the DOM,\nbut it does exist in memory as a `__data__` attribute of that element. And the\nconsole is where you can go to confirm whether or not your data was bound as\nexpected.\n\nThe data is ready. Let’s do something with it.\n\n### Using Your Data\n\nWe can see that the data has been loaded into the page and is bound to our\nnewly created elements in the DOM, but can we _use_ it? Here’s our code so\nfar:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n    \n    d3.select(\"body\").selectAll(\"p\")\n        .data(dataset)\n        .enter()\n        .append(\"p\")\n        .text(\"New paragraph!\");\n\nLet’s change the last line to:\n\n    \n    \n        .text(function(d) { return d; });\n\nNow test out that new code in _05_creating_paragraphs_text.html_. You should\nsee the result shown in [Figure\n5-11](part0009_split_002.html#more_dynamic_paragraphs).\n\n![More dynamic paragraphs](../images/00041.jpeg)\n\nFigure 5-11. More dynamic paragraphs\n\nWhoa! We used our data to populate the contents of each paragraph, all thanks\nto the magic of the `data()` method. You see, when chaining methods together,\nanytime after you call `data()`, you can create an anonymous function that\naccepts `d` as input. The magical `data()` method ensures that `d` is set to\nthe corresponding value in your original dataset, given the current element at\nhand.\n\nThe value of “the current element” changes over time as D3 loops through each\nelement. For example, when looping through the third time, our code creates\nthe third `p` tag, and `d` will correspond to the third value in our dataset\n(or `dataset[2]`). So the third paragraph gets text content of “15”.\n\n### High-Functioning\n\nIn case you’re new to writing your own functions (a.k.a. methods), the basic\nstructure of a function definition is:\n\n    \n    \n    function(input_value) {\n        //Calculate something here\n        return output_value;\n    }\n\nThe function we used earlier is dead simple, nothing fancy:\n\n    \n    \n    function(d) {\n        return d;\n    }\n\nThis is called an _anonymous function_ , because it doesn’t have a name.\nContrast that with a function that’s stored in a variable, which is a _named\nfunction_ :\n\n    \n    \n    var doSomething = function() {\n        //Code to do something here\n    };\n\nWe’ll write lots of anonymous functions when using D3. They are the key to\naccessing individual data values and calculating dynamic properties.\n\nThis particular anonymous function is wrapped within D3’s `text()` function.\nSo our anonymous function is executed first. Then its result is handed off to\n`text()`. Then `text()` finally works its magic (by inserting its input\nargument as text within the selected DOM element):\n\n    \n    \n    .text(function(d) {\n        return d;\n    });\n\nBut we can (and will) get much fancier because you can customize these\nfunctions any way you like. Yes, this is both the pleasure and pain of writing\nyour own JavaScript. Maybe you’d like to add some extra text, as in:\n\n    \n    \n    .text(function(d) {\n        return \"I can count up to \" + d;\n    });\n\nwhich produces the result shown in [Figure\n5-12](part0009_split_002.html#Still_more_dynamic_paragraphs), as seen in\nexample file _06_creating_paragraphs_counting.html_.\n\n![Still more dynamic paragraphs](../images/00042.jpeg)\n\nFigure 5-12. Still more dynamic paragraphs\n\n### Data Wants to Be Held\n\nYou might be wondering why you have to write out `function(d) { … }` instead\nof just `d` on its own. For example, this won’t work:\n\n    \n    \n    .text(\"I can count up to \" + d);\n\nIn this context, without wrapping `d` in an anonymous function, `d` has no\nvalue. Think of `d` as a lonely little placeholder value that just needs a\nwarm, containing hug from a kind, caring function’s parentheses. (Extending\nthis metaphor further, yes, it is creepy that the hug is being given by an\n_anonymous_ function, but that only confuses matters.)\n\nHere is `d` being held gently and appropriately by a function:\n\n    \n    \n    .text(function(d) {  // <-- Note tender embrace at left\n        return \"I can count up to \" + d;\n    });\n\nThe reason for this syntax is that `.text()`, `attr()`, and many other D3\nmethods can take a _function_ as an argument. For example, `text()` can take\neither simply a static string of text as an argument:\n\n    \n    \n    .text(\"someString\")\n\n_or_ the result of a function:\n\n    \n    \n    .text(someFunction())  // Presumably, someFunction() would return a string\n\n _or_ an anonymous function itself can be the argument, such as when you\nwrite:\n\n    \n    \n    .text(function(d) {\n        return d;\n    })\n\nHere, you are defining an anonymous function. If D3 sees a function there, it\nwill _call_ that function, while handing off the current datum `d` as the\nfunction’s argument. Here, I’ve named the argument `d` just by convention. You\ncould call it `datum` or `info` or whatever you like. All D3 is looking for is\n_any_ argument name, into which it can pass the current datum. Throughout this\nbook, we’ll use `d` because it is concise and familiar from many of the other\nD3 examples found online.\n\nIn any case, without that function in place, D3 couldn’t relay the current\ndata value. Without an anonymous function and its argument there to receive\nthe value of `d`, D3 could get confused and even start crying. (D3 is more\nemotional than you’d expect.)\n\nAt first, this might seem silly and like a lot of extra work to just get at\n`d`, but the value of this approach will become clear as we work on more\ncomplex pieces.\n\n### Beyond Text\n\nThings get a lot more interesting when we explore D3’s other methods, like\n`attr()` and `style()`, which allow us to set HTML attributes and CSS\nproperties on selections, respectively.\n\nFor example, adding one more line to our code:\n\n    \n    \n    .style(\"color\", \"red\");\n\nproduces the result shown in [Figure\n5-13](part0009_split_002.html#Red_paragraphs), as seen in\n_07_creating_paragraphs_with_style.html_.\n\n![Red paragraphs](../images/00043.gif)\n\nFigure 5-13. Red paragraphs\n\nAll the text is now red; big deal. But we could use a custom function to make\nthe text red only if the current datum exceeds a certain threshold. So we\nrevise that last line to use a function instead of a string:\n\n    \n    \n    .style(\"color\", function(d) {\n        if (d > 15) {   //Threshold of 15\n            return \"red\";\n        } else {\n            return \"black\";\n        }\n    });\n\nSee the resulting change, displayed in [Figure\n5-14](part0009_split_002.html#Dynamically_styled_paragraphs), in\n_08_creating_paragraphs_with_style_functions.html_.\n\n![Dynamically styled paragraphs](../images/00044.jpeg)\n\nFigure 5-14. Dynamically styled paragraphs\n\nNotice how the first three lines are black, but once `d` exceeds the arbitrary\nthreshold of 15, the text turns red.\n\nOkay, we’ve got data loaded in, and dynamically created DOM elements bound to\nthat data. I’d say we’re ready to start drawing with data!\n\n\n## Chapter 6. Drawing with Data\n\nIt’s time to start drawing with data.\n\nLet’s continue working with our simple dataset for now:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\n\n## Drawing divs\n\nWe’ll use this to generate a super-simple bar chart. Bar charts are\nessentially just rectangles, and an HTML `div` is the easiest way to draw a\nrectangle. (Then again, to a web browser, _everything_ is a rectangle, so you\ncould easily adapt this example to use `span`s or whatever element you\nprefer.)\n\nFormally, a chart with vertically oriented rectangles is a _column_ chart, and\none with horizontal rectangles is a _bar_ chart. In practice, most people just\ncall them all bar charts, as I’ll do from now on.\n\nThis `div` could work well as a data bar, shown in [Figure\n6-1](part0010_split_001.html#A_humble_div).\n\n![A humble div](../images/00045.jpeg)\n\nFigure 6-1. A humble div\n\n    \n    \n    <div style=\"display: inline-block;\n                width: 20px;\n                height: 75px;\n                background-color: teal;\"></div>\n\nAmong web standards folks, this is a semantic no-no. Normally, one shouldn’t\nuse an empty `div` for purely visual effect, but I am making an exception for\nthe sake of this example.\n\nBecause this is a `div`, its `width` and `height` are set with CSS styles.\nExcept for `height`, each bar in our chart will share the same display\nproperties, so I’ll put those shared styles into a class called `bar`, as an\nembedded style up in the `head` of the document:\n\n    \n    \n    div.bar {\n        display: inline-block;\n        width: 20px;\n        height: 75px;   /* We'll override height later */\n        background-color: teal;\n    }\n\nNow each `div` needs to be assigned the `bar` class, so our new CSS rule will\napply. If you were writing the HTML code by hand, you would write the\nfollowing:\n\n    \n    \n    <div class=\"bar\"></div>\n\nUsing D3, to add a class to an element, we use the `selection.attr()` method.\nIt’s important to understand the difference between `attr()` and its close\ncousin, `style()`. `attr()` sets DOM attribute values, whereas `style()`\napplies CSS styles directly to an element.\n\n### Setting Attributes\n\n[`attr()`](https://github.com/mbostock/d3/wiki/Selections#wiki-attr) is used\nto set an HTML attribute and its value on an element. An HTML attribute is any\nproperty/value pair that you could include between an element’s `<>` brackets.\nFor example, these HTML elements:\n\n    \n    \n    <p class=\"caption\">\n    <select id=\"country\">\n    <img src=\"logo.png\" width=\"100px\" alt=\"Logo\" />\n\ncontain a total of five attributes (and corresponding values), all of which\ncould be set with `attr()`:\n\nAttribute |  Value  \n---|---  \n`class`| `caption`  \n`id`| `country`  \n`src`| `logo.png`  \n`width`| `100px`  \n`alt`| `Logo`  \n  \nTo assign a class of `bar`, we can use:\n\n    \n    \n    .attr(\"class\", \"bar\")\n\n### A Note on Classes\n\nNote that an element’s _class_ is stored as an HTML attribute. The class, in\nturn, is used to reference a CSS style rule. This could cause some confusion\nbecause there is a difference between setting a _class_ (from which styles are\ninferred) and applying a _style_ directly to an element. You can do both with\nD3. Although you should use whatever approach makes the most sense to you, I\nrecommend using _classes_ for properties that are shared by multiple elements,\nand applying _style_ rules directly only when deviating from the norm. (In\nfact, that’s what we’ll do in just a moment.)\n\nI also want to briefly mention another D3 method, `classed()`, which can be\nused to quickly apply or remove classes from elements. The preceding line of\ncode could be rewritten as the following:\n\n    \n    \n    .classed(\"bar\", true)\n\nThis line simply takes whatever selection is passed to it and applies the\nclass `bar`. If `false` were specified, it would do the opposite, removing the\nclass of `bar` from any elements in the selection:\n\n    \n    \n    .classed(\"bar\", false)\n\n### Back to the Bars\n\nPutting it all together with our dataset, here is the complete D3 code so far:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n    \n    d3.select(\"body\").selectAll(\"div\")\n        .data(dataset)\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", \"bar\");\n\nTo see what’s going on, look at _01_drawing_divs.html_ in your browser, view\nthe source, and open your web inspector. You should see five vertical `div`\nbars, one generated for each point in our dataset. However, with no space\nbetween them, they look like one big rectangle, as seen in Figures\n[6-2](part0010_split_001.html#Five_divs_masquerading_as_one) and\n[6-3](part0010_split_001.html#Five_divs_masquerading_as_one_inspector).\n\n![Five divs masquerading as one](../images/00046.jpeg)\n\nFigure 6-2. Five `div`s masquerading as one\n\n![Five divs masquerading as one, as seen through the web\ninspector](../images/00047.jpeg)\n\nFigure 6-3. Five `div`s masquerading as one, as seen through the web inspector\n\n### Setting Styles\n\nThe [`style()`](https://github.com/mbostock/d3/wiki/Selections#wiki-style)\nmethod is used to apply a CSS property and value directly to an HTML element.\nThis is the equivalent of including CSS rules within a `style` attribute right\nin your HTML, as in:\n\n    \n    \n    <div style=\"height: 75px;\"></div>\n\nTo make a bar chart, the height of each bar must be a function of its\ncorresponding data value. So let’s add this to the end of our D3 code (taking\ncare to keep the final semicolon at the very end of the chain):\n\n    \n    \n    .style(\"height\", function(d) {\n        return d + \"px\";\n    });\n\nSee that code in _02_drawing_divs_height.html_. You should see a very small\nbar chart, like the one in [Figure\n6-4](part0010_split_001.html#A_small_bar_chart).\n\n![A small bar chart](../images/00048.jpeg)\n\nFigure 6-4. A small bar chart\n\nWhen D3 loops through each data point, the value of `d` will be set to that of\nthe corresponding value. So we are setting a `height` value of `d` (the\ncurrent data value) while appending the text `px` (to specify the units are\npixels). The resulting heights are `5px`, `10px`, `15px`, `20px`, and `25px`.\n\nThis looks a little bit silly, so let’s make those bars taller:\n\n    \n    \n    .style(\"height\", function(d) {\n        var barHeight = d * 5;  //Scale up by factor of 5\n        return barHeight + \"px\";\n    });\n\nAdd some space to the right of each bar (in the embedded CSS style, in the\ndocument `head`), to space things out:\n\n    \n    \n    margin-right: 2px;\n\nNice! We could go to [SIGGRAPH](https://www.siggraph.org) with that chart\n([Figure 6-5](part0010_split_001.html#A_taller_bar_chart)).\n\n![A taller bar chart](../images/00049.jpeg)\n\nFigure 6-5. A taller bar chart\n\nTry out the sample code _03_drawing_divs_spaced.html_. Again, view the source\nand use the web inspector to contrast the original HTML against the final DOM.\n\n\n## The Power of data()\n\nThis is exciting, but real-world data is never this clean:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nLet’s make our data a bit messier, as in _04_power_of_data.html_ :\n\n    \n    \n    var dataset = [ 25, 7, 5, 26, 11 ];\n\nThat change in data results in the bars shown in [Figure\n6-6](part0010_split_002.html#New_data_values). We’re not limited to five data\npoints, of course. Let’s add many more! (See\n_05_power_of_data_more_points.html_.)\n\n    \n    \n    var dataset = [ 25, 7, 5, 26, 11, 8, 25, 14, 23, 19,\n                    14, 11, 22, 29, 11, 13, 12, 17, 18, 10,\n                    24, 18, 25, 9, 3 ];\n\n![New data values](../images/00050.jpeg)\n\nFigure 6-6. New data values\n\nTwenty-five data points instead of five (see [Figure\n6-7](part0010_split_002.html#Lots_more_data_values))!\n\n![Lots more data values](../images/00051.gif)\n\nFigure 6-7. Lots more data values\n\nHow does D3 automatically expand our chart as needed?\n\n    \n    \n    d3.select(\"body\").selectAll(\"div\")\n        .data(dataset)  // <-- The answer is here!\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", \"bar\")\n        .style(\"height\", function(d) {\n            var barHeight = d * 5;\n            return barHeight + \"px\";\n        });\n\nGive `data()` 10 values, and it will loop through 10 times. Give it one\nmillion values, and it will loop through one million times. (Just be patient.)\n\nThat is the power of `data()` — being smart enough to loop through the full\nlength of whatever dataset you throw at it, executing each method beneath it\nin the chain, while updating the context in which each method operates, so `d`\nalways refers to the current datum at that point in the loop.\n\nThat might be a mouthful, and if it all doesn’t make sense yet, it will soon.\nI encourage you to make a copy of _05_power_of_data_more_points.html_ , tweak\nthe `dataset` values, and note how the bar chart changes.\n\nRemember, the _data_ is driving the visualization — not the other way around.\n\n### Random Data\n\nSometimes it’s fun to generate random data values, whether for testing\npurposes or just pure geekiness. That’s just what I’ve done in\n_06_power_of_data_random.html_. Notice that each time you reload the page, the\nbars render differently, as shown in [Figure\n6-8](part0010_split_002.html#Bar_charts_with_random_values).\n\n![Bar charts with random values](../images/00052.jpeg)\n\nFigure 6-8. Bar charts with random values\n\nView the source, and you’ll see this code:\n\n    \n    \n    var dataset = [];                         //Initialize empty array\n    for (var i = 0; i < 25; i++) {            //Loop 25 times\n        var newNumber = Math.random() * 30;   //New random number (0-30)\n        dataset.push(newNumber);              //Add new number to array\n    }\n\nThat code doesn’t use any D3 methods; it’s just JavaScript. Without going into\ntoo much detail, this code does the following:\n\n  1. Creates an empty array called `dataset`. \n  2. Initiates a `for` loop, which is executed 25 times. \n  3. Each time, it generates a new random number with a value between 0 and 30. (Well, technically, _almost_ 30\\. `Math.random()` returns values as low as 0.0 all the way up to, but not including, 1.0. So if `Math.random()` returned 0.99999, then the result would be 0.99999 times 30, which is 29.9997, or the teensiest bit less than 30.) \n  4. That new number is appended to the `dataset` array. (`push()` is an array method that appends a new value to the end of an array.) \n\nJust for kicks, open up the JavaScript console and enter\n`console.log(dataset)`. You should see the full array of 25 randomized data\nvalues, as shown in [Figure\n6-9](part0010_split_002.html#Random_values_in_console).\n\n![Random values in console](../images/00053.jpeg)\n\nFigure 6-9. Random values in console\n\nNotice that they are all decimal or floating point values (such as\n14.793717765714973), not whole numbers or integers (such as 14) like we used\ninitially. For this example, decimal values are fine, but if you ever need\nwhole numbers, you could use JavaScript’s `Math.round()` or `Math.floor()`\nmethods. `Math.round()` rounds any number to the nearest integer, whereas\n`Math.floor()` always rounds down, for greater control over the result. For\nexample, you could wrap the random number generator from this line:\n\n    \n    \n        var newNumber = Math.random() * 30;\n\nas follows:\n\n    \n    \n        var newNumber = Math.floor(Math.random() * 30);\n\nUsing this code, `newNumber` would always be either 0 or 29, or any integer in\nbetween. Why not 30? Because `Math.random()` always returns values _less than_\n1.0, and `Math.floor()` will always _round down_ , so 29 is the highest\npossible return value.\n\nTry it out in _07_power_of_data_rounded.html_ , and use the console to verify\nthat the numbers have indeed been rounded to integers, as displayed in [Figure\n6-10](part0010_split_002.html#Random_integer_values_in_console).\n\n![Random integer values in console](../images/00054.jpeg)\n\nFigure 6-10. Random integer values in console\n\nThat’s about all we can do visually with `div`s. Let’s expand our visual\npossibilities with SVG.\n\n\n## Drawing SVGs\n\nFor a quick refresher on SVG syntax, see [SVG](part0007_split_008.html#SVG_3).\n\nOne thing you might notice about SVG elements is that all of their properties\nare specified as _attributes_. That is, they are included as property/value\npairs within each element tag, like this:\n\n    \n    \n    <element property=\"value\"></element>\n\nHmm, that looks strangely like HTML!\n\n    \n    \n    <p class=\"eureka\">Eureka!</p>\n\nWe have already used D3’s handy `append()` and `attr()` methods to create new\nHTML elements and set their attributes. Because SVG elements exist in the DOM,\njust as HTML elements do, we can use `append()` and `attr()` in exactly the\nsame way to generate SVG images.\n\n### Create the SVG\n\nFirst, we need to create the SVG element in which to place all our shapes:\n\n    \n    \n    d3.select(\"body\").append(\"svg\");\n\nThat will find the document’s `body` and append a new `svg` element just\nbefore the closing `</body>` tag. That code will work, but I’d like to suggest\na slight modification:\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\");\n\nRemember how most D3 methods return a reference to the DOM element on which\nthey act? By creating a new variable `svg`, we are able to capture the\nreference handed back by `append()`. Think of `svg` not as a variable but as a\nreference pointing to the SVG object that we just created. This reference will\nsave us a lot of code later. Instead of having to search for that SVG each\ntime — as in `d3.select(\"svg\")` — we just say `svg`:\n\n    \n    \n    svg.attr(\"width\", 500)\n       .attr(\"height\", 50);\n\nAlternatively, that could all be written as one line of code:\n\n    \n    \n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", 500)\n                .attr(\"height\", 50);\n\nSee _08_drawing_svgs.html_ for that code. Inspect the DOM and notice that\nthere is, indeed, an empty SVG element.\n\nTo simplify your life, I recommend putting the width and height values into\nvariables at the top of your code, as in _09_drawing_svgs_size.html_. View the\nsource, and you’ll see the following code:\n\n    \n    \n    //Width and height\n    var w = 500;\n    var h = 50;\n\nI’ll be doing that with all future examples. By _variabalizing_ the size\nvalues, they can be easily referenced throughout your code, as in the\nfollowing:\n\n    \n    \n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)   // <-- Here\n                .attr(\"height\", h); // <-- and here!\n\nAlso, if you send me a petition to make “variabalize” a real word, I will\ngladly sign it.\n\n### Data-Driven Shapes\n\nTime to add some shapes. I’ll bring back our trusty old dataset:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nand then use `data()` to iterate through each data point, creating a `circle`\nfor each one:\n\n    \n    \n    svg.selectAll(\"circle\")\n        .data(dataset)\n        .enter()\n        .append(\"circle\");\n\nRemember, `selectAll()` will return empty references to all `circle`s (which\ndon’t exist yet), `data()` binds our data to the elements we’re about to\ncreate, `enter()` returns a placeholder reference to the new element, and\n`append()` finally adds a `circle` to the DOM. In this case, it appends those\n`circle`s to the end of the SVG element, as our initial selection is our\nreference `svg` (as opposed to the document `body`, for example).\n\nTo make it easy to reference all of the `circle`s later, we can create a new\nvariable to store references to them all:\n\n    \n    \n    var circles = svg.selectAll(\"circle\")\n                     .data(dataset)\n                     .enter()\n                     .append(\"circle\");\n\nGreat, but all these circles still need positions and sizes, displayed in\n[Figure 6-11](part0010_split_003.html#Row_of_data_circles). Be warned, the\nfollowing code might blow your mind:\n\n    \n    \n    circles.attr(\"cx\", function(d, i) {\n                return (i * 50) + 25;\n            })\n           .attr(\"cy\", h/2)\n           .attr(\"r\", function(d) {\n                return d;\n           });\n\n![Row of data circles](../images/00055.jpeg)\n\nFigure 6-11. Row of data circles\n\nFeast your eyes on the demo _10_drawing_svgs_circles.html_. Let’s step through\nthe code, one line at a time:\n\n    \n    \n    circles.attr(\"cx\", function(d, i) {\n                return (i * 50) + 25;\n            })\n\nThis takes the reference to all `circle`s and sets the `cx` attribute for each\none. (Remember that, in SVG lingo, `cx` is the x position value of the\n_center_ of the circle.) Our data has already been bound to the `circle`\nelements, so for each `circle`, the value `d` matches the corresponding value\nin our original dataset (5, 10, 15, 20, or 25).\n\nAnother value, `i`, is also automatically populated for us. (Thanks, D3!) Just\nas with `d`, the name `i` here is arbitrary and could be set to whatever you\nlike, such as `counter` or `elementID`. I prefer to use `i` because it is\nconcise, it alludes to the convention of using `i` in `for` loops, and it is\nvery common, as you’ll see it in all the online examples.\n\nSo, `i` is a numeric index value of the current element. Counting starts at\nzero, so for our “first” circle `i == 0`, the second circle’s `i == 1`, and so\non. We’re using `i` to push each subsequent circle over to the right, because\neach subsequent loop through, the value of `i` increases by one:\n\n    \n    \n    (0 * 50) + 25   //Returns 25\n    (1 * 50) + 25   //Returns 75\n    (2 * 50) + 25   //Returns 125\n    (3 * 50) + 25   //Returns 175\n    (4 * 50) + 25   //Returns 225\n\nTo make sure `i` is available to your custom function, you must include it as\nan argument in the function definition, `function(d, i)`. You must also\ninclude `d`, even if you don’t use `d` within your function (as in the\npreceding case). This is because, again, the actual names used for these\narguments are not important, but the total number of arguments (one or two)\nis.\n\nAlso, in case you’re feeling a surge of parameter anxiety, don’t worry. You’ll\nonly ever have to worry about `d` and `i`. There are no additional anonymous\nfunction parameters to learn about later.\n\nOn to the next line:\n\n    \n    \n    .attr(\"cy\", h/2)\n\n`cy` is the y position value of the center of each circle. We’re setting `cy`\nto `h` divided by two, or one-half of `h`. You’ll recall that `h` stores the\nheight of the entire SVG, so `h/2` has the effect of aligning all `circle`s in\nthe vertical center of the image:\n\n    \n    \n    .attr(\"r\", function(d) {\n        return d;\n    });\n\nFinally, the radius `r` of each `circle` is simply set to `d`, the\ncorresponding data value.\n\n### Pretty Colors, Oooh!\n\nColor fills and strokes are just other attributes that you can set using the\nsame methods. Simply by appending this code:\n\n    \n    \n    .attr(\"fill\", \"yellow\")\n    .attr(\"stroke\", \"orange\")\n    .attr(\"stroke-width\", function(d) {\n        return d/2;\n    });\n\nwe get the colorful circles shown in [Figure\n6-12](part0010_split_003.html#Colorful_data_circles), as seen in\n_11_drawing_svgs_color.html_.\n\n![Colorful data circles](../images/00056.jpeg)\n\nFigure 6-12. Colorful data circles\n\nOf course, you can mix and match attributes and custom functions to apply any\ncombination of properties. The trick with data visualization, of course, is\nchoosing appropriate _mappings_ , so the visual expression of your data is\nunderstandable and useful for the viewer.\n\n\n## Making a Bar Chart\n\nNow we’ll integrate everything we’ve learned so far to generate a simple bar\nchart as an SVG image.\n\nWe’ll start by adapting the `div` bar chart code to draw its bars with SVG\ninstead, giving us more flexibility over the visual presentation. Then we’ll\nadd labels, so we can see the data values clearly.\n\n### The Old Chart\n\nSee the `div` chart, updated with some new data, in\n_12_making_a_bar_chart_divs.html_ :\n\n    \n    \n    var dataset = [ 5, 10, 13, 19, 21, 25, 22, 18, 15, 13,\n                    11, 12, 15, 20, 18, 17, 16, 18, 23, 25 ];\n    \n    d3.select(\"body\").selectAll(\"div\")\n        .data(dataset)\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", \"bar\")\n        .style(\"height\", function(d) {\n            var barHeight = d * 5;\n            return barHeight + \"px\";\n        });\n\nIt might be hard to imagine, but we can definitely improve on the simple bar\nchart in [Figure 6-13](part0010_split_004.html#Bar_chart_with_divs) made of\n`div`s.\n\n![Bar chart with divs](../images/00057.gif)\n\nFigure 6-13. Bar chart with `div`s\n\n### The New Chart\n\nFirst, we need to decide on the size of the new SVG:\n\n    \n    \n    //Width and height\n    var w = 500;\n    var h = 100;\n\nOf course, you could name `w` and `h` something else, like `svgWidth` and\n`svgHeight`. Use whatever is most clear to you. JavaScript programmers, as a\ngroup, are fixated on efficiency, so you’ll often see single-character\nvariable names, code written with no spaces, and other hard-to-read, yet\nprogrammatically efficient, syntax.\n\nThen, we tell D3 to create an empty SVG element and add it to the DOM:\n\n    \n    \n    //Create SVG element\n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)\n                .attr(\"height\", h);\n\nTo recap, this inserts a new `<svg>` element just before the closing `</body>`\ntag, and assigns the SVG a width and height of 500 by 100 pixels. This\nstatement also puts the result into our new variable called `svg`, so we can\neasily reference the new SVG without having to reselect it later using\nsomething like `d3.select(\"svg\")`.\n\nNext, instead of creating `div`s, we generate `rect`s and add them to `svg`:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       .attr(\"x\", 0)\n       .attr(\"y\", 0)\n       .attr(\"width\", 20)\n       .attr(\"height\", 100);\n\nThis code selects all `rect`s inside of `svg`. Of course, there aren’t any\nyet, so an empty selection is returned. (Weird, yes, but stay with me. With\nD3, you always have to first select whatever it is you’re about to act on,\neven if that selection is momentarily empty.)\n\nThen, `data(dataset)` sees that we have 20 values in the dataset, and those\nvalues are handed off to `enter()` for processing. `enter()`, in turn, returns\na placeholder selection for each data point that does not yet have a\ncorresponding `rect` — which is to say, all of them.\n\nFor each of the 20 placeholders, `append(\"rect\")` inserts a `rect` into the\nDOM. As we learned in [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), every\n`rect` must have `x`, `y`, `width`, and `height` values. We use `attr()` to\nadd those attributes onto each newly created `rect`.\n\nBeautiful, no? Okay, maybe not. All of the bars are there (check the DOM of\n_13_making_a_bar_chart_rects.html_ with your web inspector), but they all\nshare the same `x`, `y`, `width`, and `height` values, with the result that\nthey all overlap (see [Figure 6-14](part0010_split_004.html#One_lonely_bar)).\nThis isn’t a visualization of data yet.\n\n![One lonely bar](../images/00058.jpeg)\n\nFigure 6-14. One lonely bar\n\nLet’s fix the overlap issue first. Instead of an `x` of `0`, we’ll assign a\ndynamic value that corresponds to `i`, or each value’s position in the\ndataset. So the first bar will be at `0`, but subsequent bars will be at `21`,\nthen `42`, and so on. (In a later chapter, we’ll learn about D3’s _scales_ ,\nwhich offer a better, more flexible way to accomplish this same feat.)\n\n    \n    \n    .attr(\"x\", function(d, i) {\n        return i * 21;  //Bar width of 20 plus 1 for padding\n    })\n\nSee that code in action with _14_making_a_bar_chart_offset.html_ and the\nresult in [Figure 6-15](part0010_split_004.html#Twenty_bars).\n\n![Twenty bars](../images/00059.gif)\n\nFigure 6-15. Twenty bars\n\nThat works, but it’s not particularly flexible. If our dataset were longer,\nthen the bars would just run off to the right, past the end of the SVG!\nBecause each bar is 20 pixels wide, plus 1 pixel of padding, a 500-pixel wide\nSVG can only accommodate 23 data points. Note how the 24th bar gets clipped in\n[Figure 6-16](part0010_split_004.html#Twentyfour_bars).\n\n![Twenty-four bars](../images/00060.gif)\n\nFigure 6-16. Twenty-four bars\n\nIt’s good practice to use flexible, dynamic coordinates — heights, widths, x\nvalues, and y values — so your visualization can scale appropriately along\nwith your data.\n\nAs with anything else in programming, there are a thousand ways to achieve\nthat end. I’ll use a simple one. First, I’ll amend the line where we set each\nbar’s `x` position:\n\n    \n    \n    .attr(\"x\", function(d, i) {\n        return i * (w / dataset.length);\n    })\n\nNotice how the `x` value is now tied directly to the width of the SVG (`w`)\nand the number of values in the dataset (`dataset.length`). This is exciting\nbecause now our bars will be evenly spaced, whether we have 20 data values, as\nin [Figure 6-17](part0010_split_004.html#Twenty_evenly_spaced_bars).\n\n![Twenty evenly spaced bars](../images/00061.gif)\n\nFigure 6-17. Twenty evenly spaced bars\n\nOr only five, as in [Figure\n6-18](part0010_split_004.html#Five_evenly_spaced_bars).\n\n![Five evenly spaced bars](../images/00062.jpeg)\n\nFigure 6-18. Five evenly spaced bars\n\nSee that code so far in _15_making_a_bar_chart_even.html_.\n\nNow we should set the bar _widths_ to be proportional, too, so they get\nnarrower as more data is added, or wider when there are fewer values. I’ll add\na new variable near where we set the SVG’s width and height:\n\n    \n    \n    //Width and height\n    var w = 500;\n    var h = 100;\n    var barPadding = 1;  // <-- New!\n\nand then reference that variable in the line where we set each bar’s `width`.\nInstead of a static value of `20`, the width will now be set as a fraction of\nthe SVG width and number of data points, minus a padding value:\n\n    \n    \n    .attr(\"width\", w / dataset.length - barPadding)\n\nIt works! (See [Figure\n6-19](part0010_split_004.html#Twenty_evenly_spaced_bars_with_dynamic_widths)\nand _16_making_a_bar_chart_widths.html_.)\n\n![Twenty evenly spaced bars with dynamic widths](../images/00063.gif)\n\nFigure 6-19. Twenty evenly spaced bars with dynamic widths\n\nThe bar widths and x positions scale correctly whether there are 20 points,\nonly 5 (see [Figure\n6-20](part0010_split_004.html#Five_evenly_spaced_bars_with_dynamic_widths)),\nor even 100 (see [Figure\n6-21](part0010_split_004.html#One_hundred_evenly_spaced_bars_with_dynamic_widths)).\n\n![Five evenly spaced bars with dynamic widths](../images/00064.jpeg)\n\nFigure 6-20. Five evenly spaced bars with dynamic widths\n\n![One hundred evenly spaced bars with dynamic widths](../images/00065.gif)\n\nFigure 6-21. One hundred evenly spaced bars with dynamic widths\n\nFinally, we encode our data as the _height_ of each bar. You would hope it\nwere as easy as referencing the `d` data value when setting each bar’s\n`height`:\n\n    \n    \n    .attr(\"height\", function(d) {\n        return d;\n    });\n\nHmm, the chart in [Figure 6-22](part0010_split_004.html#Dynamic_heights) looks\nfunky. Maybe we can just scale up our numbers a bit?\n\n    \n    \n    .attr(\"height\", function(d) {\n        return d * 4;  // <-- Times four!\n    });\n\n![Dynamic heights](../images/00066.jpeg)\n\nFigure 6-22. Dynamic heights\n\nAlas, it is not that easy! We want our bars to grow upward from the bottom\nedge, not down from the top, as in [Figure\n6-23](part0010_split_004.html#Dynamic_heights_magnified) — but don’t blame D3,\nblame SVG.\n\n![Dynamic heights, magnified](../images/00067.gif)\n\nFigure 6-23. Dynamic heights, magnified\n\nYou’ll recall that, when drawing SVG `rect`s, the `x` and `y` values specify\nthe coordinates of the _upper-left corner_. That is, the origin or reference\npoint for every `rect` is its top-left. For our purposes, it would be soooooo\nmuch easier to set the origin point as the bottom-left corner, but that’s just\nnot how SVG does it, and frankly, SVG is pretty indifferent about our feelings\non the matter.\n\nGiven that our bars do have to “grow down from the top,” then where is “the\ntop” of each bar in relationship to the top of the SVG? Well, the top of each\nbar could be expressed as a relationship between the height of the SVG and the\ncorresponding data value, as in:\n\n    \n    \n    .attr(\"y\", function(d) {\n        return h - d;  //Height minus data value\n    })\n\nThen, to put the “bottom” of the bar on the bottom of the SVG (see [Figure\n6-24](part0010_split_004.html#Growing_down_from_above)), each `rect`’s height\ncan be just the data value itself:\n\n    \n    \n    .attr(\"height\", function(d) {\n        return d;  //Just the data value\n    });\n\n![Growing down from above](../images/00068.jpeg)\n\nFigure 6-24. Growing down from above\n\nLet’s scale things up a bit by changing `d` to `d * 4`, with the result shown\nin [Figure 6-25](part0010_split_004.html#Growing_bigger_from_above). (Just as\nwith the bar placements, this can be done more properly using D3 scales, but\nwe’re not there yet.)\n\n![Growing bigger from above](../images/00069.gif)\n\nFigure 6-25. Growing bigger from above\n\nThe working code for our growing-down-from-above, SVG bar chart is in\n_17_making_a_bar_chart_heights.html_.\n\n### Color\n\nAdding color is easy. Just use `attr()` to set a `fill`:\n\n    \n    \n    .attr(\"fill\", \"teal\");\n\nFind the all-teal bar chart shown in [Figure\n6-26](part0010_split_004.html#Teal_bars) in _18_making_a_bar_chart_teal.html_.\n\n![Teal bars](../images/00070.gif)\n\nFigure 6-26. Teal bars\n\nTeal is nice, but you’ll often want a shape’s color to reflect some quality of\nthe data. That is, you might want to _encode_ the data values as color. (In\nthe case of our bar chart, that makes a _dual encoding_ , in which the same\ndata value is encoded in two different visual properties: both height and\ncolor.)\n\nUsing data to drive color is as easy as writing a custom function that again\nreferences `d`. Here, we replace `\"teal\"` with a custom function, resulting in\nthe chart in [Figure 6-27](part0010_split_004.html#Datadriven_blue_bars):\n\n    \n    \n    .attr(\"fill\", function(d) {\n        return \"rgb(0, 0, \" + (d * 10) + \")\";\n    });\n\n![Data-driven blue bars](../images/00071.gif)\n\nFigure 6-27. Data-driven blue bars\n\nSee the code in _19_making_a_bar_chart_blues.html_. This is not a particularly\nuseful visual encoding, but you can get the idea of how to translate data into\ncolor. Here, `d` is multiplied by 10, and then used as the blue value in an\n`rgb()` color definition. So the greater values of `d` (taller bars) will be\nmore blue. Smaller values of `d` (shorter bars) will be less blue (closer to\nblack). The red and green components of the color are fixed at zero.\n\n* * *\n\n### Multivalue Maps\n\nYou might have noticed we now have a total of _five_ different calls to\n`attr()` in the chain, one each to specify the bars’ `x`, `y`, `width`,\n`height`, and `fill` values.\n\nIf you get tired of typing `attr()` over and over again, you might appreciate\nD3’s support for [_multivalue maps_](http://bl.ocks.org/3305515), with which\nyou can set multiple attribute values using a single `attr()` statement. For\nexample, to move a circle to the top-left corner of the SVG and make it red, I\ncould use separate `attr()` statements:\n\n    \n    \n    svg.select(\"circle\")\n       .attr(\"cx\", 0)\n       .attr(\"cy\", 0)\n       .attr(\"fill\", \"red\");\n\nor I could define all three of these attributes and their values within a\nsingle object, which is then relayed to a single `attr()` statement:\n\n    \n    \n    svg.select(\"circle\")\n       .attr({\n            cx: 0,\n            cy: 0,\n            fill: red\n       });\n\nThe resulting code is more concise, and if you’ve used jQuery, this syntax of\ntucking property/value pairs into objects might already be familiar. The\n_value_ portion of each pair can include anonymous functions, referencing `d`\nand `i` to generate dynamic values, per usual. We could rewrite our bar-\ncreation code thus far using multivalue maps as:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       .attr({\n            x: function(d, i) { return i * (w / dataset.length); },\n            y: function(d) { return h - (d * 4); },\n            width: w / dataset.length - barPadding,\n            height: function(d) { return d * 4; },\n            fill: function(d) { return \"rgb(0, 0, \" + (d * 10) + \")\"; }\n       });\n\nIf you like this sort of thing, you’ll be happy to know it also works with\n`style()` and [a few other methods](http://bl.ocks.org/3305515). Throughout\nthis book, I’ve used the more verbose structure of individual attribute\nstatements, but it’s always good to know you have options.\n\n* * *\n\n### Labels\n\nVisuals are great, but sometimes you need to show the actual data values as\ntext within the visualization. Here’s where value labels come in, and they are\nvery, very easy to generate with D3.\n\nYou’ll recall from the SVG primer that you can add `text` elements to an SVG\nelement. Let’s start with:\n\n    \n    \n    svg.selectAll(\"text\")\n       .data(dataset)\n       .enter()\n       .append(\"text\")\n\nLook familiar? Just as we did for the `rect`s, here we do for the `text`s.\nFirst, select what you want, bring in the data, enter the new elements (which\nare just placeholders at this point), and finally append the new `text`\nelements to the DOM.\n\nWe’ll extend that code to include a data value within each `text` element by\nusing the `text()` method:\n\n    \n    \n       .text(function(d) {\n            return d;\n       })\n\nand then extend it further, by including `x` and `y` values to position the\ntext. It’s easiest if I just copy and paste the same x/y code we previously\nused for the bars:\n\n    \n    \n       .attr(\"x\", function(d, i) {\n            return i * (w / dataset.length);\n       })\n       .attr(\"y\", function(d) {\n            return h - (d * 4);\n       });\n\nAha! Value labels! But some are getting cut off at the top (see [Figure\n6-28](part0010_split_004.html#Baby_value_labels)).\n\n![Baby value labels!](../images/00072.jpeg)\n\nFigure 6-28. Baby value labels!\n\nLet’s try moving them down, inside the bars, by adding a small amount to the\n`x` and `y` calculations:\n\n    \n    \n       .attr(\"x\", function(d, i) {\n            return i * (w / dataset.length) + 5;  // +5\n       })\n       .attr(\"y\", function(d) {\n            return h - (d * 4) + 15;              // +15\n       });\n\nThe chart in [Figure 6-29](part0010_split_004.html#Inbar_value_labels) is\nbetter, but not legible.\n\n![In-bar value labels](../images/00073.gif)\n\nFigure 6-29. In-bar value labels\n\nFortunately, we can fix that:\n\n    \n    \n       .attr(\"font-family\", \"sans-serif\")\n       .attr(\"font-size\", \"11px\")\n       .attr(\"fill\", \"white\");\n\nFantasti-code! See _20_making_a_bar_chart_labels.html_ for the brilliant\nvisualization shown in [Figure\n6-30](part0010_split_004.html#Really_nice_value_labels).\n\n![Really nice value labels](../images/00074.jpeg)\n\nFigure 6-30. Really nice value labels\n\nIf you are not typographically obsessive, then you’re all done. If, however,\nyou are like me, you’ll notice that the value labels aren’t perfectly aligned\nwithin their bars. (For example, note the “5” in the first column.) That’s\neasy enough to fix. Let’s use the SVG `text-anchor` attribute to center the\ntext horizontally at the assigned `x` value:\n\n    \n    \n        .attr(\"text-anchor\", \"middle\")\n\nThen, let’s change the way we calculate the `x` position by setting it to the\nleft edge of each bar _plus_ half the bar width:\n\n    \n    \n        .attr(\"x\", function(d, i) {\n            return i * (w / dataset.length) + (w / dataset.length - barPadding) / 2;\n        })\n\nAnd I’ll also bring the labels up one pixel for perfect spacing, as you can\nsee in [Figure 6-31](part0010_split_004.html#Centered_labels) and\n_21_making_a_bar_chart_aligned.html_ :\n\n    \n    \n        .attr(\"y\", function(d) {\n            return h - (d * 4) + 14;  //15 is now 14\n        })\n\n![Centered labels](../images/00075.jpeg)\n\nFigure 6-31. Centered labels\n\n\n## Making a Scatterplot\n\nSo far, we’ve drawn only bar charts with simple data — just one-dimensional\nsets of numbers.\n\nBut when you have two sets of values to plot against each other, you need a\nsecond dimension. The scatterplot is a common type of visualization that\nrepresents two sets of corresponding values on two different axes: horizontal\nand vertical, x and y.\n\n### The Data\n\nAs you saw in [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), you have a\nlot of flexibility around how to structure a dataset. For our scatterplot, I’m\ngoing to use an array of arrays. The primary array will contain one element\nfor each data “point.” Each of those “point” elements will be another array,\nwith just two values: one for the x value, and one for y:\n\n    \n    \n    var dataset = [\n                    [5, 20], [480, 90], [250, 50], [100, 33], [330, 95],\n                    [410, 12], [475, 44], [25, 67], [85, 21], [220, 88]\n                  ];\n\nRemember, `[]` means array, so nested hard brackets `[[]]` indicate an array\nwithin another array. We separate array elements with commas, so an array\ncontaining three other arrays would look like this: `[[],[],[]]`.\n\nWe could rewrite our dataset with more whitespace so it’s easier to read:\n\n    \n    \n    var dataset = [\n                      [ 5,     20 ],\n                      [ 480,   90 ],\n                      [ 250,   50 ],\n                      [ 100,   33 ],\n                      [ 330,   95 ],\n                      [ 410,   12 ],\n                      [ 475,   44 ],\n                      [ 25,    67 ],\n                      [ 85,    21 ],\n                      [ 220,   88 ]\n                  ];\n\nNow you can see that each of these 10 rows will correspond to one point in our\nvisualization. With the row `[5, 20]`, for example, we’ll use `5` as the x\nvalue, and `20` for the y.\n\n### The Scatterplot\n\nLet’s carry over most of the code from our bar chart experiments, including\nthe piece that creates the SVG element:\n\n    \n    \n    //Create SVG element\n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)\n                .attr(\"height\", h);\n\nInstead of creating `rect`s, however, we’ll make a `circle` for each data\npoint:\n\n    \n    \n    svg.selectAll(\"circle\")  // <-- No longer \"rect\"\n       .data(dataset)\n       .enter()\n       .append(\"circle\")     // <-- No longer \"rect\"\n\nAlso, instead of specifying the `rect` attributes of `x`, `y`, `width`, and\n`height`, our `circle`s need `cx`, `cy`, and `r`:\n\n    \n    \n       .attr(\"cx\", function(d) {\n            return d[0];\n       })\n       .attr(\"cy\", function(d) {\n            return d[1];\n       })\n       .attr(\"r\", 5);\n\nSee the working scatterplot code that recreates the result shown in [Figure\n6-32](part0010_split_005.html#Simple_scatterplot) in _22_scatterplot.html_.\n\n![Simple scatterplot](../images/00076.jpeg)\n\nFigure 6-32. Simple scatterplot\n\nNotice how we access the data values and use them for the `cx` and `cy`\nvalues. When using `function(d)`, D3 automatically hands off the current data\nvalue as `d` to your function. In this case, the current data value is one of\nthe smaller, subarrays in our larger `dataset` array.\n\nWhen each single datum `d` is itself an array of values (and not just a single\nvalue, like `3.14159`), you need to use bracket notation to access its values.\nHence, instead of `return d`, we use `return d[0]` and `return d[1]`, which\nreturn the first and second values of the array, respectively.\n\nFor example, in the case of our first data point `[5, 20]`, the first value\n(array position `0`) is `5`, and the second value (array position `1`) is\n`20`. Thus:\n\n    \n    \n    d[0] returns 5\n    d[1] returns 20\n\nBy the way, if you ever want to access any value in the larger dataset\n(outside of D3, say), you can do so using bracket notation. For example:\n\n    \n    \n    dataset[5] returns [410, 12]\n\nYou can even use multiple sets of brackets to access values within nested\narrays:\n\n    \n    \n    dataset[5][1] returns 12\n\nDon’t believe me? Take another look at the scatterplot page\n_22_scatterplot.html_ , open your JavaScript console, type in **`dataset[5]`**\nor **`dataset[5][1]`** , and see what happens.\n\n### Size\n\nMaybe you want the circles to be different sizes, so each circle’s area\ncorresponds to its y value. As a general rule, when visualizing quantitative\nvalues with circles, make sure to encode the values as _area_ , not as a\ncircle’s _radius_. Perceptually, we understand the overall amount of “ink” or\npixels to reflect the data value. A common mistake is to map the value to the\nradius. (I’ve done this many times myself.) Mapping to the radius is easier to\ndo, as it requires less math, but the result will visually distort your data.\n\nYet when creating SVG circles, we can’t specify an `area` value; we have to\ncalculate the radius `r` and then set that. So, starting with a data value as\narea, how do we get to a radius value?\n\nYou might remember that the area of a circle equals π times the radius\nsquared, or A = πr2.\n\nLet’s say the area, then, is our data value, which is `d[1]`, in this case.\nActually, let’s subtract that value from `h`, so the circles at the top are\nlarger. So our _area_ value is `h - d[1]`. (We’ll cover a cleaner way to\nachieve this effect using scales in [Chapter\n7](part0011_split_000.html#AFM62-8a8b0c18aaaf4f5c9d772f6d0c5087fc).)\n\nTo convert this area to a radius value, we simply have to take its square\nroot. We can do that using JavaScript’s built-in `Math.sqrt()` function, as in\n`Math.sqrt(h - d[1])`.\n\nNow, instead of setting all `r` values to the static value of `5`, try:\n\n    \n    \n    .attr(\"r\", function(d) {\n        return Math.sqrt(h - d[1]);\n    });\n\nSee _23_scatterplot_sqrt.html_ for the code that results in the scatterplot\nshown in [Figure\n6-33](part0010_split_005.html#Scatterplot_with_sized_circles).\n\n![Scatterplot with sized circles](../images/00077.jpeg)\n\nFigure 6-33. Scatterplot with sized circles\n\nAfter arbitrarily subtracting the datum’s y value `d[1]` from the SVG height\n`h`, and then taking the square root, we see that circles with greater y\nvalues (those circles lower down) have smaller areas (and shorter radii).\n\nThis particular use of circle area as a visualization tool isn’t necessarily\nuseful. I simply want to illustrate how you can use `d`, along with bracket\nnotation, to reference an individual datum, apply some transformation to that\nvalue, and use the newly calculated value to _return_ a value back to the\nattribute-setting method (a value used for `r`, in this case).\n\n### Labels\n\nLet’s label our data points with `text` elements. I’ll adapt the label code\nfrom our bar chart experiments, starting with the following:\n\n    \n    \n    svg.selectAll(\"text\")  // <-- Note \"text\", not \"circle\" or \"rect\"\n       .data(dataset)\n       .enter()\n       .append(\"text\")     // <-- Same here!\n\nThis looks for all `text` elements in the SVG (there aren’t any yet), and then\nappends a new `text` element for each data point. Then we use the `text()`\nmethod to specify each element’s contents:\n\n    \n    \n       .text(function(d) {\n            return d[0] + \",\" + d[1];\n       })\n\nThis looks messy, but bear with me. Once again, we’re using `function(d)` to\naccess each data point. Then, within the function, we’re using _both_ `d[0]`\n_and_ `d[1]` to get both values within that data point array.\n\nThe plus `+` symbols, when used with strings, such as the comma between\nquotation marks `\",\"`, act as _append_ operators. So what this one line of\ncode is really saying is this: get the values of `d[0]` and `d[1]` and smush\nthem together with a comma in the middle. The end result should be something\nlike `5,20` or `25,67`.\n\nNext, we specify _where_ the text should be placed with `x` and `y` values.\nFor now, let’s just use `d[0]` and `d[1]`, the same values that we used to\nspecify the `circle` positions:\n\n    \n    \n       .attr(\"x\", function(d) {\n            return d[0];\n       })\n       .attr(\"y\", function(d) {\n            return d[1];\n       })\n\nFinally, add a bit of font styling with:\n\n    \n    \n       .attr(\"font-family\", \"sans-serif\")\n       .attr(\"font-size\", \"11px\")\n       .attr(\"fill\", \"red\");\n\nThe result in [Figure 6-34](part0010_split_005.html#Scatterplot_with_labels)\nmight not be pretty, but we got it working! See _24_scatterplot_labels.html_\nfor the latest.\n\n![Scatterplot with labels](../images/00078.jpeg)\n\nFigure 6-34. Scatterplot with labels\n\n\n## Next Steps\n\nHopefully, some core concepts of D3 are becoming clear: loading data,\ngenerating new elements, and using data values to derive attribute values for\nthose elements.\n\nYet the image in [Figure\n6-34](part0010_split_005.html#Scatterplot_with_labels) is barely passable as a\ndata visualization. The scatterplot is hard to read, and the code doesn’t use\nour data flexibly. To be honest, we haven’t yet improved on — gag — Excel’s\n_Chart Wizard!_\n\nNot to worry: D3 is way cooler than Chart Wizard (not to mention Clippy), but\ngenerating a shiny, interactive chart involves taking our D3 skills to the\nnext level. To use data flexibly, we’ll learn about D3’s _scales_ in the next\nchapter. And to make our scatterplot easier to read, we’ll learn about _axis\ngenerators_ and axis labels.\n\nThis would be a good time to take a break and stretch your legs. Maybe go for\na walk, or grab a coffee or a sandwich. I’ll hang out here (if you don’t\nmind), and when you get back, we’ll jump into D3 scales!\n\n\n## Chapter 7. Scales\n\n“Scales are functions that map from an input domain to an output range.”\n\nThat’s [Mike Bostock’s definition of D3\nscales](https://github.com/mbostock/d3/wiki/Quantitative-Scales), and there is\nno clearer way to say it.\n\nThe values in any dataset are unlikely to correspond exactly to pixel\nmeasurements for use in your visualization. Scales provide a convenient way to\nmap those data values to new values useful for visualization purposes.\n\nD3 scales are _functions_ with parameters that you define. Once they are\ncreated, you call the `scale` function, pass it a data value, and it nicely\nreturns a scaled output value. You can define and use as many scales as you\nlike.\n\nIt might be tempting to think of a scale as something that appears visually in\nthe final image — like a set of tick marks, indicating a progression of\nvalues. _Do not be fooled!_ Those tick marks are part of an _axis_ , which is\na _visual representation_ of a scale. A scale is a mathematical relationship,\nwith no direct visual output. I encourage you to think of scales and axes as\ntwo different, yet related, elements.\n\nThis chapter addresses only\n[_linear_](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-\nlinear) scales, because they are most common and easiest understood. Once you\nunderstand linear scales, the others — ordinal, logarithmic, square root, and\nso on — will be a piece of cake.\n\n\n## Apples and Pixels\n\nImagine that the following dataset represents the number of apples sold at a\nroadside fruit stand each month:\n\n    \n    \n    var dataset = [ 100, 200, 300, 400, 500 ];\n\nFirst of all, this is great news, as the stand is selling 100 additional\napples each month! Business is booming. To showcase this success, you want to\nmake a bar chart illustrating the steep upward climb of apple sales, with each\ndata value corresponding to the height of one bar.\n\nUntil now, we’ve used data values directly as display values, ignoring unit\ndifferences. So if 500 apples were sold, the corresponding bar would be 500\npixels tall.\n\nThat could work, but what about next month, when 600 apples are sold? And a\nyear later, when 1,800 apples are sold? Your audience would have to purchase\never-larger displays just to be able to see the full height of those very tall\napple bars! (Mmm, apple bars!)\n\nThis is where scales come in. Because apples are not pixels (which are also\nnot oranges), we need scales to translate between them.\n\n\n## Domains and Ranges\n\nA scale’s _input domain_ is the range of possible input data values. Given the\npreceding apples data, appropriate input domains would be either 100 and 500\n(the minimum and maximum values of the dataset) or 0 and 500.\n\nA scale’s _output range_ is the range of possible output values, commonly used\nas display values in pixel units. The output range is completely up to you, as\nthe information designer. If you decide the shortest apple bar will be 10\npixels tall, and the tallest will be 350 pixels tall, then you could set an\noutput range of 10 and 350.\n\nFor example, create a scale with an input domain of `[100,500]` and an output\nrange of `[10,350]`. If you handed the low input value of `100` to that scale,\nit would return its lowest range value, `10`. If you gave it `500`, it would\nspit back `350`. If you gave it `300`, it would hand `180` back to you on a\nsilver platter. (`300` is in the center of the domain, and `180` is in the\ncenter of the range.)\n\nWe can visualize the domain and range as corresponding axes, side-by-side,\ndisplayed in [Figure 7-1](part0011_split_002.html#input_output_axes).\n\n![An input domain and an output range, visualized as parallel\naxes](../images/00079.jpeg)\n\nFigure 7-1. An input domain and an output range, visualized as parallel axes\n\nOne more thing: to prevent your brain from mixing up the _input domain_ and\n_output range_ terminology, I’d like to propose a little exercise. When I say\n“input,” you say “domain.” Then I say “output,” and you say “range.” Ready?\nOkay:\n\n> Input! Domain!\n\n> Output! Range!\n\n> Input! Domain!\n\n> Output! Range!\n\nGot it? Great.\n\n\n## Normalization\n\nIf you’re familiar with the concept of _normalization_ , it might be helpful\nto know that, with a linear scale, that’s all that is really going on here.\n\nNormalization is the process of mapping a numeric value to a new value between\n0 and 1, based on the possible minimum and maximum values. For example, with\n365 days in the year, day number 310 maps to about 0.85, or 85 percent of the\nway through the year.\n\nWith linear scales, we are just letting D3 handle the math of the\nnormalization process. The input value is normalized according to the domain,\nand then the normalized value is scaled to the output range.\n\n\n## Creating a Scale\n\nD3’s scale function generators are accessed with `d3.scale` followed by the\ntype of scale you want. I recommend opening up the sample code page\n_01_scale_test.html_ and typing each of the following into the console:\n\n    \n    \n    var scale = d3.scale.linear();\n\nCongratulations! Now `scale` is a function to which you can pass input values.\n(Don’t be misled by the `var`. Remember that in JavaScript, variables can\nstore functions.)\n\n    \n    \n    scale(2.5);  //Returns 2.5\n\nBecause we haven’t set a domain and a range yet, this function will map input\nto output on a 1:1 scale. That is, whatever we input will be returned\nunchanged.\n\nWe can set the scale’s input domain to `100,500` by passing those values to\nthe `domain()` method as an array. Note the hard brackets indicating an array:\n\n    \n    \n    scale.domain([100, 500]);\n\nSet the output range in similar fashion, with `range()`:\n\n    \n    \n    scale.range([10, 350]);\n\nThese steps can be done separately, as just shown, or chained together into\none line of code:\n\n    \n    \n    var scale = d3.scale.linear()\n                        .domain([100, 500])\n                        .range([10, 350]);\n\nEither way, our scale is ready to use!\n\n    \n    \n    scale(100);  //Returns 10\n    scale(300);  //Returns 180\n    scale(500);  //Returns 350\n\nTypically, you will call scale functions from within an `attr()` method or\nsimilar, not on their own. Let’s modify our scatterplot visualization to use\ndynamic scales.\n\n\n## Scaling the Scatterplot\n\nTo revisit our dataset from the scatterplot:\n\n    \n    \n    var dataset = [\n                    [5, 20], [480, 90], [250, 50], [100, 33], [330, 95],\n                    [410, 12], [475, 44], [25, 67], [85, 21], [220, 88]\n                  ];\n\nYou’ll recall that this `dataset` is an array of arrays. We mapped the first\nvalue in each array onto the x-axis, and the second value onto the y-axis.\nLet’s start with the x-axis.\n\nJust by eyeballing the x values, it looks like they range from 5 to 480, so a\nreasonable input domain to specify might be `0,500`, right?\n\nWhy are you giving me that look? Oh, because you want to keep your code\nflexible and scalable, so it will continue to work even if the data changes in\nthe future. Very smart! Remember, if we were building a data dashboard for the\nroadside apple stand, we’d want our code to accommodate the enormous projected\ngrowth in apple sales. Our chart should work just as well with 5 apples sold\nas 5 million.\n\n### d3.min() and d3.max()\n\nInstead of specifying fixed values for the domain, we can use the convenient\narray functions `d3.min()` and `d3.max()` to analyze our data set on the fly.\nFor example, this loops through each of the x values in our arrays and returns\nthe value of the greatest one:\n\n    \n    \n    d3.max(dataset, function(d) {\n        return d[0];  //References first value in each subarray\n    });\n\nThat code will return the value 480, because 480 is the largest x value in our\ndataset. Let me explain how it works.\n\nBoth `min()` and `max()` work the same way, and they can take either one or\ntwo arguments. The first argument must be a reference to the array of values\nyou want evaluated, which is `dataset`, in this case. If you have a simple,\none-dimensional array of numeric values, like `[7, 8, 4, 5, 2]`, then it’s\nobvious how to compare the values against each other, and no second argument\nis needed. For example:\n\n    \n    \n    var simpleDataset = [7, 8, 4, 5, 2];\n    d3.max(simpleDataset);  // Returns 8\n\nThe `max()` function simply loops through each value in the array, and\nidentifies the largest one.\n\nBut our `dataset` is not just an array of numbers; it is an array of arrays.\nCalling `d3.max(dataset)` might produce unexpected results:\n\n    \n    \n    var dataset = [\n                    [5, 20], [480, 90], [250, 50], [100, 33], [330, 95],\n                    [410, 12], [475, 44], [25, 67], [85, 21], [220, 88]\n                  ];\n    d3.max(dataset);  // Returns [85, 21].  What???\n\nTo tell `max()` which _specific_ values we want compared, we must include a\nsecond argument, an _accessor function_ :\n\n    \n    \n    d3.max(dataset, function(d) {\n        return d[0];\n    });\n\nThe accessor function is an anonymous function to which `max()` hands off each\nvalue in the data array, one at a time, as `d`. The accessor function\nspecifies _how to access_ the value to be used for the comparison. In this\ncase, our data array is `dataset`, and we want to compare only the x values,\nwhich are the first values in each subarray, meaning in position `[0]`. So our\naccessor function looks like this:\n\n    \n    \n    function(d) {\n        return d[0];  //Return the first value in each subarray\n    }\n\nNote that this looks suspiciously similar to the syntax we used when\ngenerating our scatterplot circles, which also used anonymous functions to\nretrieve and return values:\n\n    \n    \n    .attr(\"cx\", function(d) {\n        return d[0];\n    })\n    .attr(\"cy\", function(d) {\n        return d[1];\n    })\n\nThis is a common D3 pattern. Soon you will be very comfortable with all manner\nof anonymous functions crawling all over your code.\n\n### Setting Up Dynamic Scales\n\nPutting together what we’ve covered, let’s create the scale function for our\nx-axis:\n\n    \n    \n    var xScale = d3.scale.linear()\n                         .domain([0, d3.max(dataset, function(d) { return d[0]; })])\n                         .range([0, w]);\n\nFirst, notice that I named it `xScale`. Of course, you can name your scales\nwhatever you want, but a name like `xScale` helps me remember what this\nfunction does.\n\nSecond, notice that both the domain and range are specified as two-value\narrays in hard brackets.\n\nThird, notice that I set the low end of the input domain to 0. (Alternatively,\nyou could use `min()` to calculate a dynamic value.) The upper end of the\ndomain is set to the maximum value in `dataset` (which is currently 480, but\ncould change in the future).\n\nFinally, observe that the output range is set to `0` and `w`, the SVG’s width.\n\nWe’ll use very similar code to create the scale function for the y-axis:\n\n    \n    \n    var yScale = d3.scale.linear()\n                         .domain([0, d3.max(dataset, function(d) { return d[1]; })])\n                         .range([0, h]);\n\nNote that the `max()` function here references `d[1]`, the y value of each\nsubarray. Also, the upper end of `range()` is set to `h` instead of `w`.\n\nThe scale functions are in place! Now all we need to do is use them.\n\n### Incorporating Scaled Values\n\nRevisiting our scatterplot code, we now simply modify the original line where\nwe created a `circle` for each data value:\n\n    \n    \n    .attr(\"cx\", function(d) {\n        return d[0];  //Returns original value bound from dataset\n    })\n\nto return a scaled value (instead of the original value):\n\n    \n    \n    .attr(\"cx\", function(d) {\n        return xScale(d[0]);  //Returns scaled value\n    })\n\nLikewise, for the y-axis, this:\n\n    \n    \n    .attr(\"cy\", function(d) {\n        return d[1];\n    })\n\nis modified as:\n\n    \n    \n    .attr(\"cy\", function(d) {\n        return yScale(d[1]);\n    })\n\nFor good measure, let’s make the same change where we set the coordinates for\nthe text labels, so these lines:\n\n    \n    \n    .attr(\"x\", function(d) {\n        return d[0];\n    })\n    .attr(\"y\", function(d) {\n        return d[1];\n    })\n\nbecome this:\n\n    \n    \n    .attr(\"x\", function(d) {\n        return xScale(d[0]);\n    })\n    .attr(\"y\", function(d) {\n        return yScale(d[1]);\n    })\n\nAnd there we are!\n\nCheck out the working code in _02_scaled_plot.html_. Visually, the result in\n[Figure 7-2](part0011_split_005.html#Scatterplot_using_x_and_y_scales) is\ndisappointingly similar to our original scatterplot! Yet we are making more\nprogress than might be apparent.\n\n![Scatterplot using x and y scales](../images/00080.jpeg)\n\nFigure 7-2. Scatterplot using x and y scales\n\n\n## Refining the Plot\n\nYou might have noticed that smaller y values are at the top of the plot, and\nthe larger y values are toward the bottom. Now that we’re using D3 scales,\nit’s super easy to reverse that, so greater values are higher up, as you would\nexpect. It’s just a matter of changing the output range of `yScale` from:\n\n    \n    \n    .range([0, h]);\n\nto:\n\n    \n    \n    .range([h, 0]);\n\nSee _03_scaled_plot_inverted.html_ for the code that results in [Figure\n7-3](part0011_split_006.html#Scatterplot_with_y_scale_inverted).\n\n![Scatterplot with y scale inverted](../images/00081.jpeg)\n\nFigure 7-3. Scatterplot with y scale inverted\n\nYes, now a _smaller_ input to `yScale` will produce a _larger_ output value,\nthereby pushing those `circle`s and `text` elements down, closer to the base\nof the image. I know, it’s almost too easy!\n\nYet some elements are getting cut off. Let’s introduce a `padding` variable:\n\n    \n    \n    var padding = 20;\n\nThen we’ll incorporate the `padding` amount when setting the range of both\nscales. This will help push our elements in, away from the edges of the SVG,\nto prevent them from being clipped.\n\nThe range for `xScale` was `range([0, w])`, but now it’s:\n\n    \n    \n    .range([padding, w - padding]);\n\nThe range for `yScale` was `range([h, 0])`, but now it’s:\n\n    \n    \n    .range([h - padding, padding]);\n\nThis should provide us with 20 pixels of extra room on the left, right, top,\nand bottom edges of the SVG. And it does (see [Figure\n7-4](part0011_split_006.html#Scatterplot_with_padding))!\n\n![Scatterplot with padding](../images/00082.jpeg)\n\nFigure 7-4. Scatterplot with padding\n\nBut the text labels on the far right are still getting cut off, so I’ll double\nthe amount of `xScale`’s padding on the right side by multiplying by two to\nachieve the result shown in [Figure\n7-5](part0011_split_006.html#Scatterplot_with_more_padding):\n\n    \n    \n    .range([padding, w - padding * 2]);\n\n![Scatterplot with more padding](../images/00083.jpeg)\n\nFigure 7-5. Scatterplot with more padding\n\n* * *\n\n### Tip\n\nThe way I’ve introduced padding here is simple, but not elegant. Eventually,\nyou’ll want more control over how much padding is on each side of your charts\n(top, right, bottom, left), and it’s useful to standardize how you specify\nthose values across projects. Although I haven’t used [Mike Bostock’s margin\nconvention](http://bl.ocks.org/3019563) for the code samples in this book, I\nrecommend taking a look to see if it could work for you.\n\n* * *\n\nBetter! Reference the code so far in _04_scaled_plot_padding.html_. But\nthere’s one more change I’d like to make. Instead of setting the radius of\neach `circle` as the square root of its y value (which was a bit of a hack,\nand not visually useful), why not create another custom scale?\n\n    \n    \n    var rScale = d3.scale.linear()\n                         .domain([0, d3.max(dataset, function(d) { return d[1]; })])\n                         .range([2, 5]);\n\nThen, setting the radius looks like this:\n\n    \n    \n    .attr(\"r\", function(d) {\n        return rScale(d[1]);\n    });\n\nThis is exciting because we are guaranteeing that our radius values will\n_always_ fall within the range of `2,5`. (Or _almost_ always; see reference to\n`clamp()` later.) So data values of `0` (the minimum input) will get circles\nof radius `2` (or a diameter of 4 pixels). The very largest data value will\nget a circle of radius `5` (diameter of 10 pixels).\n\nVoila: [Figure 7-6](part0011_split_006.html#Scatterplot_with_scaled_radii)\nshows our first scale used for a visual property other than an axis value.\n(See _05_scaled_plot_radii.html_.)\n\n![Scatterplot with scaled radii](../images/00084.jpeg)\n\nFigure 7-6. Scatterplot with scaled radii\n\nFinally, just in case the power of scales hasn’t yet blown your mind, I’d like\nto add one more array to the dataset: `[600, 150]`.\n\nBoom! Check out _06_scaled_plot_big.html_. Notice how all the old points in\n[Figure 7-7](part0011_split_006.html#Scatterplot_with_big_numbers_added)\nmaintained their relative positions but have migrated closer together, down\nand to the left, to accommodate the newcomer in the top-right corner.\n\n![Scatterplot with big numbers added](../images/00085.jpeg)\n\nFigure 7-7. Scatterplot with big numbers added\n\nAnd now, one final revelation: we can now very easily change the size of our\nSVG, and _everything scales accordingly_. In [Figure\n7-8](part0011_split_006.html#Large_scaled_scatterplot), I’ve increased the\nvalue of `h` from `100` to `300` and made _no other changes_.\n\n![Large, scaled scatterplot](../images/00086.jpeg)\n\nFigure 7-8. Large, scaled scatterplot\n\nBoom, again! See _07_scaled_plot_large.html_. Hopefully, you are seeing this\nand realizing: no more late nights tweaking your code because the client\ndecided the graphic should be 800 pixels wide instead of 600. Yes, you will\nget more sleep because of me (and D3’s brilliant built-in methods). Being\nwell-rested is a competitive advantage. You can thank me later.\n\n\n## Other Methods\n\n`d3.scale.linear()` has several other handy methods that deserve a brief\nmention here:\n\n[`nice()`](http://bit.ly/ZR9Si0)\n\n> This tells the scale to take whatever input domain that you gave to\n> `range()` and expand both ends to the nearest round value. From the D3 wiki:\n> “For example, for a domain of [0.20147987687960267, 0.996679553296417], the\n> nice domain is [0.2, 1].” This is useful for normal people, who are not\n> computers and find it hard to read numbers like 0.20147987687960267.\n\n[`rangeRound()`](http://bit.ly/Z2ZLke)\n\n> Use `rangeRound()` in place of `range()`, and all values output by the scale\n> will be rounded to the nearest whole number. This is useful if you want\n> shapes to have exact pixel values, to avoid the fuzzy edges that could arise\n> with antialiasing.\n\n[`clamp()`](http://bit.ly/12h7uTf)\n\n> By default, a linear scale _can_ return values outside of the specified\n> range. For example, if given a value outside of its expected input domain, a\n> scale will return a number also outside of the output range. Calling\n> `clamp(true)` on a scale, however, forces all output values to be within the\n> specified range. This means excessive values will be rounded to the range’s\n> low or high value (whichever is nearest).\n\nTo use any of these special methods, just tack them onto the chain in which\nyou define the original scale function. For example, to use `nice()`:\n\n    \n    \n    var scale = d3.scale.linear()\n                        .domain([0.123, 4.567])\n                        .range([0, 500])\n                        .nice();\n\n\n## Other Scales\n\nIn addition to [`linear`\nscales](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear)\n(discussed earlier), D3 has several other built-in scale methods:\n\n[`sqrt`](http://bit.ly/15ePKWb)\n\n> A square root scale.\n\n[`pow`](http://bit.ly/XBKvuq)\n\n> A power scale (good for the gym, er, I mean, useful when working with\n> exponential series of values, as in “to the power of” some exponent).\n\n[`log`](http://bit.ly/YTuRdX)\n\n> A logarithmic scale.\n\n[`quantize`](http://bit.ly/ZEJXtP)\n\n> A linear scale with discrete values for its output range, for when you want\n> to sort data into “buckets.”\n\n[`quantile`](http://bit.ly/XxlWlr)\n\n> Similar to `quantize`, but with discrete values for its input domain (when\n> you already have “buckets”).\n\n[`ordinal`](http://bit.ly/XWSVvB)\n\n> Ordinal scales use nonquantitative values (like category names) for output;\n> perfect for comparing apples and oranges.\n\n[`d3.scale.category10()`](http://bit.ly/X6O0fT),\n[`d3.scale.category20()`](http://bit.ly/Wn3QPH),\n[`d3.scale.category20b()`](http://bit.ly/13bmamp), and\n[`d3.scale.category20c()`](http://bit.ly/Wn3Saf)\n\n> Handy preset ordinal scales that output either 10 or 20 categorical colors.\n\n[`d3.time.scale()`](http://bit.ly/Xxm6tc)\n\n> A scale method for date and time values, with special handling of ticks for\n> dates.\n\nNow that you have mastered the power of scales, it’s time to express them\nvisually as, yes, _axes_!\n\n\n## Chapter 8. Axes\n\nHaving mastered the use of D3 scales, we now have the scatterplot shown in\n[Figure 8-1](part0012_split_000.html#Large_scaled_scatterplot2).\n\n![Large, scaled scatterplot](../images/00087.jpeg)\n\nFigure 8-1. Large, scaled scatterplot\n\nLet’s add horizontal and vertical axes, so we can do away with the horrible\nred numbers cluttering up our chart.\n\n\n## Introducing Axes\n\nMuch like its scales, [D3’s _axes_](https://github.com/mbostock/d3/wiki/SVG-\nAxes) are actually _functions_ whose parameters you define. Unlike scales,\nwhen an axis function is called, it doesn’t return a value, but generates the\nvisual elements of the axis, including lines, labels, and ticks.\n\nNote that the axis functions are SVG-specific, as they generate SVG elements.\nAlso, axes are intended for use with quantitative scales (as opposed to\nordinal ones).\n\n\n## Setting Up an Axis\n\nUse `d3.svg.axis()` to create a generic axis function:\n\n    \n    \n    var xAxis = d3.svg.axis();\n\nAt a minimum, each axis also needs to be told on what _scale_ to operate. Here\nwe’ll pass in the `xScale` from the scatterplot code:\n\n    \n    \n    xAxis.scale(xScale);\n\nWe can also specify where the labels should appear relative to the axis\nitself. The default is `bottom`, meaning the labels will appear below the axis\nline. (Although this is the default, it can’t hurt to specify it explicitly.)\nPossible orientations for horizontal axes are `top` and `bottom`. For vertical\naxes, use `left` and `right`:\n\n    \n    \n    xAxis.orient(\"bottom\");\n\nOf course, we can be more concise and string all this together into one line:\n\n    \n    \n    var xAxis = d3.svg.axis()\n                      .scale(xScale)\n                      .orient(\"bottom\");\n\nFinally, to actually generate the axis and insert all those little lines and\nlabels into our SVG, we must _call_ the `xAxis` function. This is similar to\nthe scale functions, which we first configured by setting parameters, and then\nlater _called_ , to put them into action.\n\nI’ll put this code at the end of our script, so the axis is generated after\nthe other elements in the SVG, and therefore appears “on top”:\n\n    \n    \n    svg.append(\"g\")\n        .call(xAxis);\n\nThis is where things get a little funky. You might be wondering why this looks\nso different from our friendly scale functions. Here’s why: because an _axis_\nfunction actually draws something to the screen (by appending SVG elements to\nthe DOM), we need to specify _where_ in the DOM it should place those new\nelements. This is in contrast to scale functions like `xScale()`, for example,\nwhich calculate a value and return those values, typically for use by yet\nanother function, without impacting the DOM at all.\n\nSo what we’re doing with the preceding code is to first reference `svg`, the\nSVG image in the DOM. Then, we `append()` a new `g` element to the end of the\nSVG. In SVG land, a `g` element is a _group_ element. Group elements are\ninvisible, unlike `line`, `rect`, and `circle`, and they have no visual\npresence themselves. Yet they help us in two ways: first, `g` elements can be\nused to contain (or “group”) other elements, which keeps our code nice and\ntidy. Second, we can apply _transformations_ to `g` elements, which affects\nhow visual elements within that group (such as `line`s, `rect`s, and\n`circle`s) are rendered. We’ll get to transformations in just a minute.\n\nSo we’ve created a new `g`, and then finally, the function `call()` is called\non our new `g`. So what is `call()`, and who is it calling?\n\n[D3’s `call()` function](https://github.com/mbostock/d3/wiki/Selections#wiki-\ncall) takes the incoming _selection_ , as received from the prior link in the\nchain, and hands that selection off to any _function_. In this case, the\nselection is our new `g` group element. Although the `g` isn’t strictly\nnecessary, we are using it because the axis function is about to generate lots\nof crazy lines and numbers, and it’s nice to contain all those elements within\na single group object. `call()` hands off `g` to the `xAxis` function, so our\naxis is generated _within_ `g`.\n\nIf we were messy people who loved messy code, we could also rewrite the\npreceding snippet as this exact equivalent:\n\n    \n    \n    svg.append(\"g\")\n        .call(d3.svg.axis()\n        .scale(xScale)\n        .orient(\"bottom\"));\n\nSee, you could cram the whole axis function within `call()`, but it’s usually\neasier on our brains to define functions first, then call them later.\n\nIn any case, [Figure 8-2](part0012_split_002.html#Simple_but_ugly_axis) shows\nwhat that looks like. See code example _01_axes.html_.\n\n![Simple, but ugly axis](../images/00088.jpeg)\n\nFigure 8-2. Simple, but ugly axis\n\n\n## Cleaning It Up\n\nTechnically, that is an axis, but it’s neither pretty nor useful. To clean it\nup, let’s first assign a class of `axis` to the new `g` element, so we can\ntarget it with CSS:\n\n    \n    \n    svg.append(\"g\")\n        .attr(\"class\", \"axis\") //Assign \"axis\" class\n        .call(xAxis);\n\nThen, we introduce our first CSS styles, up in the `<head>` of our page:\n\n    \n    \n    .axis path,\n    .axis line {\n        fill: none;\n        stroke: black;\n        shape-rendering: crispEdges;\n    }\n    \n    .axis text {\n        font-family: sans-serif;\n        font-size: 11px;\n    }\n\nSee how useful it is to group all the axis elements within one `g` group? Now\nwe can very easily apply styles to anything within the group using the simple\nCSS selector `.axis`. The axes themselves are made up of `path`, `line`, and\n`text` elements, so those are the three elements that we target in our CSS.\nThe `path`s and `line`s can be styled with the same rules, and `text` gets its\nown rules around font and font size.\n\nYou might notice that when we use CSS rules to style SVG elements, only SVG\nattribute names — not regular CSS properties — should be used. This is\nconfusing, because many properties share the same names in both CSS and SVG,\nbut some do not. For example, in regular CSS, to set the color of some text,\nyou would use the `color` property, as in:\n\n    \n    \n    p {\n        color: olive;\n    }\n\nThat will set the text color of all `p` paragraphs to be `olive`. But try to\napply this property to an SVG element, as with:\n\n    \n    \n    text {\n        color: olive;\n    }\n\nand it will have no effect because `color` is not a property recognized by\nSVG. Instead, you must use SVG’s equivalent, `fill`:\n\n    \n    \n    text {\n        fill: olive;\n    }\n\nIf you ever find yourself trying to style SVG elements, but for some reason\nthe stupid CSS code just isn’t working, I suggest you take a deep breath,\npause, and then review your _property names_ very closely to ensure you’re\nusing SVG names, not CSS ones. (You can reference the complete SVG attribute\nlist on [the MDN site](https://developer.mozilla.org/en-\nUS/docs/SVG/Attribute).)\n\n[The `shape-rendering`\nproperty](https://developer.mozilla.org/en/SVG/Attribute/shape-rendering) is\nanother weird SVG attribute you should know. We use it here to make sure our\naxis and its tick mark lines are pixel-perfect. No blurry axes for us!\n\nThe chart looks like [Figure 8-3](part0012_split_003.html#Cleaner_axis) after\nour CSS clean-up.\n\n![Cleaner axis](../images/00089.jpeg)\n\nFigure 8-3. Cleaner axis\n\nThat’s better, but the top horizontal line of the axis is cut off, and the\naxis itself should be down at the base of the chart anyway. Here’s where SVG\n_transformations_ come in. By adding one line of code, we can `transform` the\nentire axis group, pushing it to the bottom:\n\n    \n    \n    svg.append(\"g\")\n        .attr(\"class\", \"axis\")\n        .attr(\"transform\", \"translate(0,\" + (h - padding) + \")\")\n        .call(xAxis);\n\nNote that we use `attr()` to apply `transform` as an attribute of `g`. [SVG\ntransforms](https://developer.mozilla.org/en-US/docs/SVG/Attribute/transform)\nare quite powerful, and can accept several different kinds of transform\ndefinitions, including scales and rotations. But we are keeping it simple here\nwith only a _translation_ transform, which simply pushes the whole `g` group\nover and down by some amount.\n\nTranslation transforms are specified with the easy syntax of `translate(x,y)`,\nwhere `x` and `y` are, obviously, the number of horizontal and vertical pixels\nby which to translate the element. So, in the end, we would like our `g` to\nlook like this in the DOM:\n\n    \n    \n    <g class=\"axis\" transform=\"translate(0,280)\">\n\nAs you can see, the `g.axis` isn’t moved horizontally at all, but it is pushed\n280 pixels down, conveniently to the base of our chart. We specify as much in\nthis line of code:\n\n    \n    \n        .attr(\"transform\", \"translate(0,\" + (h - padding) + \")\")\n\nNote the use of `(h - padding)`, so the group’s top edge is set to `h`, the\nheight of the entire image, minus the `padding` value we created earlier. `(h\n- padding)` is calculated to be `280`, and then connected to the rest of the\nstring, so the final transform property value is `translate(0,280)`.\n\nThe result in [Figure 8-4](part0012_split_003.html#Nice_clean_axis) is much\nbetter! Check out the code so far in _02_axes_bottom.html_.\n\n![Nice, clean axis](../images/00090.jpeg)\n\nFigure 8-4. Nice, clean axis\n\n\n## Check for Ticks\n\nSome ticks spread disease, but [D3’s\nticks](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-\nlinear_ticks) communicate information. Yet more ticks are not necessarily\nbetter, and at a certain point, they begin to clutter your chart. You’ll\nnotice that we never specified how many ticks to include on the axis, nor at\nwhat intervals they should appear. Without clear instruction, D3 has\nautomagically examined our scale `xScale` and made informed judgments about\nhow many ticks to include, and at what intervals (every 50, in this case).\n\nAs you would expect, you can customize all aspects of your axes, starting with\nthe rough number of ticks, using `ticks()`:\n\n    \n    \n    var xAxis = d3.svg.axis()\n                      .scale(xScale)\n                      .orient(\"bottom\")\n                      .ticks(5);  //Set rough # of ticks\n\nSee _03_axes_clean.html_ for that code.\n\nYou’ll notice in [Figure 8-5](part0012_split_004.html#Fewer_ticks) that,\nalthough we specified only five ticks, D3 has made an executive decision and\nordered up a total of seven. That’s because D3 has got your back, and figured\nout that including only _five_ ticks would require slicing the input domain\ninto less-than-gorgeous values — in this case, 0, 150, 300, 450, and 600. D3\ninteprets the `ticks()` value as merely a suggestion and will override your\nsuggestion with what it determines to be the most clean and human-readable\nvalues — in this case, intervals of 100 — even when that requires including\nslightly more or fewer ticks than you requested. This is actually a totally\nbrilliant feature that increases the scalability of your design; as the\ndataset changes and the input domain expands or contracts (bigger numbers or\nsmaller numbers), D3 ensures that the tick labels remain easy to read.\n\n![Fewer ticks](../images/00091.jpeg)\n\nFigure 8-5. Fewer ticks\n\n\n## Y Not?\n\nTime to label the vertical axis! By copying and tweaking the code we already\nwrote for the `xAxis`, we add this near the top of of our code:\n\n    \n    \n    //Define Y axis\n    var yAxis = d3.svg.axis()\n                      .scale(yScale)\n                      .orient(\"left\")\n                      .ticks(5);\n\nand this, near the bottom:\n\n    \n    \n    //Create Y axis\n    svg.append(\"g\")\n        .attr(\"class\", \"axis\")\n        .attr(\"transform\", \"translate(\" + padding + \",0)\")\n        .call(yAxis);\n\nNote in [Figure 8-6](part0012_split_005.html#Initial_Y_axis) that the labels\nwill be oriented `left` and that the `yAxis` group `g` is translated to the\nright by the amount `padding`.\n\n![Initial y-axis](../images/00092.jpeg)\n\nFigure 8-6. Initial y-axis\n\nThis is starting to look like a real chart! But the `yAxis` labels are getting\ncut off. To give them more room on the left side, I’ll bump up the value of\n`padding` from 20 to 30:\n\n    \n    \n    var padding = 30;\n\nOf course, you could also introduce separate `padding` variables for each\naxis, say `xPadding` and `yPadding`, for more control over the layout.\n\nSee the updated code in _04_axes_y.html_. It looks like [Figure\n8-7](part0012_split_005.html#Scatterplot_with_Y_axis).\n\n![Scatterplot with y-axis](../images/00093.jpeg)\n\nFigure 8-7. Scatterplot with y-axis\n\n\n## Final Touches\n\nI appreciate that so far you have been very quiet and polite, and not at all\nconfrontational. Yet I still feel as though I have to win you over. So to\nprove to you that our new axes are dynamic and scalable, I’d like to switch\nfrom using a static dataset to using randomized numbers:\n\n    \n    \n    //Dynamic, random dataset\n    var dataset = [];\n    var numDataPoints = 50;\n    var xRange = Math.random() * 1000;\n    var yRange = Math.random() * 1000;\n    for (var i = 0; i < numDataPoints; i++) {\n        var newNumber1 = Math.floor(Math.random() * xRange);\n        var newNumber2 = Math.floor(Math.random() * yRange);\n        dataset.push([newNumber1, newNumber2]);\n    }\n\nThis code initializes an empty array, then loops through 50 times, chooses two\nrandom numbers each time, and adds (“pushes”) that pair of values to the\n`dataset` array (see [Figure\n8-8](part0012_split_006.html#Scatterplot_with_random_data)).\n\n![Scatterplot with random data](../images/00094.jpeg)\n\nFigure 8-8. Scatterplot with random data\n\nTry out that randomized dataset code in _05_axes_random.html_. Each time you\nreload the page, you’ll get different data values. Notice how both axes scale\nto fit the new domains, and ticks and label values are chosen accordingly.\n\nHaving made my point, I think we can finally cut those horrible, red labels,\nby commenting out the relevant lines of code.\n\nThe result is shown in [Figure\n8-9](part0012_split_006.html#Scatterplot_with_random_data_and_no_red_labels).\nOur final scatterplot code lives in _06_axes_no_labels.html_.\n\n![Scatterplot with random data and no red labels](../images/00095.jpeg)\n\nFigure 8-9. Scatterplot with random data and no red labels\n\n\n## Formatting Tick Labels\n\nOne last thing: so far, we’ve been working with integers — whole numbers —\nwhich are nice and easy. But data is often messier, and in those cases, you\nmight want more control over how the axis labels are formatted. Enter\n[`tickFormat()`](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-\nlinear_tickFormat), which enables you to specify how your numbers should be\nformatted. For example, you might want to include three places after the\ndecimal point, or display values as percentages, or both.\n\nTo use `tickFormat()`, first define a new number-formatting function. This\none, for example, says to treat values as percentages with one decimal point\nprecision. That is, if you give this function the number `0.23`, it will\nreturn the string `23.0%`. (See [the reference entry for\n`d3.format()`](https://github.com/mbostock/d3/wiki/Formatting#wiki-d3_format)\nfor more options.)\n\n    \n    \n    var formatAsPercentage = d3.format(\".1%\");\n\nThen, tell your axis to use that formatting function for its ticks, for\nexample:\n\n    \n    \n    xAxis.tickFormat(formatAsPercentage);\n\n* * *\n\n### Tip\n\nI find it easiest to test these formatting functions out in the JavaScript\nconsole. For example, just open any page that loads D3, such as\n_06_axes_no_labels.html_ , and type your format rule into the console. Then\ntest it by feeding it a value, as you would with any other function.\n\nYou can see in [Figure 8-10](part0012_split_007.html#Testing_format_console)\nthat a data value of `0.54321` is converted to `54.3%` for display purposes —\nperfect!\n\n![Testing format\\(\\) in the console](../images/00096.jpeg)\n\nFigure 8-10. Testing format() in the console\n\n* * *\n\nYou can play with that code in _07_axes_format.html_. Obviously, a percentage\nformat doesn’t make sense with our scatterplot’s current dataset, but as an\nexercise, you could try tweaking how the random numbers are generated, to make\nmore appropriate, non-whole number values, or just experiment with the format\nfunction itself.\n\n\n## Chapter 9. Updates, Transitions, and Motion\n\nUntil this point, we have used only static datasets. But real-world data\nalmost always _changes_ over time. And you might want your visualization to\nreflect those changes.\n\nIn D3 terms, those changes are handled by _updates_. The visual adjustments\nare made pretty with _transitions_ , which can employ _motion_ for perceptual\nbenefit.\n\nWe’ll start by generating a visualization with one dataset, and then changing\nthe data completely.\n\n\n## Modernizing the Bar Chart\n\nLet’s revisit our trusty old bar chart in [Figure\n9-1](part0013_split_001.html#The_bar_chart_as_seen_last).\n\n![The bar chart, as seen last](../images/00097.jpeg)\n\nFigure 9-1. The bar chart, as seen last\n\nIf you examine the code in _01_bar_chart.html_ , you’ll see that we used this\nstatic dataset:\n\n    \n    \n    var dataset = [ 5, 10, 13, 19, 21, 25, 22, 18, 15, 13,\n                    11, 12, 15, 20, 18, 17, 16, 18, 23, 25 ];\n\nSince then, we’ve learned how to write more flexible code, so our chart\nelements resize to accommodate different sized datasets (meaning shorter or\nlonger arrays) and different data values (smaller or larger numbers). We\naccomplished that flexibility using D3 scales, so I’d like to start by\nbringing our bar chart up to speed.\n\nReady? Okay, just give me a sec…\n\nAaaaaand, done! Thanks for waiting.\n\n[Figure 9-2](part0013_split_001.html#A_scalable_flexible_bar_chart) looks\npretty similar, but a lot has changed under the hood. You can follow along by\nopening up _02_bar_chart_with_scales.html_.\n\n![A scalable, flexible bar chart](../images/00098.jpeg)\n\nFigure 9-2. A scalable, flexible bar chart\n\nTo start, I adjusted the width and height, to make the chart taller and wider:\n\n    \n    \n    var w = 600;\n    var h = 250;\n\nNext, I introduced an _ordinal scale_ to handle the left/right positioning of\nbars and labels along the x-axis:\n\n    \n    \n    var xScale = d3.scale.ordinal()\n                    .domain(d3.range(dataset.length))\n                    .rangeRoundBands([0, w], 0.05);\n\nThis may seem like gobbledegook, so I’ll walk through it one line at a time.\n\n### Ordinal Scales, Explained\n\nFirst, in this line:\n\n    \n    \n    var xScale = d3.scale.ordinal()\n\nwe declare a new variable called `xScale`, just as we had done with our\nscatterplot. Only here, instead of a _linear_ scale, we create an _ordinal_\none. Ordinal scales are typically used for ordinal data, typically categories\nwith some inherent _order_ to them, such as:\n\n  * freshman, sophomore, junior, senior \n  * grade B, grade A, grade AA \n  * strongly dislike, dislike, neutral, like, strongly like \n\nWe don’t have true ordinal data for use with this bar chart. Instead, we just\nwant the bars to be drawn from left to right using the same order in which\nvalues occur in our dataset. D3’s ordinal scale is useful in this situation,\nwhen we have many visual elements (vertical bars) that are positioned in an\narbitrary order (left to right), but must be evenly spaced. This will become\nclear in a moment.\n\n    \n    \n    .domain(d3.range(dataset.length))\n\nThis next line of code sets the input domain for the scale. Remember how\nlinear scales need a two-value array to set their domains, as in `[0, 100]`?\nFor a linear scale, that array would set the low and high values of the\ndomain. But ordinal domains are, well, ordinal, so they don’t think in linear,\nquantitative terms. To set the domain of an ordinal scale, you typically\nspecify an array with the category names, as in:\n\n    \n    \n    .domain([\"freshman\", \"sophomore\", \"junior\", \"senior\"])\n\nFor our bar chart, we don’t have explicit categories, but we could assign each\ndata point or bar an ID value corresponding to its position within the\n`dataset` array, as in 0, 1, 2, 3, and so on. So perhaps our domain statement\ncould read:\n\n    \n    \n    .domain([0, 1, 2, 3, 4, 5, 6, 7, 8, 9,\n             10, 11, 12, 13, 14, 15, 16, 17, 18, 19])\n\nIt turns out there is a very simple way to quickly generate an array of\nsequential numbers: the `d3.range()` method.\n\nWhile viewing _02_bar_chart_with_scales.html_ , go ahead and open up the\nconsole, and type the following:\n\n    \n    \n    d3.range(10)\n\nYou should see the following output array:\n\n    \n    \n    [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]\n\nHow nice is that? D3 saves you time once again (and the hassle of extra\n`for()` loops).\n\nComing back to our code, it should now be clear what’s happening here:\n\n    \n    \n    .domain(d3.range(dataset.length))\n\n  1. `dataset.length`, in this case, is evaluted as `20`, because we have 20 items in our dataset. \n  2. `d3.range(20)` is then evaluated, which returns this array: `[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]`. \n  3. Finally, `domain()` sets the domain of our new ordinal scale to those values. \n\nThis might be somewhat confusing because we are using numbers (0, 1, 2…) as\nordinal values, but ordinal values are typically nonnumeric.\n\n### Round Bands Are All the Range These Days\n\nThe great thing about `d3.scale.ordinal()` is it supports _range banding_.\nInstead of returning a continuous range, as any quantitative scale (like\n`d3.scale.linear()`) would, ordinal scales use _discrete_ ranges, meaning the\noutput values are determined in advance, and could be numeric or not.\n\nWe could use `range()` like everyone else, _or_ we can be smooth and use\n`rangeBands()`, which takes a low and high value, and automatically divides it\ninto even chunks or “bands,” based on the length of the domain. For example:\n\n    \n    \n    .rangeBands([0, w])\n\nthis says “calculate even bands starting at 0 and ending at `w`, then set this\nscale’s range to those bands.” In our case, we specified 20 values in the\ndomain, so D3 will calculate:\n\n    \n    \n    (w - 0) / xScale.domain().length\n    (600 - 0) / 20\n    600 / 20\n    30\n\nIn the end, each band will be `30` “wide.”\n\nIt is also possible to include a second parameter, which includes a bit of\nspacing between each band. Here, I’ve used `0.2`, meaning that 20 percent of\nthe width of each band will be used for spacing in between bands:\n\n    \n    \n    .rangeBands([0, w], 0.2)\n\nWe can be even smoother and use `rangeRoundBands()`, which is the same as\n`rangeBands()`, except that the output values are rounded to the nearest whole\npixel, so 12.3456 becomes just 12, for example. This is helpful for keeping\nvisual elements lined up precisely on the pixel grid, for clean, sharp edges.\n\nI’ll also decrease the amount of spacing to just 5 percent. So, our final line\nof code in that statement is:\n\n    \n    \n    .rangeRoundBands([0, w], 0.05);\n\nThis gives us nice, clean pixel values, with a teensy bit of visual space\nbetween them.\n\n### Referencing the Ordinal Scale\n\nLater in the code (and I recommend viewing the source), when we create the\n`rect` elements, we set their horizontal, x-axis positions like so:\n\n    \n    \n    //Create bars\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       .attr(\"x\", function(d, i) {\n          return xScale(i);         // <-- Set x values\n       })\n               …\n\nNote that, because we include `d` and `i` as parameters to the anonymous\nfunction, D3 will automatically pass in the correct values. Of course, `d` is\nthe current datum, and `i` is its index value. So `i` will be passed 0, 1, 2,\n3, and so on.\n\nCoincidentally (hmmm!), we used those same values (0, 1, 2, 3…) for our\nordinal scale’s input domain. So when we call `xScale(i)`, `xScale()` will\nlook up the ordinal value `i` and return its associated output (band) value.\n(You can verify all this for yourself in the console. Just try typing\n`xScale(0)` or `xScale(5)`.)\n\nEven better, setting the widths of these bars just got a lot easier. Before\nusing the ordinal scale, we had:\n\n    \n    \n    .attr(\"width\", w / dataset.length - barPadding)\n\nWe don’t even need `barPadding` anymore because now the padding is built into\n`rangeRoundBands()`. Setting the width of each `rect` needs only this:\n\n    \n    \n            .attr(\"width\", xScale.rangeBand())\n\nIsn’t it nice when D3 does the math for you?\n\n### Other Updates\n\nI’ve made several other updates in _02_bar_chart_with_scales.html_ , including\ncreating a new linear scale `yScale` to calculate vertical values. You already\nknow how to use linear scales, so you can skim the source and note how that’s\nbeing used to set the bar heights.\n\n\n## Updating Data\n\nOkay, once again, we have the amazing bar chart shown in [Figure\n9-3](part0013_split_002.html#The_bar_chart), flexible enough to handle any\ndata we can throw at it.\n\n![The bar chart](../images/00099.jpeg)\n\nFigure 9-3. The bar chart\n\nOr is it? Let’s see.\n\nThe simplest kind of update is when all data values are updated at the same\ntime _and_ the number of values stays the same.\n\nThe basic approach in this scenario is this:\n\n  1. Modify the values in your dataset. \n  2. Rebind the new values to the existing elements (thereby overwriting the original values). \n  3. Set new attribute values as needed to update the visual display. \n\nBefore any of those steps can happen, though, some _event_ needs to kick\nthings off. So far, all of our code has executed immediately on page load. We\n_could_ have our update run right after the initial drawing code, but it would\nhappen imperceptibly fast. To make sure we can observe the change as it\nhappens, we will separate our update code from everything else. We will need a\n“trigger,” something that happens _after_ page load to apply the updates. How\nabout a mouse click?\n\n### Interaction via Event Listeners\n\nAny DOM element can be used, so rather than design a fancy button, I’ll add a\nsimple `p` paragraph to the HTML’s `body`:\n\n    \n    \n    <p>Click on this text to update the chart with new data values (once).</p>\n\nThen, down at the end of our D3 code, let’s add the following:\n\n    \n    \n    d3.select(\"p\")\n        .on(\"click\", function() {\n            //Do something  on click\n        });\n\nThis selects our new `p`, and then adds an _event listener_ to that element.\nHuh?\n\nIn JavaScript, events are happening all the time. Not exciting events, like\nhuge parties, but really insignificant events like `mouseover` and `click`.\nMost of the time, these insignificant events go ignored (just as in life,\nperhaps). But if someone is _listening_ , then the event will be _heard_ , and\ncan go down in posterity, or at least trigger some sort of DOM interaction.\n(Rough JavaScript parallel of classic koan: if an event occurs, and no\nlistener hears it, did it ever happen at all?)\n\nAn event _listener_ is an anonymous function that _listens_ for a specific\nevent _on_ a specific element or elements. D3’s method `selection.on()`\nprovides a nice shorthand for adding event listeners. As you can see, `on()`\ntakes two arguments: the event _type_ (`\"click\"`) and the listener itself (the\nanonymous function).\n\nIn this case, the listener listens for a `click` event occurring on our\nselection `p`. When that happens, the listener function is executed. You can\nput whatever code you want in between the brackets of the anonymous function:\n\n    \n    \n    d3.select(\"p\")\n        .on(\"click\", function() {\n            //Do something mundane and annoying on click\n            alert(\"Hey, don't click that!\");\n        });\n\nWe’ll talk a lot more about interactivity in [Chapter\n10](part0014_split_000.html#DB7S2-8a8b0c18aaaf4f5c9d772f6d0c5087fc).\n\n### Changing the Data\n\nInstead of generating annoying pop-ups, I’d rather simply update `dataset` by\noverwriting its original values. This is step 1, from earlier:\n\n    \n    \n    dataset = [ 11, 12, 15, 20, 18, 17, 16, 18, 23, 25,\n                5, 10, 13, 19, 21, 25, 22, 18, 15, 13 ];\n\nStep 2 is to rebind the new values to the existing elements. We can do that by\nselecting those `rect`s and simply calling `data()` one more time:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset);     //New data successfully bound, sir!\n\n### Updating the Visuals\n\nFinally, step 3 is to update the visual attributes, referencing the (now-\nupdated) data values. This is super easy, as we simply copy and paste the\nrelevant code that we’ve already written. In this case, the `rect`s can\nmaintain their horizontal positions and widths; all we really need to update\nare their `height`s and `y` positions. I’ve added those lines here:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       });\n\nNotice this looks almost exactly like the code that generates the `rect`s\ninitially, only without `enter()` and `append()`.\n\nPutting it all together, here is all of our update code in one place:\n\n    \n    \n    //On click, update with new data\n    d3.select(\"p\")\n        .on(\"click\", function() {\n    \n            //New values for dataset\n            dataset = [ 11, 12, 15, 20, 18, 17, 16, 18, 23, 25,\n                        5, 10, 13, 19, 21, 25, 22, 18, 15, 13 ];\n    \n            //Update all rects\n            svg.selectAll(\"rect\")\n               .data(dataset)\n               .attr(\"y\", function(d) {\n                    return h - yScale(d);\n               })\n               .attr(\"height\", function(d) {\n                    return yScale(d);\n               });\n    \n        });\n\nCheck out the revised bar chart in _03_updates_all_data.html_. It looks like\n[Figure 9-4](part0013_split_002.html#Updateable_bar_chart) to start.\n\n![Updatable bar chart](../images/00100.jpeg)\n\nFigure 9-4. Updatable bar chart\n\nThen click anywhere on the paragraph, and it turns into [Figure\n9-5](part0013_split_002.html#Bar_chart_data_updated).\n\n![Bar chart, data updated](../images/00101.jpeg)\n\nFigure 9-5. Bar chart, data updated\n\nGood news: the values in `dataset` were modified, rebound, and used to adjust\nthe `rect`s. Bad news: it looks weird because we forgot to update the labels,\nand also the bar colors. Good news (because I always like to end with good\nnews): this is easy to fix.\n\nTo ensure the colors change on update, we just copy and paste in the line\nwhere we set the `fill`:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       })\n       .attr(\"fill\", function(d) {   // <-- Down here!\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n       });\n\nTo update the labels, we use a similar pattern, only here we adjust their text\ncontent and x/y values:\n\n    \n    \n    svg.selectAll(\"text\")\n       .data(dataset)\n       .text(function(d) {\n            return d;\n       })\n       .attr(\"x\", function(d, i) {\n            return xScale(i) + xScale.rangeBand() / 2;\n       })\n       .attr(\"y\", function(d) {\n            return h - yScale(d) + 14;\n       });\n\nTake a look at _04_updates_all_data_fixed.html_. You’ll notice it looks the\nsame to start, but click the trigger and now the bar colors and labels update\ncorrectly, as shown in [Figure\n9-6](part0013_split_002.html#Updated_chart_with_correct_colors_and_labels).\n\n![Updated chart with correct colors and labels](../images/00102.jpeg)\n\nFigure 9-6. Updated chart with correct colors and labels\n\n\n## Transitions\n\nLife transitions can be scary: the first day of school, moving to a new city,\nquitting your day job to do freelance data visualization full-time. But D3\ntransitions are fun, beautiful, and not at all emotionally taxing.\n\nMaking a nice, super smooth, animated transition is as simple as adding one\nline of code:\n\n    \n    \n    .transition()\n\nSpecifically, add this link in the chain below where your selection is made,\nand _above_ where any attribute changes are applied:\n\n    \n    \n    //Update all rects\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .transition()    // <-- This is new! Everything else here is unchanged.\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       })\n       .attr(\"fill\", function(d) {\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n       });\n\nNow run the code in _05_transition.html_ , and click the text to see the\ntransition in action. Note that the end result looks the same visually, but\nthe transition from the chart’s initial state to its end state is much, much\nnicer.\n\nIsn’t that _insane_? I’m not a psychologist, but I believe it is literally\ninsane that we can add a single line of code, and D3 will _animate_ our value\nchanges for us over time.\n\nWithout `transition()`, D3 evaluates every `attr()` statement immediately, so\nthe changes in height and fill happen right away. When you add `transition()`,\nD3 introduces the element of time. Rather than applying new values all at\nonce, D3 _interpolates_ between the old values and the new values, meaning it\nnormalizes the beginning and ending values, and calculates all their in-\nbetween states. D3 is also smart enough to recognize and interpolate between\ndifferent attribute value formats. For example, if you specified a height of\n`200px` to start but transition to just `100` (without the `px`). Or if a\n`blue` fill turns `rgb(0,255,0)`. You don’t need to fret about being\nconsistent; D3 takes care of it.\n\nDo you believe me yet? This is really insane. And super helpful.\n\n### duration(), or How Long Is This Going to Take?\n\nSo the `attr()` values are interpolated over time, but how _much_ time? It\nturns out the default is 250 milliseconds, or one-quarter second (1,000\nmilliseconds = 1 second). That’s why the transition in _05_transition.html_ is\nso fast.\n\nFortunately, you can control how much time is spent on any transition by —\nagain, I kid you not — adding a single line of code:\n\n    \n    \n    .duration(1000)\n\nThe `duration()` must be specified _after_ the `transition()`, and durations\nare always specified in milliseconds, so `duration(1000)` is a one-second\nduration.\n\nHere is that line in context:\n\n    \n    \n    //Update all rects\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .transition()\n       .duration(1000)  // <-- Now this is new!\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       })\n       .attr(\"fill\", function(d) {\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n       });\n\nOpen up _06_duration.html_ and see the difference. Now make a copy of that\nfile, and try plugging in some different numbers to slow or speed the\ntransition. For example, try `3000` for a three-second transition, or `100`\nfor one-tenth of a second.\n\nThe actual durations you choose will depend on the context of your design and\nwhat triggers the transition. In practice, I find that transitions of around\n150 ms are useful for providing minor interface feedback (such as hovering\nover elements), and about 1,000 ms is ideal for many more significant visual\ntransitions, such as switching from one view of the data to another. 1,000 ms\n(one second) is not too long, not too short.\n\nIn case you’re feeling lazy, I made _07_duration_slow.html_ , which uses\n`5000` for a five-second transition.\n\nWith such a slow transition, it becomes obvious that the value labels are not\ntransitioning smoothly along with the bar heights. As you now know, we can\ncorrect that oversight by adding only two new lines of code, this time in the\nsection where we update the labels:\n\n    \n    \n    //Update all labels\n    svg.selectAll(\"text\")\n       .data(dataset)\n       .transition()        // <-- This is new,\n       .duration(5000)      //     and so is this.\n       .text(function(d) {\n            return d;\n       })\n       .attr(\"x\", function(d, i) {\n            return xScale(i) + xScale.rangeBand() / 2;\n       })\n       .attr(\"y\", function(d) {\n            return h - yScale(d) + 14;\n       });\n\nMuch better! Note in _08_duration_slow_labels_fixed.html_ how the labels now\nanimate smoothly along with the bars.\n\n### ease()-y Does It\n\nWith a 5,000-ms, slow-as-molasses transition, we can also perceive the\n_quality_ of motion. In this case, notice how the animation begins very\nslowly, then accelerates, then slows down again as the bars reach their\ndestination heights. That is, the rate of motion is not _linear_ , but\n_variable_.\n\nThe quality of motion used for a transition is called _easing_. In animation\nterms, we think about elements _easing_ into place, moving from here to there.\n\nWith D3, you can specify different kinds of easing by using `ease()`. The\ndefault easing is `\"cubic-in-out\"`, which produces the gradual acceleration\nand deceleration we see in our chart. It’s a good default because you\ngenerally can’t go wrong with a nice, smooth transition.\n\nContrast that smoothness to _09_ease_linear.html_ , which uses\n`ease(\"linear\")` to specify a linear easing function. Notice how the rate of\nmotion is constant. That is, there is no gradual acceleration and deceleration\n— the elements simply begin moving at an even pace, and then they stop\nabruptly. (Also, I lowered the duration to 2,000 ms.)\n\n`ease()` must also be specified after `transition()`, but before the `attr()`\nstatements to which the transition applies. `ease()` can come before or after\n`duration()`, but this sequence makes the most sense to me:\n\n    \n    \n    …   //Selection statement(s)\n    .transition()\n    .duration(2000)\n    .ease(\"linear\")\n    …   //attr() statements\n\nFortunately, there are several other built-in easing functions to choose from.\nSome of my favorites are:\n\n`circle`\n\n> Gradual ease in and acceleration until elements snap into place.\n\n`elastic`\n\n> The best way to describe this one is “sproingy.”\n\n`bounce`\n\n> Like a ball bouncing, then coming to rest.\n\nSample code files _10_ease_circle.html_ , _11_ease_elastic.html_ , and\n_12_ease_bounce.html_ illustrate these three functions. The complete list of\neasing functions is on [the D3\nwiki](https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_ease).\n\nWow, I already regret telling you about `bounce`. Please use `bounce` only if\nyou are making a satirical infographic that is mocking other bad graphics.\nPerceptually, I don’t think there is a real case to be used for `bounce`\neasing in visualization. `cubic-in-out` is the default for a reason.\n\n### Please Do Not delay()\n\nWhereas `ease()` controls the quality of motion, `delay()` specifies when the\ntransition begins.\n\n`delay()` can be given a static value, also in milliseconds, as in:\n\n    \n    \n    …\n    .transition()\n    .delay(1000)     //1,000 ms or 1 second\n    .duration(2000)  //2,000 ms or 2 seconds\n    …\n\nAs with `duration()` and `ease()`, the order here is somewhat flexible, but I\nlike to include `delay()` before `duration()`. That makes more sense to me\nbecause the delay happens first, followed by the transition itself.\n\nSee _13_delay_static.html_ , in which clicking the text triggers first a\n1,000-ms delay (in which nothing happens), followed by a 2,000-ms transition.\n\nStatic delays can be useful, but more exciting are delay values that we\ncalculate dynamically. A common use of this is to generate staggered delays,\nso some elements transition before others. Staggered delays can assist with\nperception, as it’s easier for our eyes to follow an individual element’s\nmotion when it is slightly out of sync with its neighboring elements’ motion.\n\nTo do this, instead of giving `delay()` a static value, we give it a function,\nin typical D3 fashion:\n\n    \n    \n    …\n    .transition()\n    .delay(function(d, i) {\n        return i * 100;\n    })\n    .duration(500)\n    …\n\nJust as we’ve seen with other D3 methods, when given an anonymous function,\nthe datum bound to the current element is passed into `d`, and the index\nposition of that element is passed into `i`. So, in this case, as D3 loops\nthrough each element, the delay for each element is set to `i * 100`, meaning\neach subsequent element will be delayed 100 ms _more_ than the preceding\nelement.\n\nAll this is to say that we now have staggered transitions. Check out the\nbeautifully animated bars in _14_delay_dynamic.html_ and see for yourself.\n\nNote that I also decreased the duration to 500 ms to make it feel a bit\nsnappier. Also note that `duration()` sets the duration for each _individual\ntransition_ , not for all transitions in aggregate. So, for example, if 20\nelements have 500-ms transitions applied with no delay, then it will all be\nover in 500 ms, or one-half second. But if a 100-ms delay is applied to each\nsubsequent element (`i * 100`), then the total running time of all transitions\nwill be 2,400 ms:\n\n    \n    \n    Max value of i times 100ms delay plus 500ms duration =\n    19 * 100 + 500 =\n    2400\n\nBecause these delays are being calculated on a per-element basis, if you added\nmore data, then the total running time of all transitions will increase. This\nis something to keep in mind if you have a dynamically loaded dataset with a\nvariable array length. If you suddenly loaded 10,000 data points instead of\n20, you could spend a long, long time watching those bars wiggle around\n(1,000,400 seconds or 11.5 days to be precise). Suddenly, they’re not so cute\nanymore.\n\nFortunately, we can _scale_ our delay values dynamically to the length of the\ndataset. This isn’t fancy D3 stuff; it’s just math.\n\nSee _15_delay_dynamic_scaled.html_ , in which 30 values are included in the\ndataset. If you get out your stopwatch, you’ll see that the total transition\ntime is 1.5 seconds, or around 1,500 ms.\n\nNow see _16_delay_dynamic_scaled_fewer.html_ , which uses exactly the same\ntransition code, but with only 10 data points. Notice how the delays are\nslightly longer (well, 200 percent longer), so the total transition time is\nthe same: 1.5 seconds! How is this possible?\n\n    \n    \n    …\n    .transition()\n    .delay(function(d, i) {\n        return i / dataset.length * 1000;   // <-- Where the magic happens\n    })\n    .duration(500)\n    …\n\nThe two preceding sample pages use the same delay calculations here. Instead\nof multiplying `i` by some static amount, we first divide `i` by\n`dataset.length`, in effect normalizing the value. Then, that normalized value\nis multiplied by `1000`, or 1 second. The result is that the maximum amount of\ndelay for the last element will be `1000`, and all prior elements will be\ndelayed by some amount less than that. A max delay of `1000` plus a duration\nof `500` equals 1.5 seconds total transition time.\n\nThis approach to delays is great because it keeps our code _scalable_. The\ntotal duration will be tolerable whether we have only 10 data points or\n10,000.\n\n### Randomizing the Data\n\nJust to illustrate how cool this is, let’s repurpose our random number\ngenerating code from [Chapter\n5](part0009_split_000.html#8IL22-8a8b0c18aaaf4f5c9d772f6d0c5087fc) here, so we\ncan update the chart as many times as we want, with new data each time.\n\nDown in our click-update function, let’s replace the static `dataset` with a\nrandomly generated one:\n\n    \n    \n    //New values for dataset\n    var numValues = dataset.length;               //Count original length of dataset\n    dataset = [];                                       //Initialize empty array\n    for (var i = 0; i < numValues; i++) {               //Loop numValues times\n        var newNumber = Math.floor(Math.random() * 25); //New random integer (0-24)\n        dataset.push(newNumber);                        //Add new number to array\n    }\n\nThis will overwrite `dataset` with an array of random integers with values\nbetween 0 and 24. The new array will be the same length as the original array.\n\nThen, I’ll update the paragraph text:\n\n    \n    \n    <p>Click on this text to update the chart with new data values\n    as many times as you like!</p>\n\nNow open up _17_randomized_data.html_ , and you should see something like\n[Figure 9-7](part0013_split_003.html#Initial_view).\n\n![Initial view](../images/00103.jpeg)\n\nFigure 9-7. Initial view\n\nEvery time you click the paragraph at top, the code will do the following:\n\n  1. Generate new, random values. \n  2. Bind those values to the existing elements. \n  3. Transition elements to new positions, heights, and colors, using the new values (see [Figure 9-8](part0013_split_003.html#Random_data_applied)). \n\n![Random data applied](../images/00104.jpeg)\n\nFigure 9-8. Random data applied\n\nPretty cool! If this does not feel pretty cool or even a little cool to you,\nplease turn off your computer and go for a short walk to clear your head,\nthereby making room for all the coolness to come. If, however, you are\nsufficiently cooled by this knowledge, read on.\n\n### Updating Scales\n\nAstute readers might take issue with this line from earlier:\n\n    \n    \n    var newNumber = Math.floor(Math.random() * 25);\n\nWhy 25? In programming, this is referred to as a _magic number_. I know, it\nsounds fun, but the problem with magic numbers is that it’s difficult to tell\nwhy they exist (hence, the “magic”). Instead of `25`, something like\n`maxValue` would be more meaningful:\n\n    \n    \n    var newNumber = Math.floor(Math.random() * maxValue);\n\nAh, see, now the magic is gone, and I can remember that `25` was acting as the\n_maximum value_ that could be calculated and put into `newNumber`. As a\ngeneral rule, it’s best to avoid magic numbers, and instead store those\nnumbers inside variables with meaningful names, like `maxValue` or\n`numberOfTimesWatchedTheMovieTopSecret`.\n\nMore important, I now remember that I arbitrarily chose `25` because values\nlarger than that exceeded the range of our chart’s scale, so those bars were\ncut off. For example, in [Figure\n9-9](part0013_split_003.html#Tootallwrongnumber), I replaced `25` with `50`.\n\n![Too tall! We used the wrong magic number!](../images/00105.jpeg)\n\nFigure 9-9. Too tall! We used the wrong magic number!\n\nThe real problem is not that I chose the _wrong_ magic number; it’s that our\n_scale_ needs to be updated whenever the dataset is updated. Whenever we plug\nin new data values, we should also recalibrate our scale to ensure that bars\ndon’t get too tall or too short.\n\nUpdating a scale is easy. You’ll recall we created `yScale` with this code:\n\n    \n    \n    var yScale = d3.scale.linear()\n                    .domain([0, d3.max(dataset)])\n                    .range([0, h]);\n\nThe _range_ can stay the same (as the visual size of our chart isn’t\nchanging), but after the new dataset has been generated, we should update the\nscale’s _domain_ :\n\n    \n    \n    //Update scale domain\n    yScale.domain([0, d3.max(dataset)]);\n\nThis sets the upper end of the input domain to the largest data value in\n`dataset`. Later, when we update all the bars and labels, we already reference\n`yScale` to calculate their positions, so no other code changes are necessary.\n\nCheck it out in _18_dynamic_scale.html_. I went ahead and replaced our magic\nnumber `25` with `maxValue`, which I set here to `100`. So now when we click\nto update, we get random numbers between 0 and 100. If the _maximum_ value in\nthe dataset is 100, then `yScale`’s domain will go up to 100, as we see in\n[Figure\n9-10](part0013_split_003.html#Randomdatabuttheyaxisscaleautomaticallyaccommodates).\n\n![Random data, but the y-axis scale automatically\naccommodates](../images/00106.jpeg)\n\nFigure 9-10. Random data, but the y-axis scale automatically accommodates\n\nBut because the numbers are random, they won’t always reach that maximum value\nof 100. In [Figure\n9-11](part0013_split_003.html#Aslightlydifferentscaleduetoslightlydifferentdata),\nthey top out at 85.\n\n![A slightly different scale, due to slightly different\ndata](../images/00107.jpeg)\n\nFigure 9-11. A slightly different scale, due to slightly different data\n\nNote that the height of the 100 bar in the first chart is _the same_ as the\nheight of the 85 bar here. The data is changing; the scale input domain is\nchanging; the output visual range does _not_ change.\n\n### Updating Axes\n\nThe bar chart doesn’t have any axes, but our scatterplot from the last chapter\ndoes ([Figure\n9-12](part0013_split_003.html#Updatedscatterplotnowwithdataupdatesanddynamicscales)).\nI’ve brought it back, with a few tweaks, in _19_axes_static.html_.\n\n![Updated scatterplot, now with data updates and dynamic\nscales](../images/00108.jpeg)\n\nFigure 9-12. Updated scatterplot, now with data updates and dynamic scales\n\nTo summarize the changes to the scatterplot:\n\n  * You can now click the text at top to generate and update with new data. \n  * Animated transitions are used after data updates. \n  * I eliminated the staggered delay, and set all transitions to occur over a full second (1,000 ms). \n  * Both the x- and y-axis scales are updated, too. \n  * Circles now have a constant radius. \n\nTry clicking the text and watch all those little dots zoom around. Cute! I\nsort of wish they represented some meaningful information, but hey, random\ndata can be fun, too.\n\nWhat’s _not_ happening yet is that the axes aren’t updating. Fortunately, that\nis simple to do.\n\nFirst, I am going to add the class names `x` and `y` to our x- and y-axes,\nrespectively. This will help us select those axes later:\n\n    \n    \n    //Create x-axis\n    svg.append(\"g\")\n        .attr(\"class\", \"x axis\")    // <-- Note x added here\n        .attr(\"transform\", \"translate(0,\" + (h - padding) + \")\")\n        .call(xAxis);\n    \n    //Create y-axis\n    svg.append(\"g\")\n        .attr(\"class\", \"y axis\")    // <-- Note y added here\n        .attr(\"transform\", \"translate(\" + padding + \",0)\")\n        .call(yAxis);\n\nThen, down in our click function, we simply add:\n\n    \n    \n    //Update x-axis\n    svg.select(\".x.axis\")\n        .transition()\n        .duration(1000)\n        .call(xAxis);\n    \n    //Update y-axis\n    svg.select(\".y.axis\")\n        .transition()\n        .duration(1000)\n        .call(yAxis);\n\nFor each axis, we do the following:\n\n  1. Select the axis. \n  2. Initiate a transition. \n  3. Set the transition’s duration. \n  4. Call the appropriate axis generator. \n\nRemember that each axis generator is already referencing a scale (either\n`xScale` or `yScale`). Because those scales are being updated, the axis\ngenerators can calculate what the new tick marks should be.\n\nOpen up _20_axes_dynamic.html_ and give it a try.\n\nOnce again, `transition()` handles all the interpolation magic for you — watch\nthose ticks fade in and out. Just beautiful, and you barely had to lift a\nfinger.\n\n### each() Transition Starts and Ends\n\nThere will be times when you want to make something happen at the start or end\nof a transition. In those times, you can use `each()` to execute arbitrary\ncode for each element in the selection.\n\n`each()` expects two arguments:\n\n  * Either `\"start\"` or `\"end\"`\n  * An anonymous function, to be executed either at the start of a transition, or as soon as it has ended \n\nFor example, here is our circle-updating code, with two `each()` statements\nadded:\n\n    \n    \n    //Update all circles\n    svg.selectAll(\"circle\")\n       .data(dataset)\n       .transition()\n       .duration(1000)\n       .each(\"start\", function() {      // <-- Executes at start of transition\n           d3.select(this)\n             .attr(\"fill\", \"magenta\")\n             .attr(\"r\", 3);\n       })\n       .attr(\"cx\", function(d) {\n            return xScale(d[0]);\n       })\n       .attr(\"cy\", function(d) {\n            return yScale(d[1]);\n       })\n       .each(\"end\", function() {        // <-- Executes at end of transition\n           d3.select(this)\n             .attr(\"fill\", \"black\")\n             .attr(\"r\", 2);\n       });\n\nYou can see this in action in _21_each.html_.\n\nNow you click the trigger, and immediately each circle’s fill is set to\nmagenta, and its radius is set to 3 (see [Figure\n9-13](part0013_split_003.html#Hotpinkcirclesinmidtransition)). Then the\ntransition is run, per usual. When complete, the fills and radii are restored\nto their original values.\n\n![Hot pink circles, midtransition](../images/00109.jpeg)\n\nFigure 9-13. Hot pink circles, midtransition\n\nSomething to note is that within the anonymous function passed to `each()`,\nthe context of `this` is maintained as “the current element.” This is handy\nbecause then `this` can be referenced with the function to easily reselect the\ncurrent element and modify it, as done here:\n\n    \n    \n       .each(\"start\", function() {\n           d3.select(this)              // Selects 'this', the current element\n             .attr(\"fill\", \"magenta\")   // Sets fill of 'this' to magenta\n             .attr(\"r\", 3);             // Sets radius of 'this' to 3\n       })\n\n#### Warning: Start carefully\n\nYou might be tempted to throw another transition in here, resulting in a\nsmooth fade from black to magenta. Don’t do it! Or do it, but note that this\nwill break:\n\n    \n    \n       .each(\"start\", function() {\n           d3.select(this)\n             .transition()              // New transition\n             .duration(250)             // New duration\n             .attr(\"fill\", \"magenta\")\n             .attr(\"r\", 3);\n       })\n\nIf you try this, and I recommend that you do, you’ll find that the circles do\nindeed fade to pink, but they no longer change positions in space. That’s\nbecause, by default, only one transition can be active on any given element at\nany given time. Newer transitions interrupt and override older transitions.\n\nThis might seem like a design flaw, but D3 operates this way on purpose.\nImagine if you had several different buttons, each of which triggered a\ndifferent view of the data, and a visitor was clicking through them in rapid\nsuccession. Wouldn’t you want an earlier transition to be interrupted, so the\nlast-selected view could be put in place right away?\n\nIf you’re familiar with jQuery, you’ll notice a difference here. By default,\njQuery queues transitions, so they execute one after another, and calling a\nnew transition doesn’t automatically interrupt any existing ones. This\nsometimes results in annoying interface behavior, like menus that fade in when\nyou mouse over them, but won’t start fading out until _after_ the fade-in has\ncompleted.\n\nIn this case, the code “breaks” because the first (spatial) transition is\nbegun, then `each(\"start\", …)` is called on each element. Within `each()`, a\nsecond transition is initiated (the fade to pink), overriding the first\ntransition, so the circles never make it to their final destinations (although\nthey look great, just sitting at home).\n\nBecause of this quirk of transitions, just remember that `each(\"start\", …)`\nshould be used only for immediate transformations, with no transitions.\n\n#### End gracefully\n\n`each(\"end\", …)`, however, _does_ support transitions. By the time\n`each(\"end\", …)` is called, the primary transition has already ended, so\ninitiating a new transition won’t cause any harm.\n\nSee _22_each_combo_transition.html_. Within the first `each()` statement, I\nbumped the pink circle radius size up to 7. In the second, I added two lines\nfor transition and a duration:\n\n    \n    \n    .each(\"end\", function() {\n        d3.select(this)\n          .transition()             // <-- New!\n          .duration(1000)           // <-- New!\n          .attr(\"fill\", \"black\")\n          .attr(\"r\", 2);\n    });\n\nWatch that transition: so cool! Note the sequence of events:\n\n  1. You click the `p` text. \n  2. Circles turn pink and increase in size immediately. \n  3. Circles transition to new positions. \n  4. Circles transition to original color and size. \n\nAlso, try clicking on the `p` trigger several times in a row. Go ahead, just\ngo nuts, click as fast as you can. Notice how each click interrupts the\ncircles’ progress. (Sorry, guys!) You’re seeing each new transition request\noverride the old one. The circles will never reach their final positions and\nfade to black unless you stop clicking and give them time to rest.\n\nAs cool as that is, there is an even simpler way to schedule multiple\ntransitions to run one after the other: we simply chain transitions together.\n(This is a new feature in version 3.0 and won’t work with older versions.) For\nexample, instead of reselecting elements and calling a new transition on each\none within `each(\"end\", …)`, we can just tack a second transition onto the end\nof the chain:\n\n    \n    \n    svg.selectAll(\"circle\")\n       .data(dataset)\n       .transition()    // <-- Transition #1\n       .duration(1000)\n       .each(\"start\", function() {\n               d3.select(this)\n                 .attr(\"fill\", \"magenta\")\n                 .attr(\"r\", 7);\n       })\n       .attr(\"cx\", function(d) {\n                    return xScale(d[0]);\n       })\n       .attr(\"cy\", function(d) {\n                    return yScale(d[1]);\n       })\n       .transition()    // <-- Transition #2\n       .duration(1000)\n       .attr(\"fill\", \"black\")\n       .attr(\"r\", 2);\n\nTry that code out in _23_each_combo_transition_chained.html_ , and you’ll see\nit has the same behavior.\n\nWhen sequencing multiple transitions, I recommend this chaining approach. Then\nonly use `each()` for immediate (nontransitioned) changes that need to occur\nright before or right after transitions. As you can imagine, it’s possible to\ncreate quite complex sequences of discrete and animated changes by chaining\ntogether multiple transitions, each of which can have its own calls to\n`each(\"start\", …)` and `each(\"end\", …)`.\n\n#### Transitionless each()\n\nYou can also use `each()` outside of a transition, just to execute arbitrary\ncode for each element in a selection. Outside of transitions, just omit the\n`\"start\"` or `\"end\"` parameter, and only pass in the anonymous function.\n\nAlthough I didn’t do this here, you can also include references to `d` and `i`\nwithin your function definition, and D3 will hand off those values, as you’d\nexpect:\n\n    \n    \n    …\n    .each(function(d, i) {\n        //Do something with d and i here\n    });\n\n#### Containing visual elements with clipping paths\n\nOn a slightly related note, you might have noticed that during these\ntransitions, points with low x or y values would exceed the boundaries of the\nchart area, and overlap the axis lines, as displayed in [Figure\n9-14](part0013_split_003.html#Pointsexceedingthechartarea).\n\n![Points exceeding the chart area](../images/00110.jpeg)\n\nFigure 9-14. Points exceeding the chart area\n\nFortunately, SVG has support for _clipping paths_ , which might be more\nfamiliar to you as _masks_ , as in Photoshop or Illustrator. A clipping path\nis an SVG element that contains visual elements that, together, make up the\nclipping path or mask to be applied to other elements. When a mask is applied\nto an element, only the pixels that land within that mask’s shape are\ndisplayed.\n\nMuch like `g`, a `clipPath` has no visual presence of its own, but it contains\nvisual elements (which are used to make the mask). For example, here’s a\nsimple `clipPath`:\n\n    \n    \n    <clipPath id=\"chart-area\">\n        <rect x=\"30\" y=\"30\" width=\"410\" height=\"240\"></rect>\n    </clipPath>\n\nNote that the outer `clipPath` element has been given an ID of `chart-area`.\nWe can use that ID to reference it later. Within the `clipPath` is a `rect`,\nwhich will function as the mask.\n\nSo there are three steps to using a clipping path:\n\n  1. Define the `clipPath` and give it an ID. \n  2. Put visual elements within the `clipPath` (usually just a `rect`, but this could be `circle`s or any other visual elements). \n  3. Add a reference to the `clipPath` from whatever element(s) you wish to be masked. \n\nContinuing with the scatterplot, I’ll define the clipping path with this new\ncode (steps 1 and 2):\n\n    \n    \n    //Define clipping path\n    svg.append(\"clipPath\")                  //Make a new clipPath\n        .attr(\"id\", \"chart-area\")           //Assign an ID\n        .append(\"rect\")                     //Within the clipPath, create a new rect\n        .attr(\"x\", padding)                 //Set rect's position and size…\n        .attr(\"y\", padding)\n        .attr(\"width\", w - padding * 3)\n        .attr(\"height\", h - padding * 2);\n\nI want all of the `circle`s to be masked by this `clipPath`. I could add a\n`clipPath` reference to every single circle, but it’s much easier and cleaner\nto just put all the `circle`s into a `g` group, and then add the reference to\nthat (this is step 3).\n\nSo, I will modify this code:\n\n    \n    \n    //Create circles\n    svg.selectAll(\"circle\")\n       .data(dataset)\n       .enter()\n       .append(\"circle\")\n       …\n\nby adding three new lines, creating a new `g`, giving it an arbitrary ID, and\nfinally adding the reference to the `chart-area` `clipPath`:\n\n    \n    \n    //Create circles\n    svg.append(\"g\")                             //Create new g\n       .attr(\"id\", \"circles\")                   //Assign ID of 'circles'\n       .attr(\"clip-path\", \"url(#chart-area)\")   //Add reference to clipPath\n       .selectAll(\"circle\")                     //Continue as before…\n       .data(dataset)\n       .enter()\n       .append(\"circle\")\n       …\n\nNotice that the attribute name is `clip-path`, and the element name is\n`clipPath`. Argh! I know; it drives me crazy, too.\n\nView the sample page _24_clip-path.html_ and open the web inspector. Let’s\nlook at that new `rect` in [Figure\n9-15](part0013_split_003.html#ThedimensionsofarectwithinaclipPath).\n\n![The dimensions of a rect within a clipPath](../images/00111.jpeg)\n\nFigure 9-15. The dimensions of a rect within a clipPath\n\nBecause `clipPath`s have no visual rendering (they only mask other elements),\nit’s helpful to highlight them in the web inspector, which will then outline\nthe path’s position and size with a blue highlight. In [Figure\n9-15](part0013_split_003.html#ThedimensionsofarectwithinaclipPath) we can see\nthat the `clipPath rect` is in the right place and is the right size.\n\nNotice, too, that now all the `circle`s are grouped within a single `g`\nelement, whose `clip-path` attribute references our new clipping path, using\nthe slightly peculiar syntax `url(#chart-area)`. Thanks for that, SVG\nspecification.\n\nThe end result is that our `circle`s’ pixels get clipped when they get too\nclose to the edge of the chart area. Note the points at the extreme top and\nright edges.\n\nThe clipping is easier to see midtransition, as in [Figure\n9-16](part0013_split_003.html#Pointscontainedwithinthechartarea).\n\n![Points contained within the chart area](../images/00112.jpeg)\n\nFigure 9-16. Points contained within the chart area\n\nVoilà! The points no longer exceed the chart boundaries.\n\n\n## Other Kinds of Data Updates\n\nUntil now, when updating data, we have taken the “whole kit-and-kaboodle”\napproach: changing values in the dataset array, and then rebinding that\nrevised dataset, overwriting the original values bound to our DOM elements.\n\nThat approach is most useful when _all_ the values are changing, and when the\nlength of the dataset (i.e., the number of values) stays the same. But as we\nknow, real-life data is messy, and calls for even more flexibility, such as\nwhen you only want to update one or two values, or you even need to add or\nsubtract values. D3, again, comes to the rescue.\n\n### Adding Values (and Elements)\n\nLet’s go back to our lovely bar chart, and say that some user interaction (a\nmouse click) should now trigger adding a _new_ value to our dataset. That is,\nthe length of the array `dataset` will increase by one.\n\nWell, generating a random number and pushing it to the array is easy enough:\n\n    \n    \n    //Add one new value to dataset\n    var maxValue = 25;\n    var newNumber = Math.floor(Math.random() * maxValue);\n    dataset.push(newNumber);\n\nMaking room for an extra bar will require recalibrating our x-axis scale.\nThat’s just a matter of updating its input domain to reflect the new length of\n`dataset`:\n\n    \n    \n    xScale.domain(d3.range(dataset.length));\n\nThat’s the easy stuff. Now prepare to bend your brain yet again, as we dive\ninto the depths of D3 _selections_.\n\n#### Select\n\nBy now, you are comfortable using `select()` and `selectAll()` to grab and\nreturn DOM element selections. And you’ve even seen how, when these methods\nare chained, they grab selections within selections, and so on, as in:\n\n    \n    \n    d3.select(\"body\").selectAll(\"p\");   //Returns all 'p' elements within 'body'\n\nWhen storing the _results_ of these selection methods, the most specific\nresult — meaning the result of the last selector in the chain — is the\nreference handed off to the variable. For example:\n\n    \n    \n    var paragraphs = d3.select(\"body\").selectAll(\"p\");\n\nNow `paragraphs` contains a selection of all `p` elements in the DOM, even\nthough we traversed through `body` to get there.\n\nThe twist here is that the `data()` method _also_ returns a selection.\nSpecifically, `data()` returns references to all elements to which data was\njust bound, which we call the _update_ selection.\n\nIn the case of our bar chart, this means that we can select all the bars, then\nrebind the new data to those bars, and grab the update selection all in one\nfell swoop:\n\n    \n    \n    //Select…\n    var bars = svg.selectAll(\"rect\")\n        .data(dataset);\n\nNow the update selection is stored in `bars`.\n\n#### Enter\n\nWhen we changed our data values, but not the _length_ of the whole data set,\nwe didn’t have to worry about an update selection — we simply rebound the\ndata, and transitioned to new attribute values.\n\nBut now we have _added_ a value. So `dataset.length` was originally 20, but\nnow it is 21. How can we address that new data value, specifically, to draw a\nnew `rect` for it? Stay with me here; your patience will be rewarded.\n\nThe genius of the update selection is that it contains within it references to\n_enter_ and _exit_ subselections.\n\n_Entering_ elements are those that are new to the scene. It’s considered good\nform to welcome such elements to the neighborhood with a plate of cookies.\n\nWhenever there are more data values than corresponding DOM elements, the\n_enter_ selection contains references to those elements _that do not yet\nexist_. You already know how to access the enter selection: by using `enter()`\nafter binding the new data, as we do when first creating the bar chart. You\nhave already seen the following code:\n\n    \n    \n    svg.selectAll(\"rect\") //Selects all rects (as yet nonexistent)\n       .data(dataset)     //Binds data to selection, returns update selection\n       .enter()           //Extracts the enter selection, i.e., 20 placeholder elements\n       .append(\"rect\")    //Creates a 'rect' inside each of the placeholder elements\n       …\n\nYou have already seen this sequence of\n`selectAll()`→`data()`→`enter()`→`append()` many times, but only in the\ncontext of creating many elements at once, when the page first loads.\n\nNow that we have added one value to `dataset`, we can use `enter()` to address\nthe one new corresponding DOM element, without touching all the existing\n`rect`s. Following the preceding `Select` code, I’ll add:\n\n    \n    \n    //Enter…\n    bars.enter()\n        .append(\"rect\")\n        .attr(\"x\", w)\n        .attr(\"y\", function(d) {\n            return h - yScale(d);\n        })\n        .attr(\"width\", xScale.rangeBand())\n        .attr(\"height\", function(d) {\n            return yScale(d);\n        })\n        .attr(\"fill\", function(d) {\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n        });\n\nRemember, `bars` contains the update selection, so `bars.enter()` extracts the\nenter selection from that. In this case, the enter selection is one reference\nto one new DOM element. We follow that with `append()` to create the new\n`rect`, and all the other `attr()` statements as usual, except for the\nfollowing line:\n\n    \n    \n    .attr(\"x\", w)\n\nYou might notice that this sets the horizontal position of the new `rect` to\nbe just past the far right edge of the SVG. I want the new bar to be created\njust out of sight, so I can use a nice, smooth transition to move it gently\ninto view.\n\n#### Update\n\nWe made the new `rect`; now all that’s left is to update all `rect`’s visual\nattributes. Again, `bars` here stores the complete update selection (which\nincludes the enter selection):\n\n    \n    \n    //Update…\n    bars.transition()\n        .duration(500)\n        .attr(\"x\", function(d, i) {\n            return xScale(i);\n        })\n        .attr(\"y\", function(d) {\n            return h - yScale(d);\n        })\n        .attr(\"width\", xScale.rangeBand())\n        .attr(\"height\", function(d) {\n            return yScale(d);\n        });\n\nThis has the effect of taking _all_ the bars and transitioning them to their\nnew x, y, width, and height values. Don’t believe me? See the working code in\n_25_adding_values.html_.\n\n[Figure 9-17](part0013_split_004.html#Initialbarchart) shows the initial\nchart.\n\n![Initial bar chart](../images/00113.jpeg)\n\nFigure 9-17. Initial bar chart\n\n[Figure 9-18](part0013_split_004.html#Afteroneclick) shows the chart after one\nclick on the text. Note the new bar on the right.\n\n![After one click](../images/00114.jpeg)\n\nFigure 9-18. After one click\n\nAfter two clicks, we get the chart shown in [Figure\n9-19](part0013_split_004.html#Aftertwoclicks). [Figure\n9-20](part0013_split_004.html#Afterthreeclicks) shows the result after three\nclicks.\n\n![After two clicks](../images/00115.jpeg)\n\nFigure 9-19. After two clicks\n\n![After three clicks](../images/00116.jpeg)\n\nFigure 9-20. After three clicks\n\nAfter several more clicks, you’ll see the chart shown in [Figure\n9-21](part0013_split_004.html#Aftermanyclicks).\n\n![After many clicks](../images/00117.jpeg)\n\nFigure 9-21. After many clicks\n\nNot only are new bars being created, sized, and positioned, but on every\nclick, _all other bars_ are rescaled and moved into position as well.\n\nWhat’s _not_ happening is that new value labels aren’t being created and\ntransitioned into place. I leave that as an exercise for you to pursue.\n\n### Removing Values (and Elements)\n\nRemoving elements is easier.\n\nWhenever there are more DOM elements than data values, the _exit_ selection\ncontains references to those elements without data. As you’ve already guessed,\nwe can access the exit selection with `exit()`.\n\nFirst, I’ll change our trigger text to indicate we’re removing values:\n\n    \n    \n    <p>Click on this text to remove a data value from the chart!</p>\n\nThen, on click, instead of generating a new random value and adding it to\n`dataset`, we’ll use `shift()`, which removes the first element from the\narray:\n\n    \n    \n    //Remove one value from dataset\n    dataset.shift();\n\n#### Exit\n\n _Exiting_ elements are those that are on their way out. We should be polite\nand wish these elements a safe journey.\n\nSo we grab the exit selection, transition the exiting element off to the right\nside, and, finally, remove it:\n\n    \n    \n    //Exit…\n    bars.exit()\n        .transition()\n        .duration(500)\n        .attr(\"x\", w)\n        .remove();\n\n`remove()` is a special transition method that waits until the transition is\ncomplete, and then deletes the element from the DOM forever. (Sorry, there’s\nno getting it back.)\n\n#### Making a smooth exit\n\nVisually speaking, it’s good practice to perform a transition first, rather\nthan simply `remove()` elements right away. In this case, we’re moving the bar\noff to the right, but you could just as easily transition `opacity` to zero,\nor apply some other visual transition.\n\nThat said, if you ever need to just get rid of an element ASAP, by all means,\nyou can use `remove()` without calling a transition first.\n\nOkay, now try out the code in _26_removing_values.html_. [Figure\n9-22](part0013_split_004.html#Initial_bar_chart) shows the initial view.\n\n![Initial bar chart](../images/00118.jpeg)\n\nFigure 9-22. Initial bar chart\n\nThen, after one click on the text, note the loss of one bar in [Figure\n9-23](part0013_split_004.html#After_one_click).\n\n![After one click](../images/00119.jpeg)\n\nFigure 9-23. After one click\n\nAfter two clicks, you’ll see the chart in [Figure\n9-24](part0013_split_004.html#After_two_clicks). [Figure\n9-25](part0013_split_004.html#After_three_clicks) shows what displays after\nthree clicks.\n\n![After two clicks](../images/00120.jpeg)\n\nFigure 9-24. After two clicks\n\n![After three clicks](../images/00121.jpeg)\n\nFigure 9-25. After three clicks\n\nAfter many clicks, the result is shown in [Figure\n9-26](part0013_split_004.html#After_many_clicks).\n\n![After many clicks](../images/00122.jpeg)\n\nFigure 9-26. After many clicks\n\nOn each click, one bar moves off to the right, and then is removed from the\nDOM. (You can confirm this with the web inspector.)\n\nBut what’s not working as expected? For starters, the value labels aren’t\nbeing removed, so they clutter up the top right of our chart. Again, I will\nleave fixing this aspect as an exercise to you.\n\nMore important, although we are using the `Array.shift()` method to remove the\n_first_ value from the `dataset` array, it’s not the _first_ bar that is\nremoved, is it? Instead, the last bar in the DOM, the one visually on the far\nright, is always removed. Although the data values are updating correctly\n(note how they move to the left with each click — 5, 10, 13, 19, and so on),\nthe bars are assigned new values, rather than “sticking” with their intial\nvalues. That is, the anticipated _object constancy_ is broken — the “5” bar\nbecomes the “10” bar, and so on, yet perceptually we would prefer that the “5”\nbar simply scoot off to the left and let all the other bars keep their\noriginal values.\n\nWhy, why, oh, why is this happening?! Not to worry; there’s a perfectly\nreasonable explanation. The key to maintaining object constancy is, well,\nkeys. (On a side note, Mike Bostock has a very eloquent [overview of the value\nof object constancy](http://bost.ocks.org/mike/constancy/), which I\nrecommend.)\n\n### Data Joins with Keys\n\nNow that you understand update, enter, and exit selections, it’s time to dig\ndeeper into data joins.\n\nA data join happens whenever you bind data to DOM elements; that is, every\ntime you call `data()`.\n\nThe default join is by _index order_ , meaning the first data value is bound\nto the first DOM element in the selection, the second value is bound to the\nsecond element, and so on.\n\nBut what if the data values and DOM elements are not in the same order? Then\nyou need to tell D3 how to join or pair values and elements. Fortunately, you\ncan define those rules by specifying a _key function_.\n\nThis explains the problem with our bars. After we remove the first value from\nthe `dataset` array, we rebind the new `dataset` on top of the existing\nelements. Those values are joined in index order, so the first `rect`, which\noriginally had a value of 5, is now assigned 10. The former 10 bar is assigned\n13, and so on. In the end, that leaves one `rect` element without data — the\nlast one on the far right.\n\nWe can use a _key function_ to control the data join with more specificity and\nensure that the right datum is bound to the right `rect` element.\n\n#### Preparing the data\n\nUntil now, our dataset has been a simple array of values. But to use a key\nfunction, each value must have some “key” associated with it. Think of the key\nas a means of identifying the value without looking at the value itself, as\nthe values themselves might change or exist in duplicate form. (If there were\ntwo separate values of `3`, how could you tell them apart?)\n\nInstead of an array of values, let’s use an array of _objects_ , within which\neach object can contain both a key value and the actual data value:\n\n    \n    \n    var dataset = [ { key: 0, value: 5 },\n                    { key: 1, value: 10 },\n                    { key: 2, value: 13 },\n                    { key: 3, value: 19 },\n                    { key: 4, value: 21 },\n                    { key: 5, value: 25 },\n                    { key: 6, value: 22 },\n                    { key: 7, value: 18 },\n                    { key: 8, value: 15 },\n                    { key: 9, value: 13 },\n                    { key: 10, value: 11 },\n                    { key: 11, value: 12 },\n                    { key: 12, value: 15 },\n                    { key: 13, value: 20 },\n                    { key: 14, value: 18 },\n                    { key: 15, value: 17 },\n                    { key: 16, value: 16 },\n                    { key: 17, value: 18 },\n                    { key: 18, value: 23 },\n                    { key: 19, value: 25 } ];\n\nRemember, hard brackets `[]` indicate an array, and curly brackets `{}`\nindicate an object.\n\nNote that the data values here are unchanged from our original `dataset`.\nWhat’s new are the keys, which just enumerate each object’s original position\nwithin the `dataset` array. (By the way, your chosen key name doesn’t have to\nbe `key` — the name can be anything, like `id`, `year`, or `fruitType`. I am\nusing `key` here for simplicity.)\n\n#### Updating all references\n\nThe next step isn’t fun, but it’s not hard. Now that our data values are\nburied within objects, we can no longer just reference `d`. (Ah, the good old\ndays.) Anywhere in the code where we want to access the actual data _value_ ,\nwe now need to specify `d.value`. When we use anonymous functions within D3\nmethods, `d` is handed whatever is in the current position in the array. In\nthis case, each position in the array now contains an object, such as `{ key:\n12, value: 15 }`. So to get at the value `15`, we now must write `d.value` to\nreach _into_ the object and grab that `value` value. (I hope you see a lot of\nvalue in this paragraph.)\n\nFirst, that means a change to the `yScale` definition:\n\n    \n    \n    var yScale = d3.scale.linear()\n                    .domain([0, d3.max(dataset, function(d) { return d.value; })])\n                    .range([0, h]);\n\nIn the second line, we used to have simply `d3.max(dataset)`, but that only\nworks with a simple array. Now that we’re using objects, we have to include an\n_accessor function_ that tells `d3.max()` how to get at the correct values to\ncompare. So as `d3.max()` loops through all the elements in the `dataset`\narray, now it knows not to look at `d` (which is an object, and not easily\ncompared to other objects), but `d.value` (a number, which is easily compared\nto other numbers).\n\nNote we also need to change the second reference to `yScale`, down in our\nclick-update function:\n\n    \n    \n    yScale.domain([0, d3.max(dataset, function(d) { return d.value; })]);\n\nNext up, everywhere `d` is used to set attributes, we must change `d` to\n`d.value`. For example, this:\n\n    \n    \n    …\n    .attr(\"y\", function(d) {\n        return h - yScale(d);        // <-- d\n    })\n    …\n\nbecomes this:\n\n    \n    \n    …\n    .attr(\"y\", function(d) {\n        return h - yScale(d.value);  // <-- d.value!\n    })\n    …\n\n#### Key functions\n\nFinally, we define a key function, to be used whenever we bind data to\nelements:\n\n    \n    \n    var key = function(d) {\n        return d.key;\n    };\n\nNotice that, in typical D3 form, the function takes `d` as input. Then this\nvery simple function specifies to take the `key` value of whatever `d` object\nis passed into it.\n\nNow, in all four places where we bind data, we replace this line:\n\n    \n    \n    .data(dataset)\n\nwith this:\n\n    \n    \n    .data(dataset, key)\n\nNote that rather than defining the key function first, then referencing it,\nyou could of course simply write the key function directly into the call to\n`data()` like so:\n\n    \n    \n    .data(dataset, function(d) {\n        return d.key;\n    })\n\nBut in this case, you’d have to write that four times, which is redundant, so\nI think defining the key function once at the top is cleaner.\n\nThat’s it! Consider your data joined.\n\n#### Exit transition\n\nOne last tweak: Let’s set the exiting bar to scoot off to the left side\ninstead of the right:\n\n    \n    \n    //Exit…\n    bars.exit()\n        .transition()\n        .duration(500)\n        .attr(\"x\", -xScale.rangeBand())  // <-- Exit stage left\n        .remove();\n\nGreat! Check out the sample code, with all of those changes, in\n_27_data_join_with_key.html_. The initial view shown in [Figure\n9-27](part0013_split_004.html#Initial-bar-chart) is unchanged.\n\n![Initial bar chart](../images/00123.jpeg)\n\nFigure 9-27. Initial bar chart\n\nTry clicking the text, though, and the leftmost bar slides cleanly off to the\nleft, all other bars’ widths rescale to fit, and then the exited bar is\ndeleted from the DOM. (Again, you can confirm this by watching the `rect`s\ndisappear one by one in the web inspector.)\n\n[Figure 9-28](part0013_split_004.html#After-one-click) shows the view after\none bar is removed.\n\n![After one click](../images/00124.jpeg)\n\nFigure 9-28. After one click\n\nAfter two clicks, you’ll see the chart in [Figure\n9-29](part0013_split_004.html#After-two-clicks).\n\n![After two clicks](../images/00125.jpeg)\n\nFigure 9-29. After two clicks\n\n[Figure 9-30](part0013_split_004.html#After-three-clicks) displays the results\nafter three clicks, and after several clicks, you’ll see the result shown in\n[Figure 9-31](part0013_split_004.html#After-many-clicks).\n\n![After three clicks](../images/00126.jpeg)\n\nFigure 9-30. After three clicks\n\n![After many clicks](../images/00127.jpeg)\n\nFigure 9-31. After many clicks\n\nThis is working better than ever. The only hitch is that the labels aren’t\nexiting to the left, and also are not removed from the DOM, so they clutter up\nthe left side of the chart. Again, I leave this to you; put your new D3 chops\nto the test and clean up those labels.\n\n### Add and Remove: Combo Platter\n\nWe could stop there and be very satisfied with our newfound skills. But why\nnot go all the way, and adjust our chart so data values can be added _and_\nremoved?\n\nThis is easier than you might think. First, we’ll need two different triggers\nfor the user interaction. I’ll split the one paragraph into two, and give each\na unique ID, so we can tell which one is clicked:\n\n    \n    \n    <p id=\"add\">Add a new data value</p>\n    <p id=\"remove\">Remove a data value</p>\n\nLater, down where we set up the click function, `select()` must become\n`selectAll()`, now that we’re selecting more than one `p` element:\n\n    \n    \n    d3.selectAll(\"p\")\n        .on(\"click\", function() { …\n\nNow that this click function will be bound to both paragraphs, we have to\nintroduce some logic to tell the function to behave differently depending on\nwhich paragraph was clicked. There are many ways to achieve this; I’ll go with\nthe most straightforward one.\n\nFortunately, within the context of our anonymous click function, `this` refers\nto the element that was clicked — the paragraph. So we can get the ID value of\nthe clicked element by selecting `this` and inquiring using `attr()`:\n\n    \n    \n    d3.select(this).attr(\"id\")\n\nThat statement will return `\"add\"` when `p#add` is clicked, and `\"remove\"`\nwhen `p#remove` is clicked. Let’s store that value in a variable, and use it\nto control an `if` statement:\n\n    \n    \n    //See which p was clicked\n    var paragraphID = d3.select(this).attr(\"id\");\n    \n    //Decide what to do next\n    if (paragraphID == \"add\") {\n        //Add a data value\n        var maxValue = 25;\n        var newNumber = Math.floor(Math.random() * maxValue);\n        var lastKeyValue = dataset[dataset.length - 1].key;\n        console.log(lastKeyValue);\n        dataset.push({\n            key: lastKeyValue + 1,\n            value: newNumber\n        });\n    } else {\n        //Remove a value\n        dataset.shift();\n    }\n\nSo, if `p#add` is clicked, we calculate a new random value, and then look up\nthe key value of the last item in `dataset`. Then we create a new object with\nan incremented key (to ensure we don’t duplicate keys; insert locksmith joke\nhere) and the random data value.\n\nNo additional changes are needed! The enter/update/exit code we wrote is\nalready flexible enough to handle adding _or_ removing data values — that’s\nthe beauty of it.\n\nTry it out in _28_adding_and_removing.html_. You’ll see that you can click to\nadd or remove data points at will. Of course, real-world data isn’t created\nthis way, but you can imagine these data updates being triggered by some other\nevent — such as data refreshes being pulled from a server — and not mouse\nclicks.\n\nAlso see _29_dynamic_labels.html_ , which is the same thing, only I’ve updated\nthe code to add, transition, and remove the labels as well.\n\n### Recap\n\nThat was a lot of information! Let’s review:\n\n  * `data()` binds data to elements, but also returns the _update selection_.\n  * The update selection can contain _enter_ and _exit_ selections, which can be accessed via `enter()` and `exit()`. \n  * When there are _more values than elements_ , an enter selection will reference the placeholder, not-yet-existing elements. \n  * When there are _more elements than values_ , an exit selection will reference the elements without data. \n  * Data joins determine how values are matched with elements. \n  * By default, data joins are performed by index, meaning in order of appearance. \n  * For more control over data joins, you can specify a key function. \n\nAs a final note, in the bar chart example, we used this sequence:\n\n  1. Enter \n  2. Update \n  3. Exit \n\nAlthough this worked well for us, this order isn’t set in stone. Depending on\nyour design goals, you might want to update first, then enter new elements,\nand finally exit old ones. It all depends — just remember that once you have\nthe update selection in hand, you can reach in to grab the enter and exit\nselections anytime. The order in which you do so is flexible and completely up\nto you.\n\nFantastic. You are well on your way to becoming a D3 wizard. Now let’s get to\nthe really fun stuff: interactivity!\n\n\n## Chapter 10. Interactivity\n\nNow that you’re an old pro at data updates, transitions, and motion, let’s\nincorporate true interactivity.\n\n\n## Binding Event Listeners\n\nSay _what?_ I know, I know: First, we bound _data_ , which was weird enough.\nAnd now I’m talking about binding _event listeners?_ (This is how JavaScript\nearned its reputation for being such a strange language.)\n\nAs explained in [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), JavaScript\nuses an _event model_ in which “events” are triggered by things happening,\nsuch as new input from the user, provided via a keyboard, mouse, or touch\nscreen. Most of the time, events are being triggered constantly, left and\nright — it’s just that nobody is _listening_ for them, so they are ignored.\n\nTo make our pieces interactive, we define chunks of code that _listen_ for\nspecific events being triggered on specific DOM elements. In [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), we used\nthe following code:\n\n    \n    \n    d3.select(\"p\")\n        .on(\"click\", function() {\n            //Do something on click\n        });\n\nThis _binds_ an _event listener_ to the `p` paragraph element. The listener\nhappens to be listening for the `click` event, which is the JavaScript event\ntriggered when the user clicks the mouse _on that`p` element_. (D3 doesn’t use\ncustom event names, although you can define your own. For the sake of\nsupporting existing standards, D3 recognizes all the standard JavaScript\nevents, such as `mouseover` and `click`. The events supported vary somewhat by\nbrowser. Peter-Paul Koch’s [event compatibility\ntables](http://www.quirksmode.org/dom/events/) are a useful reference.)\n\nThis gets at one of the nuances of JavaScript’s event model, which is that\nevents don’t happen in a vacuum. Rather, they are always _called on_ a\nspecific element. So the code just shown isn’t activated whenever _any_ click\noccurs; it is run just when a click occurs _on the`p` element_.\n\nYou could achieve all this with raw JavaScript, but D3’s `on()` method is a\nhandy way to quickly bind event listeners to D3 selections. As you can see,\n`on()` takes two arguments: the event name, and an anonymous function to be\nexecuted when the event is triggered on the selected element.\n\nMaking your visualization interactive is a simple, two-step process that\nincludes:\n\n  1. Binding event listeners \n  2. Defining the behavior \n\n\n## Introducing Behaviors\n\nLet’s start by working with an earlier, static version of our bar chart. See\nsample code _01_start.html_.\n\nThe example code binds an event on only one element: `p`. This is an unusual\nusage for `on()`. More commonly, you will want to bind event listeners to more\nthan one element at a time, such as to _all_ of the visual elements in your\nvisualization. Fortunately, that is very easy to do. Instead of using\n`select()` to select only one element, use `selectAll()` to select multiple\nelements and pass that selection to `on()`.\n\nYou can even bind those event listeners right at the moment when you first\ncreate elements. For example, here is our existing code that creates our bar\nchart’s `rect`s, to which I’ve simply tacked on `on()`:\n\n    \n    \n    //Create bars\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       …   //Set attributes (omitted here)\n       .on(\"click\", function(d) {\n           //This will run whenever *any* bar is clicked\n       });\n\nWhen defining the anonymous function, you can reference `d`, or `d` and `i`,\nor neither, just as you’ve seen throughout D3. And then whatever code you put\nbetween the function’s brackets will execute on click.\n\nThis is a quick and easy way to verify your data values, for example:\n\n    \n    \n    .on(\"click\", function(d) {\n                 console.log(d);\n    });\n\nTry that code by running _02_click.html_ , open the JavaScript console, and\nclick on some bars. When you click on each bar, you should see that bar’s data\nvalue printed to the console. Nice!\n\n### Hover to Highlight\n\nHighlighting elements in response to mouse interaction is a common way to make\nyour visualization feel more responsive, and it can help users navigate and\nfocus on the data of interest.\n\nA simple hover effect can be achieved with CSS alone — no JavaScript required!\nThe CSS pseudoclass selector `:hover` can be used in combination with any\nother selector to select, well, that same thing, but when the mouse is\nhovering _over_ the element. Here, we select all SVG `rect`s and set their\nfill to `orange` (see [Figure\n10-1](part0014_split_002.html#simple_css_only_mouse_hover)):\n\n    \n    \n    rect:hover {\n            fill: orange;\n    }\n\n![A simple CSS-only mouse hover effect](../images/00128.jpeg)\n\nFigure 10-1. A simple CSS-only mouse hover effect\n\nSee _03_hover.html_ , and try it out yourself.\n\nCSS hover styling is fast and easy, but limited. There’s only so much you can\nachieve with `:hover`. Fortunately, recent browsers support applying the new\nCSS3 transitions on SVG elements. Try adding this above the `rect:hover` rule\nin that example:\n\n    \n    \n    rect {\n            -moz-transition: all 0.3s;\n            -o-transition: all 0.3s;\n            -webkit-transition: all 0.3s;\n            transition: all 0.3s;\n    }\n\nThis tells browsers (including Mozilla, Opera, and Webkit-based browsers) to\napply a 0.2-second transition to any changes to the `rect` elements. Run that,\nand you’ll see that the blue/orange switch no longer happens instantly, but\nsmoothly, over a brief 0.2-second period. Nice!\n\nYet these transitions can also be managed using JavaScript and D3, for\nadditional control and coordination with other parts of our visualization.\nLuckily for us, D3 handles all the hassle of transitions for us, so working\nwith JavaScript is not so bad. Let’s re-create the orange hover effect without\nCSS.\n\nInstead of referencing the `click` event, as we did earlier, we can call\n`on()` with `mouseover`, the JavaScript event equivalent of CSS’s `hover`:\n\n    \n    \n    .on(\"mouseover\", function() {\n            //Do something on mouseover of any bar\n    });\n\nNow we want to set the `fill` of _this_ bar (the one on which the `mouseover`\nevent is triggered) to orange. Yet we are operating in the context of an\nanonymous function — how could we possibly select the same element on which\nthe event was just triggered?\n\nThe answer is _this_. No, sorry, I mean `this`. Just select `this`, and set\nits fill to orange:\n\n    \n    \n    .on(\"mouseover\", function() {\n            d3.select(this)\n              .attr(\"fill\", \"orange\");\n    });\n\nAnother reason “real” programmers hate JavaScript is because of its\nnotoriously wishy washy use of the keyword `this`. In other languages, the\nmeaning of `this` is very clearly defined; not so in JavaScript. (jQuery fans\nare used to this debate.)\n\nFor our purposes, here is all you need to know:\n\n  * Context is important. \n  * Within anonymous functions, D3 automatically sets the context of `this` so it references “the current element upon which we are acting.” \n\nThe end result is that, when we hand off anonymous functions to any of D3’s\nmethods, we can reference `this` when trying to act on the current element.\n\nIndeed, you can see this (ha!) in action in _04_mouseover.html_ ([Figure\n10-2](part0014_split_002.html#using_d3)).\n\n![Using D3 to set an orange fill on mouseover](../images/00129.jpeg)\n\nFigure 10-2. Using D3 to set an orange fill on `mouseover`\n\nMove the mouse over a `rect`, the event listener for that `rect` is triggered,\nthat same `rect` is selected (as `this`), and then its fill is set to orange.\n\n[Figure 10-2](part0014_split_002.html#using_d3) looks good, but we should\nprobably restore each bar’s original color once the hover is over, meaning on\n`mouseout`:\n\n    \n    \n    .on(\"mouseout\", function(d) {\n            d3.select(this)\n          .attr(\"fill\", \"rgb(0, 0, \" + (d * 10) + \")\");\n    });\n\nPerfect! Try it yourself in _05_mouseout.html_. See [Figure\n10-3](part0014_split_002.html#results_d3).\n\n![Moving the mouse left to right, with fills set on mouseover and\nmouseout](../images/00130.jpeg)\n\nFigure 10-3. Moving the mouse left to right, with fills set on `mouseover` and\n`mouseout`\n\nI am really excited to have accomplished in eight lines of JavaScript what I\ndid originally with CSS in only three! (Not!)\n\nActually, what I _am_ excited about is to now make the outbound transition\nsilky smooth (see [Figure 10-4](part0014_split_002.html#smooth)). As you\nremember from [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc),\naccomplishing that involves adding only two lines of code, for `transition()`\nand `duration()`:\n\n    \n    \n    .on(\"mouseout\", function(d) {\n        d3.select(this)\n          .transition()\n          .duration(250)\n          .attr(\"fill\", \"rgb(0, 0, \" + (d * 10) + \")\");\n    });\n\nTry that out in _06_smoother.html_.\n\n![Moving the mouse left to right \\(Smooth Operator\nEdition\\)](../images/00131.jpeg)\n\nFigure 10-4. Moving the mouse left to right (Smooth Operator Edition)\n\n* * *\n\n### Pointer Events on Overlapping Elements\n\nMouse events are triggered only on elements with pixels that can be “touched”\nby the mouse. If two elements overlap, and the mouse moves over the element\nthat is “on top” (in other words, closer to the front), then the `mouseover`\nevent will be triggered on the frontmost element, and _not_ on the element\nbehind it.\n\nYou can see this in _06_smoother.html_. Mouse over any bar, and then move your\npointer directly above one of the value labels. You’ll see the bar fade back\nfrom orange to blue. The `text` elements are in front of the bars, so mousing\nover a label involves also _mousing out_ of the `rect` behind it. This is\ncounterintuitive because, visually, we haven’t left the `rect` at all, but as\nfar as JavaScript is concerned, we have.\n\nRemember that in SVG, elements placed later in the DOM are rendered visually\n“in front” of earlier elements. (See the section “Layering and Drawing Order”\nin [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc).)\n\nIn many cases, you might want mouse events on some elements (such as our value\nlabels) to be ignored. Luckily, this is as easy as applying one line of CSS to\nthe elements you wish to have ignored:\n\n    \n    \n    pointer-events: none;\n\nThis magically tells the browser “Hey, this element shouldn’t trigger any\npointer events (such as `click`, `mouseover`, or `mouseout`), so just behave\nas if this element isn’t here.” It lets events pass through to the next\nelement below it.\n\nUse normal CSS selectors to target the appropriate elements. For example, this\nwould apply that to all SVG `text` elements:\n\n    \n    \n    svg text {\n            pointer-events: none;\n    }\n\nOr, instead of including this in a stylesheet, you could specify the CSS with\nD3 directly when you create the `text` element, for example:\n\n    \n    \n    svg.append(\"text\")\n            …  //other stuff here\n            .style(\"pointer-events\", \"none\");\n\n* * *\n\n\n## Grouping SVG Elements\n\nNote that `g` group elements _do not_ , by themselves, trigger any mouse\nevents. The reason for this is that `g` elements have no pixels! Only their\nenclosed elements — like `rect`s, `circle`s, and `text` elements — have\npixels.\n\nYou can still bind event listeners to `g` elements. Just keep in mind that the\nelements within that `g` will then behave as a group. For example, if _any_ of\nthe enclosed elements are clicked or moused over, then the listener function\nwill be activated.\n\nThis technique can be quite useful when you have several visual elements that\nshould all act in concert. In our bar chart, for example, we could group\n`rect` and `text` elements each into their own groups. The element hierarchy\ncurrently looks like this:\n\n    \n    \n    svg\n            rect\n            rect\n            rect\n            …\n            text\n            text\n            text\n            …\n\nAfter grouping elements, it could look like this:\n\n    \n    \n    svg\n            g\n                    rect\n                    text\n            g\n                    rect\n                    text\n            …\n\nInstead of worrying about `pointer-events` and which element is on top, we\njust bind the event listener to the whole group. So clicking on some `text`\nwill trigger the same code as clicking on a `rect` because they’re both in the\nsame group.\n\nEven better, throw an invisible `rect` with a `fill` of `none` and `pointer-\nevents` value of `all` on the top of each group. Even though the `rect` is\ninvisible, it will still trigger mouse events, so you could have the `rect`\nspan the whole height of the chart. The net effect is that mousing _anywhere_\nin that column — even in “empty” whitespace above a short blue bar — would\ntrigger the highlight effect.\n\n### Click to Sort\n\nInteractive visualization is most powerful when it can provide different\n_views_ of the data, empowering the user to explore the information from\ndifferent angles.\n\nThe ability to _sort_ data is extremely important. And yes, as you just\nguessed, D3 makes it very easy to sort elements.\n\nContinuing with the bar chart, let’s add an event listener for the `click`\nevent, to which we bind an anonymous function that, in turn, will call a new\nfunction of our own creation, `sortBars()`.\n\n    \n    \n    …\n    .on(\"click\", function() {\n            sortBars();\n    });\n\nFor simplicity, we are binding this to every bar, but of course you could bind\nthis instead to a button or any other element, inside or outside of the SVG\nimage.\n\nAt the end of the code, let’s define this new function and store it in\n`sortBars`:\n\n    \n    \n    var sortBars = function() {\n    \n            svg.selectAll(\"rect\")\n               .sort(function(a, b) {\n                     return d3.ascending(a, b);\n               })\n               .transition()\n               .duration(1000)\n               .attr(\"x\", function(d, i) {\n                     return xScale(i);\n               });\n    \n    };\n\nYou can see this code in _07_sort.html_ and the result in [Figure\n10-5](part0014_split_003.html#click-to-sort). Try clicking any of the bars,\nand watch them reorganize.\n\n![The view after click-to-sort](../images/00132.jpeg)\n\nFigure 10-5. The view after click-to-sort\n\nWhen `sortBars()` is called, first we reselect all the `rect`s. Then we use\nD3’s handy `sort()` method, which reorders elements based on their bound data\nvalues. `sort()` needs to know how to decide which elements come first, and\nwhich later, so we pass into it a _comparator_ function.\n\nUnlike our anonymous functions so far, the comparator doesn’t take `d` (the\ncurrent datum) or `i` (the current index). Instead, it is passed _two values_\n, `a` and `b`, which represent the data values of two different elements. (You\ncould name them anything else; `a` and `b` are just the convention.) The\ncomparator will be called on every pair of elements in our array, comparing\n`a` to `b`, until, in the end, all the array elements are sorted per whatever\nrules we specify.\n\nWe specify _how_ `a` and `b` should be compared within the comparator.\nThankfully, D3 also provides a handful of comparison functions that spare us\nfrom writing more JavaScript. Here, we use `d3.ascending()`, into which both\n`a` and `b` are passed. Whichever one is bigger comes out the winner. And\n`sort()` loops through all the data values in this way until it has all the\nelements, er, sorted out. (Note that `d3.ascending` works well in this case,\nbecause our values are numbers. Comparing strings of text is a whole other can\nof worms.)\n\nFinally, our new order in place, we initiate a transition, set a duration of\none second, and then calculate the new `x` position for each `rect`. (This\n`attr` code is just copied from when we created the `rect`s initially.)\n\nThis works swimmingly, except for two catches.\n\nFirst, you’ll notice that we haven’t accounted for the value labels yet, so\nthey didn’t slide into place along with the bars. (I leave that to you as an\nexercise.)\n\nSecond, you might observe that if you mouse over some bars _while_ the\ntransition is occurring, those bars don’t fall properly into place (see\n[Figure 10-6](part0014_split_003.html#interrupted)).\n\n![Transitions, interrupted](../images/00133.jpeg)\n\nFigure 10-6. Transitions, interrupted\n\nYeeesh, that doesn’t look good.\n\nRemember from [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc) that newer\ntransitions interrupt and override older transitions. Clicking the bars\ninitiates one transition. Immediately mousing over a bar interrupts that\ninitial transition in order to run the `mouseover` highlight transition we\nspecified earlier. The end result is that those moused-over bars never make it\nto their final destinations.\n\nBut don’t worry. This example is just a good argument for keeping hover\neffects in CSS, while letting D3 and JavaScript manage the more visually\nintensive actions.\n\nIn _08_sort_hover.html_ , I’ve restored the CSS-only highlight and removed the\n`mouseover` and `mouseout` event listeners, so this transition conflict no\nlonger occurs. (The only downside is we no longer have those smooth orange-to-\nblue fades.)\n\nSo far, this sort only goes one direction. Let’s revise this so a second click\ntriggers a re-sort, placing the bars in descending order.\n\nTo remember the current state of the chart, we’ll need a Boolean variable:\n\n    \n    \n    var sortOrder = false;\n\nThen, in the `sortBars()` function, we should flip the value of `sortOrder`,\nso if it starts out `true`, it is changed to `false`, and vice versa:\n\n    \n    \n    var sortBars = function() {\n    \n            //Flip value of sortOrder\n            sortOrder = !sortOrder;\n    \n            …\n\nDown in the comparator function, we can add a bit of logic to say _if_\n`sortOrder` is `true`, then go ahead and sort the bars in _ascending_ order.\nOtherwise, use _descending_ order:\n\n    \n    \n            svg.selectAll(\"rect\")\n               .sort(function(a, b) {\n                            if (sortOrder) {\n                                    return d3.ascending(a, b);\n                            } else {\n                                    return d3.descending(a, b);\n                            }\n                    })\n                    …\n\nGive that a shot in _09_resort.html_. Now each time you click, the sort order\nreverses, as shown in [Figure 10-7](part0014_split_003.html#second-sort).\n\n![The second sort, now in descending order](../images/00134.jpeg)\n\nFigure 10-7. The second sort, now in descending order\n\nOne more thing would make this really nice: a per-element delay. (Remember\nthat whole “object constancy” thing?)\n\nAs you know, to do that, we just add a simple `delay()` statement after\n`transition()`:\n\n    \n    \n    …\n    .transition()\n    .delay(function(d, i) {\n            return i * 50;\n    })\n    .duration(1000)\n    …\n\nNow take a look at _10_delay.html_ , in which you can easily follow individual\nbars with your eyes as they move left and right during each sort.\n\n\n## Tooltips\n\nIn interactive visualizations, tooltips are small overlays that present data\nvalues. In many cases, it’s not necessary to label every individual data value\nin the default view, but that level of detail should still be accessible to\nusers. That’s where tooltips come in.\n\nIn this section, I present three different methods to constructing tooltips\nwith D3, ranging from the simplest to the most complex.\n\n### Default Browser Tooltips\n\nThese should be your first stop. A quick-and-dirty, functional but not pretty\noption, default browser tooltips are usually those ugly yellow boxes you see\nfloating over content when you hold your mouse still for too long. These are\nvery easy to make, and the browser manages the placements for you, but you\nhave zero control over how they look — that’s also set by the browser.\n\n[Figure 10-8](part0014_split_004.html#safari-tooltip) shows our bar chart,\nwith value labels removed, and default browser tooltips implemented. The\ntooltips show up after hovering the mouse over any bar for a few seconds.\n\n![A ridiculously simple default browser tooltip, as seen in\nSafari](../images/00135.jpeg)\n\nFigure 10-8. A ridiculously simple default browser tooltip, as seen in Safari\n\nSee _11_browser_tooltip.html_ for the code and a demo. To make these tooltips,\nsimply inject a `title` element into whatever element should have the tooltip\napplied. For example, after we create all those `rect`s:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       …\n\nwe can just tack on to the end of that chain:\n\n    \n    \n       .append(\"title\")\n       .text(function(d) {\n             return d;\n       });\n\n`append()` creates the new `title` element, and then `text()` sets its content\nto `d`, the bound value.\n\nWe could make this text a little less spare by prefixing it with something\n(see [Figure 10-9](part0014_split_004.html#default-tooltip)):\n\n    \n    \n       .append(\"title\")\n       .text(function(d) {\n             return \"This value is \" + d;\n       });\n\n![A default browser tooltip, with a prefix added](../images/00136.jpeg)\n\nFigure 10-9. A default browser tooltip, with a prefix added\n\nSee _12_browser_tooltip_text.html_ for that code.\n\n### SVG Element Tooltips\n\nFor more visual control over your tooltips, code them as SVG elements.\n\nAs usual, there are many different approaches you could take. I’ll suggest\nadding event listeners, so on each `mouseover`, a new value label is created,\nand on `mouseout` it is destroyed. (Another idea would be to pregenerate all\nthe labels, but then just show or hide them based on mouse hover status. Or\njust stick with one label, but show or hide it and change its position as\nneeded.)\n\nBack to the bars we go. We’ll add back in a `mouseover` event listener, in\nwhich we first get the `x` and `y` values for the current element (`this`,\nremember?). We’ll need this information to know where to place the new\ntooltip, so it appears nicely “on top of” the bar that’s triggering the\nrollover.\n\nWhen we retrieve those values, we wrap them in `parseFloat()`, which is a\nJavaScript function for “Hey, even if this information is a string of text,\nplease convert it to a floating point number for me.”\n\nLastly, I’m adding a bit to both the `x` and `y` values, to center the new\ntooltips near the top of any given bar:\n\n    \n    \n    .on(\"mouseover\", function(d) {\n    \n    //Get this bar's x/y values, then augment for the tooltip\n    var xPosition = parseFloat(d3.select(this).attr(\"x\")) + xScale.rangeBand() / 2;\n    var yPosition = parseFloat(d3.select(this).attr(\"y\")) + 14;\n\nThat’s the hard part. Now all we do is create the tooltip as a simple `text`\nelement, in this case, but of course you could add a background `rect` or do\nanything else here for visual effect:\n\n    \n    \n    //Create the tooltip label\n    svg.append(\"text\")\n      .attr(\"id\", \"tooltip\")\n      .attr(\"x\", xPosition)\n      .attr(\"y\", yPosition)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-family\", \"sans-serif\")\n      .attr(\"font-size\", \"11px\")\n      .attr(\"font-weight\", \"bold\")\n      .attr(\"fill\", \"black\")\n      .text(d);\n    \n    })\n\nYes, this is based on our earlier value label code, simply adapted slightly.\nNote that the `x` and `y` attributes are set to the new position values we\njust calculated, and the actual text content of the label is set to `d`, the\ndatum passed into the event listener function.\n\nAlso note that I assigned this next `text` element an ID of `tooltip`. This is\nso we can easily select (and delete!) the element when we’re done with it — on\n`mouseout`:\n\n    \n    \n    .on(\"mouseout\", function() {\n    \n    //Remove the tooltip\n    d3.select(\"#tooltip\").remove();\n    \n    })\n\nTest out the code in _13_svg_tooltip.html_.\n\nAs you can see in [Figure 10-10](part0014_split_004.html#element-tooltip), you\nhave much more visual control when using SVG elements as tooltips, but they\nare a little more time-consuming to set up. And of course, you can get much\nfancier than this simple example.\n\n![An SVG element tooltip](../images/00137.gif)\n\nFigure 10-10. An SVG element tooltip\n\n### HTML div Tooltips\n\nA similar approach can be used with HTML `div` elements as tooltips. You might\nconsider using a `div` when:\n\n  * You want to achieve a visual effect that isn’t possible or well-supported with SVG (such as CSS drop shadows) \n  * You need the tooltips to extend beyond the frame of the SVG image\n\nSee Figures [10-11](part0014_split_004.html#div-tooltip) and\n[10-12](part0014_split_004.html#overlapping-tooltip) for examples.\n\n![An HTML div tooltip](../images/00138.jpeg)\n\nFigure 10-11. An HTML div tooltip\n\n![An HTML div tooltip, overlapping the bounds of the SVG image\nbeneath](../images/00139.jpeg)\n\nFigure 10-12. An HTML div tooltip, overlapping the bounds of the SVG image\nbeneath\n\nAgain, there are many ways to do this, but I like to make a hidden `div` in my\nHTML that gets populated with the data value, and is then unhidden when\ntriggered. You can follow along with the final code in _14_div_tooltip.html_.\n\nThe `div` itself could be created dynamically with D3, but I like to just type\nit in by hand:\n\n    \n    \n    <div id=\"tooltip\" class=\"hidden\">\n            <p><strong>Important Label Heading</strong></p>\n            <p><span id=\"value\">100</span>%</p>\n    </div>\n\nNow it’s going to need some special CSS styling rules:\n\n    \n    \n    #tooltip {\n            position: absolute;\n            width: 200px;\n            height: auto;\n            padding: 10px;\n            background-color: white;\n            -webkit-border-radius: 10px;\n            -moz-border-radius: 10px;\n            border-radius: 10px;\n            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);\n            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);\n            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);\n            pointer-events: none;\n    }\n    \n    #tooltip.hidden {\n            display: none;\n    }\n    \n    #tooltip p {\n            margin: 0;\n            font-family: sans-serif;\n            font-size: 16px;\n            line-height: 20px;\n    }\n\nNote in particular that its `position` is `absolute`, so we can control\nexactly where it should appear on the page. I’ve also added some fancy rounded\ncorners and a drop shadow. Plus, `pointer-events: none` ensures that mousing\nover the tooltip itself won’t trigger a `mouseout` event on the bars, thereby\nhiding the tooltip. (Try the code without this line, and you’ll see what I\nmean.) Lastly, when the tooltip is given a class of `hidden`, it is not\ndisplayed.\n\nI made some modifications to the `mouseover` function, so the `div` is roughly\ncentered vertically against its triggering bar. The revised code now also sets\nthe tooltip’s `left` and `top` position per CSS layout requirements, sets the\ntext content of the `#value` span to `d`, and then — now that everything is in\nplace — removes the `hidden` class, making the tooltip visible:\n\n    \n    \n    .on(\"mouseover\", function(d) {\n    \n    //Get this bar's x/y values, then augment for the tooltip\n    var xPosition = parseFloat(d3.select(this).attr(\"x\")) + xScale.rangeBand() / 2;\n    var yPosition = parseFloat(d3.select(this).attr(\"y\")) / 2 + h / 2;\n    \n    //Update the tooltip position and value\n    d3.select(\"#tooltip\")\n      .style(\"left\", xPosition + \"px\")\n      .style(\"top\", yPosition + \"px\")\n      .select(\"#value\")\n      .text(d);\n    \n    //Show the tooltip\n    d3.select(\"#tooltip\").classed(\"hidden\", false);\n    \n    })\n\nHiding the tooltip on `mouseout` is much easier; simply add on the `hidden`\nclass:\n\n    \n    \n    .on(\"mouseout\", function() {\n    \n    //Hide the tooltip\n    d3.select(\"#tooltip\").classed(\"hidden\", true);\n    \n    })\n\n* * *\n\n### Warning\n\nThe layout of this simple example works well, but in a real-world situation,\nthe D3 chart would be just one of many other elements on the page. As you\nprobably know, perfecting HTML/CSS layouts can be a challenge, and this is the\nbiggest hassle of getting HTML elements to interact properly with an SVG\nchart. It can help to put both the tooltip `div` and SVG chart within the same\nenclosing element (like a container `div`), so then you only have to worry\nabout relative positions.\n[`d3.mouse`](https://github.com/mbostock/d3/wiki/Selections#wiki-d3_mouse) can\nbe used to get mouse coordinates relative to any other element on the page,\nand can be useful in cases when you need to position non-SVG elements in\nrelationship to the mouse.\n\n* * *\n\n\n## Consideration for Touch Devices\n\nThe browsers on most popular touch devices — such as iOS and Android devices —\nautomatically translate touch events into mouse events, for JavaScript\npurposes. So a tap on an element is interpreted by the browser as a `click`\nevent. This means that, for the most part, your code that was crafted for\nmouse interfaces will also work just fine for touch-based interfaces.\n\nThe primary exception to this is multitouch, which is not automagically\nhandled by D3. There’s no easy answer on how to handle multitouch interactions\nyet, but D3 _does_ track the touches for you (although it’s up to you to\ndecide how to use them). See the API reference for\n[`d3.touches`](https://github.com/mbostock/d3/wiki/Selections#wiki-d3_touches).\n\n\n## Moving Forward\n\nCongratulations! You now have all the basics of D3 under your cap. You are a\npro at binding data, generating and styling elements based on that data,\nimplementing scales and drawing axes, and modifying your creations with new\ndata, animated transitions, and interactivity. What more could you ask for?\n\nHow about layouts and geomaps? The next two chapters will dive into these more\nadvanced topics, but — be warned — without the same level of detail as the\nprior chapters. Now that you know the basics, you don’t need every little\nthing spelled out. Here we go!\n\n\n## Chapter 11. Layouts\n\nContrary to what the name implies, D3 _layouts_ do not, in fact, lay anything\nout for you on the screen. The layout methods have no direct _visual_ output.\nRather, D3 layouts take data that you provide and remap or otherwise transform\nit, thereby generating _new_ data that is more convenient for a specific\nvisual task. It’s still up to you to take that new data and generate visuals\nfrom it.\n\nHere is a complete list of all D3 layouts:\n\n  * Bundle \n  * Chord \n  * Cluster \n  * Force \n  * Histogram \n  * Pack \n  * Partition \n  * Pie \n  * Stack \n  * Tree \n  * Treemap \n\nIn this chapter, I introduce three of the most common: _pie_ , _stack_ , and\n_force_. Each layout performs a different function, and each has its own\nidiosyncrasies.\n\nIf you are curious about any of the other D3 layouts, check out [the many\nexamples on the D3 website](https://github.com/mbostock/d3/wiki/Gallery), and\nbe sure to reference [the official API documentation on\nlayouts](https://github.com/mbostock/d3/wiki/Layouts).\n\n\n## Pie Layout\n\n`d3.layout.pie()` might not be as delicious as it sounds, but it’s still\nworthy of your attention. Obviously, its typical use is for creating pie\ncharts, like the example in [Figure\n11-1](part0015_split_001.html#simple_pie_chart).\n\n![A simple pie chart](../images/00140.jpeg)\n\nFigure 11-1. A simple pie chart\n\nFeel free to open up the sample code for this in _01_pie.html_ and poke\naround.\n\nTo draw those pretty wedges, we need to know a number of measurements,\nincluding an inner and outer radius for each wedge, plus the starting and\nending angles. The purpose of the pie layout is to take your data and\ncalculate all those messy angles for you, sparing you from ever having to\nthink about radians.\n\nRemember radians? In case you don’t, here’s a quick refresher. Just as there\nare 360° in a circle, there are 2π radians. So π radians equals 180°, or half\na circle. Most people find it easier to think in terms of degrees; computers\nprefer radians.\n\nFor this pie chart, let’s start, as usual, with a very simple dataset:\n\n    \n    \n    var dataset = [ 5, 10, 20, 45, 6, 25 ];\n\nWe can define a default pie layout very simply as:\n\n    \n    \n    var pie = d3.layout.pie();\n\nThen, all that remains is to hand off our data to the new `pie()` function, as\nin `pie(dataset)`. Compare the datasets before and after in [Figure\n11-2](part0015_split_001.html#pieified_data).\n\n![Your data, pie-ified](../images/00141.jpeg)\n\nFigure 11-2. Your data, pie-ified\n\nThe pie layout takes our simple array of numbers and generates an array of\nobjects, one object for each value. Each of those objects now has a few new\nvalues — most important, `startAngle` and `endAngle`. Wow, that was easy!\n\nNow, to actually draw the wedges, we turn to `d3.svg.arc()`, a handy built-in\nfunction for drawing arcs as SVG `path` elements. We haven’t talked about\n`path`s yet, but they are SVG’s answer to drawing irregular forms. Anything\nthat’s not a `rect`, `circle`, or another basic shape can be drawn as a\n`path`. The catch is, the syntax for defining `path` values is not\nparticularly human-friendly. For example, here’s the code for the big, red\nwedge in [Figure 11-1](part0015_split_001.html#simple_pie_chart):\n\n    \n    \n    <path fill=\"#d62728\" d=\"M9.184850993605149e-15,-150A150,150 0 0,1\n            83.99621792063931,124.27644738657631L0,0Z\"></path>\n\nIf you can understand that, then you don’t need this book.\n\nThe bottom line is, it’s best to let functions like `d3.svg.arc()` handle\ngenerating `path`s programatically. You don’t want to try writing this stuff\nout by hand.\n\nArcs are defined as custom functions, and they require inner and outer radius\nvalues:\n\n    \n    \n    var w = 300;\n    var h = 300;\n    \n    var outerRadius = w / 2;\n    var innerRadius = 0;\n    var arc = d3.svg.arc()\n                    .innerRadius(innerRadius)\n                    .outerRadius(outerRadius);\n\nHere I’m setting the size of the whole chart to be 300 by 300 square. Then I’m\nsetting the `outerRadius` to half of that, or 150. The `innerRadius` is zero.\nWe’ll revisit `innerRadius` in a moment.\n\nWe’re ready to draw some wedges! First, we create the SVG element, per usual:\n\n    \n    \n    //Create SVG element\n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)\n                .attr(\"height\", h);\n\nThen we can create new groups for each incoming wedge, binding the pie-ified\ndata to the new elements, and translating each group into the center of the\nchart, so the `path`s will appear in the right place:\n\n    \n    \n    //Set up groups\n    var arcs = svg.selectAll(\"g.arc\")\n            .data(pie(dataset))\n            .enter()\n            .append(\"g\")\n            .attr(\"class\", \"arc\")\n            .attr(\"transform\", \"translate(\" + outerRadius + \", \" + outerRadius + \")\");\n\nNote that we’re saving a reference to each newly created `g` in a variable\ncalled `arcs`.\n\nFinally, within each new `g`, we append a `path`. A `path`s path description\nis defined in the `d` attribute. So here we call the `arc` generator, which\ngenerates the path information based on the data already bound to this group:\n\n    \n    \n    //Draw arc paths\n    arcs.append(\"path\")\n        .attr(\"fill\", function(d, i) {\n            return color(i);\n        })\n        .attr(\"d\", arc);\n\nOh, and you might be wondering where those colors are coming from. If you\ncheck out _01_pie.html_ , you’ll note this line:\n\n    \n    \n    var color = d3.scale.category10();\n\nD3 has a number of handy ways to generate categorical colors. These might not\nbe your favorite colors, but they are quick to drop into any visualization\nwhile you’re in the prototyping stage. `d3.scale.category10()` creates an\n_ordinal_ scale with an output range of 10 different colors. (See [the\nwiki](https://github.com/mbostock/d3/wiki/Ordinal-Scales) for more information\non these color scales as well as perceptually calibrated color palettes, based\non research by Cynthia Brewer, that are included with D3.)\n\nLastly, we can generate text labels for each wedge:\n\n    \n    \n    arcs.append(\"text\")\n        .attr(\"transform\", function(d) {\n            return \"translate(\" + arc.centroid(d) + \")\";\n        })\n        .attr(\"text-anchor\", \"middle\")\n        .text(function(d) {\n            return d.value;\n        });\n\nNote that in `text()`, we reference the value with `d.value` instead of just\n`d`. This is because we bound the pie-ified data, so instead of referencing\nour original array (`d`), we have to reference the array of objects\n(`d.value`).\n\nThe only thing new here is `arc.centroid(d)`. WTH? A _centroid_ is the\ncalculated center point of any shape, whether that shape is regular (like a\nsquare) or highly irregular (like an outline of the state of Maryland).\n`arc.centroid()` is a super-helpful function that calculates and returns the\ncenter point of any arc. We translate each `text` label element to each arc’s\ncentroid, and that’s how we get the text labels to float right in the middle\nof each wedge.\n\nBonus tip: Remember how `arc()` required an `innerRadius` value? We can expand\nthat to anything greater than zero, and our pie chart becomes a _ring_ chart\nlike the one shown in [Figure\n11-3](part0015_split_001.html#simple_ring_chart):\n\n    \n    \n    var innerRadius = w / 3;\n\n![A simple ring chart](../images/00142.jpeg)\n\nFigure 11-3. A simple ring chart\n\nCheck it out in _02_ring.html_.\n\nOne more thing: The pie layout automatically reordered our data values from\nlargest to smallest. Remember, we started with `[ 5, 10, 20, 45, 6, 25 ]`, so\nthe small value of 6 should have appeared between 45 and 25, but no — the\nlayout sorted our values in descending order, so the chart began with 45 at\nthe 12 o’clock position, and everything just goes clockwise from there.\n\n\n## Stack Layout\n\n`d3.layout.stack()` converts two-dimensional data into “stacked” data; it\ncalculates a baseline value for each datum, so you can “stack” layers of data\non top of one another. This can be used to generate stacked bar charts,\nstacked area charts, and even streamgraphs (which are just stacked area charts\nbut without the rigid starting baseline value of zero).\n\nFor example, we’ll start with the stacked bar chart in [Figure\n11-4](part0015_split_002.html#simple_stacked_bar_chart).\n\n![A simple stacked bar chart](../images/00143.gif)\n\nFigure 11-4. A simple stacked bar chart\n\nLet’s say you had some data like this:\n\n    \n    \n    var dataset = [\n            { apples: 5, oranges: 10, grapes: 22 },\n            { apples: 4, oranges: 12, grapes: 28 },\n            { apples: 2, oranges: 19, grapes: 32 },\n            { apples: 7, oranges: 23, grapes: 35 },\n            { apples: 23, oranges: 17, grapes: 43 }\n    ];\n\nThe first step is to rearrange that data into an array of arrays. Each array\nrepresents the data for one category (e.g., apples, oranges, or grapes).\nWithin each category array, you’ll need an object for each data value, which\nitself must contain an `x` and a `y` value. The `x` in our case is just an ID\nnumber. The `y` is the actual data value:\n\n    \n    \n    var dataset = [\n            [\n                    { x: 0, y: 5 },\n                    { x: 1, y: 4 },\n                    { x: 2, y: 2 },\n                    { x: 3, y: 7 },\n                    { x: 4, y: 23 }\n            ],\n            [\n                    { x: 0, y: 10 },\n                    { x: 1, y: 12 },\n                    { x: 2, y: 19 },\n                    { x: 3, y: 23 },\n                    { x: 4, y: 17 }\n            ],\n            [\n                    { x: 0, y: 22 },\n                    { x: 1, y: 28 },\n                    { x: 2, y: 32 },\n                    { x: 3, y: 35 },\n                    { x: 4, y: 43 }\n            ]\n    ];\n\nOur original `dataset` looks like [Figure\n11-5](part0015_split_002.html#prestacked_data) in the console.\n\n![The data before stacking](../images/00144.jpeg)\n\nFigure 11-5. The data before stacking\n\nThen we initialize our stack layout function, and call it on `dataset`:\n\n    \n    \n    var stack = d3.layout.stack();\n    stack(dataset);\n\nNow the stacked data is shown in [Figure\n11-6](part0015_split_002.html#stacked_data).\n\n![The data after stacking](../images/00145.jpeg)\n\nFigure 11-6. The data after stacking\n\nCan you spot the difference? In the stacked data, each object has been given a\n`y0` value. This is the _baseline_ value. Notice that the `y0` baseline value\nis equal to the sum of all the `y` values in the preceding categories. For\nexample, reading left to right across the top, the first object’s `y` value is\n5, and its `y0` is zero. To the right (in the oranges column), the first\nobject has a `y` value of 10, and a `y0` of 5. (Aha! That’s just the value of\nthe first object’s `y`!) On the far right (in the grapes column), we see a `y`\nvalue of 22, and a `y0` of 15 (which is just 5 + 10).\n\nTo “stack” elements visually, now we can reference each data object’s baseline\nvalue as well as its height. See all the code in _03_stacked_bar.html_. (I\nleave it as an exercise to you to align the stacks against the bottom x-axis.)\nHere’s the critical excerpt:\n\n    \n    \n    var rects = groups.selectAll(\"rect\")\n            .data(function(d) { return d; })\n            .enter()\n            .append(\"rect\")\n            .attr(\"x\", function(d, i) {\n                    return xScale(i);\n            })\n            .attr(\"y\", function(d) {\n                    return yScale(d.y0);\n            })\n            .attr(\"height\", function(d) {\n                    return yScale(d.y);\n            })\n            .attr(\"width\", xScale.rangeBand());\n\nNote how for `y` and `height` we reference `d.y0` and `d.y`, respectively.\n\n\n## Force Layout\n\nForce-directed layouts are so-called because they use simulations of physical\n_forces_ to arrange elements on the screen. Arguably, they are a bit overused,\nyet they make a great demo and just look _so darn cool_. Everyone wants to\nlearn how to make one, so let’s talk about it.\n\nForce layouts are typically used with network data. In computer science, this\nkind of dataset is called a _graph_. A simple graph is a list of _nodes_ and\n_edges_. The nodes are entities in the dataset, and the edges are the\n_connections_ between nodes. Some nodes will be connected by edges, and others\nwon’t. Nodes are commonly represented as circles, and edges as lines. But of\ncourse the visual representation is up to you — D3 just helps manage all the\nmechanics behind the scenes.\n\nThe physical metaphor here is of particles that repel each other, yet are also\nconnected by springs. The repelling forces push particles away from each\nother, preventing visual overlap, and the springs prevent them from just\nflying out into space, thereby keeping them on the screen where we can see\nthem.\n\n[Figure 11-7](part0015_split_003.html#force_layouta) provides a visual preview\nof what we’re coding toward.\n\n![A simple force layout](../images/00146.jpeg)\n\nFigure 11-7. A simple force layout\n\nD3’s force layout expects us to provide nodes and edges separately, as arrays\nof objects. Here we have one `dataset` object that contains two elements,\n`nodes` and `edges`, each of which is itself an array of objects:\n\n    \n    \n    var dataset = {\n            nodes: [\n                    { name: \"Adam\" },\n                    { name: \"Bob\" },\n                    { name: \"Carrie\" },\n                    { name: \"Donovan\" },\n                    { name: \"Edward\" },\n                    { name: \"Felicity\" },\n                    { name: \"George\" },\n                    { name: \"Hannah\" },\n                    { name: \"Iris\" },\n                    { name: \"Jerry\" }\n            ],\n            edges: [\n                    { source: 0, target: 1 },\n                    { source: 0, target: 2 },\n                    { source: 0, target: 3 },\n                    { source: 0, target: 4 },\n                    { source: 1, target: 5 },\n                    { source: 2, target: 5 },\n                    { source: 2, target: 5 },\n                    { source: 3, target: 4 },\n                    { source: 5, target: 8 },\n                    { source: 5, target: 9 },\n                    { source: 6, target: 7 },\n                    { source: 7, target: 8 },\n                    { source: 8, target: 9 }\n            ]\n    };\n\nAs usual for D3, you can store whatever data you like within these objects.\nOur nodes are simple — just names of people. The edges contain two values\neach: a source ID and a target ID. These IDs correspond to the nodes above, so\nID number 3 is Donovan, for example. If 3 is connected to 4, then Donovan is\nconnected to Edward.\n\nThe data shown is a bare minimum for using the force layout. You can add more\ninformation, and, in fact, D3 will itself add a lot more data to what we’ve\nprovided, as we’ll see in a moment.\n\nHere’s how to initialize a force layout:\n\n    \n    \n    var force = d3.layout.force()\n                         .nodes(dataset.nodes)\n                         .links(dataset.edges)\n                         .size([w, h])\n                         .start();\n\nAgain, this is just the bare minimum. We specify the nodes and links to be\nused, the size of the available space, and then call `start()` when we’re\nready to go.\n\nThis generates a default force layout, but the default won’t be ideal for\nevery dataset. As you would expect, there are all kinds of options for\ncustomization. [See the API wiki](https://github.com/mbostock/d3/wiki/Force-\nLayout) for all the gory details. Here, I’ve increased the `linkDistance` (the\nlength of the edges between connected nodes) as well as the negative `charge`\nbetween nodes, so they will repel each other more. (It’s not personal; I just\nwant them to spread out a bit.)\n\n    \n    \n    var force = d3.layout.force()\n                         .nodes(dataset.nodes)\n                         .links(dataset.edges)\n                         .size([w, h])\n                         .linkDistance([50])        // <-- New!\n                         .charge([-100])            // <-- New!\n                         .start();\n\nNext, we create an SVG line for each edge:\n\n    \n    \n    var edges = svg.selectAll(\"line\")\n            .data(dataset.edges)\n            .enter()\n            .append(\"line\")\n            .style(\"stroke\", \"#ccc\")\n            .style(\"stroke-width\", 1);\n\nNote that I set all the lines to have the same stroke color and weight, but of\ncourse you could set this dynamically based on data (say, thicker or darker\nlines for “stronger” connections, or some other value).\n\nThen, we create an SVG circle for each node:\n\n    \n    \n    var nodes = svg.selectAll(\"circle\")\n            .data(dataset.nodes)\n            .enter()\n            .append(\"circle\")\n            .attr(\"r\", 10)\n            .style(\"fill\", function(d, i) {\n                    return colors(i);\n            })\n            .call(force.drag);\n\nI set all circles to have the same radius, but each gets a different color\nfill, just because it’s prettier that way. Of course, these values could be\nset dynamically, too, for a more useful visualization.\n\nYou’ll notice the last line of code, which enabled drag-and-drop interaction.\n(Comment that out, and the user won’t be able to move nodes around.)\n\nLastly, we have to specify what happens when the force layout “ticks.” Yes,\nthese ticks are different from the axis ticks addressed earlier, and\ndefinitely different from those little blood-sucking insects. Physics\nsimulations use the word “tick” to refer to the passage of some amount of\ntime, like the ticking second hand of a clock. For example, if an animation\nwere running at 30 frames per second, you could have one tick represent 1/30th\nof a second. Then each time the simulation ticked, you’d see the calculations\nof motion update in real time. In some applications, it’s useful to run ticks\nfaster than actual time. For example, if you were trying to model the effects\nof climate change on the planet 50 years from now, you wouldn’t want to wait\n50 years to see the results, so you’d program the system to tick on ahead,\nfaster than real time.\n\nFor our purposes, what you need to know is that D3’s force layout “ticks”\nforward through time, just like every other physics simulation. With each\ntick, the force layout adjusts the position values for each node and edge\naccording to the rules we specified when the layout was first intialized. To\nsee this progress visually, we need to update the associated elements — the\nlines and circles:\n\n    \n    \n    force.on(\"tick\", function() {\n    \n    edges.attr(\"x1\", function(d) { return d.source.x; })\n         .attr(\"y1\", function(d) { return d.source.y; })\n         .attr(\"x2\", function(d) { return d.target.x; })\n         .attr(\"y2\", function(d) { return d.target.y; });\n    \n    nodes.attr(\"cx\", function(d) { return d.x; })\n         .attr(\"cy\", function(d) { return d.y; });\n    \n    });\n\nThis tells D3, “Okay, every time you tick, take the new x/y values for each\nline and circle and update them in the DOM.”\n\nWait a minute. Where did these x/y values come from? We had only specified\n`name`s, `source`s, and `target`s!\n\nD3 calculated those x/y values and appended them to the existing objects in\nour original `dataset` (see [Figure\n11-8](part0015_split_003.html#force_data_added)). Go ahead and open up\n_04_force.html_ , and type **`dataset`** into the console. Expand any node or\nedge, and you’ll see lots of additional data that we didn’t provide. That’s\nwhere D3 stores the information it needs to continue running the physics\nsimulation. With `on(\"tick\", …)`, we are just specifying how to take those\nupdated coordinates and map them on to the visual elements in the DOM.\n\n![The first node in dataset, with lots of supplemental data added by\nD3](../images/00147.jpeg)\n\nFigure 11-8. The first node in dataset, with lots of supplemental data added\nby D3\n\nThe final result, then, is the lovely entanglement displayed in [Figure\n11-9](part0015_split_003.html#force_layout).\n\n![A simple force layout with 10 nodes and 12 edges](../images/00148.jpeg)\n\nFigure 11-9. A simple force layout with 10 nodes and 12 edges\n\nAgain, you can run the final code youself in _04_force.html_.\n\nNote that each time you reload the page, the circles and lines spring to life,\neventually resting in a state of equilibrium. But that final state of rest is\ndifferent every time because there is an element of randomness to how the\ncircles enter the stage. This illustrates the unpredictable nature of force-\nbased layouts: they might be quite different each time you use them, and they\nrely on the data to provide structure. If your data is more structured, you\nmight get a better visual result.\n\nInteractivity can be useful for improving our view of the data. I don’t like\nhow the edges overlap here, so I’ll drag the pink circle out and around (see\n[Figure 11-10](part0015_split_003.html#force_drag)), then I’ll move the red\none up and to the left (see [Figure\n11-11](part0015_split_003.html#force_drag_2)).\n\n![Dragging a node to change the arrangement of nodes](../images/00149.jpeg)\n\nFigure 11-10. Dragging a node to change the arrangement of nodes\n\n![Dragging some more to untangle nodes](../images/00150.jpeg)\n\nFigure 11-11. Dragging some more to untangle nodes\n\nAs a bonus, interactivity + physics simulation = irresistable demo. I can’t\nexplain it, but it’s true. For some reason, we humans just love seeing real-\nworld things replicated on screens.\n\n\n## Chapter 12. Geomapping\n\nBar charts, scatterplots, ring charts, and even force-directed graphs… _Yeah,\nthat’s all okay_ , you’re thinking, _but get to the maps already!_\n\n\n## JSON, Meet GeoJSON\n\nYou’ve already met JSON. Now meet GeoJSON, the JSON-based standard for\nencoding geodata for web applications. GeoJSON actually is not a totally\ndifferent format, but just a very specific use of JSON.\n\nBefore you can generate a geographic map, you need to acquire the path data\n(the outlines) for the shapes you want to display. We’ll start with a common\nexample, mapping US state boundaries. I’ve included a file _us-states.json_\nwith the sample code. This file is taken directly from one of the D3 examples,\nand we owe Mike Bostock a word of thanks for generating this nice, clean file\nof state boundaries.\n\nOpening up _us-states.json_ , you’ll see it looks something like this\n(reformatted and greatly abbreviated here):\n\n    \n    \n    {\n      \"type\": \"FeatureCollection\",\n      \"features\": [\n         {\n           \"type\": \"Feature\",\n           \"id\": \"01\",\n           \"properties\": { \"name\": \"Alabama\" },\n           \"geometry\": {\n             \"type\": \"Polygon\",\n             \"coordinates\": [[[-87.359296,35.00118],\n               [-85.606675,34.984749],[-85.431413,34.124869],\n               [-85.184951,32.859696],[-85.069935,32.580372],\n               [-84.960397,32.421541],[-85.004212,32.322956],\n               [-84.889196,32.262709],[-85.058981,32.13674] …\n              ]]\n          }\n        },\n        {\n             \"type\": \"Feature\",\n             \"id\": \"02\",\n             \"properties\": { \"name\": \"Alaska\" },\n             \"geometry\": {\n               \"type\": \"MultiPolygon\",\n               \"coordinates\": [[[[-131.602021,55.117982],\n                 [-131.569159,55.28229],[-131.355558,55.183705],\n                 [-131.38842,55.01392],[-131.645836,55.035827],\n                 [-131.602021,55.117982]]],[[[-131.832052,55.42469],\n                 [-131.645836,55.304197],[-131.749898,55.128935],\n                 [-131.832052,55.189182], …\n                ]]]\n              }\n          }\n    …\n\nIn typical GeoJSON style, we see, first of all, that this is all one giant\nobject. (Curly brackets, remember?) That object has a `type` of\n`FeatureCollection`, followed by `features`, which is an array of individual\n`Feature` objects. Each one of these `Feature`s represents a US state. You can\nsee each state’s name under `properties`.\n\nBut the real meat in any GeoJSON file is under `geometry`. This is where the\nfeature’s `type` is specified, followed by the many `coordinates` that\nconstitute the feature’s boundary. Within the `coordinates` are sets of\nlongitude/latitude pairs, each one as a small, two-value array. This is the\ninformation that cartographers dedicate their lives to compiling and refining.\nWe owe generations of explorers and researchers our gratitude for creating\nthese sequences of tiny, yet extremely powerful numbers.\n\nIt’s important to note that _longitude_ is always listed first. So despite the\ncultural bias toward lat/lon, GeoJSON is a lon/lat world.\n\nAlso, in case your cartographic skills are a bit rusty, here’s how you can\nalways remember which is which:\n\n  * Longtiude is long. Therefore, longitudinal lines run vertically, as though hanging down from above. \n  * Latitude is fatitude. Therefore, latitudinal lines run horizontally, as though wrapping around the Earth’s waist. \n\nLongitude and latitude together constitute an enormous grid that encircles the\nwhole globe. Conveniently for us, lon/lat can be easily converted to x/y\nvalues for screen display. In bar charts, we map data values to display values\n— numbers to rectangle heights. In geomapping, we also map data values to\ndisplay values — lon/lat becomes x/y. Thinking in terms of x/y also makes it\neasier to get used to the uncomfortable order of longitude first, latitude\nsecond.\n\n* * *\n\n### Tip\n\n[Get Lat+Lon](http://teczno.com/squares) is a great resource by Michal\nMigurski for double-checking coordinate values. Keep it open in a browser tab\nwhenever you’re working on geomaps. You will reference it often.\n\n* * *\n\n\n## Paths\n\nWe’ve got our geodata. Now get ready to rock.\n\nFirst, we define our first _path generator_ :\n\n    \n    \n    var path = d3.geo.path();\n\n`d3.geo.path()` is a total lifesaver of a function. It does all the dirty work\nof translating that mess of GeoJSON coordinates into even messier messes of\nSVG `path` codes. All hail `d3.geo.path()`!\n\nNow we _could_ paste all that GeoJSON directly into our HTML file, but ugh, so\nmany coordinates and curly brackets — what a mess! It’s cleaner and more\ncommon to keep the geodata in a separate file and load it in using\n`d3.json()`:\n\n    \n    \n    d3.json(\"us-states.json\", function(json) {\n    \n            svg.selectAll(\"path\")\n               .data(json.features)\n               .enter()\n               .append(\"path\")\n               .attr(\"d\", path);\n    \n    });\n\n`d3.json()` takes two arguments. First, it takes a string pointing to the path\nof the file to load in. Second, it takes a callback function that is fired\nwhen the JSON file has been loaded and parsed. (See [Handling Data Loading\nErrors](part0009_split_002.html#handling_data_loading_errors_5) for details on\nthe callback function.) `d3.json()`, just like `d3.csv()`, is _asynchronous_ ,\nmeaning it won’t prevent the rest of your code from running while the browser\nwaits for that external file to load. For example, code placed _after_ the\ncallback function might be executed _before_ the contents of the callback\nitself:\n\n    \n    \n    d3.json(\"someFile.json\", function(json) {\n            //Put things here that depend on the JSON loading\n    });\n    \n    //Only put things here that can operate independently of the JSON\n    console.log(\"I like cats.\");\n\nSo as a rule, when loading external datafiles, put the code that depends on\nthat data within the callback function. (Or put the code into other custom\nfunctions, and then call those functions from within the callback.)\n\nBack to the example. Finally, we bind the GeoJSON features to new `path`\nelements, creating one new `path` for each feature:\n\n    \n    \n            svg.selectAll(\"path\")\n               .data(json.features)\n               .enter()\n               .append(\"path\")\n               .attr(\"d\", path);\n\nNotice that last line, in which `d` (the path data attribute) is referred to\nour path generator, which magically takes the bound geodata and calculates all\nthat crazy SVG code. The result is [Figure\n12-1](part0016_split_002.html#geojson_simple).\n\n![Our first view of GeoJSON data](../images/00151.gif)\n\nFigure 12-1. Our first view of GeoJSON data\n\nA map! That was so easy! Check it out in _01_paths.html_. The rest is just\ncustomization.\n\n* * *\n\n### Tip\n\nYou can find lots more detail on paths and path generator options [on the\nwiki](https://github.com/mbostock/d3/wiki/Geo-Paths).\n\n* * *\n\n\n## Projections\n\nAs an astute observer, you noticed that our map isn’t quite showing us the\nentire United States. To correct this, we need to modify the _projection_\nbeing used.\n\nWhat is a projection? Well, as an astute observer, you have also noticed that\nthe globe is round, not flat. Round things are three-dimensional, and don’t\ntake well to being represented on two-dimensional surfaces. A _projection_ is\nan algorithm of compromise; it is the method by which 3D space is “projected”\nonto a 2D plane.\n\nWe define D3 projections using a familiar structure:\n\n    \n    \n    var projection = d3.geo.albersUsa()\n                           .translate([w/2, h/2]);\n\nD3 has several built-in projections. Albers USA is a composite projection that\nnicely tucks Alaska and Hawaii beneath the Southwest. (You’ll see in a\nsecond.) `albersUsa` is actually the default projection for `d3.path.geo()`,\nbut now that we’ve specified it explicitly, we can set several custom options,\nsuch as a translation value. You can see we’re translating the projection to\nthe center of the image (half of its width and half of its height).\n\nThe only other change we have to make is to tell the path generator explicitly\nthat it should reference our customized projection when generating all those\npaths:\n\n    \n    \n    var path = d3.geo.path()\n                     .projection(projection);\n\nThat gives us [Figure 12-2](part0016_split_003.html#geojson_centered). Getting\nthere! See _02_projection.html_ for the working code.\n\n![The same GeoJSON data, but now with a centered\nprojection](../images/00152.gif)\n\nFigure 12-2. The same GeoJSON data, but now with a centered projection\n\nWe can also add a `scale()` method to our projection in order to shrink things\ndown a bit and achieve the result shown in [Figure\n12-3](part0016_split_003.html#geojson_scaled):\n\n    \n    \n    var projection = d3.geo.albersUsa()\n                           .translate([w/2, h/2])\n                           .scale([500]);\n\nThe default scale value is 1,000. Anything smaller will shrink the map;\nanything larger will expand it.\n\n![The USA, scaled and centered within the image](../images/00153.gif)\n\nFigure 12-3. The USA, scaled and centered within the image\n\nCool! See that working code in _03_scaled.html_.\n\nBy adding a single `style()` statement, we could set the path’s fills to\nsomething less severe, like the blue shown in [Figure\n12-4](part0016_split_003.html#geojson_filled).\n\n![Now more blue-ish than black](../images/00154.jpeg)\n\nFigure 12-4. Now more blue-ish than black\n\nSee _04_fill.html_ for that. You could use the same technique to set stroke\ncolor and width, too.\n\nMap projections are extremely powerful algorithms, and different projections\nare useful for different purposes and different parts of the world (near the\npoles, versus the equator, for example).\n\nThanks primarily to the contributions of [Jason\nDavies](http://www.jasondavies.com), D3’s geo projections plug-ins now support\nessentially every obscure projection you could imagine. Reference [the\ncomplete visual reference of D3 projections on the\nwiki](https://github.com/mbostock/d3/wiki/Geo-Projections). You might also\nfind the [projection comparison demo](http://bl.ocks.org/3711652) useful.\n\n\n## Choropleth\n\nChoro-_what?_ This word, which can be difficult to pronounce, refers to a\ngeomap with areas filled in with different values (light or dark) or colors to\nreflect associated data values. In the United States, so-called “red state,\nblue state” choropleth maps showing the Republican and Democratic leanings of\neach state are ubiquitous, especially around election time. But choropleths\ncan be generated from any values, not just political ones.\n\nThese maps are also some of the most requested uses of D3. Although\nchoropleths can be fantastically useful, keep in mind that they have some\ninherent perceptual limitations. Because they use _area_ to encode values,\nlarge areas with low density (such as the state of Nevada) might be\noverrepresented visually. A standard choropleth does not represent per-capita\nvalues fairly — Nevada is too big, and Delaware far too small. But they _do_\nretain the geography of a place, and — as maps — they look really, really\ncool. So let’s dive in. (You can follow along with _05_choropleth.html_.)\n\nFirst, I’ll set up a scale that can take data values as input, and will return\ncolors. This is the heart of choropleth-style mapping:\n\n    \n    \n    var color = d3.scale.quantize()\n                        .range([\"rgb(237,248,233)\", \"rgb(186,228,179)\",\n                         \"rgb(116,196,118)\", \"rgb(49,163,84)\",\"rgb(0,109,44)\"]);\n\nA _quantize_ scale functions as a linear scale, but it outputs values from\nwithin a discrete range. These output values could be numbers, colors (as\nwe’ve done here), or anything else you like. This is useful for sorting values\ninto “buckets.” In this case, we’re using five buckets, but there could be as\nmany as you like.\n\nNotice I’ve specified an output range, but not an input domain. (I’m waiting\nuntil our data is loaded in to do that.) These particular colors are taken\nfrom the `colorbrewer.js` file included in [the D3 GitHub\nrepository](https://github.com/mbostock/d3/tree/master/lib/colorbrewer) — a\ncollection of perceptually optimized colors, selected by Cynthia Brewer, and\nbased on her research.\n\nNext, we need to load in some data. I’ve provided a file _us-ag-\nproductivity-2004.csv_ , which looks like this:\n\n    \n    \n    state,value\n    Alabama,1.1791\n    Arkansas,1.3705\n    Arizona,1.3847\n    California,1.7979\n    Colorado,1.0325\n    Connecticut,1.3209\n    Delaware,1.4345\n    …\n\nThis data, provided by the US Department of Agriculture, reports agricultural\nproductivity by state during the year 2004. The units are relative to an\narbitrary baseline of the productivity of the state of Alabama in 1996 (1.0),\nso greater values are more productive, and smaller values less so. (Find lots\nof open government datasets at <http://data.gov>.) I expect this data will\ngive us a nice map of states’ agricultural productivity.\n\nTo load in the data, we use `d3.csv()`:\n\n    \n    \n    d3.csv(\"us-ag-productivity-2004.csv\", function(data) { …\n\nThen, in the callback function, I want to set the `color` quantize scale’s\ninput domain (before I forget!):\n\n    \n    \n            color.domain([\n                    d3.min(data, function(d) { return d.value; }),\n                    d3.max(data, function(d) { return d.value; })\n            ]);\n\nThis uses `d3.min()` and `d3.max()` to calculate and return the smallest and\nlargest data values, so the scale’s domain is dynamically calculated.\n\nNext, we load in the JSON geodata, as before. But what’s new here is I want to\n_merge_ the agricultural data _into_ the GeoJSON. Why? Because we can only\nbind one set of data to elements at a time. We definitely need the GeoJSON,\nfrom which the `path`s are generated, but we also need the new agricultural\ndata. So if we can smush them into a single, monster array, then we can bind\nthem to the new `path` elements all at the same time. (There are several\napproaches to this step; what follows is my preferred method.)\n\n    \n    \n        d3.json(\"us-states.json\", function(json) {\n    \n            //Merge the ag. data and GeoJSON\n            //Loop through once for each ag. data value\n            for (var i = 0; i < data.length; i++) {\n    \n                //Grab state name\n                var dataState = data[i].state;\n    \n                //Grab data value, and convert from string to float\n                var dataValue = parseFloat(data[i].value);\n    \n                //Find the corresponding state inside the GeoJSON\n                for (var j = 0; j < json.features.length; j++) {\n    \n                var jsonState = json.features[j].properties.name;\n    \n                if (dataState == jsonState) {\n    \n                    //Copy the data value into the JSON\n                    json.features[j].properties.value = dataValue;\n    \n                    //Stop looking through the JSON\n                    break;\n    \n            }\n        }\n    }\n\nRead through that closely. Basically, for each state, we are finding the\nGeoJSON element with the same name (e.g., “Colorado”). Then we take the\nstate’s data value and tuck it in under `json.features[j].properties.value`,\nensuring it will be bound to the element and available later, when we need it.\n\nLastly, we create the `path`s just as before, only we make our `style()` value\ndynamic:\n\n    \n    \n                    svg.selectAll(\"path\")\n                       .data(json.features)\n                       .enter()\n                       .append(\"path\")\n                       .attr(\"d\", path)\n                       .style(\"fill\", function(d) {\n                                    //Get data value\n                                    var value = d.properties.value;\n    \n                                    if (value) {\n                                            //If value exists…\n                                            return color(value);\n                                    } else {\n                                            //If value is undefined…\n                                            return \"#ccc\";\n                                    }\n                       });\n\nInstead of `\"steelblue\"` for everyone, now each state `path` gets a different\nfill value. The trick is that we don’t have data for _every_ state. The\ndataset we’re using doesn’t have information for Alaska, the District of\nColumbia, Hawaii, or Puerto Rico (which, although not a state, is still\nincluded in the GeoJSON and appears in the projection).\n\nSo to accommodate those exceptions, we include a little logic: an `if()`\nstatement that checks to see whether or not the data value has been defined.\nIf it exists, then we return `color(value)`, meaning we pass the data value to\nour quantize scale, which returns a color. For undefined values, we set a\ndefault of light gray (`#ccc`).\n\nBeautiful! Just look at the result in [Figure\n12-5](part0016_split_004.html#choropleth_map). Check out the final code and\ntry it yourself in _05_choropleth.html_.\n\n![A choropleth map showing agricultural productivity by\nstate](../images/00155.jpeg)\n\nFigure 12-5. A choropleth map showing agricultural productivity by state\n\n\n## Adding Points\n\nWouldn’t it be nice to put some cities on this map, for context? Maybe it\nwould be interesting or useful to see how many large, urban areas there are in\nthe most (or least) agriculturally productive states. Again, let’s start by\nfinding the data.\n\nFortunately, the US Census has us covered, once again. (Your tax dollars at\nwork!) Here’s the start of a raw CSV dataset from the Census that shows\n[“Annual Estimates of the Resident Population for Incorporated Places Over\n50,000”](http://1.usa.gov/XWUSrY).\n\n    \n    \n    table with row headers in column A and column headers in rows 3 through 4,,,,,,,\n    ,,,\n    \"Table 1. Annual Estimates of the Resident Population for Incorporated Places\n    Over 50,000, Ranked by July 1, 2011 Population: April 1, 2010 to July 1, 2011\"\n    ,,,,,,,,,,\n    Rank,Geographic Area,,\"April 1, 2010\",,Population Estimate (as of July 1),,\n    ,,,,Place,State,Census,Estimates Base,2010,2011,,,,\n    1,New York city,New York,\"8,175,133\",\"8,175,133\",\"8,186,443\",\"8,244,910\",,,,\n    2,Los Angeles city,California,\"3,792,621\",\"3,792,625\",\"3,795,761\",\"3,819,702\"\n    ,,,,\n    3,Chicago city,Illinois,\"2,695,598\",\"2,695,598\",\"2,698,283\",\"2,707,120\",,,,\n    4,Houston city,Texas,\"2,099,451\",\"2,099,430\",\"2,108,278\",\"2,145,146\",,,,\n    5,Philadelphia city,Pennsylvania,\"1,526,006\",\"1,526,006\",\"1,528,074\",\"1,536,471\"\n    ,,,,\n    6,Phoenix city,Arizona,\"1,445,632\",\"1,445,656\",\"1,448,531\",\"1,469,471\",,,,\n    7,San Antonio city,Texas,\"1,327,407\",\"1,327,606\",\"1,334,431\",\"1,359,758\",,,,\n    8,San Diego city,California,\"1,307,402\",\"1,307,406\",\"1,311,516\",\"1,326,179\",,,,\n    9,Dallas city,Texas,\"1,197,816\",\"1,197,816\",\"1,201,715\",\"1,223,229\",,,,\n    10,San Jose city,California,\"945,942\",\"952,612\",\"955,091\",\"967,487\",,,,\n    …\n\nThis is quite messy, and I don’t even need all this data. So I’ll open the CSV\nup in my favorite spreadsheet program and clean it up a bit, removing unneeded\ncolumns. (You could use LibreOffice Calc, Apple Numbers, or Microsoft Excel.)\nI’m also interested in only the largest 50 cities, so I’ll delete all the\nothers. Exporting back to CSV, I now have this:\n\n    \n    \n    rank,place,population\n    1,New York city,8175133\n    2,Los Angeles city,3792621\n    3,Chicago city,2695598\n    4,Houston city,2099451\n    5,Philadelphia city,1526006\n    6,Phoenix city,1445632\n    7,San Antonio city,1327407\n    8,San Diego city,1307402\n    9,Dallas city,1197816\n    10,San Jose city,945942\n    …\n\nThis information is useful, but to place it on the map, I’m going to need the\nlatitude and longitude coordinates for each of these places. Looking this up\nmanually would take _forever_. Fortunately, we can use a _geocoding_ service\nto speed things up. Geocoding is the process of taking place names, looking\nthem up on a map (or in a database, really), and returning precise lat/lon\ncoordinates. “Precise” might be a bit of an overstatement — the geocoder does\nthe best job it can, but it will sometimes be forced to make assumptions given\nvague data. For example, if you specify “Paris,” it will probably assume you\nmean Paris, France and not Paris, Texas. It’s good practice to eyeball the\ngeocoder’s output once you get it on the map, and manually adjust any\nerroneous coordinates (using\n[teczno.com/squares](http://www.teczno.com/squares) as a reference).\n\nI’ll head over to [my favorite batch\ngeocoder](http://www.gpsvisualizer.com/geocoder/), paste in just the place\nnames, and click Start! A few minutes later, the geocoder spits out some more\ncomma-separated values, which includes lat/lon pairs. I bring those back into\nmy spreadsheet, and save out a new, unified CSV with coordinates:\n\n    \n    \n    rank,place,population,lat,lon\n    1,New York city,8175133,40.71455,-74.007124\n    2,Los Angeles city,3792621,34.05349,-118.245323\n    3,Chicago city,2695598,45.37399,-92.888759\n    4,Houston city,2099451,41.337462,-75.733627\n    5,Philadelphia city,1526006,37.15477,-94.486114\n    6,Phoenix city,1445632,32.46764,-85.000823\n    7,San Antonio city,1327407,37.706576,-122.440612\n    8,San Diego city,1307402,37.707815,-122.466624\n    9,Dallas city,1197816,40.636,-91.168309\n    10,San Jose city,945942,41.209716,-112.003047\n    …\n\nThat was unbelievably easy. Ten years ago that step would have taken us hours\nof research and tedious data entry, not seconds of mindless copying-and-\npasting. Now you see why we’re experiencing an explosion of online mapping.\n\nOur data is ready, and we already know how to load it in:\n\n    \n    \n    d3.csv(\"us-cities.csv\", function(data) {\n            //Do something…\n    });\n\nIn the callback function, we can specify how to create a new `circle` element\nfor each city, and then _position each circle_ according to the corresponding\ncity’s geo-coordinates:\n\n    \n    \n            svg.selectAll(\"circle\")\n               .data(data)\n               .enter()\n               .append(\"circle\")\n               .attr(\"cx\", function(d) {\n                       return projection([d.lon, d.lat])[0];\n               })\n               .attr(\"cy\", function(d) {\n                       return projection([d.lon, d.lat])[1];\n               })\n               .attr(\"r\", 5)\n               .style(\"fill\", \"yellow\")\n               .style(\"opacity\", 0.75);\n\nThe magic here is in those `attr()` statements that set the `cx` and `cy`\nvalues. You see, we can access the raw latitude and longitude values as\n`d.lat` and `d.lon`. But what we really need for positioning these circles are\nx/y _screen coordinates_ , not _geo_ -coordinates.\n\nSo we bring back our magical friend `projection()`, which is basically just a\ntwo-dimensional scale method. With D3 scales, we put in one number, and get\nback another. With projections, we put in two numbers, and get back two. (The\nother main difference is that the behind-the-scenes math for projections is\nmuch more complex than the simple normalization of scales.)\n\nThe map projection takes a two-value array as input, with _longitude_ first\n(remember, it’s lon/lat, not lat/lon, in GeoJSON-ville). Then the projection\nreturns a two-value array with x/y screen values. So, for `cx`, we use `[0]`\nto grab the _first_ of those values, which is _x_. For `cy`, we use `[1]` to\ngrab the _second_ of those values, which is _y_. Make sense?\n\nThe resulting map in [Figure\n12-6](part0016_split_005.html#choropleth_with_cities) is suh-weeeet! Check out\nthe code in _06_points.html_.\n\n![The top 50 largest US cities, represented as cute little yellow\ndots](../images/00156.jpeg)\n\nFigure 12-6. The top 50 largest US cities, represented as cute little yellow\ndots\n\nYet these dots are all the same size. Let’s link the population data to circle\nsize. Instead of a static area, we’ll reference the `population` value:\n\n    \n    \n               .attr(\"r\", function(d) {\n                     return Math.sqrt(parseInt(d.population) * 0.00004);\n               })\n\nHere we grab `d.population`, wrap it in `parseInt()` to convert it from a\nstring to an integer, scale that value down by an arbitrary amount, and\nfinally take the square root (to convert from an area value to a radius\nvalue). See the code in _07_points_sized.html_.\n\nAs you can see in [Figure\n12-7](part0016_split_005.html#choropleth_with_cities_sized), now the largest\ncities really stand out. The differences in city size are significant; this\nrepresentation might be better suited to a log scale, especially if even\nsmaller cities are included. Instead of multiplying by 0.00004, you could more\nproperly use a custom D3 scale function. (I’ll leave that to you.)\n\n![Cities as dots, with area set by population](../images/00157.jpeg)\n\nFigure 12-7. Cities as dots, with area set by population\n\nThe point here is to see that we’ve successfully loaded and visualized two\ndifferent datasets on a map. (Make that three, counting the geocoded\ncoordinates we merged in!)\n\n\n## Acquiring and Parsing Geodata\n\nIf we only ever wanted to make maps of the United States, then we would\nalready have all the GeoJSON we’d ever need. But the world is much bigger than\nthat, and there are lots of other areas to map. So allow me to digress for a\nmoment and address how to acquire and parse geodata for the area of your\nchoosing. The end goal is to produce a GeoJSON file, like _us-states.json_ ,\nthat can be used with D3.\n\n### Find Shapefiles\n\nSo-called _shapefiles_ predate the current explosion of online mapping and\nvisualization. These are documents that essentially contain the same kind of\ninformation you could store in GeoJSON — boundaries of geographic areas, and\npoints within those areas — but their contents are not plain text and,\ntherefore, are very hard to read. The shapefile format grew out of the\ncommunity of geographers, cartographers, and scientists using Geographic\nInformation Systems (GIS) software. If you have easy access to expensive GIS\nsoftware, then shapefiles are your best friend. But that’s a small group of\npeople, and web browsers can’t make heads or tails of shapefiles, in any case.\n\nIf you can’t find nice GeoJSON describing your area of interest, then hunt\ndown a shapefile. Government websites are good sources, especially if you’re\nlooking for data on a specific country or region. My favorite two sources are:\n\n[Natural Earth](http://www.naturalearthdata.com)\n\n> A massive collection of geographic data for both cultural/political and\n> natural features made available in the public domain. Mapping countries is\n> highly political, and Natural Earth posts detailed notes explaining their\n> design decisions.\n\n[The United States Census](http://www.census.gov/geo/www/cob/cbf_state.html)\n\n> Boundary data for every US state, plus counties, roadways, water features,\n> and so much more, also in the public domain.\n\n### Choose a Resolution\n\nBefore you download, check the _resolution_ of the data. All shapefiles are\nvector data (not bitmap), so by resolution I don’t mean pixels — I mean the\nlevel of _cartographic detail_ or granularity.\n\nNatural Earth’s datasets come in three different resolutions, listed here from\nmost detailed to least:\n\n  * 1:10,000,000 \n  * 1:50,000,000 \n  * 1:110,000,000 \n\nThat is, in the highest resolution data, one unit of measurement in the file\ncorresponds to 10 million such units in the actual, physical world. Or, to\nflip that around, every 10 million units in real life is simplified into one.\nSo 10 million inches (158 miles) would translate to a single inch in data\nterms.\n\nThese resolution ratios can be written more simply as:\n\n  * 1:10m \n  * 1:50m \n  * 1:110m \n\nFor a low-detail (“zoomed out”) map of the world, the 1:110m resolution could\nwork fine. But to show detailed outlines of a specific state, 1:10m will be\nbetter. If you’re mapping a very small (“zoomed in”) area, such as a specific\ncity or even neighborhood, then you’ll need much higher resolution data. (Try\nlocal state or city government websites for that information.)\n\nDifferent sources will offer different resolutions. Many of the US Census\nshapefiles are available in these three scales:\n\n  * 1:500,000 (1:500k) \n  * 1:5,000,000 (1:5m) \n  * 1:20,000,000 (1:20m) \n\nChoose a resolution, and download the file. Typically you’ll get a compressed\nZIP file that contains several other files. As an example, I’m going to\ndownload Natural Earth’s 1:110m (low detail) ocean file from here:\n<http://www.naturalearthdata.com/downloads/110m-physical-vectors/110m-ocean/>.\n\nUncompressed, it contains these files:\n\n    \n    \n    ne_110m_ocean.dbf\n    ne_110m_ocean.prj\n    ne_110m_ocean.README.html\n    ne_110m_ocean.shp\n    ne_110m_ocean.shx\n    ne_110m_ocean.VERSION.txt\n\nWow, those are some funky extensions. We’re primarily interested in the file\nending with _.shp_ , but don’t delete the rest just yet.\n\n### Simplify the Shapes\n\nIdeally, you can find shapefiles in exactly the resolution you need. But what\nif you can only find a super-high-resolution file, say at 1:100k? The size of\nthe file might be huge. And now that you’re a JavaScript programmer, you’re\nreally concerned about efficiency, remember? So no sending multimegabyte\ngeodata to the browser.\n\nFortunately, you can _simplify_ those shapefiles, in effect converting them\ninto lower-detail versions of themselves. The process of simplification is\nillustrated beautifully in [this interactive piece by Mike\nBostock](http://bost.ocks.org/mike/simplify/).\n\n[MapShaper](http://mapshaper.org), by Matt Bloch, is an excellent, easy-to-use\ninteractive tool for this purpose. It lets you upload your own shapefiles, and\nthen drag sliders around to preview different levels of simplification.\nTypically, the trade-off is between good detail and small files.\n\nIf you use MapShaper, choose the “Shapefile – polygons” option when exporting.\nThis will generate both a _.shp_ and a _.shx_ file for you. Download both\nfiles, and rename them so the filenames match the names of the original _.shp_\nand _.shx_ files. Then, before converting to GeoJSON, make a copy of the\noriginal _.dbf_ file, and put it in the same folder as the simplified\nshapefiles. This important step will ensure you don’t lose any of the\nimportant metadata that’s stored in the _.dbf_ , like country IDs and other\npath identifiers.\n\nOther options include Mike Migurski’s\n[Bloch](https://github.com/migurski/Bloch) with a Python implementation of\nMatt Bloch’s simplification algorithms, and a `d3.simplify` plug-in (used for\nMike’s demo mentioned earlier). The dream is one day we could use JavaScript\nto perform line simplification directly, and then export that simplified JSON\nto use in projects. The tools are evolving quickly, so watch this space!\n(Literally while I was writing this paragraph, Mr. Bostock posted [a\ndemo](http://bl.ocks.org/4090870) for a new project for geometry\nsimplification, [TopoJSON](https://github.com/mbostock/topojson). That’s how\nfast things are changing! By the time you read this, the TopoJSON command-line\ntool may be your best bet, as it can load shapefiles, perform simplification,\n_and_ convert your data to JSON. As you’d expect, TopoJSON is designed to play\nwell with D3, although it outputs a new TopoJSON format, which is similar to,\nbut more efficient than GeoJSON.)\n\n### Convert to GeoJSON\n\nIf you don’t already have the right software installed, this can be the\nhairiest part of the process. Our end goal is to get a terminal command called\n`ogr2ogr` running on your Mac, Unix, or Windows system. The problem is that\n`ogr2ogr` depends on several other frameworks, libraries, and so on, so for it\nto work, they all have to be in place.\n\nI won’t cover the intricacies of the installation here, but I’ll point you in\nthe right direction.\n\nFirst, you need [the Geospatial Data Abstraction\nLibrary](http://www.gdal.org), or GDAL. The `ogr2ogr` utility is part of this\npackage.\n\nYou also need [GEOS](http://trac.osgeo.org/geos/), which cleverly stands for\nGeometry Engine, Open Source.\n\nIf you have a Windows or Unix/Linux machine, you can now have fun downloading\nthe source and installing it by typing funny commands like **`build`** ,\n**`make`** , and **`seriously why isn’t this working omg please please please\ninstall this time or i will freak out`**.\n\nI don’t remember the exact command names, but they are something like that.\n(On a serious note, if you get stuck on this step, be aware that there are\nliterally entire other O’Reilly books on how to download and install software\npackages like this.)\n\nIf you’re on a Mac, and you happen to have both Xcode _and_ Homebrew\ninstalled, then simply type **`brew install gdal`** into the terminal, and\nyou’re done! (If you don’t have either of these amazing tools, they might be\nworth getting. Both tools are free, but could take some time and effort on\nyour part to install. Xcode is a massive [download from the App\nStore](http://bit.ly/XUTt81). Once you have Xcode, Homebrew can, in theory, be\ninstalled with [a simple terminal command](http://mxcl.github.com/homebrew/).\nIn my experience, some troubleshooting was required to get it working.)\n\nTo Mac users without Xcode or Homebrew: you are very lucky that some kind soul\nhas precompiled a friendly GUI installer, which installs GDAL, GEOS, and\nseveral other tools whose names you don’t really need to know. Look for the\nnewest version of the [“GDAL Complete”\npackage](http://www.kyngchaos.com/software/frameworks). Review the GDAL ReadMe\nfile closely. After installation, you won’t automatically be able to type\n**`ogr2ogr`** in a terminal window. You’ll need to add the GDAL programs to\nyour shell path. The easiest way to do that is: Open a new terminal window.\nType **`nano .bash_profile`**. Paste in `export\nPATH=/Library/Frameworks/GDAL.framework/Programs:$PATH` and then Control-X and\nControl-y to save. Type **`exit`** to end the session, then open a new\nterminal window and type **`ogr2ogr`** to see if it worked.\n\nNo matter what system you’re on, once all the tools are installed, open up a\nnew terminal window and navigate to whatever directory contains all the\nshapefiles (for example, **`cd ~/ocean_shapes/`**.) Then use the form:\n\n    \n    \n    ogr2ogr -f \"GeoJSON\" output.json filename.shp\n\nThis tells `ogr2ogr` to take `filename`, which should be a _.shp_ file,\nconvert it to GeoJSON, and finally save it as a file called _output.json_.\n\nFor my sample ocean data file, using `ogr2ogr` looks like the following:\n\n    \n    \n    ogr2ogr -f \"GeoJSON\" output.json ne_110m_ocean.shp\n\nType that in, and hopefully you see nothing at all.\n\nSo anticlimactic! I know, after the hours you spent hacking the command line\nto get ol’ `ogr` installed, you were expecting some gradiose finale, as though\nyou saved the princess in Super Mario 3, yet again. (I actually have never\ndone that, but I imagine it is pretty amazing.)\n\nBut no, hopefully nothing happened at all. Except there should be a new file\nin the same directory called _output.json_.\n\nHere’s the start of mine:\n\n    \n    \n    {\n    \"type\": \"FeatureCollection\",\n    \"features\": [ { \"type\": \"Feature\", \"properties\":\n    { \"scalerank\": 0, \"featurecla\": \"Ocean\" },\n    \"geometry\": { \"type\": \"Polygon\", \"coordinates\":\n        [ [ [ 49.110290527343778, 41.28228759765625 ],\n            [ 48.584472656250085, 41.80889892578125 ],\n        [ 47.492492675781335, 42.9866943359375 ],\n            [ 47.590881347656278, 43.660278320312528 ],\n        [ 46.682128906250028, 44.609313964843807 ],\n            [ 47.675903320312585, 45.641479492187557 ],\n        [ 48.645507812500085, 45.806274414062557 ]\n            …\n\nHey, finally, this is starting to look familiar!\n\nExcitedly, now we copy our new GeoJSON into our D3 directory. I rename mine\n_oceans.json_ , copy an earlier HTML document, and in the D3 code, simply\nchange the reference from `us-states.json` to `oceans.json`, and then get the\nresult shown in [Figure 12-8](part0016_split_006.html#oceans).\n\n![GeoJSON showing, um, the world’s oceans?](../images/00158.jpeg)\n\nFigure 12-8. GeoJSON showing, um, the world’s oceans?\n\nBlaaa! What is that?! Whatever it is, you can see it in _08_oceans.html_.\n\nIn my haste, I forgot to update the projection! Let’s make one tiny change,\nfrom `albersUsa` to `mercator` (see [Figure\n12-9](part0016_split_006.html#oceans2)).\n\n![GeoJSON of the world’s oceans, now properly projected](../images/00159.jpeg)\n\nFigure 12-9. GeoJSON of the world’s oceans, now properly projected\n\nSee the result in _09_mercator.html_ — oceanic GeoJSON paths, downloaded,\nparsed, and visualized.\n\n\n## Chapter 13. Exporting\n\nSometimes you need to take your visualization beyond the browser, such as when\nyou’re asked to present your work in a TED talk or in your first solo show at\nMoMA.\n\nHere are three easy ways to get D3 visualizations out of D3 and into formats\nsuitable for other, noninteractive media. D3 has no explicit “export” function\nbuilt in (although some people have built their own), so what follows are\nsimple techniques that will work for any SVG image in a web browser.\n\n\n## Bitmaps\n\nThe easiest and lowest-quality option is, obviously, to take a screenshot.\nDepending on your operating system, this can be done using the Print Screen\nbutton on a PC, or ⌘-Shift-4 on the Mac. (Drag those crosshairs over the area\nyou want to capture, release, and check your desktop for a PNG image.)\n\n[Figure 13-1](part0017_split_001.html#bitmap_export) is a bitmap screenshot I\nmade using the latter technique.\n\n![A PNG screenshot](../images/00160.jpeg)\n\nFigure 13-1. A PNG screenshot\n\nThis is easy and quick, but generates a bitmap image at screen resolution. So,\nas you can see, the image won’t scale up nicely, nor print with sharp edges.\nThis approach is probably suitable only for reuse on-screen. (The exception to\nthis is if you have a super high-res display, then the resolution will be much\nfiner.)\n\n\n## PDF\n\nPortable Document Format documents can contain vector-based artwork, such as\nSVG images, so exporting to PDF gives you a quick, scalable copy of your\nvisualization (see [Figure 13-2](part0017_split_002.html#pdf_export)).\n\n![A PDF maintains the original vector data for clarity](../images/00161.jpeg)\n\nFigure 13-2. A PDF maintains the original vector data for clarity\n\nOn the Mac, in your browser, go to File→Print. Then look for the PDF menu, and\nchoose Save as PDF.\n\nOn Windows or Linux, you might need to install a third-party utility to enable\nprint-to-PDF functionality. (I’ve heard doPDF for Windows works, and it’s\nfree.)\n\n\n## SVG\n\nFinally, it probably occurred to you that, because we are using D3 to generate\nimages in SVG format, why not just save out a copy of the SVG image? This has\nall the benefits of PDF: You maintain the original vector data, it’s scalable,\nand you can even bring the results into Illustrator or another SVG-compatible\neditor and tweak it after the fact. (This is true to a certain extent for PDF\nfiles as well, but depending on the PDF generator, sometimes elements get\ngrouped and layered in unexpected ways.)\n\nThe simplest way is to simply copy the SVG code straight out of the DOM (see\n[Figure 13-3](part0017_split_003.html#copy_the_svg)). First, inspect the SVG\nelement. Click the element in the web inspector, and then click Copy.\n\n![Copying the D3-generated SVG code from the DOM](../images/00162.jpeg)\n\nFigure 13-3. Copying the D3-generated SVG code from the DOM\n\nSwitch back to your text editor, and paste the contents into a new file, as\nshown in [Figure 13-4](part0017_split_003.html#paste_the_svg).\n\n![SVG code pasted into a new document](../images/00163.jpeg)\n\nFigure 13-4. SVG code pasted into a new document\n\nThen just save the file as _something.svg_. Now you can open it up in\nIllustrator, as shown in [Figure\n13-5](part0017_split_003.html#svg_in_illustrator), or any other SVG-compatible\nprogram.\n\n![Exported SVG opened in Illustrator](../images/00164.jpeg)\n\nFigure 13-5. Exported SVG opened in Illustrator\n\nAs you can see in [Figure 13-6](part0017_split_003.html#edit_the_svg), all of\nthe elements remain individually selectable and editable. In the version shown\nin [Figure 13-7](part0017_split_003.html#edited_svg_in_illustrator), I’ve made\nsome Tuftean enhancements to my design, adding variable-weight strokes and a\nneutral, lavender fill for a visually “calming” effect. (To be clear, this is\na joke, and neither Tufte nor I endorse this approach.)\n\n![SVG elements selected and highlighted](../images/00165.jpeg)\n\nFigure 13-6. SVG elements selected and highlighted\n\n![My groundbreaking image, made even more so with some manual touch-\nups](../images/00166.jpeg)\n\nFigure 13-7. My groundbreaking image, made even more so with some manual\ntouch-ups\n\nAs you can see, there are many options for getting your work out of the\nbrowser, documented, and saved for use in other contexts, whether for print or\nfor the screen.\n\n\n## Appendix A. Appendix: Further Study\n\nYou are a trouper for making it this far. We’ve covered a lot of ground, and\nby now you have a decent handle on D3’s basic concepts and common techniques.\nIf you’ve learned anything, I hope it’s that there are always several (or\ntens, or hundreds of) ways to accomplish the same task — that’s the joy of\nprogramming, right? I’ve presented the ways that, to me, are the simplest or\nmost intuitive, and the least difficult to understand. But there are probably\n_better_ ways to do anything that you learned in this book, whether “better”\nmeans “more computationally efficient” or “makes more sense to you and your\nway of working.” I’m a fan of the latter definition. Programming is like\nsolving a puzzle; it’s up to you to figure out how to tell the computer what\nto do what you want — using language that you, the human, can still\nunderstand.\n\nD3 is a powerful tool, and we’ve only scratched the surface. As you begin work\non your own visualization projects, you’ll discover many additional helpful\nmethods and sneaky shortcuts. There are lots of valuable bits that I didn’t\ncover here, such as D3’s built-in methods for working with date and time\nvalues, dynamically selecting and calculating colors, and painlessly\nmanipulating arrays, for all your client-side data processing needs — just to\nname a few. There is a _lot_ to this tool. I’ve tried to introduce you to the\ncore concepts, and now you’re ready to go dig into the pieces that really\ninterest you.\n\nSo, where to turn next? Here’s a collection of valuable resources to aid you\nin your quest. Keep in mind that the D3 software itself is still evolving, and\nso are these resources. By the time you read this, there might be some other\nhelpful website or set of tutorials not mentioned here. That is why I\nrecommend that you don’t just read, but _get involved_ with the D3 community.\nJoin [the Google Group](https://groups.google.com/forum/#!forum/d3-js), follow\npeople on Twitter, and keep your eyes open for the latest developments. Start\na discussion, and meet fellow data visualizers in your local area. If there\naren’t D3 datavis groups getting together in your area yet, then start one\nyourself. The more we can learn from each other, the better.\n\nAfter all, having worked through this book, you’re part of the community now\n(whether you like it or not). Welcome!\n\n\n## Books\n\n[ _Getting Starting with\nD3_](http://shop.oreilly.com/product/0636920025429.do) by Mike Dewar.\nO’Reilly, 2012.\n\nYes, there’s only one other book on D3 so far. Mike Dewar’s introduction\ntackles some more advanced topics, and includes sample projects with real-\nworld data from New York City’s transportation system. (Fun!)\n\n\n## Websites\n\n[d3js.org](http://d3js.org)\n\n> Your starting point for everything D3.\n\n[github.com/mbostock/d3/wiki/Gallery](https://github.com/mbostock/d3/wiki/Gallery)\n\n> The D3 gallery contains _hundreds_ of examples. Add your own work!\n\n[bl.ocks.org/mbostock](http://bl.ocks.org/mbostock)\n\n> Even more examples, in this case all by Mike Bostock, each one typically\n> highlighting just one of D3’s features.\n\n[github.com/mbostock/d3/wiki/API-\nReference](https://github.com/mbostock/d3/wiki/API-Reference)\n\n> The D3 API reference, an essential reference for every method and its\n> parameters.\n\n[stackoverflow.com/questions/tagged/d3.js](http://stackoverflow.com/questions/tagged/d3.js)\n\n> When you get stuck, post questions on StackOverflow with the `d3.js` tag.\n\n[groups.google.com/forum/?fromgroups#!forum/d3-js](https://groups.google.com/forum/?fromgroups#!forum/d3-js)\n\n> Everyone who’s anyone is on the D3 Google Group. Find out about the latest\n> projects and developments here. (Please save technical questions for\n> StackOverflow.)\n\n[bl.ocks.org](http://bl.ocks.org)\n\n> A service for posting code hosted on GitHub’s Gist, by Mike Bostock. Perfect\n> for quickly sharing your work with others, such as when seeking help on\n> StackOverflow or boasting about your latest triumph on the Google Group.\n\n[blog.visual.ly/creating-animations-and-transitions-\nwith-d3-js/](http://blog.visual.ly/creating-animations-and-transitions-\nwith-d3-js/)\n\n> An excellent tutorial on _Creating Animations and Transitions With D3_ with\n> lots of inline, interactive examples by Jérôme Cukier.\n\n[d3noob.org](http://www.d3noob.org)\n\n> A new, promising resource for D3 tips and tricks.\n\n[tributary.io](http://tributary.io)\n\n> A live-coding environment for experimenting with D3 code, by Ian Johnson.\n\n[D3 Plug-ins](https://github.com/d3/d3-plugins)\n\n> A listing of all the official plug-ins that extend D3’s functionality, in\n> case it doesn’t do enough for you already.\n\n\n## Twitterers\n\nTwitter is a great way to find out about the latest projects and D3\ndevelopments. At the risk of omitting many amazing people, here are some you\nshould follow:\n\n[@mbostock](https://twitter.com/mbostock)\n\n> Mike Bostock, for announcements on D3’s progress as well as new\n> visualizations for _The New York Times_.\n\n[@jasondavies](https://twitter.com/jasondavies)\n\n> Jason Davies, for all manner of geographic and mathematical mapping\n> experiments.\n\n[@d3visualization](https://twitter.com/d3visualization)\n\n> Christophe Viau, for frequent updates from all over the D3 universe.\n\n[@enjalot](https://twitter.com/enjalot)\n\n> Ian Johnson, for loads of new coding tools and techniques, plus video\n> tutorials.\n\n[@syntagmatic](https://twitter.com/syntagmatic)\n\n> Kai Chang, for too many D3 experiments to count.\n\n[@jcukier](https://twitter.com/jcukier)\n\n> Jérôme Cukier, for innovative visualization projects with insightful process\n> notes.\n\n[@darkgreener](https://twitter.com/darkgreener)\n\n> Anna Powell-Smith, for beautiful interactive visualizations that explore\n> personally relevant data.\n\n[@vlandham](https://twitter.com/vlandham)\n\n> Jim Vallandingham, for excellent process notes on projects as well as great\n> tutorials.\n\n[@alignedleft](https://twitter.com/alignedleft)\n\n> Scott Murray, for learning about errata, updates, and revisions to this\n> book, as well as future data-driven projects.\n\nI should acknowledge that, yes, there are mostly men listed here. As of this\nwriting, the community of D3 users and contributors tends to skew quite male.\nI hope that future editions of this book can confidently include a more\ndiverse listing.\n\n\n## Index\n\n* * *\n\n### A note on the digital index\n\nA link in an index entry is displayed as the section title in which that entry\nappears. Because some sections have multiple index markers, it is not unusual\nfor an entry to have several links to the same section. Clicking on any link\nwill take you directly to the place in the text in which the marker appears.\n\n* * *\n\n### Symbols\n\n3D drawing\n\n> alternative tools for, [Three-\n> Dimensional](part0006_split_004.html#I_indexterm2_id288213)\n>\n\n>> projections, [Projections](part0016_split_003.html#I_indexterm12_id317834)\n\n>\n\n>> “SVG (Scalable Vector Graphics)”\n\n> SVG transforms, [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305800)\n>\n\n>> ### A\n\naccessor functions, [d3.min() and\nd3.max()](part0011_split_005.html#I_indexterm7_id303853), [Updating all\nreferences](part0013_split_004.html#I_indexterm9_id311621)\n\n> Adobe Flash Player, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287441)\n\n> Alaska, map of,\n> [Projections](part0016_split_003.html#I_indexterm12_id317886)\n\n> Albers USA, [Projections](part0016_split_003.html#I_indexterm12_id317879)\n\n> alternative tools,\n> [Alternatives](part0006_split_004.html#ix_alttools)–[Tools Built with\n> D3](part0006_split_004.html#I_indexterm2_id288463)\n\n> ancestor elements, [DOM](part0007_split_003.html#I_indexterm3_id290181)\n\n> anonymous functions, [High-\n> Functioning](part0009_split_002.html#I_indexterm5_id298256), [Interaction\n> via Event Listeners](part0013_split_002.html#I_indexterm9_id307616)\n\n> Apache server software, [The\n> Web](part0007_split_001.html#I_indexterm3_id288660)\n\n> append() method, [Drawing\n> SVGs](part0010_split_003.html#I_indexterm6_id300207)\n\n> arbitrary order, overriding, [Ordinal Scales,\n> Explained](part0013_split_001.html#I_indexterm9_id306905)\n\n> arguments (input values),\n> [Functions](part0007_split_007.html#I_indexterm3_id293037), [Data Wants to\n> Be Held](part0009_split_002.html#I_indexterm5_id298503)\n\n> arrays, [Arrays](part0007_split_007.html#I_indexterm3_id291965), [What\n> arrays are made for()](part0007_split_007.html#I_indexterm3_id292927),\n> [Data](part0009_split_002.html#I_indexterm5_id297074)\n\n> arrays of objects, [Objects and\n> Arrays](part0007_split_007.html#I_indexterm3_id292294)\n\n> ascending order sort, [Click to\n> Sort](part0014_split_003.html#I_indexterm10_id314153)\n\n> assignment operators,\n> [Variables](part0007_split_007.html#I_indexterm3_id291845)\n\n> attr() method, [Beyond Text](part0009_split_002.html#I_indexterm5_id298648),\n> [Drawing SVGs](part0010_split_003.html#I_indexterm6_id300214)\n\n> attributes\n\n> assigning to HTML elements,\n> [Attributes](part0007_split_002.html#I_indexterm3_id289856)\n>\n\n>> in SVG elements, [Drawing\nSVGs](part0010_split_003.html#I_indexterm6_id300145)\n\n>\n\n>> setting, [Setting\nAttributes](part0010_split_001.html#I_indexterm6_id299071)\n\n>\n\n>> axes, [Axes](part0012_split_000.html#ix_axes)–[Formatting Tick\nLabels](part0012_split_007.html#I_indexterm8_id306577)\n\n> creating a generic axis, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305194)\n>\n\n>> dynamic quality of, [Final\nTouches](part0012_split_006.html#I_indexterm8_id306300)\n\n>\n\n>> graduated scales for (tick marks), [Check for\nTicks](part0012_split_004.html#I_indexterm8_id305997)\n\n>\n\n>> labelling, [Y Not?](part0012_split_005.html#I_indexterm8_id306113),\n[Formatting Tick Labels](part0012_split_007.html#I_indexterm8_id306441)\n\n>\n\n>> styling with CSS, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305556)\n\n>\n\n>> updating, [Updating Axes](part0013_split_003.html#I_indexterm9_id309231)\n\n>\n\n>> vs. scales, [Scales](part0011_split_000.html#I_indexterm7_id303231)\n\n>\n\n>> axis function, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305129)\n\n> ### B\n\nbar charts\n\n> adding color to, [Color](part0010_split_004.html#I_indexterm6_id301728)\n>\n\n>> adding labels to, [Labels](part0010_split_004.html#I_indexterm6_id302068)\n\n>\n\n>> creating scalable flexible, [Modernizing the Bar\nChart](part0013_split_001.html#ix_bcscal)\n\n>\n\n>> creating simple, [Drawing\ndivs](part0010_split_001.html#I_indexterm6_id298882), [Making a Bar\nChart](part0010_split_004.html#ix_bchrt)–[Labels](part0010_split_004.html#I_indexterm6_id302363)\n\n>\n\n>> creating stacked bar charts, [Stack\nLayout](part0015_split_002.html#I_indexterm11_id316577)\n\n>\n\n>> updating color of, [Updating the\nVisuals](part0013_split_002.html#I_indexterm9_id307908)\n\n>\n\n>> updating labels for, [Updating the\nVisuals](part0013_split_002.html#I_indexterm9_id307933)\n\n>\n\n>> barPadding, [Referencing the Ordinal\nScale](part0013_split_001.html#I_indexterm9_id307336)\n\n> behaviors, [Introducing Behaviors](part0014_split_002.html#ix_beh)–[Click to\n> Sort](part0014_split_003.html#I_indexterm10_id314250)\n\n> binding to multiple elements with, [Introducing\n> Behaviors](part0014_split_002.html#I_indexterm10_id312637)\n>\n\n>> click to sort, [Click to\nSort](part0014_split_003.html#I_indexterm10_id313749)\n\n>\n\n>> grouping SVG elements, [Grouping SVG\nElements](part0014_split_003.html#I_indexterm10_id313642)\n\n>\n\n>> hover to highlight, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id312750)\n\n>\n\n>> overlapping elements and, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313422)\n\n>\n\n>> bitmap map tiles, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287235)\n\n> Bloch, Matt, [Simplify the\n> Shapes](part0016_split_006.html#I_indexterm12_id319169)\n\n> block-level elements, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290699)\n\n> block-level scope, [Function-level\n> scope](part0007_split_007.html#I_indexterm3_id293548)\n\n> Bostock, Michael, [Introducing\n> D3](part0006_split_000.html#I_indexterm2_id286898), [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287471)\n\n> box model, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290582)\n\n> browsers\n\n> development of interactivity, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287348)\n>\n\n>> fundamentals of, [The Web](part0007_split_001.html#I_indexterm3_id288680)\n\n>\n\n>> rendering, [Rendering and the Box\nModel](part0007_split_005.html#I_indexterm3_id290588)\n\n>\n\n>> support for, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287168)\n\n>\n\n>> SVG compatibility, [A Note on\nCompatibility](part0007_split_009.html#I_indexterm3_id295474)\n\n>\n\n>> ### C\n\ncallback function, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297179), [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297396)\n\n> Card, Stuart, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287398)\n\n> cartographic detail, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318970)\n\n> cascading styles, [Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291567)\n\n> categorical colors, [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316383)\n\n> centroids, [Pie Layout](part0015_split_001.html#I_indexterm11_id316452)\n\n> chain syntax, [Chaining\n> Methods](part0009_split_001.html#I_indexterm5_id296535)\n\n> chaining methods\n\n> alternatives to, [The Hand-\n> off](part0009_split_001.html#I_indexterm5_id296885)\n>\n\n>> chain syntax, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296541)\n\n>\n\n>> examining the links, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296622)\n\n>\n\n>> input/output matching, [The Hand-\noff](part0009_split_001.html#I_indexterm5_id296850)\n\n>\n\n>> charts\n\n> alternative tools for, [Easy\n> Charts](part0006_split_004.html#I_indexterm2_id287622)\n>\n\n>> column charts, [Drawing\ndivs](part0010_split_001.html#I_indexterm6_id298891)\n\n>\n\n>> (see also bar charts)\n\n>>\n\n>>> pie charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316054)\n\n>\n\n>> ring charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316480)\n\n>\n\n>> child elements, [DOM](part0007_split_003.html#I_indexterm3_id290169)\n\n> choropleth maps,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318117)\n\n> Chrome, development tools, [Developer\n> Tools](part0007_split_004.html#I_indexterm3_id290378)\n\n> cities, adding to map, [Adding\n> Points](part0016_split_005.html#I_indexterm12_id318465)\n\n> class selectors, [Selectors](part0007_split_006.html#I_indexterm3_id290954)\n\n> classed() method, [A Note on\n> Classes](part0010_split_001.html#I_indexterm6_id299308)\n\n> classes\n\n> adding to elements, [Drawing\n> divs](part0010_split_001.html#I_indexterm6_id299041)\n>\n\n>> identifying elements with, [Classes and\nIDs](part0007_split_002.html#I_indexterm3_id289937)\n\n>\n\n>> vs. styles, [A Note on\nClasses](part0010_split_001.html#I_indexterm6_id299284)\n\n>\n\n>> click events, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307674), [Binding Event\nListeners](part0014_split_001.html#I_indexterm10_id312508), [Consideration for\nTouch Devices](part0014_split_005.html#I_indexterm10_id315724)\n\n> click to sort, [Click to\n> Sort](part0014_split_003.html#I_indexterm10_id313759)\n\n> clipping paths, [Containing visual elements with clipping\n> paths](part0013_split_003.html#I_indexterm9_id309907)\n\n> Cloudmade, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287253)\n\n> coding tips\n\n> chaining methods, [The Hand-\n> off](part0009_split_001.html#I_indexterm5_id296876)\n>\n\n>> deconstructing code, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296614)\n\n>\n\n>> increasing legibility, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296592)\n\n>\n\n>> limit to active transitions, [Warning: Start\ncarefully](part0013_split_003.html#I_indexterm9_id309601)\n\n>\n\n>> styling SVG elements, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305714)\n\n>\n\n>> using functions to hold data, [Data Wants to Be\nHeld](part0009_split_002.html#I_indexterm5_id298441)\n\n>\n\n>> color property, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305644)\n\n> colors, [Pretty Colors,\n> Oooh!](part0010_split_003.html#I_indexterm6_id300713), [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316389)\n\n> column charts, [Drawing divs](part0010_split_001.html#I_indexterm6_id298876)\n\n> comments, [Comments](part0007_split_002.html#I_indexterm3_id290095),\n> [Properties and Values](part0007_split_006.html#I_indexterm3_id291200),\n> [Functions](part0007_split_007.html#I_indexterm3_id293139)\n\n> communication protocol, [The\n> Web](part0007_split_001.html#I_indexterm3_id288771)\n\n> comparison operators, [Comparison\n> Operators](part0007_split_007.html#I_indexterm3_id292597)\n\n> containers, [Classes and\n> IDs](part0007_split_002.html#I_indexterm3_id290036), [Hello,\n> Console](part0007_split_007.html#I_indexterm3_id291805)\n\n> continuous ranges, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307104)\n\n> control structures, [Control\n> Structures](part0007_split_007.html#I_indexterm3_id292676)\n\n> coordinate values, locating, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317570), [Adding\n> Points](part0016_split_005.html#I_indexterm12_id318541)\n\n> CSS (Cascading Style Sheets),\n> [CSS](part0007_split_006.html#ix_CSS)–[Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291670)\n\n> applying to axes, [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305565)\n>\n\n>> cascading, [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#I_indexterm3_id291558)\n\n>\n\n>> comments, [Properties and\nValues](part0007_split_006.html#I_indexterm3_id291192)\n\n>\n\n>> CSS rule, [CSS](part0007_split_006.html#I_indexterm3_id290837)\n\n>\n\n>> hover effect, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id312764)\n\n>\n\n>> inheritance, [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#I_indexterm3_id291467)\n\n>\n\n>> methods of applying, [Referencing\nStyles](part0007_split_006.html#I_indexterm3_id291237)\n\n>\n\n>> properties and values, [Properties and\nValues](part0007_split_006.html#I_indexterm3_id291076), [Beyond\nText](part0009_split_002.html#I_indexterm5_id298615)\n\n>\n\n>> selectors and properties,\n[CSS](part0007_split_006.html#I_indexterm3_id290770)\n\n>\n\n>> specificity, [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#I_indexterm3_id291649)\n\n>\n\n>> CSV (comma-separated value files),\n[Data](part0009_split_000.html#I_indexterm5_id296265),\n[Data](part0009_split_002.html#I_indexterm5_id297100)\n\n> ### D\n\nD3\n\n> alternative tools,\n> [Alternatives](part0006_split_004.html#ix_D3alttools)–[Tools Built with\n> D3](part0006_split_004.html#I_indexterm2_id288472)\n>\n\n>> browser support, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287158)\n\n>\n\n>> core concepts of, [Next\nSteps](part0010_split_006.html#I_indexterm6_id303091)\n\n>\n\n>> creating a project template, [Referencing\nD3](part0008_split_002.html#I_indexterm4_id295836)\n\n>\n\n>> data sharing in, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287293)\n\n>\n\n>> development of, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287510)\n\n>\n\n>> downloading, [Introducing\nD3](part0006_split_000.html#I_indexterm2_id286919),\n[Setup](part0008_split_000.html#I_indexterm4_id295602)\n\n>\n\n>> explanatory visualizations with, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287132)\n\n>\n\n>> geomapping in, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287218)\n\n>\n\n>> meaning of name, [Introducing\nD3](part0006_split_000.html#I_indexterm2_id286857)\n\n>\n\n>> prerequisites to learning, [What This Book\nIs](part0005_split_005.html#I_indexterm1_id286560), [Who You\nAre](part0005_split_006.html#I_indexterm1_id286634)\n\n>\n\n>> referencing for setup, [Referencing\nD3](part0008_split_002.html#I_indexterm4_id295710)\n\n>\n\n>> resources for, [Appendix: Further\nStudy](part0018_split_000.html#I_indexterm_id320103)\n\n>\n\n>> setting up a web server for, [Setting Up a Web\nServer](part0008_split_003.html#I_indexterm4_id295872)\n\n>\n\n>> underlying processes, [What It\nDoes](part0006_split_001.html#I_indexterm2_id286968)\n\n>\n\n>> d3.csv () method, [Data](part0009_split_002.html#I_indexterm5_id297106)\n\n> d3.json() method, [Loading JSON\n> data](part0009_split_002.html#I_indexterm5_id297539)\n\n> d3.range() method, [Ordinal Scales,\n> Explained](part0013_split_001.html#I_indexterm9_id306965)\n\n> data, [Data](part0009_split_000.html#ix_data)–[Beyond\n> Text](part0009_split_002.html#I_indexterm5_id298782)\n\n> acceptable file types,\n> [Data](part0009_split_000.html#I_indexterm5_id296244),\n> [Data](part0009_split_002.html#I_indexterm5_id297065)\n>\n\n>> binding to elements, [Binding\nData](part0009_split_002.html#ix_databind)–[Bound and\nDetermined](part0009_split_002.html#I_indexterm5_id298082), [Data Joins with\nKeys](part0013_split_004.html#I_indexterm9_id311325)\n\n>\n\n>> creating page elements for,\n[Data](part0009_split_000.html#ix_pgelem)–[Going\nChainless](part0009_split_001.html#I_indexterm5_id296925)\n\n>\n\n>> holding with functions, [Data Wants to Be\nHeld](part0009_split_002.html#I_indexterm5_id298450)\n\n>\n\n>> storage of, [Data](part0009_split_000.html#I_indexterm5_id296212)\n\n>\n\n>> updating of (see updates)\n\n>\n\n>> using bound data, [Using Your\nData](part0009_split_002.html#ix_bound)–[Beyond\nText](part0009_split_002.html#I_indexterm5_id298789)\n\n>\n\n>> verifying, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297369)\n\n>\n\n>> data arrays, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297258)\n\n> data joins, [Data Joins with Keys](part0013_split_004.html#ix_dajoin)–[Exit\n> transition](part0013_split_004.html#I_indexterm9_id311998)\n\n> controlling order of, [Data Joins with\n> Keys](part0013_split_004.html#I_indexterm9_id311350)\n>\n\n>> defining key functions, [Key\nfunctions](part0013_split_004.html#I_indexterm9_id311702)\n\n>\n\n>> exit ranstitions, [Exit\ntransition](part0013_split_004.html#I_indexterm9_id311799)\n\n>\n\n>> preparing data for, [Preparing the\ndata](part0013_split_004.html#I_indexterm9_id311440)\n\n>\n\n>> updating references, [Updating all\nreferences](part0013_split_004.html#I_indexterm9_id311565)\n\n>\n\n>> data loading, error handling, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297363)\n\n> data mapping\n\n> benefits of computation, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286378)\n>\n\n>> binding data for, [Binding\nData](part0009_split_002.html#I_indexterm5_id296987)\n\n>\n\n>> design application in, [What It\nDoes](part0006_split_001.html#I_indexterm2_id287058)\n\n>\n\n>> data sharing, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287286)\n\n> data strings, [Loading CSV\n> data](part0009_split_002.html#I_indexterm5_id297316)\n\n> data values\n\n> encoding as color, [Color](part0010_split_004.html#I_indexterm6_id301798)\n>\n\n>> multi-value maps, [Color](part0010_split_004.html#I_indexterm6_id301936)\n\n>\n\n>> data visualization\n\n> benefits of, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286422)\n>\n\n>> benefits of interactivity, [Why\nInteractive?](part0005_split_003.html#I_indexterm1_id286451)\n\n>\n\n>> benefits of web-standard technologies, [Why on the\nWeb?](part0005_split_004.html#I_indexterm1_id286516)\n\n>\n\n>> early applications for, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287410)\n\n>\n\n>> exporting to other file types,\n[Exporting](part0017_split_000.html#ix_dvexp)–[SVG](part0017_split_003.html#I_indexterm13_id320064)\n\n>\n\n>> data() method, [Using Your\nData](part0009_split_002.html#I_indexterm5_id298209), [Setting\nStyles](part0010_split_001.html#I_indexterm6_id299653)\n\n> Data-Driven Documents (see D3)\n\n> data-driven shapes, [Data-Driven\n> Shapes](part0010_split_003.html#I_indexterm6_id300371)\n\n> Davies, Jason, [Projections](part0016_split_003.html#I_indexterm12_id318078)\n\n> degrees vs. radians, [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316075)\n\n> descendant elements, [DOM](part0007_split_003.html#I_indexterm3_id290187)\n\n> descendant selectors,\n> [Selectors](part0007_split_006.html#I_indexterm3_id290921)\n\n> descending order sort, [Click to\n> Sort](part0014_split_003.html#I_indexterm10_id314159)\n\n> design systems, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286401)\n\n> developer tools, [Developer\n> Tools](part0007_split_004.html#ix_devtool)–[Developer\n> Tools](part0007_split_004.html#I_indexterm3_id290518)\n\n> discrete ranges, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307097)\n\n> div attribute, [Drawing divs](part0010_split_001.html#I_indexterm6_id298850)\n\n> div element, [Classes and\n> IDs](part0007_split_002.html#I_indexterm3_id290028)\n\n> DOM (Document Object Model)\n\n> appending SVG elements with axis function, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305330)\n>\n\n>> examining current state of, [Developer\nTools](part0007_split_004.html#I_indexterm3_id290427)\n\n>\n\n>> hierarchial structure, [DOM](part0007_split_003.html#I_indexterm3_id290145)\n\n>\n\n>> interacting with event listeners, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307588)\n\n>\n\n>> styling with CSS, [CSS](part0007_split_006.html#I_indexterm3_id290743)\n\n>\n\n>> domain name, [The Web](part0007_split_001.html#I_indexterm3_id288786)\n\n> drawing\n\n> alternative tools for, [Almost from\n> Scratch](part0006_split_004.html#I_indexterm2_id288113)\n>\n\n>> irregular forms, [Pie\nLayout](part0015_split_001.html#I_indexterm11_id316204)\n\n>\n\n>> drawing order, [Layering and Drawing\nOrder](part0007_split_008.html#I_indexterm3_id295037)\n\n> dual encoding, [Color](part0010_split_004.html#I_indexterm6_id301813)\n\n> dynamic axes, [Final Touches](part0012_split_006.html#I_indexterm8_id306309)\n\n> dynamic paragraphs, [Please Make Your\n> Selection](part0009_split_002.html#I_indexterm5_id297631), [Beyond\n> Text](part0009_split_002.html#I_indexterm5_id298770)\n\n> dynamic scaling, [Creating a\n> Scale](part0011_split_004.html#I_indexterm7_id303669), [Setting Up Dynamic\n> Scales](part0011_split_005.html#I_indexterm7_id303930)\n\n> ### E\n\neach() statements, [each() Transition Starts and\nEnds](part0013_split_003.html#I_indexterm9_id309452)\n\n> easing, [ease()-y Does It](part0013_split_003.html#I_indexterm9_id308317)\n\n> edges, [Force Layout](part0015_split_003.html#I_indexterm11_id316928)\n\n> elements\n\n> adding, [Adding Values (and\n> Elements)](part0013_split_004.html#I_indexterm9_id310355)\n>\n\n>> adding a class to, [Drawing\ndivs](part0010_split_001.html#I_indexterm6_id299033)\n\n>\n\n>> adding structure with, [Adding Structure with\nElements](part0007_split_002.html#I_indexterm3_id289291)\n\n>\n\n>> applying styles to, [Styling SVG\nElements](part0007_split_008.html#I_indexterm3_id294548)\n\n>\n\n>> description of, [DOM](part0007_split_003.html#I_indexterm3_id290154)\n\n>\n\n>> group elements, [Setting Up an\nAxis](part0012_split_002.html#I_indexterm8_id305364)\n\n>\n\n>> encoding values, [Color](part0010_split_004.html#I_indexterm6_id301807)\n\n> enter() method, [Please Make Your\n> Selection](part0009_split_002.html#I_indexterm5_id297624)\n\n> event listeners, [Interaction via Event\n> Listeners](part0013_split_002.html#I_indexterm9_id307522), [Binding Event\n> Listeners](part0014_split_001.html#I_indexterm10_id312406), [Introducing\n> Behaviors](part0014_split_002.html#I_indexterm10_id312631)\n\n> event model, [Binding Event\n> Listeners](part0014_split_001.html#I_indexterm10_id312430)\n\n> exit selection, [Removing Values (and\n> Elements)](part0013_split_004.html#I_indexterm9_id310946)\n\n> exiting elements, [Exit](part0013_split_004.html#I_indexterm9_id311004)\n\n> exploratory vs. explanatory visualizations, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287141)\n\n> exporting,\n> [Exporting](part0017_split_000.html#ix_expvis)–[SVG](part0017_split_003.html#I_indexterm13_id320071)\n\n> bitmaps, [Bitmaps](part0017_split_001.html#I_indexterm13_id319710)\n>\n\n>> PDFs, [PDF](part0017_split_002.html#I_indexterm13_id319786)\n\n>\n\n>> SVG format, [SVG](part0017_split_003.html#I_indexterm13_id319857)\n\n>\n\n>> external style sheets, [Reference an external stylesheet from the\nHTML.](part0007_split_006.html#I_indexterm3_id291336)\n\n> ### F\n\nFirefox, development tools, [Developer\nTools](part0007_split_004.html#I_indexterm3_id290384)\n\n> Flare, [Origins and Context](part0006_split_003.html#I_indexterm2_id287435)\n\n> for loops, [for() now](part0007_split_007.html#I_indexterm3_id292769), [The\n> Power of data()](part0010_split_002.html#I_indexterm6_id299777)\n\n> force layout, [Force Layout](part0015_split_003.html#ix_force)–[Force\n> Layout](part0015_split_003.html#I_indexterm11_id317342)\n\n> formatting functions, testing, [Formatting Tick\n> Labels](part0012_split_007.html#I_indexterm8_id306519)\n\n> function-level scope, [Function-level\n> scope](part0007_split_007.html#I_indexterm3_id293508)\n\n> functions\n\n> accessor function, [d3.min() and\n> d3.max()](part0011_split_005.html#I_indexterm7_id303859), [Updating all\n> references](part0013_split_004.html#I_indexterm9_id311627)\n>\n\n>> anonymous functions, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298269), [Interaction via\nEvent Listeners](part0013_split_002.html#I_indexterm9_id307632)\n\n>\n\n>> axis function, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305135)\n\n>\n\n>> basic code structure of, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298246)\n\n>\n\n>> callback function, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297185), [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297402)\n\n>\n\n>> D3 scales as, [Scales](part0011_split_000.html#I_indexterm7_id303197)\n\n>\n\n>> event listeners, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307623)\n\n>\n\n>> named functions, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298277), [Interaction via\nEvent Listeners](part0013_split_002.html#I_indexterm9_id307597)\n\n>\n\n>> passing arguments to,\n[Functions](part0007_split_007.html#I_indexterm3_id293029)\n\n>\n\n>> used as arguments, [Data Wants to Be\nHeld](part0009_split_002.html#I_indexterm5_id298509)\n\n>\n\n>> vs. methods, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296562)\n\n>\n\n>> ### G\n\ngeocoding services, [Adding\nPoints](part0016_split_005.html#I_indexterm12_id318535)\n\n> Geographic Information Systems (GIS) software, [Find\n> Shapefiles](part0016_split_006.html#I_indexterm12_id318884)\n\n> GeoJSON, [GeoJSON](part0007_split_007.html#I_indexterm3_id292482), [JSON,\n> Meet GeoJSON](part0016_split_001.html#I_indexterm12_id317411), [Convert to\n> GeoJSON](part0016_split_006.html#I_indexterm12_id319287)\n\n> geomapping, [JSON, Meet GeoJSON](part0016_split_001.html#ix_geom)–[Convert\n> to GeoJSON](part0016_split_006.html#I_indexterm12_id319635)\n\n> acquiring/parsing geodata, [Acquiring and Parsing\n> Geodata](part0016_split_006.html#ix_gapg)–[Convert to\n> GeoJSON](part0016_split_006.html#I_indexterm12_id319642)\n>\n\n>> alternative tools for,\n[Geomapping](part0006_split_004.html#I_indexterm2_id287979)\n\n>\n\n>> choropleth, [Choropleth](part0016_split_004.html#I_indexterm12_id318108)\n\n>\n\n>> D3 support for, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287226)\n\n>\n\n>> GeoJSON, [JSON, Meet\nGeoJSON](part0016_split_001.html#I_indexterm12_id317403)\n\n>\n\n>> map points, [Adding Points](part0016_split_005.html#I_indexterm12_id318444)\n\n>\n\n>> paths, [Paths](part0016_split_002.html#I_indexterm12_id317606)\n\n>\n\n>> projections, [Projections](part0016_split_003.html#I_indexterm12_id317819)\n\n>\n\n>> geometry simplification, [Simplify the\nShapes](part0016_split_006.html#I_indexterm12_id319182)\n\n> global namespace, [Global\n> namespace](part0007_split_007.html#I_indexterm3_id293604)\n\n> Google Maps, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287247)\n\n> graduated scale, [Check for\n> Ticks](part0012_split_004.html#I_indexterm8_id306012)\n\n> granularity, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318989)\n\n> graphs\n\n> alternative tools for, [Graph\n> Visualizations](part0006_split_004.html#I_indexterm2_id287894)\n>\n\n>> creating with force layouts, [Force\nLayout](part0015_split_003.html#I_indexterm11_id316910)\n\n>\n\n>> (see also charts)\n\n>>\n\n>>> group elements, [Setting Up an\nAxis](part0012_split_002.html#I_indexterm8_id305374)\n\n> ### H\n\nHawaii, map of, [Projections](part0016_split_003.html#I_indexterm12_id317892)\n\n> Heer, Jeffrey, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287392)\n\n> horizontal axis, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305295)\n\n> hover to highlight, [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id312758)\n\n> HTML (Hypertext Markup Language),\n> [HTML](part0007_split_002.html#ix_HTML)–[Comments](part0007_split_002.html#I_indexterm3_id290123)\n\n> attributes, [Attributes](part0007_split_002.html#I_indexterm3_id289848),\n> [Beyond Text](part0009_split_002.html#I_indexterm5_id298633)\n>\n\n>> classes and IDs, [Classes and\nIDs](part0007_split_002.html#I_indexterm3_id289927)\n\n>\n\n>> comments, [Comments](part0007_split_002.html#I_indexterm3_id290087)\n\n>\n\n>> common elements, [Common\nElements](part0007_split_002.html#I_indexterm3_id289420)\n\n>\n\n>> specifying structure with, [Content Plus\nStructure](part0007_split_002.html#I_indexterm3_id289016)\n\n>\n\n>> tags and elements, [Adding Structure with\nElements](part0007_split_002.html#I_indexterm3_id289276)\n\n>\n\n>> HTML div tooltips, [HTML div\nTooltips](part0014_split_004.html#I_indexterm10_id314709)\n\n> HTTP (Hypertext Transfer Protocol), [The\n> Web](part0007_split_001.html#I_indexterm3_id288779)\n\n> HTTPS (Hypertext Transfer Protocol Secure), [The\n> Web](part0007_split_001.html#I_indexterm3_id288842)\n\n> ### I\n\nID selectors, [Selectors](part0007_split_006.html#I_indexterm3_id291010)\n\n> IDs, [Classes and IDs](part0007_split_002.html#I_indexterm3_id290005)\n\n> if statements, [Control\n> Structures](part0007_split_007.html#I_indexterm3_id292682)\n\n> immediate transformations, [Warning: Start\n> carefully](part0013_split_003.html#I_indexterm9_id309685)\n\n> index order, [Data Joins with\n> Keys](part0013_split_004.html#I_indexterm9_id311367)\n\n> InfoVis paper, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287532)\n\n> inheritance, [Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291476)\n\n> inline elements, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290705)\n\n> inline styles, [Attach inline\n> styles.](part0007_split_006.html#I_indexterm3_id291388)\n\n> input domain, [Domains and\n> Ranges](part0011_split_002.html#I_indexterm7_id303329)\n\n> interactivity, [Interactivity](part0014_split_000.html#ix_interact)–[Moving\n> Forward](part0014_split_006.html#I_indexterm10_id315791)\n\n> behaviors, [Introducing\n> Behaviors](part0014_split_002.html#I_indexterm10_id312611)\n>\n\n>> benefits of, [Why\nInteractive?](part0005_split_003.html#I_indexterm1_id286460)\n\n>\n\n>> browser development and, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287357)\n\n>\n\n>> click to sort, [Click to\nSort](part0014_split_003.html#I_indexterm10_id313772)\n\n>\n\n>> event listeners and, [Binding Event\nListeners](part0014_split_001.html#I_indexterm10_id312396)\n\n>\n\n>> hover to highlight, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id312773)\n\n>\n\n>> pointer events, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313431)\n\n>\n\n>> tooltips, [Tooltips](part0014_split_004.html#I_indexterm10_id314291)\n\n>\n\n>> touch devices, [Consideration for Touch\nDevices](part0014_split_005.html#I_indexterm10_id315736)\n\n>\n\n>> Internet Explorer, [The SVG\nElement](part0007_split_008.html#I_indexterm3_id293940), [A Note on\nCompatibility](part0007_split_009.html#I_indexterm3_id295459)\n\n> ### J\n\nJavaScript, [JavaScript](part0007_split_007.html#ix_Java)–[Global\nnamespace](part0007_split_007.html#I_indexterm3_id293825)\n\n> arrays, [Arrays](part0007_split_007.html#I_indexterm3_id291955), [What\n> arrays are made for()](part0007_split_007.html#I_indexterm3_id292918)\n>\n\n>> arrays of objects, [Objects and\nArrays](part0007_split_007.html#I_indexterm3_id292285)\n\n>\n\n>> as basis for D3, [What This Book\nIs](part0005_split_005.html#I_indexterm1_id286598)\n\n>\n\n>> comments, [Functions](part0007_split_007.html#I_indexterm3_id293146)\n\n>\n\n>> comparison operators, [Comparison\nOperators](part0007_split_007.html#I_indexterm3_id292588)\n\n>\n\n>> control structures, [Control\nStructures](part0007_split_007.html#I_indexterm3_id292667)\n\n>\n\n>> event model, [Binding Event\nListeners](part0014_split_001.html#I_indexterm10_id312436)\n\n>\n\n>> function-level scope, [Function-level\nscope](part0007_split_007.html#I_indexterm3_id293499)\n\n>\n\n>> functions, [Functions](part0007_split_007.html#I_indexterm3_id293020)\n\n>\n\n>> GeoJSON, [GeoJSON](part0007_split_007.html#I_indexterm3_id292473)\n\n>\n\n>> global namespace, [Global\nnamespace](part0007_split_007.html#I_indexterm3_id293595)\n\n>\n\n>> introduction of, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287329)\n\n>\n\n>> JSON, [JSON](part0007_split_007.html#I_indexterm3_id292406)\n\n>\n\n>> mathematical operators, [Mathematical\nOperators](part0007_split_007.html#I_indexterm3_id292529)\n\n>\n\n>> objects, [Objects](part0007_split_007.html#I_indexterm3_id292210)\n\n>\n\n>> opening the JS console, [Hello,\nConsole](part0007_split_007.html#I_indexterm3_id291721)\n\n>\n\n>> scripts, [Referencing\nScripts](part0007_split_007.html#I_indexterm3_id293189)\n\n>\n\n>> variable autotyping, [JavaScript\nGotchas](part0007_split_007.html#I_indexterm3_id293251)\n\n>\n\n>> variable hoisting, [Variable\nhoisting](part0007_split_007.html#I_indexterm3_id293416)\n\n>\n\n>> variables, [Hello, Console](part0007_split_007.html#I_indexterm3_id291790)\n\n>\n\n>> jQuery, [Warning: Start\ncarefully](part0013_split_003.html#I_indexterm9_id309658)\n\n> JSON (JavaScript Object Notation),\n> [JSON](part0007_split_007.html#I_indexterm3_id292416),\n> [Data](part0009_split_000.html#I_indexterm5_id296271), [Loading CSV\n> data](part0009_split_002.html#I_indexterm5_id297520)\n\n> ### K\n\nkey functions, [Data Joins with\nKeys](part0013_split_004.html#I_indexterm9_id311382), [Key\nfunctions](part0013_split_004.html#I_indexterm9_id311694)\n\n> ### L\n\nlabels\n\n> for axes, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305233), [Y\n> Not?](part0012_split_005.html#I_indexterm8_id306121), [Formatting Tick\n> Labels](part0012_split_007.html#I_indexterm8_id306433)\n>\n\n>> for bar charts, [Updating the\nVisuals](part0013_split_002.html#I_indexterm9_id307943)\n\n>\n\n>> Landay, James, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287404)\n\n> latitude, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317532)\n\n> layering, [Layering and Drawing\n> Order](part0007_split_008.html#I_indexterm3_id295044)\n\n> layouts, [Layouts](part0015_split_000.html#ix_lay)–[Force\n> Layout](part0015_split_003.html#I_indexterm11_id317328)\n\n> force layout, [Force Layout](part0015_split_003.html#ix_lflay)–[Force\n> Layout](part0015_split_003.html#I_indexterm11_id317335)\n>\n\n>> list of, [Layouts](part0015_split_000.html#I_indexterm11_id315841)\n\n>\n\n>> pie layout, [Pie Layout](part0015_split_001.html#I_indexterm11_id316040)\n\n>\n\n>> stack layout, [Stack\nLayout](part0015_split_002.html#I_indexterm11_id316561)\n\n>\n\n>> linear scales, [Scales](part0011_split_000.html#I_indexterm7_id303256)\n\n> local servers, [The Web](part0007_split_001.html#I_indexterm3_id288643)\n\n> longitude, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317525)\n\n> ### M\n\nmagic numbers, [Updating\nScales](part0013_split_003.html#I_indexterm9_id308944)\n\n> map points, [Adding Points](part0016_split_005.html#I_indexterm12_id318459)\n\n> map tiles, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287241)\n\n> mapping rules, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286395)\n\n> maps\n\n> choropleth maps,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318144)\n>\n\n>> Google Maps, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287259)\n\n>\n\n>> multi-value, [Color](part0010_split_004.html#I_indexterm6_id301951)\n\n>\n\n>> political maps,\n[Choropleth](part0016_split_004.html#I_indexterm12_id318136)\n\n>\n\n>> population maps, [Adding\nPoints](part0016_split_005.html#I_indexterm12_id318553)\n\n>\n\n>> United States map, [JSON, Meet\nGeoJSON](part0016_split_001.html#I_indexterm12_id317417)\n\n>\n\n>> (see also geomapping)\n\n>>\n\n>>> MapShaper, [Simplify the\nShapes](part0016_split_006.html#I_indexterm12_id319175)\n\n> masks, [Containing visual elements with clipping\n> paths](part0013_split_003.html#I_indexterm9_id309924)\n\n> mathematical operators, [Mathematical\n> Operators](part0007_split_007.html#I_indexterm3_id292538)\n\n> maximum value, [Updating\n> Scales](part0013_split_003.html#I_indexterm9_id308950)\n\n> methods, vs. functions, [Chaining\n> Methods](part0009_split_001.html#I_indexterm5_id296570)\n\n> Migurski, Mike, [Simplify the\n> Shapes](part0016_split_006.html#I_indexterm12_id319254)\n\n> mouseover events, [Binding Event\n> Listeners](part0014_split_001.html#I_indexterm10_id312514), [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id312743), [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id313392)\n\n> multi-value maps, [Color](part0010_split_004.html#I_indexterm6_id301945)\n\n> multitouch interactions, [Consideration for Touch\n> Devices](part0014_split_005.html#I_indexterm10_id315730)\n\n> ### N\n\nnamed functions, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298262)\n\n> nodes, [Force Layout](part0015_split_003.html#I_indexterm11_id316922)\n\n> normalization,\n> [Normalization](part0011_split_003.html#I_indexterm7_id303513)\n\n> ### O\n\nobjects, [Objects](part0007_split_007.html#I_indexterm3_id292188)\n\n> Ogievetsky, Vadim, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287504)\n\n> ordinal scales, [Introducing\n> Axes](part0012_split_001.html#I_indexterm8_id305155), [Modernizing the Bar\n> Chart](part0013_split_001.html#I_indexterm9_id306807), [Referencing the\n> Ordinal Scale](part0013_split_001.html#I_indexterm9_id307232), [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316376)\n\n> output range, [Domains and\n> Ranges](part0011_split_002.html#I_indexterm7_id303336)\n\n> overlapping elements, [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id313398)\n\n> ### P\n\npadding, [Refining the Plot](part0011_split_006.html#I_indexterm7_id304284),\n[Cleaning It Up](part0012_split_003.html#I_indexterm8_id305924), [Y\nNot?](part0012_split_005.html#I_indexterm8_id306239), [Round Bands Are All the\nRange These Days](part0013_split_001.html#I_indexterm9_id307188), [Referencing\nthe Ordinal Scale](part0013_split_001.html#I_indexterm9_id307329)\n\n> page elements\n\n> binding data to, [Binding Data](part0009_split_002.html#ix_pebind)–[Bound\n> and Determined](part0009_split_002.html#I_indexterm5_id298089), [Data Joins\n> with Keys](part0013_split_004.html#I_indexterm9_id311334)\n>\n\n>> creating, [Generating Page\nElements](part0009_split_001.html#ix_pgelemcrt)–[Going\nChainless](part0009_split_001.html#I_indexterm5_id296932)\n\n>\n\n>> paragraph elements, [Generating Page\nElements](part0009_split_001.html#I_indexterm5_id296340)\n\n> parent elements, [DOM](part0007_split_003.html#I_indexterm3_id290163)\n\n> paths, [Pie Layout](part0015_split_001.html#I_indexterm11_id316198),\n> [Paths](part0016_split_002.html#I_indexterm12_id317616)\n\n> pie charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316048)\n\n> pixel-based coordinates system, [Simple\n> Shapes](part0007_split_008.html#I_indexterm3_id294094)\n\n> pixels\n\n> lining up to, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307179)\n>\n\n>> smoothing, [Cleaning It Up](part0012_split_003.html#I_indexterm8_id305744)\n\n>\n\n>> pointer events, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313413),\n[Tooltips](part0014_split_004.html#I_indexterm10_id314269)\n\n> (see also mouseover events)\n>\n\n>> (see also tooltips)\n\n>\n\n>> points, [Adding Points](part0016_split_005.html#I_indexterm12_id318453)\n\n> political maps, [Choropleth](part0016_split_004.html#I_indexterm12_id318123)\n\n> population maps, [Adding\n> Points](part0016_split_005.html#I_indexterm12_id318548)\n\n> port number, [The Web](part0007_split_001.html#I_indexterm3_id288791)\n\n> prefuse application, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287385)\n\n> print-to-PDF functionality,\n> [PDF](part0017_split_002.html#I_indexterm13_id319830)\n\n> projections, [Projections](part0016_split_003.html#I_indexterm12_id317828),\n> [Adding Points](part0016_split_005.html#I_indexterm12_id318665)\n\n> properties, [CSS](part0007_split_006.html#I_indexterm3_id290785),\n> [Properties and Values](part0007_split_006.html#I_indexterm3_id291085),\n> [Objects](part0007_split_007.html#I_indexterm3_id292195)\n\n> Protovis visualization toolkit, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287477)\n\n> ### Q\n\nquantitative scales, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305148)\n\n> quantize scales,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318194)\n\n> queued transitions, [Warning: Start\n> carefully](part0013_split_003.html#I_indexterm9_id309652)\n\n> ### R\n\nradians, [Pie Layout](part0015_split_001.html#I_indexterm11_id316081)\n\n> random data, generating, [Random\n> Data](part0010_split_002.html#I_indexterm6_id299848)\n\n> range banding, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307091)\n\n> rectangles, drawing, [Drawing\n> divs](part0010_split_001.html#I_indexterm6_id298857)\n\n> red state/blue state maps,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318130)\n\n> referencing styles, [Referencing\n> Styles](part0007_split_006.html#I_indexterm3_id291245)\n\n> remote servers, [The Web](part0007_split_001.html#I_indexterm3_id288650)\n\n> rendering, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290551)\n\n> requests, [The Web](part0007_split_001.html#I_indexterm3_id288599)\n\n> resolution, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318976)\n\n> ring charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316474)\n\n> ### S\n\nSafari, development tools, [Developer\nTools](part0007_split_004.html#I_indexterm3_id290390)\n\n> sample code files, obtaining, [Using Sample\n> Code](part0005_split_008.html#I_indexterm1_id286768), [Referencing\n> D3](part0008_split_002.html#I_indexterm4_id295761)\n\n> scales, [Scales](part0011_split_000.html#ix_scales)–[Other\n> Scales](part0011_split_008.html#I_indexterm7_id304794)\n\n> additional methods, [Other\n> Methods](part0011_split_007.html#I_indexterm7_id304650)\n>\n\n>> creating, [Creating a Scale](part0011_split_004.html#I_indexterm7_id303551)\n\n>\n\n>> definition of, [Scales](part0011_split_000.html#I_indexterm7_id303170)\n\n>\n\n>> dynamic scales, [Creating a\nScale](part0011_split_004.html#I_indexterm7_id303675), [Setting Up Dynamic\nScales](part0011_split_005.html#I_indexterm7_id303920)\n\n>\n\n>> incorporating scaled values, [Incorporating Scaled\nValues](part0011_split_005.html#I_indexterm7_id304036)\n\n>\n\n>> input domain/output range, [Domains and\nRanges](part0011_split_002.html#I_indexterm7_id303342)\n\n>\n\n>> normalization,\n[Normalization](part0011_split_003.html#I_indexterm7_id303504)\n\n>\n\n>> refining the plot, [Incorporating Scaled\nValues](part0011_split_005.html#I_indexterm7_id304128)\n\n>\n\n>> vs. axes, [Scales](part0011_split_000.html#I_indexterm7_id303222)\n\n>\n\n>> scatterplots\n\n> adding x/y axes to, [Axes](part0012_split_000.html#I_indexterm8_id305090)\n>\n\n>> creating, [Making a\nScatterplot](part0010_split_005.html#ix_splot)–[Labels](part0010_split_005.html#I_indexterm6_id303044)\n\n>\n\n>> scaling, [Creating a Scale](part0011_split_004.html#I_indexterm7_id303659)\n\n>\n\n>> screen coordinates vs. geo-coordinates, [Adding\nPoints](part0016_split_005.html#I_indexterm12_id318649)\n\n> scripts, [Referencing\n> Scripts](part0007_split_007.html#I_indexterm3_id293198)\n\n> select(), [Select](part0013_split_004.html#I_indexterm9_id310421)\n\n> selectAll(), [Select](part0013_split_004.html#I_indexterm9_id310428)\n\n> selection.on() method, [Interaction via Event\n> Listeners](part0013_split_002.html#I_indexterm9_id307661)\n\n> selectors, [CSS](part0007_split_006.html#I_indexterm3_id290779)\n\n> semantic structure, [Content Plus\n> Structure](part0007_split_002.html#I_indexterm3_id289152)\n\n> sequential numbers, generating an array of, [Ordinal Scales,\n> Explained](part0013_split_001.html#I_indexterm9_id306957)\n\n> servers, [The Web](part0007_split_001.html#I_indexterm3_id288614)\n\n> shape-rendering property, [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305738)\n\n> shapefiles, [Find\n> Shapefiles](part0016_split_006.html#I_indexterm12_id318876)\n\n> sibling elements, [DOM](part0007_split_003.html#I_indexterm3_id290175)\n\n> sorting, [Click to Sort](part0014_split_003.html#I_indexterm10_id313765)\n\n> source code, viewing, [Developer\n> Tools](part0007_split_004.html#I_indexterm3_id290359)\n\n> specificity, [Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291658)\n\n> stack layout, [Stack Layout](part0015_split_002.html#I_indexterm11_id316571)\n\n> staggered transitions, [Please Do Not\n> delay()](part0013_split_003.html#I_indexterm9_id308578)\n\n> static transitions, [Please Do Not\n> delay()](part0013_split_003.html#I_indexterm9_id308584)\n\n> style() method, [Beyond Text](part0009_split_002.html#I_indexterm5_id298655)\n\n> styles\n\n> setting, [Setting Styles](part0010_split_001.html#I_indexterm6_id299470)\n>\n\n>> vs. classes, [A Note on\nClasses](part0010_split_001.html#I_indexterm6_id299292)\n\n>\n\n>> SVG (Scalable Vector Graphics),\n[SVG](part0007_split_008.html#ix_SVG)–[Transparency](part0007_split_008.html#I_indexterm3_id295401)\n\n> applying styles to elements, [Styling SVG\n> Elements](part0007_split_008.html#I_indexterm3_id294538)\n>\n\n>> applying transparency,\n[Transparency](part0007_split_008.html#I_indexterm3_id295078)\n\n>\n\n>> axis functions and, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305161)\n\n>\n\n>> browser compatibility, [A Note on\nCompatibility](part0007_split_009.html#I_indexterm3_id295465)\n\n>\n\n>> creating elements, [The SVG\nElement](part0007_split_008.html#I_indexterm3_id293932)\n\n>\n\n>> creating simple shapes, [Simple\nShapes](part0007_split_008.html#I_indexterm3_id294073), [Drawing\nSVGs](part0010_split_003.html#ix_svgshapes)–[Pretty Colors,\nOooh!](part0010_split_003.html#I_indexterm6_id300775)\n\n>\n\n>> creating tooltips with, [SVG Element\nTooltips](part0014_split_004.html#I_indexterm10_id314486)\n\n>\n\n>> drawing overlapping shapes, [Layering and Drawing\nOrder](part0007_split_008.html#I_indexterm3_id294967), [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313404)\n\n>\n\n>> exporting D3 visualizations as,\n[SVG](part0017_split_003.html#I_indexterm13_id319867)\n\n>\n\n>> grouping elements, [Grouping SVG\nElements](part0014_split_003.html#I_indexterm10_id313632)\n\n>\n\n>> ### T\n\ntags, [Adding Structure with\nElements](part0007_split_002.html#I_indexterm3_id289285)\n\n> text-based data, [Data](part0009_split_000.html#I_indexterm5_id296252)\n\n> tick marks, [Check for Ticks](part0012_split_004.html#I_indexterm8_id306006)\n\n> ticks (time measurement), [Force\n> Layout](part0015_split_003.html#I_indexterm11_id317110)\n\n> tooltips, [Tooltips](part0014_split_004.html#ix_ttip)–[HTML div\n> Tooltips](part0014_split_004.html#I_indexterm10_id315604)\n\n> default, [Default Browser\n> Tooltips](part0014_split_004.html#I_indexterm10_id314322)\n>\n\n>> HTML div tooltips, [HTML div\nTooltips](part0014_split_004.html#I_indexterm10_id314698)\n\n>\n\n>> SVG elements, [SVG Element\nTooltips](part0014_split_004.html#I_indexterm10_id314477)\n\n>\n\n>> touch-based interfaces, [Consideration for Touch\nDevices](part0014_split_005.html#I_indexterm10_id315717)\n\n> transformations, [What It\n> Does](part0006_split_001.html#I_indexterm2_id287066), [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305794)\n\n> transitions, [Transitions](part0013_split_003.html#ix_trans)–[Containing\n> visual elements with clipping\n> paths](part0013_split_003.html#I_indexterm9_id310280)\n\n> adding animated,\n> [Transitions](part0013_split_003.html#I_indexterm9_id308030)\n>\n\n>> chaining together, [End\ngracefully](part0013_split_003.html#I_indexterm9_id309793)\n\n>\n\n>> clipping paths, [Containing visual elements with clipping\npaths](part0013_split_003.html#I_indexterm9_id309915)\n\n>\n\n>> controlling duration of, [duration(), or How Long Is This Going to\nTake?](part0013_split_003.html#I_indexterm9_id308173)\n\n>\n\n>> delaying start of, [Please Do Not\ndelay()](part0013_split_003.html#I_indexterm9_id308521)\n\n>\n\n>> equalizing the pace, [ease()-y Does\nIt](part0013_split_003.html#I_indexterm9_id308308)\n\n>\n\n>> exit transition, [Exit\ntransition](part0013_split_004.html#I_indexterm9_id311790)\n\n>\n\n>> in mouseover events, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313047)\n\n>\n\n>> interrupted, [Click to\nSort](part0014_split_003.html#I_indexterm10_id314017)\n\n>\n\n>> limit to active number, [Warning: Start\ncarefully](part0013_split_003.html#I_indexterm9_id309611)\n\n>\n\n>> marking beginnings/endings of, [each() Transition Starts and\nEnds](part0013_split_003.html#I_indexterm9_id309460)\n\n>\n\n>> randomizing the data, [Randomizing the\nData](part0013_split_003.html#I_indexterm9_id308754)\n\n>\n\n>> updating axes, [Updating\nAxes](part0013_split_003.html#I_indexterm9_id309222)\n\n>\n\n>> updating the scale, [Updating\nScales](part0013_split_003.html#I_indexterm9_id308920)\n\n>\n\n>> translation transform, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305853)\n\n> transparency, [Transparency](part0007_split_008.html#I_indexterm3_id295087)\n\n> TXT (plain text files),\n> [Data](part0009_split_000.html#I_indexterm5_id296258)\n\n> type selectors, [Selectors](part0007_split_006.html#I_indexterm3_id290884)\n\n> typeof operator, [Dynamic\n> typing](part0007_split_007.html#I_indexterm3_id293378)\n\n> ### U\n\nul (unordered list), [Rendering and the Box\nModel](part0007_split_005.html#I_indexterm3_id290651)\n\n> United States, map of, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317397)\n\n> updates, [Updates, Transitions, and\n> Motion](part0013_split_000.html#ix_updates)–[Recap](part0013_split_004.html#I_indexterm9_id312333)\n\n> adding and removing data, [Add and Remove: Combo\n> Platter](part0013_split_004.html#I_indexterm9_id312028)\n>\n\n>> adding values/elements, [Adding Values (and\nElements)](part0013_split_004.html#ix_upadd)–[Update](part0013_split_004.html#I_indexterm9_id310907)\n\n>\n\n>> animation of, [Transitions](part0013_split_003.html#I_indexterm9_id308091)\n\n>\n\n>> basic steps to, [Updating\nData](part0013_split_002.html#I_indexterm9_id307400), [Changing the\nData](part0013_split_002.html#I_indexterm9_id307715)\n\n>\n\n>> data joins, [Data Joins with\nKeys](part0013_split_004.html#ix_updajoin)–[Exit\ntransition](part0013_split_004.html#I_indexterm9_id312005)\n\n>\n\n>> event listeners and, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307513)\n\n>\n\n>> overview of, [Recap](part0013_split_004.html#I_indexterm9_id312209)\n\n>\n\n>> removing values/elements, [Removing Values (and\nElements)](part0013_split_004.html#ix_uprem)–[Making a smooth\nexit](part0013_split_004.html#I_indexterm9_id311280)\n\n>\n\n>> to bar chart, [Modernizing the Bar\nChart](part0013_split_001.html#ix_ubcht)–[Other\nUpdates](part0013_split_001.html#I_indexterm9_id307373)\n\n>\n\n>> URLs (Uniform Resource Locators), [The\nWeb](part0007_split_001.html#I_indexterm3_id288713)\n\n> ### V\n\nvalue changes, animating,\n[Transitions](part0013_split_003.html#I_indexterm9_id308084)\n\n> values\n\n> adding, [Adding Values (and\n> Elements)](part0013_split_004.html#I_indexterm9_id310347)\n>\n\n>> in CSS, [Properties and\nValues](part0007_split_006.html#I_indexterm3_id291091)\n\n>\n\n>> in objects, [Objects](part0007_split_007.html#I_indexterm3_id292201)\n\n>\n\n>> variable hoisting, [Variable\nhoisting](part0007_split_007.html#I_indexterm3_id293425)\n\n> variable scope, [Function-level\n> scope](part0007_split_007.html#I_indexterm3_id293515)\n\n> variables, [Hello, Console](part0007_split_007.html#I_indexterm3_id291799),\n> [JavaScript Gotchas](part0007_split_007.html#I_indexterm3_id293259), [Global\n> namespace](part0007_split_007.html#I_indexterm3_id293765), [Create the\n> SVG](part0010_split_003.html#I_indexterm6_id300315)\n\n> vector data, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318983)\n\n> vertical axis, [Y Not?](part0012_split_005.html#I_indexterm8_id306106)\n\n> visual rules, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290558)\n\n> visual structure, [Content Plus\n> Structure](part0007_split_002.html#I_indexterm3_id289124)\n\n> visualization, definition of, [Why Data\n> Visualization?](part0005_split_001.html#I_indexterm1_id286312)\n\n> ### W\n\nweb development tools, [Developer\nTools](part0007_split_004.html#ix_webtool)–[Developer\nTools](part0007_split_004.html#I_indexterm3_id290524)\n\n> Web fundamentals, [The Web](part0007_split_001.html#I_indexterm3_id288530),\n> [The Web](part0007_split_001.html#I_indexterm3_id288853)\n\n> web inspector, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290596)\n\n> Web servers\n\n> operation of, [The Web](part0007_split_001.html#I_indexterm3_id288605)\n>\n\n>> setting up, [Setting Up a Web\nServer](part0008_split_003.html#I_indexterm4_id295864)\n\n>\n\n>> web-standard technologies, benefits of, [Why on the\nWeb?](part0005_split_004.html#I_indexterm1_id286524)\n\n> whitespace, adding, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307194)\n\n> (see also padding)\n>\n\n>>\n\n\n## About the Author\n\nScott Murray is a code artist who writes software to create data\nvisualizations and other interactive phenomena. His work incorporates elements\nof interaction design, systems design, and generative art.  \n  \nScott is an Assistant Professor of Design at the University of San Francisco,\nwhere he teaches data visualization and interaction design. He is a\ncontributor to Processing (processing.org), and he teaches workshops on\ncreative coding.  \n  \nScott earned an A.B. from Vassar College and an M.F.A. from the Dynamic Media\nInstitute at the Massachusetts College of Art and Design. His work can be seen\nat alignedleft.com.\n\n\n## Colophon\n\nThe animal on the cover of _Interactive Data Visualization for the Web_ is a\nlong-tail tit or bushtit (_Aegithalos caudatus_). The bushtit is a common\nspecies of bird found throughout Europe and Asia. The caudatus group of the\nspecies has a pure white head.\n\nThese birds are known for their tiny size, measuring at around only 13-15 cm\nin length, including their tail. The long-tail tit is recognized by its stubby\nbill, contrasted to its long, narrow tail. Females and males are\nindistinguishable, both undergoing a full moult before their first winter.\nTheir adult plumage is primarily black and white with accents of grey and\npink.\n\nThe bushtit inhabits deciduous and mixed woodland, feeding on insects with a\npreference for eggs and larvae of moths and butterflies, and favoring oak,\nash, and sycamore trees. They tend to nest in scrub areas usually closer to\nthe ground.\n\nThe cover image is from a loose plate of Hungarian origin. The cover font is\nAdobe ITC Garamond. The text font is Adobe Minion Pro; the heading font is\nAdobe Myriad Condensed; and the code font is Dalton Maag’s Ubuntu Mono.\n\n\n## Special Upgrade Offer\n\nIf you purchased this ebook from a retailer other than O’Reilly, you can\nupgrade it for $4.99 at oreilly.com by [clicking\nhere](http://opds.oreilly.com/buy/9781449339722.EBOOK?source=kindle).\n\n\n##\n\n# Interactive Data Visualization for the Web\n\n###  Scott Murray\n\n#### Editor\n\n###  Meghan Blanchette\n\n**Revision History**  \n---  \n2013-03-04 | First release  \n  \nCopyright © 2013 Scott Murray\n\nO’Reilly books may be purchased for educational, business, or sales\npromotional use. Online editions are also available for most titles\n([http://my.safaribooksonline.com](http://my.safaribooksonline.com/?portal=oreilly)).\nFor more information, contact our corporate/institutional sales department:\n800-998-9938 or [corporate@oreilly.com](mailto:corporate@oreilly.com).\n\nNutshell Handbook, the Nutshell Handbook logo, the cover image, and the\nO’Reilly logo are registered trademarks of O’Reilly Media, Inc. _Interactive\nData Visualization for the Web_ , the cover image of a long-tail bushtit, and\nrelated trade dress are trademarks of O’Reilly Media, Inc.\n\nMany of the designations used by manufacturers and sellers to distinguish\ntheir products are claimed as trademarks. Where those designations appear in\nthis book, and O’Reilly Media, Inc., was aware of a trademark claim, the\ndesignations have been printed in caps or initial caps.\n\nWhile every precaution has been taken in the preparation of this book, the\npublisher and author assume no responsibility for errors or omissions, or for\ndamages resulting from the use of the information contained herein.\n\nO’Reilly Media  \n\n1005 Gravenstein Highway North\n\nSebastopol, CA 95472\n\n2013-05-01T20:15:32-07:00\n\n\n# Interactive Data Visualization for the Web\n\nTable of Contents\n\n> [Special Upgrade Offer](part0002.html#front_of_book_promo)\n\n> [A Note Regarding Supplemental Files](part0003.html#id804761)\n\n> [Preface](part0004_split_000.html#3Q282-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Conventions Used in This\nBook](part0004_split_001.html#_conventions_used_in_this_book)\n\n>\n\n>> [Using Code Examples](part0004_split_002.html#_using_code_examples)\n\n>\n\n>> [Safari® Books Online](part0004_split_003.html#_safari_books_online)\n\n>\n\n>> [How to Contact Us](part0004_split_004.html#_how_to_contact_us)\n\n>\n\n>> [Acknowledgments](part0004_split_005.html#_acknowledgments)\n\n> [1\\.\n> Introduction](part0005_split_000.html#4OIQ2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Why Data Visualization?](part0005_split_001.html#_why_data_visualization)\n\n>\n\n>> [Why Write Code?](part0005_split_002.html#_why_write_code)\n\n>\n\n>> [Why Interactive?](part0005_split_003.html#_why_interactive)\n\n>\n\n>> [Why on the Web?](part0005_split_004.html#_why_on_the_web)\n\n>\n\n>> [What This Book Is](part0005_split_005.html#_what_this_book_is)\n\n>\n\n>> [Who You Are](part0005_split_006.html#_who_you_are)\n\n>\n\n>> [What This Book Is Not](part0005_split_007.html#_what_this_book_is_not)\n\n>\n\n>> [Using Sample Code](part0005_split_008.html#_using_sample_code)\n\n>\n\n>> [Thank You](part0005_split_009.html#_thank_you)\n\n> [2\\. Introducing\n> D3](part0006_split_000.html#5N3C2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [What It Does](part0006_split_001.html#_what_it_does)\n\n>\n\n>> [What It Doesn’t Do](part0006_split_002.html#_what_it_doesn_t_do)\n\n>\n\n>> [Origins and Context](part0006_split_003.html#_origins_and_context)\n\n>\n\n>> [Alternatives](part0006_split_004.html#alternatives_2)\n\n>>\n\n>>> [Easy Charts](part0006_split_004.html#_easy_charts)\n\n>>\n\n>>> [Graph Visualizations](part0006_split_004.html#_graph_visualizations)\n\n>>\n\n>>> [Geomapping](part0006_split_004.html#_geomapping)\n\n>>\n\n>>> [Almost from Scratch](part0006_split_004.html#_almost_from_scratch)\n\n>>\n\n>>> [Three-Dimensional](part0006_split_004.html#_three_dimensional)\n\n>>\n\n>>> [Tools Built with D3](part0006_split_004.html#_tools_built_with_d3)\n\n> [3\\. Technology\n> Fundamentals](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [The Web](part0007_split_001.html#_the_web)\n\n>\n\n>> [HTML](part0007_split_002.html#_html)\n\n>>\n\n>>> [Content Plus Structure](part0007_split_002.html#_content_plus_structure)\n\n>>\n\n>>> [Adding Structure with\nElements](part0007_split_002.html#_adding_structure_with_elements)\n\n>>\n\n>>> [Common Elements](part0007_split_002.html#_common_elements)\n\n>>\n\n>>> [Attributes](part0007_split_002.html#_attributes)\n\n>>\n\n>>> [Classes and IDs](part0007_split_002.html#_classes_and_ids)\n\n>>\n\n>>> [Comments](part0007_split_002.html#_comments)\n\n>\n\n>> [DOM](part0007_split_003.html#_dom)\n\n>\n\n>> [Developer Tools](part0007_split_004.html#developer_tools_3)\n\n>\n\n>> [Rendering and the Box\nModel](part0007_split_005.html#_rendering_and_the_box_model)\n\n>\n\n>> [CSS](part0007_split_006.html#_css)\n\n>>\n\n>>> [Selectors](part0007_split_006.html#_selectors)\n\n>>\n\n>>> [Properties and Values](part0007_split_006.html#_properties_and_values)\n\n>>\n\n>>> [Comments](part0007_split_006.html#_comments_2)\n\n>>\n\n>>> [Referencing Styles](part0007_split_006.html#_referencing_styles)\n\n>>>\n\n>>>> [Embed the CSS in your\nHTML.](part0007_split_006.html#_embed_the_css_in_your_html)\n\n>>>\n\n>>>> [Reference an external stylesheet from the\nHTML.](part0007_split_006.html#_reference_an_external_stylesheet_from_the_html)\n\n>>>\n\n>>>> [Attach inline styles.](part0007_split_006.html#_attach_inline_styles)\n\n>>\n\n>>> [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#_inheritance_cascading_and_specificity)\n\n>\n\n>> [JavaScript](part0007_split_007.html#_javascript)\n\n>>\n\n>>> [Hello, Console](part0007_split_007.html#_hello_console)\n\n>>\n\n>>> [Variables](part0007_split_007.html#_variables)\n\n>>\n\n>>> [Other Variable Types](part0007_split_007.html#_other_variable_types)\n\n>>\n\n>>> [Arrays](part0007_split_007.html#_arrays)\n\n>>\n\n>>> [Objects](part0007_split_007.html#_objects)\n\n>>\n\n>>> [Objects and Arrays](part0007_split_007.html#_objects_and_arrays)\n\n>>>\n\n>>>> [JSON](part0007_split_007.html#_json)\n\n>>>\n\n>>>> [GeoJSON](part0007_split_007.html#_geojson)\n\n>>\n\n>>> [Mathematical Operators](part0007_split_007.html#_mathematical_operators)\n\n>>\n\n>>> [Comparison Operators](part0007_split_007.html#_comparison_operators)\n\n>>\n\n>>> [Control Structures](part0007_split_007.html#_control_structures)\n\n>>>\n\n>>>> [if() only](part0007_split_007.html#_if_only)\n\n>>>\n\n>>>> [for() now](part0007_split_007.html#_for_now)\n\n>>>\n\n>>>> [What arrays are made\nfor()](part0007_split_007.html#_what_arrays_are_made_for)\n\n>>\n\n>>> [Functions](part0007_split_007.html#_functions)\n\n>>\n\n>>> [Comments](part0007_split_007.html#_comments_3)\n\n>>\n\n>>> [Referencing Scripts](part0007_split_007.html#_referencing_scripts)\n\n>>\n\n>>> [JavaScript Gotchas](part0007_split_007.html#_javascript_gotchas)\n\n>>>\n\n>>>> [Dynamic typing](part0007_split_007.html#_dynamic_typing)\n\n>>>\n\n>>>> [Variable hoisting](part0007_split_007.html#_variable_hoisting)\n\n>>>\n\n>>>> [Function-level scope](part0007_split_007.html#_function_level_scope)\n\n>>>\n\n>>>> [Global namespace](part0007_split_007.html#_global_namespace)\n\n>\n\n>> [SVG](part0007_split_008.html#SVG_3)\n\n>>\n\n>>> [The SVG Element](part0007_split_008.html#_the_svg_element)\n\n>>\n\n>>> [Simple Shapes](part0007_split_008.html#_simple_shapes)\n\n>>\n\n>>> [Styling SVG Elements](part0007_split_008.html#_styling_svg_elements)\n\n>>\n\n>>> [Layering and Drawing\nOrder](part0007_split_008.html#_layering_and_drawing_order)\n\n>>\n\n>>> [Transparency](part0007_split_008.html#_transparency)\n\n>\n\n>> [A Note on Compatibility](part0007_split_009.html#_a_note_on_compatibility)\n\n> [4\\. Setup](part0008_split_000.html#setup-chapter4)\n>\n\n>> [Downloading D3](part0008_split_001.html#_downloading_d3)\n\n>\n\n>> [Referencing D3](part0008_split_002.html#_referencing_d3)\n\n>\n\n>> [Setting Up a Web Server](part0008_split_003.html#_setting_up_a_web_server)\n\n>>\n\n>>> [Terminal with Python](part0008_split_003.html#_terminal_with_python)\n\n>>\n\n>>> [MAMP, WAMP, and LAMP](part0008_split_003.html#_mamp_wamp_and_lamp)\n\n>>\n\n>>> [Diving In](part0008_split_003.html#_diving_in)\n\n> [5\\. Data](part0009_split_000.html#8IL22-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Generating Page\nElements](part0009_split_001.html#_generating_page_elements)\n\n>>\n\n>>> [Chaining Methods](part0009_split_001.html#_chaining_methods)\n\n>>\n\n>>> [One Link at a Time](part0009_split_001.html#_one_link_at_a_time)\n\n>>\n\n>>> [The Hand-off](part0009_split_001.html#_the_hand_off)\n\n>>\n\n>>> [Going Chainless](part0009_split_001.html#_going_chainless)\n\n>\n\n>> [Binding Data](part0009_split_002.html#_binding_data)\n\n>>\n\n>>> [In a Bind](part0009_split_002.html#_in_a_bind)\n\n>>\n\n>>> [Data](part0009_split_002.html#_data)\n\n>>>\n\n>>>> [Loading CSV data](part0009_split_002.html#_loading_csv_data)\n\n>>>\n\n>>>> [Loading JSON data](part0009_split_002.html#_loading_json_data)\n\n>>\n\n>>> [Please Make Your\nSelection](part0009_split_002.html#please_make_your_selection_5)\n\n>>\n\n>>> [Bound and Determined](part0009_split_002.html#_bound_and_determined)\n\n>>\n\n>>> [Using Your Data](part0009_split_002.html#_using_your_data)\n\n>>\n\n>>> [High-Functioning](part0009_split_002.html#_high_functioning)\n\n>>\n\n>>> [Data Wants to Be Held](part0009_split_002.html#_data_wants_to_be_held)\n\n>>\n\n>>> [Beyond Text](part0009_split_002.html#_beyond_text)\n\n> [6\\. Drawing with\n> Data](part0010_split_000.html#9H5K2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Drawing divs](part0010_split_001.html#_drawing_divs)\n\n>>\n\n>>> [Setting Attributes](part0010_split_001.html#_setting_attributes)\n\n>>\n\n>>> [A Note on Classes](part0010_split_001.html#_a_note_on_classes)\n\n>>\n\n>>> [Back to the Bars](part0010_split_001.html#_back_to_the_bars)\n\n>>\n\n>>> [Setting Styles](part0010_split_001.html#_setting_styles)\n\n>\n\n>> [The Power of data()](part0010_split_002.html#_the_power_of_data)\n\n>>\n\n>>> [Random Data](part0010_split_002.html#_random_data)\n\n>\n\n>> [Drawing SVGs](part0010_split_003.html#_drawing_svgs)\n\n>>\n\n>>> [Create the SVG](part0010_split_003.html#_create_the_svg)\n\n>>\n\n>>> [Data-Driven Shapes](part0010_split_003.html#_data_driven_shapes)\n\n>>\n\n>>> [Pretty Colors, Oooh!](part0010_split_003.html#_pretty_colors_oooh)\n\n>\n\n>> [Making a Bar Chart](part0010_split_004.html#_making_a_bar_chart)\n\n>>\n\n>>> [The Old Chart](part0010_split_004.html#_the_old_chart)\n\n>>\n\n>>> [The New Chart](part0010_split_004.html#_the_new_chart)\n\n>>\n\n>>> [Color](part0010_split_004.html#_color)\n\n>>\n\n>>> [Labels](part0010_split_004.html#_labels)\n\n>\n\n>> [Making a Scatterplot](part0010_split_005.html#_making_a_scatterplot)\n\n>>\n\n>>> [The Data](part0010_split_005.html#_the_data)\n\n>>\n\n>>> [The Scatterplot](part0010_split_005.html#_the_scatterplot)\n\n>>\n\n>>> [Size](part0010_split_005.html#_size)\n\n>>\n\n>>> [Labels](part0010_split_005.html#_labels_2)\n\n>\n\n>> [Next Steps](part0010_split_006.html#_next_steps)\n\n> [7\\. Scales](part0011_split_000.html#AFM62-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Apples and Pixels](part0011_split_001.html#_apples_and_pixels)\n\n>\n\n>> [Domains and Ranges](part0011_split_002.html#_domains_and_ranges)\n\n>\n\n>> [Normalization](part0011_split_003.html#_normalization)\n\n>\n\n>> [Creating a Scale](part0011_split_004.html#_creating_a_scale)\n\n>\n\n>> [Scaling the Scatterplot](part0011_split_005.html#_scaling_the_scatterplot)\n\n>>\n\n>>> [d3.min() and d3.max()](part0011_split_005.html#_d3_min_and_d3_max)\n\n>>\n\n>>> [Setting Up Dynamic\nScales](part0011_split_005.html#_setting_up_dynamic_scales)\n\n>>\n\n>>> [Incorporating Scaled\nValues](part0011_split_005.html#_incorporating_scaled_values)\n\n>\n\n>> [Refining the Plot](part0011_split_006.html#_refining_the_plot)\n\n>\n\n>> [Other Methods](part0011_split_007.html#_other_methods)\n\n>\n\n>> [Other Scales](part0011_split_008.html#_other_scales)\n\n> [8\\. Axes](part0012_split_000.html#BE6O2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Introducing Axes](part0012_split_001.html#_introducing_axes)\n\n>\n\n>> [Setting Up an Axis](part0012_split_002.html#_setting_up_an_axis)\n\n>\n\n>> [Cleaning It Up](part0012_split_003.html#_cleaning_it_up)\n\n>\n\n>> [Check for Ticks](part0012_split_004.html#_check_for_ticks)\n\n>\n\n>> [Y Not?](part0012_split_005.html#_y_not)\n\n>\n\n>> [Final Touches](part0012_split_006.html#_final_touches)\n\n>\n\n>> [Formatting Tick Labels](part0012_split_007.html#_formatting_tick_labels)\n\n> [9\\. Updates, Transitions, and\n> Motion](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Modernizing the Bar\nChart](part0013_split_001.html#_modernizing_the_bar_chart)\n\n>>\n\n>>> [Ordinal Scales,\nExplained](part0013_split_001.html#_ordinal_scales_explained)\n\n>>\n\n>>> [Round Bands Are All the Range These\nDays](part0013_split_001.html#_round_bands_are_all_the_range_these_days)\n\n>>\n\n>>> [Referencing the Ordinal\nScale](part0013_split_001.html#_referencing_the_ordinal_scale)\n\n>>\n\n>>> [Other Updates](part0013_split_001.html#_other_updates)\n\n>\n\n>> [Updating Data](part0013_split_002.html#_updating_data)\n\n>>\n\n>>> [Interaction via Event\nListeners](part0013_split_002.html#_interaction_via_event_listeners)\n\n>>\n\n>>> [Changing the Data](part0013_split_002.html#_changing_the_data)\n\n>>\n\n>>> [Updating the Visuals](part0013_split_002.html#_updating_the_visuals)\n\n>\n\n>> [Transitions](part0013_split_003.html#_transitions)\n\n>>\n\n>>> [duration(), or How Long Is This Going to\nTake?](part0013_split_003.html#_duration_or_how_long_is_this_going_to_take)\n\n>>\n\n>>> [ease()-y Does It](part0013_split_003.html#_ease_y_does_it)\n\n>>\n\n>>> [Please Do Not delay()](part0013_split_003.html#_please_do_not_delay)\n\n>>\n\n>>> [Randomizing the Data](part0013_split_003.html#_randomizing_the_data)\n\n>>\n\n>>> [Updating Scales](part0013_split_003.html#_updating_scales)\n\n>>\n\n>>> [Updating Axes](part0013_split_003.html#_updating_axes)\n\n>>\n\n>>> [each() Transition Starts and\nEnds](part0013_split_003.html#_each_transition_starts_and_ends)\n\n>>>\n\n>>>> [Warning: Start\ncarefully](part0013_split_003.html#_warning_start_carefully)\n\n>>>\n\n>>>> [End gracefully](part0013_split_003.html#_end_gracefully)\n\n>>>\n\n>>>> [Transitionless each()](part0013_split_003.html#_transitionless_each)\n\n>>>\n\n>>>> [Containing visual elements with clipping\npaths](part0013_split_003.html#_containing_visual_elements_with_clipping_paths)\n\n>\n\n>> [Other Kinds of Data\nUpdates](part0013_split_004.html#_other_kinds_of_data_updates)\n\n>>\n\n>>> [Adding Values (and\nElements)](part0013_split_004.html#_adding_values_and_elements)\n\n>>>\n\n>>>> [Select](part0013_split_004.html#_select)\n\n>>>\n\n>>>> [Enter](part0013_split_004.html#_enter)\n\n>>>\n\n>>>> [Update](part0013_split_004.html#_update)\n\n>>\n\n>>> [Removing Values (and\nElements)](part0013_split_004.html#_removing_values_and_elements)\n\n>>>\n\n>>>> [Exit](part0013_split_004.html#_exit)\n\n>>>\n\n>>>> [Making a smooth exit](part0013_split_004.html#_making_a_smooth_exit)\n\n>>\n\n>>> [Data Joins with Keys](part0013_split_004.html#_data_joins_with_keys)\n\n>>>\n\n>>>> [Preparing the data](part0013_split_004.html#_preparing_the_data)\n\n>>>\n\n>>>> [Updating all\nreferences](part0013_split_004.html#_updating_all_references)\n\n>>>\n\n>>>> [Key functions](part0013_split_004.html#_key_functions)\n\n>>>\n\n>>>> [Exit transition](part0013_split_004.html#_exit_transition)\n\n>>\n\n>>> [Add and Remove: Combo\nPlatter](part0013_split_004.html#_add_and_remove_combo_platter)\n\n>>\n\n>>> [Recap](part0013_split_004.html#_recap)\n\n> [10\\.\n> Interactivity](part0014_split_000.html#DB7S2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Binding Event Listeners](part0014_split_001.html#_binding_event_listeners)\n\n>\n\n>> [Introducing Behaviors](part0014_split_002.html#_introducing_behaviors)\n\n>>\n\n>>> [Hover to Highlight](part0014_split_002.html#_hover_to_highlight)\n\n>\n\n>> [Grouping SVG Elements](part0014_split_003.html#_grouping_svg_elements)\n\n>>\n\n>>> [Click to Sort](part0014_split_003.html#_click_to_sort)\n\n>\n\n>> [Tooltips](part0014_split_004.html#_tooltips)\n\n>>\n\n>>> [Default Browser\nTooltips](part0014_split_004.html#_default_browser_tooltips)\n\n>>\n\n>>> [SVG Element Tooltips](part0014_split_004.html#_svg_element_tooltips)\n\n>>\n\n>>> [HTML div Tooltips](part0014_split_004.html#_html_div_tooltips)\n\n>\n\n>> [Consideration for Touch\nDevices](part0014_split_005.html#_consideration_for_touch_devices)\n\n>\n\n>> [Moving Forward](part0014_split_006.html#_moving_forward)\n\n> [11\\.\n> Layouts](part0015_split_000.html#E9OE2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Pie Layout](part0015_split_001.html#_pie_layout)\n\n>\n\n>> [Stack Layout](part0015_split_002.html#_stack_layout)\n\n>\n\n>> [Force Layout](part0015_split_003.html#_force_layout)\n\n> [12\\.\n> Geomapping](part0016_split_000.html#F8902-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [JSON, Meet GeoJSON](part0016_split_001.html#_json_meet_geojson)\n\n>\n\n>> [Paths](part0016_split_002.html#_paths)\n\n>\n\n>> [Projections](part0016_split_003.html#_projections)\n\n>\n\n>> [Choropleth](part0016_split_004.html#_choropleth)\n\n>\n\n>> [Adding Points](part0016_split_005.html#_adding_points)\n\n>\n\n>> [Acquiring and Parsing\nGeodata](part0016_split_006.html#_acquiring_and_parsing_geodata)\n\n>>\n\n>>> [Find Shapefiles](part0016_split_006.html#_find_shapefiles)\n\n>>\n\n>>> [Choose a Resolution](part0016_split_006.html#_choose_a_resolution)\n\n>>\n\n>>> [Simplify the Shapes](part0016_split_006.html#_simplify_the_shapes)\n\n>>\n\n>>> [Convert to GeoJSON](part0016_split_006.html#_convert_to_geojson)\n\n> [13\\.\n> Exporting](part0017_split_000.html#G6PI2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Bitmaps](part0017_split_001.html#_bitmaps)\n\n>\n\n>> [PDF](part0017_split_002.html#_pdf)\n\n>\n\n>> [SVG](part0017_split_003.html#_svg)\n\n> [A. Appendix: Further\n> Study](part0018_split_000.html#H5A42-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Books](part0018_split_001.html#_books)\n\n>\n\n>> [Websites](part0018_split_002.html#_websites)\n\n>\n\n>> [Twitterers](part0018_split_003.html#_twitterers)\n\n> [Index](part0019.html#I3QM2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n\n> [About the Author](part0020.html#id940801)\n\n> [Colophon](part0021.html#_colophon)\n\n> [Special Upgrade Offer](part0022.html#back_of_book_promo)\n\n> [Copyright](part0023.html#copyright_page_orm)\n\n\n\n\n",
    "book_id": "interactive_data_visualization_for_the_web_-_scott_murray",
    "book_title": "Interactive Data Visualization for the Web",
    "book_author": "Scott Murray",
    "topic_id": "design_data_visualization",
    "topic_label": "data visualization",
    "chunk_index": 3
  },
  {
    "chunk_full": "[![O'Reilly Strata\nConference](../images/00001.jpeg)](http://strataconf.com?intcmp=il-strata-\nstny13-report-ebook-ad-pa)\n\n\n# Interactive Data Visualization for the Web\n\n###  Scott Murray\n\n![image with no caption](../images/00002.jpeg)\n\nBeijing • Cambridge • Farnham • Köln • Sebastopol • Tokyo\n\n\n## Special Upgrade Offer\n\nIf you purchased this ebook directly from [oreilly.com](http://oreilly.com),\nyou have the following benefits:\n\n  * DRM-free ebooks — use your ebooks across devices without restrictions or limitations\n  * Multiple formats — use on your laptop, tablet, or phone\n  * Lifetime access, with free updates\n  * Dropbox syncing — your files, anywhere\n\nIf you purchased this ebook from another retailer, you can upgrade your ebook\nto take advantage of all these benefits for just $4.99. [Click\nhere](part0022.html#back_of_book_promo) to access your ebook upgrade.\n\n_Please note that upgrade offers are not available from sample content._\n\n\n## A Note Regarding Supplemental Files\n\nSupplemental files and examples for this book can be found at\n<http://examples.oreilly.com/0636920026938/>. Please use a standard desktop\nweb browser to access these files, as they may not be accessible from all\nereader devices.\n\nAll code files or examples referenced in the book will be available online.\nFor physical books that ship with an accompanying disc, whenever possible,\nwe’ve posted all CD/DVD content. Note that while we provide as much of the\nmedia content as we are able via free download, we are sometimes limited by\nlicensing restrictions. Please direct any questions or concerns to\n[booktech@oreilly.com](mailto:booktech@oreilly.com).\n\n\n## Preface\n\nThis is a book about programming data visualizations for nonprogrammers. If\nyou’re an artist or graphic designer with visual skills but no prior\nexperience working with data or code, this book is for you. If you’re a\njournalist or researcher with lots of data but no prior experience working\nwith visuals or code, this book is for you, too.\n\nThis book will introduce you to D3, a JavaScript-based tool for loading data\ninto a web page and generating visuals from that data. I assume that you have\nlittle or no programming experience. Or, perhaps you have programmed before,\nbut D3 and data visualization are bringing you to JavaScript for the first\ntime, and you’ve heard bad things about it. Well, JavaScript _is_ a little\nweird, but it’s not as bad as you’ve heard, and everything is going to be all\nright. Please sit down and make yourself comfortable.\n\nThis book began as [a series of\ntutorials](http://alignedleft.com/tutorials/d3/) posted on my website. At the\ntime (January 2012), there wasn’t much information on D3 available that was\naccessible to beginners. Very quickly, I was getting hundreds, then thousands\nof page views a day — evidence that interest in the field generally (and D3\nspecifically) was growing like gangbusters. If you’ve read the tutorials,\nportions of the book will feel familiar, but there is a _lot_ of new material\nhere, including many more examples, sneaky tips, and warnings of things to\navoid. Also, the book contains 78 percent more bad jokes.\n\nData visualization is an interdisciplinary field, which is just one reason\nit’s impossible to document the breadth of skills needed in a single book.\nFortunately, because the field is exploding in popularity, there are many new\ntitles to choose from, each of which complements this one.\n\nOn design process:\n\n  * [_Designing Data Visualizations: Intentional Communication from Data to Display_](http://shop.oreilly.com/product/0636920022060.do) by Noah Iliinsky and Julie Steele. O’Reilly Media, 2011. \n  * [_Data Visualization: A Successful Design Process_](http://bit.ly/15eJJJj) by Andy Kirk. Packt Publishing, 2012. \n\nOn visual design principles and techniques:\n\n  * [_The Functional Art: An Introduction to Information Graphics and Visualization_](http://bit.ly/VINWSz) by Alberto Cairo. New Riders, 2012. \n  * [_Information Dashboard Design: The Effective Visual Communication of Data_](http://shop.oreilly.com/product/9780596100162.do) by Stephen Few. O’Reilly Media, 2006. \n\nOn the practicalities of working with data:\n\n  * [_Bad Data Handbook: Mapping the World of Data Problems_](http://shop.oreilly.com/product/9780596802363.do) by Q. Ethan McCallum. O’Reilly Media, 2012. \n  * [_Data Analysis with Open Source Tools: A Hands-On Guide for Programmers and Data Scientists_](http://shop.oreilly.com/product/9780596802363.do) by Philipp K. Janert. O’Reilly Media, 2010. \n  * [_Python for Data Analysis: Agile Tools for Real World Data_](http://shop.oreilly.com/product/0636920023784.do) by Wes McKinney. O’Reilly Media, 2012. \n\n\n## Conventions Used in This Book\n\nThe following typographical conventions are used in this book:\n\n_Italic_\n\n> Indicates new terms, URLs, email addresses, filenames, and file extensions.\n\n`Constant width`\n\n> Used for program listings, as well as within paragraphs to refer to program\n> elements such as variable or function names, databases, data types,\n> environment variables, statements, and keywords.\n\n**`Constant width bold`**\n\n> Shows commands or other text that should be typed literally by the user.\n\n_`Constant width italic`_\n\n> Shows text that should be replaced with user-supplied values or by values\n> determined by context.\n\n* * *\n\n### Tip\n\nThis icon signifies a tip, suggestion, or general note.\n\n* * *\n\n* * *\n\n### Warning\n\nThis icon indicates a warning or caution.\n\n* * *\n\n\n## Using Code Examples\n\nThis book is here to help you get your job done. In general, if this book\nincludes code examples, you may use the code in this book in your programs and\ndocumentation. You do not need to contact us for permission unless you’re\nreproducing a significant portion of the code. For example, writing a program\nthat uses several chunks of code from this book does not require permission.\nSelling or distributing a CD-ROM of examples from O’Reilly books does require\npermission. Answering a question by citing this book and quoting example code\ndoes not require permission. Incorporating a significant amount of example\ncode from this book into your product’s documentation does require permission.\n\nWe appreciate, but do not require, attribution. An attribution usually\nincludes the title, author, publisher, and ISBN. For example: “ _Interactive\nData Visualization for the Web_ by Scott Murray (O’Reilly). Copyright 2013\nScott Murray, 978-1-449-33973-9.”\n\nIf you feel your use of code examples falls outside fair use or the permission\ngiven above, feel free to contact us at\n[permissions@oreilly.com](mailto:permissions@oreilly.com).\n\n\n## Safari® Books Online\n\n* * *\n\n### Note\n\n[Safari Books Online](http://my.safaribooksonline.com/?portal=oreilly) is an\non-demand digital library that delivers expert\n[content](http://www.safaribooksonline.com/content) in both book and video\nform from the world’s leading authors in technology and business.\n\n* * *\n\nTechnology professionals, software developers, web designers, and business and\ncreative professionals use Safari Books Online as their primary resource for\nresearch, problem solving, learning, and certification training.\n\nSafari Books Online offers a range of [product\nmixes](http://www.safaribooksonline.com/subscriptions) and pricing programs\nfor [organizations](http://www.safaribooksonline.com/organizations-teams),\n[government agencies](http://www.safaribooksonline.com/government), and\n[individuals](http://www.safaribooksonline.com/individuals). Subscribers have\naccess to thousands of books, training videos, and prepublication manuscripts\nin one fully searchable database from publishers like O’Reilly Media, Prentice\nHall Professional, Addison-Wesley Professional, Microsoft Press, Sams, Que,\nPeachpit Press, Focal Press, Cisco Press, John Wiley & Sons, Syngress, Morgan\nKaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New\nRiders, McGraw-Hill, Jones & Bartlett, Course Technology, and dozens\n[more](http://www.safaribooksonline.com/publishers). For more information\nabout Safari Books Online, please visit us\n[online](http://www.safaribooksonline.com/).\n\n\n## How to Contact Us\n\nPlease address comments and questions concerning this book to the publisher:\n\nO’Reilly Media, Inc.  \n---  \n1005 Gravenstein Highway North  \nSebastopol, CA 95472  \n800-998-9938 (in the United States or Canada)  \n707-829-0515 (international or local)  \n707-829-0104 (fax)  \n  \nWe have a web page for this book, where we list errata, examples, and any\nadditional information. You can access this page at\n<http://oreil.ly/interactive_data_visualization_web>.\n\nTo comment or ask technical questions about this book, send email to\n[bookquestions@oreilly.com](mailto:bookquestions@oreilly.com).\n\nFor more information about our books, courses, conferences, and news, see our\nwebsite at <http://www.oreilly.com>.\n\nFind us on Facebook: <http://facebook.com/oreilly>\n\nFollow us on Twitter: <http://twitter.com/oreillymedia>\n\nWatch us on YouTube: <http://www.youtube.com/oreillymedia>\n\n\n## Acknowledgments\n\nMy name may be on the cover, but as an author, I feel as though I am merely\nfunneling the wisdom of hundreds of other brilliant minds onto the page.\n\nFirst and foremost, I must thank my wife Nora, not least for being the first\nto say “Hey, you should turn those tutorials into a book.” Without her support\nand encouragement, this project never would have happened.\n\nThanks also to [Rosten Woo](http://wehavenoart.net), with whom I collaborated\non my first D3 project, for reaching out and giving me a reason to finally dig\ninto this new tool. Thanks to [Joe Golike](http://golike.com) for several\nearly D3 debugging sessions around that time, and to [Jen\nLowe](http://www.datatelling.com) and [Sha\nHwang](http://postarchitectural.com) for their reviews and feedback on the\ninitial tutorials.\n\nI am extremely grateful to [Casey Reas](http://reas.com), [Dan\nShiffman](http://www.shiffman.net), [Joshua\nNoble](http://thefactoryfactory.com), and [Noah\nIliinsky](http://complexdiagrams.com) — not just for offering advice on the\nbook-creation process, but also for their groundbreaking work in the spheres\nof art, design, code, and data. Their careers have greatly influenced my own.\n\nIn that vein, I should also thank Jan Kubasiewicz at MassArt’s [Dynamic Media\nInstitute](http://www.dynamicmediainstitute.org). Back in 2007, Jan encouraged\nme to check out something called [Processing](http://processing.org), which\neventually led me to a whole new career in code-driven arts, data\nvisualization, and now this book.\n\nIt has been a pleasure working with my editor, Meghan Blanchette, and everyone\nelse on the team at O’Reilly. Thanks to Meghan and her crew for shepherding\nthis project all the way through, from concept to an actual, physical, chunk\nof paper with words and strange diagrams printed on it.\n\nSpecial thanks to [Mike Bostock](http://bost.ocks.org/mike/), [Jen\nLowe](http://www.datatelling.com), [Anna Powell-Smith](http://anna.ps), and\n[Daisy Vincent](http://codenoobcentral.tumblr.com) for agreeing to tech review\nthe book and sending incredibly valuable feedback. The final product is vastly\nimproved, thanks to their input. That said, if you find an error or confusing\ncode example, it is because they begged me to rewrite it, and I steadfastly\nrefused.\n\nMike gets an extra-special thanks for developing D3 in the first place.\nWithout this elegant piece of software, the community of data visualization\npractitioners wouldn’t be quite as vibrant, enthusiastic, and standards-\ncompliant as it is today.\n\nSpeaking of community, many other people — including [Jérôme\nCukier](http://www.jeromecukier.net), [Lynn\nCherny](http://www.ghostweather.com), [Jason\nDavies](http://www.jasondavies.com), [Jeff\nHeer](http://hci.stanford.edu/jheer/), [Santiago Ortiz](http://moebio.com),\n[Kim Rees](http://periscopic.com), [Moritz\nStefaner](http://moritz.stefaner.eu), [Jan Willem\nTulp](http://tulpinteractive.com), and others who I have forgotten to mention\n— on the D3 list and in nearby orbits have also directly contributed to my\nthinking and process. Thank you for your support. I am lucky to get to\ncollaborate with so many talented people.\n\n\n## Chapter 1. Introduction\n\n\n## Why Data Visualization?\n\nOur information age more often feels like an era of information overload.\nExcess amounts of information are overwhelming; raw data becomes useful only\nwhen we apply methods of deriving insight from it.\n\nFortunately, we humans are intensely visual creatures. Few of us can detect\npatterns among rows of numbers, but even young children can interpret bar\ncharts, extracting meaning from those numbers’ visual representations. For\nthat reason, data visualization is a powerful exercise. Visualizing data is\nthe fastest way to communicate it to others.\n\nOf course, visualizations, like words, can be used to lie, mislead, or distort\nthe truth. But when practiced honestly and with care, the process of\nvisualization can help us see the world in a new way, revealing unexpected\npatterns and trends in the otherwise hidden information around us. At its\nbest, data visualization is expert storytelling.\n\nMore literally, visualization is a process of _mapping_ information to\nvisuals. We craft rules that interpret data and express its values as visual\nproperties. For example, the humble bar chart in [Figure\n1-1](part0005_split_001.html#data_values_mapped_to_visuals) is generated from\na very simple rule: larger values are _mapped_ as taller bars.\n\n![Data values mapped to visuals](../images/00003.gif)\n\nFigure 1-1. Data values mapped to visuals\n\nMore complex visualizations are generated from datasets more complex than the\nsequence of numbers shown in [Figure\n1-1](part0005_split_001.html#data_values_mapped_to_visuals) and more complex\nsets of mapping rules.\n\n\n## Why Write Code?\n\nMapping data by hand can be satisfying, yet is slow and tedious. So we usually\nemploy the power of computation to speed things up. The increased speed\nenables us to work with much larger datasets of thousands or millions of\nvalues; what would have taken years of effort by hand can be mapped in a\nmoment. Just as important, we can rapidly experiment with _alternate mappings_\n, tweaking our rules and seeing their output re-rendered immediately. This\nloop of write/render/evaluate is critical to the iterative process of refining\na design.\n\nSets of mapping rules function as _design systems_. The human hand no longer\nexecutes the visual output; the computer does. Our human role is to\nconceptualize, craft, and write out the rules of the system, which is then\nfinally executed by software.\n\nUnfortunately, software (and computation generally) is extremely bad at\nunderstanding what, exactly, people want. (To be fair, many humans are also\nnot good at this challenging task.) Because computers are binary systems,\neverything is either on or off, yes or no, this or that, there or not there.\nHumans are mushier, softer creatures, and the computers are not willing to\nmeet us halfway — we must go to them. Hence the inevitable struggle of\nlearning to write software, in which we train ourselves to communicate in the\nvery limited and precise syntax that the computer can understand.\n\nYet we continue to write code because seeing our visual creations come to life\nis so rewarding. We practice data visualization because it is exciting to see\nwhat has never before been seen. It is like summoning a magical, visual genie\nout of an inscrutable data bottle.\n\n\n## Why Interactive?\n\nStatic visualizations can offer only precomposed “views” of data, so multiple\nstatic views are often needed to present a variety of perspectives on the same\ninformation. The number of dimensions of data are limited, too, when all\nvisual elements must be present on the same surface at the same time.\nRepresenting multidimensional datasets fairly in static images is notoriously\ndifficult. A fixed image is ideal when alternate views are neither needed nor\ndesired, and required when publishing to a static medium, such as print.\n\nDynamic, interactive visualizations can empower people to explore the data for\nthemselves. The basic functions of most interactive visualization tools have\nchanged little since 1996, when Ben Shneiderman of the University of Maryland\nfirst proposed a “Visual Information-Seeking Mantra”: _overview first, zoom\nand filter, then details-on-demand._\n\nThis design pattern is found in most interactive visualizations today. The\ncombination of functions is successful, because it makes the data accessible\nto different audiences, from those who are merely browsing or exploring the\ndataset to those who approach the visualization with a specific question in\nsearch of an answer. An interactive visualization that offers an overview of\nthe data alongside tools for “drilling down” into the details may successfully\nfulfill many roles at once, addressing the different concerns of different\naudiences, from those new to the subject matter to those already deeply\nfamiliar with the data.\n\nOf course, interactivity can also encourage engagement with the data in ways\nthat static images cannot. With animated transitions and well-crafted\ninterfaces, some visualizations can make exploring data feel more like playing\na game. Interactive visualization can be a great medium for engaging an\naudience who might not otherwise care about the topic or data at hand.\n\n\n## Why on the Web?\n\nVisualizations aren’t truly visual unless they are _seen_. Getting your work\nout there for others to see is critical, and publishing on the Web is the\nquickest way to reach a global audience. Working with web-standard\ntechnologies means that your work can be seen and experienced by anyone using\na recent web browser, regardless of the operating system (Windows, Mac, Linux)\nand device type (laptop, desktop, smartphone, tablet).\n\nBest of all, everything covered in this book can be done with freely\naccessible tools, so the only investment required is your time. And everything\nwe’ll talk about uses open source, web-standard technologies.\n\nBy avoiding proprietary software and plug-ins, you can ensure that your\nprojects are accessible on the widest possible range of devices, from typical\ndesktop computers to tablets and even phones. The more accessible your\nvisualization, the greater your audience and your impact.\n\n\n## What This Book Is\n\nThis book is a practical introduction to merging three practices — data\nvisualization, interactive design, and web development — using D3, a powerful\ntool for custom, web-based visualization.\n\nThese chapters grew out of my own process of learning how to use D3. Many\npeople, including myself, come to D3 with backgrounds in design, mapping, and\ndata visualization, but not programming and computer science.\n\nD3 has a bit of an unfair reputation for being hard to learn. D3 itself is not\nso complicated, but it operates in the domain of the Web, and the Web _is_\ncomplicated. Using D3 comfortably requires some prior knowledge of the web\ntechnologies with which it interacts, such as HTML, CSS, JavaScript, and SVG.\nMany people (myself included) are self-taught when it comes to web skills.\nThis is great, because the barrier to entry is so low, but problematic because\nit means we probably didn’t learn each of these technologies from the ground\nup — more often, we just hack something together until it seems to work, and\ncall it a day. Yet successful use of D3 requires understanding some of these\ntechnologies in a fundamental way.\n\nBecause D3 is written in JavaScript, learning to use D3 often means learning a\nlot about JavaScript. For many datavis folks, D3 _is_ their introduction to\nJavaScript (or even web development generally). It’s hard enough to learn a\nnew programming language, let alone a new tool built on that language. D3 will\nenable you to do great things with JavaScript that you never would have even\nattempted. The time you spend learning both the language and the tool will\nprovide an incredible payoff.\n\nMy goal is to reduce that learning time, so you can start creating awesome\nstuff sooner. We’ll take a ground-up approach, starting with the fundamental\nconcepts and gradually adding complexity. I don’t intend to show you how to\nmake specific kinds of visualizations so much as to help you understand the\nworkings of D3 well enough to take those building blocks and generate designs\nof your own creation.\n\n\n## Who You Are\n\nYou may be an absolute beginner, someone new to datavis, web development, or\nboth. (Welcome!) Perhaps you are a journalist interested in new ways to\ncommunicate the data you collect during reporting. Or maybe you’re a designer,\ncomfortable drawing static infographics but ready to make the leap to\ninteractive projects on the Web. You could be an artist, interested in\ngenerative, data-based art. Or a programmer, already familiar with JavaScript\nand the Web, but excited to learn a new tool and pick up some visual design\nexperience along the way.\n\nWhoever you are, I hope that you:\n\n  * Have heard of this new thing called the “World Wide Web” \n  * Are a bit familiar with HTML, the DOM, and CSS \n  * Might even have a little programming experience already \n  * Have heard of jQuery or written some JavaScript before \n  * Aren’t scared by unknown initialisms like CSV, SVG, or JSON \n  * Want to make useful, interactive visualizations \n\nIf any of those things are unknown or unclear, don’t fear. You might just want\nto spend more time with [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), which\ncovers what you really need to know before diving into D3.\n\n\n## What This Book Is Not\n\nThat said, this is definitely not a computer science textbook, and it is not\nintended to teach the intricacies of any one web technology (HTML, CSS,\nJavaScript, SVG) in depth.\n\nIn that spirit, I might gloss over some technical points, grossly\noversimplifying important concepts fundamental to computer science in ways\nthat will make true software engineers recoil. That’s fine, because I’m\nwriting for artists and designers here, not engineers. We’ll cover the basics,\nand then you can dive into the more complex pieces once you’re comfortable.\n\nI will deliberately _not_ address every possible approach to a given problem,\nbut will typically present what I feel is the simplest solution, or, if not\nthe simplest, then the most understandable.\n\nMy goal is to teach you the fundamental concepts and methods of D3. As such,\nthis book is decidedly _not_ organized around specific example projects.\nEveryone’s data and design needs will be different. It’s up to you to\nintegrate these concepts in the way best suited to your particular project.\n\n\n## Using Sample Code\n\nIf you are a mad genius, then you can probably learn to use D3 without ever\nlooking at any sample code files, in which case you can skip the rest of this\nsection.\n\nIf you’re still with me, you are probably still very bright but not mad, in\nwhich case you should undertake this book with the full set of accompanying\ncode samples in hand. Before you go any further, please download the sample\nfiles from [GitHub](http://bit.ly/V25Xw6).\n\nNormal people will want to click the ZIP link to download a compressed ZIP\narchive with all the files. Hardcore geeksters will want to clone the\nrepository using Git. If that last sentence sounds like total gibberish,\nplease use the first option.\n\nWithin the download, you’ll notice there is a folder for each chapter that has\ncode to go with it:\n\n    \n    \n    chapter_04\n    chapter_05\n    chapter_06\n    chapter_07\n    chapter_08\n    …\n\nFiles are organized by chapter, so in [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc) when I\nreference _01_bar_chart.html_ , know that you can find that file in the\ncorresponding location: _d3-book/chapter_9/01_bar_chart.html_.\n\nYou are welcome to copy, adapt, modify, and reuse the example code in these\ntutorials for any noncommercial purpose.\n\n\n## Thank You\n\nFinally, this book has been handcrafted, carefully written, and pedagogically\nfine-tuned for maximum effect. Thank you for reading it. I hope you learn a\ngreat deal, and even have some fun along the way.\n\n\n## Chapter 2. Introducing D3\n\nD3 — also referred to as D3 or d3.js — is a JavaScript library for creating\ndata visualizations. But that kind of undersells it.\n\nThe abbreviation D3 references the tool’s full name, _Data-Driven Documents_.\nThe _data_ is provided by you, and the _documents_ are web-based documents,\nmeaning anything that can be rendered by a web browser, such as HTML and SVG.\nD3 does the _driving_ , in the sense that it connects the data to the\ndocuments.\n\nOf course, the name also functions as a clever allusion to the network of\ntechnologies underlying the tool itself: the W3, or World Wide Web, or, today,\nsimply “the Web.”\n\nD3’s primary author is the brilliant [Mike\nBostock](http://bost.ocks.org/mike/), although there are a few other dedicated\ncontributors. The project is entirely open source and freely available on\n[GitHub](https://github.com/mbostock/d3/).\n\nD3 is released under a BSD license, so you may use, modify, and adapt the code\nfor noncommercial or commercial use at no cost.\n\nD3’s official home on the Web is [_d3js.org_](http://www.d3js.org/).\n\n\n## What It Does\n\nFundamentally, D3 is an elegant piece of software that facilitates generation\nand manipulation of web documents with data. It does this by:\n\n  * _Loading_ data into the browser’s memory \n  * _Binding_ data to elements within the document, creating new elements as needed \n\n  * _Transforming_ those elements by interpreting each element’s bound datum and setting its visual properties accordingly \n  * _Transitioning_ elements between states in response to user input \n\nLearning to use D3 is simply a process of learning the syntax used to tell it\nhow you want it to load and bind data, and transform and transition elements.\n\nThe _transformation_ step is most important, as this is where the _mapping_\nhappens. D3 provides a structure for applying these transformations, but, as\nwe’ll see, you define the mapping rules. Should larger values make taller bars\nor brighter circles? Will clusters be sorted on the x-axis by age or category?\nWhat color palette is used to fill in countries on your world map? All of the\nvisual design decisions are up to you. You provide the concept, you craft the\nrules, and D3 executes it — without telling you what to do. (Yes, it’s like\nthe opposite of Excel’s pushy “Chart Wizard.”)\n\n\n## What It Doesn’t Do\n\nHere is a list of things D3 does not do:\n\n  * D3 doesn’t generate predefined or “canned” visualizations for you. This is on purpose. D3 is intended primarily for _explanatory_ visualization work, as opposed to _exploratory_ visualizations. Exploratory tools help you discover significant, meaningful patterns in data. These are tools like [Tableau](http://bit.ly/13KrhFH) and [ggplot2](http://ggplot2.org/), which help you quickly generate multiple views on the same data set. That’s an essential step, but different from generating an _explanatory_ presentation of the data, a view of the data that highlights what you’ve already discovered. Explanatory views are more constrained and limited, but also focused, and designed to communicate only the important points. D3 excels at this latter step, but is not ideal for the former. (For ideas on other tools, see the section [Alternatives](part0006_split_004.html#alternatives_2) later in this chapter.)\n  * D3 doesn’t even try to support older browsers. This helps keep the D3 codebase clean and free of hacks to support old versions of Internet Explorer, for example. The philosophy is that by creating more compelling tools and refusing to support older browsers, we encourage more people to upgrade (rather than forestall the process, thereby requiring us to continue to support those browsers, and so on — a vicious cycle). D3 wants us to move forward.\n  * D3’s core functionality doesn’t handle bitmap map tiles, such as those provided by Google Maps or Cloudmade. D3 is great with anything vector — SVG images or GeoJSON data — but wasn’t originally intended to work with traditional map tiles. (_Bitmap_ images are made up of pixels, so resizing them larger or smaller is difficult without a loss in quality. _Vector_ images are defined by points, lines, and curves — mathematical equations, really — and can be scaled up or down without a loss in quality.) This is starting to change, with the introduction of the [d3.geo.tile plug-in](http://bit.ly/W8L18u). Prior to this plug-in, geomapping with D3 meant either going all-SVG and avoiding tiles or using D3 to create SVG visuals _on top of_ a base layer of map tiles (which would be managed by another library, like Leaflet or Polymaps — see the section [Alternatives](part0006_split_004.html#alternatives_2) later in this chapter). This question of how to integrate bitmap tiles and vector graphics comes up a lot in the D3 community. As of today, there is no super-simple and perfect answer, but I think you can expect to see lots of work done in this area, and possibly the new tile-handling methods integrated into the D3 core at some point in the future.\n  * D3 doesn’t hide your original data. Because D3 code is executed on the client side (meaning, in the user’s web browser, as opposed to on the web server), the data you want visualized must be sent to the client. If your data can’t be shared, then don’t use D3. Alternatives include using proprietary tools (like Flash) or prerendering visualizations as static images and sending those to the browser. (If you’re not interested in sharing your data, though, why would you bother visualizing it? The purpose of visualization is to communicate the data, so you might sleep better at night by choosing openness and transparency, rather than having nightmares about [data thieves](http://www.datathief.org/).)\n\n\n## Origins and Context\n\nThe first web browsers rendered static pages; interactivity was limited to\nclicking links. In 1996, Netscape introduced the first browser with\nJavaScript, a new scripting language that could be interpreted _by the browser\nwhile the page was being viewed_.\n\nThis doesn’t sound as groundbreaking as it turned out to be, but this enabled\nweb browsers to evolve from merely passive _browsers_ to dynamic frames for\ninteractive, networked experiences. This shift ultimately enabled every\nintrapage interaction we have on the Web today. Without JavaScript, D3 would\nnever exist, and web-based data visualizations would be limited to\nprerendered, noninteractive GIFs. (Yuck. Thank you, Netscape!)\n\nJump ahead to 2005, when Jeffrey Heer, Stuart Card, and James Landay\nintroduced [prefuse](http://prefuse.org/), a toolkit for bringing data\nvisualization to the Web. prefuse (spelled with all lowercase letters) was\nwritten in Java, a compiled language, with programs that could run in web\nbrowsers via a Java plug-in. (Note that _Java_ is a completely different\nprogramming language than _JavaScript_ , despite their similar names.)\n\nprefuse was a breakthrough application — the first to make web-based\nvisualization accessible to less-than-expert programmers. Until prefuse came\nalong, any datavis on the Web was very much a custom affair.\n\nTwo years later, Jeff Heer introduced [Flare](http://flare.prefuse.org/), a\nsimilar toolkit, but written in ActionScript, so its visualizations could be\nviewed on the Web through Adobe’s Flash Player. Flare, like prefuse, relied on\na browser plug-in. Flare was a huge improvement, but as web browsers continued\nto evolve, it was clear that visualizations could be created with native\nbrowser technology, no plug-ins required.\n\nBy 2009, Jeff Heer had moved to Stanford, where he was advising a graduate\nstudent named Michael Bostock. Together, in Stanford’s Vis Group, they created\n[Protovis](http://mbostock.github.com/protovis/), a JavaScript-based\nvisualization toolkit that relied exclusively on native browser technologies.\n(If you have used Protovis, be sure to reference Mike’s [introduction to D3\nfor Protovis users](http://bit.ly/XxebvX).)\n\nProtovis made generating visualizations simple, even for users without prior\nprogramming experience. Yet to achieve this, it created an abstract\nrepresentation layer. The designer could address this layer using Protovis\nsyntax, but it wasn’t accessible through standard methods, so debugging was\ndifficult.\n\nIn 2011, Mike Bostock, Vadim Ogievetsky, and Jeff Heer [officially announced\nD3](http://vis.stanford.edu/papers/d3), the next evolution in web\nvisualization tools. Unlike Protovis, D3 operates directly on the web document\nitself. This means easier debugging, easier experimentation, and more visual\npossibilities. The only downside to this approach is a potentially steeper\nlearning curve, but this book will make that as painless as possible. Plus,\nall the skills you gain while learning about D3 will prove useful even beyond\nthe realm of datavis.\n\nIf you’re familiar with any of these groundbreaking tools, you’ll appreciate\nthat D3 descends from a prestigious lineage. And if you have any interest in\nthe philosophy underlying D3’s elegant technical design, I highly recommend\nMike, Vadim, and Jeff’s [InfoVis\npaper](http://vis.stanford.edu/files/2011-D3-InfoVis.pdf), which clearly\narticulates the need for this kind of tool. The paper encapsulates years’\nworth of learning and insights made while developing visualization tools.\n\n\n## Alternatives\n\nD3 might not be perfect for every project. Sometimes you just need a quick\nchart and you don’t have time to code it from scratch. Or you might need to\nsupport older browsers and can’t rely on recent technologies like SVG.\n\nFor those situations, it’s good to know what other tools are out there. Here\nis a brief, noncomprehensive list of D3 alternatives, all of which use web-\nstandard technologies (mostly JavaScript) and are free to download and use.\n\n### Easy Charts\n\n[DataWrapper](http://datawrapper.de)\n\n> A beautiful web service that lets you upload your data and quickly generate\n> a chart that you can republish elsewhere or embed on your site. This service\n> was originally intended for journalists, but it is helpful for everyone.\n> DataWrapper displays interactive charts in current browsers and static\n> images for old ones. (Brilliant!) You can also download all the code and run\n> it on your own server instead of using theirs.\n\n[Flot](http://www.flotcharts.org/)\n\n> A plotting library for jQuery that uses the HTML canvas element and supports\n> older browsers, even all the way back to Internet Explorer 6. It supports\n> limited visual forms (lines, points, bars, areas), but it is easy to use.\n\n[Google Chart Tools](https://developers.google.com/chart/)\n\n> Having evolved from their earlier [Image Charts\n> API](https://developers.google.com/chart/image/), Google’s Chart Tools can\n> be used to generate several standard chart types, with support for old\n> versions of IE.\n\n[gRaphaël](http://g.raphaeljs.com/)\n\n> A charting library based on Raphaël (see later in this chapter) that\n> supports older browsers, including IE6. It has more visual flexibility than\n> Flot, and — some might say — it is prettier.\n\n[Highcharts JS](http://www.highcharts.com/)\n\n> A JavaScript-based charting library with several predesigned themes and\n> chart types. It uses SVG for modern browsers and [falls back on\n> VML](http://www.highcharts.com/documentation/compatibility) for old versions\n> of IE, including IE6 and later. The tool is free only for noncommercial use.\n\n[JavaScript InfoVis Toolkit](http://thejit.org/)\n\n> The JIT provides several preset visualization styles for your data. It\n> includes lots of examples, but the documentation is pretty technical. The\n> toolkit is great if you like one of the preset styles, but browser support\n> is unclear.\n\n[jqPlot](http://www.jqplot.com/)\n\n> A plug-in for charting with jQuery. This supports very simple charts and is\n> great if you are okay with the predefined styles. jqPlot supports IE7 and\n> newer.\n\n[jQuery Sparklines](http://omnipotent.net/jquery.sparkline/)\n\n> A jQuery plug-in for generating sparklines, typically small bar, line, or\n> area charts used inline with text. Supports most browsers, even back to IE6.\n\n[Peity](http://benpickles.github.com/peity/)\n\n> A jQuery plug-in for very simple and very _tiny_ bar, line, and pie charts\n> that supports only recent browsers. Did I mention that this makes only very\n> _tiny_ visualizations? +10 cuteness points.\n\n[Timeline.js](http://timeline.verite.co/)\n\n> A library specifically for generating interactive timelines. No coding is\n> required; just use the code generator. There is not much room for\n> customization, but hey, timelines are really hard to do well. Timeline.js\n> supports only IE8 and newer.\n\n[YUI Charts](http://yuilibrary.com/yui/docs/charts/)\n\n> The Charts module for the Yahoo! User Interface Library enables creation of\n> simple charts with a goal of wide browser support.\n\n### Graph Visualizations\n\nA “graph” is just data with a networked structure (for example, B is connected\nto A, and A is connected to C).\n\n[Arbor.js](http://arborjs.org/)\n\n> A library for graph visualization using jQuery. Even if you never use this,\n> you should check out how the documentation is presented as a graph, using\n> the tool itself. (It’s so _meta_.) It uses the HTML canvas, so it works only\n> in IE9 or current browsers, although some workarounds are available.\n\n[Sigma.js](http://sigmajs.org/)\n\n> A very lightweight library for graph visualization. You have to visit this\n> website, move your mouse over the header graphic, and then play with the\n> demos. Sigma.js is beautiful and fast, and it also uses canvas.\n\n### Geomapping\n\nI distinguish between _mapping_ (all visualizations are maps) and _geomapping_\n(visualizations that include geographic data, or geodata, such as traditional\nmaps). D3 has a lot of geomapping functionality, but you should know about\nthese other tools.\n\n[Kartograph](http://kartograph.org/)\n\n> A JavaScript-and-Python combo for gorgeous, entirely vector-based mapping by\n> Gregor Aisch with must-see demos. Please go look at them now. I promise\n> you’ve never seen online maps this beautiful. Kartograph works with IE7 and\n> newer.\n\n[Leaflet](http://leaflet.cloudmade.com/)\n\n> A library for tiled maps, designed for smooth interaction on both desktop\n> and mobile devices. It includes some support for displaying data layers of\n> SVG on top\n\nof the map tiles. (See Mike’s demo [“Using D3 with\nLeaflet”](http://bost.ocks.org/mike/leaflet/).) Leaflet works with IE6\n(barely) or IE7 (better!) and of course all current browsers.\n\n[Modest Maps](http://modestmaps.com/)\n\n> The granddaddy of tiled map libraries, Modest Maps has been succeeded by\n> Polymaps, but lots of people still love it, as it is lightweight and works\n> with old versions of IE and other browsers. Modest Maps has been adapted for\n> ActionScript, Processing, Python, PHP, Cinder, openFrameworks…yeah,\n> basically everything. File this under “oldie, but goodie.”\n\n[Polymaps](http://polymaps.org/)\n\n> A library for displaying tiled maps, with layers of data on top of the\n> tiles. Polymaps relies on SVG and thus works best with current browsers.\n\n### Almost from Scratch\n\nThese tools, like D3, provide methods of drawing visual forms, but without\npredesigned visual templates. If you enjoy the creative freedom of starting\nfrom scratch, you might enjoy these.\n\n[Processing.js](http://processingjs.org/)\n\n> A native JavaScript implementation of [Processing](http://processing.org/),\n> the fantastic programming language for artists and designers new to\n> programming. Processing is written in Java, so exporting Processing sketches\n> to the Web traditionally involved clunky Java applets. Thanks to\n> Processing.js, regular Processing code can run natively, in the browser. It\n> renders using canvas, so only modern browsers are supported.\n\n[Paper.js](http://paperjs.org/)\n\n> A framework for rendering vector graphics to canvas. Also, its website is\n> one of the most beautiful on the Internet, and their demos are unbelievable.\n> (Go play with them now.)\n\n[Raphaël](http://raphaeljs.com/)\n\n> Another library for drawing vector graphics, popular due to its friendly\n> syntax and support for older browsers.\n\n### Three-Dimensional\n\nD3 is not the best at 3D, simply because web browsers are historically two-\ndimensional beasts. But with increased support for WebGL, there are now more\nopportunities for 3D web experiences.\n\n[PhiloGL](http://www.senchalabs.org/philogl/)\n\n> A WebGL framework specifically for 3D visualization.\n\n[Three.js](http://mrdoob.github.com/three.js/)\n\n> A library for generating any sort of 3D scene you could imagine, produced by\n> Google’s Data Arts team. You could spend all day exploring the mind-blowing\n> demos on their site.\n\n### Tools Built with D3\n\nWhen you want to use D3 without actually writing any D3 code, you can choose\none of the many tools built on top of D3!\n\n[Crossfilter](http://square.github.com/crossfilter/)\n\n> A library for working with large, multivariate datasets, written primarily\n> by Mike Bostock. This is useful for trying to squeeze your “big data” into a\n> relatively small web browser.\n\n[Cubism](http://square.github.com/cubism/)\n\n> A D3 plug-in for visualizing time series data, also written by Mike Bostock.\n> (One of my favorite demos.)\n\n[Dashku](https://dashku.com/)\n\n> An online tool for data dashboards and widgets updated in real time, by Paul\n> Jensen.\n\n[dc.js](http://nickqizhu.github.com/dc.js/)\n\n> The “dc” is short for _dimensional charting_ , as this library is optimized\n> for exploring large, multidimensional datasets.\n\n[NVD3](http://nvd3.org)\n\n> Reusable charts with D3. NVD3 offers lots of beautiful examples, with room\n> for visual customizations without requiring as much code as D3 alone.\n\n[Polychart.js](http://polychart.com/)\n\n> More reusable charts, with a range of chart types available. Polychart.js is\n> free only for noncommercial use.\n\n[Rickshaw](http://code.shutterstock.com/rickshaw/)\n\n> A toolkit for displaying time series data that is also very customizable.\n\n[Tributary](http://enjalot.com/)\n\n> A great tool for experimenting with live coding using D3, by Ian Johnson.\n\n\n## Chapter 3. Technology Fundamentals\n\nSolid familiarity with the following concepts will make your time with D3 a\nlot less frustrating and a lot more rewarding. Consider this a brief refresher\ncourse on Web-Making 101.\n\n* * *\n\n### Warning\n\nBeware! This is a pretty dense chapter, packed with years’ worth of web\ndevelopment knowledge, and nothing in here is specific to D3. I recommend\nskimming just the sections on information that is new to you, and skipping the\nrest. You can always reference this chapter later as questions arise.\n\n* * *\n\n\n## The Web\n\nIf you’re brand new to making web pages, you will now have to think about\nthings that regular people blissfully disregard every day, such as this: How\ndoes the Web actually work?\n\nWe think of the Web as a bunch of interlinked pages, but it’s really a\ncollection of conversations between web servers and web clients (browsers).\n\nThe following scene is a dramatization of a typical such conversation that\nhappens whenever you or anyone else clicks a link or types an address into\nyour browser (meaning, this brief conversation is had about 88 zillion times\nevery day):\n\n> CLIENT: I’d really like to know what’s going on over at _somewebsite.com_. I\n> better call over there to get the latest info. [Silent sound of Internet\n> connection being established.]\n>\n> SERVER: Hello, unknown web client! I am the server hosting\n> _somewebsite.com_. What page would you like?\n>\n> CLIENT: This morning, I am interested in the page at\n> _somewebsite.com/news/_.\n>\n> SERVER: Of course, one moment.\n>\n> _Code is transmitted from SERVER to CLIENT._\n>\n> CLIENT: I have received it. Thank you!\n>\n> SERVER: You’re welcome! Would love to stay on the line and chat, but I have\n> other requests to process. Bye!\n\nClients contact servers with _requests_ , and servers respond with data. But\nwhat is a server and what is a client?\n\n_Web servers_ are Internet-connected computers running server software, so\ncalled because they _serve_ web documents as requested. Servers are typically\nalways on and always connected, but web developers often also run _local_\nservers, meaning they run on the same computer that you’re working on. _Local_\nmeans here; _remote_ means somewhere else, on any computer but the one right\nin front of you.\n\nThere are lots of different server software packages, but Apache is the most\ncommon. Web server software is not pretty, and no one ever wants to look at\nit.\n\nIn contrast, web _browsers_ can be very pretty, and we spend a lot of time\nlooking at them. Regular people recognize names like Firefox, Safari, Chrome,\nand Internet Explorer, all of which are browsers or _web clients_.\n\nEvery web page, in theory, can be identified by its URL (Uniform Resource\nLocator) or URI (Uniform Resource Identifier). Most people don’t know what\n_URL_ stands for, but they recognize one when they see it. By obsolete\nconvention, URLs commonly begin with _www_ , as in\n<http://www.calmingmanatee.com>, but with a properly configured server, the\n_www_ part is wholly unnecessary.\n\nComplete URLs consist of four parts:\n\n  * An indication of the _communication protocol_ , such as HTTP or HTTPS \n  * The _domain name_ of the resource, such as _calmingmanatee.com_\n  * The _port number_ , indicating over which port the connection to the server should be attempted \n  * Any additional locating information, such as the path of the requested file, or any query parameters\n\nA complete URL, then, might look like this:\n<http://alignedleft.com:80/tutorials/d3/>.\n\nTypically, the port number is excluded, as web browsers will try to connect\nover port 80 by default. So the preceding URL is functionally the same as the\nfollowing: <http://alignedleft.com/tutorials/d3/>\n\nNote that the protocol is separated from the domain name by a colon and two\nforward (regular) slashes. Why two slashes? No reason. The inventor of the Web\n[regrets the error](http://nyti.ms/Xaol4j).\n\nHTTP stands for Hypertext Transfer Protocol, and it’s the most common protocol\nfor transferring web content from server to client. The “S” on the end of\nHTTPS stands for _Secure_. HTTPS connections are used whenever information\nshould be encrypted in transit, such as for online banking or e-commerce.\n\nLet’s briefly step through the process of what happens when a person goes to\nvisit a website.\n\n  1. User runs the web browser of her choice, then types a URL into the address bar, such as _alignedleft.com/tutorials/d3/_. Because she did not specify a protocol, HTTP is assumed, and “http://” is prepended to the URL. \n  2. The browser then attempts to connect to the server behind _alignedleft.com_ across the network, via port 80, the default port for HTTP. \n  3. The server associated with _alignedleft.com_ acknowledges the connection and is taking requests. (“I’ll be here all night.”) \n  4. The browser sends a request for the page that lives at _/tutorials/d3/_. \n  5. The server sends back the HTML content for that page. \n  6. As the client browser receives the HTML, it discovers references to _other files_ needed to assemble and display the entire page, including CSS stylesheets and image files. So it contacts the same server again, once per file, requesting the additional information. \n  7. The server responds, dispatching each file as needed. \n  8. Finally, all the web documents have been transferred over. Now the client performs its most arduous task, which is to _render_ the content. It first parses through the HTML to understand the structure of the content. Then it reviews the CSS selectors, applying any properties to matched elements. Finally, it plugs in any image files and executes any JavaScript code. \n\nCan you believe that all that happens every time you click a link? It’s a lot\nmore complicated than most people realize, but it’s important to understand\nthat client/server conversations are fundamental to the Web.\n\n\n## HTML\n\nHypertext Markup Language is used to structure content for web browsers. HTML\nis stored in plain text files with the _.html_ suffix. A simple HTML document\nlooks like this:\n\n    \n    \n    <!DOCTYPE html>\n    <html>\n        <head>\n            <title>Page Title</title>\n        </head>\n        <body>\n            <h1>Page Title</h1>\n            <p>This is a really interesting paragraph.</p>\n        </body>\n    </html>\n\nHTML is a complex language with a rich history. This overview will address\nonly the current iteration of HTML (formerly known as HTML5) and will touch on\nonly what is immediately relevant for our practice with D3.\n\n### Content Plus Structure\n\nThe core function of HTML is to enable you to “mark up” content, thereby\ngiving it structure. Take, for example, this raw text:\n\n    \n    \n    Amazing Visualization Tool Cures All Ills A new open-source tool designed for\n    visualization of data turns out to have an unexpected, positive side effect:\n    it heals any ailments of the viewer. Leading scientists report that the tool,\n    called D3000, can cure even the following symptoms: fevers chills general\n    malaise It achieves this end with a patented, three-step process. Load in data.\n    Generate a visual representation. Activate magic healing function.\n\nReading between the lines, we can infer that this is a very exciting news\nstory. But as unstructured content, it is very hard to read. By adding\nstructure, we can differentiate between the headline, for example, and the\nbody of the story.\n\n> **Amazing Visualization Tool Cures All Ills**\n>\n> A new open-source tool designed for visualization of data turns out to have\n> an unexpected, positive side effect: it heals any ailments of the viewer.\n> Leading scientists report that the tool, called D3000, can cure even the\n> following symptoms:\n>\n>   * fevers\n>   * chills\n>   * general malaise\n>\n\n>\n> It achieves this end with a patented, three-step process.\n>\n>   1. Load in data.\n>   2. Generate a visual representation.\n>   3. Activate magic healing function.\n>\n\nThat has the same raw text content, but with a _visual structure_ that makes\nthe content more accessible.\n\nHTML is a tool for specifying _semantic structure_ , or attaching hierarchy,\nrelationships, and _meaning_ to content. (HTML doesn’t address the visual\nrepresentation of a document’s structure — that’s CSS’ job.) Here is our story\nwith each chunk of content replaced by a _semantic description_ of what that\ncontent is.\n\n> **Headline**\n>\n> Paragraph text\n>\n>   * Unordered list item\n>   * Unordered list item\n>   * Unordered list item\n>\n\n>\n> Paragraph text\n>\n>   1. Numbered list item\n>   2. Numbered list item\n>   3. Numbered list item\n>\n\nThis is the kind of structure we specify with HTML markup.\n\n### Adding Structure with Elements\n\n“Marking up” is the process of adding _tags_ to create _elements_. HTML tags\nbegin with `<` and end with `>`, as in `<p>`, which is the tag indicating a\nparagraph of text. Tags usually occur in pairs, in which case adding an\nopening and closing pair of tags creates a new _element_ in the document\nstructure.\n\nClosing tags are indicated with a slash that closes or ends the element, as in\n`</p>`. Thus, a paragraph of text may be marked up like the following:\n\n    \n    \n    <p>This is a really interesting paragraph.</p>\n\nSome elements can be _nested_. For example, here we use the `em` element to\nadd _emphasis_.\n\n    \n    \n    <p>This is a <em>really</em> interesting paragraph.</p>\n\nNesting elements introduces hierarchy to the document. In this case, `em` is a\nchild of `p` because it is contained by `p`. (Conversely, `p` is `em`’s\nparent.)\n\nWhen elements are nested, they cannot overlap closures of their parent\nelements, as doing so would disrupt the hierarchy. For example:\n\n    \n    \n    <p>This could cause <em>unexpected</p>\n    <p>results</em>, and is best avoided.</p>\n\nSome tags never occur in pairs, such as the `img` element, which references an\nimage file. Although HTML no longer requires it, you will sometimes see such\ntags written in _self-closing_ fashion, with a trailing slash before the\nclosing bracket:\n\n    \n    \n    <img src=\"photo.jpg\" />\n\nAs of HTML5, the self-closing slash is optional, so the following code is\nequivalent to the preceding code:\n\n    \n    \n    <img src=\"photo.jpg\">\n\n### Common Elements\n\nThere are hundreds of different HTML elements. Here are some of the most\ncommon. We’ll cover additional elements in later chapters. (Reference the\nexcellent [Mozilla Developer Network\ndocumentation](https://developer.mozilla.org/en/HTML/Element) for a complete\nlisting.)\n\n`<!DOCTYPE html>`\n\n> The standard document type declaration. Must be the first thing in the\n> document.\n\n`html`\n\n> Surrounds all HTML content in a document.\n\n`head`\n\n> The document `head` contains all metadata about the document, such as its\n> `title` and any references to external stylesheets and scripts.\n\n`title`\n\n> The title of the document. Browsers typically display this at the top of the\n> browser window and use this title when bookmarking a page.\n\n`body`\n\n> Everything not in the `head` should go in the `body`. This is the primary\n> visible content of the page.\n\n`h1`, `h2`, `h3`, `h4`\n\n> These let you specify headings of different levels. `h1` is a top-level\n> heading, `h2` is below that, and so on.\n\n`p`\n\n> A paragraph!\n\n`ul`, `ol`, `li`\n\n> Unordered lists are specified with `ul`, most often used for bulleted lists.\n> Ordered lists (`ol`) are often numbered. Both `ul` and `ol` should include\n> `li` elements to specify list items.\n\n`em`\n\n> Indicates emphasis. Typically rendered in _italics_.\n\n`strong`\n\n> Indicates additional emphasis. Typically rendered in **boldface**.\n\n`a`\n\n> A link. Typically rendered as underlined, blue text, unless otherwise\n> specified.\n\n`span`\n\n> An arbitrary `span` of text, typically within a larger containing element\n> like `p`.\n\n`div`\n\n> An arbitrary _division_ within the document. Used for grouping and\n> containing related elements.\n\nOur earlier example could be given semantic structure by marking it up using\nsome of these element’s tags:\n\n    \n    \n    <h1>Amazing Visualization Tool Cures All Ills</h1>\n    <p>A new open-source tool designed for visualization of data turns out to have\n    an unexpected, positive side effect: it heals any ailments of the viewer.\n    Leading scientists report that the tool, called D3000, can cure even the\n    following symptoms:</p>\n    <ul>\n        <li>fevers</li>\n        <li>chills</li>\n        <li>general malaise</li>\n    </ul>\n    <p>It achieves this end with a patented, three-step process.</p>\n    <ol>\n        <li>Load in data.</li>\n        <li>Generate a visual representation.</li>\n        <li>Activate magic healing function.</li>\n    </ol>\n\nWhen viewed in a web browser, that markup is rendered as shown in [Figure\n3-1](part0007_split_002.html#Typical_default_rendering_of_simple_HTML).\n\n![Typical default rendering of simple HTML](../images/00004.jpeg)\n\nFigure 3-1. Typical default rendering of simple HTML\n\nNotice that we specified only the _semantic_ structure of the content; we\ndidn’t specify any visual properties, such as color, type size, indents, or\nline spacing. Without such instructions, the browser falls back on its\n_default styles_ , which, frankly, are not too exciting.\n\n### Attributes\n\nAll HTML elements can be assigned _attributes_ by including property/value\npairs in the opening tag.\n\n    \n    \n    <tagname property=\"value\"></tagname>\n\nThe name of the property is followed by an equals sign, and the value is\nenclosed within double quotation marks.\n\nDifferent kinds of elements can be assigned different attributes. For example,\nthe `a` link tag can be given an `href` attribute, whose value specifies the\nURL for that link. (`href` is short for “HTTP reference.”)\n\n    \n    \n    <a href=\"http://d3js.org/\">The D3 website</a>\n\nSome attributes can be assigned to _any_ type of element, such as `class` and\n`id`.\n\n### Classes and IDs\n\nClasses and IDs are extremely useful attributes, as they can be referenced\nlater to identify specific pieces of content. Your CSS and JavaScript code\nwill rely heavily on classes and IDs to identify elements. For example:\n\n    \n    \n    <p>Brilliant paragraph</p>\n    <p>Insightful paragraph</p>\n    <p class=\"awesome\">Awe-inspiring paragraph</p>\n\nThese are three very uplifting paragraphs, but only one of them is truly\nawesome, as I’ve indicated with `class=\"awesome\"`. The third paragraph becomes\npart of a _class_ of _awesome_ elements, and it can be selected and\nmanipulated along with other class members. (We’ll get to that in a moment.)\n\nElements can be assigned multiple classes, simply by separating them with a\nspace:\n\n    \n    \n    <p class=\"uplifting\">Brilliant paragraph</p>\n    <p class=\"uplifting\">Insightful paragraph</p>\n    <p class=\"uplifting awesome\">Awe-inspiring paragraph</p>\n\nNow, all three paragraphs are `uplifting`, but only the last one is both\n`uplifting` _and_ `awesome`.\n\nIDs are used in much the same way, but there can be only one ID per element,\nand each ID value can be used only once on the page. For example:\n\n    \n    \n    <div id=\"content\">\n        <div id=\"visualization\"></div>\n        <div id=\"button\"></div>\n    </div>\n\nIDs are useful when a single element has some special quality, like a `div`\nthat functions as a button or as a container for other content on the page.\n\nAs a general rule, if there will be only _one_ such element on the page, you\ncan use an `id`. Otherwise, use a `class`.\n\n* * *\n\n### Warning\n\nClass and ID names cannot begin with numerals; they must begin with alphabetic\ncharacters. So `id=\"1\"` won’t work, but `id=\"item1\"` will. The browser will\nnot give you any errors; your code simply won’t work, and you will go crazy\ntrying to figure out why.\n\n* * *\n\n### Comments\n\nAs code grows in size and complexity, it is good practice to include comments.\nThese are friendly notes that you leave for yourself to remind you why you\nwrote the code the way you did. If you are like me, you will revisit projects\nonly weeks later and have lost all recollections of it. Commenting is an easy\nway to reach out and provide guidance and solace to your future (and very\nconfused) self.\n\nIn HTML, comments are written in the following format:\n\n    \n    \n    <!-- Your comment here -->\n\nAnything between the `<!--` and `-->` will be ignored by the web browser.\n\n\n## DOM\n\nThe term Document Object Model refers to the hierarchical structure of HTML.\nEach pair of bracketed tags (or, in some cases, a single tag) is an _element_\n, and we refer to elements’ relative relationships to each other in human\nterms: parent, child, sibling, ancestor, and descendant. For example, in this\nHTML:\n\n    \n    \n    <html>\n        <body>\n            <h1>Breaking News</h1>\n            <p></p>\n        </body>\n    </html>\n\n`body` is the parent element to both of its children, `h1` and `p` (which are\nsiblings to each other). All elements on the page are descendants of `html`.\n\nWeb browsers parse the DOM to make sense of a page’s content. As coders\nbuilding visualizations, we care about the DOM, because our code must navigate\nits hierarchy to apply styles and actions to its elements. We don’t want to\nmake _all_ the `div` elements blue; we need to know how to select just the\n`div`s of the class `sky` and make _them_ blue.\n\n\n## Developer Tools\n\nIn the olden days, the web development process went like this:\n\n  1. Write some code in a text editor.\n  2. Save the files. \n  3. Switch to a browser window. \n  4. Reload the page, and see if your code worked. \n  5. If it didn’t work, take a guess at what went wrong inside the magical black box of the web browser, then go back to step 1. \n\nBrowsers were notoriously secretive about what went on _inside_ the rendering\nengine, which made debugging a total nightmare. (Seriously, in the late 1990s\nand early 2000s, I literally had nightmares about this.) Fortunately, we live\nin a more enlightened age, and every modern-day browser has built-in\n_developer tools_ that expose the inner workings of the beast and enable us to\npoke around under the hood (to mix incompatible metaphors).\n\nAll this is to say that developer tools are a big deal and you will rely on\nthem heavily to both test your code and, when something breaks, figure out\nwhat went wrong.\n\nLet’s start with the simplest possible use of the developer tools: viewing the\nraw source code of an HTML page (see [Figure\n3-2](part0007_split_004.html#plain_source_view_window)).\n\nEvery browser supports this, although different browsers hide this option in\ndifferent places. In Chrome 23.0, it’s under View→Developer→View Source. In\nFirefox 17.0, look under Tools→Web Developer→Page Source. In Safari 6.0, it’s\nunder Develop→Show Page Source (although you must first set the “Develop” menu\nto display under Safari→Preferences→Advanced). Going forward, I’m going to\nassume that you’re using the newest version of whatever browser you choose.\n\n![Looking at the source code in a new window](../images/00005.jpeg)\n\nFigure 3-2. Looking at the source code in a new window\n\nThat gets you the raw HTML, but if any D3 or JavaScript code has been\nexecuted, the current DOM may be vastly different.\n\nFortunately, your browser’s developer tools enable you to see the current\nstate of the DOM. And, again, the developer tools are different in every\nbrowser. In Chrome, find them under View→Developer→Developer Tools. In\nFirefox, try Tools→Web Developer. In Safari, first enable the developer tools\n(in Safari→Preferences→Advanced). Then, in the Develop menu, choose Show Web\nInspector. In any browser, you can also use the corresponding keyboard\nshortcut (as shown adjacent to the menu item) or right-click and choose\n“inspect element” or something similar.\n\nUntil recently, Safari and Chrome shared the same developer tools, but with\nSafari 6.0, Apple completely redesigned their dev tools, much to the dismay of\nmany web-developing Safari fans. (The new tools are very hard to navigate, and\nI don’t think I’m the only one who feels that way.) Whichever browser you use\nmight look a bit different from my screenshots, but the functionality will be\nvery similar.\n\n[Figure 3-3](part0007_split_004.html#Safari_web_inspector) shows the Elements\ntab of Chrome’s web inspector. Here we can see the current state of the DOM.\nThis is useful because your code will modify DOM elements dynamically. In the\nweb inspector, you can watch elements as they change.\n\n![Chrome’s web inspector](../images/00006.jpeg)\n\nFigure 3-3. Chrome’s web inspector\n\nIf you look closely, you’ll already see some differences between the raw HTML\nand the DOM, including the fact that Chrome generated the required `html`,\n`head`, and `body` elements. (I was lazy and didn’t include them in my\noriginal HTML.)\n\nOne more thing: why am I focusing on Chrome, Firefox, and Safari? Why not\nInternet Explorer, Opera, or the many other browsers out there? For one, it’s\nbest to develop your projects using a browser with the broadest support for\nweb standards. Internet Explorer made huge progress with versions 9 and 10,\nbut Chrome, Firefox, and Safari are understood to have the broadest standards\nsupport, and they are updated more frequently.\n\nSecond, you’re going to spend a lot of time using the developer tools, so you\nshould develop with a browser that has tools you enjoy using. I was pretty\ndevoted to Safari until the 6.0 update changed everything. Now I’m going back\nand forth between Chrome and Firefox’s new dev tools. I recommend you try them\nall and decide what works best for you.\n\n\n## Rendering and the Box Model\n\n _Rendering_ is the process by which browsers, after parsing the HTML and\ngenerating the DOM, apply visual rules to the DOM contents and draw those\npixels to the screen.\n\nThe most important thing to keep in mind when considering how browsers render\ncontent is this: to a browser, everything is a box.\n\nParagraphs, `div`s, `span`s — all are boxes in the sense that they are two-\ndimensional rectangles, with properties that any rectangle can have, such as\nwidth, height, and positions in space. Even if something looks curved or\nirregularly shaped, rest assured, to the browser, it is merely another\nrectangular box.\n\nYou can see these boxes with the help of the web inspector. Just mouse over\nany element, and the box associated with that element is highlighted in blue,\nas shown in [Figure\n3-4](part0007_split_005.html#Inspector_with_element_box_highlighted).\n\n![Inspector with element box highlighted](../images/00007.jpeg)\n\nFigure 3-4. Inspector with element box highlighted\n\nThere’s a lot of information about the `ul` unordered list here. Note that the\nlist’s total dimensions (width and height) are shown in the yellow box at the\nelement’s lower-left corner. Also, the list’s position in the DOM hierarchy is\nindicated in the lower-left corner of the inspector: `html > body > ul`.\n\nThe box for the `ul` expands to fill the width of the entire window because it\nis a _block-level_ element. (Note how under “Computed Style” is listed\n`display: block`.) This is in contrast to _inline_ elements, which rest _in\nline_ with each other, not stacked on top of each other like blocks. Common\ninline elements include `strong`, `em`, `a`, and `span`.\n\nBy default, block-level elements expand to fill their container elements and\nforce any subsequent sibling elements further down the page. Inline elements\ndo not expand to fill extra space, and happily exist side by side, next to\ntheir fellow inline neighbors. (Discussion question: what kind of element\nwould you rather be?)\n\n\n## CSS\n\nCascading Style Sheets are used to style the visual presentation of DOM\nelements. A simple CSS stylesheet looks like the following:\n\n    \n    \n    body {\n        background-color: white;\n        color: black;\n    }\n\nCSS styles consist of _selectors_ and _properties_. Selectors are followed by\nproperties, grouped in curly brackets. A property and its value are separated\nby a colon, and the line is terminated with a semicolon, like the following:\n\n    \n    \n    selector {\n        property: value;\n        property: value;\n        property: value;\n    }\n\nThe same properties can be applied to multiple selectors at once by separating\nthe selectors with a comma, as in the following:\n\n    \n    \n    selectorA,\n    selectorB,\n    selectorC {\n        property: value;\n        property: value;\n        property: value;\n    }\n\nFor example, you might want to specify that both `p` paragraphs and `li` list\nitems should use the same font size, line height, and color.\n\n    \n    \n    p,\n    li {\n        font-size: 12px;\n        line-height: 14px;\n        color: orange;\n    }\n\nCollectively, this whole chunk of code (selectors and bracketed properties) is\ncalled a _CSS rule_.\n\n### Selectors\n\nD3 uses CSS-style selectors to identify elements on which to operate, so it’s\nimportant to understand how to use them.\n\nSelectors identify specific elements to which styles will be applied. There\nare several different kinds of selectors. We’ll use only the simplest ones in\nthis book.\n\nType selectors\n\n> These are the simplest. They match DOM elements with the same name:\n    \n    \n    h1          /* Selects all level 1 headings           */\n    p           /* Selects all paragraphs                 */\n    strong      /* Selects all strong elements            */\n    em          /* Selects all em elements                */\n    div         /* Selects all divs                       */\n\nDescendant selectors\n\n> These match elements that are contained by (or “descended from”) another\n> element. We will rely heavily on descendant selectors to apply styles:\n    \n    \n    h1 em       /* Selects em elements contained in an h1 */\n    div p       /* Selects p elements contained in a div  */\n\nClass selectors\n\n> These match elements of any type that have been assigned a specific class.\n> Class names are preceded with a period, as shown here:\n    \n    \n    .caption    /* Selects elements with class \"caption\"  */\n    .label      /* Selects elements with class \"label\"    */\n    .axis       /* Selects elements with class \"axis\"     */\n\nBecause elements can have more than one class, you can target elements with\nmultiple classes by stringing the classes together, as in the following:\n\n    \n    \n    .bar.highlight  /* Could target highlighted bars      */\n    .axis.x         /* Could target an x-axis             */\n    .axis.y         /* Could target a y-axis              */\n\n`.axis` could be used to apply styles to both axes, for example, whereas\n`.axis.x` would apply only to the x-axis.\n\nID selectors\n\n> These match the single element with a given ID. (Remember, IDs can be used\n> only once each in the DOM.) IDs are preceded with a hash mark.\n    \n    \n    #header     /* Selects element with ID \"header\"       */\n    #nav        /* Selects element with ID \"nav\"          */\n    #export     /* Selects element with ID \"export\"       */\n\nSelectors get progressively more useful as you combine them in different ways\nto target specific elements. You can string selectors together to get very\nspecific results. For example:\n\n    \n    \n    div.sidebar /* Selects divs with class \"sidebar\", but\n                   not other elements with that class     */\n    #button.on  /* Selects element with ID \"button\", but\n                   only when the class \"on\" is applied    */\n\nRemember, because the DOM is dynamic, classes and IDs can be added and\nremoved, so you might have CSS rules that apply only in certain scenarios.\n\nFor details on additional selectors, see the [Mozilla Developer\nNetwork](http://mzl.la/V27Mcr).\n\n### Properties and Values\n\nGroups of property/value pairs cumulatively form the styles:\n\n    \n    \n    margin: 10px;\n    padding: 25px;\n    background-color: yellow;\n    color: pink;\n    font-family: Helvetica, Arial, sans-serif;\n\nAt the risk of stating the obvious, notice that each property expects a\ndifferent kind of information. `color` wants a color, `margin` requires a\nmeasurement (here in `px` or pixels), and so on.\n\nBy the way, colors can be specified in several different formats:\n\n  * Named colors: `orange`\n  * Hex values: `#3388aa` or `#38a`\n  * RGB values: `rgb(10, 150, 20)`\n  * RGB with alpha transparency: `rgba(10, 150, 20, 0.5)`\n\nYou can find [exhaustive lists of properties\nonline](https://developer.mozilla.org/en/CSS/CSS_Reference); I won’t try to\nlist them here. Instead, I’ll just introduce relevant properties as we go.\n\n### Comments\n\n    \n    \n    /* By the way, this is what a comment looks like\n       in CSS.  They start with a slash-asterisk pair,\n       and end with an asterisk-slash pair.  Anything\n       in between will be ignored. */\n\n### Referencing Styles\n\nThere are three common ways to apply CSS style rules to your HTML document.\n\n#### Embed the CSS in your HTML.\n\nIf you embed the CSS rules in your HTML document, you can keep everything in\none file. In the document `head`, include all CSS code within a `style`\nelement.\n\n    \n    \n    <html>\n        <head>\n            <style type=\"text/css\">\n    \n                p {\n                    font-size: 24px;\n                    font-weight: bold;\n                    background-color: red;\n                    color: white;\n                }\n    \n            </style>\n        </head>\n        <body>\n            <p>If I were to ask you, as a mere paragraph, would you say that I\n            have style?</p>\n        </body>\n    </html>\n\nThat HTML page with CSS renders as shown in [Figure\n3-5](part0007_split_006.html#Rendering_of_an_embedded_CSS_rule).\n\n![Rendering of an embedded CSS rule](../images/00008.jpeg)\n\nFigure 3-5. Rendering of an embedded CSS rule\n\nEmbedding is the simplest option, but I generally prefer to keep different\nkinds of code (for example, HTML, CSS, JavaScript) in separate documents.\n\n#### Reference an external stylesheet from the HTML.\n\nTo store CSS outside of your HTML, save it in a plain-text file with a _.css_\nsuffix, such as _style.css_. Then use a `link` element in the document `head`\nto reference the external CSS file, like so:\n\n    \n    \n    <html>\n        <head>\n            <link rel=\"stylesheet\" href=\"style.css\">\n        </head>\n        <body>\n            <p>If I were to ask you, as a mere paragraph, would you say that\n            I have style?</p>\n        </body>\n    </html>\n\nThis example renders exactly the same as the prior example.\n\n#### Attach inline styles.\n\nA third method is to attach style rules _inline_ directly to elements in the\nHTML. You can do this by adding a `style` attribute to any element. Then\ninclude the CSS rules within the double quotation marks. The result is shown\nin [Figure 3-6](part0007_split_006.html#Rendering_of_an_inline_CSS_rule).\n\n    \n    \n    <p style=\"color: blue; font-size: 48px; font-style: italic;\">Inline styles\n    are kind of a hassle</p>\n\n![Rendering of an inline CSS rule](../images/00009.jpeg)\n\nFigure 3-6. Rendering of an inline CSS rule\n\nBecause inline styles are attached directly to elements, there is no need for\nselectors.\n\nInline styles are messy and hard to read, but they are useful for giving\nspecial treatment to a single element, when that style information doesn’t\nmake sense in a larger stylesheet. We’ll learn how to apply inline styles\nprogrammatically with D3 (which is much easier than typing them in by hand,\none at a time).\n\n### Inheritance, Cascading, and Specificity\n\nMany style properties are _inherited_ by an element’s descendants unless\notherwise specified. For example, this document’s style rule applies to the\n`div`:\n\n    \n    \n    <html>\n        <head>\n            <title></title>\n            <style type=\"text/css\">\n    \n                div {\n                    background-color: red;\n                    font-size: 24px;\n                    font-weight: bold;\n                    color: white;\n                }\n    \n            </style>\n        </head>\n        <body>\n            <p>I am a sibling to the div.</p>\n            <div>\n                <p>I am a descendant and child of the div.</p>\n            </div>\n        </body>\n    </html>\n\nYet when this page renders, the styles intended for the `div` (red background,\nbold text, and so on) are _inherited_ by the second paragraph, as shown in\n[Figure 3-7](part0007_split_006.html#Inherited_style), because that `p` is a\ndescendant of the styled `div`.\n\n![Inherited style](../images/00010.jpeg)\n\nFigure 3-7. Inherited style\n\nInheritance is a great feature of CSS, as children adopt the styles of their\nparents. (There’s a metaphor in there somewhere.)\n\nFinally, an answer to the most pressing question of the day: why are they\ncalled Cascading Style Sheets? It’s because selector matches cascade from the\ntop down. When more than one selector applies to an element, the later rule\ngenerally overrides the earlier one. For example, the following rules set the\ntext of all paragraph elements in the document to be blue _except_ for those\nwith the class of `highlight` applied, which will be black _and_ have a yellow\nbackground, as shown in [Figure\n3-8](part0007_split_006.html#CSS_cascading_and_inheritance_at_work). The rules\nfor `p` are applied first, but then the rules for `p.highlight` override the\nless specific `p` rules.\n\n    \n    \n    p {\n        color: blue;\n    }\n    \n    p.highlight {\n        color: black;\n        background-color: yellow;\n    }\n\n![CSS cascading and inheritance at work](../images/00011.jpeg)\n\nFigure 3-8. CSS cascading and inheritance at work\n\nLater rules generally override earlier ones, but not always. The true logic\nhas to do with the _specificity_ of each selector. The `p.highlight` selector\nwould override the `p` rule even if it were listed first, simply because it is\na more specific selector. If two selectors have the same specificity, then the\nlater one will be applied.\n\nThis is one of the main causes of confusion with CSS. The rules for\ncalculating specificity are inscrutable, and I won’t cover them here. To save\nyourself headaches later, keep your selectors clear and easy to read. Start\nwith general selectors on top, and work your way down to more specific ones,\nand you’ll be all right.\n\n\n## JavaScript\n\nJavaScript is the scripting language that can make pages dynamic by\nmanipulating the DOM after a page has already loaded in the browser. As I\nmentioned earlier, getting to know D3 is also a process of getting to know\nJavaScript. We’ll dig in deeper as we go, but here is a taste to get you\nstarted.\n\n### Hello, Console\n\nNormally, we write JavaScript code (or, a “script”) in a text file, and then\nload that file to the browser in a web page. But you can also just type\nJavaScript code directly into your browser. This is an easy and quick way to\nget your feet wet and test out code. We’ll also use the JavaScript console for\ndebugging, as it’s an essential tool for seeing what’s going on with your\ncode.\n\nIn Chrome, select View→Developer→JavaScript Console. In Firefox, choose\nTools→Web Developer→Web Console. In Safari, go to Develop→Show Error Console\n(see [Figure 3-9](part0007_split_007.html#A_fresh_JavaScript_console)).\n\n![A fresh JavaScript console… delicious!](../images/00012.jpeg)\n\nFigure 3-9. A fresh JavaScript console… delicious!\n\nThe console accepts one line of code at a time, and it always spits back the\nresult of whatever you input. For example, if you enter the number `7`, the\nconsole returns the mind-numbingly obvious result of `7`. Brilliant.\n\nOther times, you’ll want your script to print values out to the console\nautomatically, so you can keep an eye on what’s going on. As you’ll see in\nsome examples that follow, you can use `console.log(\"something\");` to do that.\n\nType the following examples into the console to see how it works.\n\n### Variables\n\nVariables are containers for data. A simple variable holds one value:\n\n    \n    \n    var number = 5;\n\nIn that statement, `var` indicates you are declaring a new variable, the name\nof which is `number`. The equals sign is an _assignment operator_ because it\ntakes the value on the right (`5`) and _assigns_ it to the variable on the\nleft (`number`). So when you see something such as:\n\n    \n    \n    defaultColor = \"hot pink\";\n\ntry to read the equals sign not as “equals” but as “is set to.” So that\nstatement could be stated in plain English as “The variable `defaultColor` _is\nset to_ hot pink.”\n\nAs you’ve just seen, variables can store numeric values as well as strings of\ntext, so called because they are formed by stringing together individual\ncharacters of text. Strings must be enclosed by quotation marks. True or false\n(Boolean) values can also be stored:\n\n    \n    \n    var thisMakesSenseSoFar = true;\n\nAlso note that in JavaScript, statements are concluded with a semicolon.\n\nYou can try making some variables yourself in the console. For example, type\n`var amount = 200`, then press Enter, then on a new line just enter `amount`\nand press Enter. You should see `200` returned to you in the console — proof\nthat JavaScript remembered the value you assigned to `amount`!\n\n### Other Variable Types\n\nA variable is a datum, the smallest building block of data. The variable is\nthe foundation of all other data structures, which are simply different\nconfigurations of variables.\n\nNow we’ll address some of these more complex forms of data, including arrays,\nobjects, and arrays of objects. You might want to skip this section for now,\nbut reference it later, once you’re ready to load your own data into D3.\n\n### Arrays\n\nAn array is a sequence of values, conveniently stored in a single variable.\n\nKeeping track of related values in separate variables is inefficient:\n\n    \n    \n    var numberA = 5;\n    var numberB = 10;\n    var numberC = 15;\n    var numberD = 20;\n    var numberE = 25;\n\nRewritten as an array, those values are much simpler. Hard brackets `[]`\nindicate an array, and each value is separated by a comma:\n\n    \n    \n    var numbers = [ 5, 10, 15, 20, 25 ];\n\nArrays are ubiquitous in data visualization, so you will become very\ncomfortable with them. You can access (retrieve) a value in an array by using\n_bracket notation_ :\n\n    \n    \n    numbers[2]  //Returns 15\n\nThe numeral in the bracket refers to a corresponding position in the array.\nRemember, array positions begin counting at zero, so the first position is 0,\nthe second position is 1, and so on:\n\n    \n    \n    numbers[0]  //Returns 5\n    numbers[1]  //Returns 10\n    numbers[2]  //Returns 15\n    numbers[3]  //Returns 20\n    numbers[4]  //Returns 25\n\nSome people find it helpful to think of arrays in spatial terms, as though\nthey have rows and columns, like in a spreadsheet:\n\nPosition |  Value  \n---|---  \n0| 5  \n1| 10  \n2| 15  \n3| 20  \n4| 25  \n  \nArrays can contain any type of data, not just integers:\n\n    \n    \n    var percentages = [ 0.55, 0.32, 0.91 ];\n    var names = [ \"Ernie\", \"Bert\", \"Oscar\" ];\n    \n    percentages[1]  //Returns 0.32\n    names[1]        //Returns \"Bert\"\n\nAlthough I don’t recommend it, different types of values can even be stored\nwithin the same array:\n\n    \n    \n    var mishmash = [ 1, 2, 3, 4.5, 5.6, \"oh boy\", \"say it isn't\", true ];\n\n### Objects\n\nArrays are great for simple lists of values, but with more complex datasets,\nyou’ll want to put your data into an object. For our purposes, think of a\nJavaScript object as a custom data structure. We use curly brackets `{}` to\nindicate an object. In between the brackets, we include _properties_ and\n_values_. A colon `:` separates each property and its value, and a comma\nseparates each property/value pair:\n\n    \n    \n    var fruit = {\n        kind: \"grape\",\n        color: \"red\",\n        quantity: 12,\n        tasty: true\n    };\n\nTo reference each value, we use _dot notation_ , specifying the name of the\nproperty:\n\n    \n    \n    fruit.kind      //Returns \"grape\"\n    fruit.color     //Returns \"red\"\n    fruit.quantity  //Returns 12\n    fruit.tasty     //Returns true\n\nThink of the value as “belonging” to the object. Oh, look, some fruit. “What\nkind of fruit is that?” you might ask. As it turns out, `fruit.kind` is\n`\"grape\"`. “Are they tasty?” Oh, definitely, because `fruit.tasty` is `true`.\n\n### Objects and Arrays\n\nYou can combine these two structures to create arrays of objects, or objects\nof arrays, or objects of objects or, well, basically whatever structure makes\nsense for your dataset.\n\nLet’s say we have acquired a couple more pieces of fruit, and we want to\nexpand our catalog accordingly. We use hard brackets `[]` on the outside, to\nindicate an array, followed by curly brackets `{}` and object notation on the\ninside, with each object separated by a comma:\n\n    \n    \n    var fruits = [\n        {\n            kind: \"grape\",\n            color: \"red\",\n            quantity: 12,\n            tasty: true\n        },\n        {\n            kind: \"kiwi\",\n            color: \"brown\",\n            quantity: 98,\n            tasty: true\n        },\n        {\n            kind: \"banana\",\n            color: \"yellow\",\n            quantity: 0,\n            tasty: true\n        }\n    ];\n\nTo access this data, we just follow the trail of properties down to the values\nwe want. Remember, `[]` means array, and `{}` means object. `fruits` is an\narray, so first we use bracket notation to specify an array index:\n\n    \n    \n    fruits[1]\n\nNext, each array element is an object, so just tack on a dot and a property:\n\n    \n    \n    fruits[1].quantity   //Returns 98\n\nHere’s a map of how to access every value in the `fruits` array of objects:\n\n    \n    \n    fruits[0].kind      ==  \"grape\"\n    fruits[0].color     ==  \"red\"\n    fruits[0].quantity  ==  12\n    fruits[0].tasty     ==  true\n    \n    fruits[1].kind      ==  \"kiwi\"\n    fruits[1].color     ==  \"brown\"\n    fruits[1].quantity  ==  98\n    fruits[1].tasty     ==  true\n    \n    fruits[2].kind      ==  \"banana\"\n    fruits[2].color     ==  \"yellow\"\n    fruits[2].quantity  ==  0\n    fruits[2].tasty     ==  true\n\nYes, that’s right, we have `fruits[2].quantity` bananas.\n\n#### JSON\n\nAt some point in your D3 career, you will encounter JavaScript Object\nNotation. You can [read up on the details](http://en.wikipedia.org/wiki/Json),\nbut JSON is basically a specific syntax for organizing data as JavaScript\nobjects. The syntax is optimized for use with JavaScript (obviously) and AJAX\nrequests, which is why you’ll see a lot of web-based application programming\ninterfaces (APIs) that return data formatted as JSON. It’s faster and easier\nto parse with JavaScript than XML, and of course D3 works well with it.\n\nAll that, and it doesn’t look much weirder than what we’ve already seen:\n\n    \n    \n    {\n        \"kind\": \"grape\",\n        \"color\": \"red\",\n        \"quantity\": 12,\n        \"tasty\": true\n    }\n\nThe only difference here is that our property names are now surrounded by\ndouble quotation marks `\"\"`, making them string values.\n\nJSON objects, like all other JavaScript objects, can of course be stored in\nvariables like so:\n\n    \n    \n    var jsonFruit = {\n        \"kind\": \"grape\",\n        \"color\": \"red\",\n        \"quantity\": 12,\n        \"tasty\": true\n    };\n\n#### GeoJSON\n\nJust as JSON is just a formalization of existing JavaScript object syntax,\nGeoJSON is a formalized syntax of JSON objects, optimized for storing geodata.\nAll GeoJSON object are JSON objects, and all JSON objects are JavaScript\nobjects.\n\n[GeoJSON](http://geojson.org/geojson-spec.html) can store points in\ngeographical space (typically as longitude/latitude coordinates), but also\nshapes (such as lines and polygons) and other spatial features. If you have a\nlot of geodata, it’s worth it to parse it into GeoJSON format for best use\nwith D3.\n\nWe’ll get into the details of GeoJSON when we talk about geomaps, but for now,\njust know that this is what simple GeoJSON data could look like the following:\n\n    \n    \n    {\n        \"type\": \"FeatureCollection\",\n        \"features\": [\n            {\n                \"type\": \"Feature\",\n                \"geometry\": {\n                    \"type\": \"Point\",\n                    \"coordinates\": [ 150.1282427, -24.471803 ]\n                },\n                \"properties\": {\n                    \"type\": \"town\"\n                }\n            }\n        ]\n    }\n\nConfusingly, longitude is always listed before latitude. Get used to thinking\nin terms of lon/lat instead of lat/lon.\n\n### Mathematical Operators\n\nYou can add, subtract, multiply, and divide values using the following\noperators, respectively:\n\n    \n    \n    +   //Add\n    -   //Subtract\n    *   //Multiply\n    /   //Divide\n\nFor example, type `8 * 2` into the console, press Enter, and you should see\n`16`. More examples:\n\n    \n    \n    1 + 2       //Returns 3\n    10 - 0.5    //Retuns 9.5\n    33 * 3      //Returns 99\n    3 / 4       //Returns 0.75\n\n### Comparison Operators\n\nYou can compare values against each other using the following operators:\n\n    \n    \n    ==  //Equal to\n    !=  //Not equal to\n    <   //Less than\n    >   //Greater than\n    <=  //Less than or equal to\n    >=  //Greater than or equal to\n\nThese all compare some value on the left to some value on the right. If the\nresult is true, then `true` is returned. If the result is false, `false` is\nreturned.\n\nTry it! Type each of the following into the console and see what you get:\n\n    \n    \n    3 == 3\n    3 == 5\n    3 >= 3\n    3 >= 2\n    100 < 2\n    298 != 298\n\n(JavaScript also offers the `===` and `!==` operators, which perform equality\ncomparisons without type coercion, but I won’t be addressing that distinction\nin this book.)\n\n### Control Structures\n\nWhenever your code needs to make a decision or repeat something, you need a\ncontrol structure. There are lots to choose from, but we are primarily\ninterested in `if` statements and `for` loops.\n\n#### if() only\n\nAn `if` statement uses comparison operators to determine if a statement is\ntrue or false:\n\n    \n    \n    if (test) {\n        //Code to run if true\n    }\n\nIf the test between parentheses is `true`, then the code between the curly\nbrackets is run. If the test turns up `false`, then the bracketed code is\nignored, and life goes on. (Technically, life goes on either way.)\n\n    \n    \n    if (3 < 5) {\n        console.log(\"Eureka! Three is less than five!\");\n    }\n\nIn the preceding example, the bracketed code will always be executed, because\n`3 < 5` is always true. `if` statements are more useful when comparing\nvariables or other conditions that change.\n\n    \n    \n    if (someValue < anotherValue) {\n        //Set someValue to anotherValue, thereby restoring\n        //a sense of balance and equilibrium to the world.\n        someValue = anotherValue;\n    }\n\n#### for() now\n\nYou can use `for` loops to repeatedly execute the same code, with slight\nvariations. A `for` loop uses this syntax:\n\n    \n    \n    for (initialization; test; update) {\n        //Code to run each time through the loop\n    }\n\nThey are so-called because they loop through the code _for_ as many times as\nspecified. First, the initialization statement is run. Then, the test is\nevaluated, like a mini `if` statement. If the test is true, then the bracketed\ncode is run. Finally, the `update` statement is run, and the test is\nreevaluated.\n\nThe most common application of a `for` loop is to increase some variable by 1\neach time through the loop. The test statement can then control how many times\nthe loop is run by referencing that value. (The variable is often named `i`,\npurely by convention, because it is short and easy to type.)\n\n    \n    \n    for (var i = 0; i < 5; i++) {\n        console.log(i);  //Prints value to console\n    }\n\nThe preceding `for` loop prints the following to the console:\n\n    \n    \n    0\n    1\n    2\n    3\n    4\n\nThe first time through, a variable named `i` is declared and set to zero. `i`\nis less than five, so the bracketed code is run, printing the current value of\n`i` (zero) to the console. Finally, the value of `i` is increased by one.\n(`i++` is shorthand for `i = i + 1`.) So now `i` is `1`, so the test again\nevaluates as true, the bracketed code is run again, but this time the value\nprinted to the console is 1.\n\nAs you can see, reading prose descriptions of loops is about as interesting as\nexecuting them by hand yourself. This is why we invented computers. So I’ll\nskip to the end and point out that after the final iteration, `i` is increased\nto 5, after which the test returns false, and the loop is over.\n\nIt’s important to note that counting began at zero, and not one. That is, the\n“first” value of `i` was `0`. Why not `1`? This is another arbitrary\nconvention, but it nicely parallels how computers count arrays of values.\n\n#### What arrays are made for()\n\nCode-based data visualization would not be possible without arrays and the\nmighty `for()` loop. Together, they form a data geek’s dynamic duo. (If you do\nnot consider yourself a “data geek,” then may I remind you that you are\nreading a book titled _Interactive Data Visualization for the Web_?)\n\nAn array organizes lots of data values in one convenient place. Then `for()`\ncan quickly “loop” through every value in an array and perform some action\nwith it — such as, express the value as a visual form. D3 often manages this\nlooping for us, such as with its magical `data()` method.\n\nNote this example, which loops through each of the values in an array called\n`numbers`:\n\n    \n    \n    var numbers = [ 8, 100, 22, 98, 99, 45 ];\n    \n    for (var i = 0; i < numbers.length; i++) {\n        console.log(numbers[i]);  //Print value to console\n    }\n\nSee that `numbers.length`? That’s the beautiful part. `length` is a property\nof every array. In this case, `numbers` contains six values, so\n`numbers.length` resolves to `6`, and the loop runs six times. If `numbers`\nwere 10 positions long, the loop would run 10 times. If it were 10 million\npositions long … yeah, you get it. This is what computers are good at: taking\na set of instructions and executing them over and over. And this is at the\nheart of why data visualization can be so rewarding — you design and code the\nvisualization system, and the system will respond appropriately, even as you\nfeed it different data. The system’s mapping rules are consistent, even when\nthe data is not.\n\n### Functions\n\nFunctions are chunks of code that do things.\n\nMore specifically, functions are special because they can take arguments or\nparameters as input, and then return values as output. Parentheses are used to\n_call_ (execute) a function. If that function requires any arguments (input\nvalues), then they are _passed_ to the function by including them in the\nparentheses.\n\nWhenever you see something like the following code, you know it’s a function:\n\n    \n    \n    calculateGratuity(38);\n\nIn fact, you’ve already seen functions at work with `console.log`, as in the\nfollowing:\n\n    \n    \n    console.log(\"Look at me. I can do stuff!\");\n\nBut the best part about functions is that you can define your own. There are\nseveral ways to define functions in JavaScript, but here’s the simplest, which\nI’ll use throughout this book:\n\n    \n    \n    var calculateGratuity = function(bill) {\n        return bill * 0.2;\n    };\n\nThis declares a new variable named `calculateGratuity`. Then, instead of\nassigning a simple number or string, we store an entire function in the\nvariable. In the parentheses, we name `bill`, another variable to be used only\nby the function itself. `bill` is the expected input. When called, the\nfunction will take that input, multiply it by `0.2`, and _return_ the result\nas its output.\n\nSo now if we call:\n\n    \n    \n    calculateGratuity(38);\n\nthe function returns 7.6. Not bad — a 20 percent tip!\n\nOf course, you could store the output to use it elsewhere later, as in:\n\n    \n    \n    var tip = calculateGratuity(38);\n    console.log(tip);  //Prints 7.6 to the console\n\nThere are also _anonymous_ functions that, unlike `calculateGratuity`, don’t\nhave names. Anonymous functions are used all the time with D3, but I’ll\nintroduce them later.\n\n### Comments\n\n    \n    \n    /* JavaScript supports CSS-style comments like this. */\n    \n    // But double-slashes can be used as well.\n    // Anything following // on the same line will be ignored.\n    // This is helpful for including brief notes to yourself\n    // as to what each line of code does, as in:\n    \n    console.log(\"Brilliant\");  //Prints \"Brilliant\" to the console\n\n### Referencing Scripts\n\nScripts can be included directly in HTML, between two `script` tags, as in:\n\n    \n    \n    <body>\n        <script type=\"text/javascript\">\n            alert(\"Hello, world!\");\n        </script>\n    </body>\n\nor stored in a separate file with a _.js_ suffix, and then referenced\nsomewhere in the HTML (could be in the `head`, as shown here, or also just\nbefore the end of the closing `body` tag):\n\n    \n    \n    <head>\n        <title>Page Title</title>\n        <script type=\"text/javascript\" src=\"myscript.js\"></script>\n    </head>\n\n### JavaScript Gotchas\n\nAs a bonus, and at no extra charge, I would like to share with you my top four\nJavaScript gotchas: things that, had I known earlier, would have saved me many\nhours of late-night debugging sessions, anxiety-induced panic, and increased\ncortisol levels. You might want to come back and reference this section later.\n\n#### Dynamic typing\n\nI do love how your fingers flutter across the keyboard, but that’s not what\nI’m talking about. No, JavaScript is a _loosely typed_ language, meaning you\ndon’t have to specify what _type_ of information will be stored in a variable\nin advance. Many other languages, like Java (which is completely different\nfrom Java _Script_), require you to declare a variable’s type, such as `int`,\n`float`, `boolean`, or `String`:\n\n    \n    \n    //Declaring variables in Java\n    int number = 5;\n    float value = 12.3467;\n    boolean active = true;\n    String text = \"Crystal clear\";\n\nJavaScript, however, automatically _types_ a variable based on what kind of\ninformation you assign to it. (Note that `''` or `\"\"` indicate string values.\nI prefer double quotation marks `\"\"`, but some people like singles `''`.)\n\n    \n    \n    //Declaring variables in JavaScript\n    var number = 5;\n    var value = 12.3467;\n    var active = true;\n    var text = \"Crystal clear\";\n\nHow boring — `var`, `var`, `var`, `var`! — yet handy, as we can declare and\nname variables before we even know what type of data will go into them. You\ncan even change a variable’s type on-the-fly without JavaScript freaking out\non you:\n\n    \n    \n    var value = 100;\n    value = 99.9999;\n    value = false;\n    value = \"This can't possibly work.\";\n    value = \"Argh, it does work! No errorzzzz!\";\n\nI mention this because one day a numeric value will be accidentally stored as\na string, and it will cause some part of your code to behave strangely, and\nbasically I don’t want you to come crying to me when that happens. Thus, know\nthat whenever a variable’s type is in doubt, you can employ the `typeof`\noperator:\n\n    \n    \n    typeof 67;              //Returns \"number\"\n    var myName = \"Scott\";\n    typeof myName;          //Returns \"string\"\n    myName = true;\n    typeof myName;          //Returns \"boolean\"\n\n#### Variable hoisting\n\nContrary to what you would expect, JavaScript code is usually, but not always,\nexecuted in linear, top-to-bottom order. For example, in this code, when would\nyou expect the variable `i` to be established?\n\n    \n    \n    var numLoops = 100;\n    for (var i = 0; i < numLoops; i++) {\n        console.log(i);\n    }\n\nIn many other languages, `i` would be declared right when the `for` loop\nbegins, as you’d expect. But thanks to a phenomenon known as _variable\nhoisting_ , in JavaScript, variable declarations are _hoisted_ up to the top\nof the function context in which they reside. So in our example, `i` is\nactually declared _before_ the `for` loop even begins. The following is\nequivalent:\n\n    \n    \n    var numLoops = 100;\n    var i;\n    for (i = 0; i < numLoops; i++) {\n        console.log(i);\n    }\n\nThis can be problematic when you have conflicting variable names, as a\nvariable that you thought existed only later in the code is actually present\nright at the beginning.\n\n#### Function-level scope\n\nIn programming, the concept of _variable scope_ helps us identify which\nvariables are accessible in which contexts. Generally, it is a bad idea to\nhave every value accessible from everywhere else because you’d end up with so\nmany conflicts and accidental value changes that you would just go crazy.\n\nMany languages use _block-level scope_ , in which variables exist only within\nthe current “block” of code, usually indicated by curly braces. With block-\nlevel scope, our `i` would exist only within the context of the `for` loop,\nfor example, so any attempts to read the value of `i` or change `i` outside of\nthe loop would fail. This is nice because you could establish other variables\nfrom within your loop and know that they wouldn’t conflict with variables that\nexist elsewhere.\n\nIn JavaScript, however, variables are scoped at the function level, meaning\nthey are accessible anywhere within the _function_ (not block) in which they\nreside.\n\nThis is primarily something to be aware of if you’re used to other languages.\nBottom line: You can keep values contained by wrapping them within functions.\n\n#### Global namespace\n\nSpeaking of variable conflicts, please do me a favor: open any web page,\nactivate the JavaScript console, type **`window`** , and click the gray\ndisclosure triangle to view its contents.\n\nI know it feels like you just entered the matrix, but this is actually called\n“the global namespace,” which might sound even cooler (see [Figure\n3-10](part0007_split_007.html#The_global_namespace)).\n\n![The global namespace](../images/00013.jpeg)\n\nFigure 3-10. The global namespace\n\n`window` is the topmost object in the browser’s hierarchy of JavaScript\nelements, and all of these objects and values you see beneath `window` exist\nat the _global_ level. What this means is that every time you declare a new\nvariable, you are adding a new value to `window`. Or, as righteous JavaScript\ncoders like to say, you are polluting the global namespace. (Surprisingly,\nmost people who write things like this in online forums are actually quite\nfriendly in person.)\n\nFor example, try typing this into the console: **`var zebras = \"amazing\"`**.\n\nThen type **`window`** again, and scroll all the way down to the bottom, where\nyou should now see `zebras`, as shown in [Figure\n3-11](part0007_split_007.html#The_global_namespace_now_with_zebras).\n\n![The global namespace, now with zebras](../images/00014.jpeg)\n\nFigure 3-11. The global namespace, now with zebras\n\n(Confusingly, it is also possible to define new variables in JavaScript\nwithout using the standard `var` declaration, so typing simply **`zebras =\n\"amazing\"`** would have the same effect as that shown.)\n\nWhat’s so wrong with adding values to `window`? As you get started, nothing at\nall. But as your projects grow in complexity, and especially if you begin to\nincorporate other non-D3 JavaScript code (such as jQuery, Facebook “Like”\nbuttons, or Google Analytics tracking code), at some point you’re bound to run\ninto a conflict because you’re using the variable `zebras` for your project,\nbut zebraTracker.js is _also_ using a variable with the same name! The result:\nchaos. Or at least some bad data, which could lead to unexpected behavior or\nerrors.\n\nThere are two easy workarounds (and, to clarify, you probably don’t have to\nworry about this until later):\n\n  * Declare variables only within other functions. This is not usually feasible, but the function-level scope will prevent local variables from conflicting with others. \n  * Declare a single global object, and attach all of your would-be global variables to that object. For example: \n\n    \n    \n    var Vis = {};  //Declare empty global object\n    Vis.zebras = \"still pretty amazing\";\n    Vis.monkeys = \"too funny LOL\";\n    Vis.fish = \"you know, not bad\";\n\nAll of your weird animal-related variables are no longer polluting the global\nnamespace, but instead they all exist as values stored within your single,\nglobal object, `Vis`. Of course, `Vis` could be named whatever you like, but\n`Menagerie` is harder to type. Regardless, the only naming conflict you’ll\nhave with other scripts is if one of them _also_ wants to have a global object\nwith the same name (`Vis`), which is far less likely.\n\n\n## SVG\n\nD3 is most useful when used to generate and manipulate visuals as Scalable\nVector Graphics (SVG). Drawing with `div`s and other native HTML elements is\npossible, but a bit clunky and subject to the usual inconsistencies across\ndifferent browsers. Using SVG is more reliable, visually consistent, and\nfaster.\n\n[Figure 3-12](part0007_split_008.html#A_small_SVG_circle) shows a small\ncircle, and its SVG code follows.\n\n![A small SVG circle](../images/00015.gif)\n\nFigure 3-12. A small SVG circle\n\n    \n    \n    <svg width=\"50\" height=\"50\">\n        <circle cx=\"25\" cy=\"25\" r=\"22\" fill=\"blue\" stroke=\"gray\" stroke-width=\"2\"/>\n    </svg>\n\nVector drawing software like Illustrator can be used to generate SVG files,\nbut we need to learn how to generate them with code.\n\n### The SVG Element\n\nSVG is a text-based image format. Each SVG image is defined using markup code\nsimilar to HTML, and SVG code can be included directly within any HTML\ndocument, or inserted dynamically into the DOM. Every web browser supports SVG\n_except_ [Internet Explorer versions 8 and\nearlier](http://caniuse.com/#feat=svg). SVG is XML-based, so you’ll notice\nthat elements that don’t have a closing tag must be self-closing. For example:\n\n    \n    \n    <element></element> <!-- Uses closing tag -->\n    <element/>          <!-- Self-closing tag -->\n\nBefore you can draw anything, you must create an SVG element. Think of the SVG\nelement as a canvas on which your visuals are rendered. (In that respect, SVG\nis conceptually similar to HTML’s `canvas` element.) At a minimum, it’s good\nto specify `width` and `height` values. If you don’t specify these, the SVG\nwill behave like a typically greedy, block-level HTML element and take up as\nmuch room as it can within its enclosing element:\n\n    \n    \n    <svg width=\"500\" height=\"50\">\n    </svg>\n\nNote that _pixels_ are the default measurement units, so we can specify\ndimensions of `500` and `50`, not `500px` and `50px`. We could have specified\n`px` explicitly, or any number of other supported units, including `em`, `pt`,\n`in`, `cm`, and `mm`.\n\n### Simple Shapes\n\nThere are a number of visual elements that you can include between those `svg`\ntags, including `rect`, `circle`, `ellipse`, `line`, `text`, and `path`.\n(Sorry, `zebras` is not valid in this context.)\n\nIf you’re familiar with computer graphics programming, you’ll recognize the\nusual pixel-based coordinates system in which `0,0` is the top-left corner of\nthe drawing space. Increasing `x` values move to the right, while increasing\n`y` values move down (see [Figure\n3-13](part0007_split_008.html#The_SVG_coordinates_system)).\n\n![The SVG coordinates system](../images/00016.jpeg)\n\nFigure 3-13. The SVG coordinates system\n\n`rect` draws a rectangle. Use `x` and `y` to specify the coordinates of the\nupper-left corner, and `width` and `height` to specify the dimensions. This\nrectangle fills the entire space of our SVG, as shown in [Figure\n3-14](part0007_split_008.html#An_SVG_rect):\n\n    \n    \n    <rect x=\"0\" y=\"0\" width=\"500\" height=\"50\"/>\n\n![An SVG rect](../images/00017.gif)\n\nFigure 3-14. An SVG rect\n\n`circle` draws a circle. Use `cx` and `cy` to specify the coordinates of the\n_center_ , and `r` to specify the radius. This circle is centered in the\nmiddle of our 500-pixel-wide SVG because its `cx` (“center-x”) value is 250\n(see [Figure 3-15](part0007_split_008.html#An_SVG_circle)):\n\n    \n    \n    <circle cx=\"250\" cy=\"25\" r=\"25\"/>\n\n![An SVG circle](../images/00018.gif)\n\nFigure 3-15. An SVG circle\n\n`ellipse` is similar, but expects separate radius values for each axis.\nInstead of `r`, use `rx` and `ry` to obtain the result shown in [Figure\n3-16](part0007_split_008.html#An_SVG_ellipse):\n\n    \n    \n    <ellipse cx=\"250\" cy=\"25\" rx=\"100\" ry=\"25\"/>\n\n![An SVG ellipse](../images/00019.gif)\n\nFigure 3-16. An SVG ellipse\n\n`line` draws a line, as shown in [Figure\n3-17](part0007_split_008.html#An_SVG_line). Use `x1` and `y1` to specify the\ncoordinates of one end of the line, and `x2` and `y2` to specify the\ncoordinates of the other end. A `stroke` color must be specified for the line\nto be visible:\n\n    \n    \n    <line x1=\"0\" y1=\"0\" x2=\"500\" y2=\"50\" stroke=\"black\"/>\n\n![An SVG line](../images/00020.gif)\n\nFigure 3-17. An SVG line\n\n`text` renders text. Use `x` to specify the position of the left edge, and `y`\nto specify the vertical position of the type’s _baseline_. (Baseline is a\ntypographical term for the invisible line on which the letters appear to rest.\nPortions of letters such as “p” and “y” that extend below the baseline are\ncalled descenders.) The result of the following code is displayed in [Figure\n3-18](part0007_split_008.html#SVG_text):\n\n    \n    \n    <text x=\"250\" y=\"25\">Easy-peasy</text>\n\n![SVG text](../images/00021.gif)\n\nFigure 3-18. SVG text\n\n`text` will inherit the CSS-specified font styles of its parent element unless\nspecified otherwise. (More on styling text in a moment.) We could override\nthat formatting as follows and obtain the result shown in [Figure\n3-19](part0007_split_008.html#More_SVG_text):\n\n    \n    \n    <text x=\"250\" y=\"25\" font-family=\"serif\" font-size=\"25\"\n     fill=\"gray\">Easy-peasy</text>\n\n![More SVG text](../images/00022.gif)\n\nFigure 3-19. More SVG text\n\nAlso note that when any visual element runs up against the edge of the SVG, it\nwill be clipped. Be careful when using `text` so your descenders don’t get cut\noff (ouch!). You can see this happen in [Figure\n3-20](part0007_split_008.html#Even_More_SVG_text) when we set the baseline\n(`y`) to 50, the same as the height of our SVG:\n\n    \n    \n    <text x=\"250\" y=\"50\" font-family=\"serif\" font-size=\"25\"\n     fill=\"gray\">Easy-peasy</text>\n\n![More SVG text](../images/00023.gif)\n\nFigure 3-20. More SVG text\n\n`path` is for drawing anything more complex than the preceding shapes (like\ncountry outlines for geomaps), and will be explained separately. For now,\nwe’ll work with simple shapes.\n\n### Styling SVG Elements\n\nSVG’s default style is a black fill with no stroke. If you want anything else,\nyou’ll have to apply styles to your elements. Common SVG properties are as\nfollows:\n\n`fill`\n\n> A color value. Just as with CSS, colors can be specified as named colors,\n> hex values, or RGB or RGBA values.\n\n`stroke`\n\n> A color value.\n\n`stroke-width`\n\n> A numeric measurement (typically in pixels).\n\n`opacity`\n\n> A numeric value between 0.0 (completely transparent) and 1.0 (completely\n> opaque).\n\nWith `text`, you can also use these properties, which work just like in CSS:\n\n  * `font-family`\n  * `font-size`\n\nIn another parallel to CSS, there are two ways to apply styles to an SVG\nelement: either directly (inline) as an attribute of the element, or with a\nCSS style rule.\n\nHere are some style properties applied directly to a `circle` as attributes,\nwith the result shown in [Figure\n3-21](part0007_split_008.html#An_SVG_circle2):\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"22\"\n     fill=\"yellow\" stroke=\"orange\" stroke-width=\"5\"/>\n\n![An SVG circle](../images/00024.gif)\n\nFigure 3-21. An SVG circle\n\nAlternatively, we could strip the style attributes and assign the `circle` a\nclass (just as if it were a normal HTML element):\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"22\" class=\"pumpkin\"/>\n\nand then put the `fill`, `stroke`, and `stroke-width` rules into a CSS style\nthat targets the new class:\n\n    \n    \n    .pumpkin {\n        fill: yellow;\n        stroke: orange;\n        stroke-width: 5;\n     }\n\nThe CSS approach has a few obvious benefits:\n\n  * You can specify a style once and have it applied to multiple elements. \n  * CSS code is easier to read than inline attributes. \n  * For those reasons, the CSS approach might be more maintainable and make design changes faster to implement. \n\nUsing CSS to apply SVG styles, however, can be disconcerting for some. `fill`,\n`stroke`, and `stroke-width`, after all, are _not_ CSS properties. (The\nnearest CSS equivalents are `background-color` and `border`.) It’s just that\nwe are using CSS selectors to apply SVG-specific properties. If it helps you\nremember which rules in your stylesheet are SVG-specific, consider including\n`svg` in those selectors:\n\n    \n    \n    svg .pumpkin {\n        /* ... */\n     }\n\n### Layering and Drawing Order\n\nThere are no “layers” in SVG and no real concept of depth. SVG does not\nsupport CSS’s `z-index` property, so shapes can be arranged only within the\ntwo-dimensional x/y plane.\n\nAnd yet, if we draw multiple shapes, they overlap:\n\n    \n    \n    <rect x=\"0\" y=\"0\" width=\"30\" height=\"30\" fill=\"purple\"/>\n    <rect x=\"20\" y=\"5\" width=\"30\" height=\"30\" fill=\"blue\"/>\n    <rect x=\"40\" y=\"10\" width=\"30\" height=\"30\" fill=\"green\"/>\n    <rect x=\"60\" y=\"15\" width=\"30\" height=\"30\" fill=\"yellow\"/>\n    <rect x=\"80\" y=\"20\" width=\"30\" height=\"30\" fill=\"red\"/>\n\nThe order in which elements are coded determines their depth order. In [Figure\n3-22](part0007_split_008.html#Overlapping_SVG_elements), the purple square\nappears first in the code, so it is rendered first. Then, the blue square is\nrendered “on top” of the purple one, then the green square on top of that, and\nso on.\n\n![Overlapping SVG elements](../images/00025.gif)\n\nFigure 3-22. Overlapping SVG elements\n\nThink of SVG shapes as being rendered like paint on a canvas. The pixel-paint\nthat is applied later obscures any earlier paint, and thus appears to be “in\nfront.”\n\nThis aspect of drawing order becomes important when you have some visual\nelements that should not be obscured by others. For example, you might have\naxes or value labels that appear on a scatterplot. The axes and labels should\nbe added to the SVG last, so they appear in front of any other elements.\n\n### Transparency\n\nTransparency can be useful when elements in your visualization overlap but\nmust remain visible, or you want to deemphasize some elements while\nhighlighting others, as shown in [Figure\n3-23](part0007_split_008.html#RGBA_SVG_shapes).\n\nThere are two ways to apply transparency: use an RGB color with alpha, or set\nan `opacity` value.\n\nYou can use `rgba()` anywhere you specify a color, such as with `fill` or\n`stroke`. `rgba()` expects three values between 0 and 255 for red, green, and\nblue, plus an alpha (transparency) value between 0.0 and 1.0:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 1.0)\"/>\n    <circle cx=\"50\" cy=\"25\" r=\"20\" fill=\"rgba(0, 0, 255, 0.75)\"/>\n    <circle cx=\"75\" cy=\"25\" r=\"20\" fill=\"rgba(0, 255, 0, 0.5)\"/>\n    <circle cx=\"100\" cy=\"25\" r=\"20\" fill=\"rgba(255, 255, 0, 0.25)\"/>\n    <circle cx=\"125\" cy=\"25\" r=\"20\" fill=\"rgba(255, 0, 0, 0.1)\"/>\n\n![RGBA SVG shapes](../images/00026.jpeg)\n\nFigure 3-23. RGBA SVG shapes\n\nNote that with `rgba()`, transparency is applied to the `fill` and `stroke`\ncolors independently. The following circles’ `fill` is 75 percent opaque, and\ntheir `stroke`s are only 25 percent opaque:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\"/>\n    <circle cx=\"75\" cy=\"25\" r=\"20\" fill=\"rgba(0, 255, 0, 0.75)\"\n            stroke=\"rgba(0, 0, 255, 0.25)\" stroke-width=\"10\"/>\n    <circle cx=\"125\" cy=\"25\" r=\"20\" fill=\"rgba(255, 255, 0, 0.75)\"\n            stroke=\"rgba(255, 0, 0, 0.25)\" stroke-width=\"10\"/>\n\nWith this transparency applied, and the result shown in [Figure\n3-24](part0007_split_008.html#More_RGBA_SVG_shapes), we can see that strokes\nare aligned to the center of each shape’s edge. That is, the stroke is neither\nfully inside nor outside the object, but is both half in and half out. As a\nresult of this transparency, these individual `10px` strokes look more like\ntwo separate `5px` strokes.\n\n![More RGBA SVG shapes](../images/00027.jpeg)\n\nFigure 3-24. More RGBA SVG shapes\n\nTo apply transparency to an entire element, set an `opacity` attribute.\n[Figure 3-25](part0007_split_008.html#Opaque_circles) illustrates some\ncompletely opaque circles.\n\n![Opaque circles](../images/00028.gif)\n\nFigure 3-25. Opaque circles\n\n[Figure 3-26](part0007_split_008.html#Semiopaque_circles) shows the same\ncircles, with `opacity` values:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"purple\" stroke=\"green\" stroke-width=\"10\"\n            opacity=\"0.9\"/>\n    <circle cx=\"65\" cy=\"25\" r=\"20\" fill=\"green\" stroke=\"blue\" stroke-width=\"10\"\n            opacity=\"0.5\"/>\n    <circle cx=\"105\" cy=\"25\" r=\"20\" fill=\"yellow\" stroke=\"red\" stroke-width=\"10\"\n            opacity=\"0.1\"/>\n\n![Semiopaque circles](../images/00029.jpeg)\n\nFigure 3-26. Semiopaque circles\n\nYou can employ `opacity` on an element that also has colors set with `rgba()`.\nWhen doing so, the transparencies are multiplied. The circles in [Figure\n3-27](part0007_split_008.html#More_opaque_circles) use the same RGBA values\nfor `fill` and `stroke`. The first circle has no element `opacity` set, but\nthe other two do:\n\n    \n    \n    <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\"/>\n    <circle cx=\"65\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\" opacity=\"0.5\"/>\n    <circle cx=\"105\" cy=\"25\" r=\"20\" fill=\"rgba(128, 0, 128, 0.75)\"\n            stroke=\"rgba(0, 255, 0, 0.25)\" stroke-width=\"10\" opacity=\"0.2\"/>\n\n![More opaque circles](../images/00030.jpeg)\n\nFigure 3-27. More opaque circles\n\nNotice how the third circle’s `opacity` is `0.2`, or 20 percent. Yet its\npurple fill already has an alpha value of `0.75`, or 75 percent. The purple\narea, then, has a final transparency of 0.2 times 0.75 = 0.15, or 15 percent.\n\n\n## A Note on Compatibility\n\nOlder browsers don’t support SVG. So, generally speaking, Internet Explorer\nversion 8 and older will not display SVG images at all. This is a little\nannoying because people could visit your page only to see emptiness in place\nof a gorgeous visualization. On the other hand, D3 also does not work with\nolder browsers (again, meaning IE8 and older), so it never would have worked\nin the first place.\n\n* * *\n\n### Note\n\nD3 _can_ be made to work with IE8 by employing the\n[Aight](https://github.com/shawnbot/aight) compatibility library, but that\ndoesn’t help with older versions of IE.\n[r2d3](https://github.com/mhemesath/r2d3/) is an adaptation of D3 that\nintegrates [Raphaël](http://raphaeljs.com) for drawing visuals, which should\nget you as far back as IE7.\n\n* * *\n\nIn general, your best bet is to encourage people to upgrade and use a web\nbrowser that has been built in the last few years. The more people move to\nmodern browsers, the better their web experiences will be, and the larger our\npotential audiences.\n\nThat said, it’s polite to notify users of older browsers why the piece isn’t\nworking. I recommend using [Modernizr](http://modernizr.com) or a similar\nJavaScript tool to detect whether or not the browser supports SVG. If it does,\nthen you can load your D3 code and proceed as normal. If SVG is _not_\nsupported, then you can display a static, noninteractive version of your\nvisualization alongside a message explaining that a current browser is needed.\n(Be nice and provide links to the [Chrome](http://www.google.com/chrome) and\n[Firefox](http://www.mozilla.org/en-US/firefox/new/) download pages. I used to\nlink to [Safari](http://www.apple.com/safari/) as well, but Apple now\ndistributes it as part of the Mac OS, so it’s no longer available as a\nseparate download.)\n\nFor example, you can use `Modernizr.load()` to check the results of\nModernizr’s tests. Then, if the tests pass (for example, because SVG support\n_is_ detected), then tell Modernizr to go ahead and load D3 and your custom\nJavaScript code. I’d typically have something like this in the `<head>` of my\ndocument:\n\n    \n    \n    <script src=\"js/modernizr.js\"></script>\n    \n    <script type=\"text/javascript\">\n            Modernizr.load({\n                    test: Modernizr.svg && Modernizr.inlinesvg,\n                    yep : [ 'js/d3.v3.min.js',\n                            'js/script.js' ]\n            });\n    </script>\n\nThis loads Modernizr in, performs the tests, and then bothers loading the\nother code only if the tests succeed. (That’s the “`yep`” part.) You can use\nCSS or more JavaScript to define what shows up to the user when the test\n_fails_ , such as a static image of your visualization or a message\nencouraging the user to try a newer browser. Learn more about how to do this\nin the [Modernizr documentation](http://modernizr.com/docs/#load).\n\n_caniuse.com_ is a fantastic resource for supported browser features. See\ntheir list of [browsers with SVG support](http://caniuse.com/#search=svg).\n\nPeople have tried to get D3 working in older browsers, sometimes by mashing it\nup with Raphaël to render to canvas, or other hacky means. It is technically\npossible, but I don’t recommend it.\n\n\n## Chapter 4. Setup\n\nGetting set up with D3 is pretty straightforward — a simple matter of\ndownloading the latest version, creating an empty page in which to write your\ncode, and finally setting up a local web server.\n\n\n## Downloading D3\n\nStart by creating a new folder for your project. Call it whatever you like,\nbut maybe something like _project-folder_.\n\nWithin that folder, I recommend creating a subfolder called _d3_. Then\ndownload the latest version of D3 into that subfolder. [Download the latest\nversion of D3 as a ZIP file](http://d3js.org/d3.v3.zip), and then decompress\nthe ZIP file. As of this writing, the current version of D3 is 3.0.6.\n\nD3 is also provided in a “minified” version,\n[_d3.v3.min.js_](http://d3js.org/d3.v3.min.js), from which whitespace has been\nremoved for smaller file sizes and faster load times. The functionality is the\nsame, but typically you’d use the regular version while working on a project\n(for friendlier debugging), and then switch to the minified version once\nyou’ve launched the project publicly (for optimized load times). The choice is\nup to you, but in this book, I use the standard version.\n\nA third option is to download the entire D3 repository, which gives you not\njust the JavaScript files, but also all of the component source code. You can\n[browse the repository contents](https://github.com/mbostock/d3) first, or\njust [download the whole thing as a compressed ZIP\nfile](https://github.com/mbostock/d3/zipball/master). Of course, once you’ve\ndownloaded everything, make a copy of the file _d3.v3.js_ and move that into\n_project-folder/d3/_.\n\n\n## Referencing D3\n\nNow create a simple HTML page within your project folder named _index.html_.\nRemember, HTML documents are just plain text files, so you can use the text\neditor of your choice. Free editors like TextEdit and Notepad are fine, but\nyour life might be easier if you use an editor designed specifically for\nworking with code, like Coda, Espresso, or Sublime Text (among many, many\nothers).\n\nIf your editor gives you the option to set the file encoding, choose Unicode\n(UTF-8).\n\nYour folder structure should now look something like this:\n\n    \n    \n    project-folder/\n        d3/\n            d3.v3.js\n            d3.v3.min.js (optional)\n        index.html\n\nPaste the following into your new HTML file:\n\n    \n    \n    <!DOCTYPE html>\n    <html lang=\"en\">\n        <head>\n            <meta charset=\"utf-8\">\n            <title>D3 Page Template</title>\n            <script type=\"text/javascript\" src=\"d3/d3.v3.js\"></script>\n        </head>\n        <body>\n            <script type=\"text/javascript\">\n                // Your beautiful D3 code will go here\n            </script>\n        </body>\n    </html>\n\nOr, rather than go through all that manual labor, you could just download the\nsample code files (see [Chapter\n1](part0005_split_000.html#4OIQ2-8a8b0c18aaaf4f5c9d772f6d0c5087fc) for\ninstructions), and take a look at _01_empty_page_template.html_ , which\ncontains almost exactly the same code. (The `src` path to D3 is different in\nmy version.)\n\nHere are a few things to note about this template:\n\n  * The `meta` tag identifies the encoding for this file as `utf-8`, which is needed to ensure that the browser can parse D3’s functions and data properly. \n  * The first `script` tag sets the reference to _d3.v3.js_. You should edit this file path as needed if you’re using the minified version of D3 or decided to locate _d3.v3.js_ somewhere other than the _d3_ directory. \n  * The second `script` tag, in the `body`, is where you will soon key in all your beautiful code. And it will be beautiful. \n\nDone! Your D3 template files and folders are all set up. You might want to\nmake a copy of this template for each new project down the line.\n\n\n## Setting Up a Web Server\n\nIn some cases, you can view local HTML files directly in your web browser.\nHowever, some browsers have restrictions that prevent them from loading local\nfiles via JavaScript, for security reasons. That means if your D3 code is\ntrying to pull in any external datafiles (like CSVs or JSON), it will fail\nwith no good explanation. This isn’t D3’s fault; it’s a browser feature that\nprevents loading of scripts and other external files from third-party,\nuntrusted websites.\n\nFor this reason, it is much more reliable to load your page via a web server.\nAlthough you _could_ use a remote web server, it is much, much faster to store\nand host everything locally (meaning, on the same computer, the one right in\nfront of you). It is a strange idea, to use your local computer to host and\nserve files to itself, but you can think about it as the different programs\ntalking to each other: the browser program requests files from the server\nprogram, which responds by serving them back.\n\nThe good news is that it’s quite easy to get a local server up and running.\nHere are a couple of ways to do that.\n\n### Terminal with Python\n\nIf you’re using Mac OS X or Linux, then you already have Python installed. As\nlong as you’re comfortable entering commands in the terminal, then running a\nminiserver with Python is definitely the quickest option. (If you’re on\nWindows, you’ll need to install Python first.)\n\nTo use Python, you’ll need to open up a terminal window on your system. On a\nMac, open the Terminal application. You can find it in the Utilities folder,\nor by typing **`Terminal`** into Spotlight (the magnifying glass menu item in\nthe upper-right corner of your screen). Linux users are born knowing how to\nopen a terminal window, so I won’t waste your time explaining it here.\n\nTo run a Python web server:\n\n  1. Open up a new terminal window. \n  2. Via the command line, navigate into the directory that you want served. For example, if your project folder is in your Desktop folder on your Mac, you could type: **`cd ~/Desktop/project-folder`**. \n  3. Enter **`python -m SimpleHTTPServer 8888&`**. \n\n(This will work with Python version 2.x, but in Python versions 3.0 and newer,\n`SimpleHTTPServer` has been removed. For Python 3.x, just replace\n`SimpleHTTPServer` with `http.server` in the command.)\n\nThis will activate the server on port `8888`. Switch back to your web browser\nand visit the following URL: <http://localhost:8888/>. Yes, instead of\n_www.something.com_ , you just use _localhost_ , which tells the browser to\nrequest a page from _this machine_.\n\nYou should see the blank “D3 Page Template” page. Given that `body` of the\npage is empty, it won’t look like much. Select View source, and you should see\nthe contents of our HTML template page.\n\n### MAMP, WAMP, and LAMP\n\nThis option takes longer, but is best if you like dragging and dropping to\ninstall things, and want to avoid scary things like the terminal.\n\nAll of the AMPs in this section stand for Apache (the web server software),\nMySQL (popular database software), and PHP (a popular web scripting language).\nWe are really interested only in Apache, the web server, but it usually comes\nbundled with the other two, as they all work well together.\n\nOn a Mac, you can download and install [MAMP](http://mamp.info/en/) or [XAMPP\nfor Mac](http://bit.ly/W8RQa6).\n\nThe Windows equivalents are [WampServer](http://www.wampserver.com/en/) and\n[XAMPP for Windows](http://bit.ly/ZEGJq1).\n\nIf you use Linux, then all of this is probably already installed on your\nmachine, but you could still download [XAMPP for\nLinux](http://bit.ly/126txfk).\n\nInstallation for each of these packages varies somewhat, so follow the\ndocumentation carefully. (I’ve found MAMP to be the easiest to install.)\n\nEach package will designate one folder as the web server directory, so only\nthe files _within that folder_ will be served. You should find out what that\nfolder is, and move your D3 _project-folder_ into it.\n\nOnce the local server is up and running, you can view any pages within the\nserver directory by opening a browser (on the same computer, of course) and\npointing it to _localhost_ , as in the following: <http://localhost/>.\nDepending on your AMP configuration, you might need to append a port number to\nthe URL, as in the following: <http://localhost:8888/>.\n\nIf the server’s port number is `8888` and your project folder is called\n_project-folder_ , then you could view your D3 template page by going to\n<http://localhost:8888/project-folder/>.\n\n### Diving In\n\nAll set? Great! Let’s start working with data.\n\n\n## Chapter 5. Data\n\n_Data_ is an extremely broad term, only slightly less vague than the nearly\nall-encompassing _information_. What is data? (What _isn’t_ data?) What kinds\nof data are there, and what can we use with D3?\n\nBroadly speaking, data is structured information with potential for meaning.\n\nIn the context of programming for visualization, data is stored in a digital\nfile, typically in either text or binary form. Of course, potentially every\npiece of digital ephemera may be considered “data” — not just text, but bits\nand bytes representing images, audio, video, databases, streams, models,\narchives, and anything else.\n\nWithin the scope of D3 and browser-based visualization, however, we will limit\nourselves to _text-based data_. That is, anything that can be represented as\nnumbers and strings of alpha characters. If you can get your data into a\n_.txt_ plain text file, a _.csv_ comma-separated value file, or a _.json_ JSON\ndocument, then you can use it with D3.\n\nWhatever your data, it can’t be made useful and visual until it is _attached_\nto something. In D3 lingo, the data must be _bound_ to elements within the\npage. Let’s address how to create new page elements first. Then attaching data\nto those elements will be a cinch.\n\n\n## Generating Page Elements\n\nTypically, when using D3 to generate new DOM elements, the new elements will\nbe circles, rectangles, or other visual forms that represent your data. But to\navoid confusing matters, we’ll start with a simple example and create a lowly\n`p` paragraph element.\n\nBegin by creating a new document with our simple HTML template from the last\nchapter. You can find it in the sample code files as\n_01_empty_page_template.html_ , and it looks like the following code. (Eagle-\neyed viewers will notice that I’ve modified the `src` path here due to work\nwith the directory structure of the code samples. If that doesn’t mean\nanything to you, don’t worry about it.)\n\n    \n    \n    <!DOCTYPE html>\n    <html lang=\"en\">\n        <head>\n            <meta charset=\"utf-8\">\n            <title>D3 Page Template</title>\n            <script type=\"text/javascript\" src=\"../d3/d3.v3.js\"></script>\n        </head>\n        <body>\n            <script type=\"text/javascript\">\n                // Your beautiful D3 code will go here\n            </script>\n        </body>\n    </html>\n\nOpen that page in your web browser. Make sure you’re accessing the page via\nyour local web server, as we discussed in [Chapter\n4](part0008_split_000.html#setup-chapter4). So the URL in your browser’s\nlocation bar should look something like this:\n\n    \n    \n    http://localhost:8888/d3-book/chapter_05/01_empty_page_template.html\n\nIf not viewed through a web server, the URL path will start with _file:///_\ninstead of _http://_. Confirm that the URL does _not_ look like this:\n\n    \n    \n    file:///…/d3-book/chapter_05/01_empty_page_template.html\n\nOnce you’re viewing the page, pop open the web inspector. (As a reminder, see\n[Developer Tools](part0007_split_004.html#developer_tools_3) on how to do\nthat.) You should see an empty web page, with the DOM contents shown in\n[Figure 5-1](part0009_split_001.html#Web_inspector).\n\n![Web inspector](../images/00031.jpeg)\n\nFigure 5-1. Web inspector\n\nBack in your text editor, replace the comment between the `script` tags with:\n\n    \n    \n    d3.select(\"body\").append(\"p\").text(\"New paragraph!\");\n\nSave and refresh, and voilà! There is text in the formerly empty browser\nwindow, and the web inspector will look like [Figure\n5-2](part0009_split_001.html#Web_inspector_again).\n\n![Web inspector, again](../images/00032.jpeg)\n\nFigure 5-2. Web inspector, again\n\nSee the difference? Now in the DOM, there is a new paragraph element that was\ngenerated on the fly! This might not be exciting yet, but you will soon use a\nsimilar technique to dynamically generate tens or hundreds of elements, each\none corresponding to a piece of your dataset.\n\nLet’s walk through what just happened. (You can follow along with\n_02_new_element.html_.) To understand that first line of D3 code, you must\nfirst meet your new best friend, _chain syntax_.\n\n### Chaining Methods\n\nD3 smartly employs a technique called _chain syntax_ , which you might\nrecognize from jQuery. By “chaining” methods together with periods, you can\nperform several actions in a single line of code. It can be fast and easy, but\nit’s important to understand how it works, to save yourself hours of debugging\nheadaches later.\n\nBy the way, _functions_ and _methods_ are just two different words for the\nsame concept: a chunk of code that accepts an argument as input, performs some\naction, and returns some other information as output.\n\nThe following code:\n\n    \n    \n    d3.select(\"body\").append(\"p\").text(\"New paragraph!\");\n\nmight look like a big mess, especially if you’re new to programming. So the\nfirst thing to know is that JavaScript, like HTML, doesn’t care about\nwhitespace and line breaks, so you can put each method on its own line for\nlegibility:\n\n    \n    \n    d3.select(\"body\")\n        .append(\"p\")\n        .text(\"New paragraph!\");\n\nBoth I and your optometrist highly recommend putting each method on its own\nindented line. But programmers have their own coding style; use whatever\nindents, line breaks, and whitespace (tabs or spaces) are most legible for\nyou.\n\n### One Link at a Time\n\nLet’s deconstruct each line in this chain of code:\n\n`d3`\n\n> References the D3 object, so we can access its methods. Our D3 adventure\n> begins here.\n\n`.select(\"body\")`\n\n> Give the [`select()`](http://bit.ly/12h4SF1) method a CSS selector as input,\n> and it will return a reference to the first element in the DOM that matches.\n> (Use [`selectAll()`](http://bit.ly/WwINKs) when you need more than one\n> element.) In this case, we just want the `body` of the document, so a\n> reference to `body` is handed off to the next method in our chain.\n\n`.append(\"p\")`\n\n> [`append()`](https://github.com/mbostock/d3/wiki/Selections#wiki-append)\n> creates whatever new DOM element you specify and appends it to the end (but\n> _just inside_) of whatever selection it’s acting on. In our case, we want to\n> create a new `p` within the `body`. We specified `\"p\"` as the input\n> argument, but this method also sees the reference to `body` that was passed\n> down the chain from the `select()` method. So an empty `p` paragraph is\n> _appended_ to the `body`. Finally, `append()` hands off a reference to the\n> new element it just created.\n\n`.text(\"New paragraph!\")`\n\n> [`text()`](https://github.com/mbostock/d3/wiki/Selections#wiki-text) takes a\n> string and inserts it between the opening and closing tags of the current\n> selection. Because the previous method passed down a reference to our new\n> `p`, this code just inserts the new text between `<p>` and `</p>`. (In cases\n> where there is existing content, it will be overwritten.)\n\n`;`\n\n> The all-important semicolon indicates the end of this line of code. Chain\n> over.\n\n### The Hand-off\n\nMany, but not all, D3 methods return a selection (actually, a reference to a\nselection), which enables this handy technique of method chaining. Typically,\na method returns a reference to the element that it just acted on, but not\nalways.\n\nSo remember this: when chaining methods, order matters. The output type of one\nmethod has to match the input type expected by the next method in the chain.\nIf adjacent inputs and outputs are mismatched, the hand-off will function more\nlike a dropped baton in a middle-school relay race.\n\nWhen sussing out what each function expects and returns, [the API\nreference](https://github.com/mbostock/d3/wiki/API-Reference) is your friend.\nIt contains detailed information on each method, including whether or not it\nreturns a selection.\n\n### Going Chainless\n\nOur sample code could be rewritten without chain syntax:\n\n    \n    \n    var body = d3.select(\"body\");\n    var p = body.append(\"p\");\n    p.text(\"New paragraph!\");\n\nUgh! What a mess. Yet there will be times you need to break the chain, such as\nwhen you are calling so many functions that it doesn’t make sense to string\nthem all together. Or just because you want to organize your code in a way\nthat makes more sense to you.\n\nNow that you know how to generate new page elements with D3, it’s time to\nattach data to them.\n\n\n## Binding Data\n\nWhat is binding, and why would I want to do it to my data?\n\nData visualization is a process of _mapping_ data to visuals. Data in, visual\nproperties out. Maybe bigger numbers make taller bars, or special categories\ntrigger brighter colors. The mapping rules are up to you.\n\nWith D3, we _bind_ our data input values to elements in the DOM. Binding is\nlike “attaching” or associating data to specific elements, so that later you\ncan reference those values to apply mapping rules. Without the binding step,\nwe have a bunch of data-less, unmappable DOM elements. No one wants that.\n\n### In a Bind\n\nWe use D3’s\n[`selection.data()`](https://github.com/mbostock/d3/wiki/Selections#wiki-data)\nmethod to bind data to DOM elements. But there are two things we need in place\nfirst, before we can bind data:\n\n  * The data \n  * A selection of DOM elements \n\nLet’s tackle these one at a time.\n\n### Data\n\nD3 is smart about handling different kinds of data, so it will accept\npractically any array of numbers, strings, or objects (themselves containing\nother arrays or key/value pairs). It can handle JSON (and GeoJSON) gracefully,\nand even has a built-in method to help you load in CSV files.\n\nBut to keep things simple, for now we will start with a boring array of five\nnumbers. Here is our sample dataset:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nIf you’re feeling adventurous, or already have some data in CSV or JSON format\nthat you want to play with, here’s how to do that. Otherwise, just skip ahead\nto [Please Make Your\nSelection](part0009_split_002.html#please_make_your_selection_5).\n\n#### Loading CSV data\n\nCSV stands for comma-separated values. A CSV data file might look something\nlike this:\n\n    \n    \n    Food,Deliciousness\n    Apples,9\n    Green Beans,5\n    Egg Salad Sandwich,4\n    Cookies,10\n    Vegemite,0.2\n    Burrito,7\n\nEach line in the file has the same number of values (two, in this case), and\nvalues are separated by a comma. The first line in the file often serves as a\nheader, providing names for each of the “columns” of data.\n\nIf you have data in an Excel file, it probably follows a similar structure of\nrows and columns. To get that data into D3, open it in Excel, then choose Save\nas… and select CSV as the file type.\n\nIf we saved the preceding CSV data into a file called _food.csv_ , then we\ncould load the file into D3 by using the `d3.csv()` method:\n\n    \n    \n    d3.csv(\"food.csv\", function(data) {\n        console.log(data);\n    });\n\n`csv()` takes two arguments: a string representing the path of the CSV file to\nload in, and an anonymous function, to be used as a _callback function_. The\ncallback function is “called” only _after_ the CSV file has been loaded into\nmemory. So you can be sure that, by the time the callback is called,\n`d3.csv()` is done executing.\n\nWhen called, the anonymous function is handed the result of the CSV loading\nand parsing process; that is, the data. Here I’m naming it `data`, but this\ncould be called whatever you like. You should use this callback function to do\nall the things you can do only _after_ the data has been loaded. In the\npreceding example, we are just logging the value of the `data` array to the\nconsole, to verify it, as shown in [Figure\n5-3](part0009_split_002.html#Array_logged_to_console). (See\n_03_csv_loading_example.html_ in the example code.)\n\n![Array logged to console](../images/00033.jpeg)\n\nFigure 5-3. Array logged to console\n\nYou can see that `data` is an array (because of the hard brackets `[]` on\neither end) with six elements, each of which is an object. By toggling the\ndisclosure triangles next to each object, we can see their values (see [Figure\n5-4](part0009_split_002.html#Array_elements_expanded)).\n\n![Array elements expanded](../images/00034.jpeg)\n\nFigure 5-4. Array elements expanded\n\nAha! Each object has both a `Food` property and a `Deliciousness` property,\nthe values of which correspond to the values in our CSV! (There is also a\nthird property, `__proto__`, but that has to do with how JavaScript handles\nobjects, and you can ignore it for now.) D3 has employed the first row of the\nCSV for property names, and subsequent rows for values. You might not realize\nit, but this just saved you a _lot_ of time.\n\nOne more thing to note is that each value from the CSV is stored as a string,\neven the numbers. (You can tell because 9 is surrounded by quotation marks, as\nin `\"9\"` and not simply `9`.) This could cause unexpected behavior later, if\nyou try to reference your data as a numeric value but it is still typed as a\nstring.\n\n* * *\n\n### Handling Data Loading Errors\n\nNote that `d3.csv()` is an _asynchronous_ method, meaning that the rest of\nyour code is executed even while JavaScript is simultaneously waiting for the\nfile to finish downloading into the browser. (The same is true of D3’s other\nfunctions that load external resources, such as `d3.json()`.)\n\nThis can potentially be _very_ confusing, because you — as a reasonable human\nperson — might assume that the CSV file’s data is available, when in fact it\nhasn’t finished loading yet. A common mistake is to include references to the\nexternal data _outside of_ the callback function. Save yourself some headaches\nand make sure to reference your data only from _within_ the callback function\n(or from within other functions that you call within the callback function).\n\nPersonally, I like to declare a global variable first, then call `d3.csv()` to\nload the data. Within the callback function, I copy the data into my global\nvariable (so it’s available to all of my subsequent functions), and finally I\ncall any functions that rely on that data being present. For example:\n\n    \n    \n    var dataset;  //Global variable\n    \n    d3.csv(\"food.csv\", function(data) {\n        dataset = data;    //Once loaded, copy to dataset.\n        generateVis();     //Then call other functions that\n        hideLoadingMsg();  //depend on data being present.\n    });\n\nTo further confuse matters, the callback function is executed _whether or not\nthe datafile was loaded successfully_. That’s right, if the network connection\nfails, or the filename is misspelled, or for some reason an error occurs on\nthe web server end, the callback function will _still_ be executed. When the\ndata fails to load, and you call functions that rely on that data being\npresent, you will probably see an error in the console, and the visualization\nwon’t be created. This scenario might happen only rarely, but it’s useful to\nknow how to handle it.\n\nFortunately, you can include an optional `error` parameter in the callback\nfunction definition. If there is a problem loading the file, then `error` will\nbe set to the error message returned by the web server, and `data` will be\n`undefined`. If the file loads successfully and there is no error, then\n`error` will be `null`, and the `data` array will be populated as expected.\nNote that `error` must be the first parameter, and `data` the second:\n\n    \n    \n    var dataset;\n    \n    d3.csv(\"food.csv\", function(error, data) {\n    \n            if (error) {  //If error is not null, something went wrong.\n              console.log(error);  //Log the error.\n            } else {      //If no error, the file loaded correctly. Yay!\n              console.log(data);   //Log the data.\n    \n          //Include other code to execute after successful file load here\n          dataset = data;\n          generateVis();\n          hideLoadingMsg();\n            }\n    \n    });\n\n* * *\n\nVerifying your data is a great use of the `csv()` callback function, but\ntypically this is where you’d call other functions that construct the\nvisualization, now that the data is available, as in:\n\n    \n    \n    var dataset;  //Declare global var\n    \n    d3.csv(\"food.csv\", function(data) {\n    \n        //Hand CSV data off to global var,\n        //so it's accessible later.\n        dataset = data;\n    \n        //Call some other functions that\n        //generate your visualization, e.g.:\n        generateVisualization();\n        makeAwesomeCharts();\n        makeEvenAwesomerCharts();\n        thankAwardsCommittee();\n    \n    });\n\nOne more tip: if you have _tab_ -separated data in a TSV file, try the\n`d3.tsv()` method, which otherwise behaves exactly as the preceding method.\n\n#### Loading JSON data\n\nWe’ll spend more time talking about JSON later, but for now, all you need to\nknow is that the `d3.json()` method works the same way as `csv()`. Load your\nJSON data in this way:\n\n    \n    \n    d3.json(\"waterfallVelocities.json\", function(json) {\n        console.log(json);  //Log output to console\n    });\n\nHere, I’ve named the parsed output `json`, but it could be called `data` or\nwhatever you like.\n\n### Please Make Your Selection\n\nThe data is ready to go. As a reminder, we are working with this simple array:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nNow you need to decide what to select. That is, what elements will your data\nbe associated with? Again, let’s keep it super simple and say that we want to\nmake a new paragraph for each value in the dataset. So you might imagine\nsomething like this would be helpful:\n\n    \n    \n    d3.select(\"body\").selectAll(\"p\")\n\nand you’d be right, but there’s a catch: the paragraphs we want to select\n_don’t exist yet_. And this gets at one of the most common points of confusion\nwith D3: how can we select elements that don’t yet exist? Bear with me, as the\nanswer might require bending your mind a bit.\n\nThe answer lies with `enter()`, a truly magical method. See this code, which\nI’ll explain:\n\n    \n    \n    d3.select(\"body\").selectAll(\"p\")\n        .data(dataset)\n        .enter()\n        .append(\"p\")\n        .text(\"New paragraph!\");\n\nView the example code _04_creating_paragraphs.html_ and you should see five\nnew paragraphs, each with the same content, as shown in [Figure\n5-5](part0009_split_002.html#Dynamic_paragraphs).\n\n![Dynamic paragraphs](../images/00035.jpeg)\n\nFigure 5-5. Dynamic paragraphs\n\nHere’s what’s happening:\n\n`d3.select(\"body\")`\n\n> Finds the `body` in the DOM and hands off a reference to the next step in\n> the chain.\n\n`.selectAll(\"p\")`\n\n> Selects all paragraphs in the DOM. Because none exist yet, this returns an\n> empty selection. Think of this empty selection as representing the\n> paragraphs that _will soon exist_.\n\n`.data(dataset)`\n\n> Counts and parses our data values. There are five values in our array called\n> `dataset`, so everything past this point is executed five times, once for\n> each value.\n\n`.enter()`\n\n> To create new, data-bound elements, you must use `enter()`. This method\n> looks at the current DOM selection, and then at the data being handed to it.\n> If there are more data values than corresponding DOM elements, then\n> `enter()` _creates a new placeholder element_ on which you can work your\n> magic. It then hands off a reference to this new placeholder to the next\n> step in the chain.\n\n`.append(\"p\")`\n\n> Takes the empty placeholder selection created by `enter()` and appends a `p`\n> element into the DOM. Hooray! Then it hands off a reference to the element\n> it just created to the next step in the chain.\n\n`.text(\"New paragraph!\")`\n\n> Takes the reference to the newly created `p` and inserts a text value.\n\n### Bound and Determined\n\nAll right! Our data has been read, parsed, and bound to new `p` elements that\nwe created in the DOM. Don’t believe me? Take another look at\n_04_creating_paragraphs.html_ and whip out your web inspector, shown in\n[Figure 5-6](part0009_split_002.html#new_p_elements_in_the_inspector).\n\n![New p elements in the web inspector](../images/00036.jpeg)\n\nFigure 5-6. New `p` elements in the web inspector\n\nOkay, I see five paragraphs, but where’s the data? Switch to the JavaScript\nconsole, type in the following code, and click Enter. The results are shown in\n[Figure 5-7](part0009_split_002.html#logging_to_from_console):\n\n    \n    \n    console.log(d3.selectAll(\"p\"))\n\n![Logging to the console, from the console](../images/00037.jpeg)\n\nFigure 5-7. Logging to the console, from the console\n\nAn array! Or, really, an array containing another array. Click the gray\ndisclosure triangle to reveal its contents, shown in [Figure\n5-8](part0009_split_002.html#array_of_arrays).\n\n![Array of arrays, expanded](../images/00038.jpeg)\n\nFigure 5-8. Array of arrays, expanded\n\nYou’ll notice the five `p`s, numbered 0 through 4. Click the disclosure\ntriangle next to the first one (number zero), which results in the view shown\nin [Figure 5-9](part0009_split_002.html#the_p_element_expanded).\n\n![The p element, expanded](../images/00039.jpeg)\n\nFigure 5-9. The p element, expanded\n\nSee it? Do you see it? I can barely contain myself. There it is ([Figure\n5-10](part0009_split_002.html#finally_bound_data)).\n\n![Finally, bound data](../images/00040.jpeg)\n\nFigure 5-10. Finally, bound data\n\nOur first data value, the number `5`, is showing up under the first\nparagraph’s `__data__` attribute. Click into the other paragraph elements, and\nyou’ll see they also contain `__data__` values: 10, 15, 20, and 25, just as we\nspecified.\n\nYou see, when D3 binds data to an element, that data doesn’t exist in the DOM,\nbut it does exist in memory as a `__data__` attribute of that element. And the\nconsole is where you can go to confirm whether or not your data was bound as\nexpected.\n\nThe data is ready. Let’s do something with it.\n\n### Using Your Data\n\nWe can see that the data has been loaded into the page and is bound to our\nnewly created elements in the DOM, but can we _use_ it? Here’s our code so\nfar:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n    \n    d3.select(\"body\").selectAll(\"p\")\n        .data(dataset)\n        .enter()\n        .append(\"p\")\n        .text(\"New paragraph!\");\n\nLet’s change the last line to:\n\n    \n    \n        .text(function(d) { return d; });\n\nNow test out that new code in _05_creating_paragraphs_text.html_. You should\nsee the result shown in [Figure\n5-11](part0009_split_002.html#more_dynamic_paragraphs).\n\n![More dynamic paragraphs](../images/00041.jpeg)\n\nFigure 5-11. More dynamic paragraphs\n\nWhoa! We used our data to populate the contents of each paragraph, all thanks\nto the magic of the `data()` method. You see, when chaining methods together,\nanytime after you call `data()`, you can create an anonymous function that\naccepts `d` as input. The magical `data()` method ensures that `d` is set to\nthe corresponding value in your original dataset, given the current element at\nhand.\n\nThe value of “the current element” changes over time as D3 loops through each\nelement. For example, when looping through the third time, our code creates\nthe third `p` tag, and `d` will correspond to the third value in our dataset\n(or `dataset[2]`). So the third paragraph gets text content of “15”.\n\n### High-Functioning\n\nIn case you’re new to writing your own functions (a.k.a. methods), the basic\nstructure of a function definition is:\n\n    \n    \n    function(input_value) {\n        //Calculate something here\n        return output_value;\n    }\n\nThe function we used earlier is dead simple, nothing fancy:\n\n    \n    \n    function(d) {\n        return d;\n    }\n\nThis is called an _anonymous function_ , because it doesn’t have a name.\nContrast that with a function that’s stored in a variable, which is a _named\nfunction_ :\n\n    \n    \n    var doSomething = function() {\n        //Code to do something here\n    };\n\nWe’ll write lots of anonymous functions when using D3. They are the key to\naccessing individual data values and calculating dynamic properties.\n\nThis particular anonymous function is wrapped within D3’s `text()` function.\nSo our anonymous function is executed first. Then its result is handed off to\n`text()`. Then `text()` finally works its magic (by inserting its input\nargument as text within the selected DOM element):\n\n    \n    \n    .text(function(d) {\n        return d;\n    });\n\nBut we can (and will) get much fancier because you can customize these\nfunctions any way you like. Yes, this is both the pleasure and pain of writing\nyour own JavaScript. Maybe you’d like to add some extra text, as in:\n\n    \n    \n    .text(function(d) {\n        return \"I can count up to \" + d;\n    });\n\nwhich produces the result shown in [Figure\n5-12](part0009_split_002.html#Still_more_dynamic_paragraphs), as seen in\nexample file _06_creating_paragraphs_counting.html_.\n\n![Still more dynamic paragraphs](../images/00042.jpeg)\n\nFigure 5-12. Still more dynamic paragraphs\n\n### Data Wants to Be Held\n\nYou might be wondering why you have to write out `function(d) { … }` instead\nof just `d` on its own. For example, this won’t work:\n\n    \n    \n    .text(\"I can count up to \" + d);\n\nIn this context, without wrapping `d` in an anonymous function, `d` has no\nvalue. Think of `d` as a lonely little placeholder value that just needs a\nwarm, containing hug from a kind, caring function’s parentheses. (Extending\nthis metaphor further, yes, it is creepy that the hug is being given by an\n_anonymous_ function, but that only confuses matters.)\n\nHere is `d` being held gently and appropriately by a function:\n\n    \n    \n    .text(function(d) {  // <-- Note tender embrace at left\n        return \"I can count up to \" + d;\n    });\n\nThe reason for this syntax is that `.text()`, `attr()`, and many other D3\nmethods can take a _function_ as an argument. For example, `text()` can take\neither simply a static string of text as an argument:\n\n    \n    \n    .text(\"someString\")\n\n_or_ the result of a function:\n\n    \n    \n    .text(someFunction())  // Presumably, someFunction() would return a string\n\n _or_ an anonymous function itself can be the argument, such as when you\nwrite:\n\n    \n    \n    .text(function(d) {\n        return d;\n    })\n\nHere, you are defining an anonymous function. If D3 sees a function there, it\nwill _call_ that function, while handing off the current datum `d` as the\nfunction’s argument. Here, I’ve named the argument `d` just by convention. You\ncould call it `datum` or `info` or whatever you like. All D3 is looking for is\n_any_ argument name, into which it can pass the current datum. Throughout this\nbook, we’ll use `d` because it is concise and familiar from many of the other\nD3 examples found online.\n\nIn any case, without that function in place, D3 couldn’t relay the current\ndata value. Without an anonymous function and its argument there to receive\nthe value of `d`, D3 could get confused and even start crying. (D3 is more\nemotional than you’d expect.)\n\nAt first, this might seem silly and like a lot of extra work to just get at\n`d`, but the value of this approach will become clear as we work on more\ncomplex pieces.\n\n### Beyond Text\n\nThings get a lot more interesting when we explore D3’s other methods, like\n`attr()` and `style()`, which allow us to set HTML attributes and CSS\nproperties on selections, respectively.\n\nFor example, adding one more line to our code:\n\n    \n    \n    .style(\"color\", \"red\");\n\nproduces the result shown in [Figure\n5-13](part0009_split_002.html#Red_paragraphs), as seen in\n_07_creating_paragraphs_with_style.html_.\n\n![Red paragraphs](../images/00043.gif)\n\nFigure 5-13. Red paragraphs\n\nAll the text is now red; big deal. But we could use a custom function to make\nthe text red only if the current datum exceeds a certain threshold. So we\nrevise that last line to use a function instead of a string:\n\n    \n    \n    .style(\"color\", function(d) {\n        if (d > 15) {   //Threshold of 15\n            return \"red\";\n        } else {\n            return \"black\";\n        }\n    });\n\nSee the resulting change, displayed in [Figure\n5-14](part0009_split_002.html#Dynamically_styled_paragraphs), in\n_08_creating_paragraphs_with_style_functions.html_.\n\n![Dynamically styled paragraphs](../images/00044.jpeg)\n\nFigure 5-14. Dynamically styled paragraphs\n\nNotice how the first three lines are black, but once `d` exceeds the arbitrary\nthreshold of 15, the text turns red.\n\nOkay, we’ve got data loaded in, and dynamically created DOM elements bound to\nthat data. I’d say we’re ready to start drawing with data!\n\n\n## Chapter 6. Drawing with Data\n\nIt’s time to start drawing with data.\n\nLet’s continue working with our simple dataset for now:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\n\n## Drawing divs\n\nWe’ll use this to generate a super-simple bar chart. Bar charts are\nessentially just rectangles, and an HTML `div` is the easiest way to draw a\nrectangle. (Then again, to a web browser, _everything_ is a rectangle, so you\ncould easily adapt this example to use `span`s or whatever element you\nprefer.)\n\nFormally, a chart with vertically oriented rectangles is a _column_ chart, and\none with horizontal rectangles is a _bar_ chart. In practice, most people just\ncall them all bar charts, as I’ll do from now on.\n\nThis `div` could work well as a data bar, shown in [Figure\n6-1](part0010_split_001.html#A_humble_div).\n\n![A humble div](../images/00045.jpeg)\n\nFigure 6-1. A humble div\n\n    \n    \n    <div style=\"display: inline-block;\n                width: 20px;\n                height: 75px;\n                background-color: teal;\"></div>\n\nAmong web standards folks, this is a semantic no-no. Normally, one shouldn’t\nuse an empty `div` for purely visual effect, but I am making an exception for\nthe sake of this example.\n\nBecause this is a `div`, its `width` and `height` are set with CSS styles.\nExcept for `height`, each bar in our chart will share the same display\nproperties, so I’ll put those shared styles into a class called `bar`, as an\nembedded style up in the `head` of the document:\n\n    \n    \n    div.bar {\n        display: inline-block;\n        width: 20px;\n        height: 75px;   /* We'll override height later */\n        background-color: teal;\n    }\n\nNow each `div` needs to be assigned the `bar` class, so our new CSS rule will\napply. If you were writing the HTML code by hand, you would write the\nfollowing:\n\n    \n    \n    <div class=\"bar\"></div>\n\nUsing D3, to add a class to an element, we use the `selection.attr()` method.\nIt’s important to understand the difference between `attr()` and its close\ncousin, `style()`. `attr()` sets DOM attribute values, whereas `style()`\napplies CSS styles directly to an element.\n\n### Setting Attributes\n\n[`attr()`](https://github.com/mbostock/d3/wiki/Selections#wiki-attr) is used\nto set an HTML attribute and its value on an element. An HTML attribute is any\nproperty/value pair that you could include between an element’s `<>` brackets.\nFor example, these HTML elements:\n\n    \n    \n    <p class=\"caption\">\n    <select id=\"country\">\n    <img src=\"logo.png\" width=\"100px\" alt=\"Logo\" />\n\ncontain a total of five attributes (and corresponding values), all of which\ncould be set with `attr()`:\n\nAttribute |  Value  \n---|---  \n`class`| `caption`  \n`id`| `country`  \n`src`| `logo.png`  \n`width`| `100px`  \n`alt`| `Logo`  \n  \nTo assign a class of `bar`, we can use:\n\n    \n    \n    .attr(\"class\", \"bar\")\n\n### A Note on Classes\n\nNote that an element’s _class_ is stored as an HTML attribute. The class, in\nturn, is used to reference a CSS style rule. This could cause some confusion\nbecause there is a difference between setting a _class_ (from which styles are\ninferred) and applying a _style_ directly to an element. You can do both with\nD3. Although you should use whatever approach makes the most sense to you, I\nrecommend using _classes_ for properties that are shared by multiple elements,\nand applying _style_ rules directly only when deviating from the norm. (In\nfact, that’s what we’ll do in just a moment.)\n\nI also want to briefly mention another D3 method, `classed()`, which can be\nused to quickly apply or remove classes from elements. The preceding line of\ncode could be rewritten as the following:\n\n    \n    \n    .classed(\"bar\", true)\n\nThis line simply takes whatever selection is passed to it and applies the\nclass `bar`. If `false` were specified, it would do the opposite, removing the\nclass of `bar` from any elements in the selection:\n\n    \n    \n    .classed(\"bar\", false)\n\n### Back to the Bars\n\nPutting it all together with our dataset, here is the complete D3 code so far:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n    \n    d3.select(\"body\").selectAll(\"div\")\n        .data(dataset)\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", \"bar\");\n\nTo see what’s going on, look at _01_drawing_divs.html_ in your browser, view\nthe source, and open your web inspector. You should see five vertical `div`\nbars, one generated for each point in our dataset. However, with no space\nbetween them, they look like one big rectangle, as seen in Figures\n[6-2](part0010_split_001.html#Five_divs_masquerading_as_one) and\n[6-3](part0010_split_001.html#Five_divs_masquerading_as_one_inspector).\n\n![Five divs masquerading as one](../images/00046.jpeg)\n\nFigure 6-2. Five `div`s masquerading as one\n\n![Five divs masquerading as one, as seen through the web\ninspector](../images/00047.jpeg)\n\nFigure 6-3. Five `div`s masquerading as one, as seen through the web inspector\n\n### Setting Styles\n\nThe [`style()`](https://github.com/mbostock/d3/wiki/Selections#wiki-style)\nmethod is used to apply a CSS property and value directly to an HTML element.\nThis is the equivalent of including CSS rules within a `style` attribute right\nin your HTML, as in:\n\n    \n    \n    <div style=\"height: 75px;\"></div>\n\nTo make a bar chart, the height of each bar must be a function of its\ncorresponding data value. So let’s add this to the end of our D3 code (taking\ncare to keep the final semicolon at the very end of the chain):\n\n    \n    \n    .style(\"height\", function(d) {\n        return d + \"px\";\n    });\n\nSee that code in _02_drawing_divs_height.html_. You should see a very small\nbar chart, like the one in [Figure\n6-4](part0010_split_001.html#A_small_bar_chart).\n\n![A small bar chart](../images/00048.jpeg)\n\nFigure 6-4. A small bar chart\n\nWhen D3 loops through each data point, the value of `d` will be set to that of\nthe corresponding value. So we are setting a `height` value of `d` (the\ncurrent data value) while appending the text `px` (to specify the units are\npixels). The resulting heights are `5px`, `10px`, `15px`, `20px`, and `25px`.\n\nThis looks a little bit silly, so let’s make those bars taller:\n\n    \n    \n    .style(\"height\", function(d) {\n        var barHeight = d * 5;  //Scale up by factor of 5\n        return barHeight + \"px\";\n    });\n\nAdd some space to the right of each bar (in the embedded CSS style, in the\ndocument `head`), to space things out:\n\n    \n    \n    margin-right: 2px;\n\nNice! We could go to [SIGGRAPH](https://www.siggraph.org) with that chart\n([Figure 6-5](part0010_split_001.html#A_taller_bar_chart)).\n\n![A taller bar chart](../images/00049.jpeg)\n\nFigure 6-5. A taller bar chart\n\nTry out the sample code _03_drawing_divs_spaced.html_. Again, view the source\nand use the web inspector to contrast the original HTML against the final DOM.\n\n\n## The Power of data()\n\nThis is exciting, but real-world data is never this clean:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nLet’s make our data a bit messier, as in _04_power_of_data.html_ :\n\n    \n    \n    var dataset = [ 25, 7, 5, 26, 11 ];\n\nThat change in data results in the bars shown in [Figure\n6-6](part0010_split_002.html#New_data_values). We’re not limited to five data\npoints, of course. Let’s add many more! (See\n_05_power_of_data_more_points.html_.)\n\n    \n    \n    var dataset = [ 25, 7, 5, 26, 11, 8, 25, 14, 23, 19,\n                    14, 11, 22, 29, 11, 13, 12, 17, 18, 10,\n                    24, 18, 25, 9, 3 ];\n\n![New data values](../images/00050.jpeg)\n\nFigure 6-6. New data values\n\nTwenty-five data points instead of five (see [Figure\n6-7](part0010_split_002.html#Lots_more_data_values))!\n\n![Lots more data values](../images/00051.gif)\n\nFigure 6-7. Lots more data values\n\nHow does D3 automatically expand our chart as needed?\n\n    \n    \n    d3.select(\"body\").selectAll(\"div\")\n        .data(dataset)  // <-- The answer is here!\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", \"bar\")\n        .style(\"height\", function(d) {\n            var barHeight = d * 5;\n            return barHeight + \"px\";\n        });\n\nGive `data()` 10 values, and it will loop through 10 times. Give it one\nmillion values, and it will loop through one million times. (Just be patient.)\n\nThat is the power of `data()` — being smart enough to loop through the full\nlength of whatever dataset you throw at it, executing each method beneath it\nin the chain, while updating the context in which each method operates, so `d`\nalways refers to the current datum at that point in the loop.\n\nThat might be a mouthful, and if it all doesn’t make sense yet, it will soon.\nI encourage you to make a copy of _05_power_of_data_more_points.html_ , tweak\nthe `dataset` values, and note how the bar chart changes.\n\nRemember, the _data_ is driving the visualization — not the other way around.\n\n### Random Data\n\nSometimes it’s fun to generate random data values, whether for testing\npurposes or just pure geekiness. That’s just what I’ve done in\n_06_power_of_data_random.html_. Notice that each time you reload the page, the\nbars render differently, as shown in [Figure\n6-8](part0010_split_002.html#Bar_charts_with_random_values).\n\n![Bar charts with random values](../images/00052.jpeg)\n\nFigure 6-8. Bar charts with random values\n\nView the source, and you’ll see this code:\n\n    \n    \n    var dataset = [];                         //Initialize empty array\n    for (var i = 0; i < 25; i++) {            //Loop 25 times\n        var newNumber = Math.random() * 30;   //New random number (0-30)\n        dataset.push(newNumber);              //Add new number to array\n    }\n\nThat code doesn’t use any D3 methods; it’s just JavaScript. Without going into\ntoo much detail, this code does the following:\n\n  1. Creates an empty array called `dataset`. \n  2. Initiates a `for` loop, which is executed 25 times. \n  3. Each time, it generates a new random number with a value between 0 and 30. (Well, technically, _almost_ 30\\. `Math.random()` returns values as low as 0.0 all the way up to, but not including, 1.0. So if `Math.random()` returned 0.99999, then the result would be 0.99999 times 30, which is 29.9997, or the teensiest bit less than 30.) \n  4. That new number is appended to the `dataset` array. (`push()` is an array method that appends a new value to the end of an array.) \n\nJust for kicks, open up the JavaScript console and enter\n`console.log(dataset)`. You should see the full array of 25 randomized data\nvalues, as shown in [Figure\n6-9](part0010_split_002.html#Random_values_in_console).\n\n![Random values in console](../images/00053.jpeg)\n\nFigure 6-9. Random values in console\n\nNotice that they are all decimal or floating point values (such as\n14.793717765714973), not whole numbers or integers (such as 14) like we used\ninitially. For this example, decimal values are fine, but if you ever need\nwhole numbers, you could use JavaScript’s `Math.round()` or `Math.floor()`\nmethods. `Math.round()` rounds any number to the nearest integer, whereas\n`Math.floor()` always rounds down, for greater control over the result. For\nexample, you could wrap the random number generator from this line:\n\n    \n    \n        var newNumber = Math.random() * 30;\n\nas follows:\n\n    \n    \n        var newNumber = Math.floor(Math.random() * 30);\n\nUsing this code, `newNumber` would always be either 0 or 29, or any integer in\nbetween. Why not 30? Because `Math.random()` always returns values _less than_\n1.0, and `Math.floor()` will always _round down_ , so 29 is the highest\npossible return value.\n\nTry it out in _07_power_of_data_rounded.html_ , and use the console to verify\nthat the numbers have indeed been rounded to integers, as displayed in [Figure\n6-10](part0010_split_002.html#Random_integer_values_in_console).\n\n![Random integer values in console](../images/00054.jpeg)\n\nFigure 6-10. Random integer values in console\n\nThat’s about all we can do visually with `div`s. Let’s expand our visual\npossibilities with SVG.\n\n\n## Drawing SVGs\n\nFor a quick refresher on SVG syntax, see [SVG](part0007_split_008.html#SVG_3).\n\nOne thing you might notice about SVG elements is that all of their properties\nare specified as _attributes_. That is, they are included as property/value\npairs within each element tag, like this:\n\n    \n    \n    <element property=\"value\"></element>\n\nHmm, that looks strangely like HTML!\n\n    \n    \n    <p class=\"eureka\">Eureka!</p>\n\nWe have already used D3’s handy `append()` and `attr()` methods to create new\nHTML elements and set their attributes. Because SVG elements exist in the DOM,\njust as HTML elements do, we can use `append()` and `attr()` in exactly the\nsame way to generate SVG images.\n\n### Create the SVG\n\nFirst, we need to create the SVG element in which to place all our shapes:\n\n    \n    \n    d3.select(\"body\").append(\"svg\");\n\nThat will find the document’s `body` and append a new `svg` element just\nbefore the closing `</body>` tag. That code will work, but I’d like to suggest\na slight modification:\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\");\n\nRemember how most D3 methods return a reference to the DOM element on which\nthey act? By creating a new variable `svg`, we are able to capture the\nreference handed back by `append()`. Think of `svg` not as a variable but as a\nreference pointing to the SVG object that we just created. This reference will\nsave us a lot of code later. Instead of having to search for that SVG each\ntime — as in `d3.select(\"svg\")` — we just say `svg`:\n\n    \n    \n    svg.attr(\"width\", 500)\n       .attr(\"height\", 50);\n\nAlternatively, that could all be written as one line of code:\n\n    \n    \n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", 500)\n                .attr(\"height\", 50);\n\nSee _08_drawing_svgs.html_ for that code. Inspect the DOM and notice that\nthere is, indeed, an empty SVG element.\n\nTo simplify your life, I recommend putting the width and height values into\nvariables at the top of your code, as in _09_drawing_svgs_size.html_. View the\nsource, and you’ll see the following code:\n\n    \n    \n    //Width and height\n    var w = 500;\n    var h = 50;\n\nI’ll be doing that with all future examples. By _variabalizing_ the size\nvalues, they can be easily referenced throughout your code, as in the\nfollowing:\n\n    \n    \n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)   // <-- Here\n                .attr(\"height\", h); // <-- and here!\n\nAlso, if you send me a petition to make “variabalize” a real word, I will\ngladly sign it.\n\n### Data-Driven Shapes\n\nTime to add some shapes. I’ll bring back our trusty old dataset:\n\n    \n    \n    var dataset = [ 5, 10, 15, 20, 25 ];\n\nand then use `data()` to iterate through each data point, creating a `circle`\nfor each one:\n\n    \n    \n    svg.selectAll(\"circle\")\n        .data(dataset)\n        .enter()\n        .append(\"circle\");\n\nRemember, `selectAll()` will return empty references to all `circle`s (which\ndon’t exist yet), `data()` binds our data to the elements we’re about to\ncreate, `enter()` returns a placeholder reference to the new element, and\n`append()` finally adds a `circle` to the DOM. In this case, it appends those\n`circle`s to the end of the SVG element, as our initial selection is our\nreference `svg` (as opposed to the document `body`, for example).\n\nTo make it easy to reference all of the `circle`s later, we can create a new\nvariable to store references to them all:\n\n    \n    \n    var circles = svg.selectAll(\"circle\")\n                     .data(dataset)\n                     .enter()\n                     .append(\"circle\");\n\nGreat, but all these circles still need positions and sizes, displayed in\n[Figure 6-11](part0010_split_003.html#Row_of_data_circles). Be warned, the\nfollowing code might blow your mind:\n\n    \n    \n    circles.attr(\"cx\", function(d, i) {\n                return (i * 50) + 25;\n            })\n           .attr(\"cy\", h/2)\n           .attr(\"r\", function(d) {\n                return d;\n           });\n\n![Row of data circles](../images/00055.jpeg)\n\nFigure 6-11. Row of data circles\n\nFeast your eyes on the demo _10_drawing_svgs_circles.html_. Let’s step through\nthe code, one line at a time:\n\n    \n    \n    circles.attr(\"cx\", function(d, i) {\n                return (i * 50) + 25;\n            })\n\nThis takes the reference to all `circle`s and sets the `cx` attribute for each\none. (Remember that, in SVG lingo, `cx` is the x position value of the\n_center_ of the circle.) Our data has already been bound to the `circle`\nelements, so for each `circle`, the value `d` matches the corresponding value\nin our original dataset (5, 10, 15, 20, or 25).\n\nAnother value, `i`, is also automatically populated for us. (Thanks, D3!) Just\nas with `d`, the name `i` here is arbitrary and could be set to whatever you\nlike, such as `counter` or `elementID`. I prefer to use `i` because it is\nconcise, it alludes to the convention of using `i` in `for` loops, and it is\nvery common, as you’ll see it in all the online examples.\n\nSo, `i` is a numeric index value of the current element. Counting starts at\nzero, so for our “first” circle `i == 0`, the second circle’s `i == 1`, and so\non. We’re using `i` to push each subsequent circle over to the right, because\neach subsequent loop through, the value of `i` increases by one:\n\n    \n    \n    (0 * 50) + 25   //Returns 25\n    (1 * 50) + 25   //Returns 75\n    (2 * 50) + 25   //Returns 125\n    (3 * 50) + 25   //Returns 175\n    (4 * 50) + 25   //Returns 225\n\nTo make sure `i` is available to your custom function, you must include it as\nan argument in the function definition, `function(d, i)`. You must also\ninclude `d`, even if you don’t use `d` within your function (as in the\npreceding case). This is because, again, the actual names used for these\narguments are not important, but the total number of arguments (one or two)\nis.\n\nAlso, in case you’re feeling a surge of parameter anxiety, don’t worry. You’ll\nonly ever have to worry about `d` and `i`. There are no additional anonymous\nfunction parameters to learn about later.\n\nOn to the next line:\n\n    \n    \n    .attr(\"cy\", h/2)\n\n`cy` is the y position value of the center of each circle. We’re setting `cy`\nto `h` divided by two, or one-half of `h`. You’ll recall that `h` stores the\nheight of the entire SVG, so `h/2` has the effect of aligning all `circle`s in\nthe vertical center of the image:\n\n    \n    \n    .attr(\"r\", function(d) {\n        return d;\n    });\n\nFinally, the radius `r` of each `circle` is simply set to `d`, the\ncorresponding data value.\n\n### Pretty Colors, Oooh!\n\nColor fills and strokes are just other attributes that you can set using the\nsame methods. Simply by appending this code:\n\n    \n    \n    .attr(\"fill\", \"yellow\")\n    .attr(\"stroke\", \"orange\")\n    .attr(\"stroke-width\", function(d) {\n        return d/2;\n    });\n\nwe get the colorful circles shown in [Figure\n6-12](part0010_split_003.html#Colorful_data_circles), as seen in\n_11_drawing_svgs_color.html_.\n\n![Colorful data circles](../images/00056.jpeg)\n\nFigure 6-12. Colorful data circles\n\nOf course, you can mix and match attributes and custom functions to apply any\ncombination of properties. The trick with data visualization, of course, is\nchoosing appropriate _mappings_ , so the visual expression of your data is\nunderstandable and useful for the viewer.\n\n\n## Making a Bar Chart\n\nNow we’ll integrate everything we’ve learned so far to generate a simple bar\nchart as an SVG image.\n\nWe’ll start by adapting the `div` bar chart code to draw its bars with SVG\ninstead, giving us more flexibility over the visual presentation. Then we’ll\nadd labels, so we can see the data values clearly.\n\n### The Old Chart\n\nSee the `div` chart, updated with some new data, in\n_12_making_a_bar_chart_divs.html_ :\n\n    \n    \n    var dataset = [ 5, 10, 13, 19, 21, 25, 22, 18, 15, 13,\n                    11, 12, 15, 20, 18, 17, 16, 18, 23, 25 ];\n    \n    d3.select(\"body\").selectAll(\"div\")\n        .data(dataset)\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", \"bar\")\n        .style(\"height\", function(d) {\n            var barHeight = d * 5;\n            return barHeight + \"px\";\n        });\n\nIt might be hard to imagine, but we can definitely improve on the simple bar\nchart in [Figure 6-13](part0010_split_004.html#Bar_chart_with_divs) made of\n`div`s.\n\n![Bar chart with divs](../images/00057.gif)\n\nFigure 6-13. Bar chart with `div`s\n\n### The New Chart\n\nFirst, we need to decide on the size of the new SVG:\n\n    \n    \n    //Width and height\n    var w = 500;\n    var h = 100;\n\nOf course, you could name `w` and `h` something else, like `svgWidth` and\n`svgHeight`. Use whatever is most clear to you. JavaScript programmers, as a\ngroup, are fixated on efficiency, so you’ll often see single-character\nvariable names, code written with no spaces, and other hard-to-read, yet\nprogrammatically efficient, syntax.\n\nThen, we tell D3 to create an empty SVG element and add it to the DOM:\n\n    \n    \n    //Create SVG element\n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)\n                .attr(\"height\", h);\n\nTo recap, this inserts a new `<svg>` element just before the closing `</body>`\ntag, and assigns the SVG a width and height of 500 by 100 pixels. This\nstatement also puts the result into our new variable called `svg`, so we can\neasily reference the new SVG without having to reselect it later using\nsomething like `d3.select(\"svg\")`.\n\nNext, instead of creating `div`s, we generate `rect`s and add them to `svg`:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       .attr(\"x\", 0)\n       .attr(\"y\", 0)\n       .attr(\"width\", 20)\n       .attr(\"height\", 100);\n\nThis code selects all `rect`s inside of `svg`. Of course, there aren’t any\nyet, so an empty selection is returned. (Weird, yes, but stay with me. With\nD3, you always have to first select whatever it is you’re about to act on,\neven if that selection is momentarily empty.)\n\nThen, `data(dataset)` sees that we have 20 values in the dataset, and those\nvalues are handed off to `enter()` for processing. `enter()`, in turn, returns\na placeholder selection for each data point that does not yet have a\ncorresponding `rect` — which is to say, all of them.\n\nFor each of the 20 placeholders, `append(\"rect\")` inserts a `rect` into the\nDOM. As we learned in [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), every\n`rect` must have `x`, `y`, `width`, and `height` values. We use `attr()` to\nadd those attributes onto each newly created `rect`.\n\nBeautiful, no? Okay, maybe not. All of the bars are there (check the DOM of\n_13_making_a_bar_chart_rects.html_ with your web inspector), but they all\nshare the same `x`, `y`, `width`, and `height` values, with the result that\nthey all overlap (see [Figure 6-14](part0010_split_004.html#One_lonely_bar)).\nThis isn’t a visualization of data yet.\n\n![One lonely bar](../images/00058.jpeg)\n\nFigure 6-14. One lonely bar\n\nLet’s fix the overlap issue first. Instead of an `x` of `0`, we’ll assign a\ndynamic value that corresponds to `i`, or each value’s position in the\ndataset. So the first bar will be at `0`, but subsequent bars will be at `21`,\nthen `42`, and so on. (In a later chapter, we’ll learn about D3’s _scales_ ,\nwhich offer a better, more flexible way to accomplish this same feat.)\n\n    \n    \n    .attr(\"x\", function(d, i) {\n        return i * 21;  //Bar width of 20 plus 1 for padding\n    })\n\nSee that code in action with _14_making_a_bar_chart_offset.html_ and the\nresult in [Figure 6-15](part0010_split_004.html#Twenty_bars).\n\n![Twenty bars](../images/00059.gif)\n\nFigure 6-15. Twenty bars\n\nThat works, but it’s not particularly flexible. If our dataset were longer,\nthen the bars would just run off to the right, past the end of the SVG!\nBecause each bar is 20 pixels wide, plus 1 pixel of padding, a 500-pixel wide\nSVG can only accommodate 23 data points. Note how the 24th bar gets clipped in\n[Figure 6-16](part0010_split_004.html#Twentyfour_bars).\n\n![Twenty-four bars](../images/00060.gif)\n\nFigure 6-16. Twenty-four bars\n\nIt’s good practice to use flexible, dynamic coordinates — heights, widths, x\nvalues, and y values — so your visualization can scale appropriately along\nwith your data.\n\nAs with anything else in programming, there are a thousand ways to achieve\nthat end. I’ll use a simple one. First, I’ll amend the line where we set each\nbar’s `x` position:\n\n    \n    \n    .attr(\"x\", function(d, i) {\n        return i * (w / dataset.length);\n    })\n\nNotice how the `x` value is now tied directly to the width of the SVG (`w`)\nand the number of values in the dataset (`dataset.length`). This is exciting\nbecause now our bars will be evenly spaced, whether we have 20 data values, as\nin [Figure 6-17](part0010_split_004.html#Twenty_evenly_spaced_bars).\n\n![Twenty evenly spaced bars](../images/00061.gif)\n\nFigure 6-17. Twenty evenly spaced bars\n\nOr only five, as in [Figure\n6-18](part0010_split_004.html#Five_evenly_spaced_bars).\n\n![Five evenly spaced bars](../images/00062.jpeg)\n\nFigure 6-18. Five evenly spaced bars\n\nSee that code so far in _15_making_a_bar_chart_even.html_.\n\nNow we should set the bar _widths_ to be proportional, too, so they get\nnarrower as more data is added, or wider when there are fewer values. I’ll add\na new variable near where we set the SVG’s width and height:\n\n    \n    \n    //Width and height\n    var w = 500;\n    var h = 100;\n    var barPadding = 1;  // <-- New!\n\nand then reference that variable in the line where we set each bar’s `width`.\nInstead of a static value of `20`, the width will now be set as a fraction of\nthe SVG width and number of data points, minus a padding value:\n\n    \n    \n    .attr(\"width\", w / dataset.length - barPadding)\n\nIt works! (See [Figure\n6-19](part0010_split_004.html#Twenty_evenly_spaced_bars_with_dynamic_widths)\nand _16_making_a_bar_chart_widths.html_.)\n\n![Twenty evenly spaced bars with dynamic widths](../images/00063.gif)\n\nFigure 6-19. Twenty evenly spaced bars with dynamic widths\n\nThe bar widths and x positions scale correctly whether there are 20 points,\nonly 5 (see [Figure\n6-20](part0010_split_004.html#Five_evenly_spaced_bars_with_dynamic_widths)),\nor even 100 (see [Figure\n6-21](part0010_split_004.html#One_hundred_evenly_spaced_bars_with_dynamic_widths)).\n\n![Five evenly spaced bars with dynamic widths](../images/00064.jpeg)\n\nFigure 6-20. Five evenly spaced bars with dynamic widths\n\n![One hundred evenly spaced bars with dynamic widths](../images/00065.gif)\n\nFigure 6-21. One hundred evenly spaced bars with dynamic widths\n\nFinally, we encode our data as the _height_ of each bar. You would hope it\nwere as easy as referencing the `d` data value when setting each bar’s\n`height`:\n\n    \n    \n    .attr(\"height\", function(d) {\n        return d;\n    });\n\nHmm, the chart in [Figure 6-22](part0010_split_004.html#Dynamic_heights) looks\nfunky. Maybe we can just scale up our numbers a bit?\n\n    \n    \n    .attr(\"height\", function(d) {\n        return d * 4;  // <-- Times four!\n    });\n\n![Dynamic heights](../images/00066.jpeg)\n\nFigure 6-22. Dynamic heights\n\nAlas, it is not that easy! We want our bars to grow upward from the bottom\nedge, not down from the top, as in [Figure\n6-23](part0010_split_004.html#Dynamic_heights_magnified) — but don’t blame D3,\nblame SVG.\n\n![Dynamic heights, magnified](../images/00067.gif)\n\nFigure 6-23. Dynamic heights, magnified\n\nYou’ll recall that, when drawing SVG `rect`s, the `x` and `y` values specify\nthe coordinates of the _upper-left corner_. That is, the origin or reference\npoint for every `rect` is its top-left. For our purposes, it would be soooooo\nmuch easier to set the origin point as the bottom-left corner, but that’s just\nnot how SVG does it, and frankly, SVG is pretty indifferent about our feelings\non the matter.\n\nGiven that our bars do have to “grow down from the top,” then where is “the\ntop” of each bar in relationship to the top of the SVG? Well, the top of each\nbar could be expressed as a relationship between the height of the SVG and the\ncorresponding data value, as in:\n\n    \n    \n    .attr(\"y\", function(d) {\n        return h - d;  //Height minus data value\n    })\n\nThen, to put the “bottom” of the bar on the bottom of the SVG (see [Figure\n6-24](part0010_split_004.html#Growing_down_from_above)), each `rect`’s height\ncan be just the data value itself:\n\n    \n    \n    .attr(\"height\", function(d) {\n        return d;  //Just the data value\n    });\n\n![Growing down from above](../images/00068.jpeg)\n\nFigure 6-24. Growing down from above\n\nLet’s scale things up a bit by changing `d` to `d * 4`, with the result shown\nin [Figure 6-25](part0010_split_004.html#Growing_bigger_from_above). (Just as\nwith the bar placements, this can be done more properly using D3 scales, but\nwe’re not there yet.)\n\n![Growing bigger from above](../images/00069.gif)\n\nFigure 6-25. Growing bigger from above\n\nThe working code for our growing-down-from-above, SVG bar chart is in\n_17_making_a_bar_chart_heights.html_.\n\n### Color\n\nAdding color is easy. Just use `attr()` to set a `fill`:\n\n    \n    \n    .attr(\"fill\", \"teal\");\n\nFind the all-teal bar chart shown in [Figure\n6-26](part0010_split_004.html#Teal_bars) in _18_making_a_bar_chart_teal.html_.\n\n![Teal bars](../images/00070.gif)\n\nFigure 6-26. Teal bars\n\nTeal is nice, but you’ll often want a shape’s color to reflect some quality of\nthe data. That is, you might want to _encode_ the data values as color. (In\nthe case of our bar chart, that makes a _dual encoding_ , in which the same\ndata value is encoded in two different visual properties: both height and\ncolor.)\n\nUsing data to drive color is as easy as writing a custom function that again\nreferences `d`. Here, we replace `\"teal\"` with a custom function, resulting in\nthe chart in [Figure 6-27](part0010_split_004.html#Datadriven_blue_bars):\n\n    \n    \n    .attr(\"fill\", function(d) {\n        return \"rgb(0, 0, \" + (d * 10) + \")\";\n    });\n\n![Data-driven blue bars](../images/00071.gif)\n\nFigure 6-27. Data-driven blue bars\n\nSee the code in _19_making_a_bar_chart_blues.html_. This is not a particularly\nuseful visual encoding, but you can get the idea of how to translate data into\ncolor. Here, `d` is multiplied by 10, and then used as the blue value in an\n`rgb()` color definition. So the greater values of `d` (taller bars) will be\nmore blue. Smaller values of `d` (shorter bars) will be less blue (closer to\nblack). The red and green components of the color are fixed at zero.\n\n* * *\n\n### Multivalue Maps\n\nYou might have noticed we now have a total of _five_ different calls to\n`attr()` in the chain, one each to specify the bars’ `x`, `y`, `width`,\n`height`, and `fill` values.\n\nIf you get tired of typing `attr()` over and over again, you might appreciate\nD3’s support for [_multivalue maps_](http://bl.ocks.org/3305515), with which\nyou can set multiple attribute values using a single `attr()` statement. For\nexample, to move a circle to the top-left corner of the SVG and make it red, I\ncould use separate `attr()` statements:\n\n    \n    \n    svg.select(\"circle\")\n       .attr(\"cx\", 0)\n       .attr(\"cy\", 0)\n       .attr(\"fill\", \"red\");\n\nor I could define all three of these attributes and their values within a\nsingle object, which is then relayed to a single `attr()` statement:\n\n    \n    \n    svg.select(\"circle\")\n       .attr({\n            cx: 0,\n            cy: 0,\n            fill: red\n       });\n\nThe resulting code is more concise, and if you’ve used jQuery, this syntax of\ntucking property/value pairs into objects might already be familiar. The\n_value_ portion of each pair can include anonymous functions, referencing `d`\nand `i` to generate dynamic values, per usual. We could rewrite our bar-\ncreation code thus far using multivalue maps as:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       .attr({\n            x: function(d, i) { return i * (w / dataset.length); },\n            y: function(d) { return h - (d * 4); },\n            width: w / dataset.length - barPadding,\n            height: function(d) { return d * 4; },\n            fill: function(d) { return \"rgb(0, 0, \" + (d * 10) + \")\"; }\n       });\n\nIf you like this sort of thing, you’ll be happy to know it also works with\n`style()` and [a few other methods](http://bl.ocks.org/3305515). Throughout\nthis book, I’ve used the more verbose structure of individual attribute\nstatements, but it’s always good to know you have options.\n\n* * *\n\n### Labels\n\nVisuals are great, but sometimes you need to show the actual data values as\ntext within the visualization. Here’s where value labels come in, and they are\nvery, very easy to generate with D3.\n\nYou’ll recall from the SVG primer that you can add `text` elements to an SVG\nelement. Let’s start with:\n\n    \n    \n    svg.selectAll(\"text\")\n       .data(dataset)\n       .enter()\n       .append(\"text\")\n\nLook familiar? Just as we did for the `rect`s, here we do for the `text`s.\nFirst, select what you want, bring in the data, enter the new elements (which\nare just placeholders at this point), and finally append the new `text`\nelements to the DOM.\n\nWe’ll extend that code to include a data value within each `text` element by\nusing the `text()` method:\n\n    \n    \n       .text(function(d) {\n            return d;\n       })\n\nand then extend it further, by including `x` and `y` values to position the\ntext. It’s easiest if I just copy and paste the same x/y code we previously\nused for the bars:\n\n    \n    \n       .attr(\"x\", function(d, i) {\n            return i * (w / dataset.length);\n       })\n       .attr(\"y\", function(d) {\n            return h - (d * 4);\n       });\n\nAha! Value labels! But some are getting cut off at the top (see [Figure\n6-28](part0010_split_004.html#Baby_value_labels)).\n\n![Baby value labels!](../images/00072.jpeg)\n\nFigure 6-28. Baby value labels!\n\nLet’s try moving them down, inside the bars, by adding a small amount to the\n`x` and `y` calculations:\n\n    \n    \n       .attr(\"x\", function(d, i) {\n            return i * (w / dataset.length) + 5;  // +5\n       })\n       .attr(\"y\", function(d) {\n            return h - (d * 4) + 15;              // +15\n       });\n\nThe chart in [Figure 6-29](part0010_split_004.html#Inbar_value_labels) is\nbetter, but not legible.\n\n![In-bar value labels](../images/00073.gif)\n\nFigure 6-29. In-bar value labels\n\nFortunately, we can fix that:\n\n    \n    \n       .attr(\"font-family\", \"sans-serif\")\n       .attr(\"font-size\", \"11px\")\n       .attr(\"fill\", \"white\");\n\nFantasti-code! See _20_making_a_bar_chart_labels.html_ for the brilliant\nvisualization shown in [Figure\n6-30](part0010_split_004.html#Really_nice_value_labels).\n\n![Really nice value labels](../images/00074.jpeg)\n\nFigure 6-30. Really nice value labels\n\nIf you are not typographically obsessive, then you’re all done. If, however,\nyou are like me, you’ll notice that the value labels aren’t perfectly aligned\nwithin their bars. (For example, note the “5” in the first column.) That’s\neasy enough to fix. Let’s use the SVG `text-anchor` attribute to center the\ntext horizontally at the assigned `x` value:\n\n    \n    \n        .attr(\"text-anchor\", \"middle\")\n\nThen, let’s change the way we calculate the `x` position by setting it to the\nleft edge of each bar _plus_ half the bar width:\n\n    \n    \n        .attr(\"x\", function(d, i) {\n            return i * (w / dataset.length) + (w / dataset.length - barPadding) / 2;\n        })\n\nAnd I’ll also bring the labels up one pixel for perfect spacing, as you can\nsee in [Figure 6-31](part0010_split_004.html#Centered_labels) and\n_21_making_a_bar_chart_aligned.html_ :\n\n    \n    \n        .attr(\"y\", function(d) {\n            return h - (d * 4) + 14;  //15 is now 14\n        })\n\n![Centered labels](../images/00075.jpeg)\n\nFigure 6-31. Centered labels\n\n\n## Making a Scatterplot\n\nSo far, we’ve drawn only bar charts with simple data — just one-dimensional\nsets of numbers.\n\nBut when you have two sets of values to plot against each other, you need a\nsecond dimension. The scatterplot is a common type of visualization that\nrepresents two sets of corresponding values on two different axes: horizontal\nand vertical, x and y.\n\n### The Data\n\nAs you saw in [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), you have a\nlot of flexibility around how to structure a dataset. For our scatterplot, I’m\ngoing to use an array of arrays. The primary array will contain one element\nfor each data “point.” Each of those “point” elements will be another array,\nwith just two values: one for the x value, and one for y:\n\n    \n    \n    var dataset = [\n                    [5, 20], [480, 90], [250, 50], [100, 33], [330, 95],\n                    [410, 12], [475, 44], [25, 67], [85, 21], [220, 88]\n                  ];\n\nRemember, `[]` means array, so nested hard brackets `[[]]` indicate an array\nwithin another array. We separate array elements with commas, so an array\ncontaining three other arrays would look like this: `[[],[],[]]`.\n\nWe could rewrite our dataset with more whitespace so it’s easier to read:\n\n    \n    \n    var dataset = [\n                      [ 5,     20 ],\n                      [ 480,   90 ],\n                      [ 250,   50 ],\n                      [ 100,   33 ],\n                      [ 330,   95 ],\n                      [ 410,   12 ],\n                      [ 475,   44 ],\n                      [ 25,    67 ],\n                      [ 85,    21 ],\n                      [ 220,   88 ]\n                  ];\n\nNow you can see that each of these 10 rows will correspond to one point in our\nvisualization. With the row `[5, 20]`, for example, we’ll use `5` as the x\nvalue, and `20` for the y.\n\n### The Scatterplot\n\nLet’s carry over most of the code from our bar chart experiments, including\nthe piece that creates the SVG element:\n\n    \n    \n    //Create SVG element\n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)\n                .attr(\"height\", h);\n\nInstead of creating `rect`s, however, we’ll make a `circle` for each data\npoint:\n\n    \n    \n    svg.selectAll(\"circle\")  // <-- No longer \"rect\"\n       .data(dataset)\n       .enter()\n       .append(\"circle\")     // <-- No longer \"rect\"\n\nAlso, instead of specifying the `rect` attributes of `x`, `y`, `width`, and\n`height`, our `circle`s need `cx`, `cy`, and `r`:\n\n    \n    \n       .attr(\"cx\", function(d) {\n            return d[0];\n       })\n       .attr(\"cy\", function(d) {\n            return d[1];\n       })\n       .attr(\"r\", 5);\n\nSee the working scatterplot code that recreates the result shown in [Figure\n6-32](part0010_split_005.html#Simple_scatterplot) in _22_scatterplot.html_.\n\n![Simple scatterplot](../images/00076.jpeg)\n\nFigure 6-32. Simple scatterplot\n\nNotice how we access the data values and use them for the `cx` and `cy`\nvalues. When using `function(d)`, D3 automatically hands off the current data\nvalue as `d` to your function. In this case, the current data value is one of\nthe smaller, subarrays in our larger `dataset` array.\n\nWhen each single datum `d` is itself an array of values (and not just a single\nvalue, like `3.14159`), you need to use bracket notation to access its values.\nHence, instead of `return d`, we use `return d[0]` and `return d[1]`, which\nreturn the first and second values of the array, respectively.\n\nFor example, in the case of our first data point `[5, 20]`, the first value\n(array position `0`) is `5`, and the second value (array position `1`) is\n`20`. Thus:\n\n    \n    \n    d[0] returns 5\n    d[1] returns 20\n\nBy the way, if you ever want to access any value in the larger dataset\n(outside of D3, say), you can do so using bracket notation. For example:\n\n    \n    \n    dataset[5] returns [410, 12]\n\nYou can even use multiple sets of brackets to access values within nested\narrays:\n\n    \n    \n    dataset[5][1] returns 12\n\nDon’t believe me? Take another look at the scatterplot page\n_22_scatterplot.html_ , open your JavaScript console, type in **`dataset[5]`**\nor **`dataset[5][1]`** , and see what happens.\n\n### Size\n\nMaybe you want the circles to be different sizes, so each circle’s area\ncorresponds to its y value. As a general rule, when visualizing quantitative\nvalues with circles, make sure to encode the values as _area_ , not as a\ncircle’s _radius_. Perceptually, we understand the overall amount of “ink” or\npixels to reflect the data value. A common mistake is to map the value to the\nradius. (I’ve done this many times myself.) Mapping to the radius is easier to\ndo, as it requires less math, but the result will visually distort your data.\n\nYet when creating SVG circles, we can’t specify an `area` value; we have to\ncalculate the radius `r` and then set that. So, starting with a data value as\narea, how do we get to a radius value?\n\nYou might remember that the area of a circle equals π times the radius\nsquared, or A = πr2.\n\nLet’s say the area, then, is our data value, which is `d[1]`, in this case.\nActually, let’s subtract that value from `h`, so the circles at the top are\nlarger. So our _area_ value is `h - d[1]`. (We’ll cover a cleaner way to\nachieve this effect using scales in [Chapter\n7](part0011_split_000.html#AFM62-8a8b0c18aaaf4f5c9d772f6d0c5087fc).)\n\nTo convert this area to a radius value, we simply have to take its square\nroot. We can do that using JavaScript’s built-in `Math.sqrt()` function, as in\n`Math.sqrt(h - d[1])`.\n\nNow, instead of setting all `r` values to the static value of `5`, try:\n\n    \n    \n    .attr(\"r\", function(d) {\n        return Math.sqrt(h - d[1]);\n    });\n\nSee _23_scatterplot_sqrt.html_ for the code that results in the scatterplot\nshown in [Figure\n6-33](part0010_split_005.html#Scatterplot_with_sized_circles).\n\n![Scatterplot with sized circles](../images/00077.jpeg)\n\nFigure 6-33. Scatterplot with sized circles\n\nAfter arbitrarily subtracting the datum’s y value `d[1]` from the SVG height\n`h`, and then taking the square root, we see that circles with greater y\nvalues (those circles lower down) have smaller areas (and shorter radii).\n\nThis particular use of circle area as a visualization tool isn’t necessarily\nuseful. I simply want to illustrate how you can use `d`, along with bracket\nnotation, to reference an individual datum, apply some transformation to that\nvalue, and use the newly calculated value to _return_ a value back to the\nattribute-setting method (a value used for `r`, in this case).\n\n### Labels\n\nLet’s label our data points with `text` elements. I’ll adapt the label code\nfrom our bar chart experiments, starting with the following:\n\n    \n    \n    svg.selectAll(\"text\")  // <-- Note \"text\", not \"circle\" or \"rect\"\n       .data(dataset)\n       .enter()\n       .append(\"text\")     // <-- Same here!\n\nThis looks for all `text` elements in the SVG (there aren’t any yet), and then\nappends a new `text` element for each data point. Then we use the `text()`\nmethod to specify each element’s contents:\n\n    \n    \n       .text(function(d) {\n            return d[0] + \",\" + d[1];\n       })\n\nThis looks messy, but bear with me. Once again, we’re using `function(d)` to\naccess each data point. Then, within the function, we’re using _both_ `d[0]`\n_and_ `d[1]` to get both values within that data point array.\n\nThe plus `+` symbols, when used with strings, such as the comma between\nquotation marks `\",\"`, act as _append_ operators. So what this one line of\ncode is really saying is this: get the values of `d[0]` and `d[1]` and smush\nthem together with a comma in the middle. The end result should be something\nlike `5,20` or `25,67`.\n\nNext, we specify _where_ the text should be placed with `x` and `y` values.\nFor now, let’s just use `d[0]` and `d[1]`, the same values that we used to\nspecify the `circle` positions:\n\n    \n    \n       .attr(\"x\", function(d) {\n            return d[0];\n       })\n       .attr(\"y\", function(d) {\n            return d[1];\n       })\n\nFinally, add a bit of font styling with:\n\n    \n    \n       .attr(\"font-family\", \"sans-serif\")\n       .attr(\"font-size\", \"11px\")\n       .attr(\"fill\", \"red\");\n\nThe result in [Figure 6-34](part0010_split_005.html#Scatterplot_with_labels)\nmight not be pretty, but we got it working! See _24_scatterplot_labels.html_\nfor the latest.\n\n![Scatterplot with labels](../images/00078.jpeg)\n\nFigure 6-34. Scatterplot with labels\n\n\n## Next Steps\n\nHopefully, some core concepts of D3 are becoming clear: loading data,\ngenerating new elements, and using data values to derive attribute values for\nthose elements.\n\nYet the image in [Figure\n6-34](part0010_split_005.html#Scatterplot_with_labels) is barely passable as a\ndata visualization. The scatterplot is hard to read, and the code doesn’t use\nour data flexibly. To be honest, we haven’t yet improved on — gag — Excel’s\n_Chart Wizard!_\n\nNot to worry: D3 is way cooler than Chart Wizard (not to mention Clippy), but\ngenerating a shiny, interactive chart involves taking our D3 skills to the\nnext level. To use data flexibly, we’ll learn about D3’s _scales_ in the next\nchapter. And to make our scatterplot easier to read, we’ll learn about _axis\ngenerators_ and axis labels.\n\nThis would be a good time to take a break and stretch your legs. Maybe go for\na walk, or grab a coffee or a sandwich. I’ll hang out here (if you don’t\nmind), and when you get back, we’ll jump into D3 scales!\n\n\n## Chapter 7. Scales\n\n“Scales are functions that map from an input domain to an output range.”\n\nThat’s [Mike Bostock’s definition of D3\nscales](https://github.com/mbostock/d3/wiki/Quantitative-Scales), and there is\nno clearer way to say it.\n\nThe values in any dataset are unlikely to correspond exactly to pixel\nmeasurements for use in your visualization. Scales provide a convenient way to\nmap those data values to new values useful for visualization purposes.\n\nD3 scales are _functions_ with parameters that you define. Once they are\ncreated, you call the `scale` function, pass it a data value, and it nicely\nreturns a scaled output value. You can define and use as many scales as you\nlike.\n\nIt might be tempting to think of a scale as something that appears visually in\nthe final image — like a set of tick marks, indicating a progression of\nvalues. _Do not be fooled!_ Those tick marks are part of an _axis_ , which is\na _visual representation_ of a scale. A scale is a mathematical relationship,\nwith no direct visual output. I encourage you to think of scales and axes as\ntwo different, yet related, elements.\n\nThis chapter addresses only\n[_linear_](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-\nlinear) scales, because they are most common and easiest understood. Once you\nunderstand linear scales, the others — ordinal, logarithmic, square root, and\nso on — will be a piece of cake.\n\n\n## Apples and Pixels\n\nImagine that the following dataset represents the number of apples sold at a\nroadside fruit stand each month:\n\n    \n    \n    var dataset = [ 100, 200, 300, 400, 500 ];\n\nFirst of all, this is great news, as the stand is selling 100 additional\napples each month! Business is booming. To showcase this success, you want to\nmake a bar chart illustrating the steep upward climb of apple sales, with each\ndata value corresponding to the height of one bar.\n\nUntil now, we’ve used data values directly as display values, ignoring unit\ndifferences. So if 500 apples were sold, the corresponding bar would be 500\npixels tall.\n\nThat could work, but what about next month, when 600 apples are sold? And a\nyear later, when 1,800 apples are sold? Your audience would have to purchase\never-larger displays just to be able to see the full height of those very tall\napple bars! (Mmm, apple bars!)\n\nThis is where scales come in. Because apples are not pixels (which are also\nnot oranges), we need scales to translate between them.\n\n\n## Domains and Ranges\n\nA scale’s _input domain_ is the range of possible input data values. Given the\npreceding apples data, appropriate input domains would be either 100 and 500\n(the minimum and maximum values of the dataset) or 0 and 500.\n\nA scale’s _output range_ is the range of possible output values, commonly used\nas display values in pixel units. The output range is completely up to you, as\nthe information designer. If you decide the shortest apple bar will be 10\npixels tall, and the tallest will be 350 pixels tall, then you could set an\noutput range of 10 and 350.\n\nFor example, create a scale with an input domain of `[100,500]` and an output\nrange of `[10,350]`. If you handed the low input value of `100` to that scale,\nit would return its lowest range value, `10`. If you gave it `500`, it would\nspit back `350`. If you gave it `300`, it would hand `180` back to you on a\nsilver platter. (`300` is in the center of the domain, and `180` is in the\ncenter of the range.)\n\nWe can visualize the domain and range as corresponding axes, side-by-side,\ndisplayed in [Figure 7-1](part0011_split_002.html#input_output_axes).\n\n![An input domain and an output range, visualized as parallel\naxes](../images/00079.jpeg)\n\nFigure 7-1. An input domain and an output range, visualized as parallel axes\n\nOne more thing: to prevent your brain from mixing up the _input domain_ and\n_output range_ terminology, I’d like to propose a little exercise. When I say\n“input,” you say “domain.” Then I say “output,” and you say “range.” Ready?\nOkay:\n\n> Input! Domain!\n\n> Output! Range!\n\n> Input! Domain!\n\n> Output! Range!\n\nGot it? Great.\n\n\n## Normalization\n\nIf you’re familiar with the concept of _normalization_ , it might be helpful\nto know that, with a linear scale, that’s all that is really going on here.\n\nNormalization is the process of mapping a numeric value to a new value between\n0 and 1, based on the possible minimum and maximum values. For example, with\n365 days in the year, day number 310 maps to about 0.85, or 85 percent of the\nway through the year.\n\nWith linear scales, we are just letting D3 handle the math of the\nnormalization process. The input value is normalized according to the domain,\nand then the normalized value is scaled to the output range.\n\n\n## Creating a Scale\n\nD3’s scale function generators are accessed with `d3.scale` followed by the\ntype of scale you want. I recommend opening up the sample code page\n_01_scale_test.html_ and typing each of the following into the console:\n\n    \n    \n    var scale = d3.scale.linear();\n\nCongratulations! Now `scale` is a function to which you can pass input values.\n(Don’t be misled by the `var`. Remember that in JavaScript, variables can\nstore functions.)\n\n    \n    \n    scale(2.5);  //Returns 2.5\n\nBecause we haven’t set a domain and a range yet, this function will map input\nto output on a 1:1 scale. That is, whatever we input will be returned\nunchanged.\n\nWe can set the scale’s input domain to `100,500` by passing those values to\nthe `domain()` method as an array. Note the hard brackets indicating an array:\n\n    \n    \n    scale.domain([100, 500]);\n\nSet the output range in similar fashion, with `range()`:\n\n    \n    \n    scale.range([10, 350]);\n\nThese steps can be done separately, as just shown, or chained together into\none line of code:\n\n    \n    \n    var scale = d3.scale.linear()\n                        .domain([100, 500])\n                        .range([10, 350]);\n\nEither way, our scale is ready to use!\n\n    \n    \n    scale(100);  //Returns 10\n    scale(300);  //Returns 180\n    scale(500);  //Returns 350\n\nTypically, you will call scale functions from within an `attr()` method or\nsimilar, not on their own. Let’s modify our scatterplot visualization to use\ndynamic scales.\n\n\n## Scaling the Scatterplot\n\nTo revisit our dataset from the scatterplot:\n\n    \n    \n    var dataset = [\n                    [5, 20], [480, 90], [250, 50], [100, 33], [330, 95],\n                    [410, 12], [475, 44], [25, 67], [85, 21], [220, 88]\n                  ];\n\nYou’ll recall that this `dataset` is an array of arrays. We mapped the first\nvalue in each array onto the x-axis, and the second value onto the y-axis.\nLet’s start with the x-axis.\n\nJust by eyeballing the x values, it looks like they range from 5 to 480, so a\nreasonable input domain to specify might be `0,500`, right?\n\nWhy are you giving me that look? Oh, because you want to keep your code\nflexible and scalable, so it will continue to work even if the data changes in\nthe future. Very smart! Remember, if we were building a data dashboard for the\nroadside apple stand, we’d want our code to accommodate the enormous projected\ngrowth in apple sales. Our chart should work just as well with 5 apples sold\nas 5 million.\n\n### d3.min() and d3.max()\n\nInstead of specifying fixed values for the domain, we can use the convenient\narray functions `d3.min()` and `d3.max()` to analyze our data set on the fly.\nFor example, this loops through each of the x values in our arrays and returns\nthe value of the greatest one:\n\n    \n    \n    d3.max(dataset, function(d) {\n        return d[0];  //References first value in each subarray\n    });\n\nThat code will return the value 480, because 480 is the largest x value in our\ndataset. Let me explain how it works.\n\nBoth `min()` and `max()` work the same way, and they can take either one or\ntwo arguments. The first argument must be a reference to the array of values\nyou want evaluated, which is `dataset`, in this case. If you have a simple,\none-dimensional array of numeric values, like `[7, 8, 4, 5, 2]`, then it’s\nobvious how to compare the values against each other, and no second argument\nis needed. For example:\n\n    \n    \n    var simpleDataset = [7, 8, 4, 5, 2];\n    d3.max(simpleDataset);  // Returns 8\n\nThe `max()` function simply loops through each value in the array, and\nidentifies the largest one.\n\nBut our `dataset` is not just an array of numbers; it is an array of arrays.\nCalling `d3.max(dataset)` might produce unexpected results:\n\n    \n    \n    var dataset = [\n                    [5, 20], [480, 90], [250, 50], [100, 33], [330, 95],\n                    [410, 12], [475, 44], [25, 67], [85, 21], [220, 88]\n                  ];\n    d3.max(dataset);  // Returns [85, 21].  What???\n\nTo tell `max()` which _specific_ values we want compared, we must include a\nsecond argument, an _accessor function_ :\n\n    \n    \n    d3.max(dataset, function(d) {\n        return d[0];\n    });\n\nThe accessor function is an anonymous function to which `max()` hands off each\nvalue in the data array, one at a time, as `d`. The accessor function\nspecifies _how to access_ the value to be used for the comparison. In this\ncase, our data array is `dataset`, and we want to compare only the x values,\nwhich are the first values in each subarray, meaning in position `[0]`. So our\naccessor function looks like this:\n\n    \n    \n    function(d) {\n        return d[0];  //Return the first value in each subarray\n    }\n\nNote that this looks suspiciously similar to the syntax we used when\ngenerating our scatterplot circles, which also used anonymous functions to\nretrieve and return values:\n\n    \n    \n    .attr(\"cx\", function(d) {\n        return d[0];\n    })\n    .attr(\"cy\", function(d) {\n        return d[1];\n    })\n\nThis is a common D3 pattern. Soon you will be very comfortable with all manner\nof anonymous functions crawling all over your code.\n\n### Setting Up Dynamic Scales\n\nPutting together what we’ve covered, let’s create the scale function for our\nx-axis:\n\n    \n    \n    var xScale = d3.scale.linear()\n                         .domain([0, d3.max(dataset, function(d) { return d[0]; })])\n                         .range([0, w]);\n\nFirst, notice that I named it `xScale`. Of course, you can name your scales\nwhatever you want, but a name like `xScale` helps me remember what this\nfunction does.\n\nSecond, notice that both the domain and range are specified as two-value\narrays in hard brackets.\n\nThird, notice that I set the low end of the input domain to 0. (Alternatively,\nyou could use `min()` to calculate a dynamic value.) The upper end of the\ndomain is set to the maximum value in `dataset` (which is currently 480, but\ncould change in the future).\n\nFinally, observe that the output range is set to `0` and `w`, the SVG’s width.\n\nWe’ll use very similar code to create the scale function for the y-axis:\n\n    \n    \n    var yScale = d3.scale.linear()\n                         .domain([0, d3.max(dataset, function(d) { return d[1]; })])\n                         .range([0, h]);\n\nNote that the `max()` function here references `d[1]`, the y value of each\nsubarray. Also, the upper end of `range()` is set to `h` instead of `w`.\n\nThe scale functions are in place! Now all we need to do is use them.\n\n### Incorporating Scaled Values\n\nRevisiting our scatterplot code, we now simply modify the original line where\nwe created a `circle` for each data value:\n\n    \n    \n    .attr(\"cx\", function(d) {\n        return d[0];  //Returns original value bound from dataset\n    })\n\nto return a scaled value (instead of the original value):\n\n    \n    \n    .attr(\"cx\", function(d) {\n        return xScale(d[0]);  //Returns scaled value\n    })\n\nLikewise, for the y-axis, this:\n\n    \n    \n    .attr(\"cy\", function(d) {\n        return d[1];\n    })\n\nis modified as:\n\n    \n    \n    .attr(\"cy\", function(d) {\n        return yScale(d[1]);\n    })\n\nFor good measure, let’s make the same change where we set the coordinates for\nthe text labels, so these lines:\n\n    \n    \n    .attr(\"x\", function(d) {\n        return d[0];\n    })\n    .attr(\"y\", function(d) {\n        return d[1];\n    })\n\nbecome this:\n\n    \n    \n    .attr(\"x\", function(d) {\n        return xScale(d[0]);\n    })\n    .attr(\"y\", function(d) {\n        return yScale(d[1]);\n    })\n\nAnd there we are!\n\nCheck out the working code in _02_scaled_plot.html_. Visually, the result in\n[Figure 7-2](part0011_split_005.html#Scatterplot_using_x_and_y_scales) is\ndisappointingly similar to our original scatterplot! Yet we are making more\nprogress than might be apparent.\n\n![Scatterplot using x and y scales](../images/00080.jpeg)\n\nFigure 7-2. Scatterplot using x and y scales\n\n\n## Refining the Plot\n\nYou might have noticed that smaller y values are at the top of the plot, and\nthe larger y values are toward the bottom. Now that we’re using D3 scales,\nit’s super easy to reverse that, so greater values are higher up, as you would\nexpect. It’s just a matter of changing the output range of `yScale` from:\n\n    \n    \n    .range([0, h]);\n\nto:\n\n    \n    \n    .range([h, 0]);\n\nSee _03_scaled_plot_inverted.html_ for the code that results in [Figure\n7-3](part0011_split_006.html#Scatterplot_with_y_scale_inverted).\n\n![Scatterplot with y scale inverted](../images/00081.jpeg)\n\nFigure 7-3. Scatterplot with y scale inverted\n\nYes, now a _smaller_ input to `yScale` will produce a _larger_ output value,\nthereby pushing those `circle`s and `text` elements down, closer to the base\nof the image. I know, it’s almost too easy!\n\nYet some elements are getting cut off. Let’s introduce a `padding` variable:\n\n    \n    \n    var padding = 20;\n\nThen we’ll incorporate the `padding` amount when setting the range of both\nscales. This will help push our elements in, away from the edges of the SVG,\nto prevent them from being clipped.\n\nThe range for `xScale` was `range([0, w])`, but now it’s:\n\n    \n    \n    .range([padding, w - padding]);\n\nThe range for `yScale` was `range([h, 0])`, but now it’s:\n\n    \n    \n    .range([h - padding, padding]);\n\nThis should provide us with 20 pixels of extra room on the left, right, top,\nand bottom edges of the SVG. And it does (see [Figure\n7-4](part0011_split_006.html#Scatterplot_with_padding))!\n\n![Scatterplot with padding](../images/00082.jpeg)\n\nFigure 7-4. Scatterplot with padding\n\nBut the text labels on the far right are still getting cut off, so I’ll double\nthe amount of `xScale`’s padding on the right side by multiplying by two to\nachieve the result shown in [Figure\n7-5](part0011_split_006.html#Scatterplot_with_more_padding):\n\n    \n    \n    .range([padding, w - padding * 2]);\n\n![Scatterplot with more padding](../images/00083.jpeg)\n\nFigure 7-5. Scatterplot with more padding\n\n* * *\n\n### Tip\n\nThe way I’ve introduced padding here is simple, but not elegant. Eventually,\nyou’ll want more control over how much padding is on each side of your charts\n(top, right, bottom, left), and it’s useful to standardize how you specify\nthose values across projects. Although I haven’t used [Mike Bostock’s margin\nconvention](http://bl.ocks.org/3019563) for the code samples in this book, I\nrecommend taking a look to see if it could work for you.\n\n* * *\n\nBetter! Reference the code so far in _04_scaled_plot_padding.html_. But\nthere’s one more change I’d like to make. Instead of setting the radius of\neach `circle` as the square root of its y value (which was a bit of a hack,\nand not visually useful), why not create another custom scale?\n\n    \n    \n    var rScale = d3.scale.linear()\n                         .domain([0, d3.max(dataset, function(d) { return d[1]; })])\n                         .range([2, 5]);\n\nThen, setting the radius looks like this:\n\n    \n    \n    .attr(\"r\", function(d) {\n        return rScale(d[1]);\n    });\n\nThis is exciting because we are guaranteeing that our radius values will\n_always_ fall within the range of `2,5`. (Or _almost_ always; see reference to\n`clamp()` later.) So data values of `0` (the minimum input) will get circles\nof radius `2` (or a diameter of 4 pixels). The very largest data value will\nget a circle of radius `5` (diameter of 10 pixels).\n\nVoila: [Figure 7-6](part0011_split_006.html#Scatterplot_with_scaled_radii)\nshows our first scale used for a visual property other than an axis value.\n(See _05_scaled_plot_radii.html_.)\n\n![Scatterplot with scaled radii](../images/00084.jpeg)\n\nFigure 7-6. Scatterplot with scaled radii\n\nFinally, just in case the power of scales hasn’t yet blown your mind, I’d like\nto add one more array to the dataset: `[600, 150]`.\n\nBoom! Check out _06_scaled_plot_big.html_. Notice how all the old points in\n[Figure 7-7](part0011_split_006.html#Scatterplot_with_big_numbers_added)\nmaintained their relative positions but have migrated closer together, down\nand to the left, to accommodate the newcomer in the top-right corner.\n\n![Scatterplot with big numbers added](../images/00085.jpeg)\n\nFigure 7-7. Scatterplot with big numbers added\n\nAnd now, one final revelation: we can now very easily change the size of our\nSVG, and _everything scales accordingly_. In [Figure\n7-8](part0011_split_006.html#Large_scaled_scatterplot), I’ve increased the\nvalue of `h` from `100` to `300` and made _no other changes_.\n\n![Large, scaled scatterplot](../images/00086.jpeg)\n\nFigure 7-8. Large, scaled scatterplot\n\nBoom, again! See _07_scaled_plot_large.html_. Hopefully, you are seeing this\nand realizing: no more late nights tweaking your code because the client\ndecided the graphic should be 800 pixels wide instead of 600. Yes, you will\nget more sleep because of me (and D3’s brilliant built-in methods). Being\nwell-rested is a competitive advantage. You can thank me later.\n\n\n## Other Methods\n\n`d3.scale.linear()` has several other handy methods that deserve a brief\nmention here:\n\n[`nice()`](http://bit.ly/ZR9Si0)\n\n> This tells the scale to take whatever input domain that you gave to\n> `range()` and expand both ends to the nearest round value. From the D3 wiki:\n> “For example, for a domain of [0.20147987687960267, 0.996679553296417], the\n> nice domain is [0.2, 1].” This is useful for normal people, who are not\n> computers and find it hard to read numbers like 0.20147987687960267.\n\n[`rangeRound()`](http://bit.ly/Z2ZLke)\n\n> Use `rangeRound()` in place of `range()`, and all values output by the scale\n> will be rounded to the nearest whole number. This is useful if you want\n> shapes to have exact pixel values, to avoid the fuzzy edges that could arise\n> with antialiasing.\n\n[`clamp()`](http://bit.ly/12h7uTf)\n\n> By default, a linear scale _can_ return values outside of the specified\n> range. For example, if given a value outside of its expected input domain, a\n> scale will return a number also outside of the output range. Calling\n> `clamp(true)` on a scale, however, forces all output values to be within the\n> specified range. This means excessive values will be rounded to the range’s\n> low or high value (whichever is nearest).\n\nTo use any of these special methods, just tack them onto the chain in which\nyou define the original scale function. For example, to use `nice()`:\n\n    \n    \n    var scale = d3.scale.linear()\n                        .domain([0.123, 4.567])\n                        .range([0, 500])\n                        .nice();\n\n\n## Other Scales\n\nIn addition to [`linear`\nscales](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear)\n(discussed earlier), D3 has several other built-in scale methods:\n\n[`sqrt`](http://bit.ly/15ePKWb)\n\n> A square root scale.\n\n[`pow`](http://bit.ly/XBKvuq)\n\n> A power scale (good for the gym, er, I mean, useful when working with\n> exponential series of values, as in “to the power of” some exponent).\n\n[`log`](http://bit.ly/YTuRdX)\n\n> A logarithmic scale.\n\n[`quantize`](http://bit.ly/ZEJXtP)\n\n> A linear scale with discrete values for its output range, for when you want\n> to sort data into “buckets.”\n\n[`quantile`](http://bit.ly/XxlWlr)\n\n> Similar to `quantize`, but with discrete values for its input domain (when\n> you already have “buckets”).\n\n[`ordinal`](http://bit.ly/XWSVvB)\n\n> Ordinal scales use nonquantitative values (like category names) for output;\n> perfect for comparing apples and oranges.\n\n[`d3.scale.category10()`](http://bit.ly/X6O0fT),\n[`d3.scale.category20()`](http://bit.ly/Wn3QPH),\n[`d3.scale.category20b()`](http://bit.ly/13bmamp), and\n[`d3.scale.category20c()`](http://bit.ly/Wn3Saf)\n\n> Handy preset ordinal scales that output either 10 or 20 categorical colors.\n\n[`d3.time.scale()`](http://bit.ly/Xxm6tc)\n\n> A scale method for date and time values, with special handling of ticks for\n> dates.\n\nNow that you have mastered the power of scales, it’s time to express them\nvisually as, yes, _axes_!\n\n\n## Chapter 8. Axes\n\nHaving mastered the use of D3 scales, we now have the scatterplot shown in\n[Figure 8-1](part0012_split_000.html#Large_scaled_scatterplot2).\n\n![Large, scaled scatterplot](../images/00087.jpeg)\n\nFigure 8-1. Large, scaled scatterplot\n\nLet’s add horizontal and vertical axes, so we can do away with the horrible\nred numbers cluttering up our chart.\n\n\n## Introducing Axes\n\nMuch like its scales, [D3’s _axes_](https://github.com/mbostock/d3/wiki/SVG-\nAxes) are actually _functions_ whose parameters you define. Unlike scales,\nwhen an axis function is called, it doesn’t return a value, but generates the\nvisual elements of the axis, including lines, labels, and ticks.\n\nNote that the axis functions are SVG-specific, as they generate SVG elements.\nAlso, axes are intended for use with quantitative scales (as opposed to\nordinal ones).\n\n\n## Setting Up an Axis\n\nUse `d3.svg.axis()` to create a generic axis function:\n\n    \n    \n    var xAxis = d3.svg.axis();\n\nAt a minimum, each axis also needs to be told on what _scale_ to operate. Here\nwe’ll pass in the `xScale` from the scatterplot code:\n\n    \n    \n    xAxis.scale(xScale);\n\nWe can also specify where the labels should appear relative to the axis\nitself. The default is `bottom`, meaning the labels will appear below the axis\nline. (Although this is the default, it can’t hurt to specify it explicitly.)\nPossible orientations for horizontal axes are `top` and `bottom`. For vertical\naxes, use `left` and `right`:\n\n    \n    \n    xAxis.orient(\"bottom\");\n\nOf course, we can be more concise and string all this together into one line:\n\n    \n    \n    var xAxis = d3.svg.axis()\n                      .scale(xScale)\n                      .orient(\"bottom\");\n\nFinally, to actually generate the axis and insert all those little lines and\nlabels into our SVG, we must _call_ the `xAxis` function. This is similar to\nthe scale functions, which we first configured by setting parameters, and then\nlater _called_ , to put them into action.\n\nI’ll put this code at the end of our script, so the axis is generated after\nthe other elements in the SVG, and therefore appears “on top”:\n\n    \n    \n    svg.append(\"g\")\n        .call(xAxis);\n\nThis is where things get a little funky. You might be wondering why this looks\nso different from our friendly scale functions. Here’s why: because an _axis_\nfunction actually draws something to the screen (by appending SVG elements to\nthe DOM), we need to specify _where_ in the DOM it should place those new\nelements. This is in contrast to scale functions like `xScale()`, for example,\nwhich calculate a value and return those values, typically for use by yet\nanother function, without impacting the DOM at all.\n\nSo what we’re doing with the preceding code is to first reference `svg`, the\nSVG image in the DOM. Then, we `append()` a new `g` element to the end of the\nSVG. In SVG land, a `g` element is a _group_ element. Group elements are\ninvisible, unlike `line`, `rect`, and `circle`, and they have no visual\npresence themselves. Yet they help us in two ways: first, `g` elements can be\nused to contain (or “group”) other elements, which keeps our code nice and\ntidy. Second, we can apply _transformations_ to `g` elements, which affects\nhow visual elements within that group (such as `line`s, `rect`s, and\n`circle`s) are rendered. We’ll get to transformations in just a minute.\n\nSo we’ve created a new `g`, and then finally, the function `call()` is called\non our new `g`. So what is `call()`, and who is it calling?\n\n[D3’s `call()` function](https://github.com/mbostock/d3/wiki/Selections#wiki-\ncall) takes the incoming _selection_ , as received from the prior link in the\nchain, and hands that selection off to any _function_. In this case, the\nselection is our new `g` group element. Although the `g` isn’t strictly\nnecessary, we are using it because the axis function is about to generate lots\nof crazy lines and numbers, and it’s nice to contain all those elements within\na single group object. `call()` hands off `g` to the `xAxis` function, so our\naxis is generated _within_ `g`.\n\nIf we were messy people who loved messy code, we could also rewrite the\npreceding snippet as this exact equivalent:\n\n    \n    \n    svg.append(\"g\")\n        .call(d3.svg.axis()\n        .scale(xScale)\n        .orient(\"bottom\"));\n\nSee, you could cram the whole axis function within `call()`, but it’s usually\neasier on our brains to define functions first, then call them later.\n\nIn any case, [Figure 8-2](part0012_split_002.html#Simple_but_ugly_axis) shows\nwhat that looks like. See code example _01_axes.html_.\n\n![Simple, but ugly axis](../images/00088.jpeg)\n\nFigure 8-2. Simple, but ugly axis\n\n\n## Cleaning It Up\n\nTechnically, that is an axis, but it’s neither pretty nor useful. To clean it\nup, let’s first assign a class of `axis` to the new `g` element, so we can\ntarget it with CSS:\n\n    \n    \n    svg.append(\"g\")\n        .attr(\"class\", \"axis\") //Assign \"axis\" class\n        .call(xAxis);\n\nThen, we introduce our first CSS styles, up in the `<head>` of our page:\n\n    \n    \n    .axis path,\n    .axis line {\n        fill: none;\n        stroke: black;\n        shape-rendering: crispEdges;\n    }\n    \n    .axis text {\n        font-family: sans-serif;\n        font-size: 11px;\n    }\n\nSee how useful it is to group all the axis elements within one `g` group? Now\nwe can very easily apply styles to anything within the group using the simple\nCSS selector `.axis`. The axes themselves are made up of `path`, `line`, and\n`text` elements, so those are the three elements that we target in our CSS.\nThe `path`s and `line`s can be styled with the same rules, and `text` gets its\nown rules around font and font size.\n\nYou might notice that when we use CSS rules to style SVG elements, only SVG\nattribute names — not regular CSS properties — should be used. This is\nconfusing, because many properties share the same names in both CSS and SVG,\nbut some do not. For example, in regular CSS, to set the color of some text,\nyou would use the `color` property, as in:\n\n    \n    \n    p {\n        color: olive;\n    }\n\nThat will set the text color of all `p` paragraphs to be `olive`. But try to\napply this property to an SVG element, as with:\n\n    \n    \n    text {\n        color: olive;\n    }\n\nand it will have no effect because `color` is not a property recognized by\nSVG. Instead, you must use SVG’s equivalent, `fill`:\n\n    \n    \n    text {\n        fill: olive;\n    }\n\nIf you ever find yourself trying to style SVG elements, but for some reason\nthe stupid CSS code just isn’t working, I suggest you take a deep breath,\npause, and then review your _property names_ very closely to ensure you’re\nusing SVG names, not CSS ones. (You can reference the complete SVG attribute\nlist on [the MDN site](https://developer.mozilla.org/en-\nUS/docs/SVG/Attribute).)\n\n[The `shape-rendering`\nproperty](https://developer.mozilla.org/en/SVG/Attribute/shape-rendering) is\nanother weird SVG attribute you should know. We use it here to make sure our\naxis and its tick mark lines are pixel-perfect. No blurry axes for us!\n\nThe chart looks like [Figure 8-3](part0012_split_003.html#Cleaner_axis) after\nour CSS clean-up.\n\n![Cleaner axis](../images/00089.jpeg)\n\nFigure 8-3. Cleaner axis\n\nThat’s better, but the top horizontal line of the axis is cut off, and the\naxis itself should be down at the base of the chart anyway. Here’s where SVG\n_transformations_ come in. By adding one line of code, we can `transform` the\nentire axis group, pushing it to the bottom:\n\n    \n    \n    svg.append(\"g\")\n        .attr(\"class\", \"axis\")\n        .attr(\"transform\", \"translate(0,\" + (h - padding) + \")\")\n        .call(xAxis);\n\nNote that we use `attr()` to apply `transform` as an attribute of `g`. [SVG\ntransforms](https://developer.mozilla.org/en-US/docs/SVG/Attribute/transform)\nare quite powerful, and can accept several different kinds of transform\ndefinitions, including scales and rotations. But we are keeping it simple here\nwith only a _translation_ transform, which simply pushes the whole `g` group\nover and down by some amount.\n\nTranslation transforms are specified with the easy syntax of `translate(x,y)`,\nwhere `x` and `y` are, obviously, the number of horizontal and vertical pixels\nby which to translate the element. So, in the end, we would like our `g` to\nlook like this in the DOM:\n\n    \n    \n    <g class=\"axis\" transform=\"translate(0,280)\">\n\nAs you can see, the `g.axis` isn’t moved horizontally at all, but it is pushed\n280 pixels down, conveniently to the base of our chart. We specify as much in\nthis line of code:\n\n    \n    \n        .attr(\"transform\", \"translate(0,\" + (h - padding) + \")\")\n\nNote the use of `(h - padding)`, so the group’s top edge is set to `h`, the\nheight of the entire image, minus the `padding` value we created earlier. `(h\n- padding)` is calculated to be `280`, and then connected to the rest of the\nstring, so the final transform property value is `translate(0,280)`.\n\nThe result in [Figure 8-4](part0012_split_003.html#Nice_clean_axis) is much\nbetter! Check out the code so far in _02_axes_bottom.html_.\n\n![Nice, clean axis](../images/00090.jpeg)\n\nFigure 8-4. Nice, clean axis\n\n\n## Check for Ticks\n\nSome ticks spread disease, but [D3’s\nticks](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-\nlinear_ticks) communicate information. Yet more ticks are not necessarily\nbetter, and at a certain point, they begin to clutter your chart. You’ll\nnotice that we never specified how many ticks to include on the axis, nor at\nwhat intervals they should appear. Without clear instruction, D3 has\nautomagically examined our scale `xScale` and made informed judgments about\nhow many ticks to include, and at what intervals (every 50, in this case).\n\nAs you would expect, you can customize all aspects of your axes, starting with\nthe rough number of ticks, using `ticks()`:\n\n    \n    \n    var xAxis = d3.svg.axis()\n                      .scale(xScale)\n                      .orient(\"bottom\")\n                      .ticks(5);  //Set rough # of ticks\n\nSee _03_axes_clean.html_ for that code.\n\nYou’ll notice in [Figure 8-5](part0012_split_004.html#Fewer_ticks) that,\nalthough we specified only five ticks, D3 has made an executive decision and\nordered up a total of seven. That’s because D3 has got your back, and figured\nout that including only _five_ ticks would require slicing the input domain\ninto less-than-gorgeous values — in this case, 0, 150, 300, 450, and 600. D3\ninteprets the `ticks()` value as merely a suggestion and will override your\nsuggestion with what it determines to be the most clean and human-readable\nvalues — in this case, intervals of 100 — even when that requires including\nslightly more or fewer ticks than you requested. This is actually a totally\nbrilliant feature that increases the scalability of your design; as the\ndataset changes and the input domain expands or contracts (bigger numbers or\nsmaller numbers), D3 ensures that the tick labels remain easy to read.\n\n![Fewer ticks](../images/00091.jpeg)\n\nFigure 8-5. Fewer ticks\n\n\n## Y Not?\n\nTime to label the vertical axis! By copying and tweaking the code we already\nwrote for the `xAxis`, we add this near the top of of our code:\n\n    \n    \n    //Define Y axis\n    var yAxis = d3.svg.axis()\n                      .scale(yScale)\n                      .orient(\"left\")\n                      .ticks(5);\n\nand this, near the bottom:\n\n    \n    \n    //Create Y axis\n    svg.append(\"g\")\n        .attr(\"class\", \"axis\")\n        .attr(\"transform\", \"translate(\" + padding + \",0)\")\n        .call(yAxis);\n\nNote in [Figure 8-6](part0012_split_005.html#Initial_Y_axis) that the labels\nwill be oriented `left` and that the `yAxis` group `g` is translated to the\nright by the amount `padding`.\n\n![Initial y-axis](../images/00092.jpeg)\n\nFigure 8-6. Initial y-axis\n\nThis is starting to look like a real chart! But the `yAxis` labels are getting\ncut off. To give them more room on the left side, I’ll bump up the value of\n`padding` from 20 to 30:\n\n    \n    \n    var padding = 30;\n\nOf course, you could also introduce separate `padding` variables for each\naxis, say `xPadding` and `yPadding`, for more control over the layout.\n\nSee the updated code in _04_axes_y.html_. It looks like [Figure\n8-7](part0012_split_005.html#Scatterplot_with_Y_axis).\n\n![Scatterplot with y-axis](../images/00093.jpeg)\n\nFigure 8-7. Scatterplot with y-axis\n\n\n## Final Touches\n\nI appreciate that so far you have been very quiet and polite, and not at all\nconfrontational. Yet I still feel as though I have to win you over. So to\nprove to you that our new axes are dynamic and scalable, I’d like to switch\nfrom using a static dataset to using randomized numbers:\n\n    \n    \n    //Dynamic, random dataset\n    var dataset = [];\n    var numDataPoints = 50;\n    var xRange = Math.random() * 1000;\n    var yRange = Math.random() * 1000;\n    for (var i = 0; i < numDataPoints; i++) {\n        var newNumber1 = Math.floor(Math.random() * xRange);\n        var newNumber2 = Math.floor(Math.random() * yRange);\n        dataset.push([newNumber1, newNumber2]);\n    }\n\nThis code initializes an empty array, then loops through 50 times, chooses two\nrandom numbers each time, and adds (“pushes”) that pair of values to the\n`dataset` array (see [Figure\n8-8](part0012_split_006.html#Scatterplot_with_random_data)).\n\n![Scatterplot with random data](../images/00094.jpeg)\n\nFigure 8-8. Scatterplot with random data\n\nTry out that randomized dataset code in _05_axes_random.html_. Each time you\nreload the page, you’ll get different data values. Notice how both axes scale\nto fit the new domains, and ticks and label values are chosen accordingly.\n\nHaving made my point, I think we can finally cut those horrible, red labels,\nby commenting out the relevant lines of code.\n\nThe result is shown in [Figure\n8-9](part0012_split_006.html#Scatterplot_with_random_data_and_no_red_labels).\nOur final scatterplot code lives in _06_axes_no_labels.html_.\n\n![Scatterplot with random data and no red labels](../images/00095.jpeg)\n\nFigure 8-9. Scatterplot with random data and no red labels\n\n\n## Formatting Tick Labels\n\nOne last thing: so far, we’ve been working with integers — whole numbers —\nwhich are nice and easy. But data is often messier, and in those cases, you\nmight want more control over how the axis labels are formatted. Enter\n[`tickFormat()`](https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-\nlinear_tickFormat), which enables you to specify how your numbers should be\nformatted. For example, you might want to include three places after the\ndecimal point, or display values as percentages, or both.\n\nTo use `tickFormat()`, first define a new number-formatting function. This\none, for example, says to treat values as percentages with one decimal point\nprecision. That is, if you give this function the number `0.23`, it will\nreturn the string `23.0%`. (See [the reference entry for\n`d3.format()`](https://github.com/mbostock/d3/wiki/Formatting#wiki-d3_format)\nfor more options.)\n\n    \n    \n    var formatAsPercentage = d3.format(\".1%\");\n\nThen, tell your axis to use that formatting function for its ticks, for\nexample:\n\n    \n    \n    xAxis.tickFormat(formatAsPercentage);\n\n* * *\n\n### Tip\n\nI find it easiest to test these formatting functions out in the JavaScript\nconsole. For example, just open any page that loads D3, such as\n_06_axes_no_labels.html_ , and type your format rule into the console. Then\ntest it by feeding it a value, as you would with any other function.\n\nYou can see in [Figure 8-10](part0012_split_007.html#Testing_format_console)\nthat a data value of `0.54321` is converted to `54.3%` for display purposes —\nperfect!\n\n![Testing format\\(\\) in the console](../images/00096.jpeg)\n\nFigure 8-10. Testing format() in the console\n\n* * *\n\nYou can play with that code in _07_axes_format.html_. Obviously, a percentage\nformat doesn’t make sense with our scatterplot’s current dataset, but as an\nexercise, you could try tweaking how the random numbers are generated, to make\nmore appropriate, non-whole number values, or just experiment with the format\nfunction itself.\n\n\n## Chapter 9. Updates, Transitions, and Motion\n\nUntil this point, we have used only static datasets. But real-world data\nalmost always _changes_ over time. And you might want your visualization to\nreflect those changes.\n\nIn D3 terms, those changes are handled by _updates_. The visual adjustments\nare made pretty with _transitions_ , which can employ _motion_ for perceptual\nbenefit.\n\nWe’ll start by generating a visualization with one dataset, and then changing\nthe data completely.\n\n\n## Modernizing the Bar Chart\n\nLet’s revisit our trusty old bar chart in [Figure\n9-1](part0013_split_001.html#The_bar_chart_as_seen_last).\n\n![The bar chart, as seen last](../images/00097.jpeg)\n\nFigure 9-1. The bar chart, as seen last\n\nIf you examine the code in _01_bar_chart.html_ , you’ll see that we used this\nstatic dataset:\n\n    \n    \n    var dataset = [ 5, 10, 13, 19, 21, 25, 22, 18, 15, 13,\n                    11, 12, 15, 20, 18, 17, 16, 18, 23, 25 ];\n\nSince then, we’ve learned how to write more flexible code, so our chart\nelements resize to accommodate different sized datasets (meaning shorter or\nlonger arrays) and different data values (smaller or larger numbers). We\naccomplished that flexibility using D3 scales, so I’d like to start by\nbringing our bar chart up to speed.\n\nReady? Okay, just give me a sec…\n\nAaaaaand, done! Thanks for waiting.\n\n[Figure 9-2](part0013_split_001.html#A_scalable_flexible_bar_chart) looks\npretty similar, but a lot has changed under the hood. You can follow along by\nopening up _02_bar_chart_with_scales.html_.\n\n![A scalable, flexible bar chart](../images/00098.jpeg)\n\nFigure 9-2. A scalable, flexible bar chart\n\nTo start, I adjusted the width and height, to make the chart taller and wider:\n\n    \n    \n    var w = 600;\n    var h = 250;\n\nNext, I introduced an _ordinal scale_ to handle the left/right positioning of\nbars and labels along the x-axis:\n\n    \n    \n    var xScale = d3.scale.ordinal()\n                    .domain(d3.range(dataset.length))\n                    .rangeRoundBands([0, w], 0.05);\n\nThis may seem like gobbledegook, so I’ll walk through it one line at a time.\n\n### Ordinal Scales, Explained\n\nFirst, in this line:\n\n    \n    \n    var xScale = d3.scale.ordinal()\n\nwe declare a new variable called `xScale`, just as we had done with our\nscatterplot. Only here, instead of a _linear_ scale, we create an _ordinal_\none. Ordinal scales are typically used for ordinal data, typically categories\nwith some inherent _order_ to them, such as:\n\n  * freshman, sophomore, junior, senior \n  * grade B, grade A, grade AA \n  * strongly dislike, dislike, neutral, like, strongly like \n\nWe don’t have true ordinal data for use with this bar chart. Instead, we just\nwant the bars to be drawn from left to right using the same order in which\nvalues occur in our dataset. D3’s ordinal scale is useful in this situation,\nwhen we have many visual elements (vertical bars) that are positioned in an\narbitrary order (left to right), but must be evenly spaced. This will become\nclear in a moment.\n\n    \n    \n    .domain(d3.range(dataset.length))\n\nThis next line of code sets the input domain for the scale. Remember how\nlinear scales need a two-value array to set their domains, as in `[0, 100]`?\nFor a linear scale, that array would set the low and high values of the\ndomain. But ordinal domains are, well, ordinal, so they don’t think in linear,\nquantitative terms. To set the domain of an ordinal scale, you typically\nspecify an array with the category names, as in:\n\n    \n    \n    .domain([\"freshman\", \"sophomore\", \"junior\", \"senior\"])\n\nFor our bar chart, we don’t have explicit categories, but we could assign each\ndata point or bar an ID value corresponding to its position within the\n`dataset` array, as in 0, 1, 2, 3, and so on. So perhaps our domain statement\ncould read:\n\n    \n    \n    .domain([0, 1, 2, 3, 4, 5, 6, 7, 8, 9,\n             10, 11, 12, 13, 14, 15, 16, 17, 18, 19])\n\nIt turns out there is a very simple way to quickly generate an array of\nsequential numbers: the `d3.range()` method.\n\nWhile viewing _02_bar_chart_with_scales.html_ , go ahead and open up the\nconsole, and type the following:\n\n    \n    \n    d3.range(10)\n\nYou should see the following output array:\n\n    \n    \n    [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]\n\nHow nice is that? D3 saves you time once again (and the hassle of extra\n`for()` loops).\n\nComing back to our code, it should now be clear what’s happening here:\n\n    \n    \n    .domain(d3.range(dataset.length))\n\n  1. `dataset.length`, in this case, is evaluted as `20`, because we have 20 items in our dataset. \n  2. `d3.range(20)` is then evaluated, which returns this array: `[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]`. \n  3. Finally, `domain()` sets the domain of our new ordinal scale to those values. \n\nThis might be somewhat confusing because we are using numbers (0, 1, 2…) as\nordinal values, but ordinal values are typically nonnumeric.\n\n### Round Bands Are All the Range These Days\n\nThe great thing about `d3.scale.ordinal()` is it supports _range banding_.\nInstead of returning a continuous range, as any quantitative scale (like\n`d3.scale.linear()`) would, ordinal scales use _discrete_ ranges, meaning the\noutput values are determined in advance, and could be numeric or not.\n\nWe could use `range()` like everyone else, _or_ we can be smooth and use\n`rangeBands()`, which takes a low and high value, and automatically divides it\ninto even chunks or “bands,” based on the length of the domain. For example:\n\n    \n    \n    .rangeBands([0, w])\n\nthis says “calculate even bands starting at 0 and ending at `w`, then set this\nscale’s range to those bands.” In our case, we specified 20 values in the\ndomain, so D3 will calculate:\n\n    \n    \n    (w - 0) / xScale.domain().length\n    (600 - 0) / 20\n    600 / 20\n    30\n\nIn the end, each band will be `30` “wide.”\n\nIt is also possible to include a second parameter, which includes a bit of\nspacing between each band. Here, I’ve used `0.2`, meaning that 20 percent of\nthe width of each band will be used for spacing in between bands:\n\n    \n    \n    .rangeBands([0, w], 0.2)\n\nWe can be even smoother and use `rangeRoundBands()`, which is the same as\n`rangeBands()`, except that the output values are rounded to the nearest whole\npixel, so 12.3456 becomes just 12, for example. This is helpful for keeping\nvisual elements lined up precisely on the pixel grid, for clean, sharp edges.\n\nI’ll also decrease the amount of spacing to just 5 percent. So, our final line\nof code in that statement is:\n\n    \n    \n    .rangeRoundBands([0, w], 0.05);\n\nThis gives us nice, clean pixel values, with a teensy bit of visual space\nbetween them.\n\n### Referencing the Ordinal Scale\n\nLater in the code (and I recommend viewing the source), when we create the\n`rect` elements, we set their horizontal, x-axis positions like so:\n\n    \n    \n    //Create bars\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       .attr(\"x\", function(d, i) {\n          return xScale(i);         // <-- Set x values\n       })\n               …\n\nNote that, because we include `d` and `i` as parameters to the anonymous\nfunction, D3 will automatically pass in the correct values. Of course, `d` is\nthe current datum, and `i` is its index value. So `i` will be passed 0, 1, 2,\n3, and so on.\n\nCoincidentally (hmmm!), we used those same values (0, 1, 2, 3…) for our\nordinal scale’s input domain. So when we call `xScale(i)`, `xScale()` will\nlook up the ordinal value `i` and return its associated output (band) value.\n(You can verify all this for yourself in the console. Just try typing\n`xScale(0)` or `xScale(5)`.)\n\nEven better, setting the widths of these bars just got a lot easier. Before\nusing the ordinal scale, we had:\n\n    \n    \n    .attr(\"width\", w / dataset.length - barPadding)\n\nWe don’t even need `barPadding` anymore because now the padding is built into\n`rangeRoundBands()`. Setting the width of each `rect` needs only this:\n\n    \n    \n            .attr(\"width\", xScale.rangeBand())\n\nIsn’t it nice when D3 does the math for you?\n\n### Other Updates\n\nI’ve made several other updates in _02_bar_chart_with_scales.html_ , including\ncreating a new linear scale `yScale` to calculate vertical values. You already\nknow how to use linear scales, so you can skim the source and note how that’s\nbeing used to set the bar heights.\n\n\n## Updating Data\n\nOkay, once again, we have the amazing bar chart shown in [Figure\n9-3](part0013_split_002.html#The_bar_chart), flexible enough to handle any\ndata we can throw at it.\n\n![The bar chart](../images/00099.jpeg)\n\nFigure 9-3. The bar chart\n\nOr is it? Let’s see.\n\nThe simplest kind of update is when all data values are updated at the same\ntime _and_ the number of values stays the same.\n\nThe basic approach in this scenario is this:\n\n  1. Modify the values in your dataset. \n  2. Rebind the new values to the existing elements (thereby overwriting the original values). \n  3. Set new attribute values as needed to update the visual display. \n\nBefore any of those steps can happen, though, some _event_ needs to kick\nthings off. So far, all of our code has executed immediately on page load. We\n_could_ have our update run right after the initial drawing code, but it would\nhappen imperceptibly fast. To make sure we can observe the change as it\nhappens, we will separate our update code from everything else. We will need a\n“trigger,” something that happens _after_ page load to apply the updates. How\nabout a mouse click?\n\n### Interaction via Event Listeners\n\nAny DOM element can be used, so rather than design a fancy button, I’ll add a\nsimple `p` paragraph to the HTML’s `body`:\n\n    \n    \n    <p>Click on this text to update the chart with new data values (once).</p>\n\nThen, down at the end of our D3 code, let’s add the following:\n\n    \n    \n    d3.select(\"p\")\n        .on(\"click\", function() {\n            //Do something  on click\n        });\n\nThis selects our new `p`, and then adds an _event listener_ to that element.\nHuh?\n\nIn JavaScript, events are happening all the time. Not exciting events, like\nhuge parties, but really insignificant events like `mouseover` and `click`.\nMost of the time, these insignificant events go ignored (just as in life,\nperhaps). But if someone is _listening_ , then the event will be _heard_ , and\ncan go down in posterity, or at least trigger some sort of DOM interaction.\n(Rough JavaScript parallel of classic koan: if an event occurs, and no\nlistener hears it, did it ever happen at all?)\n\nAn event _listener_ is an anonymous function that _listens_ for a specific\nevent _on_ a specific element or elements. D3’s method `selection.on()`\nprovides a nice shorthand for adding event listeners. As you can see, `on()`\ntakes two arguments: the event _type_ (`\"click\"`) and the listener itself (the\nanonymous function).\n\nIn this case, the listener listens for a `click` event occurring on our\nselection `p`. When that happens, the listener function is executed. You can\nput whatever code you want in between the brackets of the anonymous function:\n\n    \n    \n    d3.select(\"p\")\n        .on(\"click\", function() {\n            //Do something mundane and annoying on click\n            alert(\"Hey, don't click that!\");\n        });\n\nWe’ll talk a lot more about interactivity in [Chapter\n10](part0014_split_000.html#DB7S2-8a8b0c18aaaf4f5c9d772f6d0c5087fc).\n\n### Changing the Data\n\nInstead of generating annoying pop-ups, I’d rather simply update `dataset` by\noverwriting its original values. This is step 1, from earlier:\n\n    \n    \n    dataset = [ 11, 12, 15, 20, 18, 17, 16, 18, 23, 25,\n                5, 10, 13, 19, 21, 25, 22, 18, 15, 13 ];\n\nStep 2 is to rebind the new values to the existing elements. We can do that by\nselecting those `rect`s and simply calling `data()` one more time:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset);     //New data successfully bound, sir!\n\n### Updating the Visuals\n\nFinally, step 3 is to update the visual attributes, referencing the (now-\nupdated) data values. This is super easy, as we simply copy and paste the\nrelevant code that we’ve already written. In this case, the `rect`s can\nmaintain their horizontal positions and widths; all we really need to update\nare their `height`s and `y` positions. I’ve added those lines here:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       });\n\nNotice this looks almost exactly like the code that generates the `rect`s\ninitially, only without `enter()` and `append()`.\n\nPutting it all together, here is all of our update code in one place:\n\n    \n    \n    //On click, update with new data\n    d3.select(\"p\")\n        .on(\"click\", function() {\n    \n            //New values for dataset\n            dataset = [ 11, 12, 15, 20, 18, 17, 16, 18, 23, 25,\n                        5, 10, 13, 19, 21, 25, 22, 18, 15, 13 ];\n    \n            //Update all rects\n            svg.selectAll(\"rect\")\n               .data(dataset)\n               .attr(\"y\", function(d) {\n                    return h - yScale(d);\n               })\n               .attr(\"height\", function(d) {\n                    return yScale(d);\n               });\n    \n        });\n\nCheck out the revised bar chart in _03_updates_all_data.html_. It looks like\n[Figure 9-4](part0013_split_002.html#Updateable_bar_chart) to start.\n\n![Updatable bar chart](../images/00100.jpeg)\n\nFigure 9-4. Updatable bar chart\n\nThen click anywhere on the paragraph, and it turns into [Figure\n9-5](part0013_split_002.html#Bar_chart_data_updated).\n\n![Bar chart, data updated](../images/00101.jpeg)\n\nFigure 9-5. Bar chart, data updated\n\nGood news: the values in `dataset` were modified, rebound, and used to adjust\nthe `rect`s. Bad news: it looks weird because we forgot to update the labels,\nand also the bar colors. Good news (because I always like to end with good\nnews): this is easy to fix.\n\nTo ensure the colors change on update, we just copy and paste in the line\nwhere we set the `fill`:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       })\n       .attr(\"fill\", function(d) {   // <-- Down here!\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n       });\n\nTo update the labels, we use a similar pattern, only here we adjust their text\ncontent and x/y values:\n\n    \n    \n    svg.selectAll(\"text\")\n       .data(dataset)\n       .text(function(d) {\n            return d;\n       })\n       .attr(\"x\", function(d, i) {\n            return xScale(i) + xScale.rangeBand() / 2;\n       })\n       .attr(\"y\", function(d) {\n            return h - yScale(d) + 14;\n       });\n\nTake a look at _04_updates_all_data_fixed.html_. You’ll notice it looks the\nsame to start, but click the trigger and now the bar colors and labels update\ncorrectly, as shown in [Figure\n9-6](part0013_split_002.html#Updated_chart_with_correct_colors_and_labels).\n\n![Updated chart with correct colors and labels](../images/00102.jpeg)\n\nFigure 9-6. Updated chart with correct colors and labels\n\n\n## Transitions\n\nLife transitions can be scary: the first day of school, moving to a new city,\nquitting your day job to do freelance data visualization full-time. But D3\ntransitions are fun, beautiful, and not at all emotionally taxing.\n\nMaking a nice, super smooth, animated transition is as simple as adding one\nline of code:\n\n    \n    \n    .transition()\n\nSpecifically, add this link in the chain below where your selection is made,\nand _above_ where any attribute changes are applied:\n\n    \n    \n    //Update all rects\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .transition()    // <-- This is new! Everything else here is unchanged.\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       })\n       .attr(\"fill\", function(d) {\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n       });\n\nNow run the code in _05_transition.html_ , and click the text to see the\ntransition in action. Note that the end result looks the same visually, but\nthe transition from the chart’s initial state to its end state is much, much\nnicer.\n\nIsn’t that _insane_? I’m not a psychologist, but I believe it is literally\ninsane that we can add a single line of code, and D3 will _animate_ our value\nchanges for us over time.\n\nWithout `transition()`, D3 evaluates every `attr()` statement immediately, so\nthe changes in height and fill happen right away. When you add `transition()`,\nD3 introduces the element of time. Rather than applying new values all at\nonce, D3 _interpolates_ between the old values and the new values, meaning it\nnormalizes the beginning and ending values, and calculates all their in-\nbetween states. D3 is also smart enough to recognize and interpolate between\ndifferent attribute value formats. For example, if you specified a height of\n`200px` to start but transition to just `100` (without the `px`). Or if a\n`blue` fill turns `rgb(0,255,0)`. You don’t need to fret about being\nconsistent; D3 takes care of it.\n\nDo you believe me yet? This is really insane. And super helpful.\n\n### duration(), or How Long Is This Going to Take?\n\nSo the `attr()` values are interpolated over time, but how _much_ time? It\nturns out the default is 250 milliseconds, or one-quarter second (1,000\nmilliseconds = 1 second). That’s why the transition in _05_transition.html_ is\nso fast.\n\nFortunately, you can control how much time is spent on any transition by —\nagain, I kid you not — adding a single line of code:\n\n    \n    \n    .duration(1000)\n\nThe `duration()` must be specified _after_ the `transition()`, and durations\nare always specified in milliseconds, so `duration(1000)` is a one-second\nduration.\n\nHere is that line in context:\n\n    \n    \n    //Update all rects\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .transition()\n       .duration(1000)  // <-- Now this is new!\n       .attr(\"y\", function(d) {\n            return h - yScale(d);\n       })\n       .attr(\"height\", function(d) {\n            return yScale(d);\n       })\n       .attr(\"fill\", function(d) {\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n       });\n\nOpen up _06_duration.html_ and see the difference. Now make a copy of that\nfile, and try plugging in some different numbers to slow or speed the\ntransition. For example, try `3000` for a three-second transition, or `100`\nfor one-tenth of a second.\n\nThe actual durations you choose will depend on the context of your design and\nwhat triggers the transition. In practice, I find that transitions of around\n150 ms are useful for providing minor interface feedback (such as hovering\nover elements), and about 1,000 ms is ideal for many more significant visual\ntransitions, such as switching from one view of the data to another. 1,000 ms\n(one second) is not too long, not too short.\n\nIn case you’re feeling lazy, I made _07_duration_slow.html_ , which uses\n`5000` for a five-second transition.\n\nWith such a slow transition, it becomes obvious that the value labels are not\ntransitioning smoothly along with the bar heights. As you now know, we can\ncorrect that oversight by adding only two new lines of code, this time in the\nsection where we update the labels:\n\n    \n    \n    //Update all labels\n    svg.selectAll(\"text\")\n       .data(dataset)\n       .transition()        // <-- This is new,\n       .duration(5000)      //     and so is this.\n       .text(function(d) {\n            return d;\n       })\n       .attr(\"x\", function(d, i) {\n            return xScale(i) + xScale.rangeBand() / 2;\n       })\n       .attr(\"y\", function(d) {\n            return h - yScale(d) + 14;\n       });\n\nMuch better! Note in _08_duration_slow_labels_fixed.html_ how the labels now\nanimate smoothly along with the bars.\n\n### ease()-y Does It\n\nWith a 5,000-ms, slow-as-molasses transition, we can also perceive the\n_quality_ of motion. In this case, notice how the animation begins very\nslowly, then accelerates, then slows down again as the bars reach their\ndestination heights. That is, the rate of motion is not _linear_ , but\n_variable_.\n\nThe quality of motion used for a transition is called _easing_. In animation\nterms, we think about elements _easing_ into place, moving from here to there.\n\nWith D3, you can specify different kinds of easing by using `ease()`. The\ndefault easing is `\"cubic-in-out\"`, which produces the gradual acceleration\nand deceleration we see in our chart. It’s a good default because you\ngenerally can’t go wrong with a nice, smooth transition.\n\nContrast that smoothness to _09_ease_linear.html_ , which uses\n`ease(\"linear\")` to specify a linear easing function. Notice how the rate of\nmotion is constant. That is, there is no gradual acceleration and deceleration\n— the elements simply begin moving at an even pace, and then they stop\nabruptly. (Also, I lowered the duration to 2,000 ms.)\n\n`ease()` must also be specified after `transition()`, but before the `attr()`\nstatements to which the transition applies. `ease()` can come before or after\n`duration()`, but this sequence makes the most sense to me:\n\n    \n    \n    …   //Selection statement(s)\n    .transition()\n    .duration(2000)\n    .ease(\"linear\")\n    …   //attr() statements\n\nFortunately, there are several other built-in easing functions to choose from.\nSome of my favorites are:\n\n`circle`\n\n> Gradual ease in and acceleration until elements snap into place.\n\n`elastic`\n\n> The best way to describe this one is “sproingy.”\n\n`bounce`\n\n> Like a ball bouncing, then coming to rest.\n\nSample code files _10_ease_circle.html_ , _11_ease_elastic.html_ , and\n_12_ease_bounce.html_ illustrate these three functions. The complete list of\neasing functions is on [the D3\nwiki](https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_ease).\n\nWow, I already regret telling you about `bounce`. Please use `bounce` only if\nyou are making a satirical infographic that is mocking other bad graphics.\nPerceptually, I don’t think there is a real case to be used for `bounce`\neasing in visualization. `cubic-in-out` is the default for a reason.\n\n### Please Do Not delay()\n\nWhereas `ease()` controls the quality of motion, `delay()` specifies when the\ntransition begins.\n\n`delay()` can be given a static value, also in milliseconds, as in:\n\n    \n    \n    …\n    .transition()\n    .delay(1000)     //1,000 ms or 1 second\n    .duration(2000)  //2,000 ms or 2 seconds\n    …\n\nAs with `duration()` and `ease()`, the order here is somewhat flexible, but I\nlike to include `delay()` before `duration()`. That makes more sense to me\nbecause the delay happens first, followed by the transition itself.\n\nSee _13_delay_static.html_ , in which clicking the text triggers first a\n1,000-ms delay (in which nothing happens), followed by a 2,000-ms transition.\n\nStatic delays can be useful, but more exciting are delay values that we\ncalculate dynamically. A common use of this is to generate staggered delays,\nso some elements transition before others. Staggered delays can assist with\nperception, as it’s easier for our eyes to follow an individual element’s\nmotion when it is slightly out of sync with its neighboring elements’ motion.\n\nTo do this, instead of giving `delay()` a static value, we give it a function,\nin typical D3 fashion:\n\n    \n    \n    …\n    .transition()\n    .delay(function(d, i) {\n        return i * 100;\n    })\n    .duration(500)\n    …\n\nJust as we’ve seen with other D3 methods, when given an anonymous function,\nthe datum bound to the current element is passed into `d`, and the index\nposition of that element is passed into `i`. So, in this case, as D3 loops\nthrough each element, the delay for each element is set to `i * 100`, meaning\neach subsequent element will be delayed 100 ms _more_ than the preceding\nelement.\n\nAll this is to say that we now have staggered transitions. Check out the\nbeautifully animated bars in _14_delay_dynamic.html_ and see for yourself.\n\nNote that I also decreased the duration to 500 ms to make it feel a bit\nsnappier. Also note that `duration()` sets the duration for each _individual\ntransition_ , not for all transitions in aggregate. So, for example, if 20\nelements have 500-ms transitions applied with no delay, then it will all be\nover in 500 ms, or one-half second. But if a 100-ms delay is applied to each\nsubsequent element (`i * 100`), then the total running time of all transitions\nwill be 2,400 ms:\n\n    \n    \n    Max value of i times 100ms delay plus 500ms duration =\n    19 * 100 + 500 =\n    2400\n\nBecause these delays are being calculated on a per-element basis, if you added\nmore data, then the total running time of all transitions will increase. This\nis something to keep in mind if you have a dynamically loaded dataset with a\nvariable array length. If you suddenly loaded 10,000 data points instead of\n20, you could spend a long, long time watching those bars wiggle around\n(1,000,400 seconds or 11.5 days to be precise). Suddenly, they’re not so cute\nanymore.\n\nFortunately, we can _scale_ our delay values dynamically to the length of the\ndataset. This isn’t fancy D3 stuff; it’s just math.\n\nSee _15_delay_dynamic_scaled.html_ , in which 30 values are included in the\ndataset. If you get out your stopwatch, you’ll see that the total transition\ntime is 1.5 seconds, or around 1,500 ms.\n\nNow see _16_delay_dynamic_scaled_fewer.html_ , which uses exactly the same\ntransition code, but with only 10 data points. Notice how the delays are\nslightly longer (well, 200 percent longer), so the total transition time is\nthe same: 1.5 seconds! How is this possible?\n\n    \n    \n    …\n    .transition()\n    .delay(function(d, i) {\n        return i / dataset.length * 1000;   // <-- Where the magic happens\n    })\n    .duration(500)\n    …\n\nThe two preceding sample pages use the same delay calculations here. Instead\nof multiplying `i` by some static amount, we first divide `i` by\n`dataset.length`, in effect normalizing the value. Then, that normalized value\nis multiplied by `1000`, or 1 second. The result is that the maximum amount of\ndelay for the last element will be `1000`, and all prior elements will be\ndelayed by some amount less than that. A max delay of `1000` plus a duration\nof `500` equals 1.5 seconds total transition time.\n\nThis approach to delays is great because it keeps our code _scalable_. The\ntotal duration will be tolerable whether we have only 10 data points or\n10,000.\n\n### Randomizing the Data\n\nJust to illustrate how cool this is, let’s repurpose our random number\ngenerating code from [Chapter\n5](part0009_split_000.html#8IL22-8a8b0c18aaaf4f5c9d772f6d0c5087fc) here, so we\ncan update the chart as many times as we want, with new data each time.\n\nDown in our click-update function, let’s replace the static `dataset` with a\nrandomly generated one:\n\n    \n    \n    //New values for dataset\n    var numValues = dataset.length;               //Count original length of dataset\n    dataset = [];                                       //Initialize empty array\n    for (var i = 0; i < numValues; i++) {               //Loop numValues times\n        var newNumber = Math.floor(Math.random() * 25); //New random integer (0-24)\n        dataset.push(newNumber);                        //Add new number to array\n    }\n\nThis will overwrite `dataset` with an array of random integers with values\nbetween 0 and 24. The new array will be the same length as the original array.\n\nThen, I’ll update the paragraph text:\n\n    \n    \n    <p>Click on this text to update the chart with new data values\n    as many times as you like!</p>\n\nNow open up _17_randomized_data.html_ , and you should see something like\n[Figure 9-7](part0013_split_003.html#Initial_view).\n\n![Initial view](../images/00103.jpeg)\n\nFigure 9-7. Initial view\n\nEvery time you click the paragraph at top, the code will do the following:\n\n  1. Generate new, random values. \n  2. Bind those values to the existing elements. \n  3. Transition elements to new positions, heights, and colors, using the new values (see [Figure 9-8](part0013_split_003.html#Random_data_applied)). \n\n![Random data applied](../images/00104.jpeg)\n\nFigure 9-8. Random data applied\n\nPretty cool! If this does not feel pretty cool or even a little cool to you,\nplease turn off your computer and go for a short walk to clear your head,\nthereby making room for all the coolness to come. If, however, you are\nsufficiently cooled by this knowledge, read on.\n\n### Updating Scales\n\nAstute readers might take issue with this line from earlier:\n\n    \n    \n    var newNumber = Math.floor(Math.random() * 25);\n\nWhy 25? In programming, this is referred to as a _magic number_. I know, it\nsounds fun, but the problem with magic numbers is that it’s difficult to tell\nwhy they exist (hence, the “magic”). Instead of `25`, something like\n`maxValue` would be more meaningful:\n\n    \n    \n    var newNumber = Math.floor(Math.random() * maxValue);\n\nAh, see, now the magic is gone, and I can remember that `25` was acting as the\n_maximum value_ that could be calculated and put into `newNumber`. As a\ngeneral rule, it’s best to avoid magic numbers, and instead store those\nnumbers inside variables with meaningful names, like `maxValue` or\n`numberOfTimesWatchedTheMovieTopSecret`.\n\nMore important, I now remember that I arbitrarily chose `25` because values\nlarger than that exceeded the range of our chart’s scale, so those bars were\ncut off. For example, in [Figure\n9-9](part0013_split_003.html#Tootallwrongnumber), I replaced `25` with `50`.\n\n![Too tall! We used the wrong magic number!](../images/00105.jpeg)\n\nFigure 9-9. Too tall! We used the wrong magic number!\n\nThe real problem is not that I chose the _wrong_ magic number; it’s that our\n_scale_ needs to be updated whenever the dataset is updated. Whenever we plug\nin new data values, we should also recalibrate our scale to ensure that bars\ndon’t get too tall or too short.\n\nUpdating a scale is easy. You’ll recall we created `yScale` with this code:\n\n    \n    \n    var yScale = d3.scale.linear()\n                    .domain([0, d3.max(dataset)])\n                    .range([0, h]);\n\nThe _range_ can stay the same (as the visual size of our chart isn’t\nchanging), but after the new dataset has been generated, we should update the\nscale’s _domain_ :\n\n    \n    \n    //Update scale domain\n    yScale.domain([0, d3.max(dataset)]);\n\nThis sets the upper end of the input domain to the largest data value in\n`dataset`. Later, when we update all the bars and labels, we already reference\n`yScale` to calculate their positions, so no other code changes are necessary.\n\nCheck it out in _18_dynamic_scale.html_. I went ahead and replaced our magic\nnumber `25` with `maxValue`, which I set here to `100`. So now when we click\nto update, we get random numbers between 0 and 100. If the _maximum_ value in\nthe dataset is 100, then `yScale`’s domain will go up to 100, as we see in\n[Figure\n9-10](part0013_split_003.html#Randomdatabuttheyaxisscaleautomaticallyaccommodates).\n\n![Random data, but the y-axis scale automatically\naccommodates](../images/00106.jpeg)\n\nFigure 9-10. Random data, but the y-axis scale automatically accommodates\n\nBut because the numbers are random, they won’t always reach that maximum value\nof 100. In [Figure\n9-11](part0013_split_003.html#Aslightlydifferentscaleduetoslightlydifferentdata),\nthey top out at 85.\n\n![A slightly different scale, due to slightly different\ndata](../images/00107.jpeg)\n\nFigure 9-11. A slightly different scale, due to slightly different data\n\nNote that the height of the 100 bar in the first chart is _the same_ as the\nheight of the 85 bar here. The data is changing; the scale input domain is\nchanging; the output visual range does _not_ change.\n\n### Updating Axes\n\nThe bar chart doesn’t have any axes, but our scatterplot from the last chapter\ndoes ([Figure\n9-12](part0013_split_003.html#Updatedscatterplotnowwithdataupdatesanddynamicscales)).\nI’ve brought it back, with a few tweaks, in _19_axes_static.html_.\n\n![Updated scatterplot, now with data updates and dynamic\nscales](../images/00108.jpeg)\n\nFigure 9-12. Updated scatterplot, now with data updates and dynamic scales\n\nTo summarize the changes to the scatterplot:\n\n  * You can now click the text at top to generate and update with new data. \n  * Animated transitions are used after data updates. \n  * I eliminated the staggered delay, and set all transitions to occur over a full second (1,000 ms). \n  * Both the x- and y-axis scales are updated, too. \n  * Circles now have a constant radius. \n\nTry clicking the text and watch all those little dots zoom around. Cute! I\nsort of wish they represented some meaningful information, but hey, random\ndata can be fun, too.\n\nWhat’s _not_ happening yet is that the axes aren’t updating. Fortunately, that\nis simple to do.\n\nFirst, I am going to add the class names `x` and `y` to our x- and y-axes,\nrespectively. This will help us select those axes later:\n\n    \n    \n    //Create x-axis\n    svg.append(\"g\")\n        .attr(\"class\", \"x axis\")    // <-- Note x added here\n        .attr(\"transform\", \"translate(0,\" + (h - padding) + \")\")\n        .call(xAxis);\n    \n    //Create y-axis\n    svg.append(\"g\")\n        .attr(\"class\", \"y axis\")    // <-- Note y added here\n        .attr(\"transform\", \"translate(\" + padding + \",0)\")\n        .call(yAxis);\n\nThen, down in our click function, we simply add:\n\n    \n    \n    //Update x-axis\n    svg.select(\".x.axis\")\n        .transition()\n        .duration(1000)\n        .call(xAxis);\n    \n    //Update y-axis\n    svg.select(\".y.axis\")\n        .transition()\n        .duration(1000)\n        .call(yAxis);\n\nFor each axis, we do the following:\n\n  1. Select the axis. \n  2. Initiate a transition. \n  3. Set the transition’s duration. \n  4. Call the appropriate axis generator. \n\nRemember that each axis generator is already referencing a scale (either\n`xScale` or `yScale`). Because those scales are being updated, the axis\ngenerators can calculate what the new tick marks should be.\n\nOpen up _20_axes_dynamic.html_ and give it a try.\n\nOnce again, `transition()` handles all the interpolation magic for you — watch\nthose ticks fade in and out. Just beautiful, and you barely had to lift a\nfinger.\n\n### each() Transition Starts and Ends\n\nThere will be times when you want to make something happen at the start or end\nof a transition. In those times, you can use `each()` to execute arbitrary\ncode for each element in the selection.\n\n`each()` expects two arguments:\n\n  * Either `\"start\"` or `\"end\"`\n  * An anonymous function, to be executed either at the start of a transition, or as soon as it has ended \n\nFor example, here is our circle-updating code, with two `each()` statements\nadded:\n\n    \n    \n    //Update all circles\n    svg.selectAll(\"circle\")\n       .data(dataset)\n       .transition()\n       .duration(1000)\n       .each(\"start\", function() {      // <-- Executes at start of transition\n           d3.select(this)\n             .attr(\"fill\", \"magenta\")\n             .attr(\"r\", 3);\n       })\n       .attr(\"cx\", function(d) {\n            return xScale(d[0]);\n       })\n       .attr(\"cy\", function(d) {\n            return yScale(d[1]);\n       })\n       .each(\"end\", function() {        // <-- Executes at end of transition\n           d3.select(this)\n             .attr(\"fill\", \"black\")\n             .attr(\"r\", 2);\n       });\n\nYou can see this in action in _21_each.html_.\n\nNow you click the trigger, and immediately each circle’s fill is set to\nmagenta, and its radius is set to 3 (see [Figure\n9-13](part0013_split_003.html#Hotpinkcirclesinmidtransition)). Then the\ntransition is run, per usual. When complete, the fills and radii are restored\nto their original values.\n\n![Hot pink circles, midtransition](../images/00109.jpeg)\n\nFigure 9-13. Hot pink circles, midtransition\n\nSomething to note is that within the anonymous function passed to `each()`,\nthe context of `this` is maintained as “the current element.” This is handy\nbecause then `this` can be referenced with the function to easily reselect the\ncurrent element and modify it, as done here:\n\n    \n    \n       .each(\"start\", function() {\n           d3.select(this)              // Selects 'this', the current element\n             .attr(\"fill\", \"magenta\")   // Sets fill of 'this' to magenta\n             .attr(\"r\", 3);             // Sets radius of 'this' to 3\n       })\n\n#### Warning: Start carefully\n\nYou might be tempted to throw another transition in here, resulting in a\nsmooth fade from black to magenta. Don’t do it! Or do it, but note that this\nwill break:\n\n    \n    \n       .each(\"start\", function() {\n           d3.select(this)\n             .transition()              // New transition\n             .duration(250)             // New duration\n             .attr(\"fill\", \"magenta\")\n             .attr(\"r\", 3);\n       })\n\nIf you try this, and I recommend that you do, you’ll find that the circles do\nindeed fade to pink, but they no longer change positions in space. That’s\nbecause, by default, only one transition can be active on any given element at\nany given time. Newer transitions interrupt and override older transitions.\n\nThis might seem like a design flaw, but D3 operates this way on purpose.\nImagine if you had several different buttons, each of which triggered a\ndifferent view of the data, and a visitor was clicking through them in rapid\nsuccession. Wouldn’t you want an earlier transition to be interrupted, so the\nlast-selected view could be put in place right away?\n\nIf you’re familiar with jQuery, you’ll notice a difference here. By default,\njQuery queues transitions, so they execute one after another, and calling a\nnew transition doesn’t automatically interrupt any existing ones. This\nsometimes results in annoying interface behavior, like menus that fade in when\nyou mouse over them, but won’t start fading out until _after_ the fade-in has\ncompleted.\n\nIn this case, the code “breaks” because the first (spatial) transition is\nbegun, then `each(\"start\", …)` is called on each element. Within `each()`, a\nsecond transition is initiated (the fade to pink), overriding the first\ntransition, so the circles never make it to their final destinations (although\nthey look great, just sitting at home).\n\nBecause of this quirk of transitions, just remember that `each(\"start\", …)`\nshould be used only for immediate transformations, with no transitions.\n\n#### End gracefully\n\n`each(\"end\", …)`, however, _does_ support transitions. By the time\n`each(\"end\", …)` is called, the primary transition has already ended, so\ninitiating a new transition won’t cause any harm.\n\nSee _22_each_combo_transition.html_. Within the first `each()` statement, I\nbumped the pink circle radius size up to 7. In the second, I added two lines\nfor transition and a duration:\n\n    \n    \n    .each(\"end\", function() {\n        d3.select(this)\n          .transition()             // <-- New!\n          .duration(1000)           // <-- New!\n          .attr(\"fill\", \"black\")\n          .attr(\"r\", 2);\n    });\n\nWatch that transition: so cool! Note the sequence of events:\n\n  1. You click the `p` text. \n  2. Circles turn pink and increase in size immediately. \n  3. Circles transition to new positions. \n  4. Circles transition to original color and size. \n\nAlso, try clicking on the `p` trigger several times in a row. Go ahead, just\ngo nuts, click as fast as you can. Notice how each click interrupts the\ncircles’ progress. (Sorry, guys!) You’re seeing each new transition request\noverride the old one. The circles will never reach their final positions and\nfade to black unless you stop clicking and give them time to rest.\n\nAs cool as that is, there is an even simpler way to schedule multiple\ntransitions to run one after the other: we simply chain transitions together.\n(This is a new feature in version 3.0 and won’t work with older versions.) For\nexample, instead of reselecting elements and calling a new transition on each\none within `each(\"end\", …)`, we can just tack a second transition onto the end\nof the chain:\n\n    \n    \n    svg.selectAll(\"circle\")\n       .data(dataset)\n       .transition()    // <-- Transition #1\n       .duration(1000)\n       .each(\"start\", function() {\n               d3.select(this)\n                 .attr(\"fill\", \"magenta\")\n                 .attr(\"r\", 7);\n       })\n       .attr(\"cx\", function(d) {\n                    return xScale(d[0]);\n       })\n       .attr(\"cy\", function(d) {\n                    return yScale(d[1]);\n       })\n       .transition()    // <-- Transition #2\n       .duration(1000)\n       .attr(\"fill\", \"black\")\n       .attr(\"r\", 2);\n\nTry that code out in _23_each_combo_transition_chained.html_ , and you’ll see\nit has the same behavior.\n\nWhen sequencing multiple transitions, I recommend this chaining approach. Then\nonly use `each()` for immediate (nontransitioned) changes that need to occur\nright before or right after transitions. As you can imagine, it’s possible to\ncreate quite complex sequences of discrete and animated changes by chaining\ntogether multiple transitions, each of which can have its own calls to\n`each(\"start\", …)` and `each(\"end\", …)`.\n\n#### Transitionless each()\n\nYou can also use `each()` outside of a transition, just to execute arbitrary\ncode for each element in a selection. Outside of transitions, just omit the\n`\"start\"` or `\"end\"` parameter, and only pass in the anonymous function.\n\nAlthough I didn’t do this here, you can also include references to `d` and `i`\nwithin your function definition, and D3 will hand off those values, as you’d\nexpect:\n\n    \n    \n    …\n    .each(function(d, i) {\n        //Do something with d and i here\n    });\n\n#### Containing visual elements with clipping paths\n\nOn a slightly related note, you might have noticed that during these\ntransitions, points with low x or y values would exceed the boundaries of the\nchart area, and overlap the axis lines, as displayed in [Figure\n9-14](part0013_split_003.html#Pointsexceedingthechartarea).\n\n![Points exceeding the chart area](../images/00110.jpeg)\n\nFigure 9-14. Points exceeding the chart area\n\nFortunately, SVG has support for _clipping paths_ , which might be more\nfamiliar to you as _masks_ , as in Photoshop or Illustrator. A clipping path\nis an SVG element that contains visual elements that, together, make up the\nclipping path or mask to be applied to other elements. When a mask is applied\nto an element, only the pixels that land within that mask’s shape are\ndisplayed.\n\nMuch like `g`, a `clipPath` has no visual presence of its own, but it contains\nvisual elements (which are used to make the mask). For example, here’s a\nsimple `clipPath`:\n\n    \n    \n    <clipPath id=\"chart-area\">\n        <rect x=\"30\" y=\"30\" width=\"410\" height=\"240\"></rect>\n    </clipPath>\n\nNote that the outer `clipPath` element has been given an ID of `chart-area`.\nWe can use that ID to reference it later. Within the `clipPath` is a `rect`,\nwhich will function as the mask.\n\nSo there are three steps to using a clipping path:\n\n  1. Define the `clipPath` and give it an ID. \n  2. Put visual elements within the `clipPath` (usually just a `rect`, but this could be `circle`s or any other visual elements). \n  3. Add a reference to the `clipPath` from whatever element(s) you wish to be masked. \n\nContinuing with the scatterplot, I’ll define the clipping path with this new\ncode (steps 1 and 2):\n\n    \n    \n    //Define clipping path\n    svg.append(\"clipPath\")                  //Make a new clipPath\n        .attr(\"id\", \"chart-area\")           //Assign an ID\n        .append(\"rect\")                     //Within the clipPath, create a new rect\n        .attr(\"x\", padding)                 //Set rect's position and size…\n        .attr(\"y\", padding)\n        .attr(\"width\", w - padding * 3)\n        .attr(\"height\", h - padding * 2);\n\nI want all of the `circle`s to be masked by this `clipPath`. I could add a\n`clipPath` reference to every single circle, but it’s much easier and cleaner\nto just put all the `circle`s into a `g` group, and then add the reference to\nthat (this is step 3).\n\nSo, I will modify this code:\n\n    \n    \n    //Create circles\n    svg.selectAll(\"circle\")\n       .data(dataset)\n       .enter()\n       .append(\"circle\")\n       …\n\nby adding three new lines, creating a new `g`, giving it an arbitrary ID, and\nfinally adding the reference to the `chart-area` `clipPath`:\n\n    \n    \n    //Create circles\n    svg.append(\"g\")                             //Create new g\n       .attr(\"id\", \"circles\")                   //Assign ID of 'circles'\n       .attr(\"clip-path\", \"url(#chart-area)\")   //Add reference to clipPath\n       .selectAll(\"circle\")                     //Continue as before…\n       .data(dataset)\n       .enter()\n       .append(\"circle\")\n       …\n\nNotice that the attribute name is `clip-path`, and the element name is\n`clipPath`. Argh! I know; it drives me crazy, too.\n\nView the sample page _24_clip-path.html_ and open the web inspector. Let’s\nlook at that new `rect` in [Figure\n9-15](part0013_split_003.html#ThedimensionsofarectwithinaclipPath).\n\n![The dimensions of a rect within a clipPath](../images/00111.jpeg)\n\nFigure 9-15. The dimensions of a rect within a clipPath\n\nBecause `clipPath`s have no visual rendering (they only mask other elements),\nit’s helpful to highlight them in the web inspector, which will then outline\nthe path’s position and size with a blue highlight. In [Figure\n9-15](part0013_split_003.html#ThedimensionsofarectwithinaclipPath) we can see\nthat the `clipPath rect` is in the right place and is the right size.\n\nNotice, too, that now all the `circle`s are grouped within a single `g`\nelement, whose `clip-path` attribute references our new clipping path, using\nthe slightly peculiar syntax `url(#chart-area)`. Thanks for that, SVG\nspecification.\n\nThe end result is that our `circle`s’ pixels get clipped when they get too\nclose to the edge of the chart area. Note the points at the extreme top and\nright edges.\n\nThe clipping is easier to see midtransition, as in [Figure\n9-16](part0013_split_003.html#Pointscontainedwithinthechartarea).\n\n![Points contained within the chart area](../images/00112.jpeg)\n\nFigure 9-16. Points contained within the chart area\n\nVoilà! The points no longer exceed the chart boundaries.\n\n\n## Other Kinds of Data Updates\n\nUntil now, when updating data, we have taken the “whole kit-and-kaboodle”\napproach: changing values in the dataset array, and then rebinding that\nrevised dataset, overwriting the original values bound to our DOM elements.\n\nThat approach is most useful when _all_ the values are changing, and when the\nlength of the dataset (i.e., the number of values) stays the same. But as we\nknow, real-life data is messy, and calls for even more flexibility, such as\nwhen you only want to update one or two values, or you even need to add or\nsubtract values. D3, again, comes to the rescue.\n\n### Adding Values (and Elements)\n\nLet’s go back to our lovely bar chart, and say that some user interaction (a\nmouse click) should now trigger adding a _new_ value to our dataset. That is,\nthe length of the array `dataset` will increase by one.\n\nWell, generating a random number and pushing it to the array is easy enough:\n\n    \n    \n    //Add one new value to dataset\n    var maxValue = 25;\n    var newNumber = Math.floor(Math.random() * maxValue);\n    dataset.push(newNumber);\n\nMaking room for an extra bar will require recalibrating our x-axis scale.\nThat’s just a matter of updating its input domain to reflect the new length of\n`dataset`:\n\n    \n    \n    xScale.domain(d3.range(dataset.length));\n\nThat’s the easy stuff. Now prepare to bend your brain yet again, as we dive\ninto the depths of D3 _selections_.\n\n#### Select\n\nBy now, you are comfortable using `select()` and `selectAll()` to grab and\nreturn DOM element selections. And you’ve even seen how, when these methods\nare chained, they grab selections within selections, and so on, as in:\n\n    \n    \n    d3.select(\"body\").selectAll(\"p\");   //Returns all 'p' elements within 'body'\n\nWhen storing the _results_ of these selection methods, the most specific\nresult — meaning the result of the last selector in the chain — is the\nreference handed off to the variable. For example:\n\n    \n    \n    var paragraphs = d3.select(\"body\").selectAll(\"p\");\n\nNow `paragraphs` contains a selection of all `p` elements in the DOM, even\nthough we traversed through `body` to get there.\n\nThe twist here is that the `data()` method _also_ returns a selection.\nSpecifically, `data()` returns references to all elements to which data was\njust bound, which we call the _update_ selection.\n\nIn the case of our bar chart, this means that we can select all the bars, then\nrebind the new data to those bars, and grab the update selection all in one\nfell swoop:\n\n    \n    \n    //Select…\n    var bars = svg.selectAll(\"rect\")\n        .data(dataset);\n\nNow the update selection is stored in `bars`.\n\n#### Enter\n\nWhen we changed our data values, but not the _length_ of the whole data set,\nwe didn’t have to worry about an update selection — we simply rebound the\ndata, and transitioned to new attribute values.\n\nBut now we have _added_ a value. So `dataset.length` was originally 20, but\nnow it is 21. How can we address that new data value, specifically, to draw a\nnew `rect` for it? Stay with me here; your patience will be rewarded.\n\nThe genius of the update selection is that it contains within it references to\n_enter_ and _exit_ subselections.\n\n_Entering_ elements are those that are new to the scene. It’s considered good\nform to welcome such elements to the neighborhood with a plate of cookies.\n\nWhenever there are more data values than corresponding DOM elements, the\n_enter_ selection contains references to those elements _that do not yet\nexist_. You already know how to access the enter selection: by using `enter()`\nafter binding the new data, as we do when first creating the bar chart. You\nhave already seen the following code:\n\n    \n    \n    svg.selectAll(\"rect\") //Selects all rects (as yet nonexistent)\n       .data(dataset)     //Binds data to selection, returns update selection\n       .enter()           //Extracts the enter selection, i.e., 20 placeholder elements\n       .append(\"rect\")    //Creates a 'rect' inside each of the placeholder elements\n       …\n\nYou have already seen this sequence of\n`selectAll()`→`data()`→`enter()`→`append()` many times, but only in the\ncontext of creating many elements at once, when the page first loads.\n\nNow that we have added one value to `dataset`, we can use `enter()` to address\nthe one new corresponding DOM element, without touching all the existing\n`rect`s. Following the preceding `Select` code, I’ll add:\n\n    \n    \n    //Enter…\n    bars.enter()\n        .append(\"rect\")\n        .attr(\"x\", w)\n        .attr(\"y\", function(d) {\n            return h - yScale(d);\n        })\n        .attr(\"width\", xScale.rangeBand())\n        .attr(\"height\", function(d) {\n            return yScale(d);\n        })\n        .attr(\"fill\", function(d) {\n            return \"rgb(0, 0, \" + (d * 10) + \")\";\n        });\n\nRemember, `bars` contains the update selection, so `bars.enter()` extracts the\nenter selection from that. In this case, the enter selection is one reference\nto one new DOM element. We follow that with `append()` to create the new\n`rect`, and all the other `attr()` statements as usual, except for the\nfollowing line:\n\n    \n    \n    .attr(\"x\", w)\n\nYou might notice that this sets the horizontal position of the new `rect` to\nbe just past the far right edge of the SVG. I want the new bar to be created\njust out of sight, so I can use a nice, smooth transition to move it gently\ninto view.\n\n#### Update\n\nWe made the new `rect`; now all that’s left is to update all `rect`’s visual\nattributes. Again, `bars` here stores the complete update selection (which\nincludes the enter selection):\n\n    \n    \n    //Update…\n    bars.transition()\n        .duration(500)\n        .attr(\"x\", function(d, i) {\n            return xScale(i);\n        })\n        .attr(\"y\", function(d) {\n            return h - yScale(d);\n        })\n        .attr(\"width\", xScale.rangeBand())\n        .attr(\"height\", function(d) {\n            return yScale(d);\n        });\n\nThis has the effect of taking _all_ the bars and transitioning them to their\nnew x, y, width, and height values. Don’t believe me? See the working code in\n_25_adding_values.html_.\n\n[Figure 9-17](part0013_split_004.html#Initialbarchart) shows the initial\nchart.\n\n![Initial bar chart](../images/00113.jpeg)\n\nFigure 9-17. Initial bar chart\n\n[Figure 9-18](part0013_split_004.html#Afteroneclick) shows the chart after one\nclick on the text. Note the new bar on the right.\n\n![After one click](../images/00114.jpeg)\n\nFigure 9-18. After one click\n\nAfter two clicks, we get the chart shown in [Figure\n9-19](part0013_split_004.html#Aftertwoclicks). [Figure\n9-20](part0013_split_004.html#Afterthreeclicks) shows the result after three\nclicks.\n\n![After two clicks](../images/00115.jpeg)\n\nFigure 9-19. After two clicks\n\n![After three clicks](../images/00116.jpeg)\n\nFigure 9-20. After three clicks\n\nAfter several more clicks, you’ll see the chart shown in [Figure\n9-21](part0013_split_004.html#Aftermanyclicks).\n\n![After many clicks](../images/00117.jpeg)\n\nFigure 9-21. After many clicks\n\nNot only are new bars being created, sized, and positioned, but on every\nclick, _all other bars_ are rescaled and moved into position as well.\n\nWhat’s _not_ happening is that new value labels aren’t being created and\ntransitioned into place. I leave that as an exercise for you to pursue.\n\n### Removing Values (and Elements)\n\nRemoving elements is easier.\n\nWhenever there are more DOM elements than data values, the _exit_ selection\ncontains references to those elements without data. As you’ve already guessed,\nwe can access the exit selection with `exit()`.\n\nFirst, I’ll change our trigger text to indicate we’re removing values:\n\n    \n    \n    <p>Click on this text to remove a data value from the chart!</p>\n\nThen, on click, instead of generating a new random value and adding it to\n`dataset`, we’ll use `shift()`, which removes the first element from the\narray:\n\n    \n    \n    //Remove one value from dataset\n    dataset.shift();\n\n#### Exit\n\n _Exiting_ elements are those that are on their way out. We should be polite\nand wish these elements a safe journey.\n\nSo we grab the exit selection, transition the exiting element off to the right\nside, and, finally, remove it:\n\n    \n    \n    //Exit…\n    bars.exit()\n        .transition()\n        .duration(500)\n        .attr(\"x\", w)\n        .remove();\n\n`remove()` is a special transition method that waits until the transition is\ncomplete, and then deletes the element from the DOM forever. (Sorry, there’s\nno getting it back.)\n\n#### Making a smooth exit\n\nVisually speaking, it’s good practice to perform a transition first, rather\nthan simply `remove()` elements right away. In this case, we’re moving the bar\noff to the right, but you could just as easily transition `opacity` to zero,\nor apply some other visual transition.\n\nThat said, if you ever need to just get rid of an element ASAP, by all means,\nyou can use `remove()` without calling a transition first.\n\nOkay, now try out the code in _26_removing_values.html_. [Figure\n9-22](part0013_split_004.html#Initial_bar_chart) shows the initial view.\n\n![Initial bar chart](../images/00118.jpeg)\n\nFigure 9-22. Initial bar chart\n\nThen, after one click on the text, note the loss of one bar in [Figure\n9-23](part0013_split_004.html#After_one_click).\n\n![After one click](../images/00119.jpeg)\n\nFigure 9-23. After one click\n\nAfter two clicks, you’ll see the chart in [Figure\n9-24](part0013_split_004.html#After_two_clicks). [Figure\n9-25](part0013_split_004.html#After_three_clicks) shows what displays after\nthree clicks.\n\n![After two clicks](../images/00120.jpeg)\n\nFigure 9-24. After two clicks\n\n![After three clicks](../images/00121.jpeg)\n\nFigure 9-25. After three clicks\n\nAfter many clicks, the result is shown in [Figure\n9-26](part0013_split_004.html#After_many_clicks).\n\n![After many clicks](../images/00122.jpeg)\n\nFigure 9-26. After many clicks\n\nOn each click, one bar moves off to the right, and then is removed from the\nDOM. (You can confirm this with the web inspector.)\n\nBut what’s not working as expected? For starters, the value labels aren’t\nbeing removed, so they clutter up the top right of our chart. Again, I will\nleave fixing this aspect as an exercise to you.\n\nMore important, although we are using the `Array.shift()` method to remove the\n_first_ value from the `dataset` array, it’s not the _first_ bar that is\nremoved, is it? Instead, the last bar in the DOM, the one visually on the far\nright, is always removed. Although the data values are updating correctly\n(note how they move to the left with each click — 5, 10, 13, 19, and so on),\nthe bars are assigned new values, rather than “sticking” with their intial\nvalues. That is, the anticipated _object constancy_ is broken — the “5” bar\nbecomes the “10” bar, and so on, yet perceptually we would prefer that the “5”\nbar simply scoot off to the left and let all the other bars keep their\noriginal values.\n\nWhy, why, oh, why is this happening?! Not to worry; there’s a perfectly\nreasonable explanation. The key to maintaining object constancy is, well,\nkeys. (On a side note, Mike Bostock has a very eloquent [overview of the value\nof object constancy](http://bost.ocks.org/mike/constancy/), which I\nrecommend.)\n\n### Data Joins with Keys\n\nNow that you understand update, enter, and exit selections, it’s time to dig\ndeeper into data joins.\n\nA data join happens whenever you bind data to DOM elements; that is, every\ntime you call `data()`.\n\nThe default join is by _index order_ , meaning the first data value is bound\nto the first DOM element in the selection, the second value is bound to the\nsecond element, and so on.\n\nBut what if the data values and DOM elements are not in the same order? Then\nyou need to tell D3 how to join or pair values and elements. Fortunately, you\ncan define those rules by specifying a _key function_.\n\nThis explains the problem with our bars. After we remove the first value from\nthe `dataset` array, we rebind the new `dataset` on top of the existing\nelements. Those values are joined in index order, so the first `rect`, which\noriginally had a value of 5, is now assigned 10. The former 10 bar is assigned\n13, and so on. In the end, that leaves one `rect` element without data — the\nlast one on the far right.\n\nWe can use a _key function_ to control the data join with more specificity and\nensure that the right datum is bound to the right `rect` element.\n\n#### Preparing the data\n\nUntil now, our dataset has been a simple array of values. But to use a key\nfunction, each value must have some “key” associated with it. Think of the key\nas a means of identifying the value without looking at the value itself, as\nthe values themselves might change or exist in duplicate form. (If there were\ntwo separate values of `3`, how could you tell them apart?)\n\nInstead of an array of values, let’s use an array of _objects_ , within which\neach object can contain both a key value and the actual data value:\n\n    \n    \n    var dataset = [ { key: 0, value: 5 },\n                    { key: 1, value: 10 },\n                    { key: 2, value: 13 },\n                    { key: 3, value: 19 },\n                    { key: 4, value: 21 },\n                    { key: 5, value: 25 },\n                    { key: 6, value: 22 },\n                    { key: 7, value: 18 },\n                    { key: 8, value: 15 },\n                    { key: 9, value: 13 },\n                    { key: 10, value: 11 },\n                    { key: 11, value: 12 },\n                    { key: 12, value: 15 },\n                    { key: 13, value: 20 },\n                    { key: 14, value: 18 },\n                    { key: 15, value: 17 },\n                    { key: 16, value: 16 },\n                    { key: 17, value: 18 },\n                    { key: 18, value: 23 },\n                    { key: 19, value: 25 } ];\n\nRemember, hard brackets `[]` indicate an array, and curly brackets `{}`\nindicate an object.\n\nNote that the data values here are unchanged from our original `dataset`.\nWhat’s new are the keys, which just enumerate each object’s original position\nwithin the `dataset` array. (By the way, your chosen key name doesn’t have to\nbe `key` — the name can be anything, like `id`, `year`, or `fruitType`. I am\nusing `key` here for simplicity.)\n\n#### Updating all references\n\nThe next step isn’t fun, but it’s not hard. Now that our data values are\nburied within objects, we can no longer just reference `d`. (Ah, the good old\ndays.) Anywhere in the code where we want to access the actual data _value_ ,\nwe now need to specify `d.value`. When we use anonymous functions within D3\nmethods, `d` is handed whatever is in the current position in the array. In\nthis case, each position in the array now contains an object, such as `{ key:\n12, value: 15 }`. So to get at the value `15`, we now must write `d.value` to\nreach _into_ the object and grab that `value` value. (I hope you see a lot of\nvalue in this paragraph.)\n\nFirst, that means a change to the `yScale` definition:\n\n    \n    \n    var yScale = d3.scale.linear()\n                    .domain([0, d3.max(dataset, function(d) { return d.value; })])\n                    .range([0, h]);\n\nIn the second line, we used to have simply `d3.max(dataset)`, but that only\nworks with a simple array. Now that we’re using objects, we have to include an\n_accessor function_ that tells `d3.max()` how to get at the correct values to\ncompare. So as `d3.max()` loops through all the elements in the `dataset`\narray, now it knows not to look at `d` (which is an object, and not easily\ncompared to other objects), but `d.value` (a number, which is easily compared\nto other numbers).\n\nNote we also need to change the second reference to `yScale`, down in our\nclick-update function:\n\n    \n    \n    yScale.domain([0, d3.max(dataset, function(d) { return d.value; })]);\n\nNext up, everywhere `d` is used to set attributes, we must change `d` to\n`d.value`. For example, this:\n\n    \n    \n    …\n    .attr(\"y\", function(d) {\n        return h - yScale(d);        // <-- d\n    })\n    …\n\nbecomes this:\n\n    \n    \n    …\n    .attr(\"y\", function(d) {\n        return h - yScale(d.value);  // <-- d.value!\n    })\n    …\n\n#### Key functions\n\nFinally, we define a key function, to be used whenever we bind data to\nelements:\n\n    \n    \n    var key = function(d) {\n        return d.key;\n    };\n\nNotice that, in typical D3 form, the function takes `d` as input. Then this\nvery simple function specifies to take the `key` value of whatever `d` object\nis passed into it.\n\nNow, in all four places where we bind data, we replace this line:\n\n    \n    \n    .data(dataset)\n\nwith this:\n\n    \n    \n    .data(dataset, key)\n\nNote that rather than defining the key function first, then referencing it,\nyou could of course simply write the key function directly into the call to\n`data()` like so:\n\n    \n    \n    .data(dataset, function(d) {\n        return d.key;\n    })\n\nBut in this case, you’d have to write that four times, which is redundant, so\nI think defining the key function once at the top is cleaner.\n\nThat’s it! Consider your data joined.\n\n#### Exit transition\n\nOne last tweak: Let’s set the exiting bar to scoot off to the left side\ninstead of the right:\n\n    \n    \n    //Exit…\n    bars.exit()\n        .transition()\n        .duration(500)\n        .attr(\"x\", -xScale.rangeBand())  // <-- Exit stage left\n        .remove();\n\nGreat! Check out the sample code, with all of those changes, in\n_27_data_join_with_key.html_. The initial view shown in [Figure\n9-27](part0013_split_004.html#Initial-bar-chart) is unchanged.\n\n![Initial bar chart](../images/00123.jpeg)\n\nFigure 9-27. Initial bar chart\n\nTry clicking the text, though, and the leftmost bar slides cleanly off to the\nleft, all other bars’ widths rescale to fit, and then the exited bar is\ndeleted from the DOM. (Again, you can confirm this by watching the `rect`s\ndisappear one by one in the web inspector.)\n\n[Figure 9-28](part0013_split_004.html#After-one-click) shows the view after\none bar is removed.\n\n![After one click](../images/00124.jpeg)\n\nFigure 9-28. After one click\n\nAfter two clicks, you’ll see the chart in [Figure\n9-29](part0013_split_004.html#After-two-clicks).\n\n![After two clicks](../images/00125.jpeg)\n\nFigure 9-29. After two clicks\n\n[Figure 9-30](part0013_split_004.html#After-three-clicks) displays the results\nafter three clicks, and after several clicks, you’ll see the result shown in\n[Figure 9-31](part0013_split_004.html#After-many-clicks).\n\n![After three clicks](../images/00126.jpeg)\n\nFigure 9-30. After three clicks\n\n![After many clicks](../images/00127.jpeg)\n\nFigure 9-31. After many clicks\n\nThis is working better than ever. The only hitch is that the labels aren’t\nexiting to the left, and also are not removed from the DOM, so they clutter up\nthe left side of the chart. Again, I leave this to you; put your new D3 chops\nto the test and clean up those labels.\n\n### Add and Remove: Combo Platter\n\nWe could stop there and be very satisfied with our newfound skills. But why\nnot go all the way, and adjust our chart so data values can be added _and_\nremoved?\n\nThis is easier than you might think. First, we’ll need two different triggers\nfor the user interaction. I’ll split the one paragraph into two, and give each\na unique ID, so we can tell which one is clicked:\n\n    \n    \n    <p id=\"add\">Add a new data value</p>\n    <p id=\"remove\">Remove a data value</p>\n\nLater, down where we set up the click function, `select()` must become\n`selectAll()`, now that we’re selecting more than one `p` element:\n\n    \n    \n    d3.selectAll(\"p\")\n        .on(\"click\", function() { …\n\nNow that this click function will be bound to both paragraphs, we have to\nintroduce some logic to tell the function to behave differently depending on\nwhich paragraph was clicked. There are many ways to achieve this; I’ll go with\nthe most straightforward one.\n\nFortunately, within the context of our anonymous click function, `this` refers\nto the element that was clicked — the paragraph. So we can get the ID value of\nthe clicked element by selecting `this` and inquiring using `attr()`:\n\n    \n    \n    d3.select(this).attr(\"id\")\n\nThat statement will return `\"add\"` when `p#add` is clicked, and `\"remove\"`\nwhen `p#remove` is clicked. Let’s store that value in a variable, and use it\nto control an `if` statement:\n\n    \n    \n    //See which p was clicked\n    var paragraphID = d3.select(this).attr(\"id\");\n    \n    //Decide what to do next\n    if (paragraphID == \"add\") {\n        //Add a data value\n        var maxValue = 25;\n        var newNumber = Math.floor(Math.random() * maxValue);\n        var lastKeyValue = dataset[dataset.length - 1].key;\n        console.log(lastKeyValue);\n        dataset.push({\n            key: lastKeyValue + 1,\n            value: newNumber\n        });\n    } else {\n        //Remove a value\n        dataset.shift();\n    }\n\nSo, if `p#add` is clicked, we calculate a new random value, and then look up\nthe key value of the last item in `dataset`. Then we create a new object with\nan incremented key (to ensure we don’t duplicate keys; insert locksmith joke\nhere) and the random data value.\n\nNo additional changes are needed! The enter/update/exit code we wrote is\nalready flexible enough to handle adding _or_ removing data values — that’s\nthe beauty of it.\n\nTry it out in _28_adding_and_removing.html_. You’ll see that you can click to\nadd or remove data points at will. Of course, real-world data isn’t created\nthis way, but you can imagine these data updates being triggered by some other\nevent — such as data refreshes being pulled from a server — and not mouse\nclicks.\n\nAlso see _29_dynamic_labels.html_ , which is the same thing, only I’ve updated\nthe code to add, transition, and remove the labels as well.\n\n### Recap\n\nThat was a lot of information! Let’s review:\n\n  * `data()` binds data to elements, but also returns the _update selection_.\n  * The update selection can contain _enter_ and _exit_ selections, which can be accessed via `enter()` and `exit()`. \n  * When there are _more values than elements_ , an enter selection will reference the placeholder, not-yet-existing elements. \n  * When there are _more elements than values_ , an exit selection will reference the elements without data. \n  * Data joins determine how values are matched with elements. \n  * By default, data joins are performed by index, meaning in order of appearance. \n  * For more control over data joins, you can specify a key function. \n\nAs a final note, in the bar chart example, we used this sequence:\n\n  1. Enter \n  2. Update \n  3. Exit \n\nAlthough this worked well for us, this order isn’t set in stone. Depending on\nyour design goals, you might want to update first, then enter new elements,\nand finally exit old ones. It all depends — just remember that once you have\nthe update selection in hand, you can reach in to grab the enter and exit\nselections anytime. The order in which you do so is flexible and completely up\nto you.\n\nFantastic. You are well on your way to becoming a D3 wizard. Now let’s get to\nthe really fun stuff: interactivity!\n\n\n## Chapter 10. Interactivity\n\nNow that you’re an old pro at data updates, transitions, and motion, let’s\nincorporate true interactivity.\n\n\n## Binding Event Listeners\n\nSay _what?_ I know, I know: First, we bound _data_ , which was weird enough.\nAnd now I’m talking about binding _event listeners?_ (This is how JavaScript\nearned its reputation for being such a strange language.)\n\nAs explained in [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), JavaScript\nuses an _event model_ in which “events” are triggered by things happening,\nsuch as new input from the user, provided via a keyboard, mouse, or touch\nscreen. Most of the time, events are being triggered constantly, left and\nright — it’s just that nobody is _listening_ for them, so they are ignored.\n\nTo make our pieces interactive, we define chunks of code that _listen_ for\nspecific events being triggered on specific DOM elements. In [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc), we used\nthe following code:\n\n    \n    \n    d3.select(\"p\")\n        .on(\"click\", function() {\n            //Do something on click\n        });\n\nThis _binds_ an _event listener_ to the `p` paragraph element. The listener\nhappens to be listening for the `click` event, which is the JavaScript event\ntriggered when the user clicks the mouse _on that`p` element_. (D3 doesn’t use\ncustom event names, although you can define your own. For the sake of\nsupporting existing standards, D3 recognizes all the standard JavaScript\nevents, such as `mouseover` and `click`. The events supported vary somewhat by\nbrowser. Peter-Paul Koch’s [event compatibility\ntables](http://www.quirksmode.org/dom/events/) are a useful reference.)\n\nThis gets at one of the nuances of JavaScript’s event model, which is that\nevents don’t happen in a vacuum. Rather, they are always _called on_ a\nspecific element. So the code just shown isn’t activated whenever _any_ click\noccurs; it is run just when a click occurs _on the`p` element_.\n\nYou could achieve all this with raw JavaScript, but D3’s `on()` method is a\nhandy way to quickly bind event listeners to D3 selections. As you can see,\n`on()` takes two arguments: the event name, and an anonymous function to be\nexecuted when the event is triggered on the selected element.\n\nMaking your visualization interactive is a simple, two-step process that\nincludes:\n\n  1. Binding event listeners \n  2. Defining the behavior \n\n\n## Introducing Behaviors\n\nLet’s start by working with an earlier, static version of our bar chart. See\nsample code _01_start.html_.\n\nThe example code binds an event on only one element: `p`. This is an unusual\nusage for `on()`. More commonly, you will want to bind event listeners to more\nthan one element at a time, such as to _all_ of the visual elements in your\nvisualization. Fortunately, that is very easy to do. Instead of using\n`select()` to select only one element, use `selectAll()` to select multiple\nelements and pass that selection to `on()`.\n\nYou can even bind those event listeners right at the moment when you first\ncreate elements. For example, here is our existing code that creates our bar\nchart’s `rect`s, to which I’ve simply tacked on `on()`:\n\n    \n    \n    //Create bars\n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       …   //Set attributes (omitted here)\n       .on(\"click\", function(d) {\n           //This will run whenever *any* bar is clicked\n       });\n\nWhen defining the anonymous function, you can reference `d`, or `d` and `i`,\nor neither, just as you’ve seen throughout D3. And then whatever code you put\nbetween the function’s brackets will execute on click.\n\nThis is a quick and easy way to verify your data values, for example:\n\n    \n    \n    .on(\"click\", function(d) {\n                 console.log(d);\n    });\n\nTry that code by running _02_click.html_ , open the JavaScript console, and\nclick on some bars. When you click on each bar, you should see that bar’s data\nvalue printed to the console. Nice!\n\n### Hover to Highlight\n\nHighlighting elements in response to mouse interaction is a common way to make\nyour visualization feel more responsive, and it can help users navigate and\nfocus on the data of interest.\n\nA simple hover effect can be achieved with CSS alone — no JavaScript required!\nThe CSS pseudoclass selector `:hover` can be used in combination with any\nother selector to select, well, that same thing, but when the mouse is\nhovering _over_ the element. Here, we select all SVG `rect`s and set their\nfill to `orange` (see [Figure\n10-1](part0014_split_002.html#simple_css_only_mouse_hover)):\n\n    \n    \n    rect:hover {\n            fill: orange;\n    }\n\n![A simple CSS-only mouse hover effect](../images/00128.jpeg)\n\nFigure 10-1. A simple CSS-only mouse hover effect\n\nSee _03_hover.html_ , and try it out yourself.\n\nCSS hover styling is fast and easy, but limited. There’s only so much you can\nachieve with `:hover`. Fortunately, recent browsers support applying the new\nCSS3 transitions on SVG elements. Try adding this above the `rect:hover` rule\nin that example:\n\n    \n    \n    rect {\n            -moz-transition: all 0.3s;\n            -o-transition: all 0.3s;\n            -webkit-transition: all 0.3s;\n            transition: all 0.3s;\n    }\n\nThis tells browsers (including Mozilla, Opera, and Webkit-based browsers) to\napply a 0.2-second transition to any changes to the `rect` elements. Run that,\nand you’ll see that the blue/orange switch no longer happens instantly, but\nsmoothly, over a brief 0.2-second period. Nice!\n\nYet these transitions can also be managed using JavaScript and D3, for\nadditional control and coordination with other parts of our visualization.\nLuckily for us, D3 handles all the hassle of transitions for us, so working\nwith JavaScript is not so bad. Let’s re-create the orange hover effect without\nCSS.\n\nInstead of referencing the `click` event, as we did earlier, we can call\n`on()` with `mouseover`, the JavaScript event equivalent of CSS’s `hover`:\n\n    \n    \n    .on(\"mouseover\", function() {\n            //Do something on mouseover of any bar\n    });\n\nNow we want to set the `fill` of _this_ bar (the one on which the `mouseover`\nevent is triggered) to orange. Yet we are operating in the context of an\nanonymous function — how could we possibly select the same element on which\nthe event was just triggered?\n\nThe answer is _this_. No, sorry, I mean `this`. Just select `this`, and set\nits fill to orange:\n\n    \n    \n    .on(\"mouseover\", function() {\n            d3.select(this)\n              .attr(\"fill\", \"orange\");\n    });\n\nAnother reason “real” programmers hate JavaScript is because of its\nnotoriously wishy washy use of the keyword `this`. In other languages, the\nmeaning of `this` is very clearly defined; not so in JavaScript. (jQuery fans\nare used to this debate.)\n\nFor our purposes, here is all you need to know:\n\n  * Context is important. \n  * Within anonymous functions, D3 automatically sets the context of `this` so it references “the current element upon which we are acting.” \n\nThe end result is that, when we hand off anonymous functions to any of D3’s\nmethods, we can reference `this` when trying to act on the current element.\n\nIndeed, you can see this (ha!) in action in _04_mouseover.html_ ([Figure\n10-2](part0014_split_002.html#using_d3)).\n\n![Using D3 to set an orange fill on mouseover](../images/00129.jpeg)\n\nFigure 10-2. Using D3 to set an orange fill on `mouseover`\n\nMove the mouse over a `rect`, the event listener for that `rect` is triggered,\nthat same `rect` is selected (as `this`), and then its fill is set to orange.\n\n[Figure 10-2](part0014_split_002.html#using_d3) looks good, but we should\nprobably restore each bar’s original color once the hover is over, meaning on\n`mouseout`:\n\n    \n    \n    .on(\"mouseout\", function(d) {\n            d3.select(this)\n          .attr(\"fill\", \"rgb(0, 0, \" + (d * 10) + \")\");\n    });\n\nPerfect! Try it yourself in _05_mouseout.html_. See [Figure\n10-3](part0014_split_002.html#results_d3).\n\n![Moving the mouse left to right, with fills set on mouseover and\nmouseout](../images/00130.jpeg)\n\nFigure 10-3. Moving the mouse left to right, with fills set on `mouseover` and\n`mouseout`\n\nI am really excited to have accomplished in eight lines of JavaScript what I\ndid originally with CSS in only three! (Not!)\n\nActually, what I _am_ excited about is to now make the outbound transition\nsilky smooth (see [Figure 10-4](part0014_split_002.html#smooth)). As you\nremember from [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc),\naccomplishing that involves adding only two lines of code, for `transition()`\nand `duration()`:\n\n    \n    \n    .on(\"mouseout\", function(d) {\n        d3.select(this)\n          .transition()\n          .duration(250)\n          .attr(\"fill\", \"rgb(0, 0, \" + (d * 10) + \")\");\n    });\n\nTry that out in _06_smoother.html_.\n\n![Moving the mouse left to right \\(Smooth Operator\nEdition\\)](../images/00131.jpeg)\n\nFigure 10-4. Moving the mouse left to right (Smooth Operator Edition)\n\n* * *\n\n### Pointer Events on Overlapping Elements\n\nMouse events are triggered only on elements with pixels that can be “touched”\nby the mouse. If two elements overlap, and the mouse moves over the element\nthat is “on top” (in other words, closer to the front), then the `mouseover`\nevent will be triggered on the frontmost element, and _not_ on the element\nbehind it.\n\nYou can see this in _06_smoother.html_. Mouse over any bar, and then move your\npointer directly above one of the value labels. You’ll see the bar fade back\nfrom orange to blue. The `text` elements are in front of the bars, so mousing\nover a label involves also _mousing out_ of the `rect` behind it. This is\ncounterintuitive because, visually, we haven’t left the `rect` at all, but as\nfar as JavaScript is concerned, we have.\n\nRemember that in SVG, elements placed later in the DOM are rendered visually\n“in front” of earlier elements. (See the section “Layering and Drawing Order”\nin [Chapter\n3](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc).)\n\nIn many cases, you might want mouse events on some elements (such as our value\nlabels) to be ignored. Luckily, this is as easy as applying one line of CSS to\nthe elements you wish to have ignored:\n\n    \n    \n    pointer-events: none;\n\nThis magically tells the browser “Hey, this element shouldn’t trigger any\npointer events (such as `click`, `mouseover`, or `mouseout`), so just behave\nas if this element isn’t here.” It lets events pass through to the next\nelement below it.\n\nUse normal CSS selectors to target the appropriate elements. For example, this\nwould apply that to all SVG `text` elements:\n\n    \n    \n    svg text {\n            pointer-events: none;\n    }\n\nOr, instead of including this in a stylesheet, you could specify the CSS with\nD3 directly when you create the `text` element, for example:\n\n    \n    \n    svg.append(\"text\")\n            …  //other stuff here\n            .style(\"pointer-events\", \"none\");\n\n* * *\n\n\n## Grouping SVG Elements\n\nNote that `g` group elements _do not_ , by themselves, trigger any mouse\nevents. The reason for this is that `g` elements have no pixels! Only their\nenclosed elements — like `rect`s, `circle`s, and `text` elements — have\npixels.\n\nYou can still bind event listeners to `g` elements. Just keep in mind that the\nelements within that `g` will then behave as a group. For example, if _any_ of\nthe enclosed elements are clicked or moused over, then the listener function\nwill be activated.\n\nThis technique can be quite useful when you have several visual elements that\nshould all act in concert. In our bar chart, for example, we could group\n`rect` and `text` elements each into their own groups. The element hierarchy\ncurrently looks like this:\n\n    \n    \n    svg\n            rect\n            rect\n            rect\n            …\n            text\n            text\n            text\n            …\n\nAfter grouping elements, it could look like this:\n\n    \n    \n    svg\n            g\n                    rect\n                    text\n            g\n                    rect\n                    text\n            …\n\nInstead of worrying about `pointer-events` and which element is on top, we\njust bind the event listener to the whole group. So clicking on some `text`\nwill trigger the same code as clicking on a `rect` because they’re both in the\nsame group.\n\nEven better, throw an invisible `rect` with a `fill` of `none` and `pointer-\nevents` value of `all` on the top of each group. Even though the `rect` is\ninvisible, it will still trigger mouse events, so you could have the `rect`\nspan the whole height of the chart. The net effect is that mousing _anywhere_\nin that column — even in “empty” whitespace above a short blue bar — would\ntrigger the highlight effect.\n\n### Click to Sort\n\nInteractive visualization is most powerful when it can provide different\n_views_ of the data, empowering the user to explore the information from\ndifferent angles.\n\nThe ability to _sort_ data is extremely important. And yes, as you just\nguessed, D3 makes it very easy to sort elements.\n\nContinuing with the bar chart, let’s add an event listener for the `click`\nevent, to which we bind an anonymous function that, in turn, will call a new\nfunction of our own creation, `sortBars()`.\n\n    \n    \n    …\n    .on(\"click\", function() {\n            sortBars();\n    });\n\nFor simplicity, we are binding this to every bar, but of course you could bind\nthis instead to a button or any other element, inside or outside of the SVG\nimage.\n\nAt the end of the code, let’s define this new function and store it in\n`sortBars`:\n\n    \n    \n    var sortBars = function() {\n    \n            svg.selectAll(\"rect\")\n               .sort(function(a, b) {\n                     return d3.ascending(a, b);\n               })\n               .transition()\n               .duration(1000)\n               .attr(\"x\", function(d, i) {\n                     return xScale(i);\n               });\n    \n    };\n\nYou can see this code in _07_sort.html_ and the result in [Figure\n10-5](part0014_split_003.html#click-to-sort). Try clicking any of the bars,\nand watch them reorganize.\n\n![The view after click-to-sort](../images/00132.jpeg)\n\nFigure 10-5. The view after click-to-sort\n\nWhen `sortBars()` is called, first we reselect all the `rect`s. Then we use\nD3’s handy `sort()` method, which reorders elements based on their bound data\nvalues. `sort()` needs to know how to decide which elements come first, and\nwhich later, so we pass into it a _comparator_ function.\n\nUnlike our anonymous functions so far, the comparator doesn’t take `d` (the\ncurrent datum) or `i` (the current index). Instead, it is passed _two values_\n, `a` and `b`, which represent the data values of two different elements. (You\ncould name them anything else; `a` and `b` are just the convention.) The\ncomparator will be called on every pair of elements in our array, comparing\n`a` to `b`, until, in the end, all the array elements are sorted per whatever\nrules we specify.\n\nWe specify _how_ `a` and `b` should be compared within the comparator.\nThankfully, D3 also provides a handful of comparison functions that spare us\nfrom writing more JavaScript. Here, we use `d3.ascending()`, into which both\n`a` and `b` are passed. Whichever one is bigger comes out the winner. And\n`sort()` loops through all the data values in this way until it has all the\nelements, er, sorted out. (Note that `d3.ascending` works well in this case,\nbecause our values are numbers. Comparing strings of text is a whole other can\nof worms.)\n\nFinally, our new order in place, we initiate a transition, set a duration of\none second, and then calculate the new `x` position for each `rect`. (This\n`attr` code is just copied from when we created the `rect`s initially.)\n\nThis works swimmingly, except for two catches.\n\nFirst, you’ll notice that we haven’t accounted for the value labels yet, so\nthey didn’t slide into place along with the bars. (I leave that to you as an\nexercise.)\n\nSecond, you might observe that if you mouse over some bars _while_ the\ntransition is occurring, those bars don’t fall properly into place (see\n[Figure 10-6](part0014_split_003.html#interrupted)).\n\n![Transitions, interrupted](../images/00133.jpeg)\n\nFigure 10-6. Transitions, interrupted\n\nYeeesh, that doesn’t look good.\n\nRemember from [Chapter\n9](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc) that newer\ntransitions interrupt and override older transitions. Clicking the bars\ninitiates one transition. Immediately mousing over a bar interrupts that\ninitial transition in order to run the `mouseover` highlight transition we\nspecified earlier. The end result is that those moused-over bars never make it\nto their final destinations.\n\nBut don’t worry. This example is just a good argument for keeping hover\neffects in CSS, while letting D3 and JavaScript manage the more visually\nintensive actions.\n\nIn _08_sort_hover.html_ , I’ve restored the CSS-only highlight and removed the\n`mouseover` and `mouseout` event listeners, so this transition conflict no\nlonger occurs. (The only downside is we no longer have those smooth orange-to-\nblue fades.)\n\nSo far, this sort only goes one direction. Let’s revise this so a second click\ntriggers a re-sort, placing the bars in descending order.\n\nTo remember the current state of the chart, we’ll need a Boolean variable:\n\n    \n    \n    var sortOrder = false;\n\nThen, in the `sortBars()` function, we should flip the value of `sortOrder`,\nso if it starts out `true`, it is changed to `false`, and vice versa:\n\n    \n    \n    var sortBars = function() {\n    \n            //Flip value of sortOrder\n            sortOrder = !sortOrder;\n    \n            …\n\nDown in the comparator function, we can add a bit of logic to say _if_\n`sortOrder` is `true`, then go ahead and sort the bars in _ascending_ order.\nOtherwise, use _descending_ order:\n\n    \n    \n            svg.selectAll(\"rect\")\n               .sort(function(a, b) {\n                            if (sortOrder) {\n                                    return d3.ascending(a, b);\n                            } else {\n                                    return d3.descending(a, b);\n                            }\n                    })\n                    …\n\nGive that a shot in _09_resort.html_. Now each time you click, the sort order\nreverses, as shown in [Figure 10-7](part0014_split_003.html#second-sort).\n\n![The second sort, now in descending order](../images/00134.jpeg)\n\nFigure 10-7. The second sort, now in descending order\n\nOne more thing would make this really nice: a per-element delay. (Remember\nthat whole “object constancy” thing?)\n\nAs you know, to do that, we just add a simple `delay()` statement after\n`transition()`:\n\n    \n    \n    …\n    .transition()\n    .delay(function(d, i) {\n            return i * 50;\n    })\n    .duration(1000)\n    …\n\nNow take a look at _10_delay.html_ , in which you can easily follow individual\nbars with your eyes as they move left and right during each sort.\n\n\n## Tooltips\n\nIn interactive visualizations, tooltips are small overlays that present data\nvalues. In many cases, it’s not necessary to label every individual data value\nin the default view, but that level of detail should still be accessible to\nusers. That’s where tooltips come in.\n\nIn this section, I present three different methods to constructing tooltips\nwith D3, ranging from the simplest to the most complex.\n\n### Default Browser Tooltips\n\nThese should be your first stop. A quick-and-dirty, functional but not pretty\noption, default browser tooltips are usually those ugly yellow boxes you see\nfloating over content when you hold your mouse still for too long. These are\nvery easy to make, and the browser manages the placements for you, but you\nhave zero control over how they look — that’s also set by the browser.\n\n[Figure 10-8](part0014_split_004.html#safari-tooltip) shows our bar chart,\nwith value labels removed, and default browser tooltips implemented. The\ntooltips show up after hovering the mouse over any bar for a few seconds.\n\n![A ridiculously simple default browser tooltip, as seen in\nSafari](../images/00135.jpeg)\n\nFigure 10-8. A ridiculously simple default browser tooltip, as seen in Safari\n\nSee _11_browser_tooltip.html_ for the code and a demo. To make these tooltips,\nsimply inject a `title` element into whatever element should have the tooltip\napplied. For example, after we create all those `rect`s:\n\n    \n    \n    svg.selectAll(\"rect\")\n       .data(dataset)\n       .enter()\n       .append(\"rect\")\n       …\n\nwe can just tack on to the end of that chain:\n\n    \n    \n       .append(\"title\")\n       .text(function(d) {\n             return d;\n       });\n\n`append()` creates the new `title` element, and then `text()` sets its content\nto `d`, the bound value.\n\nWe could make this text a little less spare by prefixing it with something\n(see [Figure 10-9](part0014_split_004.html#default-tooltip)):\n\n    \n    \n       .append(\"title\")\n       .text(function(d) {\n             return \"This value is \" + d;\n       });\n\n![A default browser tooltip, with a prefix added](../images/00136.jpeg)\n\nFigure 10-9. A default browser tooltip, with a prefix added\n\nSee _12_browser_tooltip_text.html_ for that code.\n\n### SVG Element Tooltips\n\nFor more visual control over your tooltips, code them as SVG elements.\n\nAs usual, there are many different approaches you could take. I’ll suggest\nadding event listeners, so on each `mouseover`, a new value label is created,\nand on `mouseout` it is destroyed. (Another idea would be to pregenerate all\nthe labels, but then just show or hide them based on mouse hover status. Or\njust stick with one label, but show or hide it and change its position as\nneeded.)\n\nBack to the bars we go. We’ll add back in a `mouseover` event listener, in\nwhich we first get the `x` and `y` values for the current element (`this`,\nremember?). We’ll need this information to know where to place the new\ntooltip, so it appears nicely “on top of” the bar that’s triggering the\nrollover.\n\nWhen we retrieve those values, we wrap them in `parseFloat()`, which is a\nJavaScript function for “Hey, even if this information is a string of text,\nplease convert it to a floating point number for me.”\n\nLastly, I’m adding a bit to both the `x` and `y` values, to center the new\ntooltips near the top of any given bar:\n\n    \n    \n    .on(\"mouseover\", function(d) {\n    \n    //Get this bar's x/y values, then augment for the tooltip\n    var xPosition = parseFloat(d3.select(this).attr(\"x\")) + xScale.rangeBand() / 2;\n    var yPosition = parseFloat(d3.select(this).attr(\"y\")) + 14;\n\nThat’s the hard part. Now all we do is create the tooltip as a simple `text`\nelement, in this case, but of course you could add a background `rect` or do\nanything else here for visual effect:\n\n    \n    \n    //Create the tooltip label\n    svg.append(\"text\")\n      .attr(\"id\", \"tooltip\")\n      .attr(\"x\", xPosition)\n      .attr(\"y\", yPosition)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-family\", \"sans-serif\")\n      .attr(\"font-size\", \"11px\")\n      .attr(\"font-weight\", \"bold\")\n      .attr(\"fill\", \"black\")\n      .text(d);\n    \n    })\n\nYes, this is based on our earlier value label code, simply adapted slightly.\nNote that the `x` and `y` attributes are set to the new position values we\njust calculated, and the actual text content of the label is set to `d`, the\ndatum passed into the event listener function.\n\nAlso note that I assigned this next `text` element an ID of `tooltip`. This is\nso we can easily select (and delete!) the element when we’re done with it — on\n`mouseout`:\n\n    \n    \n    .on(\"mouseout\", function() {\n    \n    //Remove the tooltip\n    d3.select(\"#tooltip\").remove();\n    \n    })\n\nTest out the code in _13_svg_tooltip.html_.\n\nAs you can see in [Figure 10-10](part0014_split_004.html#element-tooltip), you\nhave much more visual control when using SVG elements as tooltips, but they\nare a little more time-consuming to set up. And of course, you can get much\nfancier than this simple example.\n\n![An SVG element tooltip](../images/00137.gif)\n\nFigure 10-10. An SVG element tooltip\n\n### HTML div Tooltips\n\nA similar approach can be used with HTML `div` elements as tooltips. You might\nconsider using a `div` when:\n\n  * You want to achieve a visual effect that isn’t possible or well-supported with SVG (such as CSS drop shadows) \n  * You need the tooltips to extend beyond the frame of the SVG image\n\nSee Figures [10-11](part0014_split_004.html#div-tooltip) and\n[10-12](part0014_split_004.html#overlapping-tooltip) for examples.\n\n![An HTML div tooltip](../images/00138.jpeg)\n\nFigure 10-11. An HTML div tooltip\n\n![An HTML div tooltip, overlapping the bounds of the SVG image\nbeneath](../images/00139.jpeg)\n\nFigure 10-12. An HTML div tooltip, overlapping the bounds of the SVG image\nbeneath\n\nAgain, there are many ways to do this, but I like to make a hidden `div` in my\nHTML that gets populated with the data value, and is then unhidden when\ntriggered. You can follow along with the final code in _14_div_tooltip.html_.\n\nThe `div` itself could be created dynamically with D3, but I like to just type\nit in by hand:\n\n    \n    \n    <div id=\"tooltip\" class=\"hidden\">\n            <p><strong>Important Label Heading</strong></p>\n            <p><span id=\"value\">100</span>%</p>\n    </div>\n\nNow it’s going to need some special CSS styling rules:\n\n    \n    \n    #tooltip {\n            position: absolute;\n            width: 200px;\n            height: auto;\n            padding: 10px;\n            background-color: white;\n            -webkit-border-radius: 10px;\n            -moz-border-radius: 10px;\n            border-radius: 10px;\n            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);\n            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);\n            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);\n            pointer-events: none;\n    }\n    \n    #tooltip.hidden {\n            display: none;\n    }\n    \n    #tooltip p {\n            margin: 0;\n            font-family: sans-serif;\n            font-size: 16px;\n            line-height: 20px;\n    }\n\nNote in particular that its `position` is `absolute`, so we can control\nexactly where it should appear on the page. I’ve also added some fancy rounded\ncorners and a drop shadow. Plus, `pointer-events: none` ensures that mousing\nover the tooltip itself won’t trigger a `mouseout` event on the bars, thereby\nhiding the tooltip. (Try the code without this line, and you’ll see what I\nmean.) Lastly, when the tooltip is given a class of `hidden`, it is not\ndisplayed.\n\nI made some modifications to the `mouseover` function, so the `div` is roughly\ncentered vertically against its triggering bar. The revised code now also sets\nthe tooltip’s `left` and `top` position per CSS layout requirements, sets the\ntext content of the `#value` span to `d`, and then — now that everything is in\nplace — removes the `hidden` class, making the tooltip visible:\n\n    \n    \n    .on(\"mouseover\", function(d) {\n    \n    //Get this bar's x/y values, then augment for the tooltip\n    var xPosition = parseFloat(d3.select(this).attr(\"x\")) + xScale.rangeBand() / 2;\n    var yPosition = parseFloat(d3.select(this).attr(\"y\")) / 2 + h / 2;\n    \n    //Update the tooltip position and value\n    d3.select(\"#tooltip\")\n      .style(\"left\", xPosition + \"px\")\n      .style(\"top\", yPosition + \"px\")\n      .select(\"#value\")\n      .text(d);\n    \n    //Show the tooltip\n    d3.select(\"#tooltip\").classed(\"hidden\", false);\n    \n    })\n\nHiding the tooltip on `mouseout` is much easier; simply add on the `hidden`\nclass:\n\n    \n    \n    .on(\"mouseout\", function() {\n    \n    //Hide the tooltip\n    d3.select(\"#tooltip\").classed(\"hidden\", true);\n    \n    })\n\n* * *\n\n### Warning\n\nThe layout of this simple example works well, but in a real-world situation,\nthe D3 chart would be just one of many other elements on the page. As you\nprobably know, perfecting HTML/CSS layouts can be a challenge, and this is the\nbiggest hassle of getting HTML elements to interact properly with an SVG\nchart. It can help to put both the tooltip `div` and SVG chart within the same\nenclosing element (like a container `div`), so then you only have to worry\nabout relative positions.\n[`d3.mouse`](https://github.com/mbostock/d3/wiki/Selections#wiki-d3_mouse) can\nbe used to get mouse coordinates relative to any other element on the page,\nand can be useful in cases when you need to position non-SVG elements in\nrelationship to the mouse.\n\n* * *\n\n\n## Consideration for Touch Devices\n\nThe browsers on most popular touch devices — such as iOS and Android devices —\nautomatically translate touch events into mouse events, for JavaScript\npurposes. So a tap on an element is interpreted by the browser as a `click`\nevent. This means that, for the most part, your code that was crafted for\nmouse interfaces will also work just fine for touch-based interfaces.\n\nThe primary exception to this is multitouch, which is not automagically\nhandled by D3. There’s no easy answer on how to handle multitouch interactions\nyet, but D3 _does_ track the touches for you (although it’s up to you to\ndecide how to use them). See the API reference for\n[`d3.touches`](https://github.com/mbostock/d3/wiki/Selections#wiki-d3_touches).\n\n\n## Moving Forward\n\nCongratulations! You now have all the basics of D3 under your cap. You are a\npro at binding data, generating and styling elements based on that data,\nimplementing scales and drawing axes, and modifying your creations with new\ndata, animated transitions, and interactivity. What more could you ask for?\n\nHow about layouts and geomaps? The next two chapters will dive into these more\nadvanced topics, but — be warned — without the same level of detail as the\nprior chapters. Now that you know the basics, you don’t need every little\nthing spelled out. Here we go!\n\n\n## Chapter 11. Layouts\n\nContrary to what the name implies, D3 _layouts_ do not, in fact, lay anything\nout for you on the screen. The layout methods have no direct _visual_ output.\nRather, D3 layouts take data that you provide and remap or otherwise transform\nit, thereby generating _new_ data that is more convenient for a specific\nvisual task. It’s still up to you to take that new data and generate visuals\nfrom it.\n\nHere is a complete list of all D3 layouts:\n\n  * Bundle \n  * Chord \n  * Cluster \n  * Force \n  * Histogram \n  * Pack \n  * Partition \n  * Pie \n  * Stack \n  * Tree \n  * Treemap \n\nIn this chapter, I introduce three of the most common: _pie_ , _stack_ , and\n_force_. Each layout performs a different function, and each has its own\nidiosyncrasies.\n\nIf you are curious about any of the other D3 layouts, check out [the many\nexamples on the D3 website](https://github.com/mbostock/d3/wiki/Gallery), and\nbe sure to reference [the official API documentation on\nlayouts](https://github.com/mbostock/d3/wiki/Layouts).\n\n\n## Pie Layout\n\n`d3.layout.pie()` might not be as delicious as it sounds, but it’s still\nworthy of your attention. Obviously, its typical use is for creating pie\ncharts, like the example in [Figure\n11-1](part0015_split_001.html#simple_pie_chart).\n\n![A simple pie chart](../images/00140.jpeg)\n\nFigure 11-1. A simple pie chart\n\nFeel free to open up the sample code for this in _01_pie.html_ and poke\naround.\n\nTo draw those pretty wedges, we need to know a number of measurements,\nincluding an inner and outer radius for each wedge, plus the starting and\nending angles. The purpose of the pie layout is to take your data and\ncalculate all those messy angles for you, sparing you from ever having to\nthink about radians.\n\nRemember radians? In case you don’t, here’s a quick refresher. Just as there\nare 360° in a circle, there are 2π radians. So π radians equals 180°, or half\na circle. Most people find it easier to think in terms of degrees; computers\nprefer radians.\n\nFor this pie chart, let’s start, as usual, with a very simple dataset:\n\n    \n    \n    var dataset = [ 5, 10, 20, 45, 6, 25 ];\n\nWe can define a default pie layout very simply as:\n\n    \n    \n    var pie = d3.layout.pie();\n\nThen, all that remains is to hand off our data to the new `pie()` function, as\nin `pie(dataset)`. Compare the datasets before and after in [Figure\n11-2](part0015_split_001.html#pieified_data).\n\n![Your data, pie-ified](../images/00141.jpeg)\n\nFigure 11-2. Your data, pie-ified\n\nThe pie layout takes our simple array of numbers and generates an array of\nobjects, one object for each value. Each of those objects now has a few new\nvalues — most important, `startAngle` and `endAngle`. Wow, that was easy!\n\nNow, to actually draw the wedges, we turn to `d3.svg.arc()`, a handy built-in\nfunction for drawing arcs as SVG `path` elements. We haven’t talked about\n`path`s yet, but they are SVG’s answer to drawing irregular forms. Anything\nthat’s not a `rect`, `circle`, or another basic shape can be drawn as a\n`path`. The catch is, the syntax for defining `path` values is not\nparticularly human-friendly. For example, here’s the code for the big, red\nwedge in [Figure 11-1](part0015_split_001.html#simple_pie_chart):\n\n    \n    \n    <path fill=\"#d62728\" d=\"M9.184850993605149e-15,-150A150,150 0 0,1\n            83.99621792063931,124.27644738657631L0,0Z\"></path>\n\nIf you can understand that, then you don’t need this book.\n\nThe bottom line is, it’s best to let functions like `d3.svg.arc()` handle\ngenerating `path`s programatically. You don’t want to try writing this stuff\nout by hand.\n\nArcs are defined as custom functions, and they require inner and outer radius\nvalues:\n\n    \n    \n    var w = 300;\n    var h = 300;\n    \n    var outerRadius = w / 2;\n    var innerRadius = 0;\n    var arc = d3.svg.arc()\n                    .innerRadius(innerRadius)\n                    .outerRadius(outerRadius);\n\nHere I’m setting the size of the whole chart to be 300 by 300 square. Then I’m\nsetting the `outerRadius` to half of that, or 150. The `innerRadius` is zero.\nWe’ll revisit `innerRadius` in a moment.\n\nWe’re ready to draw some wedges! First, we create the SVG element, per usual:\n\n    \n    \n    //Create SVG element\n    var svg = d3.select(\"body\")\n                .append(\"svg\")\n                .attr(\"width\", w)\n                .attr(\"height\", h);\n\nThen we can create new groups for each incoming wedge, binding the pie-ified\ndata to the new elements, and translating each group into the center of the\nchart, so the `path`s will appear in the right place:\n\n    \n    \n    //Set up groups\n    var arcs = svg.selectAll(\"g.arc\")\n            .data(pie(dataset))\n            .enter()\n            .append(\"g\")\n            .attr(\"class\", \"arc\")\n            .attr(\"transform\", \"translate(\" + outerRadius + \", \" + outerRadius + \")\");\n\nNote that we’re saving a reference to each newly created `g` in a variable\ncalled `arcs`.\n\nFinally, within each new `g`, we append a `path`. A `path`s path description\nis defined in the `d` attribute. So here we call the `arc` generator, which\ngenerates the path information based on the data already bound to this group:\n\n    \n    \n    //Draw arc paths\n    arcs.append(\"path\")\n        .attr(\"fill\", function(d, i) {\n            return color(i);\n        })\n        .attr(\"d\", arc);\n\nOh, and you might be wondering where those colors are coming from. If you\ncheck out _01_pie.html_ , you’ll note this line:\n\n    \n    \n    var color = d3.scale.category10();\n\nD3 has a number of handy ways to generate categorical colors. These might not\nbe your favorite colors, but they are quick to drop into any visualization\nwhile you’re in the prototyping stage. `d3.scale.category10()` creates an\n_ordinal_ scale with an output range of 10 different colors. (See [the\nwiki](https://github.com/mbostock/d3/wiki/Ordinal-Scales) for more information\non these color scales as well as perceptually calibrated color palettes, based\non research by Cynthia Brewer, that are included with D3.)\n\nLastly, we can generate text labels for each wedge:\n\n    \n    \n    arcs.append(\"text\")\n        .attr(\"transform\", function(d) {\n            return \"translate(\" + arc.centroid(d) + \")\";\n        })\n        .attr(\"text-anchor\", \"middle\")\n        .text(function(d) {\n            return d.value;\n        });\n\nNote that in `text()`, we reference the value with `d.value` instead of just\n`d`. This is because we bound the pie-ified data, so instead of referencing\nour original array (`d`), we have to reference the array of objects\n(`d.value`).\n\nThe only thing new here is `arc.centroid(d)`. WTH? A _centroid_ is the\ncalculated center point of any shape, whether that shape is regular (like a\nsquare) or highly irregular (like an outline of the state of Maryland).\n`arc.centroid()` is a super-helpful function that calculates and returns the\ncenter point of any arc. We translate each `text` label element to each arc’s\ncentroid, and that’s how we get the text labels to float right in the middle\nof each wedge.\n\nBonus tip: Remember how `arc()` required an `innerRadius` value? We can expand\nthat to anything greater than zero, and our pie chart becomes a _ring_ chart\nlike the one shown in [Figure\n11-3](part0015_split_001.html#simple_ring_chart):\n\n    \n    \n    var innerRadius = w / 3;\n\n![A simple ring chart](../images/00142.jpeg)\n\nFigure 11-3. A simple ring chart\n\nCheck it out in _02_ring.html_.\n\nOne more thing: The pie layout automatically reordered our data values from\nlargest to smallest. Remember, we started with `[ 5, 10, 20, 45, 6, 25 ]`, so\nthe small value of 6 should have appeared between 45 and 25, but no — the\nlayout sorted our values in descending order, so the chart began with 45 at\nthe 12 o’clock position, and everything just goes clockwise from there.\n\n\n## Stack Layout\n\n`d3.layout.stack()` converts two-dimensional data into “stacked” data; it\ncalculates a baseline value for each datum, so you can “stack” layers of data\non top of one another. This can be used to generate stacked bar charts,\nstacked area charts, and even streamgraphs (which are just stacked area charts\nbut without the rigid starting baseline value of zero).\n\nFor example, we’ll start with the stacked bar chart in [Figure\n11-4](part0015_split_002.html#simple_stacked_bar_chart).\n\n![A simple stacked bar chart](../images/00143.gif)\n\nFigure 11-4. A simple stacked bar chart\n\nLet’s say you had some data like this:\n\n    \n    \n    var dataset = [\n            { apples: 5, oranges: 10, grapes: 22 },\n            { apples: 4, oranges: 12, grapes: 28 },\n            { apples: 2, oranges: 19, grapes: 32 },\n            { apples: 7, oranges: 23, grapes: 35 },\n            { apples: 23, oranges: 17, grapes: 43 }\n    ];\n\nThe first step is to rearrange that data into an array of arrays. Each array\nrepresents the data for one category (e.g., apples, oranges, or grapes).\nWithin each category array, you’ll need an object for each data value, which\nitself must contain an `x` and a `y` value. The `x` in our case is just an ID\nnumber. The `y` is the actual data value:\n\n    \n    \n    var dataset = [\n            [\n                    { x: 0, y: 5 },\n                    { x: 1, y: 4 },\n                    { x: 2, y: 2 },\n                    { x: 3, y: 7 },\n                    { x: 4, y: 23 }\n            ],\n            [\n                    { x: 0, y: 10 },\n                    { x: 1, y: 12 },\n                    { x: 2, y: 19 },\n                    { x: 3, y: 23 },\n                    { x: 4, y: 17 }\n            ],\n            [\n                    { x: 0, y: 22 },\n                    { x: 1, y: 28 },\n                    { x: 2, y: 32 },\n                    { x: 3, y: 35 },\n                    { x: 4, y: 43 }\n            ]\n    ];\n\nOur original `dataset` looks like [Figure\n11-5](part0015_split_002.html#prestacked_data) in the console.\n\n![The data before stacking](../images/00144.jpeg)\n\nFigure 11-5. The data before stacking\n\nThen we initialize our stack layout function, and call it on `dataset`:\n\n    \n    \n    var stack = d3.layout.stack();\n    stack(dataset);\n\nNow the stacked data is shown in [Figure\n11-6](part0015_split_002.html#stacked_data).\n\n![The data after stacking](../images/00145.jpeg)\n\nFigure 11-6. The data after stacking\n\nCan you spot the difference? In the stacked data, each object has been given a\n`y0` value. This is the _baseline_ value. Notice that the `y0` baseline value\nis equal to the sum of all the `y` values in the preceding categories. For\nexample, reading left to right across the top, the first object’s `y` value is\n5, and its `y0` is zero. To the right (in the oranges column), the first\nobject has a `y` value of 10, and a `y0` of 5. (Aha! That’s just the value of\nthe first object’s `y`!) On the far right (in the grapes column), we see a `y`\nvalue of 22, and a `y0` of 15 (which is just 5 + 10).\n\nTo “stack” elements visually, now we can reference each data object’s baseline\nvalue as well as its height. See all the code in _03_stacked_bar.html_. (I\nleave it as an exercise to you to align the stacks against the bottom x-axis.)\nHere’s the critical excerpt:\n\n    \n    \n    var rects = groups.selectAll(\"rect\")\n            .data(function(d) { return d; })\n            .enter()\n            .append(\"rect\")\n            .attr(\"x\", function(d, i) {\n                    return xScale(i);\n            })\n            .attr(\"y\", function(d) {\n                    return yScale(d.y0);\n            })\n            .attr(\"height\", function(d) {\n                    return yScale(d.y);\n            })\n            .attr(\"width\", xScale.rangeBand());\n\nNote how for `y` and `height` we reference `d.y0` and `d.y`, respectively.\n\n\n## Force Layout\n\nForce-directed layouts are so-called because they use simulations of physical\n_forces_ to arrange elements on the screen. Arguably, they are a bit overused,\nyet they make a great demo and just look _so darn cool_. Everyone wants to\nlearn how to make one, so let’s talk about it.\n\nForce layouts are typically used with network data. In computer science, this\nkind of dataset is called a _graph_. A simple graph is a list of _nodes_ and\n_edges_. The nodes are entities in the dataset, and the edges are the\n_connections_ between nodes. Some nodes will be connected by edges, and others\nwon’t. Nodes are commonly represented as circles, and edges as lines. But of\ncourse the visual representation is up to you — D3 just helps manage all the\nmechanics behind the scenes.\n\nThe physical metaphor here is of particles that repel each other, yet are also\nconnected by springs. The repelling forces push particles away from each\nother, preventing visual overlap, and the springs prevent them from just\nflying out into space, thereby keeping them on the screen where we can see\nthem.\n\n[Figure 11-7](part0015_split_003.html#force_layouta) provides a visual preview\nof what we’re coding toward.\n\n![A simple force layout](../images/00146.jpeg)\n\nFigure 11-7. A simple force layout\n\nD3’s force layout expects us to provide nodes and edges separately, as arrays\nof objects. Here we have one `dataset` object that contains two elements,\n`nodes` and `edges`, each of which is itself an array of objects:\n\n    \n    \n    var dataset = {\n            nodes: [\n                    { name: \"Adam\" },\n                    { name: \"Bob\" },\n                    { name: \"Carrie\" },\n                    { name: \"Donovan\" },\n                    { name: \"Edward\" },\n                    { name: \"Felicity\" },\n                    { name: \"George\" },\n                    { name: \"Hannah\" },\n                    { name: \"Iris\" },\n                    { name: \"Jerry\" }\n            ],\n            edges: [\n                    { source: 0, target: 1 },\n                    { source: 0, target: 2 },\n                    { source: 0, target: 3 },\n                    { source: 0, target: 4 },\n                    { source: 1, target: 5 },\n                    { source: 2, target: 5 },\n                    { source: 2, target: 5 },\n                    { source: 3, target: 4 },\n                    { source: 5, target: 8 },\n                    { source: 5, target: 9 },\n                    { source: 6, target: 7 },\n                    { source: 7, target: 8 },\n                    { source: 8, target: 9 }\n            ]\n    };\n\nAs usual for D3, you can store whatever data you like within these objects.\nOur nodes are simple — just names of people. The edges contain two values\neach: a source ID and a target ID. These IDs correspond to the nodes above, so\nID number 3 is Donovan, for example. If 3 is connected to 4, then Donovan is\nconnected to Edward.\n\nThe data shown is a bare minimum for using the force layout. You can add more\ninformation, and, in fact, D3 will itself add a lot more data to what we’ve\nprovided, as we’ll see in a moment.\n\nHere’s how to initialize a force layout:\n\n    \n    \n    var force = d3.layout.force()\n                         .nodes(dataset.nodes)\n                         .links(dataset.edges)\n                         .size([w, h])\n                         .start();\n\nAgain, this is just the bare minimum. We specify the nodes and links to be\nused, the size of the available space, and then call `start()` when we’re\nready to go.\n\nThis generates a default force layout, but the default won’t be ideal for\nevery dataset. As you would expect, there are all kinds of options for\ncustomization. [See the API wiki](https://github.com/mbostock/d3/wiki/Force-\nLayout) for all the gory details. Here, I’ve increased the `linkDistance` (the\nlength of the edges between connected nodes) as well as the negative `charge`\nbetween nodes, so they will repel each other more. (It’s not personal; I just\nwant them to spread out a bit.)\n\n    \n    \n    var force = d3.layout.force()\n                         .nodes(dataset.nodes)\n                         .links(dataset.edges)\n                         .size([w, h])\n                         .linkDistance([50])        // <-- New!\n                         .charge([-100])            // <-- New!\n                         .start();\n\nNext, we create an SVG line for each edge:\n\n    \n    \n    var edges = svg.selectAll(\"line\")\n            .data(dataset.edges)\n            .enter()\n            .append(\"line\")\n            .style(\"stroke\", \"#ccc\")\n            .style(\"stroke-width\", 1);\n\nNote that I set all the lines to have the same stroke color and weight, but of\ncourse you could set this dynamically based on data (say, thicker or darker\nlines for “stronger” connections, or some other value).\n\nThen, we create an SVG circle for each node:\n\n    \n    \n    var nodes = svg.selectAll(\"circle\")\n            .data(dataset.nodes)\n            .enter()\n            .append(\"circle\")\n            .attr(\"r\", 10)\n            .style(\"fill\", function(d, i) {\n                    return colors(i);\n            })\n            .call(force.drag);\n\nI set all circles to have the same radius, but each gets a different color\nfill, just because it’s prettier that way. Of course, these values could be\nset dynamically, too, for a more useful visualization.\n\nYou’ll notice the last line of code, which enabled drag-and-drop interaction.\n(Comment that out, and the user won’t be able to move nodes around.)\n\nLastly, we have to specify what happens when the force layout “ticks.” Yes,\nthese ticks are different from the axis ticks addressed earlier, and\ndefinitely different from those little blood-sucking insects. Physics\nsimulations use the word “tick” to refer to the passage of some amount of\ntime, like the ticking second hand of a clock. For example, if an animation\nwere running at 30 frames per second, you could have one tick represent 1/30th\nof a second. Then each time the simulation ticked, you’d see the calculations\nof motion update in real time. In some applications, it’s useful to run ticks\nfaster than actual time. For example, if you were trying to model the effects\nof climate change on the planet 50 years from now, you wouldn’t want to wait\n50 years to see the results, so you’d program the system to tick on ahead,\nfaster than real time.\n\nFor our purposes, what you need to know is that D3’s force layout “ticks”\nforward through time, just like every other physics simulation. With each\ntick, the force layout adjusts the position values for each node and edge\naccording to the rules we specified when the layout was first intialized. To\nsee this progress visually, we need to update the associated elements — the\nlines and circles:\n\n    \n    \n    force.on(\"tick\", function() {\n    \n    edges.attr(\"x1\", function(d) { return d.source.x; })\n         .attr(\"y1\", function(d) { return d.source.y; })\n         .attr(\"x2\", function(d) { return d.target.x; })\n         .attr(\"y2\", function(d) { return d.target.y; });\n    \n    nodes.attr(\"cx\", function(d) { return d.x; })\n         .attr(\"cy\", function(d) { return d.y; });\n    \n    });\n\nThis tells D3, “Okay, every time you tick, take the new x/y values for each\nline and circle and update them in the DOM.”\n\nWait a minute. Where did these x/y values come from? We had only specified\n`name`s, `source`s, and `target`s!\n\nD3 calculated those x/y values and appended them to the existing objects in\nour original `dataset` (see [Figure\n11-8](part0015_split_003.html#force_data_added)). Go ahead and open up\n_04_force.html_ , and type **`dataset`** into the console. Expand any node or\nedge, and you’ll see lots of additional data that we didn’t provide. That’s\nwhere D3 stores the information it needs to continue running the physics\nsimulation. With `on(\"tick\", …)`, we are just specifying how to take those\nupdated coordinates and map them on to the visual elements in the DOM.\n\n![The first node in dataset, with lots of supplemental data added by\nD3](../images/00147.jpeg)\n\nFigure 11-8. The first node in dataset, with lots of supplemental data added\nby D3\n\nThe final result, then, is the lovely entanglement displayed in [Figure\n11-9](part0015_split_003.html#force_layout).\n\n![A simple force layout with 10 nodes and 12 edges](../images/00148.jpeg)\n\nFigure 11-9. A simple force layout with 10 nodes and 12 edges\n\nAgain, you can run the final code youself in _04_force.html_.\n\nNote that each time you reload the page, the circles and lines spring to life,\neventually resting in a state of equilibrium. But that final state of rest is\ndifferent every time because there is an element of randomness to how the\ncircles enter the stage. This illustrates the unpredictable nature of force-\nbased layouts: they might be quite different each time you use them, and they\nrely on the data to provide structure. If your data is more structured, you\nmight get a better visual result.\n\nInteractivity can be useful for improving our view of the data. I don’t like\nhow the edges overlap here, so I’ll drag the pink circle out and around (see\n[Figure 11-10](part0015_split_003.html#force_drag)), then I’ll move the red\none up and to the left (see [Figure\n11-11](part0015_split_003.html#force_drag_2)).\n\n![Dragging a node to change the arrangement of nodes](../images/00149.jpeg)\n\nFigure 11-10. Dragging a node to change the arrangement of nodes\n\n![Dragging some more to untangle nodes](../images/00150.jpeg)\n\nFigure 11-11. Dragging some more to untangle nodes\n\nAs a bonus, interactivity + physics simulation = irresistable demo. I can’t\nexplain it, but it’s true. For some reason, we humans just love seeing real-\nworld things replicated on screens.\n\n\n## Chapter 12. Geomapping\n\nBar charts, scatterplots, ring charts, and even force-directed graphs… _Yeah,\nthat’s all okay_ , you’re thinking, _but get to the maps already!_\n\n\n## JSON, Meet GeoJSON\n\nYou’ve already met JSON. Now meet GeoJSON, the JSON-based standard for\nencoding geodata for web applications. GeoJSON actually is not a totally\ndifferent format, but just a very specific use of JSON.\n\nBefore you can generate a geographic map, you need to acquire the path data\n(the outlines) for the shapes you want to display. We’ll start with a common\nexample, mapping US state boundaries. I’ve included a file _us-states.json_\nwith the sample code. This file is taken directly from one of the D3 examples,\nand we owe Mike Bostock a word of thanks for generating this nice, clean file\nof state boundaries.\n\nOpening up _us-states.json_ , you’ll see it looks something like this\n(reformatted and greatly abbreviated here):\n\n    \n    \n    {\n      \"type\": \"FeatureCollection\",\n      \"features\": [\n         {\n           \"type\": \"Feature\",\n           \"id\": \"01\",\n           \"properties\": { \"name\": \"Alabama\" },\n           \"geometry\": {\n             \"type\": \"Polygon\",\n             \"coordinates\": [[[-87.359296,35.00118],\n               [-85.606675,34.984749],[-85.431413,34.124869],\n               [-85.184951,32.859696],[-85.069935,32.580372],\n               [-84.960397,32.421541],[-85.004212,32.322956],\n               [-84.889196,32.262709],[-85.058981,32.13674] …\n              ]]\n          }\n        },\n        {\n             \"type\": \"Feature\",\n             \"id\": \"02\",\n             \"properties\": { \"name\": \"Alaska\" },\n             \"geometry\": {\n               \"type\": \"MultiPolygon\",\n               \"coordinates\": [[[[-131.602021,55.117982],\n                 [-131.569159,55.28229],[-131.355558,55.183705],\n                 [-131.38842,55.01392],[-131.645836,55.035827],\n                 [-131.602021,55.117982]]],[[[-131.832052,55.42469],\n                 [-131.645836,55.304197],[-131.749898,55.128935],\n                 [-131.832052,55.189182], …\n                ]]]\n              }\n          }\n    …\n\nIn typical GeoJSON style, we see, first of all, that this is all one giant\nobject. (Curly brackets, remember?) That object has a `type` of\n`FeatureCollection`, followed by `features`, which is an array of individual\n`Feature` objects. Each one of these `Feature`s represents a US state. You can\nsee each state’s name under `properties`.\n\nBut the real meat in any GeoJSON file is under `geometry`. This is where the\nfeature’s `type` is specified, followed by the many `coordinates` that\nconstitute the feature’s boundary. Within the `coordinates` are sets of\nlongitude/latitude pairs, each one as a small, two-value array. This is the\ninformation that cartographers dedicate their lives to compiling and refining.\nWe owe generations of explorers and researchers our gratitude for creating\nthese sequences of tiny, yet extremely powerful numbers.\n\nIt’s important to note that _longitude_ is always listed first. So despite the\ncultural bias toward lat/lon, GeoJSON is a lon/lat world.\n\nAlso, in case your cartographic skills are a bit rusty, here’s how you can\nalways remember which is which:\n\n  * Longtiude is long. Therefore, longitudinal lines run vertically, as though hanging down from above. \n  * Latitude is fatitude. Therefore, latitudinal lines run horizontally, as though wrapping around the Earth’s waist. \n\nLongitude and latitude together constitute an enormous grid that encircles the\nwhole globe. Conveniently for us, lon/lat can be easily converted to x/y\nvalues for screen display. In bar charts, we map data values to display values\n— numbers to rectangle heights. In geomapping, we also map data values to\ndisplay values — lon/lat becomes x/y. Thinking in terms of x/y also makes it\neasier to get used to the uncomfortable order of longitude first, latitude\nsecond.\n\n* * *\n\n### Tip\n\n[Get Lat+Lon](http://teczno.com/squares) is a great resource by Michal\nMigurski for double-checking coordinate values. Keep it open in a browser tab\nwhenever you’re working on geomaps. You will reference it often.\n\n* * *\n\n\n## Paths\n\nWe’ve got our geodata. Now get ready to rock.\n\nFirst, we define our first _path generator_ :\n\n    \n    \n    var path = d3.geo.path();\n\n`d3.geo.path()` is a total lifesaver of a function. It does all the dirty work\nof translating that mess of GeoJSON coordinates into even messier messes of\nSVG `path` codes. All hail `d3.geo.path()`!\n\nNow we _could_ paste all that GeoJSON directly into our HTML file, but ugh, so\nmany coordinates and curly brackets — what a mess! It’s cleaner and more\ncommon to keep the geodata in a separate file and load it in using\n`d3.json()`:\n\n    \n    \n    d3.json(\"us-states.json\", function(json) {\n    \n            svg.selectAll(\"path\")\n               .data(json.features)\n               .enter()\n               .append(\"path\")\n               .attr(\"d\", path);\n    \n    });\n\n`d3.json()` takes two arguments. First, it takes a string pointing to the path\nof the file to load in. Second, it takes a callback function that is fired\nwhen the JSON file has been loaded and parsed. (See [Handling Data Loading\nErrors](part0009_split_002.html#handling_data_loading_errors_5) for details on\nthe callback function.) `d3.json()`, just like `d3.csv()`, is _asynchronous_ ,\nmeaning it won’t prevent the rest of your code from running while the browser\nwaits for that external file to load. For example, code placed _after_ the\ncallback function might be executed _before_ the contents of the callback\nitself:\n\n    \n    \n    d3.json(\"someFile.json\", function(json) {\n            //Put things here that depend on the JSON loading\n    });\n    \n    //Only put things here that can operate independently of the JSON\n    console.log(\"I like cats.\");\n\nSo as a rule, when loading external datafiles, put the code that depends on\nthat data within the callback function. (Or put the code into other custom\nfunctions, and then call those functions from within the callback.)\n\nBack to the example. Finally, we bind the GeoJSON features to new `path`\nelements, creating one new `path` for each feature:\n\n    \n    \n            svg.selectAll(\"path\")\n               .data(json.features)\n               .enter()\n               .append(\"path\")\n               .attr(\"d\", path);\n\nNotice that last line, in which `d` (the path data attribute) is referred to\nour path generator, which magically takes the bound geodata and calculates all\nthat crazy SVG code. The result is [Figure\n12-1](part0016_split_002.html#geojson_simple).\n\n![Our first view of GeoJSON data](../images/00151.gif)\n\nFigure 12-1. Our first view of GeoJSON data\n\nA map! That was so easy! Check it out in _01_paths.html_. The rest is just\ncustomization.\n\n* * *\n\n### Tip\n\nYou can find lots more detail on paths and path generator options [on the\nwiki](https://github.com/mbostock/d3/wiki/Geo-Paths).\n\n* * *\n\n\n## Projections\n\nAs an astute observer, you noticed that our map isn’t quite showing us the\nentire United States. To correct this, we need to modify the _projection_\nbeing used.\n\nWhat is a projection? Well, as an astute observer, you have also noticed that\nthe globe is round, not flat. Round things are three-dimensional, and don’t\ntake well to being represented on two-dimensional surfaces. A _projection_ is\nan algorithm of compromise; it is the method by which 3D space is “projected”\nonto a 2D plane.\n\nWe define D3 projections using a familiar structure:\n\n    \n    \n    var projection = d3.geo.albersUsa()\n                           .translate([w/2, h/2]);\n\nD3 has several built-in projections. Albers USA is a composite projection that\nnicely tucks Alaska and Hawaii beneath the Southwest. (You’ll see in a\nsecond.) `albersUsa` is actually the default projection for `d3.path.geo()`,\nbut now that we’ve specified it explicitly, we can set several custom options,\nsuch as a translation value. You can see we’re translating the projection to\nthe center of the image (half of its width and half of its height).\n\nThe only other change we have to make is to tell the path generator explicitly\nthat it should reference our customized projection when generating all those\npaths:\n\n    \n    \n    var path = d3.geo.path()\n                     .projection(projection);\n\nThat gives us [Figure 12-2](part0016_split_003.html#geojson_centered). Getting\nthere! See _02_projection.html_ for the working code.\n\n![The same GeoJSON data, but now with a centered\nprojection](../images/00152.gif)\n\nFigure 12-2. The same GeoJSON data, but now with a centered projection\n\nWe can also add a `scale()` method to our projection in order to shrink things\ndown a bit and achieve the result shown in [Figure\n12-3](part0016_split_003.html#geojson_scaled):\n\n    \n    \n    var projection = d3.geo.albersUsa()\n                           .translate([w/2, h/2])\n                           .scale([500]);\n\nThe default scale value is 1,000. Anything smaller will shrink the map;\nanything larger will expand it.\n\n![The USA, scaled and centered within the image](../images/00153.gif)\n\nFigure 12-3. The USA, scaled and centered within the image\n\nCool! See that working code in _03_scaled.html_.\n\nBy adding a single `style()` statement, we could set the path’s fills to\nsomething less severe, like the blue shown in [Figure\n12-4](part0016_split_003.html#geojson_filled).\n\n![Now more blue-ish than black](../images/00154.jpeg)\n\nFigure 12-4. Now more blue-ish than black\n\nSee _04_fill.html_ for that. You could use the same technique to set stroke\ncolor and width, too.\n\nMap projections are extremely powerful algorithms, and different projections\nare useful for different purposes and different parts of the world (near the\npoles, versus the equator, for example).\n\nThanks primarily to the contributions of [Jason\nDavies](http://www.jasondavies.com), D3’s geo projections plug-ins now support\nessentially every obscure projection you could imagine. Reference [the\ncomplete visual reference of D3 projections on the\nwiki](https://github.com/mbostock/d3/wiki/Geo-Projections). You might also\nfind the [projection comparison demo](http://bl.ocks.org/3711652) useful.\n\n\n## Choropleth\n\nChoro-_what?_ This word, which can be difficult to pronounce, refers to a\ngeomap with areas filled in with different values (light or dark) or colors to\nreflect associated data values. In the United States, so-called “red state,\nblue state” choropleth maps showing the Republican and Democratic leanings of\neach state are ubiquitous, especially around election time. But choropleths\ncan be generated from any values, not just political ones.\n\nThese maps are also some of the most requested uses of D3. Although\nchoropleths can be fantastically useful, keep in mind that they have some\ninherent perceptual limitations. Because they use _area_ to encode values,\nlarge areas with low density (such as the state of Nevada) might be\noverrepresented visually. A standard choropleth does not represent per-capita\nvalues fairly — Nevada is too big, and Delaware far too small. But they _do_\nretain the geography of a place, and — as maps — they look really, really\ncool. So let’s dive in. (You can follow along with _05_choropleth.html_.)\n\nFirst, I’ll set up a scale that can take data values as input, and will return\ncolors. This is the heart of choropleth-style mapping:\n\n    \n    \n    var color = d3.scale.quantize()\n                        .range([\"rgb(237,248,233)\", \"rgb(186,228,179)\",\n                         \"rgb(116,196,118)\", \"rgb(49,163,84)\",\"rgb(0,109,44)\"]);\n\nA _quantize_ scale functions as a linear scale, but it outputs values from\nwithin a discrete range. These output values could be numbers, colors (as\nwe’ve done here), or anything else you like. This is useful for sorting values\ninto “buckets.” In this case, we’re using five buckets, but there could be as\nmany as you like.\n\nNotice I’ve specified an output range, but not an input domain. (I’m waiting\nuntil our data is loaded in to do that.) These particular colors are taken\nfrom the `colorbrewer.js` file included in [the D3 GitHub\nrepository](https://github.com/mbostock/d3/tree/master/lib/colorbrewer) — a\ncollection of perceptually optimized colors, selected by Cynthia Brewer, and\nbased on her research.\n\nNext, we need to load in some data. I’ve provided a file _us-ag-\nproductivity-2004.csv_ , which looks like this:\n\n    \n    \n    state,value\n    Alabama,1.1791\n    Arkansas,1.3705\n    Arizona,1.3847\n    California,1.7979\n    Colorado,1.0325\n    Connecticut,1.3209\n    Delaware,1.4345\n    …\n\nThis data, provided by the US Department of Agriculture, reports agricultural\nproductivity by state during the year 2004. The units are relative to an\narbitrary baseline of the productivity of the state of Alabama in 1996 (1.0),\nso greater values are more productive, and smaller values less so. (Find lots\nof open government datasets at <http://data.gov>.) I expect this data will\ngive us a nice map of states’ agricultural productivity.\n\nTo load in the data, we use `d3.csv()`:\n\n    \n    \n    d3.csv(\"us-ag-productivity-2004.csv\", function(data) { …\n\nThen, in the callback function, I want to set the `color` quantize scale’s\ninput domain (before I forget!):\n\n    \n    \n            color.domain([\n                    d3.min(data, function(d) { return d.value; }),\n                    d3.max(data, function(d) { return d.value; })\n            ]);\n\nThis uses `d3.min()` and `d3.max()` to calculate and return the smallest and\nlargest data values, so the scale’s domain is dynamically calculated.\n\nNext, we load in the JSON geodata, as before. But what’s new here is I want to\n_merge_ the agricultural data _into_ the GeoJSON. Why? Because we can only\nbind one set of data to elements at a time. We definitely need the GeoJSON,\nfrom which the `path`s are generated, but we also need the new agricultural\ndata. So if we can smush them into a single, monster array, then we can bind\nthem to the new `path` elements all at the same time. (There are several\napproaches to this step; what follows is my preferred method.)\n\n    \n    \n        d3.json(\"us-states.json\", function(json) {\n    \n            //Merge the ag. data and GeoJSON\n            //Loop through once for each ag. data value\n            for (var i = 0; i < data.length; i++) {\n    \n                //Grab state name\n                var dataState = data[i].state;\n    \n                //Grab data value, and convert from string to float\n                var dataValue = parseFloat(data[i].value);\n    \n                //Find the corresponding state inside the GeoJSON\n                for (var j = 0; j < json.features.length; j++) {\n    \n                var jsonState = json.features[j].properties.name;\n    \n                if (dataState == jsonState) {\n    \n                    //Copy the data value into the JSON\n                    json.features[j].properties.value = dataValue;\n    \n                    //Stop looking through the JSON\n                    break;\n    \n            }\n        }\n    }\n\nRead through that closely. Basically, for each state, we are finding the\nGeoJSON element with the same name (e.g., “Colorado”). Then we take the\nstate’s data value and tuck it in under `json.features[j].properties.value`,\nensuring it will be bound to the element and available later, when we need it.\n\nLastly, we create the `path`s just as before, only we make our `style()` value\ndynamic:\n\n    \n    \n                    svg.selectAll(\"path\")\n                       .data(json.features)\n                       .enter()\n                       .append(\"path\")\n                       .attr(\"d\", path)\n                       .style(\"fill\", function(d) {\n                                    //Get data value\n                                    var value = d.properties.value;\n    \n                                    if (value) {\n                                            //If value exists…\n                                            return color(value);\n                                    } else {\n                                            //If value is undefined…\n                                            return \"#ccc\";\n                                    }\n                       });\n\nInstead of `\"steelblue\"` for everyone, now each state `path` gets a different\nfill value. The trick is that we don’t have data for _every_ state. The\ndataset we’re using doesn’t have information for Alaska, the District of\nColumbia, Hawaii, or Puerto Rico (which, although not a state, is still\nincluded in the GeoJSON and appears in the projection).\n\nSo to accommodate those exceptions, we include a little logic: an `if()`\nstatement that checks to see whether or not the data value has been defined.\nIf it exists, then we return `color(value)`, meaning we pass the data value to\nour quantize scale, which returns a color. For undefined values, we set a\ndefault of light gray (`#ccc`).\n\nBeautiful! Just look at the result in [Figure\n12-5](part0016_split_004.html#choropleth_map). Check out the final code and\ntry it yourself in _05_choropleth.html_.\n\n![A choropleth map showing agricultural productivity by\nstate](../images/00155.jpeg)\n\nFigure 12-5. A choropleth map showing agricultural productivity by state\n\n\n## Adding Points\n\nWouldn’t it be nice to put some cities on this map, for context? Maybe it\nwould be interesting or useful to see how many large, urban areas there are in\nthe most (or least) agriculturally productive states. Again, let’s start by\nfinding the data.\n\nFortunately, the US Census has us covered, once again. (Your tax dollars at\nwork!) Here’s the start of a raw CSV dataset from the Census that shows\n[“Annual Estimates of the Resident Population for Incorporated Places Over\n50,000”](http://1.usa.gov/XWUSrY).\n\n    \n    \n    table with row headers in column A and column headers in rows 3 through 4,,,,,,,\n    ,,,\n    \"Table 1. Annual Estimates of the Resident Population for Incorporated Places\n    Over 50,000, Ranked by July 1, 2011 Population: April 1, 2010 to July 1, 2011\"\n    ,,,,,,,,,,\n    Rank,Geographic Area,,\"April 1, 2010\",,Population Estimate (as of July 1),,\n    ,,,,Place,State,Census,Estimates Base,2010,2011,,,,\n    1,New York city,New York,\"8,175,133\",\"8,175,133\",\"8,186,443\",\"8,244,910\",,,,\n    2,Los Angeles city,California,\"3,792,621\",\"3,792,625\",\"3,795,761\",\"3,819,702\"\n    ,,,,\n    3,Chicago city,Illinois,\"2,695,598\",\"2,695,598\",\"2,698,283\",\"2,707,120\",,,,\n    4,Houston city,Texas,\"2,099,451\",\"2,099,430\",\"2,108,278\",\"2,145,146\",,,,\n    5,Philadelphia city,Pennsylvania,\"1,526,006\",\"1,526,006\",\"1,528,074\",\"1,536,471\"\n    ,,,,\n    6,Phoenix city,Arizona,\"1,445,632\",\"1,445,656\",\"1,448,531\",\"1,469,471\",,,,\n    7,San Antonio city,Texas,\"1,327,407\",\"1,327,606\",\"1,334,431\",\"1,359,758\",,,,\n    8,San Diego city,California,\"1,307,402\",\"1,307,406\",\"1,311,516\",\"1,326,179\",,,,\n    9,Dallas city,Texas,\"1,197,816\",\"1,197,816\",\"1,201,715\",\"1,223,229\",,,,\n    10,San Jose city,California,\"945,942\",\"952,612\",\"955,091\",\"967,487\",,,,\n    …\n\nThis is quite messy, and I don’t even need all this data. So I’ll open the CSV\nup in my favorite spreadsheet program and clean it up a bit, removing unneeded\ncolumns. (You could use LibreOffice Calc, Apple Numbers, or Microsoft Excel.)\nI’m also interested in only the largest 50 cities, so I’ll delete all the\nothers. Exporting back to CSV, I now have this:\n\n    \n    \n    rank,place,population\n    1,New York city,8175133\n    2,Los Angeles city,3792621\n    3,Chicago city,2695598\n    4,Houston city,2099451\n    5,Philadelphia city,1526006\n    6,Phoenix city,1445632\n    7,San Antonio city,1327407\n    8,San Diego city,1307402\n    9,Dallas city,1197816\n    10,San Jose city,945942\n    …\n\nThis information is useful, but to place it on the map, I’m going to need the\nlatitude and longitude coordinates for each of these places. Looking this up\nmanually would take _forever_. Fortunately, we can use a _geocoding_ service\nto speed things up. Geocoding is the process of taking place names, looking\nthem up on a map (or in a database, really), and returning precise lat/lon\ncoordinates. “Precise” might be a bit of an overstatement — the geocoder does\nthe best job it can, but it will sometimes be forced to make assumptions given\nvague data. For example, if you specify “Paris,” it will probably assume you\nmean Paris, France and not Paris, Texas. It’s good practice to eyeball the\ngeocoder’s output once you get it on the map, and manually adjust any\nerroneous coordinates (using\n[teczno.com/squares](http://www.teczno.com/squares) as a reference).\n\nI’ll head over to [my favorite batch\ngeocoder](http://www.gpsvisualizer.com/geocoder/), paste in just the place\nnames, and click Start! A few minutes later, the geocoder spits out some more\ncomma-separated values, which includes lat/lon pairs. I bring those back into\nmy spreadsheet, and save out a new, unified CSV with coordinates:\n\n    \n    \n    rank,place,population,lat,lon\n    1,New York city,8175133,40.71455,-74.007124\n    2,Los Angeles city,3792621,34.05349,-118.245323\n    3,Chicago city,2695598,45.37399,-92.888759\n    4,Houston city,2099451,41.337462,-75.733627\n    5,Philadelphia city,1526006,37.15477,-94.486114\n    6,Phoenix city,1445632,32.46764,-85.000823\n    7,San Antonio city,1327407,37.706576,-122.440612\n    8,San Diego city,1307402,37.707815,-122.466624\n    9,Dallas city,1197816,40.636,-91.168309\n    10,San Jose city,945942,41.209716,-112.003047\n    …\n\nThat was unbelievably easy. Ten years ago that step would have taken us hours\nof research and tedious data entry, not seconds of mindless copying-and-\npasting. Now you see why we’re experiencing an explosion of online mapping.\n\nOur data is ready, and we already know how to load it in:\n\n    \n    \n    d3.csv(\"us-cities.csv\", function(data) {\n            //Do something…\n    });\n\nIn the callback function, we can specify how to create a new `circle` element\nfor each city, and then _position each circle_ according to the corresponding\ncity’s geo-coordinates:\n\n    \n    \n            svg.selectAll(\"circle\")\n               .data(data)\n               .enter()\n               .append(\"circle\")\n               .attr(\"cx\", function(d) {\n                       return projection([d.lon, d.lat])[0];\n               })\n               .attr(\"cy\", function(d) {\n                       return projection([d.lon, d.lat])[1];\n               })\n               .attr(\"r\", 5)\n               .style(\"fill\", \"yellow\")\n               .style(\"opacity\", 0.75);\n\nThe magic here is in those `attr()` statements that set the `cx` and `cy`\nvalues. You see, we can access the raw latitude and longitude values as\n`d.lat` and `d.lon`. But what we really need for positioning these circles are\nx/y _screen coordinates_ , not _geo_ -coordinates.\n\nSo we bring back our magical friend `projection()`, which is basically just a\ntwo-dimensional scale method. With D3 scales, we put in one number, and get\nback another. With projections, we put in two numbers, and get back two. (The\nother main difference is that the behind-the-scenes math for projections is\nmuch more complex than the simple normalization of scales.)\n\nThe map projection takes a two-value array as input, with _longitude_ first\n(remember, it’s lon/lat, not lat/lon, in GeoJSON-ville). Then the projection\nreturns a two-value array with x/y screen values. So, for `cx`, we use `[0]`\nto grab the _first_ of those values, which is _x_. For `cy`, we use `[1]` to\ngrab the _second_ of those values, which is _y_. Make sense?\n\nThe resulting map in [Figure\n12-6](part0016_split_005.html#choropleth_with_cities) is suh-weeeet! Check out\nthe code in _06_points.html_.\n\n![The top 50 largest US cities, represented as cute little yellow\ndots](../images/00156.jpeg)\n\nFigure 12-6. The top 50 largest US cities, represented as cute little yellow\ndots\n\nYet these dots are all the same size. Let’s link the population data to circle\nsize. Instead of a static area, we’ll reference the `population` value:\n\n    \n    \n               .attr(\"r\", function(d) {\n                     return Math.sqrt(parseInt(d.population) * 0.00004);\n               })\n\nHere we grab `d.population`, wrap it in `parseInt()` to convert it from a\nstring to an integer, scale that value down by an arbitrary amount, and\nfinally take the square root (to convert from an area value to a radius\nvalue). See the code in _07_points_sized.html_.\n\nAs you can see in [Figure\n12-7](part0016_split_005.html#choropleth_with_cities_sized), now the largest\ncities really stand out. The differences in city size are significant; this\nrepresentation might be better suited to a log scale, especially if even\nsmaller cities are included. Instead of multiplying by 0.00004, you could more\nproperly use a custom D3 scale function. (I’ll leave that to you.)\n\n![Cities as dots, with area set by population](../images/00157.jpeg)\n\nFigure 12-7. Cities as dots, with area set by population\n\nThe point here is to see that we’ve successfully loaded and visualized two\ndifferent datasets on a map. (Make that three, counting the geocoded\ncoordinates we merged in!)\n\n\n## Acquiring and Parsing Geodata\n\nIf we only ever wanted to make maps of the United States, then we would\nalready have all the GeoJSON we’d ever need. But the world is much bigger than\nthat, and there are lots of other areas to map. So allow me to digress for a\nmoment and address how to acquire and parse geodata for the area of your\nchoosing. The end goal is to produce a GeoJSON file, like _us-states.json_ ,\nthat can be used with D3.\n\n### Find Shapefiles\n\nSo-called _shapefiles_ predate the current explosion of online mapping and\nvisualization. These are documents that essentially contain the same kind of\ninformation you could store in GeoJSON — boundaries of geographic areas, and\npoints within those areas — but their contents are not plain text and,\ntherefore, are very hard to read. The shapefile format grew out of the\ncommunity of geographers, cartographers, and scientists using Geographic\nInformation Systems (GIS) software. If you have easy access to expensive GIS\nsoftware, then shapefiles are your best friend. But that’s a small group of\npeople, and web browsers can’t make heads or tails of shapefiles, in any case.\n\nIf you can’t find nice GeoJSON describing your area of interest, then hunt\ndown a shapefile. Government websites are good sources, especially if you’re\nlooking for data on a specific country or region. My favorite two sources are:\n\n[Natural Earth](http://www.naturalearthdata.com)\n\n> A massive collection of geographic data for both cultural/political and\n> natural features made available in the public domain. Mapping countries is\n> highly political, and Natural Earth posts detailed notes explaining their\n> design decisions.\n\n[The United States Census](http://www.census.gov/geo/www/cob/cbf_state.html)\n\n> Boundary data for every US state, plus counties, roadways, water features,\n> and so much more, also in the public domain.\n\n### Choose a Resolution\n\nBefore you download, check the _resolution_ of the data. All shapefiles are\nvector data (not bitmap), so by resolution I don’t mean pixels — I mean the\nlevel of _cartographic detail_ or granularity.\n\nNatural Earth’s datasets come in three different resolutions, listed here from\nmost detailed to least:\n\n  * 1:10,000,000 \n  * 1:50,000,000 \n  * 1:110,000,000 \n\nThat is, in the highest resolution data, one unit of measurement in the file\ncorresponds to 10 million such units in the actual, physical world. Or, to\nflip that around, every 10 million units in real life is simplified into one.\nSo 10 million inches (158 miles) would translate to a single inch in data\nterms.\n\nThese resolution ratios can be written more simply as:\n\n  * 1:10m \n  * 1:50m \n  * 1:110m \n\nFor a low-detail (“zoomed out”) map of the world, the 1:110m resolution could\nwork fine. But to show detailed outlines of a specific state, 1:10m will be\nbetter. If you’re mapping a very small (“zoomed in”) area, such as a specific\ncity or even neighborhood, then you’ll need much higher resolution data. (Try\nlocal state or city government websites for that information.)\n\nDifferent sources will offer different resolutions. Many of the US Census\nshapefiles are available in these three scales:\n\n  * 1:500,000 (1:500k) \n  * 1:5,000,000 (1:5m) \n  * 1:20,000,000 (1:20m) \n\nChoose a resolution, and download the file. Typically you’ll get a compressed\nZIP file that contains several other files. As an example, I’m going to\ndownload Natural Earth’s 1:110m (low detail) ocean file from here:\n<http://www.naturalearthdata.com/downloads/110m-physical-vectors/110m-ocean/>.\n\nUncompressed, it contains these files:\n\n    \n    \n    ne_110m_ocean.dbf\n    ne_110m_ocean.prj\n    ne_110m_ocean.README.html\n    ne_110m_ocean.shp\n    ne_110m_ocean.shx\n    ne_110m_ocean.VERSION.txt\n\nWow, those are some funky extensions. We’re primarily interested in the file\nending with _.shp_ , but don’t delete the rest just yet.\n\n### Simplify the Shapes\n\nIdeally, you can find shapefiles in exactly the resolution you need. But what\nif you can only find a super-high-resolution file, say at 1:100k? The size of\nthe file might be huge. And now that you’re a JavaScript programmer, you’re\nreally concerned about efficiency, remember? So no sending multimegabyte\ngeodata to the browser.\n\nFortunately, you can _simplify_ those shapefiles, in effect converting them\ninto lower-detail versions of themselves. The process of simplification is\nillustrated beautifully in [this interactive piece by Mike\nBostock](http://bost.ocks.org/mike/simplify/).\n\n[MapShaper](http://mapshaper.org), by Matt Bloch, is an excellent, easy-to-use\ninteractive tool for this purpose. It lets you upload your own shapefiles, and\nthen drag sliders around to preview different levels of simplification.\nTypically, the trade-off is between good detail and small files.\n\nIf you use MapShaper, choose the “Shapefile – polygons” option when exporting.\nThis will generate both a _.shp_ and a _.shx_ file for you. Download both\nfiles, and rename them so the filenames match the names of the original _.shp_\nand _.shx_ files. Then, before converting to GeoJSON, make a copy of the\noriginal _.dbf_ file, and put it in the same folder as the simplified\nshapefiles. This important step will ensure you don’t lose any of the\nimportant metadata that’s stored in the _.dbf_ , like country IDs and other\npath identifiers.\n\nOther options include Mike Migurski’s\n[Bloch](https://github.com/migurski/Bloch) with a Python implementation of\nMatt Bloch’s simplification algorithms, and a `d3.simplify` plug-in (used for\nMike’s demo mentioned earlier). The dream is one day we could use JavaScript\nto perform line simplification directly, and then export that simplified JSON\nto use in projects. The tools are evolving quickly, so watch this space!\n(Literally while I was writing this paragraph, Mr. Bostock posted [a\ndemo](http://bl.ocks.org/4090870) for a new project for geometry\nsimplification, [TopoJSON](https://github.com/mbostock/topojson). That’s how\nfast things are changing! By the time you read this, the TopoJSON command-line\ntool may be your best bet, as it can load shapefiles, perform simplification,\n_and_ convert your data to JSON. As you’d expect, TopoJSON is designed to play\nwell with D3, although it outputs a new TopoJSON format, which is similar to,\nbut more efficient than GeoJSON.)\n\n### Convert to GeoJSON\n\nIf you don’t already have the right software installed, this can be the\nhairiest part of the process. Our end goal is to get a terminal command called\n`ogr2ogr` running on your Mac, Unix, or Windows system. The problem is that\n`ogr2ogr` depends on several other frameworks, libraries, and so on, so for it\nto work, they all have to be in place.\n\nI won’t cover the intricacies of the installation here, but I’ll point you in\nthe right direction.\n\nFirst, you need [the Geospatial Data Abstraction\nLibrary](http://www.gdal.org), or GDAL. The `ogr2ogr` utility is part of this\npackage.\n\nYou also need [GEOS](http://trac.osgeo.org/geos/), which cleverly stands for\nGeometry Engine, Open Source.\n\nIf you have a Windows or Unix/Linux machine, you can now have fun downloading\nthe source and installing it by typing funny commands like **`build`** ,\n**`make`** , and **`seriously why isn’t this working omg please please please\ninstall this time or i will freak out`**.\n\nI don’t remember the exact command names, but they are something like that.\n(On a serious note, if you get stuck on this step, be aware that there are\nliterally entire other O’Reilly books on how to download and install software\npackages like this.)\n\nIf you’re on a Mac, and you happen to have both Xcode _and_ Homebrew\ninstalled, then simply type **`brew install gdal`** into the terminal, and\nyou’re done! (If you don’t have either of these amazing tools, they might be\nworth getting. Both tools are free, but could take some time and effort on\nyour part to install. Xcode is a massive [download from the App\nStore](http://bit.ly/XUTt81). Once you have Xcode, Homebrew can, in theory, be\ninstalled with [a simple terminal command](http://mxcl.github.com/homebrew/).\nIn my experience, some troubleshooting was required to get it working.)\n\nTo Mac users without Xcode or Homebrew: you are very lucky that some kind soul\nhas precompiled a friendly GUI installer, which installs GDAL, GEOS, and\nseveral other tools whose names you don’t really need to know. Look for the\nnewest version of the [“GDAL Complete”\npackage](http://www.kyngchaos.com/software/frameworks). Review the GDAL ReadMe\nfile closely. After installation, you won’t automatically be able to type\n**`ogr2ogr`** in a terminal window. You’ll need to add the GDAL programs to\nyour shell path. The easiest way to do that is: Open a new terminal window.\nType **`nano .bash_profile`**. Paste in `export\nPATH=/Library/Frameworks/GDAL.framework/Programs:$PATH` and then Control-X and\nControl-y to save. Type **`exit`** to end the session, then open a new\nterminal window and type **`ogr2ogr`** to see if it worked.\n\nNo matter what system you’re on, once all the tools are installed, open up a\nnew terminal window and navigate to whatever directory contains all the\nshapefiles (for example, **`cd ~/ocean_shapes/`**.) Then use the form:\n\n    \n    \n    ogr2ogr -f \"GeoJSON\" output.json filename.shp\n\nThis tells `ogr2ogr` to take `filename`, which should be a _.shp_ file,\nconvert it to GeoJSON, and finally save it as a file called _output.json_.\n\nFor my sample ocean data file, using `ogr2ogr` looks like the following:\n\n    \n    \n    ogr2ogr -f \"GeoJSON\" output.json ne_110m_ocean.shp\n\nType that in, and hopefully you see nothing at all.\n\nSo anticlimactic! I know, after the hours you spent hacking the command line\nto get ol’ `ogr` installed, you were expecting some gradiose finale, as though\nyou saved the princess in Super Mario 3, yet again. (I actually have never\ndone that, but I imagine it is pretty amazing.)\n\nBut no, hopefully nothing happened at all. Except there should be a new file\nin the same directory called _output.json_.\n\nHere’s the start of mine:\n\n    \n    \n    {\n    \"type\": \"FeatureCollection\",\n    \"features\": [ { \"type\": \"Feature\", \"properties\":\n    { \"scalerank\": 0, \"featurecla\": \"Ocean\" },\n    \"geometry\": { \"type\": \"Polygon\", \"coordinates\":\n        [ [ [ 49.110290527343778, 41.28228759765625 ],\n            [ 48.584472656250085, 41.80889892578125 ],\n        [ 47.492492675781335, 42.9866943359375 ],\n            [ 47.590881347656278, 43.660278320312528 ],\n        [ 46.682128906250028, 44.609313964843807 ],\n            [ 47.675903320312585, 45.641479492187557 ],\n        [ 48.645507812500085, 45.806274414062557 ]\n            …\n\nHey, finally, this is starting to look familiar!\n\nExcitedly, now we copy our new GeoJSON into our D3 directory. I rename mine\n_oceans.json_ , copy an earlier HTML document, and in the D3 code, simply\nchange the reference from `us-states.json` to `oceans.json`, and then get the\nresult shown in [Figure 12-8](part0016_split_006.html#oceans).\n\n![GeoJSON showing, um, the world’s oceans?](../images/00158.jpeg)\n\nFigure 12-8. GeoJSON showing, um, the world’s oceans?\n\nBlaaa! What is that?! Whatever it is, you can see it in _08_oceans.html_.\n\nIn my haste, I forgot to update the projection! Let’s make one tiny change,\nfrom `albersUsa` to `mercator` (see [Figure\n12-9](part0016_split_006.html#oceans2)).\n\n![GeoJSON of the world’s oceans, now properly projected](../images/00159.jpeg)\n\nFigure 12-9. GeoJSON of the world’s oceans, now properly projected\n\nSee the result in _09_mercator.html_ — oceanic GeoJSON paths, downloaded,\nparsed, and visualized.\n\n\n## Chapter 13. Exporting\n\nSometimes you need to take your visualization beyond the browser, such as when\nyou’re asked to present your work in a TED talk or in your first solo show at\nMoMA.\n\nHere are three easy ways to get D3 visualizations out of D3 and into formats\nsuitable for other, noninteractive media. D3 has no explicit “export” function\nbuilt in (although some people have built their own), so what follows are\nsimple techniques that will work for any SVG image in a web browser.\n\n\n## Bitmaps\n\nThe easiest and lowest-quality option is, obviously, to take a screenshot.\nDepending on your operating system, this can be done using the Print Screen\nbutton on a PC, or ⌘-Shift-4 on the Mac. (Drag those crosshairs over the area\nyou want to capture, release, and check your desktop for a PNG image.)\n\n[Figure 13-1](part0017_split_001.html#bitmap_export) is a bitmap screenshot I\nmade using the latter technique.\n\n![A PNG screenshot](../images/00160.jpeg)\n\nFigure 13-1. A PNG screenshot\n\nThis is easy and quick, but generates a bitmap image at screen resolution. So,\nas you can see, the image won’t scale up nicely, nor print with sharp edges.\nThis approach is probably suitable only for reuse on-screen. (The exception to\nthis is if you have a super high-res display, then the resolution will be much\nfiner.)\n\n\n## PDF\n\nPortable Document Format documents can contain vector-based artwork, such as\nSVG images, so exporting to PDF gives you a quick, scalable copy of your\nvisualization (see [Figure 13-2](part0017_split_002.html#pdf_export)).\n\n![A PDF maintains the original vector data for clarity](../images/00161.jpeg)\n\nFigure 13-2. A PDF maintains the original vector data for clarity\n\nOn the Mac, in your browser, go to File→Print. Then look for the PDF menu, and\nchoose Save as PDF.\n\nOn Windows or Linux, you might need to install a third-party utility to enable\nprint-to-PDF functionality. (I’ve heard doPDF for Windows works, and it’s\nfree.)\n\n\n## SVG\n\nFinally, it probably occurred to you that, because we are using D3 to generate\nimages in SVG format, why not just save out a copy of the SVG image? This has\nall the benefits of PDF: You maintain the original vector data, it’s scalable,\nand you can even bring the results into Illustrator or another SVG-compatible\neditor and tweak it after the fact. (This is true to a certain extent for PDF\nfiles as well, but depending on the PDF generator, sometimes elements get\ngrouped and layered in unexpected ways.)\n\nThe simplest way is to simply copy the SVG code straight out of the DOM (see\n[Figure 13-3](part0017_split_003.html#copy_the_svg)). First, inspect the SVG\nelement. Click the element in the web inspector, and then click Copy.\n\n![Copying the D3-generated SVG code from the DOM](../images/00162.jpeg)\n\nFigure 13-3. Copying the D3-generated SVG code from the DOM\n\nSwitch back to your text editor, and paste the contents into a new file, as\nshown in [Figure 13-4](part0017_split_003.html#paste_the_svg).\n\n![SVG code pasted into a new document](../images/00163.jpeg)\n\nFigure 13-4. SVG code pasted into a new document\n\nThen just save the file as _something.svg_. Now you can open it up in\nIllustrator, as shown in [Figure\n13-5](part0017_split_003.html#svg_in_illustrator), or any other SVG-compatible\nprogram.\n\n![Exported SVG opened in Illustrator](../images/00164.jpeg)\n\nFigure 13-5. Exported SVG opened in Illustrator\n\nAs you can see in [Figure 13-6](part0017_split_003.html#edit_the_svg), all of\nthe elements remain individually selectable and editable. In the version shown\nin [Figure 13-7](part0017_split_003.html#edited_svg_in_illustrator), I’ve made\nsome Tuftean enhancements to my design, adding variable-weight strokes and a\nneutral, lavender fill for a visually “calming” effect. (To be clear, this is\na joke, and neither Tufte nor I endorse this approach.)\n\n![SVG elements selected and highlighted](../images/00165.jpeg)\n\nFigure 13-6. SVG elements selected and highlighted\n\n![My groundbreaking image, made even more so with some manual touch-\nups](../images/00166.jpeg)\n\nFigure 13-7. My groundbreaking image, made even more so with some manual\ntouch-ups\n\nAs you can see, there are many options for getting your work out of the\nbrowser, documented, and saved for use in other contexts, whether for print or\nfor the screen.\n\n\n## Appendix A. Appendix: Further Study\n\nYou are a trouper for making it this far. We’ve covered a lot of ground, and\nby now you have a decent handle on D3’s basic concepts and common techniques.\nIf you’ve learned anything, I hope it’s that there are always several (or\ntens, or hundreds of) ways to accomplish the same task — that’s the joy of\nprogramming, right? I’ve presented the ways that, to me, are the simplest or\nmost intuitive, and the least difficult to understand. But there are probably\n_better_ ways to do anything that you learned in this book, whether “better”\nmeans “more computationally efficient” or “makes more sense to you and your\nway of working.” I’m a fan of the latter definition. Programming is like\nsolving a puzzle; it’s up to you to figure out how to tell the computer what\nto do what you want — using language that you, the human, can still\nunderstand.\n\nD3 is a powerful tool, and we’ve only scratched the surface. As you begin work\non your own visualization projects, you’ll discover many additional helpful\nmethods and sneaky shortcuts. There are lots of valuable bits that I didn’t\ncover here, such as D3’s built-in methods for working with date and time\nvalues, dynamically selecting and calculating colors, and painlessly\nmanipulating arrays, for all your client-side data processing needs — just to\nname a few. There is a _lot_ to this tool. I’ve tried to introduce you to the\ncore concepts, and now you’re ready to go dig into the pieces that really\ninterest you.\n\nSo, where to turn next? Here’s a collection of valuable resources to aid you\nin your quest. Keep in mind that the D3 software itself is still evolving, and\nso are these resources. By the time you read this, there might be some other\nhelpful website or set of tutorials not mentioned here. That is why I\nrecommend that you don’t just read, but _get involved_ with the D3 community.\nJoin [the Google Group](https://groups.google.com/forum/#!forum/d3-js), follow\npeople on Twitter, and keep your eyes open for the latest developments. Start\na discussion, and meet fellow data visualizers in your local area. If there\naren’t D3 datavis groups getting together in your area yet, then start one\nyourself. The more we can learn from each other, the better.\n\nAfter all, having worked through this book, you’re part of the community now\n(whether you like it or not). Welcome!\n\n\n## Books\n\n[ _Getting Starting with\nD3_](http://shop.oreilly.com/product/0636920025429.do) by Mike Dewar.\nO’Reilly, 2012.\n\nYes, there’s only one other book on D3 so far. Mike Dewar’s introduction\ntackles some more advanced topics, and includes sample projects with real-\nworld data from New York City’s transportation system. (Fun!)\n\n\n## Websites\n\n[d3js.org](http://d3js.org)\n\n> Your starting point for everything D3.\n\n[github.com/mbostock/d3/wiki/Gallery](https://github.com/mbostock/d3/wiki/Gallery)\n\n> The D3 gallery contains _hundreds_ of examples. Add your own work!\n\n[bl.ocks.org/mbostock](http://bl.ocks.org/mbostock)\n\n> Even more examples, in this case all by Mike Bostock, each one typically\n> highlighting just one of D3’s features.\n\n[github.com/mbostock/d3/wiki/API-\nReference](https://github.com/mbostock/d3/wiki/API-Reference)\n\n> The D3 API reference, an essential reference for every method and its\n> parameters.\n\n[stackoverflow.com/questions/tagged/d3.js](http://stackoverflow.com/questions/tagged/d3.js)\n\n> When you get stuck, post questions on StackOverflow with the `d3.js` tag.\n\n[groups.google.com/forum/?fromgroups#!forum/d3-js](https://groups.google.com/forum/?fromgroups#!forum/d3-js)\n\n> Everyone who’s anyone is on the D3 Google Group. Find out about the latest\n> projects and developments here. (Please save technical questions for\n> StackOverflow.)\n\n[bl.ocks.org](http://bl.ocks.org)\n\n> A service for posting code hosted on GitHub’s Gist, by Mike Bostock. Perfect\n> for quickly sharing your work with others, such as when seeking help on\n> StackOverflow or boasting about your latest triumph on the Google Group.\n\n[blog.visual.ly/creating-animations-and-transitions-\nwith-d3-js/](http://blog.visual.ly/creating-animations-and-transitions-\nwith-d3-js/)\n\n> An excellent tutorial on _Creating Animations and Transitions With D3_ with\n> lots of inline, interactive examples by Jérôme Cukier.\n\n[d3noob.org](http://www.d3noob.org)\n\n> A new, promising resource for D3 tips and tricks.\n\n[tributary.io](http://tributary.io)\n\n> A live-coding environment for experimenting with D3 code, by Ian Johnson.\n\n[D3 Plug-ins](https://github.com/d3/d3-plugins)\n\n> A listing of all the official plug-ins that extend D3’s functionality, in\n> case it doesn’t do enough for you already.\n\n\n## Twitterers\n\nTwitter is a great way to find out about the latest projects and D3\ndevelopments. At the risk of omitting many amazing people, here are some you\nshould follow:\n\n[@mbostock](https://twitter.com/mbostock)\n\n> Mike Bostock, for announcements on D3’s progress as well as new\n> visualizations for _The New York Times_.\n\n[@jasondavies](https://twitter.com/jasondavies)\n\n> Jason Davies, for all manner of geographic and mathematical mapping\n> experiments.\n\n[@d3visualization](https://twitter.com/d3visualization)\n\n> Christophe Viau, for frequent updates from all over the D3 universe.\n\n[@enjalot](https://twitter.com/enjalot)\n\n> Ian Johnson, for loads of new coding tools and techniques, plus video\n> tutorials.\n\n[@syntagmatic](https://twitter.com/syntagmatic)\n\n> Kai Chang, for too many D3 experiments to count.\n\n[@jcukier](https://twitter.com/jcukier)\n\n> Jérôme Cukier, for innovative visualization projects with insightful process\n> notes.\n\n[@darkgreener](https://twitter.com/darkgreener)\n\n> Anna Powell-Smith, for beautiful interactive visualizations that explore\n> personally relevant data.\n\n[@vlandham](https://twitter.com/vlandham)\n\n> Jim Vallandingham, for excellent process notes on projects as well as great\n> tutorials.\n\n[@alignedleft](https://twitter.com/alignedleft)\n\n> Scott Murray, for learning about errata, updates, and revisions to this\n> book, as well as future data-driven projects.\n\nI should acknowledge that, yes, there are mostly men listed here. As of this\nwriting, the community of D3 users and contributors tends to skew quite male.\nI hope that future editions of this book can confidently include a more\ndiverse listing.\n\n\n## Index\n\n* * *\n\n### A note on the digital index\n\nA link in an index entry is displayed as the section title in which that entry\nappears. Because some sections have multiple index markers, it is not unusual\nfor an entry to have several links to the same section. Clicking on any link\nwill take you directly to the place in the text in which the marker appears.\n\n* * *\n\n### Symbols\n\n3D drawing\n\n> alternative tools for, [Three-\n> Dimensional](part0006_split_004.html#I_indexterm2_id288213)\n>\n\n>> projections, [Projections](part0016_split_003.html#I_indexterm12_id317834)\n\n>\n\n>> “SVG (Scalable Vector Graphics)”\n\n> SVG transforms, [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305800)\n>\n\n>> ### A\n\naccessor functions, [d3.min() and\nd3.max()](part0011_split_005.html#I_indexterm7_id303853), [Updating all\nreferences](part0013_split_004.html#I_indexterm9_id311621)\n\n> Adobe Flash Player, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287441)\n\n> Alaska, map of,\n> [Projections](part0016_split_003.html#I_indexterm12_id317886)\n\n> Albers USA, [Projections](part0016_split_003.html#I_indexterm12_id317879)\n\n> alternative tools,\n> [Alternatives](part0006_split_004.html#ix_alttools)–[Tools Built with\n> D3](part0006_split_004.html#I_indexterm2_id288463)\n\n> ancestor elements, [DOM](part0007_split_003.html#I_indexterm3_id290181)\n\n> anonymous functions, [High-\n> Functioning](part0009_split_002.html#I_indexterm5_id298256), [Interaction\n> via Event Listeners](part0013_split_002.html#I_indexterm9_id307616)\n\n> Apache server software, [The\n> Web](part0007_split_001.html#I_indexterm3_id288660)\n\n> append() method, [Drawing\n> SVGs](part0010_split_003.html#I_indexterm6_id300207)\n\n> arbitrary order, overriding, [Ordinal Scales,\n> Explained](part0013_split_001.html#I_indexterm9_id306905)\n\n> arguments (input values),\n> [Functions](part0007_split_007.html#I_indexterm3_id293037), [Data Wants to\n> Be Held](part0009_split_002.html#I_indexterm5_id298503)\n\n> arrays, [Arrays](part0007_split_007.html#I_indexterm3_id291965), [What\n> arrays are made for()](part0007_split_007.html#I_indexterm3_id292927),\n> [Data](part0009_split_002.html#I_indexterm5_id297074)\n\n> arrays of objects, [Objects and\n> Arrays](part0007_split_007.html#I_indexterm3_id292294)\n\n> ascending order sort, [Click to\n> Sort](part0014_split_003.html#I_indexterm10_id314153)\n\n> assignment operators,\n> [Variables](part0007_split_007.html#I_indexterm3_id291845)\n\n> attr() method, [Beyond Text](part0009_split_002.html#I_indexterm5_id298648),\n> [Drawing SVGs](part0010_split_003.html#I_indexterm6_id300214)\n\n> attributes\n\n> assigning to HTML elements,\n> [Attributes](part0007_split_002.html#I_indexterm3_id289856)\n>\n\n>> in SVG elements, [Drawing\nSVGs](part0010_split_003.html#I_indexterm6_id300145)\n\n>\n\n>> setting, [Setting\nAttributes](part0010_split_001.html#I_indexterm6_id299071)\n\n>\n\n>> axes, [Axes](part0012_split_000.html#ix_axes)–[Formatting Tick\nLabels](part0012_split_007.html#I_indexterm8_id306577)\n\n> creating a generic axis, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305194)\n>\n\n>> dynamic quality of, [Final\nTouches](part0012_split_006.html#I_indexterm8_id306300)\n\n>\n\n>> graduated scales for (tick marks), [Check for\nTicks](part0012_split_004.html#I_indexterm8_id305997)\n\n>\n\n>> labelling, [Y Not?](part0012_split_005.html#I_indexterm8_id306113),\n[Formatting Tick Labels](part0012_split_007.html#I_indexterm8_id306441)\n\n>\n\n>> styling with CSS, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305556)\n\n>\n\n>> updating, [Updating Axes](part0013_split_003.html#I_indexterm9_id309231)\n\n>\n\n>> vs. scales, [Scales](part0011_split_000.html#I_indexterm7_id303231)\n\n>\n\n>> axis function, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305129)\n\n> ### B\n\nbar charts\n\n> adding color to, [Color](part0010_split_004.html#I_indexterm6_id301728)\n>\n\n>> adding labels to, [Labels](part0010_split_004.html#I_indexterm6_id302068)\n\n>\n\n>> creating scalable flexible, [Modernizing the Bar\nChart](part0013_split_001.html#ix_bcscal)\n\n>\n\n>> creating simple, [Drawing\ndivs](part0010_split_001.html#I_indexterm6_id298882), [Making a Bar\nChart](part0010_split_004.html#ix_bchrt)–[Labels](part0010_split_004.html#I_indexterm6_id302363)\n\n>\n\n>> creating stacked bar charts, [Stack\nLayout](part0015_split_002.html#I_indexterm11_id316577)\n\n>\n\n>> updating color of, [Updating the\nVisuals](part0013_split_002.html#I_indexterm9_id307908)\n\n>\n\n>> updating labels for, [Updating the\nVisuals](part0013_split_002.html#I_indexterm9_id307933)\n\n>\n\n>> barPadding, [Referencing the Ordinal\nScale](part0013_split_001.html#I_indexterm9_id307336)\n\n> behaviors, [Introducing Behaviors](part0014_split_002.html#ix_beh)–[Click to\n> Sort](part0014_split_003.html#I_indexterm10_id314250)\n\n> binding to multiple elements with, [Introducing\n> Behaviors](part0014_split_002.html#I_indexterm10_id312637)\n>\n\n>> click to sort, [Click to\nSort](part0014_split_003.html#I_indexterm10_id313749)\n\n>\n\n>> grouping SVG elements, [Grouping SVG\nElements](part0014_split_003.html#I_indexterm10_id313642)\n\n>\n\n>> hover to highlight, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id312750)\n\n>\n\n>> overlapping elements and, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313422)\n\n>\n\n>> bitmap map tiles, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287235)\n\n> Bloch, Matt, [Simplify the\n> Shapes](part0016_split_006.html#I_indexterm12_id319169)\n\n> block-level elements, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290699)\n\n> block-level scope, [Function-level\n> scope](part0007_split_007.html#I_indexterm3_id293548)\n\n> Bostock, Michael, [Introducing\n> D3](part0006_split_000.html#I_indexterm2_id286898), [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287471)\n\n> box model, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290582)\n\n> browsers\n\n> development of interactivity, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287348)\n>\n\n>> fundamentals of, [The Web](part0007_split_001.html#I_indexterm3_id288680)\n\n>\n\n>> rendering, [Rendering and the Box\nModel](part0007_split_005.html#I_indexterm3_id290588)\n\n>\n\n>> support for, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287168)\n\n>\n\n>> SVG compatibility, [A Note on\nCompatibility](part0007_split_009.html#I_indexterm3_id295474)\n\n>\n\n>> ### C\n\ncallback function, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297179), [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297396)\n\n> Card, Stuart, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287398)\n\n> cartographic detail, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318970)\n\n> cascading styles, [Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291567)\n\n> categorical colors, [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316383)\n\n> centroids, [Pie Layout](part0015_split_001.html#I_indexterm11_id316452)\n\n> chain syntax, [Chaining\n> Methods](part0009_split_001.html#I_indexterm5_id296535)\n\n> chaining methods\n\n> alternatives to, [The Hand-\n> off](part0009_split_001.html#I_indexterm5_id296885)\n>\n\n>> chain syntax, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296541)\n\n>\n\n>> examining the links, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296622)\n\n>\n\n>> input/output matching, [The Hand-\noff](part0009_split_001.html#I_indexterm5_id296850)\n\n>\n\n>> charts\n\n> alternative tools for, [Easy\n> Charts](part0006_split_004.html#I_indexterm2_id287622)\n>\n\n>> column charts, [Drawing\ndivs](part0010_split_001.html#I_indexterm6_id298891)\n\n>\n\n>> (see also bar charts)\n\n>>\n\n>>> pie charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316054)\n\n>\n\n>> ring charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316480)\n\n>\n\n>> child elements, [DOM](part0007_split_003.html#I_indexterm3_id290169)\n\n> choropleth maps,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318117)\n\n> Chrome, development tools, [Developer\n> Tools](part0007_split_004.html#I_indexterm3_id290378)\n\n> cities, adding to map, [Adding\n> Points](part0016_split_005.html#I_indexterm12_id318465)\n\n> class selectors, [Selectors](part0007_split_006.html#I_indexterm3_id290954)\n\n> classed() method, [A Note on\n> Classes](part0010_split_001.html#I_indexterm6_id299308)\n\n> classes\n\n> adding to elements, [Drawing\n> divs](part0010_split_001.html#I_indexterm6_id299041)\n>\n\n>> identifying elements with, [Classes and\nIDs](part0007_split_002.html#I_indexterm3_id289937)\n\n>\n\n>> vs. styles, [A Note on\nClasses](part0010_split_001.html#I_indexterm6_id299284)\n\n>\n\n>> click events, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307674), [Binding Event\nListeners](part0014_split_001.html#I_indexterm10_id312508), [Consideration for\nTouch Devices](part0014_split_005.html#I_indexterm10_id315724)\n\n> click to sort, [Click to\n> Sort](part0014_split_003.html#I_indexterm10_id313759)\n\n> clipping paths, [Containing visual elements with clipping\n> paths](part0013_split_003.html#I_indexterm9_id309907)\n\n> Cloudmade, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287253)\n\n> coding tips\n\n> chaining methods, [The Hand-\n> off](part0009_split_001.html#I_indexterm5_id296876)\n>\n\n>> deconstructing code, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296614)\n\n>\n\n>> increasing legibility, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296592)\n\n>\n\n>> limit to active transitions, [Warning: Start\ncarefully](part0013_split_003.html#I_indexterm9_id309601)\n\n>\n\n>> styling SVG elements, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305714)\n\n>\n\n>> using functions to hold data, [Data Wants to Be\nHeld](part0009_split_002.html#I_indexterm5_id298441)\n\n>\n\n>> color property, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305644)\n\n> colors, [Pretty Colors,\n> Oooh!](part0010_split_003.html#I_indexterm6_id300713), [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316389)\n\n> column charts, [Drawing divs](part0010_split_001.html#I_indexterm6_id298876)\n\n> comments, [Comments](part0007_split_002.html#I_indexterm3_id290095),\n> [Properties and Values](part0007_split_006.html#I_indexterm3_id291200),\n> [Functions](part0007_split_007.html#I_indexterm3_id293139)\n\n> communication protocol, [The\n> Web](part0007_split_001.html#I_indexterm3_id288771)\n\n> comparison operators, [Comparison\n> Operators](part0007_split_007.html#I_indexterm3_id292597)\n\n> containers, [Classes and\n> IDs](part0007_split_002.html#I_indexterm3_id290036), [Hello,\n> Console](part0007_split_007.html#I_indexterm3_id291805)\n\n> continuous ranges, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307104)\n\n> control structures, [Control\n> Structures](part0007_split_007.html#I_indexterm3_id292676)\n\n> coordinate values, locating, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317570), [Adding\n> Points](part0016_split_005.html#I_indexterm12_id318541)\n\n> CSS (Cascading Style Sheets),\n> [CSS](part0007_split_006.html#ix_CSS)–[Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291670)\n\n> applying to axes, [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305565)\n>\n\n>> cascading, [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#I_indexterm3_id291558)\n\n>\n\n>> comments, [Properties and\nValues](part0007_split_006.html#I_indexterm3_id291192)\n\n>\n\n>> CSS rule, [CSS](part0007_split_006.html#I_indexterm3_id290837)\n\n>\n\n>> hover effect, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id312764)\n\n>\n\n>> inheritance, [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#I_indexterm3_id291467)\n\n>\n\n>> methods of applying, [Referencing\nStyles](part0007_split_006.html#I_indexterm3_id291237)\n\n>\n\n>> properties and values, [Properties and\nValues](part0007_split_006.html#I_indexterm3_id291076), [Beyond\nText](part0009_split_002.html#I_indexterm5_id298615)\n\n>\n\n>> selectors and properties,\n[CSS](part0007_split_006.html#I_indexterm3_id290770)\n\n>\n\n>> specificity, [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#I_indexterm3_id291649)\n\n>\n\n>> CSV (comma-separated value files),\n[Data](part0009_split_000.html#I_indexterm5_id296265),\n[Data](part0009_split_002.html#I_indexterm5_id297100)\n\n> ### D\n\nD3\n\n> alternative tools,\n> [Alternatives](part0006_split_004.html#ix_D3alttools)–[Tools Built with\n> D3](part0006_split_004.html#I_indexterm2_id288472)\n>\n\n>> browser support, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287158)\n\n>\n\n>> core concepts of, [Next\nSteps](part0010_split_006.html#I_indexterm6_id303091)\n\n>\n\n>> creating a project template, [Referencing\nD3](part0008_split_002.html#I_indexterm4_id295836)\n\n>\n\n>> data sharing in, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287293)\n\n>\n\n>> development of, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287510)\n\n>\n\n>> downloading, [Introducing\nD3](part0006_split_000.html#I_indexterm2_id286919),\n[Setup](part0008_split_000.html#I_indexterm4_id295602)\n\n>\n\n>> explanatory visualizations with, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287132)\n\n>\n\n>> geomapping in, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287218)\n\n>\n\n>> meaning of name, [Introducing\nD3](part0006_split_000.html#I_indexterm2_id286857)\n\n>\n\n>> prerequisites to learning, [What This Book\nIs](part0005_split_005.html#I_indexterm1_id286560), [Who You\nAre](part0005_split_006.html#I_indexterm1_id286634)\n\n>\n\n>> referencing for setup, [Referencing\nD3](part0008_split_002.html#I_indexterm4_id295710)\n\n>\n\n>> resources for, [Appendix: Further\nStudy](part0018_split_000.html#I_indexterm_id320103)\n\n>\n\n>> setting up a web server for, [Setting Up a Web\nServer](part0008_split_003.html#I_indexterm4_id295872)\n\n>\n\n>> underlying processes, [What It\nDoes](part0006_split_001.html#I_indexterm2_id286968)\n\n>\n\n>> d3.csv () method, [Data](part0009_split_002.html#I_indexterm5_id297106)\n\n> d3.json() method, [Loading JSON\n> data](part0009_split_002.html#I_indexterm5_id297539)\n\n> d3.range() method, [Ordinal Scales,\n> Explained](part0013_split_001.html#I_indexterm9_id306965)\n\n> data, [Data](part0009_split_000.html#ix_data)–[Beyond\n> Text](part0009_split_002.html#I_indexterm5_id298782)\n\n> acceptable file types,\n> [Data](part0009_split_000.html#I_indexterm5_id296244),\n> [Data](part0009_split_002.html#I_indexterm5_id297065)\n>\n\n>> binding to elements, [Binding\nData](part0009_split_002.html#ix_databind)–[Bound and\nDetermined](part0009_split_002.html#I_indexterm5_id298082), [Data Joins with\nKeys](part0013_split_004.html#I_indexterm9_id311325)\n\n>\n\n>> creating page elements for,\n[Data](part0009_split_000.html#ix_pgelem)–[Going\nChainless](part0009_split_001.html#I_indexterm5_id296925)\n\n>\n\n>> holding with functions, [Data Wants to Be\nHeld](part0009_split_002.html#I_indexterm5_id298450)\n\n>\n\n>> storage of, [Data](part0009_split_000.html#I_indexterm5_id296212)\n\n>\n\n>> updating of (see updates)\n\n>\n\n>> using bound data, [Using Your\nData](part0009_split_002.html#ix_bound)–[Beyond\nText](part0009_split_002.html#I_indexterm5_id298789)\n\n>\n\n>> verifying, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297369)\n\n>\n\n>> data arrays, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297258)\n\n> data joins, [Data Joins with Keys](part0013_split_004.html#ix_dajoin)–[Exit\n> transition](part0013_split_004.html#I_indexterm9_id311998)\n\n> controlling order of, [Data Joins with\n> Keys](part0013_split_004.html#I_indexterm9_id311350)\n>\n\n>> defining key functions, [Key\nfunctions](part0013_split_004.html#I_indexterm9_id311702)\n\n>\n\n>> exit ranstitions, [Exit\ntransition](part0013_split_004.html#I_indexterm9_id311799)\n\n>\n\n>> preparing data for, [Preparing the\ndata](part0013_split_004.html#I_indexterm9_id311440)\n\n>\n\n>> updating references, [Updating all\nreferences](part0013_split_004.html#I_indexterm9_id311565)\n\n>\n\n>> data loading, error handling, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297363)\n\n> data mapping\n\n> benefits of computation, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286378)\n>\n\n>> binding data for, [Binding\nData](part0009_split_002.html#I_indexterm5_id296987)\n\n>\n\n>> design application in, [What It\nDoes](part0006_split_001.html#I_indexterm2_id287058)\n\n>\n\n>> data sharing, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287286)\n\n> data strings, [Loading CSV\n> data](part0009_split_002.html#I_indexterm5_id297316)\n\n> data values\n\n> encoding as color, [Color](part0010_split_004.html#I_indexterm6_id301798)\n>\n\n>> multi-value maps, [Color](part0010_split_004.html#I_indexterm6_id301936)\n\n>\n\n>> data visualization\n\n> benefits of, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286422)\n>\n\n>> benefits of interactivity, [Why\nInteractive?](part0005_split_003.html#I_indexterm1_id286451)\n\n>\n\n>> benefits of web-standard technologies, [Why on the\nWeb?](part0005_split_004.html#I_indexterm1_id286516)\n\n>\n\n>> early applications for, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287410)\n\n>\n\n>> exporting to other file types,\n[Exporting](part0017_split_000.html#ix_dvexp)–[SVG](part0017_split_003.html#I_indexterm13_id320064)\n\n>\n\n>> data() method, [Using Your\nData](part0009_split_002.html#I_indexterm5_id298209), [Setting\nStyles](part0010_split_001.html#I_indexterm6_id299653)\n\n> Data-Driven Documents (see D3)\n\n> data-driven shapes, [Data-Driven\n> Shapes](part0010_split_003.html#I_indexterm6_id300371)\n\n> Davies, Jason, [Projections](part0016_split_003.html#I_indexterm12_id318078)\n\n> degrees vs. radians, [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316075)\n\n> descendant elements, [DOM](part0007_split_003.html#I_indexterm3_id290187)\n\n> descendant selectors,\n> [Selectors](part0007_split_006.html#I_indexterm3_id290921)\n\n> descending order sort, [Click to\n> Sort](part0014_split_003.html#I_indexterm10_id314159)\n\n> design systems, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286401)\n\n> developer tools, [Developer\n> Tools](part0007_split_004.html#ix_devtool)–[Developer\n> Tools](part0007_split_004.html#I_indexterm3_id290518)\n\n> discrete ranges, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307097)\n\n> div attribute, [Drawing divs](part0010_split_001.html#I_indexterm6_id298850)\n\n> div element, [Classes and\n> IDs](part0007_split_002.html#I_indexterm3_id290028)\n\n> DOM (Document Object Model)\n\n> appending SVG elements with axis function, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305330)\n>\n\n>> examining current state of, [Developer\nTools](part0007_split_004.html#I_indexterm3_id290427)\n\n>\n\n>> hierarchial structure, [DOM](part0007_split_003.html#I_indexterm3_id290145)\n\n>\n\n>> interacting with event listeners, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307588)\n\n>\n\n>> styling with CSS, [CSS](part0007_split_006.html#I_indexterm3_id290743)\n\n>\n\n>> domain name, [The Web](part0007_split_001.html#I_indexterm3_id288786)\n\n> drawing\n\n> alternative tools for, [Almost from\n> Scratch](part0006_split_004.html#I_indexterm2_id288113)\n>\n\n>> irregular forms, [Pie\nLayout](part0015_split_001.html#I_indexterm11_id316204)\n\n>\n\n>> drawing order, [Layering and Drawing\nOrder](part0007_split_008.html#I_indexterm3_id295037)\n\n> dual encoding, [Color](part0010_split_004.html#I_indexterm6_id301813)\n\n> dynamic axes, [Final Touches](part0012_split_006.html#I_indexterm8_id306309)\n\n> dynamic paragraphs, [Please Make Your\n> Selection](part0009_split_002.html#I_indexterm5_id297631), [Beyond\n> Text](part0009_split_002.html#I_indexterm5_id298770)\n\n> dynamic scaling, [Creating a\n> Scale](part0011_split_004.html#I_indexterm7_id303669), [Setting Up Dynamic\n> Scales](part0011_split_005.html#I_indexterm7_id303930)\n\n> ### E\n\neach() statements, [each() Transition Starts and\nEnds](part0013_split_003.html#I_indexterm9_id309452)\n\n> easing, [ease()-y Does It](part0013_split_003.html#I_indexterm9_id308317)\n\n> edges, [Force Layout](part0015_split_003.html#I_indexterm11_id316928)\n\n> elements\n\n> adding, [Adding Values (and\n> Elements)](part0013_split_004.html#I_indexterm9_id310355)\n>\n\n>> adding a class to, [Drawing\ndivs](part0010_split_001.html#I_indexterm6_id299033)\n\n>\n\n>> adding structure with, [Adding Structure with\nElements](part0007_split_002.html#I_indexterm3_id289291)\n\n>\n\n>> applying styles to, [Styling SVG\nElements](part0007_split_008.html#I_indexterm3_id294548)\n\n>\n\n>> description of, [DOM](part0007_split_003.html#I_indexterm3_id290154)\n\n>\n\n>> group elements, [Setting Up an\nAxis](part0012_split_002.html#I_indexterm8_id305364)\n\n>\n\n>> encoding values, [Color](part0010_split_004.html#I_indexterm6_id301807)\n\n> enter() method, [Please Make Your\n> Selection](part0009_split_002.html#I_indexterm5_id297624)\n\n> event listeners, [Interaction via Event\n> Listeners](part0013_split_002.html#I_indexterm9_id307522), [Binding Event\n> Listeners](part0014_split_001.html#I_indexterm10_id312406), [Introducing\n> Behaviors](part0014_split_002.html#I_indexterm10_id312631)\n\n> event model, [Binding Event\n> Listeners](part0014_split_001.html#I_indexterm10_id312430)\n\n> exit selection, [Removing Values (and\n> Elements)](part0013_split_004.html#I_indexterm9_id310946)\n\n> exiting elements, [Exit](part0013_split_004.html#I_indexterm9_id311004)\n\n> exploratory vs. explanatory visualizations, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287141)\n\n> exporting,\n> [Exporting](part0017_split_000.html#ix_expvis)–[SVG](part0017_split_003.html#I_indexterm13_id320071)\n\n> bitmaps, [Bitmaps](part0017_split_001.html#I_indexterm13_id319710)\n>\n\n>> PDFs, [PDF](part0017_split_002.html#I_indexterm13_id319786)\n\n>\n\n>> SVG format, [SVG](part0017_split_003.html#I_indexterm13_id319857)\n\n>\n\n>> external style sheets, [Reference an external stylesheet from the\nHTML.](part0007_split_006.html#I_indexterm3_id291336)\n\n> ### F\n\nFirefox, development tools, [Developer\nTools](part0007_split_004.html#I_indexterm3_id290384)\n\n> Flare, [Origins and Context](part0006_split_003.html#I_indexterm2_id287435)\n\n> for loops, [for() now](part0007_split_007.html#I_indexterm3_id292769), [The\n> Power of data()](part0010_split_002.html#I_indexterm6_id299777)\n\n> force layout, [Force Layout](part0015_split_003.html#ix_force)–[Force\n> Layout](part0015_split_003.html#I_indexterm11_id317342)\n\n> formatting functions, testing, [Formatting Tick\n> Labels](part0012_split_007.html#I_indexterm8_id306519)\n\n> function-level scope, [Function-level\n> scope](part0007_split_007.html#I_indexterm3_id293508)\n\n> functions\n\n> accessor function, [d3.min() and\n> d3.max()](part0011_split_005.html#I_indexterm7_id303859), [Updating all\n> references](part0013_split_004.html#I_indexterm9_id311627)\n>\n\n>> anonymous functions, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298269), [Interaction via\nEvent Listeners](part0013_split_002.html#I_indexterm9_id307632)\n\n>\n\n>> axis function, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305135)\n\n>\n\n>> basic code structure of, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298246)\n\n>\n\n>> callback function, [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297185), [Loading CSV\ndata](part0009_split_002.html#I_indexterm5_id297402)\n\n>\n\n>> D3 scales as, [Scales](part0011_split_000.html#I_indexterm7_id303197)\n\n>\n\n>> event listeners, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307623)\n\n>\n\n>> named functions, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298277), [Interaction via\nEvent Listeners](part0013_split_002.html#I_indexterm9_id307597)\n\n>\n\n>> passing arguments to,\n[Functions](part0007_split_007.html#I_indexterm3_id293029)\n\n>\n\n>> used as arguments, [Data Wants to Be\nHeld](part0009_split_002.html#I_indexterm5_id298509)\n\n>\n\n>> vs. methods, [Chaining\nMethods](part0009_split_001.html#I_indexterm5_id296562)\n\n>\n\n>> ### G\n\ngeocoding services, [Adding\nPoints](part0016_split_005.html#I_indexterm12_id318535)\n\n> Geographic Information Systems (GIS) software, [Find\n> Shapefiles](part0016_split_006.html#I_indexterm12_id318884)\n\n> GeoJSON, [GeoJSON](part0007_split_007.html#I_indexterm3_id292482), [JSON,\n> Meet GeoJSON](part0016_split_001.html#I_indexterm12_id317411), [Convert to\n> GeoJSON](part0016_split_006.html#I_indexterm12_id319287)\n\n> geomapping, [JSON, Meet GeoJSON](part0016_split_001.html#ix_geom)–[Convert\n> to GeoJSON](part0016_split_006.html#I_indexterm12_id319635)\n\n> acquiring/parsing geodata, [Acquiring and Parsing\n> Geodata](part0016_split_006.html#ix_gapg)–[Convert to\n> GeoJSON](part0016_split_006.html#I_indexterm12_id319642)\n>\n\n>> alternative tools for,\n[Geomapping](part0006_split_004.html#I_indexterm2_id287979)\n\n>\n\n>> choropleth, [Choropleth](part0016_split_004.html#I_indexterm12_id318108)\n\n>\n\n>> D3 support for, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287226)\n\n>\n\n>> GeoJSON, [JSON, Meet\nGeoJSON](part0016_split_001.html#I_indexterm12_id317403)\n\n>\n\n>> map points, [Adding Points](part0016_split_005.html#I_indexterm12_id318444)\n\n>\n\n>> paths, [Paths](part0016_split_002.html#I_indexterm12_id317606)\n\n>\n\n>> projections, [Projections](part0016_split_003.html#I_indexterm12_id317819)\n\n>\n\n>> geometry simplification, [Simplify the\nShapes](part0016_split_006.html#I_indexterm12_id319182)\n\n> global namespace, [Global\n> namespace](part0007_split_007.html#I_indexterm3_id293604)\n\n> Google Maps, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287247)\n\n> graduated scale, [Check for\n> Ticks](part0012_split_004.html#I_indexterm8_id306012)\n\n> granularity, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318989)\n\n> graphs\n\n> alternative tools for, [Graph\n> Visualizations](part0006_split_004.html#I_indexterm2_id287894)\n>\n\n>> creating with force layouts, [Force\nLayout](part0015_split_003.html#I_indexterm11_id316910)\n\n>\n\n>> (see also charts)\n\n>>\n\n>>> group elements, [Setting Up an\nAxis](part0012_split_002.html#I_indexterm8_id305374)\n\n> ### H\n\nHawaii, map of, [Projections](part0016_split_003.html#I_indexterm12_id317892)\n\n> Heer, Jeffrey, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287392)\n\n> horizontal axis, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305295)\n\n> hover to highlight, [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id312758)\n\n> HTML (Hypertext Markup Language),\n> [HTML](part0007_split_002.html#ix_HTML)–[Comments](part0007_split_002.html#I_indexterm3_id290123)\n\n> attributes, [Attributes](part0007_split_002.html#I_indexterm3_id289848),\n> [Beyond Text](part0009_split_002.html#I_indexterm5_id298633)\n>\n\n>> classes and IDs, [Classes and\nIDs](part0007_split_002.html#I_indexterm3_id289927)\n\n>\n\n>> comments, [Comments](part0007_split_002.html#I_indexterm3_id290087)\n\n>\n\n>> common elements, [Common\nElements](part0007_split_002.html#I_indexterm3_id289420)\n\n>\n\n>> specifying structure with, [Content Plus\nStructure](part0007_split_002.html#I_indexterm3_id289016)\n\n>\n\n>> tags and elements, [Adding Structure with\nElements](part0007_split_002.html#I_indexterm3_id289276)\n\n>\n\n>> HTML div tooltips, [HTML div\nTooltips](part0014_split_004.html#I_indexterm10_id314709)\n\n> HTTP (Hypertext Transfer Protocol), [The\n> Web](part0007_split_001.html#I_indexterm3_id288779)\n\n> HTTPS (Hypertext Transfer Protocol Secure), [The\n> Web](part0007_split_001.html#I_indexterm3_id288842)\n\n> ### I\n\nID selectors, [Selectors](part0007_split_006.html#I_indexterm3_id291010)\n\n> IDs, [Classes and IDs](part0007_split_002.html#I_indexterm3_id290005)\n\n> if statements, [Control\n> Structures](part0007_split_007.html#I_indexterm3_id292682)\n\n> immediate transformations, [Warning: Start\n> carefully](part0013_split_003.html#I_indexterm9_id309685)\n\n> index order, [Data Joins with\n> Keys](part0013_split_004.html#I_indexterm9_id311367)\n\n> InfoVis paper, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287532)\n\n> inheritance, [Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291476)\n\n> inline elements, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290705)\n\n> inline styles, [Attach inline\n> styles.](part0007_split_006.html#I_indexterm3_id291388)\n\n> input domain, [Domains and\n> Ranges](part0011_split_002.html#I_indexterm7_id303329)\n\n> interactivity, [Interactivity](part0014_split_000.html#ix_interact)–[Moving\n> Forward](part0014_split_006.html#I_indexterm10_id315791)\n\n> behaviors, [Introducing\n> Behaviors](part0014_split_002.html#I_indexterm10_id312611)\n>\n\n>> benefits of, [Why\nInteractive?](part0005_split_003.html#I_indexterm1_id286460)\n\n>\n\n>> browser development and, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287357)\n\n>\n\n>> click to sort, [Click to\nSort](part0014_split_003.html#I_indexterm10_id313772)\n\n>\n\n>> event listeners and, [Binding Event\nListeners](part0014_split_001.html#I_indexterm10_id312396)\n\n>\n\n>> hover to highlight, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id312773)\n\n>\n\n>> pointer events, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313431)\n\n>\n\n>> tooltips, [Tooltips](part0014_split_004.html#I_indexterm10_id314291)\n\n>\n\n>> touch devices, [Consideration for Touch\nDevices](part0014_split_005.html#I_indexterm10_id315736)\n\n>\n\n>> Internet Explorer, [The SVG\nElement](part0007_split_008.html#I_indexterm3_id293940), [A Note on\nCompatibility](part0007_split_009.html#I_indexterm3_id295459)\n\n> ### J\n\nJavaScript, [JavaScript](part0007_split_007.html#ix_Java)–[Global\nnamespace](part0007_split_007.html#I_indexterm3_id293825)\n\n> arrays, [Arrays](part0007_split_007.html#I_indexterm3_id291955), [What\n> arrays are made for()](part0007_split_007.html#I_indexterm3_id292918)\n>\n\n>> arrays of objects, [Objects and\nArrays](part0007_split_007.html#I_indexterm3_id292285)\n\n>\n\n>> as basis for D3, [What This Book\nIs](part0005_split_005.html#I_indexterm1_id286598)\n\n>\n\n>> comments, [Functions](part0007_split_007.html#I_indexterm3_id293146)\n\n>\n\n>> comparison operators, [Comparison\nOperators](part0007_split_007.html#I_indexterm3_id292588)\n\n>\n\n>> control structures, [Control\nStructures](part0007_split_007.html#I_indexterm3_id292667)\n\n>\n\n>> event model, [Binding Event\nListeners](part0014_split_001.html#I_indexterm10_id312436)\n\n>\n\n>> function-level scope, [Function-level\nscope](part0007_split_007.html#I_indexterm3_id293499)\n\n>\n\n>> functions, [Functions](part0007_split_007.html#I_indexterm3_id293020)\n\n>\n\n>> GeoJSON, [GeoJSON](part0007_split_007.html#I_indexterm3_id292473)\n\n>\n\n>> global namespace, [Global\nnamespace](part0007_split_007.html#I_indexterm3_id293595)\n\n>\n\n>> introduction of, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287329)\n\n>\n\n>> JSON, [JSON](part0007_split_007.html#I_indexterm3_id292406)\n\n>\n\n>> mathematical operators, [Mathematical\nOperators](part0007_split_007.html#I_indexterm3_id292529)\n\n>\n\n>> objects, [Objects](part0007_split_007.html#I_indexterm3_id292210)\n\n>\n\n>> opening the JS console, [Hello,\nConsole](part0007_split_007.html#I_indexterm3_id291721)\n\n>\n\n>> scripts, [Referencing\nScripts](part0007_split_007.html#I_indexterm3_id293189)\n\n>\n\n>> variable autotyping, [JavaScript\nGotchas](part0007_split_007.html#I_indexterm3_id293251)\n\n>\n\n>> variable hoisting, [Variable\nhoisting](part0007_split_007.html#I_indexterm3_id293416)\n\n>\n\n>> variables, [Hello, Console](part0007_split_007.html#I_indexterm3_id291790)\n\n>\n\n>> jQuery, [Warning: Start\ncarefully](part0013_split_003.html#I_indexterm9_id309658)\n\n> JSON (JavaScript Object Notation),\n> [JSON](part0007_split_007.html#I_indexterm3_id292416),\n> [Data](part0009_split_000.html#I_indexterm5_id296271), [Loading CSV\n> data](part0009_split_002.html#I_indexterm5_id297520)\n\n> ### K\n\nkey functions, [Data Joins with\nKeys](part0013_split_004.html#I_indexterm9_id311382), [Key\nfunctions](part0013_split_004.html#I_indexterm9_id311694)\n\n> ### L\n\nlabels\n\n> for axes, [Setting Up an\n> Axis](part0012_split_002.html#I_indexterm8_id305233), [Y\n> Not?](part0012_split_005.html#I_indexterm8_id306121), [Formatting Tick\n> Labels](part0012_split_007.html#I_indexterm8_id306433)\n>\n\n>> for bar charts, [Updating the\nVisuals](part0013_split_002.html#I_indexterm9_id307943)\n\n>\n\n>> Landay, James, [Origins and\nContext](part0006_split_003.html#I_indexterm2_id287404)\n\n> latitude, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317532)\n\n> layering, [Layering and Drawing\n> Order](part0007_split_008.html#I_indexterm3_id295044)\n\n> layouts, [Layouts](part0015_split_000.html#ix_lay)–[Force\n> Layout](part0015_split_003.html#I_indexterm11_id317328)\n\n> force layout, [Force Layout](part0015_split_003.html#ix_lflay)–[Force\n> Layout](part0015_split_003.html#I_indexterm11_id317335)\n>\n\n>> list of, [Layouts](part0015_split_000.html#I_indexterm11_id315841)\n\n>\n\n>> pie layout, [Pie Layout](part0015_split_001.html#I_indexterm11_id316040)\n\n>\n\n>> stack layout, [Stack\nLayout](part0015_split_002.html#I_indexterm11_id316561)\n\n>\n\n>> linear scales, [Scales](part0011_split_000.html#I_indexterm7_id303256)\n\n> local servers, [The Web](part0007_split_001.html#I_indexterm3_id288643)\n\n> longitude, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317525)\n\n> ### M\n\nmagic numbers, [Updating\nScales](part0013_split_003.html#I_indexterm9_id308944)\n\n> map points, [Adding Points](part0016_split_005.html#I_indexterm12_id318459)\n\n> map tiles, [What It Doesn’t\n> Do](part0006_split_002.html#I_indexterm2_id287241)\n\n> mapping rules, [Why Write\n> Code?](part0005_split_002.html#I_indexterm1_id286395)\n\n> maps\n\n> choropleth maps,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318144)\n>\n\n>> Google Maps, [What It Doesn’t\nDo](part0006_split_002.html#I_indexterm2_id287259)\n\n>\n\n>> multi-value, [Color](part0010_split_004.html#I_indexterm6_id301951)\n\n>\n\n>> political maps,\n[Choropleth](part0016_split_004.html#I_indexterm12_id318136)\n\n>\n\n>> population maps, [Adding\nPoints](part0016_split_005.html#I_indexterm12_id318553)\n\n>\n\n>> United States map, [JSON, Meet\nGeoJSON](part0016_split_001.html#I_indexterm12_id317417)\n\n>\n\n>> (see also geomapping)\n\n>>\n\n>>> MapShaper, [Simplify the\nShapes](part0016_split_006.html#I_indexterm12_id319175)\n\n> masks, [Containing visual elements with clipping\n> paths](part0013_split_003.html#I_indexterm9_id309924)\n\n> mathematical operators, [Mathematical\n> Operators](part0007_split_007.html#I_indexterm3_id292538)\n\n> maximum value, [Updating\n> Scales](part0013_split_003.html#I_indexterm9_id308950)\n\n> methods, vs. functions, [Chaining\n> Methods](part0009_split_001.html#I_indexterm5_id296570)\n\n> Migurski, Mike, [Simplify the\n> Shapes](part0016_split_006.html#I_indexterm12_id319254)\n\n> mouseover events, [Binding Event\n> Listeners](part0014_split_001.html#I_indexterm10_id312514), [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id312743), [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id313392)\n\n> multi-value maps, [Color](part0010_split_004.html#I_indexterm6_id301945)\n\n> multitouch interactions, [Consideration for Touch\n> Devices](part0014_split_005.html#I_indexterm10_id315730)\n\n> ### N\n\nnamed functions, [High-\nFunctioning](part0009_split_002.html#I_indexterm5_id298262)\n\n> nodes, [Force Layout](part0015_split_003.html#I_indexterm11_id316922)\n\n> normalization,\n> [Normalization](part0011_split_003.html#I_indexterm7_id303513)\n\n> ### O\n\nobjects, [Objects](part0007_split_007.html#I_indexterm3_id292188)\n\n> Ogievetsky, Vadim, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287504)\n\n> ordinal scales, [Introducing\n> Axes](part0012_split_001.html#I_indexterm8_id305155), [Modernizing the Bar\n> Chart](part0013_split_001.html#I_indexterm9_id306807), [Referencing the\n> Ordinal Scale](part0013_split_001.html#I_indexterm9_id307232), [Pie\n> Layout](part0015_split_001.html#I_indexterm11_id316376)\n\n> output range, [Domains and\n> Ranges](part0011_split_002.html#I_indexterm7_id303336)\n\n> overlapping elements, [Hover to\n> Highlight](part0014_split_002.html#I_indexterm10_id313398)\n\n> ### P\n\npadding, [Refining the Plot](part0011_split_006.html#I_indexterm7_id304284),\n[Cleaning It Up](part0012_split_003.html#I_indexterm8_id305924), [Y\nNot?](part0012_split_005.html#I_indexterm8_id306239), [Round Bands Are All the\nRange These Days](part0013_split_001.html#I_indexterm9_id307188), [Referencing\nthe Ordinal Scale](part0013_split_001.html#I_indexterm9_id307329)\n\n> page elements\n\n> binding data to, [Binding Data](part0009_split_002.html#ix_pebind)–[Bound\n> and Determined](part0009_split_002.html#I_indexterm5_id298089), [Data Joins\n> with Keys](part0013_split_004.html#I_indexterm9_id311334)\n>\n\n>> creating, [Generating Page\nElements](part0009_split_001.html#ix_pgelemcrt)–[Going\nChainless](part0009_split_001.html#I_indexterm5_id296932)\n\n>\n\n>> paragraph elements, [Generating Page\nElements](part0009_split_001.html#I_indexterm5_id296340)\n\n> parent elements, [DOM](part0007_split_003.html#I_indexterm3_id290163)\n\n> paths, [Pie Layout](part0015_split_001.html#I_indexterm11_id316198),\n> [Paths](part0016_split_002.html#I_indexterm12_id317616)\n\n> pie charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316048)\n\n> pixel-based coordinates system, [Simple\n> Shapes](part0007_split_008.html#I_indexterm3_id294094)\n\n> pixels\n\n> lining up to, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307179)\n>\n\n>> smoothing, [Cleaning It Up](part0012_split_003.html#I_indexterm8_id305744)\n\n>\n\n>> pointer events, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313413),\n[Tooltips](part0014_split_004.html#I_indexterm10_id314269)\n\n> (see also mouseover events)\n>\n\n>> (see also tooltips)\n\n>\n\n>> points, [Adding Points](part0016_split_005.html#I_indexterm12_id318453)\n\n> political maps, [Choropleth](part0016_split_004.html#I_indexterm12_id318123)\n\n> population maps, [Adding\n> Points](part0016_split_005.html#I_indexterm12_id318548)\n\n> port number, [The Web](part0007_split_001.html#I_indexterm3_id288791)\n\n> prefuse application, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287385)\n\n> print-to-PDF functionality,\n> [PDF](part0017_split_002.html#I_indexterm13_id319830)\n\n> projections, [Projections](part0016_split_003.html#I_indexterm12_id317828),\n> [Adding Points](part0016_split_005.html#I_indexterm12_id318665)\n\n> properties, [CSS](part0007_split_006.html#I_indexterm3_id290785),\n> [Properties and Values](part0007_split_006.html#I_indexterm3_id291085),\n> [Objects](part0007_split_007.html#I_indexterm3_id292195)\n\n> Protovis visualization toolkit, [Origins and\n> Context](part0006_split_003.html#I_indexterm2_id287477)\n\n> ### Q\n\nquantitative scales, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305148)\n\n> quantize scales,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318194)\n\n> queued transitions, [Warning: Start\n> carefully](part0013_split_003.html#I_indexterm9_id309652)\n\n> ### R\n\nradians, [Pie Layout](part0015_split_001.html#I_indexterm11_id316081)\n\n> random data, generating, [Random\n> Data](part0010_split_002.html#I_indexterm6_id299848)\n\n> range banding, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307091)\n\n> rectangles, drawing, [Drawing\n> divs](part0010_split_001.html#I_indexterm6_id298857)\n\n> red state/blue state maps,\n> [Choropleth](part0016_split_004.html#I_indexterm12_id318130)\n\n> referencing styles, [Referencing\n> Styles](part0007_split_006.html#I_indexterm3_id291245)\n\n> remote servers, [The Web](part0007_split_001.html#I_indexterm3_id288650)\n\n> rendering, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290551)\n\n> requests, [The Web](part0007_split_001.html#I_indexterm3_id288599)\n\n> resolution, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318976)\n\n> ring charts, [Pie Layout](part0015_split_001.html#I_indexterm11_id316474)\n\n> ### S\n\nSafari, development tools, [Developer\nTools](part0007_split_004.html#I_indexterm3_id290390)\n\n> sample code files, obtaining, [Using Sample\n> Code](part0005_split_008.html#I_indexterm1_id286768), [Referencing\n> D3](part0008_split_002.html#I_indexterm4_id295761)\n\n> scales, [Scales](part0011_split_000.html#ix_scales)–[Other\n> Scales](part0011_split_008.html#I_indexterm7_id304794)\n\n> additional methods, [Other\n> Methods](part0011_split_007.html#I_indexterm7_id304650)\n>\n\n>> creating, [Creating a Scale](part0011_split_004.html#I_indexterm7_id303551)\n\n>\n\n>> definition of, [Scales](part0011_split_000.html#I_indexterm7_id303170)\n\n>\n\n>> dynamic scales, [Creating a\nScale](part0011_split_004.html#I_indexterm7_id303675), [Setting Up Dynamic\nScales](part0011_split_005.html#I_indexterm7_id303920)\n\n>\n\n>> incorporating scaled values, [Incorporating Scaled\nValues](part0011_split_005.html#I_indexterm7_id304036)\n\n>\n\n>> input domain/output range, [Domains and\nRanges](part0011_split_002.html#I_indexterm7_id303342)\n\n>\n\n>> normalization,\n[Normalization](part0011_split_003.html#I_indexterm7_id303504)\n\n>\n\n>> refining the plot, [Incorporating Scaled\nValues](part0011_split_005.html#I_indexterm7_id304128)\n\n>\n\n>> vs. axes, [Scales](part0011_split_000.html#I_indexterm7_id303222)\n\n>\n\n>> scatterplots\n\n> adding x/y axes to, [Axes](part0012_split_000.html#I_indexterm8_id305090)\n>\n\n>> creating, [Making a\nScatterplot](part0010_split_005.html#ix_splot)–[Labels](part0010_split_005.html#I_indexterm6_id303044)\n\n>\n\n>> scaling, [Creating a Scale](part0011_split_004.html#I_indexterm7_id303659)\n\n>\n\n>> screen coordinates vs. geo-coordinates, [Adding\nPoints](part0016_split_005.html#I_indexterm12_id318649)\n\n> scripts, [Referencing\n> Scripts](part0007_split_007.html#I_indexterm3_id293198)\n\n> select(), [Select](part0013_split_004.html#I_indexterm9_id310421)\n\n> selectAll(), [Select](part0013_split_004.html#I_indexterm9_id310428)\n\n> selection.on() method, [Interaction via Event\n> Listeners](part0013_split_002.html#I_indexterm9_id307661)\n\n> selectors, [CSS](part0007_split_006.html#I_indexterm3_id290779)\n\n> semantic structure, [Content Plus\n> Structure](part0007_split_002.html#I_indexterm3_id289152)\n\n> sequential numbers, generating an array of, [Ordinal Scales,\n> Explained](part0013_split_001.html#I_indexterm9_id306957)\n\n> servers, [The Web](part0007_split_001.html#I_indexterm3_id288614)\n\n> shape-rendering property, [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305738)\n\n> shapefiles, [Find\n> Shapefiles](part0016_split_006.html#I_indexterm12_id318876)\n\n> sibling elements, [DOM](part0007_split_003.html#I_indexterm3_id290175)\n\n> sorting, [Click to Sort](part0014_split_003.html#I_indexterm10_id313765)\n\n> source code, viewing, [Developer\n> Tools](part0007_split_004.html#I_indexterm3_id290359)\n\n> specificity, [Inheritance, Cascading, and\n> Specificity](part0007_split_006.html#I_indexterm3_id291658)\n\n> stack layout, [Stack Layout](part0015_split_002.html#I_indexterm11_id316571)\n\n> staggered transitions, [Please Do Not\n> delay()](part0013_split_003.html#I_indexterm9_id308578)\n\n> static transitions, [Please Do Not\n> delay()](part0013_split_003.html#I_indexterm9_id308584)\n\n> style() method, [Beyond Text](part0009_split_002.html#I_indexterm5_id298655)\n\n> styles\n\n> setting, [Setting Styles](part0010_split_001.html#I_indexterm6_id299470)\n>\n\n>> vs. classes, [A Note on\nClasses](part0010_split_001.html#I_indexterm6_id299292)\n\n>\n\n>> SVG (Scalable Vector Graphics),\n[SVG](part0007_split_008.html#ix_SVG)–[Transparency](part0007_split_008.html#I_indexterm3_id295401)\n\n> applying styles to elements, [Styling SVG\n> Elements](part0007_split_008.html#I_indexterm3_id294538)\n>\n\n>> applying transparency,\n[Transparency](part0007_split_008.html#I_indexterm3_id295078)\n\n>\n\n>> axis functions and, [Introducing\nAxes](part0012_split_001.html#I_indexterm8_id305161)\n\n>\n\n>> browser compatibility, [A Note on\nCompatibility](part0007_split_009.html#I_indexterm3_id295465)\n\n>\n\n>> creating elements, [The SVG\nElement](part0007_split_008.html#I_indexterm3_id293932)\n\n>\n\n>> creating simple shapes, [Simple\nShapes](part0007_split_008.html#I_indexterm3_id294073), [Drawing\nSVGs](part0010_split_003.html#ix_svgshapes)–[Pretty Colors,\nOooh!](part0010_split_003.html#I_indexterm6_id300775)\n\n>\n\n>> creating tooltips with, [SVG Element\nTooltips](part0014_split_004.html#I_indexterm10_id314486)\n\n>\n\n>> drawing overlapping shapes, [Layering and Drawing\nOrder](part0007_split_008.html#I_indexterm3_id294967), [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313404)\n\n>\n\n>> exporting D3 visualizations as,\n[SVG](part0017_split_003.html#I_indexterm13_id319867)\n\n>\n\n>> grouping elements, [Grouping SVG\nElements](part0014_split_003.html#I_indexterm10_id313632)\n\n>\n\n>> ### T\n\ntags, [Adding Structure with\nElements](part0007_split_002.html#I_indexterm3_id289285)\n\n> text-based data, [Data](part0009_split_000.html#I_indexterm5_id296252)\n\n> tick marks, [Check for Ticks](part0012_split_004.html#I_indexterm8_id306006)\n\n> ticks (time measurement), [Force\n> Layout](part0015_split_003.html#I_indexterm11_id317110)\n\n> tooltips, [Tooltips](part0014_split_004.html#ix_ttip)–[HTML div\n> Tooltips](part0014_split_004.html#I_indexterm10_id315604)\n\n> default, [Default Browser\n> Tooltips](part0014_split_004.html#I_indexterm10_id314322)\n>\n\n>> HTML div tooltips, [HTML div\nTooltips](part0014_split_004.html#I_indexterm10_id314698)\n\n>\n\n>> SVG elements, [SVG Element\nTooltips](part0014_split_004.html#I_indexterm10_id314477)\n\n>\n\n>> touch-based interfaces, [Consideration for Touch\nDevices](part0014_split_005.html#I_indexterm10_id315717)\n\n> transformations, [What It\n> Does](part0006_split_001.html#I_indexterm2_id287066), [Cleaning It\n> Up](part0012_split_003.html#I_indexterm8_id305794)\n\n> transitions, [Transitions](part0013_split_003.html#ix_trans)–[Containing\n> visual elements with clipping\n> paths](part0013_split_003.html#I_indexterm9_id310280)\n\n> adding animated,\n> [Transitions](part0013_split_003.html#I_indexterm9_id308030)\n>\n\n>> chaining together, [End\ngracefully](part0013_split_003.html#I_indexterm9_id309793)\n\n>\n\n>> clipping paths, [Containing visual elements with clipping\npaths](part0013_split_003.html#I_indexterm9_id309915)\n\n>\n\n>> controlling duration of, [duration(), or How Long Is This Going to\nTake?](part0013_split_003.html#I_indexterm9_id308173)\n\n>\n\n>> delaying start of, [Please Do Not\ndelay()](part0013_split_003.html#I_indexterm9_id308521)\n\n>\n\n>> equalizing the pace, [ease()-y Does\nIt](part0013_split_003.html#I_indexterm9_id308308)\n\n>\n\n>> exit transition, [Exit\ntransition](part0013_split_004.html#I_indexterm9_id311790)\n\n>\n\n>> in mouseover events, [Hover to\nHighlight](part0014_split_002.html#I_indexterm10_id313047)\n\n>\n\n>> interrupted, [Click to\nSort](part0014_split_003.html#I_indexterm10_id314017)\n\n>\n\n>> limit to active number, [Warning: Start\ncarefully](part0013_split_003.html#I_indexterm9_id309611)\n\n>\n\n>> marking beginnings/endings of, [each() Transition Starts and\nEnds](part0013_split_003.html#I_indexterm9_id309460)\n\n>\n\n>> randomizing the data, [Randomizing the\nData](part0013_split_003.html#I_indexterm9_id308754)\n\n>\n\n>> updating axes, [Updating\nAxes](part0013_split_003.html#I_indexterm9_id309222)\n\n>\n\n>> updating the scale, [Updating\nScales](part0013_split_003.html#I_indexterm9_id308920)\n\n>\n\n>> translation transform, [Cleaning It\nUp](part0012_split_003.html#I_indexterm8_id305853)\n\n> transparency, [Transparency](part0007_split_008.html#I_indexterm3_id295087)\n\n> TXT (plain text files),\n> [Data](part0009_split_000.html#I_indexterm5_id296258)\n\n> type selectors, [Selectors](part0007_split_006.html#I_indexterm3_id290884)\n\n> typeof operator, [Dynamic\n> typing](part0007_split_007.html#I_indexterm3_id293378)\n\n> ### U\n\nul (unordered list), [Rendering and the Box\nModel](part0007_split_005.html#I_indexterm3_id290651)\n\n> United States, map of, [JSON, Meet\n> GeoJSON](part0016_split_001.html#I_indexterm12_id317397)\n\n> updates, [Updates, Transitions, and\n> Motion](part0013_split_000.html#ix_updates)–[Recap](part0013_split_004.html#I_indexterm9_id312333)\n\n> adding and removing data, [Add and Remove: Combo\n> Platter](part0013_split_004.html#I_indexterm9_id312028)\n>\n\n>> adding values/elements, [Adding Values (and\nElements)](part0013_split_004.html#ix_upadd)–[Update](part0013_split_004.html#I_indexterm9_id310907)\n\n>\n\n>> animation of, [Transitions](part0013_split_003.html#I_indexterm9_id308091)\n\n>\n\n>> basic steps to, [Updating\nData](part0013_split_002.html#I_indexterm9_id307400), [Changing the\nData](part0013_split_002.html#I_indexterm9_id307715)\n\n>\n\n>> data joins, [Data Joins with\nKeys](part0013_split_004.html#ix_updajoin)–[Exit\ntransition](part0013_split_004.html#I_indexterm9_id312005)\n\n>\n\n>> event listeners and, [Interaction via Event\nListeners](part0013_split_002.html#I_indexterm9_id307513)\n\n>\n\n>> overview of, [Recap](part0013_split_004.html#I_indexterm9_id312209)\n\n>\n\n>> removing values/elements, [Removing Values (and\nElements)](part0013_split_004.html#ix_uprem)–[Making a smooth\nexit](part0013_split_004.html#I_indexterm9_id311280)\n\n>\n\n>> to bar chart, [Modernizing the Bar\nChart](part0013_split_001.html#ix_ubcht)–[Other\nUpdates](part0013_split_001.html#I_indexterm9_id307373)\n\n>\n\n>> URLs (Uniform Resource Locators), [The\nWeb](part0007_split_001.html#I_indexterm3_id288713)\n\n> ### V\n\nvalue changes, animating,\n[Transitions](part0013_split_003.html#I_indexterm9_id308084)\n\n> values\n\n> adding, [Adding Values (and\n> Elements)](part0013_split_004.html#I_indexterm9_id310347)\n>\n\n>> in CSS, [Properties and\nValues](part0007_split_006.html#I_indexterm3_id291091)\n\n>\n\n>> in objects, [Objects](part0007_split_007.html#I_indexterm3_id292201)\n\n>\n\n>> variable hoisting, [Variable\nhoisting](part0007_split_007.html#I_indexterm3_id293425)\n\n> variable scope, [Function-level\n> scope](part0007_split_007.html#I_indexterm3_id293515)\n\n> variables, [Hello, Console](part0007_split_007.html#I_indexterm3_id291799),\n> [JavaScript Gotchas](part0007_split_007.html#I_indexterm3_id293259), [Global\n> namespace](part0007_split_007.html#I_indexterm3_id293765), [Create the\n> SVG](part0010_split_003.html#I_indexterm6_id300315)\n\n> vector data, [Choose a\n> Resolution](part0016_split_006.html#I_indexterm12_id318983)\n\n> vertical axis, [Y Not?](part0012_split_005.html#I_indexterm8_id306106)\n\n> visual rules, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290558)\n\n> visual structure, [Content Plus\n> Structure](part0007_split_002.html#I_indexterm3_id289124)\n\n> visualization, definition of, [Why Data\n> Visualization?](part0005_split_001.html#I_indexterm1_id286312)\n\n> ### W\n\nweb development tools, [Developer\nTools](part0007_split_004.html#ix_webtool)–[Developer\nTools](part0007_split_004.html#I_indexterm3_id290524)\n\n> Web fundamentals, [The Web](part0007_split_001.html#I_indexterm3_id288530),\n> [The Web](part0007_split_001.html#I_indexterm3_id288853)\n\n> web inspector, [Rendering and the Box\n> Model](part0007_split_005.html#I_indexterm3_id290596)\n\n> Web servers\n\n> operation of, [The Web](part0007_split_001.html#I_indexterm3_id288605)\n>\n\n>> setting up, [Setting Up a Web\nServer](part0008_split_003.html#I_indexterm4_id295864)\n\n>\n\n>> web-standard technologies, benefits of, [Why on the\nWeb?](part0005_split_004.html#I_indexterm1_id286524)\n\n> whitespace, adding, [Round Bands Are All the Range These\n> Days](part0013_split_001.html#I_indexterm9_id307194)\n\n> (see also padding)\n>\n\n>>\n\n\n## About the Author\n\nScott Murray is a code artist who writes software to create data\nvisualizations and other interactive phenomena. His work incorporates elements\nof interaction design, systems design, and generative art.  \n  \nScott is an Assistant Professor of Design at the University of San Francisco,\nwhere he teaches data visualization and interaction design. He is a\ncontributor to Processing (processing.org), and he teaches workshops on\ncreative coding.  \n  \nScott earned an A.B. from Vassar College and an M.F.A. from the Dynamic Media\nInstitute at the Massachusetts College of Art and Design. His work can be seen\nat alignedleft.com.\n\n\n## Colophon\n\nThe animal on the cover of _Interactive Data Visualization for the Web_ is a\nlong-tail tit or bushtit (_Aegithalos caudatus_). The bushtit is a common\nspecies of bird found throughout Europe and Asia. The caudatus group of the\nspecies has a pure white head.\n\nThese birds are known for their tiny size, measuring at around only 13-15 cm\nin length, including their tail. The long-tail tit is recognized by its stubby\nbill, contrasted to its long, narrow tail. Females and males are\nindistinguishable, both undergoing a full moult before their first winter.\nTheir adult plumage is primarily black and white with accents of grey and\npink.\n\nThe bushtit inhabits deciduous and mixed woodland, feeding on insects with a\npreference for eggs and larvae of moths and butterflies, and favoring oak,\nash, and sycamore trees. They tend to nest in scrub areas usually closer to\nthe ground.\n\nThe cover image is from a loose plate of Hungarian origin. The cover font is\nAdobe ITC Garamond. The text font is Adobe Minion Pro; the heading font is\nAdobe Myriad Condensed; and the code font is Dalton Maag’s Ubuntu Mono.\n\n\n## Special Upgrade Offer\n\nIf you purchased this ebook from a retailer other than O’Reilly, you can\nupgrade it for $4.99 at oreilly.com by [clicking\nhere](http://opds.oreilly.com/buy/9781449339722.EBOOK?source=kindle).\n\n\n##\n\n# Interactive Data Visualization for the Web\n\n###  Scott Murray\n\n#### Editor\n\n###  Meghan Blanchette\n\n**Revision History**  \n---  \n2013-03-04 | First release  \n  \nCopyright © 2013 Scott Murray\n\nO’Reilly books may be purchased for educational, business, or sales\npromotional use. Online editions are also available for most titles\n([http://my.safaribooksonline.com](http://my.safaribooksonline.com/?portal=oreilly)).\nFor more information, contact our corporate/institutional sales department:\n800-998-9938 or [corporate@oreilly.com](mailto:corporate@oreilly.com).\n\nNutshell Handbook, the Nutshell Handbook logo, the cover image, and the\nO’Reilly logo are registered trademarks of O’Reilly Media, Inc. _Interactive\nData Visualization for the Web_ , the cover image of a long-tail bushtit, and\nrelated trade dress are trademarks of O’Reilly Media, Inc.\n\nMany of the designations used by manufacturers and sellers to distinguish\ntheir products are claimed as trademarks. Where those designations appear in\nthis book, and O’Reilly Media, Inc., was aware of a trademark claim, the\ndesignations have been printed in caps or initial caps.\n\nWhile every precaution has been taken in the preparation of this book, the\npublisher and author assume no responsibility for errors or omissions, or for\ndamages resulting from the use of the information contained herein.\n\nO’Reilly Media  \n\n1005 Gravenstein Highway North\n\nSebastopol, CA 95472\n\n2013-05-01T20:15:32-07:00\n\n\n# Interactive Data Visualization for the Web\n\nTable of Contents\n\n> [Special Upgrade Offer](part0002.html#front_of_book_promo)\n\n> [A Note Regarding Supplemental Files](part0003.html#id804761)\n\n> [Preface](part0004_split_000.html#3Q282-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Conventions Used in This\nBook](part0004_split_001.html#_conventions_used_in_this_book)\n\n>\n\n>> [Using Code Examples](part0004_split_002.html#_using_code_examples)\n\n>\n\n>> [Safari® Books Online](part0004_split_003.html#_safari_books_online)\n\n>\n\n>> [How to Contact Us](part0004_split_004.html#_how_to_contact_us)\n\n>\n\n>> [Acknowledgments](part0004_split_005.html#_acknowledgments)\n\n> [1\\.\n> Introduction](part0005_split_000.html#4OIQ2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Why Data Visualization?](part0005_split_001.html#_why_data_visualization)\n\n>\n\n>> [Why Write Code?](part0005_split_002.html#_why_write_code)\n\n>\n\n>> [Why Interactive?](part0005_split_003.html#_why_interactive)\n\n>\n\n>> [Why on the Web?](part0005_split_004.html#_why_on_the_web)\n\n>\n\n>> [What This Book Is](part0005_split_005.html#_what_this_book_is)\n\n>\n\n>> [Who You Are](part0005_split_006.html#_who_you_are)\n\n>\n\n>> [What This Book Is Not](part0005_split_007.html#_what_this_book_is_not)\n\n>\n\n>> [Using Sample Code](part0005_split_008.html#_using_sample_code)\n\n>\n\n>> [Thank You](part0005_split_009.html#_thank_you)\n\n> [2\\. Introducing\n> D3](part0006_split_000.html#5N3C2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [What It Does](part0006_split_001.html#_what_it_does)\n\n>\n\n>> [What It Doesn’t Do](part0006_split_002.html#_what_it_doesn_t_do)\n\n>\n\n>> [Origins and Context](part0006_split_003.html#_origins_and_context)\n\n>\n\n>> [Alternatives](part0006_split_004.html#alternatives_2)\n\n>>\n\n>>> [Easy Charts](part0006_split_004.html#_easy_charts)\n\n>>\n\n>>> [Graph Visualizations](part0006_split_004.html#_graph_visualizations)\n\n>>\n\n>>> [Geomapping](part0006_split_004.html#_geomapping)\n\n>>\n\n>>> [Almost from Scratch](part0006_split_004.html#_almost_from_scratch)\n\n>>\n\n>>> [Three-Dimensional](part0006_split_004.html#_three_dimensional)\n\n>>\n\n>>> [Tools Built with D3](part0006_split_004.html#_tools_built_with_d3)\n\n> [3\\. Technology\n> Fundamentals](part0007_split_000.html#6LJU2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [The Web](part0007_split_001.html#_the_web)\n\n>\n\n>> [HTML](part0007_split_002.html#_html)\n\n>>\n\n>>> [Content Plus Structure](part0007_split_002.html#_content_plus_structure)\n\n>>\n\n>>> [Adding Structure with\nElements](part0007_split_002.html#_adding_structure_with_elements)\n\n>>\n\n>>> [Common Elements](part0007_split_002.html#_common_elements)\n\n>>\n\n>>> [Attributes](part0007_split_002.html#_attributes)\n\n>>\n\n>>> [Classes and IDs](part0007_split_002.html#_classes_and_ids)\n\n>>\n\n>>> [Comments](part0007_split_002.html#_comments)\n\n>\n\n>> [DOM](part0007_split_003.html#_dom)\n\n>\n\n>> [Developer Tools](part0007_split_004.html#developer_tools_3)\n\n>\n\n>> [Rendering and the Box\nModel](part0007_split_005.html#_rendering_and_the_box_model)\n\n>\n\n>> [CSS](part0007_split_006.html#_css)\n\n>>\n\n>>> [Selectors](part0007_split_006.html#_selectors)\n\n>>\n\n>>> [Properties and Values](part0007_split_006.html#_properties_and_values)\n\n>>\n\n>>> [Comments](part0007_split_006.html#_comments_2)\n\n>>\n\n>>> [Referencing Styles](part0007_split_006.html#_referencing_styles)\n\n>>>\n\n>>>> [Embed the CSS in your\nHTML.](part0007_split_006.html#_embed_the_css_in_your_html)\n\n>>>\n\n>>>> [Reference an external stylesheet from the\nHTML.](part0007_split_006.html#_reference_an_external_stylesheet_from_the_html)\n\n>>>\n\n>>>> [Attach inline styles.](part0007_split_006.html#_attach_inline_styles)\n\n>>\n\n>>> [Inheritance, Cascading, and\nSpecificity](part0007_split_006.html#_inheritance_cascading_and_specificity)\n\n>\n\n>> [JavaScript](part0007_split_007.html#_javascript)\n\n>>\n\n>>> [Hello, Console](part0007_split_007.html#_hello_console)\n\n>>\n\n>>> [Variables](part0007_split_007.html#_variables)\n\n>>\n\n>>> [Other Variable Types](part0007_split_007.html#_other_variable_types)\n\n>>\n\n>>> [Arrays](part0007_split_007.html#_arrays)\n\n>>\n\n>>> [Objects](part0007_split_007.html#_objects)\n\n>>\n\n>>> [Objects and Arrays](part0007_split_007.html#_objects_and_arrays)\n\n>>>\n\n>>>> [JSON](part0007_split_007.html#_json)\n\n>>>\n\n>>>> [GeoJSON](part0007_split_007.html#_geojson)\n\n>>\n\n>>> [Mathematical Operators](part0007_split_007.html#_mathematical_operators)\n\n>>\n\n>>> [Comparison Operators](part0007_split_007.html#_comparison_operators)\n\n>>\n\n>>> [Control Structures](part0007_split_007.html#_control_structures)\n\n>>>\n\n>>>> [if() only](part0007_split_007.html#_if_only)\n\n>>>\n\n>>>> [for() now](part0007_split_007.html#_for_now)\n\n>>>\n\n>>>> [What arrays are made\nfor()](part0007_split_007.html#_what_arrays_are_made_for)\n\n>>\n\n>>> [Functions](part0007_split_007.html#_functions)\n\n>>\n\n>>> [Comments](part0007_split_007.html#_comments_3)\n\n>>\n\n>>> [Referencing Scripts](part0007_split_007.html#_referencing_scripts)\n\n>>\n\n>>> [JavaScript Gotchas](part0007_split_007.html#_javascript_gotchas)\n\n>>>\n\n>>>> [Dynamic typing](part0007_split_007.html#_dynamic_typing)\n\n>>>\n\n>>>> [Variable hoisting](part0007_split_007.html#_variable_hoisting)\n\n>>>\n\n>>>> [Function-level scope](part0007_split_007.html#_function_level_scope)\n\n>>>\n\n>>>> [Global namespace](part0007_split_007.html#_global_namespace)\n\n>\n\n>> [SVG](part0007_split_008.html#SVG_3)\n\n>>\n\n>>> [The SVG Element](part0007_split_008.html#_the_svg_element)\n\n>>\n\n>>> [Simple Shapes](part0007_split_008.html#_simple_shapes)\n\n>>\n\n>>> [Styling SVG Elements](part0007_split_008.html#_styling_svg_elements)\n\n>>\n\n>>> [Layering and Drawing\nOrder](part0007_split_008.html#_layering_and_drawing_order)\n\n>>\n\n>>> [Transparency](part0007_split_008.html#_transparency)\n\n>\n\n>> [A Note on Compatibility](part0007_split_009.html#_a_note_on_compatibility)\n\n> [4\\. Setup](part0008_split_000.html#setup-chapter4)\n>\n\n>> [Downloading D3](part0008_split_001.html#_downloading_d3)\n\n>\n\n>> [Referencing D3](part0008_split_002.html#_referencing_d3)\n\n>\n\n>> [Setting Up a Web Server](part0008_split_003.html#_setting_up_a_web_server)\n\n>>\n\n>>> [Terminal with Python](part0008_split_003.html#_terminal_with_python)\n\n>>\n\n>>> [MAMP, WAMP, and LAMP](part0008_split_003.html#_mamp_wamp_and_lamp)\n\n>>\n\n>>> [Diving In](part0008_split_003.html#_diving_in)\n\n> [5\\. Data](part0009_split_000.html#8IL22-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Generating Page\nElements](part0009_split_001.html#_generating_page_elements)\n\n>>\n\n>>> [Chaining Methods](part0009_split_001.html#_chaining_methods)\n\n>>\n\n>>> [One Link at a Time](part0009_split_001.html#_one_link_at_a_time)\n\n>>\n\n>>> [The Hand-off](part0009_split_001.html#_the_hand_off)\n\n>>\n\n>>> [Going Chainless](part0009_split_001.html#_going_chainless)\n\n>\n\n>> [Binding Data](part0009_split_002.html#_binding_data)\n\n>>\n\n>>> [In a Bind](part0009_split_002.html#_in_a_bind)\n\n>>\n\n>>> [Data](part0009_split_002.html#_data)\n\n>>>\n\n>>>> [Loading CSV data](part0009_split_002.html#_loading_csv_data)\n\n>>>\n\n>>>> [Loading JSON data](part0009_split_002.html#_loading_json_data)\n\n>>\n\n>>> [Please Make Your\nSelection](part0009_split_002.html#please_make_your_selection_5)\n\n>>\n\n>>> [Bound and Determined](part0009_split_002.html#_bound_and_determined)\n\n>>\n\n>>> [Using Your Data](part0009_split_002.html#_using_your_data)\n\n>>\n\n>>> [High-Functioning](part0009_split_002.html#_high_functioning)\n\n>>\n\n>>> [Data Wants to Be Held](part0009_split_002.html#_data_wants_to_be_held)\n\n>>\n\n>>> [Beyond Text](part0009_split_002.html#_beyond_text)\n\n> [6\\. Drawing with\n> Data](part0010_split_000.html#9H5K2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Drawing divs](part0010_split_001.html#_drawing_divs)\n\n>>\n\n>>> [Setting Attributes](part0010_split_001.html#_setting_attributes)\n\n>>\n\n>>> [A Note on Classes](part0010_split_001.html#_a_note_on_classes)\n\n>>\n\n>>> [Back to the Bars](part0010_split_001.html#_back_to_the_bars)\n\n>>\n\n>>> [Setting Styles](part0010_split_001.html#_setting_styles)\n\n>\n\n>> [The Power of data()](part0010_split_002.html#_the_power_of_data)\n\n>>\n\n>>> [Random Data](part0010_split_002.html#_random_data)\n\n>\n\n>> [Drawing SVGs](part0010_split_003.html#_drawing_svgs)\n\n>>\n\n>>> [Create the SVG](part0010_split_003.html#_create_the_svg)\n\n>>\n\n>>> [Data-Driven Shapes](part0010_split_003.html#_data_driven_shapes)\n\n>>\n\n>>> [Pretty Colors, Oooh!](part0010_split_003.html#_pretty_colors_oooh)\n\n>\n\n>> [Making a Bar Chart](part0010_split_004.html#_making_a_bar_chart)\n\n>>\n\n>>> [The Old Chart](part0010_split_004.html#_the_old_chart)\n\n>>\n\n>>> [The New Chart](part0010_split_004.html#_the_new_chart)\n\n>>\n\n>>> [Color](part0010_split_004.html#_color)\n\n>>\n\n>>> [Labels](part0010_split_004.html#_labels)\n\n>\n\n>> [Making a Scatterplot](part0010_split_005.html#_making_a_scatterplot)\n\n>>\n\n>>> [The Data](part0010_split_005.html#_the_data)\n\n>>\n\n>>> [The Scatterplot](part0010_split_005.html#_the_scatterplot)\n\n>>\n\n>>> [Size](part0010_split_005.html#_size)\n\n>>\n\n>>> [Labels](part0010_split_005.html#_labels_2)\n\n>\n\n>> [Next Steps](part0010_split_006.html#_next_steps)\n\n> [7\\. Scales](part0011_split_000.html#AFM62-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Apples and Pixels](part0011_split_001.html#_apples_and_pixels)\n\n>\n\n>> [Domains and Ranges](part0011_split_002.html#_domains_and_ranges)\n\n>\n\n>> [Normalization](part0011_split_003.html#_normalization)\n\n>\n\n>> [Creating a Scale](part0011_split_004.html#_creating_a_scale)\n\n>\n\n>> [Scaling the Scatterplot](part0011_split_005.html#_scaling_the_scatterplot)\n\n>>\n\n>>> [d3.min() and d3.max()](part0011_split_005.html#_d3_min_and_d3_max)\n\n>>\n\n>>> [Setting Up Dynamic\nScales](part0011_split_005.html#_setting_up_dynamic_scales)\n\n>>\n\n>>> [Incorporating Scaled\nValues](part0011_split_005.html#_incorporating_scaled_values)\n\n>\n\n>> [Refining the Plot](part0011_split_006.html#_refining_the_plot)\n\n>\n\n>> [Other Methods](part0011_split_007.html#_other_methods)\n\n>\n\n>> [Other Scales](part0011_split_008.html#_other_scales)\n\n> [8\\. Axes](part0012_split_000.html#BE6O2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Introducing Axes](part0012_split_001.html#_introducing_axes)\n\n>\n\n>> [Setting Up an Axis](part0012_split_002.html#_setting_up_an_axis)\n\n>\n\n>> [Cleaning It Up](part0012_split_003.html#_cleaning_it_up)\n\n>\n\n>> [Check for Ticks](part0012_split_004.html#_check_for_ticks)\n\n>\n\n>> [Y Not?](part0012_split_005.html#_y_not)\n\n>\n\n>> [Final Touches](part0012_split_006.html#_final_touches)\n\n>\n\n>> [Formatting Tick Labels](part0012_split_007.html#_formatting_tick_labels)\n\n> [9\\. Updates, Transitions, and\n> Motion](part0013_split_000.html#CCNA2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Modernizing the Bar\nChart](part0013_split_001.html#_modernizing_the_bar_chart)\n\n>>\n\n>>> [Ordinal Scales,\nExplained](part0013_split_001.html#_ordinal_scales_explained)\n\n>>\n\n>>> [Round Bands Are All the Range These\nDays](part0013_split_001.html#_round_bands_are_all_the_range_these_days)\n\n>>\n\n>>> [Referencing the Ordinal\nScale](part0013_split_001.html#_referencing_the_ordinal_scale)\n\n>>\n\n>>> [Other Updates](part0013_split_001.html#_other_updates)\n\n>\n\n>> [Updating Data](part0013_split_002.html#_updating_data)\n\n>>\n\n>>> [Interaction via Event\nListeners](part0013_split_002.html#_interaction_via_event_listeners)\n\n>>\n\n>>> [Changing the Data](part0013_split_002.html#_changing_the_data)\n\n>>\n\n>>> [Updating the Visuals](part0013_split_002.html#_updating_the_visuals)\n\n>\n\n>> [Transitions](part0013_split_003.html#_transitions)\n\n>>\n\n>>> [duration(), or How Long Is This Going to\nTake?](part0013_split_003.html#_duration_or_how_long_is_this_going_to_take)\n\n>>\n\n>>> [ease()-y Does It](part0013_split_003.html#_ease_y_does_it)\n\n>>\n\n>>> [Please Do Not delay()](part0013_split_003.html#_please_do_not_delay)\n\n>>\n\n>>> [Randomizing the Data](part0013_split_003.html#_randomizing_the_data)\n\n>>\n\n>>> [Updating Scales](part0013_split_003.html#_updating_scales)\n\n>>\n\n>>> [Updating Axes](part0013_split_003.html#_updating_axes)\n\n>>\n\n>>> [each() Transition Starts and\nEnds](part0013_split_003.html#_each_transition_starts_and_ends)\n\n>>>\n\n>>>> [Warning: Start\ncarefully](part0013_split_003.html#_warning_start_carefully)\n\n>>>\n\n>>>> [End gracefully](part0013_split_003.html#_end_gracefully)\n\n>>>\n\n>>>> [Transitionless each()](part0013_split_003.html#_transitionless_each)\n\n>>>\n\n>>>> [Containing visual elements with clipping\npaths](part0013_split_003.html#_containing_visual_elements_with_clipping_paths)\n\n>\n\n>> [Other Kinds of Data\nUpdates](part0013_split_004.html#_other_kinds_of_data_updates)\n\n>>\n\n>>> [Adding Values (and\nElements)](part0013_split_004.html#_adding_values_and_elements)\n\n>>>\n\n>>>> [Select](part0013_split_004.html#_select)\n\n>>>\n\n>>>> [Enter](part0013_split_004.html#_enter)\n\n>>>\n\n>>>> [Update](part0013_split_004.html#_update)\n\n>>\n\n>>> [Removing Values (and\nElements)](part0013_split_004.html#_removing_values_and_elements)\n\n>>>\n\n>>>> [Exit](part0013_split_004.html#_exit)\n\n>>>\n\n>>>> [Making a smooth exit](part0013_split_004.html#_making_a_smooth_exit)\n\n>>\n\n>>> [Data Joins with Keys](part0013_split_004.html#_data_joins_with_keys)\n\n>>>\n\n>>>> [Preparing the data](part0013_split_004.html#_preparing_the_data)\n\n>>>\n\n>>>> [Updating all\nreferences](part0013_split_004.html#_updating_all_references)\n\n>>>\n\n>>>> [Key functions](part0013_split_004.html#_key_functions)\n\n>>>\n\n>>>> [Exit transition](part0013_split_004.html#_exit_transition)\n\n>>\n\n>>> [Add and Remove: Combo\nPlatter](part0013_split_004.html#_add_and_remove_combo_platter)\n\n>>\n\n>>> [Recap](part0013_split_004.html#_recap)\n\n> [10\\.\n> Interactivity](part0014_split_000.html#DB7S2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Binding Event Listeners](part0014_split_001.html#_binding_event_listeners)\n\n>\n\n>> [Introducing Behaviors](part0014_split_002.html#_introducing_behaviors)\n\n>>\n\n>>> [Hover to Highlight](part0014_split_002.html#_hover_to_highlight)\n\n>\n\n>> [Grouping SVG Elements](part0014_split_003.html#_grouping_svg_elements)\n\n>>\n\n>>> [Click to Sort](part0014_split_003.html#_click_to_sort)\n\n>\n\n>> [Tooltips](part0014_split_004.html#_tooltips)\n\n>>\n\n>>> [Default Browser\nTooltips](part0014_split_004.html#_default_browser_tooltips)\n\n>>\n\n>>> [SVG Element Tooltips](part0014_split_004.html#_svg_element_tooltips)\n\n>>\n\n>>> [HTML div Tooltips](part0014_split_004.html#_html_div_tooltips)\n\n>\n\n>> [Consideration for Touch\nDevices](part0014_split_005.html#_consideration_for_touch_devices)\n\n>\n\n>> [Moving Forward](part0014_split_006.html#_moving_forward)\n\n> [11\\.\n> Layouts](part0015_split_000.html#E9OE2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Pie Layout](part0015_split_001.html#_pie_layout)\n\n>\n\n>> [Stack Layout](part0015_split_002.html#_stack_layout)\n\n>\n\n>> [Force Layout](part0015_split_003.html#_force_layout)\n\n> [12\\.\n> Geomapping](part0016_split_000.html#F8902-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [JSON, Meet GeoJSON](part0016_split_001.html#_json_meet_geojson)\n\n>\n\n>> [Paths](part0016_split_002.html#_paths)\n\n>\n\n>> [Projections](part0016_split_003.html#_projections)\n\n>\n\n>> [Choropleth](part0016_split_004.html#_choropleth)\n\n>\n\n>> [Adding Points](part0016_split_005.html#_adding_points)\n\n>\n\n>> [Acquiring and Parsing\nGeodata](part0016_split_006.html#_acquiring_and_parsing_geodata)\n\n>>\n\n>>> [Find Shapefiles](part0016_split_006.html#_find_shapefiles)\n\n>>\n\n>>> [Choose a Resolution](part0016_split_006.html#_choose_a_resolution)\n\n>>\n\n>>> [Simplify the Shapes](part0016_split_006.html#_simplify_the_shapes)\n\n>>\n\n>>> [Convert to GeoJSON](part0016_split_006.html#_convert_to_geojson)\n\n> [13\\.\n> Exporting](part0017_split_000.html#G6PI2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Bitmaps](part0017_split_001.html#_bitmaps)\n\n>\n\n>> [PDF](part0017_split_002.html#_pdf)\n\n>\n\n>> [SVG](part0017_split_003.html#_svg)\n\n> [A. Appendix: Further\n> Study](part0018_split_000.html#H5A42-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n>\n\n>> [Books](part0018_split_001.html#_books)\n\n>\n\n>> [Websites](part0018_split_002.html#_websites)\n\n>\n\n>> [Twitterers](part0018_split_003.html#_twitterers)\n\n> [Index](part0019.html#I3QM2-8a8b0c18aaaf4f5c9d772f6d0c5087fc)\n\n> [About the Author](part0020.html#id940801)\n\n> [Colophon](part0021.html#_colophon)\n\n> [Special Upgrade Offer](part0022.html#back_of_book_promo)\n\n> [Copyright](part0023.html#copyright_page_orm)\n\n\n\n\n",
    "book_id": "interactive_data_visualization_for_the_web",
    "book_title": "Interactive Data Visualization for the Web",
    "book_author": "Scott Murray",
    "topic_id": "design_data_visualization",
    "topic_label": "data visualization",
    "chunk_index": 4
  },
  {
    "chunk_full": "![D3 Tips and Tricks v4.x](images/title_page.png)\n\n\n## D3 Tips and Tricks v4.x\n\n### Interactive Data Visualization in a Web Browser\n\n#### Malcolm Maclean\n\nThis book is for sale at <http://leanpub.com/d3-t-and-t-v4>\n\nThis version was published on 2017-04-12\n\n![publisher's logo](images/leanpub-logo.png)\n\n* * * * *\n\nThis is a [Leanpub](http://leanpub.com) book. Leanpub empowers authors and\npublishers with the Lean Publishing process. [Lean\nPublishing](http://leanpub.com/manifesto) is the act of publishing an in-\nprogress ebook using lightweight tools and many iterations to get reader\nfeedback, pivot until you have the right book and build traction once you do.\n\n* * * * *\n\n© 2016 - 2017 Malcolm Maclean\n\n\n## Table of Contents\n\n  1. [Acknowledgements](chap00.xhtml#leanpub-auto-acknowledgements)\n     1. [Mike](chap00.xhtml#leanpub-auto-mike)\n     2. [Partners, Supporters and Contributors.](chap00.xhtml#leanpub-auto-partners-supporters-and-contributors)\n     3. [Proof Reading](chap00.xhtml#leanpub-auto-proof-reading)\n     4. [The d3.js Community](chap00.xhtml#leanpub-auto-the-d3js-community)\n     5. [Cover art](chap00.xhtml#leanpub-auto-cover-art)\n     6. [Leanpub](chap00.xhtml#leanpub-auto-leanpub)\n     7. [Make sure you get the most up to date copy of D3 Tips and Tricks](chap00.xhtml#leanpub-auto-make-sure-you-get-the-most-up-to-date-copy-of-d3-tips-and-tricks)\n  2. [What is d3.js?](chap01.xhtml#leanpub-auto-what-is-d3js)\n  3. [Introduction](chap02.xhtml#leanpub-auto-introduction)\n  4. [What do we need to get started?](chap03.xhtml#leanpub-auto-what-do-we-need-to-get-started)\n     1. [HTML](chap03.xhtml#leanpub-auto-html)\n     2. [JavaScript](chap03.xhtml#leanpub-auto-javascript)\n     3. [Cascading Style Sheets (CSS)](chap03.xhtml#leanpub-auto-cascading-style-sheets-css)\n     4. [Web Servers](chap03.xhtml#leanpub-auto-web-servers)\n     5. [PHP](chap03.xhtml#leanpub-auto-php)\n     6. [Other Useful Stuff](chap03.xhtml#leanpub-auto-other-useful-stuff)\n        1. [Text Editor](chap03.xhtml#leanpub-auto-text-editor)\n        2. [Getting D3](chap03.xhtml#leanpub-auto-getting-d3)\n           1. [Host d3.js locally](chap03.xhtml#leanpub-auto-host-d3js-locally)\n           2. [Use a remote CDN to always use the latest version of d3.js](chap03.xhtml#leanpub-auto-use-a-remote-cdn-to-always-use-the-latest-version-of-d3js)\n           3. [Potential directory structure](chap03.xhtml#leanpub-auto-potential-directory-structure)\n        3. [Where to get information on d3.js](chap03.xhtml#leanpub-auto-where-to-get-information-on-d3js)\n           1. [d3js.org](chap03.xhtml#leanpub-auto-d3jsorg)\n           2. [Google Groups](chap03.xhtml#leanpub-auto-google-groups)\n           3. [Stack Overflow](chap03.xhtml#leanpub-auto-stack-overflow)\n           4. [Github](chap03.xhtml#leanpub-auto-github)\n           5. [bl.ocks.org](chap03.xhtml#leanpub-auto-blocksorg)\n           6. [Twitter](chap03.xhtml#leanpub-auto-twitter)\n           7. [Books](chap03.xhtml#leanpub-auto-books)\n  5. [Starting with a simple graph](chap04.xhtml#simplegraph)\n     1. [HTML](chap04.xhtml#html)\n     2. [Cascading Style Sheets (CSS)](chap04.xhtml#css)\n     3. [D3 JavaScript](chap04.xhtml#javascript)\n        1. [Setting up the margins and the graph area.](chap04.xhtml#leanpub-auto-setting-up-the-margins-and-the-graph-area)\n        2. [Getting the Data](chap04.xhtml#leanpub-auto-getting-the-data)\n        3. [Formatting the Date / Time.](chap04.xhtml#leanpub-auto-formatting-the-date--time)\n        4. [Setting Scales Domains and Ranges](chap04.xhtml#leanpub-auto-setting-scales-domains-and-ranges)\n        5. [Adding data to the line function](chap04.xhtml#leanpub-auto-adding-data-to-the-line-function)\n        6. [Adding the SVG element.](chap04.xhtml#leanpub-auto-adding-the-svg-element)\n        7. [Actually Drawing Something!](chap04.xhtml#leanpub-auto-actually-drawing-something)\n           1. [Drawing the line](chap04.xhtml#leanpub-auto-drawing-the-line)\n           2. [Drawing the Axes](chap04.xhtml#leanpub-auto-drawing-the-axes)\n     4. [Wrap Up](chap04.xhtml#leanpub-auto-wrap-up)\n  6. [Things we can do with the simple graph](chap05.xhtml#leanpub-auto-things-we-can-do-with-the-simple-graph)\n     1. [Setting up and configuring the Axes](chap05.xhtml#axes)\n        1. [Change the text size](chap05.xhtml#leanpub-auto-change-the-text-size)\n        2. [Changing the number of ticks on an axis](chap05.xhtml#leanpub-auto-changing-the-number-of-ticks-on-an-axis)\n        3. [Rotating text labels for a graph axis](chap05.xhtml#leanpub-auto-rotating-text-labels-for-a-graph-axis)\n        4. [Formatting a date / time axis with specified values](chap05.xhtml#leanpub-auto-formatting-a-date--time-axis-with-specified-values)\n     2. [Adding Axis Labels](chap05.xhtml#axislabels)\n        1. [The x axis label](chap05.xhtml#leanpub-auto-the-x-axis-label)\n        2. [The y axis label](chap05.xhtml#leanpub-auto-the-y-axis-label)\n     3. [How to add a title to your graph](chap05.xhtml#title)\n     4. [Change a line chart into a scatter plot](chap05.xhtml#leanpub-auto-change-a-line-chart-into-a-scatter-plot)\n     5. [Smoothing out graph lines](chap05.xhtml#smoothing)\n     6. [Make a dashed line](chap05.xhtml#leanpub-auto-make-a-dashed-line)\n     7. [Filling an area under the graph](chap05.xhtml#leanpub-auto-filling-an-area-under-the-graph)\n        1. [CSS for an area fill](chap05.xhtml#leanpub-auto-css-for-an-area-fill)\n        2. [Define the area function](chap05.xhtml#leanpub-auto-define-the-area-function)\n        3. [Draw the area](chap05.xhtml#leanpub-auto-draw-the-area)\n        4. [Filling an area above the line](chap05.xhtml#leanpub-auto-filling-an-area-above-the-line)\n     8. [Adding a drop shadow to allow text to stand out on graphics.](chap05.xhtml#leanpub-auto-adding-a-drop-shadow-to-allow-text-to-stand-out-on-graphics)\n        1. [CSS for white shadowy background](chap05.xhtml#leanpub-auto-css-for-white-shadowy-background)\n        2. [Drawing the white shadowy background.](chap05.xhtml#leanpub-auto-drawing-the-white-shadowy-background)\n     9. [Adding grid lines to a graph](chap05.xhtml#leanpub-auto-adding-grid-lines-to-a-graph)\n        1. [The grid line CSS](chap05.xhtml#leanpub-auto-the-grid-line-css)\n        2. [Define the grid line functions](chap05.xhtml#leanpub-auto-define-the-grid-line-functions)\n        3. [Draw the lines](chap05.xhtml#leanpub-auto-draw-the-lines)\n     10. [Adding more than one line to a graph](chap05.xhtml#leanpub-auto-adding-more-than-one-line-to-a-graph)\n     11. [Labelling multiple lines on a graph](chap05.xhtml#leanpub-auto-labelling-multiple-lines-on-a-graph)\n     12. [Multiple axes for a graph](chap05.xhtml#leanpub-auto-multiple-axes-for-a-graph)\n  7. [Elements, Attributes and Styles](chap06.xhtml#leanpub-auto-elements-attributes-and-styles)\n     1. [The Framework](chap06.xhtml#EASframework)\n     2. [Elements](chap06.xhtml#elements)\n        1. [Circle](chap06.xhtml#circle)\n        2. [Ellipse](chap06.xhtml#leanpub-auto-ellipse)\n        3. [Rectangle](chap06.xhtml#leanpub-auto-rectangle)\n        4. [Line](chap06.xhtml#leanpub-auto-line)\n        5. [Polyline](chap06.xhtml#leanpub-auto-polyline)\n        6. [Polygon](chap06.xhtml#leanpub-auto-polygon)\n        7. [Path](chap06.xhtml#leanpub-auto-path)\n        8. [Clipped Path (AKA clipPath)](chap06.xhtml#clipPath)\n        9. [Text](chap06.xhtml#leanpub-auto-text)\n           1. [Anchor at the bottom, middle of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-bottom-middle-of-the-text)\n           2. [Anchor at the bottom, right of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-bottom-right-of-the-text)\n           3. [Anchor at the middle, left of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-middle-left-of-the-text)\n           4. [Anchor in the middle, centre of the text:](chap06.xhtml#leanpub-auto-anchor-in-the-middle-centre-of-the-text)\n           5. [Anchor in the middle, right of the text:](chap06.xhtml#leanpub-auto-anchor-in-the-middle-right-of-the-text)\n           6. [Anchor at the top, left of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-top-left-of-the-text)\n           7. [Anchor at the top, middle of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-top-middle-of-the-text)\n           8. [Anchor at the top, right of the text:](chap06.xhtml#leanpub-auto-anchor-at-the-top-right-of-the-text)\n     3. [Attributes](chap06.xhtml#leanpub-auto-attributes)\n        1. [`x`, `y`](chap06.xhtml#leanpub-auto-x-y)\n        2. [`x1`, `x2`, `y1`, `y2`](chap06.xhtml#leanpub-auto-x1-x2-y1-y2)\n        3. [points](chap06.xhtml#leanpub-auto-points)\n        4. [`cx`, `cy`](chap06.xhtml#leanpub-auto-cx-cy)\n        5. [`r`](chap06.xhtml#leanpub-auto-r)\n        6. [`rx`, `ry`](chap06.xhtml#leanpub-auto-rx-ry)\n        7. [`transform (translate(x,y), scale(k), rotate(a))`](chap06.xhtml#leanpub-auto-transform-translatexy-scalek-rotatea)\n           1. [`transform (translate(x,y))`](chap06.xhtml#leanpub-auto-transform-translatexy)\n           2. [`transform (scale(k))`](chap06.xhtml#leanpub-auto-transform-scalek)\n           3. [`transform (rotate(a))`](chap06.xhtml#leanpub-auto-transform-rotatea)\n        8. [`width`, `height`](chap06.xhtml#leanpub-auto-width-height)\n        9. [`text-anchor`](chap06.xhtml#leanpub-auto-text-anchor)\n        10. [`dx`, `dy`](chap06.xhtml#leanpub-auto-dx-dy)\n        11. [`textLength`](chap06.xhtml#leanpub-auto-textlength)\n        12. [`lengthAdjust`](chap06.xhtml#leanpub-auto-lengthadjust)\n     4. [Styles](chap06.xhtml#leanpub-auto-styles)\n        1. [`fill`](chap06.xhtml#leanpub-auto-fill)\n        2. [`stroke`](chap06.xhtml#leanpub-auto-stroke)\n        3. [`opacity`](chap06.xhtml#leanpub-auto-opacity)\n        4. [`fill-opacity`](chap06.xhtml#leanpub-auto-fill-opacity)\n        5. [`stroke-opacity`](chap06.xhtml#leanpub-auto-stroke-opacity)\n        6. [`stroke-width`](chap06.xhtml#leanpub-auto-stroke-width)\n        7. [`stroke-dasharray`](chap06.xhtml#leanpub-auto-stroke-dasharray)\n        8. [`stroke-linecap`](chap06.xhtml#leanpub-auto-stroke-linecap)\n        9. [`stroke-linejoin`](chap06.xhtml#leanpub-auto-stroke-linejoin)\n        10. [`writing-mode`](chap06.xhtml#leanpub-auto-writing-mode)\n        11. [`glyph-orientation-vertical`](chap06.xhtml#leanpub-auto-glyph-orientation-vertical)\n        12. [Using styles in Cascading Style Sheets](chap06.xhtml#leanpub-auto-using-styles-in-cascading-style-sheets)\n  8. [Manipulating data](chap07.xhtml#leanpub-auto-manipulating-data)\n     1. [How to use data imported from a csv file with spaces in the header.](chap07.xhtml#leanpub-auto-how-to-use-data-imported-from-a-csv-file-with-spaces-in-the-header)\n     2. [Extracting data from a portion of a string.](chap07.xhtml#leanpub-auto-extracting-data-from-a-portion-of-a-string)\n     3. [Grouping and summing data (d3.nest)](chap07.xhtml#nest)\n     4. [Selecting a random string from an array.](chap07.xhtml#leanpub-auto-selecting-a-random-string-from-an-array)\n  9. [Bar Charts and Histograms](chap08.xhtml#leanpub-auto-bar-charts-and-histograms)\n     1. [Bar Chart](chap08.xhtml#leanpub-auto-bar-chart)\n        1. [Histogram](chap08.xhtml#leanpub-auto-histogram)\n     2. [Bar Charts](chap08.xhtml#leanpub-auto-bar-charts)\n        1. [The data](chap08.xhtml#leanpub-auto-the-data)\n        2. [The code](chap08.xhtml#leanpub-auto-the-code)\n        3. [The bar chart explained](chap08.xhtml#leanpub-auto-the-bar-chart-explained)\n     3. [Histograms](chap08.xhtml#leanpub-auto-histograms)\n        1. [The data](chap08.xhtml#leanpub-auto-the-data-1)\n        2. [The code](chap08.xhtml#leanpub-auto-the-code-1)\n        3. [The histogram explained](chap08.xhtml#leanpub-auto-the-histogram-explained)\n  10. [Tree Diagrams](chap09.xhtml#leanpub-auto-tree-diagrams)\n     1. [What is a Tree Diagram?](chap09.xhtml#leanpub-auto-what-is-a-tree-diagram)\n     2. [A simple Tree Diagram explained](chap09.xhtml#leanpub-auto-a-simple-tree-diagram-explained)\n     3. [A horizontal tree diagram explained](chap09.xhtml#leanpub-auto-a-horizontal-tree-diagram-explained)\n     4. [Styling nodes in a tree diagram](chap09.xhtml#leanpub-auto-styling-nodes-in-a-tree-diagram)\n        1. [Changing node and link colours](chap09.xhtml#tree-styling)\n        2. [Changing the nodes to different shapes](chap09.xhtml#leanpub-auto-changing-the-nodes-to-different-shapes)\n        3. [Using images as nodes](chap09.xhtml#leanpub-auto-using-images-as-nodes)\n     5. [Generating a tree diagram from external data](chap09.xhtml#treeFromExternal)\n     6. [Generating a tree diagram from ‘flat’ data](chap09.xhtml#treeFromFlat)\n     7. [Generating a tree diagram from a CSV file.](chap09.xhtml#leanpub-auto-generating-a-tree-diagram-from-a-csv-file)\n     8. [An interactive tree diagram](chap09.xhtml#leanpub-auto-an-interactive-tree-diagram)\n  11. [Sankey Diagrams](chap10.xhtml#leanpub-auto-sankey-diagrams)\n     1. [What is a Sankey Diagram?](chap10.xhtml#leanpub-auto-what-is-a-sankey-diagram)\n     2. [Which Sankey plugin should we use?](chap10.xhtml#leanpub-auto-which-sankey-plugin-should-we-use)\n     3. [How d3.js Sankey Diagrams want their data formatted](chap10.xhtml#sankeydata)\n     4. [Description of the code](chap10.xhtml#leanpub-auto-description-of-the-code)\n     5. [Formatting data for Sankey diagrams](chap10.xhtml#leanpub-auto-formatting-data-for-sankey-diagrams)\n        1. [From a JSON file with numeric link values](chap10.xhtml#leanpub-auto-from-a-json-file-with-numeric-link-values)\n        2. [From a JSON file with links as names](chap10.xhtml#leanpub-auto-from-a-json-file-with-links-as-names)\n        3. [From a CSV with ‘source’, ‘target’ and ‘value’ info only.](chap10.xhtml#leanpub-auto-from-a-csv-with-source-target-and-value-info-only)\n  12. [Assorted Tips and Tricks](chap11.xhtml#leanpub-auto-assorted-tips-and-tricks)\n     1. [Change a line chart into a scatter plot](chap11.xhtml#scatterplot)\n     2. [Adding tooltips.](chap11.xhtml#leanpub-auto-adding-tooltips)\n        1. [Transitions](chap11.xhtml#leanpub-auto-transitions)\n        2. [Events](chap11.xhtml#leanpub-auto-events)\n        3. [Get tipping](chap11.xhtml#leanpub-auto-get-tipping)\n        4. [on.mouseover](chap11.xhtml#leanpub-auto-onmouseover)\n        5. [on.mouseout](chap11.xhtml#leanpub-auto-onmouseout)\n        6. [Including an HTML link in a tool tip](chap11.xhtml#leanpub-auto-including-an-html-link-in-a-tool-tip)\n           1. [Moar Links!](chap11.xhtml#leanpub-auto-moar-links)\n     3. [What are the predefined, named colours?](chap11.xhtml#leanpub-auto-what-are-the-predefined-named-colours)\n     4. [Selecting / filtering a subset of objects](chap11.xhtml#filtering)\n     5. [Select items with an IF statement.](chap11.xhtml#leanpub-auto-select-items-with-an-if-statement)\n     6. [Applying a colour gradient to a line based on value.](chap11.xhtml#leanpub-auto-applying-a-colour-gradient-to-a-line-based-on-value)\n     7. [Applying a colour gradient to an area fill.](chap11.xhtml#leanpub-auto-applying-a-colour-gradient-to-an-area-fill)\n     8. [Transitions](chap11.xhtml#leanpub-auto-transitions-1)\n        1. [Transitioning Chaining](chap11.xhtml#chaining)\n        2. [Transition Easing](chap11.xhtml#leanpub-auto-transition-easing)\n        3. [Looping a Transition](chap11.xhtml#leanpub-auto-looping-a-transition)\n     9. [Show / hide an element by clicking on another element](chap11.xhtml#leanpub-auto-show--hide-an-element-by-clicking-on-another-element)\n        1.            1. [The code](chap11.xhtml#leanpub-auto-the-code-2)\n     10. [Using HTML inputs with d3.js](chap11.xhtml#leanpub-auto-using-html-inputs-with-d3js)\n        1. [What is an HTML input?](chap11.xhtml#leanpub-auto-what-is-an-html-input)\n        2. [Using a `range` input with d3.js](chap11.xhtml#leanpub-auto-using-a-range-input-with-d3js)\n           1. [The code](chap11.xhtml#leanpub-auto-the-code-3)\n           2. [The explanation](chap11.xhtml#leanpub-auto-the-explanation)\n        3. [Using more than one input](chap11.xhtml#leanpub-auto-using-more-than-one-input)\n           1. [The code](chap11.xhtml#leanpub-auto-the-code-4)\n           2. [The explanation](chap11.xhtml#leanpub-auto-the-explanation-1)\n        4. [Rotate text with an input](chap11.xhtml#leanpub-auto-rotate-text-with-an-input)\n           1. [The explanation](chap11.xhtml#leanpub-auto-the-explanation-2)\n        5. [Use a `number` input with d3.js](chap11.xhtml#leanpub-auto-use-a-number-input-with-d3js)\n        6. [Change more than one element with an input](chap11.xhtml#leanpub-auto-change-more-than-one-element-with-an-input)\n           1. [The code](chap11.xhtml#leanpub-auto-the-code-5)\n           2. [The explanation](chap11.xhtml#leanpub-auto-the-explanation-3)\n     11. [Add an HTML table to your graph](chap11.xhtml#tables)\n        1. [HTML Tables](chap11.xhtml#leanpub-auto-html-tables)\n        2. [First the CSS](chap11.xhtml#leanpub-auto-first-the-css)\n        3. [Now the d3.js code](chap11.xhtml#leanpub-auto-now-the-d3js-code)\n        4. [A small but cunning change…](chap11.xhtml#leanpub-auto-a-small-but-cunning-change)\n        5. [Explaining the d3.js code (reloaded).](chap11.xhtml#leanpub-auto-explaining-the-d3js-code-reloaded)\n        6. [Wrap up](chap11.xhtml#leanpub-auto-wrap-up-1)\n     12. [More table madness: sorting, prettifying and adding columns](chap11.xhtml#leanpub-auto-more-table-madness-sorting-prettifying-and-adding-columns)\n        1. [Add another column of information:](chap11.xhtml#leanpub-auto-add-another-column-of-information)\n        2. [Sorting on a column](chap11.xhtml#leanpub-auto-sorting-on-a-column)\n        3. [Prettifying (actually just capitalising the header for each column)](chap11.xhtml#leanpub-auto-prettifying-actually-just-capitalising-the-header-for-each-column)\n        4. [Add borders](chap11.xhtml#leanpub-auto-add-borders)\n     13. [Adding web links to d3.js objects](chap11.xhtml#leanpub-auto-adding-web-links-to-d3js-objects)\n        1. [It’s all about the ‘a’ and the ‘xlink’](chap11.xhtml#leanpub-auto-its-all-about-the-a-and-the-xlink)\n        2. [Adding in the links](chap11.xhtml#leanpub-auto-adding-in-the-links)\n        3. [Making the mouse pointer ignore an object](chap11.xhtml#leanpub-auto-making-the-mouse-pointer-ignore-an-object)\n     14. [Using the Yahoo Query Language (YQL) to get data.](chap11.xhtml#leanpub-auto-using-the-yahoo-query-language-yql-to-get-data)\n        1. [YQL by example](chap11.xhtml#leanpub-auto-yql-by-example)\n     15. [Export an image from a d3.js page as a SVG or bitmap](chap11.xhtml#leanpub-auto-export-an-image-from-a-d3js-page-as-a-svg-or-bitmap)\n        1. [Bitmaps](chap11.xhtml#leanpub-auto-bitmaps)\n        2. [Vector Graphics (Specifically SVG)](chap11.xhtml#svg)\n        3. [Let’s get exporting!](chap11.xhtml#leanpub-auto-lets-get-exporting)\n           1. [Copying the image off the web page](chap11.xhtml#leanpub-auto-copying-the-image-off-the-web-page)\n           2. [Open the SVG Image and Edit](chap11.xhtml#leanpub-auto-open-the-svg-image-and-edit)\n           3. [Saving as a bitmap](chap11.xhtml#leanpub-auto-saving-as-a-bitmap)\n     16. [Understanding JavaScript Object Notation (JSON)](chap11.xhtml#json)\n  13. [D3.js Examples Explained](chap12.xhtml#leanpub-auto-d3js-examples-explained)\n     1. [Multi-line graph with automatic legend and toggling show / hide lines.](chap12.xhtml#leanpub-auto-multi-line-graph-with-automatic-legend-and-toggling-show--hide-lines)\n        1. [Purpose](chap12.xhtml#leanpub-auto-purpose)\n        2. [The Code](chap12.xhtml#leanpub-auto-the-code-6)\n        3. [Description](chap12.xhtml#leanpub-auto-description)\n           1. [Nesting the data](chap12.xhtml#leanpub-auto-nesting-the-data)\n           2. [Applying the colours](chap12.xhtml#leanpub-auto-applying-the-colours)\n           3. [Adding the legend](chap12.xhtml#leanpub-auto-adding-the-legend)\n           4. [Making it interactive](chap12.xhtml#leanpub-auto-making-it-interactive)\n\n## Guide\n\n  1. [Begin Reading](chap00.xhtml)\n\n\n## Acknowledgements\n\n### Mike\n\nFirst and foremost I would like to express my thanks to Mike Bostock, the\ndriving force behind d3.js. His efforts are tireless and his altruism in\nmaking his work open and available to the masses is inspiring.\n\nThe decision for him to leave what must have been an incredible job with the\nNew York Times to return to improving visualisation software (d3.js in\nparticular) has marked him as a very special person indeed. If any reader of\nthis book has the opportunity to support his continuing efforts, please do.\n\n### Partners, Supporters and Contributors.\n\nMike has worked with a crew of like-minded individuals in bringing D3 to the\nWorld. Vadim Ogievetsky and Jeffrey Heer share honours for the work on [D3:\nData-Driven Documents](http://vis.stanford.edu/papers/d3) and while there has\nbeen a cast of over 40 people contributing to the D3 code base, Jason Davies\nstands out as the man who has provided a generous portion especially in the\narea of mapping.\n\nNick Zhu has created a fantastic resource in\n[dc.js](https://github.com/NickQiZhu/dc.js/wiki) (which is built on top of\nd3.js and crossfilter) and has been kind enough to provide good advice and\npermission to include some of his work.\n\nAdvice given by Christophe Viau has been a great help in getting me settled\ninto the on-line world and his energy in managing and directing the D3\ncommunity is amazing.\n\nMike Dewar (_Getting Started with D3_), Scott Murray (_Interactive Data\nVisualization for the Web_) and Sebastian Gutierrez\n([dashingd3js.com](http://www.dashingd3js.com/)) lead the pack for providing\nhigh quality reference material for learning D3. Many thanks gentlemen.\n\n### Proof Reading\n\nI am particularly grateful for the assistance given by Filiep Spyckerelle and\nRobin Bennett who selflessly donated their time and expertise in proofreading\nthe earlier edition of D3 Tips and Tricks (d3.js v3) (where this document\ncontains any errors, they are most certainly mine).\n\nIn fact Robin has been very quick off the mark and is feeding back areas for\nimprovement in the new book already!\n\n### The d3.js Community\n\nBig thanks go out to the D3 community. Whether providing advice on Google\nGroups or Stack Overflow, contributing examples on bl.ocks.org or just giving\nback in the form of time and effort to similar work. Well done all.\n\n### Cover art\n\nOut of the blue and in yet another example of the friendly and giving nature\nof people involved in this community I was contacted by Jose (‘Tactician\nJenro’) who offered to use his skills to design a cover for the original book.\nHe has subsequently designed the cover for this version and I think he did an\nawesome job and was super helpful. If you think that he could help you out\nwith a project, you can get in touch with him at\n[@tacticianjenro](https://twitter.com/mindthetimes) or via his web site at\n<http://mindthetimes.xyz/>.\n\n![A sampling of works by Tactician Jenro](images/banner.jpg) A sampling of\nworks by Tactician Jenro\n\n### Leanpub\n\nLastly, I want to pay homage to [Leanpub](https://leanpub.com/) who have made\nthe publishing of this document possible. They offer an outstanding service\nfor self-publishing and have made the task of providing and distributing\ncontent achievable.\n\n### Make sure you get the most up to date copy of D3 Tips and Tricks\n\nIf you’ve received a copy of this book from any location other than\n[Leanpub](https://leanpub.com/d3-t-and-t-v4) then it’s possible that you\nhaven’t got the latest version. Go to https://leanpub.com/d3-t-and-t-v4 and\ndownload the most recent version. After all, it won’t cost you anything :-).\nIf you find some value in the work, please consider contributing when you\ndownload it so that Leanpub get something for hosting the book (and I’ll think\nof you fondly while I continue adding content :-D).\n\n\n## What is d3.js?\n\n[d3.js](http://d3js.org/) (hereafter abridged as D3) is “ _a JavaScript\nlibrary for manipulating documents based on data_ ”.\n\nBut that description doesn’t do it justice.\n\nD3 is all about helping you to take information and make it more accessible to\nothers via a web browser.\n\nIt’s a JavaScript library. That means that it’s a software tool that can be\nused in conjunction with other software tools to achieve a task. Those other\ntools are based on web standards such as HTML, SVG and CSS but you don’t need\nto know too much about them to start using D3 (although it will help :-)).\n\nIt’s an open framework, which means that there are no hidden mysteries about\nhow it does its magic and it allows others to contribute to a constant cycle\nof improvement.\n\nBeing built to leverage web standards means that modern browsers don’t have to\ndo anything special to use D3, they just have to support the framework that\nthe Internet has adopted for ease of use.\n\nThe beauty of D3 is that it allows you to associate data and what appears on\nthe screen in a way that directly links the two. Change the data and you\nchange the object on the screen. D3’s trick is to let you set what appears on\nthe screen. A circle, a line, a point on a map, a graph, a bouncing ball, a\ngradient (and way, way more). Once the data and the object are linked the\npossibilities are endless.\n\nD3 bridges the gap between the static display of data and the desire of people\nto represent it dynamically. That applies equally to the developer who wants\nto show something cool and to the end user who wants to be able to explore\ninformation interactively.\n\nIt was (and still is being) developed by [Mike\nBostock](http://bost.ocks.org/mike/) who has not just spent time writing the\ncode, but writing the [documentation](https://github.com/mbostock/d3/wiki) for\nD3 as well. There is an extensive community of supporters who also contribute\nto the code, provide technical\n[support](https://groups.google.com/forum/?fromgroups#!forum/d3-js)\n[online](http://stackoverflow.com/questions/tagged/d3.js) and generally have\nfun creating amazing\n[visualizations](https://github.com/mbostock/d3/wiki/Gallery). Their\ncontributions are extraordinary (you only have to look at the work of Jason\nDavies to be amazed).\n\nThis book has been written to incorporate the changes in version 4 of d3.js to\nthe original edition of D3 Tips and Tricks. If you’re looking for the\nequivalent for version 3 you can find it [here](https://leanpub.com/D3-Tips-\nand-Tricks).\n\n\n## Introduction\n\nI never set out to write treatise on D3… But here I am three years after\npublishing the first version of this book and I’m in the process of updating\nit for version 4 of d3.js, while also looking back at a range of other books\nthat have been written as a result of this first foray into publishing.\n\nI am a simple user of this extraordinary framework and when I say simple, I\n_really_ mean I had no idea how to get it to do anything when I started; I\nneeded to do a lot of searching and learned by trial-and-error (emphasis on\nthe errors which were entirely mine). The one thing that I did know was that\nthe example graphics shown by Mike Bostock and others were the sort of\ngraphical goodness that I wanted to play with.\n\nSo to get from the point of having no skills whatsoever to the point where I\ncould begin to code up something to display data in a way I wanted, I had to\ncapture the information as I went. The really cool thing about this sort of\nprocess is that it doesn’t need to occur all at once. You can start with no\nknowledge whatsoever (or pretty close) and by standing on the shoulders of\nother’s work, you can add building blocks to improve what you’re seeing and\nthen change the blocks to adapt and improve.\n\nFor example (and this is pretty much how it started). I wanted to draw a line\ngraph, so I imported an example and then got it running locally on my\ncomputer. Then I worked out how to change the example data for my data. Then I\nworked out how to move the Y axis from the right to the left. Then how to make\nthe axis labels larger, change the tick size, make the lines fatter, change\nthe colour, add a label, fill the area under the graph, put the graph in the\ncentre of the page, add a glow to the text to help it stand out, put it in a\nframework (bootstrap), add buttons to change data sets, animate the\ntransitions between data sets, update the data automatically when it changed,\nadd a pan and zoom feature, turn parts of the graph into hyperlinks to move to\nother graphs… And then I started on bar graphs :-).\n\nThe point to take away from all of this is that any one graph is just a\ncollection of lots of blocks of code, each block designed to carry out a\nspecific function. Pick the blocks you want and implement them.\n\nI found it was much simpler to work on one thing (block) at a time, and this\nhelped greatly to reduce the uncertainty factor when things didn’t work as\nanticipated. I’m not going to pretend that everything I’ve done while trying\nto build graphs employs the most elegant or efficient mechanism, but in the\nend, if it all works on the screen, I walk away happy :-). That’s not to say I\nhave deliberately ignored any best practices – I just never knew what they\nwere. Likewise, wherever possible, I have tried to make things as extensible\nas possible.\n\nD3 has also steered down the road of providing standalone micro-libraries\navailable as components and this flexibility continues to redefine the maxim\nof change being the only constant in the software world.\n\nYou will find that I have typically eschewed a simple “Do this approach” for\nmore of a story telling exercise. This means that some explanations are longer\nand more flowery than might be to everyone’s liking, but there you go, try to\nbe brave :-)\n\nI’m sure most authors try to be as accessible as possible. I’d like to do the\nsame, but be warned… There’s a good chance that if you ask me a technical\nquestion I may not know the answer. So please be gentle with your emails :-).\n\nEmail: ‘d3noobmail+contact@gmail.com’\n\n\n## What do we need to get started?\n\nLet’s be honest with each other. D3 is not the simplest way to draw a graph.\n\nHowever, that doesn’t mean that it’s beyond those with a little computer savy\nand a willingness to experiment. Remember failure is your friend (I am fairly\nsure that I am also related by blood). Just learn from your mistakes and it’ll\nall work out.\n\nSo, here in no particular order is a list of good things to know. None of\nwhich are essential, but any one (or more) of which will make your life\nslightly easier.\n\n  * HyperText Markup Language (HTML)\n  * JavaScript\n  * Cascading Style Sheets (CSS)\n  * Web Servers\n  * PHP\n\n### **DON’T FREAK OUT!**\n\nFirst things first. This isn’t rocket science. It’s just the Internet. We’ll\ntake it gently, and I’ll be a little more specific in the following sections.\n\n### HTML\n\nThis stands for HyperText Markup Language and is the stuff that web pages are\nmade of. Check out the definition and other information on\n[Wikipedia](http://en.wikipedia.org/wiki/HTML) for a great overview. Just\nremember that all you’re going to use HTML for is to hold the code that you\nwill use to present your information. This will be as a .html (or .htm) file\nand they can be pretty simple (we’ll look at some in a moment).\n\n### JavaScript\n\n[JavaScript](http://en.wikipedia.org/wiki/JavaScript) is what’s called a\n‘scripting language’. It is the code that will be contained inside the HTML\nfile that will make D3 do all its fanciness. In fact, D3 is a JavaScript\nLibrary, it’s the native language for using D3.\n\nKnowing a little bit about this would be really good, but to be perfectly\nhonest, I didn’t know anything about it before I started. I read a book along\nthe way ([JavaScript: The Missing\nManual](http://shop.oreilly.com/product/9780596515898.do) from O’Reilly) and\nthat helped with context, but the examples that are available for D3 graphics\nare understandable, and with a bit of trial and error, you can figure out\nwhat’s going on.\n\nIn fact, most of what this collection of information’s about is providing\nexamples and explanations for the JavaScript components of D3.\n\n### Cascading Style Sheets (CSS)\n\n[Cascading Style Sheets](http://en.wikipedia.org/wiki/Css) (everyone tends to\ncall them ‘Style Sheets’ or ‘CSS’) is a language used to describe the\nformatting (or “ _look and feel_ ”) of a document written in a markup\nlanguage. The job of CSS is to make the presentation of the components you\nwill draw with D3 simpler by assigning specific styles to specific objects.\nOne of the cool things about CSS is that it is an enormously flexible and\nefficient method for making everything on the screen look more consistent and\nwhen you want to change the format of something you can just change the CSS\ncomponent and the whole look and feel of your graphics will change.\n\n![The wonderful World of Cascading Style Sheets](images/wordcloud.png) The\nwonderful World of Cascading Style Sheets\n\n### Full disclosure\n\nI know CSS is an incredibly powerful tool that would make my life easier, but\nI use it in a very basic (and probably painful) way. Don’t judge me, just\naccept that the way I’ve learnt was what I needed to get the job done (this\nprobably means that noobs like myself will find it easier, but where possible\ntry and use examples that include what look like logical CSS structures).\n\n### Web Servers\n\nWeb servers can go one of two ways. If you have access to a web server and\nknow where to put the files so that you can access them with your browser,\nyou’re in a good place. If you’re not quite sure, read on…\n\nA web server will allow you to access your HTML files and will provide the\nstructure that allows it to be displayed on a web browser. There are some\nsimple instructions on the main [D3 wiki\npage](https://github.com/mbostock/d3/wiki) for setting up a local server. Or\nyou might have access to a remote one and be able to upload your files.\nHowever, for a little more functionality and a whole lot of ease of use, I can\nthoroughly recommend WampServer (WAMP) as a free and simple way to set up a\nlocal web server that includes PHP and a MySQL database (more on those later).\nGo to the [WampServer web page](http://www.wampserver.com/en/)\n(http://www.wampserver.com/en/) and see if it suits you.\n\nThroughout this document I will be describing the files and how they’re laid\nout in a way that has suited my efforts while using WAMP, but they will work\nequally well on a remote server. I will explain a little more about how I\narrange the files later in the ‘Getting D3’ section.\n\n![WAMP = Windows + Apache + MySQL + PHP](images/wamp.png) WAMP = Windows +\nApache + MySQL + PHP\n\nThere are other options of course. You could host code on\n[GitHub](https://github.com/about) and present the resulting graphics on\n[bl.ocks.org](http://bl.ocks.org/). This is a great way to make sure that your\ncode is available for peer review and sharing with the wider community.\n\nOne such alternative option that I have recently started playing with is\nPlunker (http://plnkr.co/) This is a lightweight collaborative online editing\ntool. It’s so cool I wrote a special section for it which you can find later\nin this document. This is definitely worth trying if you want to use something\nsimple without a great deal of overhead. If you like what you see, perhaps\nconsider an alternative that provides a greater degree of capability if you go\non to greater d3.js things.\n\n### PHP\n\nPHP is a scripting language for the web. That is to say that it is a\nprogramming language which is executed when you load web pages and it helps\nweb pages do dynamic things.\n\nYou might think that this sounds familiar and that JavaScript does the same\nthing. But not quite.\n\nJavaScript is designed so that it travels _with_ the web page when it is\ndownloaded by a browser (the **client**). However, PHP is executed remotely on\nthe **server** that supplies the web page. This might sound a bit redundant,\nbut it’s a big deal. This means that the PHP which is executed doesn’t form\n_part_ of the web page, but it can _form_ the web page. The implication here\nis that the web page you are viewing can be altered by the PHP code that runs\non a remote server. This is the dynamic aspect of it.\n\nIn practice, PHP could be analogous to the glue that binds web pages together.\nAllowing different portions of the web page to respond to directions from the\nend user.\n\nIt is widely recognised not only as a relatively simple language to learn, but\nalso as a fairly powerful one. At the same time it comes into criticism for\nbeing somewhat fragmented and sometimes contradictory or confusing. But in\nspite of any perceived shortcomings, it is a very widely used and implemented\nlanguage and one for which there is no obvious better option.\n\n### Other Useful Stuff\n\n#### Text Editor\n\nA good text editor for writing up your code will be a real boost. Don’t make\nthe fatal mistake of using an office word processor or similar. **THEY WILL\nDOOM YOU TO A LIFE OF MISERY**. They add in crazy stuff that you can’t even\nsee and never save the files in a way that can be used properly.\n\nPreferably, you should get an editor that will provide some assistance in the\nform of syntax highlighting which is where the editor knows what language you\nare writing in (JavaScript for example) and highlights the text in a way that\nhelps you read it. For example, it will change text that might appear as this;\n\n    \n    \n    // Get the data\n    d3.tsv(\"data/data.tsv\", function(error, data) {\n    data.forEach(function(d) {\n        d.date = parseDate(d.date\n        d.close = +d.close;\n    });\n    \n\nInto something like this;\n\n    \n    \n    // Get the data\n    d3.tsv(\"data/data.tsv\", function(error, data) {\n    data.forEach(function(d) {\n        d.date = parseDate(d.date);\n        d.close = +d.close;\n    });\n    \n\nInfinitely easier to use. Trust me.\n\nThere are plenty of editors that will do the trick. I have a preference for\n[Geany](http://www.geany.org/), mainly because it’s what I started with and it\ngrew on me :-).\n\n#### Getting D3\n\nLuckily this is pretty easy and could go one of two ways.\n\n##### Host d3.js locally\n\nGo to the D3 repository on [github](https://github.com/mbostock/d3) and\ndownload the entire repository by clicking on the ‘ZIP’ button.\n\n![Download the repository as a zip file](images/downloadrepository.png)\nDownload the repository as a zip file\n\nWhat you do with it from here depends on how you’re hosting your graphs. If\nyou’re working on them on your local PC, then you will want to have the d3.js\nfile in the path that can be seen by the browser. Again, I would recommend\nWAMP (a local web server) to access your files locally. If you’re using WAMP,\nthen you just have to make sure that it knows to use a directory that will\ncontain the d3 directory and you will be away.\n\n##### Use a remote CDN to always use the latest version of d3.js\n\nThe alternative to downloading d3.js and using it locally is to always\nretrieve it from an online source. For d3.js this could be done via having the\nfollowing line in our JavaScript; `<script\nsrc=\"https://d3js.org/d3.v4.min.js\"></script>`. This method has the advantage\nof always using the latest version of D3 and is especially useful if your\nvisualisations are hosted somewhere like bl.ocks.org.\n\n##### Potential directory structure\n\nThe following image is intended to provide a very crude overview of how we can\nset up the directories for our web server.\n\n![A potential directory structure for your files](images/dirlayout.png) A\npotential directory structure for your files\n\n  * webserver: Use this as our ‘base’ directory where you put our files that we create. That way when we open our browser we point to this directory and it allows us to access the files like a normal web site.\n  * d3: This would be our unzipped d3 directory. It contains all the examples and more importantly the d3.v4.js file that we need to get things going. To do this we would include a line like the following;\n\n    \n    \n    <script type=\"text/javascript\" src=\"d3/d3.v4.js\"></script>\n    \n\nThis tells our browser that from the file it is running (one of the html graph\nfiles) if it goes into the ‘d3’ folder it will find the `d3.v4.js` file that\nit can load.\n\n  * data: I use this directory to hold any data files that I would use for processing. For example, you will see the following line in the code examples that follow `d3.csv(\"data/data.csv\", function(error, data) {`. Again, that’s telling the browser to go into the ‘data’ directory and to load the ‘data.csv’ file.\n  * js: Often we will find that we will want to include other JavaScript libraries to load. This is a good place to put them.\n\n#### Where to get information on d3.js\n\nD3 has made huge advances in providing an extensible and practical framework\nfor manipulating data as web objects. At the same time there has been\nsignificant increase in information available for people to use it. The\nfollowing is a far from exhaustive list of sources, but from my own experience\nit represents a useful subset of knowledge.\n\n##### d3js.org\n\nd3js.org would be the first port of call for people wanting to know something\nabout d3.js.\n\nFrom the overview on the main page you can access a dizzying array of\n[examples](https://github.com/mbostock/d3/wiki/Gallery) that have been\nprovided by the founder of d3 (Mike Bostock) and a host of additional\ndevelopers, artists, coders and anyone who has something to add to the sum\nknowledge of cool things that can be done with D3.\n\nThere is a link to a [documentation page](https://github.com/mbostock/d3/wiki)\nthat serves as a portal to the ever important API reference, contributed\ntutorials and other valuable links (some of which I will mention in paragraphs\nahead).\n\nThe last major link is to the [Github\nrepository](https://github.com/mbostock/d3) where you can download d3.js\nitself.\n\nIt is difficult to overstate the volume of available information that can be\naccessed from d3js.org. It stands alone as the one location that anyone\ninterested in D3 should visit.\n\n##### Google Groups\n\nThere is a Google Group dedicated to [discussions on\nd3.js](https://groups.google.com/forum/?fromgroups#!forum/d3-js).\n\nIn theory this forum is for discussions on topics including visualization\ndesign, API design, requesting new features, etc. With a specific direction\nmade in the main header that “ _If you want help using D3, please use the\nd3.js tag on Stack Overflow!_ ”.\n\nIn practice however, it would appear that a sizeable proportion of the posts\nthere are technical assistance requests of one type or another. Having said\nthat this means that if you’re having a problem, there could already be a\nsolution posted there. However, if at all possible the intention is certainly\nthat people use Stack Overflow, so this should be the first port of call for\nthose types of inquiry.\n\nSo, by all means add this group as a favourite and this will provide you with\nthe opportunity to receive emailed summaries of postings or just an\nopportunity to easily browse recent goings-on.\n\n##### Stack Overflow\n\nStack Overflow is a question and answer site whose stated desire is “ _to\nbuild a library of detailed answers to every question about programming_ ”.\nAmbitious. So how are they doing? Actually really well. Stack overflow is a\nfantastic place to get help and information. It’s also a great place to help\npeople out if you have some knowledge on a topic.\n\nThey have a funny scheme for rewarding users that encourages providing good\nanswers based on readers voting. It’s a great example of gamification working\nwell. If you want to know a little more about how it works, check out this\npage; http://stackoverflow.com/about.\n\nThey have a d3.js tag (http://stackoverflow.com/questions/tagged/d3.js) and\nlike Google Groups there is a running list of different topics that are an\nexcellent source of information.\n\n##### Github\n\n[Github](https://github.com/) is predominantly a code repository and version\ncontrol site. It is highly regarded for its technical acumen and provides a\nfantastic service that is broadly used for many purposes. Not the least of\nwhich is hosting the code (and the wiki) for d3.js.\n\nWhilst not strictly a site that specialises in providing a Q & A function,\nthere is a significant number of repositories which mention d3.js. With the\nhelp from an astute search phrase, there is potentially a solution to be found\nthere.\n\nThe other associated feature of Github is Gist. Gist is a pastebin service (a\nplace where you can copy and past code) that can provide a ‘wiki like’ feature\nfor individual repositories and web pages that can be edited through a Git\nrepository. Gist plays a role in providing the hub for the bl.ocks.org example\nhosting service set up by Mike Bostock.\n\nFor a new user, Github / Gist can be slightly daunting. It’s an area where you\nwill get most value by understanding something about the services before you\nstart using them. This is certainly true if you want to make use of its\nincredible features that are available for hosting code. However, if you want\nto browse other peoples code it’s an easier introduction. Have a look through\nwhat’s available and if you feel so inclined, I recommend that you learn\nenough to use their service. It’s time well spent.\n\n##### bl.ocks.org\n\n[bl.ocks.org](http://bl.ocks.org/) is a viewer for code examples which are\nhosted on Gist. You are able to load your code into Gist, and then from\nbl.ocks.org you can view them.\n\nThis is a really great way for people to provide examples of their work and\nthere are many who do. However, it’s slightly tricky to know what is there.\nThere is a [project](http://blockbuilder.org/search) that will help with\nsearching the bl.ocks for key words. This is an immensely valuable service\nthat should be a highlight for someone wanting inspiration or assistance.\n\nI would describe the process of getting your own code hosted and displaying as\nsomething that will be slightly challenging for people who are not familiar\nwith Github / Gist, but again, in terms of visibility of the code and\nproviding an external hosting solution, it is excellent and well worth the\ntime to get to grips with.\n\n##### Twitter\n\nTwitter provides a great alerting service to inform a large disparate group of\npeople about _stuff_.\n\nIt’s certainly a great way to keep in touch on an hour by hour basis with\npeople who are involved with d3.js and this can be accomplished in a couple of\nways. First, find as many people from the various D3 sites around the web who\nyou consider to be influential in areas you want to follow (different aspects\nsuch as development, practical output, educational (etc) and follow them. Even\nbetter, I found it useful to find a small subset who I considered to be\ninfluential people and I noted who they followed. It’s a bit ‘ _stalky_ ’ if\nyou’re unfamiliar with it, but the end result should be a useful collection of\npeople with something useful to say.\n\n##### Books\n\nThe following books are referenced on the D3 wiki;\n\n  * _[Getting Started with D3](http://shop.oreilly.com/product/0636920025429.do)_ : Mike Dewar, O’Reilly Media, June 2012\n  * _[Interactive Data Visualization for the Web](http://chimera.labs.oreilly.com/books/1230000000345)_ : Scott Murray, O’Reilly Media, November 2012\n  * _[Data Visualization with d3.js](http://www.packtpub.com/data-visualization-with-d3js/book)_ : Swizec Teller, Packt Publishing, October 2013\n  * _[Data Visualization with D3.js Cookbook](http://www.packtpub.com/data-visualization-with-d3-js-cookbook/book)_ : Nick Qi Zhu, Packt Publishing, October 2013\n  * _[Mastering D3.js](https://www.packtpub.com/web-development/mastering-d3js)_ : Pablo Navarro Castillo, Packt Publishing, August 2014\n  * _[D3.js in Action](http://www.manning.com/meeks/)_ : Elijah Meeks, Manning Publications, 2014\n  * _[Learning D3.js Mapping](https://www.packtpub.com/web-development/learning-d3js-mapping)_ : Thomas Newton, Oscar Villarreal, Packt Publishing, 2014\n  * _[Visual Storytelling with D3](http://ritchiesking.com/book/)_ : Ritchie King, Addison-Wesley, 2014\n  * _[D3 on AngularJS](https://leanpub.com/d3angularjs)_ : Ari Lerner + Victor Powell, Leanpub, 2014\n\nOf course, there is also the original paper that launched D3 _[D3: Data-Driven\nDocuments](http://vis.stanford.edu/papers/d3)_ by Michael Bostock, Vadim\nOgievetsky and Jeffrey Heer (IEEE Trans. Visualization & Comp. Graphics (Proc.\nInfoVis), 2011)\n\n\n## Starting with a simple graph\n\nWe’ll start with the full code for a simple graph and then we can go through\nit piece by piece.\n\nHere’s what the basic graph looks like;\n\n![Basic Graph](images/basicgraph.png) Basic Graph\n\nAnd here’s the code that makes it happen;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    .line {\n      fill: none;\n      stroke: steelblue;\n      stroke-width: 2px;\n    }\n    \n    </style>\n    <body>\n    \n    <!-- load the d3.js library -->    \t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // parse the date / time\n    var parseTime = d3.timeParse(\"%d-%b-%y\");\n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n    // append the svg obgect to the body of the page\n    // appends a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Get the data\n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n      // Scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\nPlease note that the `<head></head>` tags are omitted which is a common thing\nfor d3 examples (It’s presumably an effort to reduce potentially distracting\ncode for when modern browsers can cope with the omission).\n\nOnce we’ve finished working through the explanation of the functional blocks\nthat make up the graph, we’ll start looking at what we need to add in and\nadjust so that we can incorporate other useful functions that are completely\nreusable in other diagrams as well.\n\nWorking on the premiss that we can break the file down into component parts we\nwill explain the major blocks as [HTML](chap04.xhtml#html),\n[CSS](chap04.xhtml#css) and [JavaScript](chap04.xhtml#javascript). I’m going\nto play kind of fast and loose here, but never fear, it’ll all make sense.\n\n### HTML\n\nHere’s the HTML portion of the code;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style>\n    \n        The CSS is in here\n    \n    </style>\n    <body>\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n        The D3 JavaScript code is here\n    \n    </script>\n    </body>\n    \n\nCompare it with the full code. It kind of looks like a wrapping for the\n[CSS](chap04.xhtml#css) and [JavaScript](chap04.xhtml#javascript). You can see\nthat it really doesn’t boil down to much at all (that doesn’t mean it’s not\nimportant).\n\nThere are plenty of good options for adding additional HTML stuff into this\nvery basic part of the file, but for what we’re going to be doing, we really\ndon’t need to bother too much.\n\nOne thing probably worth mentioning is the line;\n\n    \n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n\nThat’s the line that identifies the file that needs to be loaded to get D3 up\nand running. In this case the file is sourced from the official d3.js\nrepository on the Internet (that way we are using the most up to date\nversion). The D3 file is actually called `d3.v4.min.js` which may come as a\nbit of a surprise. That tells us that this is version 4 of the d3.js file (the\n`v4` part) which is an indication that it is separate from the v3 release,\nwhich was superseded in the middle of 2016. The other point to note is that\nthis version of d3.js is the minified version (hence `min`). This means that\nany extraneous information has been removed from the file to make it quicker\nto load.\n\nLater when doing things like implementing integration with bootstrap (a pretty\nlayout framework) we will be doing a great deal more, but for now, that’s the\nbasics done.\n\nThe two parts that we left out are the [CSS](chap04.xhtml#css) and the D3\n[JavaScript](chap04.xhtml#javascript).\n\n### Cascading Style Sheets (CSS)\n\nThe CSS is as follows;\n\n    \n    \n    .line {\n      fill: none;\n      stroke: steelblue;\n      stroke-width: 2px;\n    }\n    \n\nCascading Style Sheets (CSS) give you control over the look / feel /\npresentation of web content. The idea is to define a set of properties to\nobjects in the web page.\n\nThey are made up of ‘rules’. Each rule has a ‘selector’ and one or more\n‘declarations’ and each declaration has a property and a value (or a group of\nproperties and values).\n\nFor instance in the example code for this web page we have the following rule;\n\n    \n    \n    .line {\n      fill: none;\n      stroke: steelblue;\n      stroke-width: 2px;\n    }\n    \n\n`line` is the selector. The period (.) in front of `line` indicates that the\nselector is a ‘class’. This tells us that on the web page, any particular\nelement (and we are going to apply this rule to the line of our graph) which\nwe decorate with the ‘class’, `line` will have the various declarations\napplied to it.\n\nThere are three declarations as part of the rule. These are contained within\nthe curly braces and separated by semi-colons.\n\nOne of the declarations is for the width of the graph line (`stroke-width:\n2px;`) The property is `stroke-width:` and the value is `2px` (2 pixels). This\ntells the web page that any element in the web page that has the class `line`\nwill have lines drawn that are (amongst other things) 2 pixels wide.\n\nSure enough if we look at the line of the graph…\n\n![Graph line with stroke-width of 2 pixels](images/stroke-width-01.png) Graph\nline with stroke-width of 2 pixels\n\nThat looks as if the line might _actually_ be 2 pixels wide!\n\nLet’s try a test. We can change that particular declaration to the following;\n\n    \n    \n      stroke-width: 20px;\n    \n\nand the result is…\n\n![Graph line with stroke-width of 20 pixels](images/stroke-width-02.png) Graph\nline with stroke-width of 20 pixels\n\nAhh…. 20 pixels of goodness!\n\nBecause we’re getting the hang of things now, let’s change the colour\ndeclaration to…\n\n    \n    \n      stroke: red;\n    \n\nand we get…\n\n![Graph line with stroke colour changed to red](images/stroke-width-03.png)\nGraph line with stroke colour changed to red\n\nAwesome! I think we can safely say that this has had the desired effect.\n\nSo what else is there?\n\nSince there’s only one declaration left, it seems like a shame not to try\nsomething different with it;\n\n    \n    \n        fill: blue;\n    \n\nWe’ll get…\n\n![Basic Graph with changed CSS](images/basicgraph-02.png) Basic Graph with\nchanged CSS\n\nSo the ‘fill’ property looks like it will change the colour of the area that\nwould be closed by the line. Nice.\n\nThe one thing to take away from this small exercise is that there is a good\ndeal of flexibility in adjusting properties of elements on the web page via\nCSS.\n\n### D3 JavaScript\n\nThe D3 JavaScript part of the code is as follows;\n\n    \n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // parse the date / time\n    var parseTime = d3.timeParse(\"%d-%b-%y\");\n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n    // append the svg obgect to the body of the page\n    // appends a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Get the data\n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n      // Scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n\nAgain there’s quite a bit of detail in the code, but it’s not so long that we\ncan’t work out what’s doing what.\n\nThe first thing to note is that throughout the code we have lines that are\nadding a description of what the code does. These have two forward-stroke\ncharacters (//) preceding them which the computer will recognise as a line\nthat only contains comments. I recommend that you add them into your own code\nwhere you think that you might want reminding of a function or description.\n\nLet’s examine the blocks bit by bit to get a feel for it.\n\n#### Setting up the margins and the graph area.\n\nThe part of the code responsible for defining the canvas (or the area where\nthe graph and associated bits and pieces is placed ) is this part.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nThis is really (**_really_**) well explained on Mike Bostock’s page on margin\nconventions here <http://bl.ocks.org/3019563>, but at the risk of confusing\nyou here’s my crude take on it.\n\nThe first line defines the four margins which surround the block where the\ngraph (as an object) is positioned.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 30, left: 50},\n    \n\nSo there will be a border of 20 pixels at the top, 20 at the right and 30 and\n50 at the bottom and left respectively. Now the cool thing about how these are\nset up is that they use a JavaScript object to define everything. That means\nif you want to do calculations in the JavaScript later, you don’t need to put\nthe numbers in, you just use the variable that has been set up. In this case\nmargin.right = 20!\n\nJavaScript can store variables in arrayts and objects. A simple way to\nconsider them is that an array is defined with square brackets or with `new\nArray()` and an object uses the curly braces. Above we have a JavaScript\nobject with four properties. Each property of an object must have a unique\nname, thus each property can be referred to with dot syntax, such as\nmargin.right, while the elements of an array are unnamed and can only be\nreferred by position, such as myArray[0], myArray[3], etc.\n\nMany thanks to Dave Lampton for providing the clarification above (and others\nfollowing).\n\nSo when we go to the next line;\n\n    \n    \n        width = 960 - margin.left - margin.right,\n    \n\nThe width of the inner block of the area where the graph will be drawn is 960\npixels – margin.left – margin.right or 960-50-20 or 890 pixels wide. Of course\nnow we have another variable ‘width’ that we can use later in the code.\n\nObviously the same treatment is given to height.\n\nAnother cool thing about all of this is that just because we appear to have\ndefined separate areas for the graph and the margins, the whole area in there\nis available for use. It just makes it really useful to have areas designated\nfor the axis labels and graph labels without having to juggle them and the\ngraph proper at the same time.\n\nSo, let’s have a play and change some values.\n\n    \n    \n    var margin = {top: 80, right: 20, bottom: 80, left: 50},\n        width = 400 - margin.left - margin.right,\n        height = 270 - margin.top - margin.bottom;\n    \n\n![The effect of changing the margins](images/squishedgraph.png) The effect of\nchanging the margins\n\nHere we’ve made the graph narrower (400 pixels) but retained the left / right\nmargins and increased the top / bottom margins while changing the overall\nheight of the canvas to 270 pixels. The really cool thing that you can tell\nfrom this is that while we shrank the dimensions of the area that we had to\ndraw the graph in, it was still able to dynamically adapt the axes and line to\nfit properly (Although the x axis values got a bit squished. Don’t worry we’ll\nwork through that shortly). That is the really cool part of this whole\nbusiness. D3 is running in the background looking after the drawing of the\nobjects, while you get to concentrate on how the data looks without too much\nmaths!\n\nYou will have noticed that the axes have certainly not fared too well in this\ntransformation. This is because we are using absolutely no [styling or\nconfiguration for the axes](chap05.xhtml#axes) on this graph at all. We will\nhowever certainly be looking at this in more depth in subsequent chapters.\n\n#### Getting the Data\n\nWe’re going to jump forward a little bit here to the portion of the JavaScript\ncode that loads the data for the graph.\n\nI’m going to go out of the sequence of the code here, because if you know what\nthe data is that you’re using, it will make explaining some of the other\nfunctions much easier.\n\nThe section that grabs the data is this bit.\n\n    \n    \n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n      \n    // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n\nThere’s lots of different ways that we can get data into our web page and turn\nit into graphics. The method that we’ll want to use will probably depend more\non the format that the data is in than the mechanism we want to use for\nimporting.\n\nFor instance, if it’s only a few points of data we could include the\ninformation directly in the JavaScript.\n\nThat would make it look something like;\n\n    \n    \n    var data = [\n        {date:\"1-May-12\",close:\"58.13\"},\n        {date:\"30-Apr-12\",close:\"53.98\"},\n        {date:\"27-Apr-12\",close:\"67.00\"},\n        {date:\"26-Apr-12\",close:\"89.70\"},\n        {date:\"25-Apr-12\",close:\"99.00\"}\n    ];\n    \n\nThe format of the data shown above is called [JSON](chap11.xhtml#json)\n(JavaScript Object Notation) and it’s a great way to include data since it’s\neasy for humans to read what’s in there and it’s easy for computers to parse\nthe data out. For a brief overview of JSON there is a [separate section in the\n“Assorted Tips and Tricks Chapter”](chap11.xhtml#json) that may assist.\n\nBut if you’ve got a fair bit of data or if the data you want to include is\ndynamic and could be changing from one moment to the next, you’ll want to load\nit from an external source. That’s when we call on D3’s ‘Request’ functions.\n\n### Request Functions\n\nA ‘Request’ is a function that instructs the browser to reach out and grab\nsome data from somewhere. It could be stored locally (on the web server) or\nsomewhere out in the Internet. There are different types of requests depending\non the type of data you want to ingest. Each type of data is formatted with\ndifferent rules, so the different requests interpret those rules to make sure\nthat the data is returned to the D3 processing in a format that it\nunderstands. You could therefore think of the different ‘Requests’ as\ntranslators and the different data formats as being foreign languages.\n\nThe different types of data that can be requested by D3 are;\n\n  * **[text](https://github.com/d3/d3-request/blob/master/README.md#text)** : A plain old piece of text that has options to be encoded in a particular way.\n  * **[json](https://github.com/d3/d3-request/blob/master/README.md#json)** : This is the aforementioned JavaScript Object Notation.\n  * **[xml](https://github.com/d3/d3-request/blob/master/README.md#xml)** : Extensible Markup Language is a language that is widely used for encoding documents in a human readable forrm.\n  * **[html](https://github.com/d3/d3-request/blob/master/README.md#html)** : HyperText Markup Language is the language used for displaying web pages.\n  * **[csv](https://github.com/d3/d3-request/blob/master/README.md#csv)** : Comma Separated Values is a widely used format for storing data where plain text information is separated by (wait for it) commas.\n  * **[tsv](https://github.com/d3/d3-request/blob/master/README.md#tsv)** : Tab Separated Values is a widely used format for storing data where plain text information is separated by a tab-stop character.\n\nDetails on these ingestion methods and the formats for the requests are well\nexplained on the [D3 Wiki](https://github.com/mbostock/d3/wiki/Requests) page.\nIn this particular script we will look at the csv request method.\n\nNow, it’s important to note that this is not an exclusive list of what can be\ningested. If you’ve got some funky data in a weird format, you can still get\nit in, but you will most likely need to stand up a small amount of code\nsomewhere else in your page to do the conversion (we will look at this process\nwhen describing getting data from a MySQL database).\n\nBack to our request…\n\n    \n    \n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n      \n    // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n\nThe first line of that piece of code invokes the d3.csv request (`d3.csv`) and\nthen the function is pointed to the data file that should be loaded\n(`data.csv`). This is referred to as the ‘URL’ (Unique Resource Locator) of\nthe file. In this case the file is stored locally (in the same directory as\nthe `simple-graph.html` file), but the URL could just as easily point to a\nfile somewhere on the Internet.\n\nThe format of the data in the data.csv file looks a bit like this (although\nthe file is longer (about 26 data points));\n\n    \n    \n    date,close\n    1-May-12,58.13\n    30-Apr-12,53.98\n    27-Apr-12,67.00\n    26-Apr-12,89.70\n    25-Apr-12,99.00\n    \n\nThe ‘date’ and the ‘close’ heading labels are separated by a comma as are each\nsubsequent date and number. Hence the ‘comma separated values’ :-).\n\nThe next part is part of the coolness of JavaScript. With the request for the\nfile made, the script is told to carry out a function on the data (which will\nnow be called ‘data’).\n\n    \n    \n    function(error, data) {\n    \n\nThe function statement will catch any error that is generated and load the\ndata that is ingested as the array ‘data’. The following line ensures that any\nerrors that are generated are captured and ‘thrown’ to an appropriate ‘catch’\nblock (if it exists) in the function. If it doesn’t exist the program will\nterminate.\n\nThere are actually more things that get acted on as part of the function call\n(which we will examine soon), but the one we will consider here is contained\nin the following lines;\n\n    \n    \n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n      });\n    \n\nThis block of code ensures that all the values that are pulled out of the csv\nfile are set and formatted correctly. The first line declares that the data\narray called ‘data’ (confusingly) is being dealt with and tells the block of\ncode that, for each group within the ‘data’ array it should carry out a\nfunction on it. Furthermore, when it carries out the formatting of each part\nof the array, it should designate the equivalent of each row as being ‘d’.\n\n    \n    \n        data.forEach(function(d) { \n    \n\nThe information in the array can be considered as being stored in rows. Each\nrow consists of two values: one value for ‘date’ and another value for\n‘close’.\n\nThe function is pulling out values of ‘date’ and ‘close’ one row at a time.\n\nEach time (Get it? `forEach`?) it gets a value of ‘date’ and ‘close’ it\ncarries out the following operations;\n\n    \n    \n          d.date = parseTime(d.date);\n    \n\nFor each value of date being operated on (d.date), d3.js changes it into a\ndate format that is processed via a separate function ‘parseTime’. (The\n`parseTime` function is defined in a separate part of the script, and we will\nexamine that later.) For the moment, be satisfied that it takes the raw date\ninformation from the CSV file in each row and converts it into a format that\nD3 can recognise as a date/time. That value is then re-saved in the same\nvariable space.\n\nThe next line then sets the ‘close’ variable to a numeric value (if it isn’t\nalready) using the ‘+’ operator.\n\n    \n    \n          d.close = +d.close;\n    \n\nThis appears to be good practice when the format of the number being pulled\nout of the data may not mean that it is automagically recognised as a number.\nThis line will ensure that it is.\n\nAt the end of this section of code, we have gone out and picked up a file with\ndata in it of a particular type (comma separated values) and ensured that it\nis formatted in a way that the rest of the script can use correctly.\n\nNow, the astute amongst you will have noticed that in the first line of that\nblock of code (`d3.csv(\"data.csv\", function(error, data) {`) we opened a\nnormal bracket ( `(` ) and a curly bracket ( `{` ), but we never closed them.\nThat’s because they stay open until the very end of the file. That means that\nall those blocks that occur after the `d3.csv` bit are referenced to the\n`data` array. Or put another way, it uses the data in the `data` array to draw\nstuff!\n\nBut anyway, let’s get back to figuring what the code is doing by jumping back\nto the end of the margins block.\n\n#### Formatting the Date / Time.\n\nOne of the glorious things about the World is that we all do things a bit\ndifferently. One of those things is how we refer to [dates and\ntime](http://en.wikipedia.org/wiki/Date_format_by_country).\n\nIn my neck of the woods, it’s customary to write the date as day - month –\nyear. E.g 23-12-2012. But in the United States the more common format would be\n12-23-2012. Likewise, the data may be in formats that name the months or\nweekdays (E.g. January, Tuesday) or combine dates and time together (E.g.\n2012-12-23 15:45:32). So, if we were to attempt to try to load in some data\nand to try and get D3 to recognise it as date / time information, we really\nneed to tell it what format the date / time is in.\n\n### Does Time Matter?\n\nYou might be asking yourself “What’s the point?” All you want to do is give it\na number and it can sort it out somehow. Well, that is true, but if you want\nto really bring out the best in your data and to keep maximum flexibility in\nrepresenting it on the screen, you will want D3 to play to its strengths. And\none of those is being able to adjust dynamically with variable time values.\n\nTime for a little demonstration (see what I did there).\n\nWe will change our data.csv file so that it only includes two points. The\nfirst one and the last one with a separation of a month and a bit. It will\ntherefore look a little like this;\n\n    \n    \n    date,close\n    1-May-12,58.13\n    26-Mar-12,606.98\n    \n\nThe graph now looks like this;\n\n![Simple line graph](images/straightgraph.png) Simple line graph\n\nNothing too surprising here, a very simple graph (note the time scale on the x\naxis).\n\nNow we will change the later date in the data.csv file so that it is a lot\ncloser to the starting date;\n\n    \n    \n    date,close\n    29-Mar-12,58.13\n    26-Mar-12,606.98\n    \n\nSo, just a three day difference. Let’s see what happens.\n\n![Simple line graph over three days](images/straightgraph2.png) Simple line\ngraph over three days\n\nAhh…. Not only did we not have to make any changes to our JavaScript code, but\nit was able to recognise the dates were closer and fill in the intervening\ngaps with appropriate time / day values. Now, one more time for giggles.\n\nThis time we’ll stretch the interval out by a few years.\n\n    \n    \n    date,close\n    29-Mar-21,58.13\n    26-Mar-12,606.98\n    \n\nand the result is…\n\n![Simple line graph over several years](images/straightgraph3.png) Simple line\ngraph over several years\n\nHopefully that’s enough encouragement to impress upon you that formatting the\ntime is a _REALLY_ good thing to get right. Trust me, it will never fail to\nimpress :-).\n\nBack to formatting.\n\nThe line in the JavaScript that parses the time is the following;\n\n    \n    \n    var parseTime = d3.timeParse(\"%d-%b-%y\");\n    \n\nThis line is used when the `data.forEach(function(d)` portion of the code\n(that we looked at a couple of pages back) used `d.date = parseTime(d.date)`\nas a way to take a date in a specific format and to get it recognised by D3.\nIn effect it said “ _take this value that is supposedly a date and make it\ninto a value I can work with_ ”.\n\nThe function used is the `d3.timeParse(specifier)` function where the\nspecifier in this case is the mysterious combination of characters `%d-%b-%y`.\nThe good news is that these are just a combination of directives specific for\nthe type of date we are presenting.\n\nThe `%` signs are used as prefixes to each separate format type and the ‘`-`’\n(minus) signs are literals for the actual ‘`-`’ (minus) signs that appear in\nthe date to be parsed.\n\nThe `d` refers to a zero-padded day of the month as a decimal number [01,31].\n\nThe `b` refers to an abbreviated month name.\n\nAnd the `y` refers to the year (without the centuries) as a decimal number.\n\nIf we look at a subset of the data from the data.csv file we see that indeed,\nthe dates therein are formatted in this way.\n\n    \n    \n    1-May-12,58.13\n    30-Apr-12,53.98\n    27-Apr-12,67.00\n    26-Apr-12,89.70\n    25-Apr-12,99.00\n    \n\nThat’s all well and good, but what if your data isn’t formatted exactly like\nthat?\n\nGood news. There are multiple different formatters for different ways of\ntelling time and you get to pick and choose which one you want. Check out the\nTime Formatting page on the [D3 Wiki](https://github.com/d3/d3-time-\nformat/blob/master/README.md#locale_format) for the authoritative list and\nsome great detail, but the following is the list of currently available\nformatters (from the d3 wiki);\n\n  * %a - abbreviated weekday name.\n  * %A - full weekday name.\n  * %b - abbreviated month name.\n  * %B - full month name.\n  * %c - date and time, as “%a %b %e %H:%M:%S %Y”.\n  * %d - zero-padded day of the month as a decimal number [01,31].\n  * %e - space-padded day of the month as a decimal number [ 1,31].\n  * %H - hour (24-hour clock) as a decimal number [00,23].\n  * %I - hour (12-hour clock) as a decimal number [01,12].\n  * %j - day of the year as a decimal number [001,366].\n  * %m - month as a decimal number [01,12].\n  * %M - minute as a decimal number [00,59].\n  * %p - either AM or PM.\n  * %S - second as a decimal number [00,61].\n  * %U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].\n  * %w - weekday as a decimal number [0(Sunday),6].\n  * %W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].\n  * %x - date, as “%m/%d/%y”.\n  * %X - time, as “%H:%M:%S”.\n  * %y - year without century as a decimal number [00,99].\n  * %Y - year with century as a decimal number.\n  * %Z - time zone offset, such as “-0700”.\n  * There is also a a literal “%” character that can be presented by using double % signs.\n\nAs an example, if you wanted to input date / time formatted as a generic MySQL\n‘YYYY-MM-DD HH:MM:SS’ TIMESTAMP format the D3 parse script would look like;\n\n    \n    \n    parseTime = d3.timeParse(\"%Y-%m-%d %H:%M:%S\");\n    \n\n#### Setting Scales Domains and Ranges\n\nThis is another example where, if you set it up right, D3 will look after you\nforever.\n\n#### Scales, Ranges and the “Ah Ha!” moment.\n\nThe “Ah Ha!” moment for me in understanding ranges and scales was after\nreading Jerome Cukier’s great page on ‘[d3:scales and\ncolor](http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/)’. I\nthoroughly recommend you read it (and plenty more of the great work by Jerome)\nas he really does nail the description in my humble opinion. I will put my own\ndescription down here, but if it doesn’t seem clear, head on over to Jerome’s\npage.\n\nFrom our basic web page we have now moved to the section that includes the\nfollowing lines;\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n\nThe purpose of these portions of the script is to ensure that the data we\ningest fits onto our graph correctly. Since we have two different types of\ndata (date/time and numeric values) they need to be treated separately (but d3\nmanages them in almost the same way). To examine this whole concept of scales,\ndomains and ranges properly, we will also move slightly out of sequence and\n(in conjunction with the earlier scale statements) take a look at the lines of\nscript that occur later and set the domain. They are as follows;\n\n    \n    \n      // Scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nThe idea of scaling is to take the range of values of data that we have and to\nfit them into the space we have available.\n\nIf we have data that goes from 53.98 to 636.23 (as the data we have for\n‘close’ in our csv file does), but we have a graph that is 450 pixels high\n(`height = 500 - margin.top – margin.bottom;`) we clearly need to make an\nadjustment.\n\nNot only that. Even though our data goes from 53.98 to 636.23, that would look\nslightly misleading on the graph and it should really go from 0 to a bit over\n636.23. It sounds really complicated, so let’s simple it up a bit.\n\nFirst we make sure that any quantity we specify on the x axis fits onto our\ngraph.\n\n    \n    \n    var x = d3.scaleTime().range([0, width]);\n    \n\nHere we set our variable (`x`) that will tell D3 where to draw something on\nthe x axis. By using the `d3.scaleTime()` function we make sure that D3 knows\nto treat the values as date / time entities (with all their ingrained\npeculiarities). Then we specify the range that those values will cover\n(`.range`) and we specify the range as being from 0 to the width of our\ngraphing area (See? Setting those variables for margins and widths are\nstarting to pay off now!).\n\nThen we do the same for the Y axis.\n\n    \n    \n    var y = d3.scaleLinear().range([height, 0]);\n    \n\nThere’s a different function call (`d3.scaleLinear()`) but the `.range`\nsetting is still there. In the interests of drawing a (semi) pretty picture to\ntry and explain, hopefully this will assist;\n\n![Scaling the data to the graph size](images/scales1.png) Scaling the data to\nthe graph size\n\nI know, I know, it’s a little misleading because nowhere have we actually said\nto D3 this is our data from 53.98 to 636.23. All we’ve said is when we get the\ndata, we’ll be scaling it into this space.\n\nNow hang on, what’s going on with the `[height, 0]` part in y axis scale\nstatement? The astute amongst you will note that for the time scale we set the\nrange as `[0, width]` but for this one (`[height, 0]`) the values look\nbackwards.\n\nWell spotted.\n\nThis is all to do with how the screen is laid out and referenced. Take a look\nat the following diagram showing how the coordinates for drawing on your\nscreen work;\n\n![Coordinates that the browser expects](images/scales2.png) Coordinates that\nthe browser expects\n\nThe top left hand of the screen is the origin or 0,0 point and as we go left\nor down the corresponding x and y values increase to the full values defined\nby height and width.\n\nThat’s good enough for the time values on the x axis that will start at lower\nvalues and increase, but for the values on the y axis we’re trying to go\nagainst the flow. We want the low values to be at the bottom and the high\nvalues to be at the top.\n\nNo problem. We just tell D3 via the statement `y =\nd3.scaleLinear().range([height, 0]);` that the larger values (height) are at\nthe low end of the screen (at the top) and the low values are at the bottom\n(as you most probably will have guessed by this stage, the `.range` statement\nuses the format `.range([closer_to_the_origin, further_from_the_origin])`. So\nwhen we put the height variable first, that is now associated with the top of\nthe screen.\n\n![Coordinates with adjusted ranges](images/scales3.png) Coordinates with\nadjusted ranges\n\nWe’ve scaled our data to the graph size and ensured that the range of values\nis set appropriately. What’s with the domain part that was in this section’s\ntitle?\n\nCome on, you remember this little piece of script don’t you?\n\n    \n    \n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nWhile it exists in a separate part of the file from the scale / range part, it\nis certainly linked.\n\nThat’s because there’s something missing from what we have been describing so\nfar with the set up of the data ranges for the graphs. We haven’t actually\ntold D3 what the range of the data is. That’s also the reason this part of the\nscript occurs where it does. It is within the section where the data.csv file\nhas been loaded as ‘data’ and it’s therefore ready to use it.\n\nSo, the `.domain` function is designed to let D3 know what the scope of the\ndata will be. This is what is then passed to the scale function.\n\nLooking at the first part that is setting up the x axis values, it is saying\nthat the domain for the x axis values will be determined by the `d3.extent`\nfunction which in turn is acting on a separate function which looks through\nall the ‘date’ values that occur in the ‘data’ array. In this case the\n`.extent` function returns the minimum and maximum value in the given array.\n\n  * `function(d) { return d.date; }` returns all the ‘date’ values in ‘data’. This is then passed to…\n  * The `.extent` function that finds the maximum and minimum values in the array and then…\n  * The `.domain` function which returns those maximum and minimum values to D3 as the range for the x axis.\n\nPretty neat really. At first you might think it was overly complex, but\nbreaking the function down into these components allows additional\nfunctionality with differing scales, values and quantities. In short, don’t\nsweat it. It’s a good thing.\n\nThe x axis values are dates; so the domain for them is basically from the 26th\nof March 2012 till 1st of May 2012. The y axis is done slightly differently\n\n    \n    \n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nBecause the range of values desired on the y axis goes from 0 to the maximum\nin the data range, that’s exactly what we tell D3. The ‘0’ in the .domain\nfunction is the starting point and the finishing point is found by employing a\nseparate function that sorts through all the ‘close’ values in the ‘data’\narray and returns the largest one. Therefore the domain is from 0 to 636.23.\n\nLet’s try a small experiment. Let’s change the y axis domain to use the\n.extent function (the same way the x axis does) to see what it produces.\n\nThe JavaScript for the y domain will be;\n\n    \n    \n      y.domain(d3.extent(data, function(d) { return d.close; }));\n    \n\nYou can see apart from a quick copy paste of the internals, all I had to\nchange was the reference to ‘close’ rather than ‘date’.\n\nAnd the result is…\n\n![Graph using .extent for data values](images/scales4.png) Graph using .extent\nfor data values\n\nLook at that! The starting point for the y axis looks like it’s pretty much on\nthe 53.98 mark and the graph itself certainly touches the x axis where the\ndata would indicate it should.\n\nNow, I’m not really advocating making a graph like this since I think it looks\na bit nasty (and a casual observer might be fooled into thinking that the x\naxis was at 0). However, this would be a useful thing to do if the data was\nconcentrated in a narrow range of values that are quite distant from zero.\n\nFor instance, if I change the data.csv file so that the values are represented\nlike the following;\n\n![Concentrated data range graph](images/scales5.png) Concentrated data range\ngraph\n\nThen it kind of loses the ability to distinguish between values around the\nmedian of the data.\n\nBut, if I put in our magic .extent function for the y axis and redraw the\ngraph…\n\n![Expanded concentrated data range using .extent](images/scales6.png) Expanded\nconcentrated data range using .extent\n\nHow about that?\n\nThe same data as the previous graph, but with one simple piece of the script\nchanged and D3 takes care of the details.\n\n#### Adding data to the line function\n\nWe’re getting towards the end of our journey through the script now. The next\nstep is to associate the array ‘data’ with a new array that consists of a set\nof coordinates that we are going to plot.\n\nI’m aware that the statement above may be somewhat ambiguous. You would be\njustified in thinking that we already had the data stored and ready to go. But\nthat’s not _strictly_ correct.\n\n    \n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n\nWhat we have is data in a raw format, we have added pieces of code that will\nallow the data to be adjusted for scale and range to fit in the area that we\nwant to draw, but we haven’t actually taken our raw data and adjusted it for\nour desired coordinates. That’s what the code above does.\n\nThe main function that gets used here is the `d3.line()`\n[function](https://github.com/d3/d3-shape/blob/master/README.md#lines). This\nfunction uses accessor functions to store the appropriate information in the\nright area and in the case above they use the `x` and `y` accessors (that\nwould be the bits that are `.x` and `.y`). The `d3.line()` function is called\na ‘path generator’ and this is an indication that it can carry out some pretty\nclever things on its own accord. But in essence its job is to assign a set of\ncoordinates in a form that can be used to draw a line.\n\nEach time this line function is called on, it will go through the data and\nwill assign coordinates to ‘date’ and ‘close’ pairs using the ‘x’ and ‘y’\nfunctions that we set up earlier (which are responsible for scaling and\nsetting the correct range / domain).\n\nOf course, it doesn’t get the data all by itself, we still need to actually\ncall the valueline function with ‘data’ as the source to act on. But never\nfear, that’s coming up soon.\n\n#### Adding the SVG element.\n\nAs the title states, the next piece of script forms and adds the SVG element\nto the web page that D3 will then use to draw on.\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nSo what exactly does that all mean?\n\nWell D3 needs to be able to have a space defined for it to draw things. When\nyou define the space it’s going to use, you can also give the space you’re\ngoing to use an identifying name and attributes.\n\nIn the example we’re using here, we are ‘appending’ an [SVG\nelement](chap11.xhtml#svg) (an element designed for drawing graphics on) to\nthe `<body>` of the HTML page.\n\nIn human talk that means that on the web page and bounded by the `<body>` tag\nthat we saw in the HTML part, we will have an area to draw on. That area will\nbe ‘width’ plus the left and right margins wide and ‘height’ plus the top and\nbottom margins wide.\n\nWe also add a group element ‘g’ that is referenced to the top left corner of\nthe actual graph area on the canvas. ‘g’ is a grouping element in the sense\nthat it is normally used for grouping together several related elements. So in\nthis case those grouped elements will have a common reference.\n\n![Graph area and margins](images/margins.png) Graph area and margins\n\n(the image above is definitely not to scale, but I hope you get the general\nidea)\n\nInteresting things to note about the code. The `.attr(\"stuff in here\")` parts\nare attributes of the appended elements they are part of.\n\nFor instance;\n\n    \n    \n       .append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n    \n\ntells us that the ‘svg’ element has a “width” of width + margin.left +\nmargin.right and the “height” of height + margin.top + margin.bottom.\n\nLikewise…\n\n    \n    \n      .append(\"g\")\n        .attr(\"transform\",\n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\ntells us that the group element ‘g’ has been transformed by moving\n(translating) to the point margin.left, margin.top. Or to the top left of the\ngraph space proper. This way when we tell something to be drawn on our page,\nwe can use this reference point ‘g’ to make sure everything is in the right\nplace.\n\n#### Actually Drawing Something!\n\nUp until now we have spent a lot of time defining, loading and setting up.\nGood news! We’re about to finally draw something!\n\n##### Drawing the line\n\nWe jump lightly over some of the code that we have already explained and land\non the part that draws the line.\n\n    \n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n\nThis area occurs in the part of the code that has the data loaded (via the\n`d3.csv` block) and it’s ready for action.\n\nThe `svg.append(\"path\")` portion adds a new path element . A path element\nrepresents a shape that can be manipulated in lots of different ways (see more\nhere: <http://www.w3.org/TR/SVG/paths.html>).\n\nWe join our array of data (confusingly the array is _called_ ‘data’) to the\npath element with the `.data([data])` line. We could have used an alternative\nmethod here with a line that read `.datum(data)`. Both are completely valid to\nuse, but have different strengths.\n\n##### data vs datum.\n\n`data` takes the specified array and joins it to a selection of data. Joining\ndata allows for dynamic updating of the data via ‘update’, ‘enter’ and ‘exit’\nselections (more on these much later in the book).\n\n`datum` doesn’t join data to any existing array and instead the data will\nexist as static element. The advantage to this is that it allows access to\nHTML5 custom data attributes.\n\nFor more detail on the differences, it is worth reading the [documentation of\njoining\ndata](https://github.com/d3/d3-selection/blob/master/README.md#joining-data).\n\nThe next line down applies the ‘line’ styles from the CSS section that we\n[experimented with earlier](chap04.xhtml#css).\n\nIn the final line (`.attr(\"d\", valueline);`), we add the attribute ‘d’ to the\npath with the data from the `valueline` function that we had declared earlier.\n\nThe `d` attribute is a [mini language](https://developer.mozilla.org/en-\nUS/docs/Web/SVG/Attribute/d) which contains a series of commands for movement\nthat will describe a path in SVG. These commands are written in a shorthand of\nsingle letters such as M-moveto, Z-closepath, L-lineto, C-curveto. The good\nnews is that D3 takes care of the heavy lifting in putting together this set\nof commands.\n\n##### Drawing the Axes\n\nThen we get to draw in the axes;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nBoth axes start by appending a group element (‘g’). Each axis will be bound to\nits own element.\n\nThe y axis can be drawn from the default position at the origin of the svg\nelement (which we recall is 0,0 at the top left of the graph). However the x\naxis needs to be moved to the bottom of our graph.\n\nOn the x axis, we have a transform statement (`.attr(\"transform\",\n\"translate(0,\" + height + \")\")`). If we want our x axis to be on the bottom of\nthe graph, we need to move (transform) it to the bottom by a set amount. The\nset amount in this case is the height of the graph proper (`height`). So, for\nthe point of demonstration we will remove the transform line and see what\nhappens;\n\n![x axis transformed to the top of the graph](images/axistransformed.png) x\naxis transformed to the top of the graph\n\nYep, pretty much as anticipated.\n\nThe last part of the two sections of script ( `.call(d3.axisBottom(x));` and\n`.call(d3.axisLeft(y));` ) call the D3 x and y axis functions respectively and\ninitiate the drawing action.\n\nThe method by which D3 orientates the axes is relatively self-evident and\nthere are four options;\n\n  * `.axisTop`: An axis with values and ticks drawn above a horizontal axis.\n  * `.axisRight`: An axis with values and ticks drawn to the right of a vertical axis.\n  * `.axisBottom`: An axis with values and ticks drawn below a horizontal axis.\n  * `.axisLeft`: An axis with values and ticks drawn to the left of a vertical axis.\n\nJust to illustrate the point, we can reverse the orientation of `.axisBottom`\nto `.axisTop` and `.axisLeft` to `.axisRight` to see what it looks like;\n\n![x and y axes reversed](images/axesreversed.png) x and y axes reversed\n\nThere we go.\n\nIt is worth stating that the axes as presented for this simple graph are very\nmuch a ‘straight out of the box’ configuration. [Later in the\nbook](chap05.xhtml#axes) we will look at options for configuring and styling\naxes in more depth.\n\n### Wrap Up\n\nWell that’s it. In theory, you should now be a complete D3 ninja.\n\nOK, perhaps a slight exaggeration. In fact there is a strong possibility that\nthe information I have laid out here is at best borderline useful and at worst\nladen with evil practices and gross inaccuracies.\n\nBut look on the bright side. Irrespective of the nastiness of the way that any\nof it was accomplished or the inelegance of the code, if the picture drawn on\nthe screen is pretty, you can walk away with a smile. :-)\n\nThis section concludes a very basic description of one type of a graphic that\ncan be built with D3. We will look at adding value to it in subsequent\nchapters.\n\nI’ve said it before and I’ll say it again. This is not a how-to for learning\nD3. This is how I have managed to muddle through and achieve what I wanted to\ndo. If some small part of it helps you. All good. Those with a smattering of\nknowledge of any of the topics I have butchered above (or below) are fully\njustified in feeling a large degree of righteous indignation. To those I say,\nplease feel free to amend where practical and possible, but please bear in\nmind this was written from the point of view of someone with no experience in\nthe topic and therefore try to keep any instructions at a level where a new\nentrant can step in :-).\n\n\n## Things we can do with the simple graph\n\nThe following headings in this section are intended to be a list of relatively\nsimple ‘block’ type improvements that you can do to your graph to add\nfunctionality. The idea is to be able to use the simple graph that was used\nfor the explanation of how D3 worked and just slot in code to add\nfunctionality (let’s hope it works for you :-)).\n\n### Setting up and configuring the Axes\n\nAs referenced in the chapter where we initially developed our simple graph,\nthe axes of that graph had no styling or configuration changes made to them at\nall. One of the results of this is that the font size, type, number of ticks\nand the way that the values are represented is very much at the default\nsettings. This means that when we change our initial graph…\n\n![Basic Graph](images/basicgraph.png) Basic Graph\n\n… and compress the margins or graph size we end up with axes that are not\nreally suitable for the purpose;\n\n![The effect of changing the margins](images/squishedgraph.png) The effect of\nchanging the margins\n\nLuckily, the D3 axis component has a wide range of configuration options and\nwe can make changes simply via either the CSS styling or in the JavaScript\ncode.\n\n#### Change the text size\n\nThe first thing that we will change is the text size for the axes. The default\nsize (built into D3) is 10px with the font type of sans-serif.\n\nThere are a couple of different ways that we could change the font size and\neither one is valid. The first way is to specify the font as a style when\ndrawing an individual axis. To do this we simply add in a font style as\nfollows;\n\n    \n    \n      svg.append(\"g\")\n          .style(\"font\", \"14px times\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n\nThis will increase the x axis font size to 14px and change the font type to\n‘times’. Just like this;\n\n![X axis 14px, times](images/axes-01.png) X axis 14px, times\n\nThere are a few things to notice here.\n\nFirstly, we do indeed have a larger font and it appears to be of the type\n‘times’. Yay!\n\nSecondly, the y axis has remained as 10px sans-serif (which is to be expected\nsince we only added the style to the x axis code block)\n\nLastly, the number of values represented on the x axis has meant that with the\nincrease in font size there is some overlapping going on. We will deal with\nthat shortly…\n\nThe addition of the styling for the x axis has been successful and in a\nsituation where only one element on a page is being adjusted, this is a\nperfectly valid way to accomplish the task. However, in this case we should be\ninterested in changing the font on both the x _and_ y axes. We could do this\nby adding a duplicate style line to the y axis block, but we have a slightly\nbetter way of accomplishing the task by declaring the style in the HTML style\nblock at the start of the code and then applying the same style to both\nblocks.\n\nIn the `<style> ... </style>` section at the start of the file add in the\nfollowing line;\n\n    \n    \n    .axis { font: 14px sans-serif; }\n    \n\nThis will set the font to 14px sans-serif (I prefer this to ‘times’) for\nanything that has the `axis` class applied to it. All we have to do then is to\ntell our x and y axes blocks to use the `axis` class as an attribute. We can\ndo this as follows;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .call(d3.axisLeft(y));\n    \n\nIt could be argued that this doesn’t really conserve more code, but in my\nhumble opinion it adds a more elegant way to alter styling in this case.\n\nThe end result now looks like the following;\n\n![Both axes 14px, sans-serif](images/axes-02.png) Both axes 14px, sans-serif\n\n#### Changing the number of ticks on an axis\n\nNow we shall address the other problem that cropped up when we changed the\nsize of the text. We have overlapping values on the x axis.\n\n![Overlapping axis values](images/axes-03.png) Overlapping axis values\n\nIf I was to be brutally honest, I think that the number of values (ticks) on\nthe graph is a bit too many. The format of the values (especially on the x\naxis) is too wide and this type of overlap was bound to happen eventually.\n\nGood news. D3 has got us covered.\n\nThe [axis component](https://github.com/d3/d3-axis) includes a function to\nspecify the number of ticks on an axis. All we need to do is add in the\nfunction and the number of ticks like so;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .ticks(5));\n    \n\nWith the end result looking like this;\n\n![Nicely spaced axis values](images/axes-04.png) Nicely spaced axis values\n\nWe can see that D3 has picked tick values that seem nice and logical. There’s\none that starts on the 1st of April that’s just labelled ‘April’ and they go\nat a nice interval of one week for the subsequent ticks. Nice.\n\nHopefully you just did a quick count across the bottom of the previous graph\nand went “Yep, five ticks. Spot on”. Well done if you did, but there’s a\nlittle bit of a sneaky trick up D3’s sleeve with the number of ticks on a\ngraph axis.\n\nFor instance, here’s what the graph looks like when the `.ticks(5)` value is\nchanged to `.ticks(4)`.\n\n![Five ticks on the x axis](images/axes-04.png) Five ticks on the x axis\n\nEh? Hang on. Isn’t that some kind of mistake? There are still five ticks. Yep,\nsure is! But wait… we can keep dropping the ticks value till we get to two and\nit will still be the same. At `.ticks(2)` though, we finally see a change.\n\n![Two ticks on the x axis](images/axes-05.png) Two ticks on the x axis\n\nHow about that? At first glance that just doesn’t seem right, then you have a\nbit of a think about it and you go “Hmm… When there were 5 ticks, they were\nseparated by a week each, and that stayed that way till we got to a point\nwhere it could show a separation of a month”.\n\nD3 is making a command decision for you as to how your ticks should be best\ndisplayed. This is great for simple graphs and indeed for the vast majority of\ngraphs. Like all things related to D3, if you really need to do something\nbespoke, it will let you if you understand enough code.\n\nThe following is the\n[list](https://github.com/d3/d3-scale/blob/master/README.md#time_ticks) of\ntime intervals that D3 will consider when setting automatic ticks on a time\nbased axis;\n\n  * 1, 5, 15 and 30-second.\n  * 1, 5, 15 and 30-minute.\n  * 1, 3, 6 and 12-hour.\n  * 1 and 2-day.\n  * 1-week.\n  * 1 and 3-month.\n  * 1-year.\n\nAnd yes. If you increase the number of ticks, you need to wait till you get to\n10 before they change to an axis with interval of two days. And yes, the\noverlap is still there;\n\n![Still overlapping axis values](images/axes-03a.png) Still overlapping axis\nvalues\n\nIf we do a quick count we should also notice that we have 19 ticks!\n\nThe question should be asked. Can we specify our own intervals? Great\nquestion! Yes we can.\n\nWhat we need to do is to use another D3 trick and specify an exact interval\nusing the [d3 time component](https://github.com/d3/d3-time#d3-time). In our\nparticular situation all we need to do is specify an interval inside the\n`.ticks` function. Specifically for an interval of 4 days for example we would\nuse something like;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .ticks(d3.timeDay.every(4)));\n    \n\nHere we use the `timeDay` unit of ‘days’ and specify an interval of 4 days.\n\nThe graph will subsequently appear as follows;\n\n![Axis ticks at 4 day intervals](images/axes-06.png) Axis ticks at 4 day\nintervals\n\nIntervals have a number of [standard\nunits](https://github.com/d3/d3-time#intervals) (including UTC time) such as;\n\n  * `d3.timeMillisecond` : Milliseconds\n  * `d3.timeSecond` : Seconds\n  * `d3.timeMinute` : Minutes\n  * `d3.timeHour` : Hours\n  * `d3.timeDay` : Days\n  * `d3.timeWeek` : This is an alias for `d3.timeSunday` for a week\n  * `d3.timeSunday` : A week starting on Sunday\n  * `d3.timeMonday` : A week starting on Monday\n  * `d3.timeTuesday` : A week starting on Tuesday\n  * `d3.timeWednesday` : A week starting on Wednesday\n  * `d3.timeThursday` : A week starting on Thursday\n  * `d3.timeFriday` : A week starting on Friday\n  * `d3.timeSaturday` : A week starting on Saturday\n  * `d3.timeMonth` : Months starting on the 1st of the month\n  * `d3.timeYear` : Years Starting on the 1st day of the year\n\nBut what if we really wanted that two day separation of ticks without the\noverlap?\n\n#### Rotating text labels for a graph axis\n\nAn answer to the problem of overlapping axis values might be to rotate the\ntext to provide more space.\n\nThe answer I found most usable was provided by Aaron Ward on [Google\nGroups](https://groups.google.com/forum/#!msg/d3-js/CRlW0ISbOy4/1sgrE5uS5ysJ).\n\n#### There might be a better way\n\nNow, I’ll put a bit of a caveat on this solution to the rotating axis label\nproblem. It looks like it’s worked well, but I’ve only carried out this\ninvestigation to the point where I’ve got something that looks like it’s a\nsolution. There may be better or more elegant ways of carrying out the same\ntask, so let Google be your friend if it doesn’t appear to be working out for\nyou.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/3c040800ff6457717cca586ae9547dbf) or\nin the code samples bundled with this book (simple-axis-rotated.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3c040800ff6457717cca586ae9547dbf).\n\nThe first substantive change would be a little housekeeping. Because we are\ngoing to be rotating the text at the bottom of the graph, we are going to need\nsome extra space to fit in our labels. So we should change our bottom margin\nappropriately.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 70, left: 50},\n    \n\nI found that 70 pixels was sufficient.\n\nThe remainder of our changes occur in the block that draws the x axis.\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x).ticks(10))\n          .selectAll(\"text\")\t\n            .style(\"text-anchor\", \"end\")\n            .attr(\"dx\", \"-.8em\")\n            .attr(\"dy\", \".15em\")\n            .attr(\"transform\", \"rotate(-65)\");\t\n    \n\nIt’s pretty standard until the `.call(d3.axisBottom(x).ticks(10))` portion of\nthe code. Here we remove the semicolon that was there so that the block\ncontinues with its function.\n\nThen we select all the text elements that comprise the x axis with the\n`.selectAll(\"text\")`. From this point onwards, we are operating on the text\nelements associated with the x axis. In effect; the following four ‘actions’\nare applied to the text labels.\n\nThe `.style(\"text-anchor\", \"end\")` line ensures that the text label has the\nend of the label ‘attached’ to the axis tick. This has the effect of making\nsure that the text rotates about the end of the date. This makes sure that the\ntext all ends up at a uniform distance from the axis ticks.\n\nThe `dx` and `dy` attribute lines move the end of the text just far enough\naway from the axis tick so that they don’t crowd it and not too far away so\nthat it appears disassociated. This took a little bit of fiddling to ‘look’\nright and you will notice that I’ve used the ‘em’ units to get an adjustment\nif the size of the font differs.\n\nThe final action is kind of the money shot.\n\nThe transform attribute applies itself to each text label and rotates each\nline by -65 degrees. I selected -65 degrees just because it looked OK. There\nwas no deeper reason.\n\nThe end result then looks like the following;\n\n![Rotated x axis labels](images/rotate02.png) Rotated x axis labels\n\nThis was a surprisingly difficult problem to find a solution to that I could\neasily understand (well done Aaron). That makes me think that there are some\nfar deeper mysteries to it that I don’t fully appreciate that could trip this\nsolution up. But in lieu of that, enjoy!\n\n#### Formatting a date / time axis with specified values\n\nOK then. We’ve been very clever in rotating our text, but you will notice that\nD3 has used its own good judgement as to what format the days / date will be\nrepresented as.\n\nNot that there’s anything wrong with it, but what if we want to put a specific\nformat of date / time nomenclature as axis labels?\n\nNo problem. D3 to the rescue again!\n\nThis is actually a pretty easy thing to do, but there are plenty of options\nfor the formatting, so the only really tricky part is deciding what to put\nwhere.\n\nBut, before we start doing anything we are going to have to expand our bottom\nmargin even more than we did with the rotate the axis labels feature.\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 100, left: 50},\n    \n\nThat should see us right.\n\nNow the simple part :-). Changing the format of the label is as simple as\ninserting the `tickFormat` command into the xAxis declaration and including a\nD3 [time formatting](https://github.com/d3/d3-time-format) function a little\nlike this;\n\n    \n    \n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .tickFormat(d3.timeFormat(\"%Y-%m-%d\")))\n          .selectAll(\"text\")\t\n            .style(\"text-anchor\", \"end\")\n            .attr(\"dx\", \"-.8em\")\n            .attr(\"dy\", \".15em\")\n            .attr(\"transform\", \"rotate(-65)\");\n    \n\nThe `timeFormat` formatters are the same as those we used when parsing our\ntime values when reading our data with the simple graph;\n\n  * %a - abbreviated weekday name.\n  * %A - full weekday name.\n  * %b - abbreviated month name.\n  * %B - full month name.\n  * %c - date and time, as “%a %b %e %H:%M:%S %Y”.\n  * %d - zero-padded day of the month as a decimal number [01,31].\n  * %e - space-padded day of the month as a decimal number [ 1,31].\n  * %H - hour (24-hour clock) as a decimal number [00,23].\n  * %I - hour (12-hour clock) as a decimal number [01,12].\n  * %j - day of the year as a decimal number [001,366].\n  * %m - month as a decimal number [01,12].\n  * %M - minute as a decimal number [00,59].\n  * %p - either AM or PM.\n  * %S - second as a decimal number [00,61].\n  * %U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].\n  * %w - weekday as a decimal number [0(Sunday),6].\n  * %W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].\n  * %x - date, as “%m/%d/%y”.\n  * %X - time, as “%H:%M:%S”.\n  * %y - year without century as a decimal number [00,99].\n  * %Y - year with century as a decimal number.\n  * %Z - time zone offset, such as “-0700”.\n  * There is also a literal “%” character that can be presented by using double % signs.\n\nSo the format we have specified (`%Y-%m-%d`) will show the year with the\ncentury as a decimal number (`%Y`) followed by a hyphen, followed by a zero\npadded month as a decimal number (`%m`) followed by another hyphen and lastly\nthe day as a zero padded day of the month (`%d`).\n\nThe end result looking a bit like this;\n\n![Rotated x axis labels](images/axes-07.png) Rotated x axis labels\n\nAn example using this code can be found on\n[github](https://gist.github.com/d3noob/0e276dc70bb9184727ee47d6dd06e915) or\nin the code samples bundled with this book (simple-axis-rotated-formatted.html\nand data.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/0e276dc70bb9184727ee47d6dd06e915). The\nexample code also includes the rotating of the x axis text as described in the\nprevious section.\n\nSo how about we try something a little out of the ordinary (extreme)?\n\nHow about the full weekday name (`%A`), the day (`%d`), the full month name\n(`%B`) and the year (`%Y`) as a four digit number?\n\n    \n    \n      svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x)\n                  .tickFormat(d3.timeFormat(\"%A %d %B %Y\")))\n          .selectAll(\"text\")\t\n            .style(\"text-anchor\", \"end\")\n            .attr(\"dx\", \"-.8em\")\n            .attr(\"dy\", \".15em\")\n            .attr(\"transform\", \"rotate(-65)\");\n    \n\nWe will also need some extra space for the bottom margin, so how about 170?\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 170, left: 50},\n    \n\nAnd….\n\n![Extreme format change for the x axis labels](images/axes-08.png) Extreme\nformat change for the x axis labels\n\nOh yeah… When axis ticks go bad…\n\nBut seriously, that does work as a pretty good example of the flexibility\navailable.\n\n### Adding Axis Labels\n\nWhat’s the first thing you get told at school when drawing a graph?\n\n“ _Always label your axes!_ ”\n\nSo, time to add a couple of labels!\n\nWe’ll start with our default code for our simple graph. The full code for this\ncan be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\n**Preparation** : Because we’re going to be adding labels to the bottom and\nleft of the graph we need to increase the bottom and left margins. Changes\nlike the following should suffice;\n\n    \n    \n    var margin = {top: 20, right: 20, bottom: 50, left: 70},\n    \n\n#### The x axis label\n\nFirst things first (because they’re done slightly differently), the x axis. If\nwe begin by describing what we want to achieve, it may make the process of\nimplementing a solution a little more logical.\n\nWhat we want to do is to add a simple piece of text under the x axis and in\nthe centre of the total span. Wow, that does sound easy.\n\nAnd it is, but there are different ways of accomplishing it, and I think I\nshould take an opportunity to demonstrate them. Especially since one of those\nways is a BAD idea.\n\nLets start with the bad idea first :-).\n\nThis is the code we’re going to add to the simple line graph script;\n\n    \n    \n      // text label for the x axis\n      svg.append(\"text\")             \n          .attr(\"x\", 480 )\n          .attr(\"y\",  475 )\n          .style(\"text-anchor\", \"middle\")\n          .text(\"Date\");\n    \n\nWe will put it in between the blocks of script that add the x axis and the y\naxis.\n\n    \n    \n      // Add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // PUT THE NEW CODE HERE!\n    \n      // Add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nBefore we describe what’s happening, let’s take a look at the result;\n\n![Date label on x axis](images/date01.png) Date label on x axis\n\nWell, it certainly did what it was asked to do. There’s a ‘Date’ label as\nadvertised! (Yes, I know it’s not pretty.) Let’s describe the code and then\nwork out why there’s a better way to do it.\n\n    \n    \n      // text label for the x axis\n      svg.append(\"text\")             \n          .attr(\"x\", 480 )\n          .attr(\"y\",  475 )\n          .style(\"text-anchor\", \"middle\")\n          .text(\"Date\");\n    \n\nThe first line appends a “text” element to our svg element. There is a lot\nmore to learn about “text” elements at the home of the [World Wide Web\nConsortium (W3C)](http://www.w3.org/TR/SVG/text.html#TextElement). The next\ntwo lines ( `.attr(\"x\", 480 ) and .attr(\"y\", 475 )` ) set the attributes for\nthe x and y coordinates to position the text on the svg.\n\nThe second last line (`.style(\"text-anchor\", \"middle\")`) ensures that the text\n‘style’ is such that the text is centre aligned and therefore remains nicely\ncentred on the x, y coordinates that we send it to.\n\nThe final line (`.text(\"Date\");`) adds the actual text that we are going to\nplace.\n\nThat seems really simple and effective and it is. However, the bad part about\nit is that we have hard coded the location for the date into the code. This\nmeans if we change any of the physical aspects of the graph, we will end up\nhaving to re-calculate and edit our code. And we don’t want to do that.\n\nHere’s an example. If I decide that I would prefer to decrease the height of\nthe graph by editing the line here;\n\n    \n    \n        height = 500 - margin.top - margin.bottom;\n    \n\nand making the height 490 pixels;\n\n    \n    \n        height = 490 - margin.top - margin.bottom;\n    \n\nThe result is as follows;\n\n![Hard coded Date label](images/date02.png) Hard coded Date label\n\n_EVERYTHING_ about the graph has adjusted itself, except our nasty, hard coded\n‘Date’ label which has been cruelly cut off. This is far from ideal and can be\neasily fixed by using the variables that we set up ever so carefully earlier.\n\nSo, instead of;\n\n    \n    \n          .attr(\"x\", 480 )\n          .attr(\"y\",  475 )\n    \n\nlets let our variables do the walking and use;\n\n    \n    \n          .attr(\"x\", width / 2 )\n          .attr(\"y\",  height + margin.top + 20)\n    \n\nSo with this code we tell the script that the ‘Date’ label will always be\nhalfway across the width of the graph (no matter how wide it is) and at the\nbottom of the graph with respect to its height plus the top margin and 20\npixels (as a fixed offset) (remember it uses a coordinates system that\nincreases from the top down).\n\nThe end result of using variables is that if I go to an extreme of changing\nthe height and width of my graph to;\n\n    \n    \n        width = 560 - margin.left - margin.right,\n        height = 300 - margin.top - margin.bottom;\n    \n\nWe still finish up with an acceptable result;\n\n![Auto adjusting Date label](images/date03.png) Auto adjusting Date label\n\nWell, for the label position at least :-).\n\nSo the changes to using variables is just a useful lesson that variables rock\nand mean that you don’t have to worry about your graph staying in relative\nshape while you change the dimensions. The astute readers amongst you will\nhave learned this lesson very early on in your programming careers, but it’s\nnever a bad idea to make sure that users that are unfamiliar with the concept\nhave an indicator of why it’s a good idea.\n\nNow the third method that I mentioned at the start of our x axis odyssey. This\nis not mentioned because it’s any better or worse way to implement your script\n(The reason that I say this is because I’m not sure if it’s better or worse.)\nbut because it’s sufficiently different to make it look confusing if you\ndidn’t think of it in the first place.\n\nSo, we’ll take our marvellous coordinates code;\n\n    \n    \n          .attr(\"x\", width / 2 )\n          .attr(\"y\",  height + margin.top + 20))\n    \n\nAnd replace it with a single (longer) line;\n\n    \n    \n          .attr(\"transform\",\n                \"translate(\" + (width/2) + \" ,\" + \n                               (height + margin.top + 20) + \")\")\n    \n\nThis uses the `\"transform\"` attribute to move (translate) the point to place\nthe ‘Date’ label to exactly the same spot that we’ve been using for the other\ntwo examples (using variables of course).\n\n### Why does that line look odd?\n\nThe `\"translate”` function is done in a ‘translate(x,y)’ style but it is put\non the page in such a way that the verbatim pieces that get passed back are in\nspeech marks and the variables are in the clear (in a manner of speaking).\nThat’s why the comma is in speech marks. Additionally, the variables are\ncontained within plus signs. I make the assumption that this is a designator\nfor ‘areas where there is variable action going on’. The end result is that if\nyou try to do some maths in that area with a plus sign, it does not appear to\nwork (or at least it didn’t for me). That’s why I put the variable for ( `+\n(height + margin.top + 20) +` ) in parenthesis (then I thought I should make\nthe `+ (width / 2) +` part look the same, but actually you can get away\nwithout them there).\n\n#### The y axis label\n\nSo, that’s the x axis label. Time to do the y axis. The code we’re going to\nuse looks like this;\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"transform\", \"rotate(-90)\")\n          .attr(\"y\", 0 - margin.left)\n          .attr(\"x\",0 - (height / 2))\n          .attr(\"dy\", \"1em\")\n          .style(\"text-anchor\", \"middle\")\n          .text(\"Value\"); \n    \n\nFor the sake of neatness we will put the piece of code in a nice logical spot\nand this would be following the block of code that added the y axis (but\nbefore the closing curly bracket)\n\n    \n    \n      // Add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n      // PUT THE NEW CODE HERE!\n    \n    });\n    \n\nAnd the result looks like this;\n\n![y axis label with rotation!](images/value01.png) y axis label with rotation!\n\nThere we go, a label for the y axis that is nicely centred and (gasp!) rotated\nby 90 degrees! Woah, does the leetness never end! (No. No it does not.)\n\nSo, how do we get to this incredible result?\n\nThe first thing we do is the same as for the x axis and append a text element\nto our svg element (`svg.append(\"text\")`).\n\nThen things get interesting.\n\n    \n    \n          .attr(\"transform\", \"rotate(-90)\")\n    \n\nBecause that line rotates everything by -90 degrees. While it’s obvious that\nthe text label ‘Value’ has been rotated by -90 degrees (from the picture), the\nfollowing lines of code show that we also rotated our reference point (which\ncan be a little confusing).\n\n    \n    \n          .attr(\"y\", 0 - margin.left)\n          .attr(\"x\",0 - (height / 2))\n    \n\nLet’s get graphical to illustrate how this works;\n\n![Reference point pre-rotation](images/value02.png) Reference point pre-\nrotation\n\nHere’s our starting position, with x,y in the 0,0 coordinate of the graph\ndrawing area surrounded by the margins.\n\nWhen we apply a -90 degrees transform we get the equivalent of this;\n\n![Reference point after rotation](images/value03.png) Reference point after\nrotation\n\nHere the 0,0 coordinate has been shifted by -90 degrees and the x,y\ndesignations are flipped so that we now need to tell the script that we’re\nmoving a ‘y’ coordinate when we would have otherwise been moving ‘x’.\n\nHence, when the script runs…\n\n    \n    \n          .attr(\"y\", 0 - margin.left)\n    \n\n… we can see that this is moving the x position to the left from the new 0\ncoordinate by the margin.left value.\n\nLikewise when the script runs…\n\n    \n    \n          .attr(\"x\",0 - (height / 2))\n    \n\n… this is actually moving the y position from the new 0 coordinate halfway up\nthe height of the graph area.\n\nI will be the first to admit that this does seem a little confusing. But\nhere’s the good part. You really don’t need to understand it completely.\nSimply do what I did when I saw the code. Play with it a bit till you get the\nresult you were looking for. If that means putting in some hard coded numbers\nand incrementing them to see which way is the new ‘up’. Good! Once you work it\nout, then work out how to get the right variable expression in there and\nyou’re set.\n\nIn the worst case scenario, simply use the code blocks as shown here and leave\nwell enough alone :-).\n\nRight, we’re not quite done yet. The following line has the effect of shifting\nthe text slightly to the right.\n\n    \n    \n          .attr(\"dy\", \"1em\")\n    \n\nFirstly the reason we do this is that our previous translation of coordinates\nmeans that when we place our text label it sits exactly on the line of 0 –\nmargin.left. But in this case that takes the text to the other side of the\nline, so it actually sits just outside the boundary of the svg element.\n\nThe `\"dy\"` attribute is another coordinate adjustment move, but this time a\nrelative adjustment and the “1em” is a unit of measure that equals exactly one\nunit of the currently specified [text point\nsize](http://en.wikipedia.org/wiki/Em_\\(typography\\)). So what ends up\nhappening is that the ‘Value’ label gets shifted to the right by exactly the\nheight of the text, which neatly places it exactly on the edge of the canvas.\n\nThe two final lines of this part of the script are the same as for the x axis.\nThey make sure the reference point is aligned to the centre of the text\n(`.style(\"text-anchor\", \"middle\")`) and then it prints the text\n(`.text(\"Value\");`). There, that wasn’t too painful.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/23e42c8f67210ac6c678db2cd07a747e) or\nin the code samples bundled with this book (axis-labels.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/23e42c8f67210ac6c678db2cd07a747e).\n\n### How to add a title to your graph\n\nIf you’ve read through the [adding the axis labels](chap05.xhtml#axislabels)\nsection most of this will come as no surprise.\n\nWhat we want to do to add a title to the graph is to add a text element (just\na few words) that will appear above the graph and centred left to right.\n\nWe’ll start with our default code for our simple graph. The full code for this\ncan be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\n**Preparation** : Because we’re going to be adding a title to the top of the\ngraph we need to increase the top margin. Changes like the following should\nsuffice;\n\n    \n    \n    var margin = {top: 40, right: 20, bottom: 50, left: 70},\n    \n\nTo add the title this is the code we’re going to add to the simple line graph\nscript;\n\n    \n    \n      // add a title\n      svg.append(\"text\")\n          .attr(\"x\", (width / 2))\t\t\t\t\n          .attr(\"y\", 0 - (margin.top / 2))\n          .attr(\"text-anchor\", \"middle\")\t\n          .style(\"font-size\", \"20px\") \n          .style(\"text-decoration\", \"underline\") \t\n          .text(\"Value vs Date Graph\");\n    \n\nAnd the end result will look like this;\n\n![Basic graph with title](images/title01.png) Basic graph with title\n\nA nice logical place to put the block of code would be towards the end of the\nJavaScript. In fact I would put it as the last element we add. So here;\n\n    \n    \n      // add the Y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n      // PUT THE NEW CODE HERE!\n    \n    });\n    \n\nNow since the vast majority of the code for this block is a regurgitation of\nthe axis labels code, I don’t want to revisit that and bloat up this document\neven more, so I will direct you [back to that\nsection](chap05.xhtml#axislabels) if you need to refresh yourself on any\nparticular line. But….. There are a couple of new ones in there which could\nbenefit from a little explanation.\n\nBoth of them are style descriptors and as such their job is to apply a very\nspecific style to this element.\n\n    \n    \n            .style(\"font-size\", \"20px\") \n            .style(\"text-decoration\", \"underline\") \t\n    \n\nWhat they do is pretty self explanatory. Make the text a specific size and\nunderline it. But what is perhaps slightly more interesting is that we have\nthis declaration in the JavaScript code and not in the CSS portion of the\nfile.\n\nStrictly speaking, this is the sort of thing that would be placed in the\n`<style>` section of the HTML code, but in this case, since it is only going\nto be used once, we shouldn’t feel too bad putting it here.\n\n### Change a line chart into a scatter plot\n\nConfession time.\n\nI didn’t actually intend to add in a section with a scatter plot in it because\nI thought it would be;\n\n  1. tricky\n  2. not useful\n  3. all of the above\n\nI was wrong on all counts.\n\nI did want to have a scatter plot, because I wanted to display tool tips, but\nthis is too neat to ignore. It was literally a 5 minute job, 3 minutes of\nwhich was taken up by going to the [d3 gallery on the\nwiki](https://github.com/mbostock/d3/wiki/Gallery) and ogling at the cool\nstuff there before snapping out of it and going to the [scatter plot\nexample](http://bl.ocks.org/3887118).\n\nAll you need to do is take the [simple graph](chap04.xhtml#simplegraph)\nexample file. The full code for this can be found on\n[github](https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0) or\nin the code samples bundled with this book (simple-graph.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\nWe then slot the following block in between the ‘Add the valueline path’ and\nthe ‘add the x axis’ blocks.\n\n    \n    \n      // Add the scatterplot\n      svg.selectAll(\"dot\")\n          .data(data)\n        .enter().append(\"circle\")\n          .attr(\"r\", 5)\n          .attr(\"cx\", function(d) { return x(d.date); })\n          .attr(\"cy\", function(d) { return y(d.close); });\n    \n\nAnd you will get…\n\n![A scatter plot! \\(with a line\\)](images/scatter01.png) A scatter plot! (with\na line)\n\nThe full code for this graph can also be found on\n[github](https://gist.github.com/d3noob/6f082f0e3b820b6bf68b78f2f7786084) or\nin the code samples bundled with this book (scatterplot.html and data.csv). A\nlive example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/6f082f0e3b820b6bf68b78f2f7786084).\n\nI deliberately put the dots _after_ the line in the drawing section, because I\nthought they would look better, but you could put the block of code before the\nline drawing block to get the following effect;\n\n![A scatter plot with the line in front of the dots](images/scatter02.png) A\nscatter plot with the line in front of the dots\n\n(just trying to reinforce the concept that ‘order’ matters when drawing\nobjects :-)).\n\nYou could of course just remove the line block all together…\n\n![A scatter plot without the line this time](images/scatter03.png) A scatter\nplot without the line this time\n\nBut in my humble opinion it loses something.\n\nSo what do the individual lines in the scatter plot block of JavaScript do?\n\nThe first line (`svg.selectAll(\"dot\")`) essentially provides a suitable\ngrouping label for the svg circle elements that will be added. The next line\nassociates the range of data that we have to the group of elements we are\nabout to add in.\n\nThen we add a circle for each data point (`.enter().append(\"circle\")`) with a\nradius of 5 pixels (`.attr(\"r\", 5)`) and appropriate x (`.attr(\"cx\",\nfunction(d) { return x(d.date); })`) and y (`.attr(\"cy\", function(d) { return\ny(d.close); });`) coordinates.\n\nThere is lots more that we could be doing with this piece of code (check out\nthe [scatter plot example](http://bl.ocks.org/3887118)) including varying the\ncolour or size or opacity of the circles depending on the data and all sorts\nof really neat things, but for the mean time, there we go. Scatter plot!\n\n### Smoothing out graph lines\n\nWhen you draw a line graph, what you’re doing is taking two (or more) sets of\ncoordinates and connecting them with a line (or lines). I know that sounds\nsimplistic, but bear with me. When you connect these points, you’re telling\nthe viewer of the graph that in between the individual points, you expect the\nvalue to vary in keeping with the points that the line passes through. So in a\nway, you’re trying to interpret the change in values that are not shown.\n\nNow this is not strictly true for all graph types, but it does hold for a lot\nof line graphs.\n\nSo… when connecting these known coordinates together, you want to make the\nbest estimate of how the values would be represented. In this respect,\nsometimes a straight line between points is not the best representation.\n\nFor instance. Earlier, when demonstrating the extent function for graphing we\nshowed a graph of the varying values with the y axis showing a narrow range.\n\n![Expanded values for a narrow range](images/scales6.png) Expanded values for\na narrow range\n\nThe resulting variation of the graph shows a fair amount of extremes and you\ncould be forgiven for thinking that if this represented a smoothly flowing\nanalog system of some kind then some of those sharp peaks and troughs would\nnot be a true representation of how the system or figures varied.\n\nSo how should it look? Ahh… The $64,000 question. I don’t know :-). You will\nhave a better idea since you are the person who will know your data best.\nHowever, what I do know is that D3 has some tricks up its sleeve to help.\n\nWe can easily change what we see above into;\n\n![Smoothing using \"basis\"](images/smooth02.png) Smoothing using “basis”\n\nHow about that? And the massive amount of code required to carry out what must\nbe a ridiculously difficult set of calculations?\n\n    \n    \n        .curve(d3.curveBasis);\n    \n\nNow, that is slightly unfair because that’s the code that WE need to put in\nyour script, but Mike Bostock probably had to do the mental equivalent of\nwalking across hot coals to get it to work so nicely.\n\nSo where does this neat piece of code go? Here;\n\n    \n    \n    // define the line\n    var valueline = d3.line()\n        .curve(d3.curveBasis)\t \t\t// <=== THERE IT IS!\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n\nSo is that it? Nooooo…….. There’s more! This is one form of interpolation\neffect that can be applied to your data, but there is a range and depending on\nyour data you can select the one that is appropriate.\n\nHere’s the list of available options and for more about them head on over to\nthe [D3 wiki](https://github.com/d3/d3-shape/blob/master/README.md#curves).\n\n  * linear (`d3.curveLinear`) – Normal line (jagged).\n  * linear-closed (`d3.curveLinearClosed`) – A normal line (jagged) families of curves available with the start and the end closed in a loop.\n  * step (`d3.curveStep`)- a stepping graph alternating between vertical and horizontal segments. The y values change at the mid point of the adjacent x values\n  * step-before (`d3.curveStepBefore`) - a stepping graph alternating between vertical and horizontal segments. The y values change before the x value.\n  * step-after (`d3.curveStepAfter`) - a stepping graph alternating between horizontal and vertical segments. The y values change after the x value.\n  * basis (`d3.curveBasis`) - a B-spline, with control point duplication on the ends (that’s the one above).\n  * basis-open (`d3.curveBasisOpen`) - an open B-spline; may not intersect the start or end.\n  * basis-closed (`d3.curveBasisClosed`) - a closed B-spline, with the start and the end closed in a loop.\n  * bundle (`d3.curveBundle`) - equivalent to basis, except a separate tension parameter is used to straighten the spline. This could be really cool with varying tension.\n  * cardinal (`d3.curveCardinal`) - a Cardinal spline, with control point duplication on the ends. It looks slightly more ‘jagged’ than basis.\n  * cardinal-open (`d3.curveCardinalOpen`) - an open Cardinal spline; may not intersect the start or end, but will intersect other control points. So kind of shorter than ‘cardinal’.\n  * cardinal-closed (`d3.curveCardinalClosed`) - a closed Cardinal spline, looped back on itself.\n  * monotone (`d3.curveMonotoneX`) - cubic interpolation that makes the graph only slightly smoother.\n  * catmull-Rom (`d3.curveCatmullRom`) - New for v4 - a cubic [Catmull–Rom spline](https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline)\n  * catmull-Rom-closed (`d3.curveCatmullRomClosed`) - New for v4 - a closed cubic Catmull–Rom spline\n  * catmull-Rom-open (`d3.curveCatmullRomOpen`) - New for v4 - an open cubic Catmull–Rom spline\n\nBecause in the course of writing this I took an opportunity to play with each\nof them, I was pleasantly surprised to see some of the effects and it seems\nlike a shame to deprive the reader of the same joy :-). So at the risk of\ndeforesting the planet (so I hope you are reading this in electronic format)\nhere is each of the above interpolation types applied to the same data.\n\nThis is also an opportunity to add some reader feedback awesomeness. Many\nthanks to ‘enjalot’ for the great suggestion to plot the points of the data as\nseparate circles on the graphs. Since the process of interpolation has the\neffect of ‘interpreting’ the trends of the data to the extent that in some\ncases, the lines don’t intersect the actual data much at all.\n\nEach of the following shows the smoothing curve and the data that is used to\nplot the graph (as a scatterplot).\n\n![Smoothing using \"linear\"](images/smooth03.png) Smoothing using “linear”\n![Smoothing using \"linear-closed\"](images/smooth03a.png) Smoothing using\n“linear-closed” ![Smoothing using \"step\"](images/smooth04a.png) Smoothing\nusing “step” ![Smoothing using \"step-before\"](images/smooth04.png) Smoothing\nusing “step-before” ![Smoothing using \"step-after\"](images/smooth05.png)\nSmoothing using “step-after” ![Smoothing using \"basis\"](images/smooth06.png)\nSmoothing using “basis” ![Smoothing using \"basis-open\"](images/smooth07.png)\nSmoothing using “basis-open” ![Smoothing using \"basis-\nclosed\"](images/smooth08.png) Smoothing using “basis-closed” ![Smoothing using\n\"bundle\"](images/smooth09.png) Smoothing using “bundle” ![Smoothing using\n\"cardinal\"](images/smooth10.png) Smoothing using “cardinal” ![Smoothing using\n\"cardinal-open\"](images/smooth11.png) Smoothing using “cardinal-open”\n![Smoothing using \"cardinal-closed\"](images/smooth12.png) Smoothing using\n“cardinal-closed” ![Smoothing using \"monotone\"](images/smooth13.png) Smoothing\nusing “monotone” ![Smoothing using \"catmull-Rom\"](images/smooth14.png)\nSmoothing using “catmull-Rom” ![Smoothing using \"catmull-Rom-\nclosed\"](images/smooth15.png) Smoothing using “catmull-Rom-closed” ![Smoothing\nusing \"catmull-Rom-open\"](images/smooth16.png) Smoothing using “catmull-Rom-\nopen”\n\nJust in case you’re in the mood for another example, feel free to check out\nthe [bl.ock here](http://bl.ocks.org/d3noob/ced1b9b18bd8192d2c898884033b5529)\nwhich shows all of the basic forms of the curve types (I didn’t include the\nopen and closed versions or ‘bundle’ since it is the equivalent of ‘basis’).\nThe full code for this can also be found in the code samples bundled with this\nbook (interpolate.html and data-3.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0).\n\n![Comparison of curve types](images/smooth17.png) Comparison of curve types\n\nSo, over to you to decide which format of interpolation is going to suit your\ndata best:-).\n\n### Make a dashed line\n\nDashed lines totally rock!\n\nOK, there may be an element of exaggeration there, but I certainly found it\ninteresting that there didn’t seem to be a lot of explanation for a simple\nperson like myself to make a dashed line in D3. So for me they rocked :-)\n\nOne of the best parts about it is that they’re so simple to do!\n\nLiterally one line!!!!\n\nSo lets imagine that we want to make the line on our [simple\ngraph](chap04.xhtml#simplegraph) dashed. All we have to do is insert the\nfollowing line in our JavaScript code here;\n\n    \n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .style(\"stroke-dasharray\", (\"3, 3\"))  // <== This line here!!\n          .attr(\"d\", valueline);\n    \n\nAnd our graph ends up like this;\n\n![Dashed line for the basic graph](images/dashed01.png) Dashed line for the\nbasic graph\n\nHey! It’s dashtastic!\n\nSo how does it work?\n\nWell, obviously `\"stroke-dasharray\"` is a style for the path element, but the\nmagic is in the numbers.\n\nEssentially they describe the on length and off length of the line. So `\"3,\n3\"` translates to 3 pixels (or whatever they are) on and 3 pixels off. Then it\nrepeats. Simple eh?\n\nSo, experiment time :-)\n\nWhat would the following represent?\n\n`\"5, 5, 5, 5, 5, 5, 10, 5, 10, 5, 10, 5\"`\n\nTry not to cheat…\n\n![Dashed lines for fun](images/dashed02.png) Dashed lines for fun\n\nAhh yes, Mr. Morse would be proud.\n\nAnd you can put them anywhere. Here are our axes perverted with dashes;\n\n    \n    \n      // Add the X Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .style(\"stroke-dasharray\", (\"3, 3\"))\n          .call(d3.axisBottom(x));\n    \n      // Add the Y Axis\n      svg.append(\"g\")\n          .style(\"stroke-dasharray\", (\"3, 3\"))\n          .call(d3.axisLeft(y));\n    \n\n![When dashed lines go bad](images/dashed03.png) When dashed lines go bad\n\nWell… I suppose you can have too much of a good thing. With great power comes\ngreat responsibility. Use your dash skills wisely and only for good.\n\n### Filling an area under the graph\n\nLines are all very well and good, but that’s not the whole story for graphs.\nSometimes you’ve just got to go with a fill.\n\nFilling an area with a solid colour isn’t too hard. I mean we did it by\nmistake back a few pages when we were trying to draw a line.\n\nBut to do it in a nice coherent way is fairly straight forward.\n\nIt takes three sections of code in much the same way that we drew our grid\nlines earlier;\n\n  1. One in the CSS section to define what style the area will have.\n  2. One to define the functions that generate the area. And…\n  3. One to draw the area.\n\nThe end result will looks a bit like this;\n\n![Basic graph with an area fill](images/fill01.png) Basic graph with an area\nfill\n\nWhile we’ll start with our default code for our simple graph, the full code\nfor this area graph can be found on\n[github](https://gist.github.com/d3noob/119a138ef9bd1d8f0a8d57ea72355252) or\nin the code samples bundled with this book (area.html and data.csv). A live\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/119a138ef9bd1d8f0a8d57ea72355252).\n\n#### CSS for an area fill\n\nThis is pretty straight forward and only consists of one rule;\n\n    \n    \n    .area {\n      fill: lightsteelblue;\n    }\n    \n\nPut it at the bottom of your `<style>` section.\n\nThe style (`fill: lightsteelblue;`) sets the colour of our fill (and in this\ncase we have chosen a lighter shade of the same colour as our line to match\nit).\n\n#### Define the area function\n\nWe need a function that will tell the area what space to fill. This is\naccessed from the [`d3.area`\nfunction](https://github.com/d3/d3-shape/blob/master/README.md#areas)\n\nThe code that we will use is as follows;\n\n    \n    \n    // define the area\n    var area = d3.area()\n        .x(function(d) { return x(d.date); })\n        .y0(height)\n        .y1(function(d) { return y(d.close); });\n    \n\nI have placed it in between the range variable definitions and the line\ndefinitions here;\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y = d3.scaleLinear().range([height, 0]);\n    \n                             <==== Put the new code here!\n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\n    \n\nYou will notice it looks _INCREDIBLY_ similar to the valueline function\ndefinition. That’s because; while the line definition describes drawing a line\nthat connects a set of coordinates, I imagine the area definition describes\ndrawing two lines that share the same x coordinates, but simultaneously draws\ntwo y coordinates, y0 and y1. Then when it’s finished drawing the resultant\nshape, it fills it with the colour of your choosing.\n\nSo the only changes to the code are the addition of the `y0` line and the\nrenaming of the `y` line `y1`.\n\nHere’s a picture that might help explain;\n\n![How the area is defined](images/fill03.png) How the area is defined\n\nAs should be apparent, the top line (`y1`) follows the valueline line and the\nbottom line is at the constant ‘height’ value. Everything in between these\nlines is what gets filled. The function in this section describes the area.\n\n#### Draw the area\n\nNow to the money maker.\n\nThe final section of code in the area filling odyssey is as follows;\n\n    \n    \n      // add the area\n        svg.append(\"path\")\n           .data([data])\n           .attr(\"class\", \"area\")\n           .attr(\"d\", area);\n    \n\nWe should place this block directly after the domain functions but before the\ndrawing of the valueline path;\n\n    \n    \n      // scale the range of the data\n      x.domain(d3.extent(data, function(d) { return d.date; }));\n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n                                    //   <== Area drawing code here!\n    \n      // add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n\nThis is actually a pretty good idea to put it there since the various bits and\npieces that are drawn in the graph are done so one after the other. This means\nthat the filled area comes first, then the valueline is layered on top and\nthen the axes come last. This is a pretty good sequence since if there are\nareas where two or more elements overlap, it might cause the graph to look\n‘wrong’.\n\nFor instance, here is the graph drawn with the area added last.\n\n![Area overlaps and obscures](images/fill04.png) Area overlaps and obscures\n\nYou should be able to notice that part of the valueline line has been obscured\nand the line for the y axis where it coincides with the area is obscured also.\n\nLooking at the code we are adding here, the first line appends a path element\n(`svg.append(\"path\")`) much like the script that draws the line.\n\nThe second line (`.data([data])`) declares the data we will be utilising for\ndescribing the area and the third line (`.attr(\"class\", \"area\")`) makes sure\nthat the style we apply to it is as defined in the CSS section (under ‘area’).\n\nThe final line (`.attr(\"d\", area);`) declares “d” as the attributer for path\ndata and calls the ‘area’ function to do the drawing.\n\nAnd that’s it!\n\n#### Filling an area above the line\n\nPop Quiz:\n\nHow would you go about filling the area _ABOVE_ the graph?\n\nNow it might sound a little trite, but believe it or not, this could come in\nhandy. For instance, what if you want to highlight an area that was too high\nand an area that was too low for a line of data on a graph with an area in the\ncentre where a projected ‘normal’ set of values should be present?\n\nIn this instance, you could fill the lower area as has been demonstrated here,\nand with a small change you can fill another area with a solid colour above\nanother line.\n\nHow is this incredible feat achieved?\n\nWell, remember the code that defined the area?\n\n    \n    \n    // define the area\n    var area = d3.area()\n        .x(function(d) { return x(d.date); })\n        .y0(height)\n        .y1(function(d) { return y(d.close); });\n    \n\nAll we have to do is tell it that instead of setting the `y0` constant value\nto the height of the graph (remember, this is the bottom of the graph) we will\nset it to the constant value that is at the top of the graph. In other words\nzero (0).\n\n    \n    \n        .y0(0)\n    \n\nThat’s it.\n\n![Fill an area above a line](images/fill05.png) Fill an area above a line\n\nNow, I’m not going to go over the process of drawing two lines and filling\neach in different directions to demonstrate the example I described, but this\nprovides a germ of an idea that you might be able to flesh out :-)\n\n### Adding a drop shadow to allow text to stand out on graphics.\n\nI’ve deliberately positioned this particular tip to follow the ‘filling an\narea’ description because it provides an opportunity to demonstrate the\nprinciple to slightly better effect.\n\nWhile we’ll start with our code for our area graph, the full code for the\ngraph with shadowy text can be found on\n[github](https://gist.github.com/d3noob/aa55e2004abba3c503116b103a1f0ff2) or\nin the code samples bundled with this book (shadow.html and data.csv). A live\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/aa55e2004abba3c503116b103a1f0ff2).\n\nThere have been several opportunities where I have wanted to place text\noverlaid on graphs for convenience sake only to have it look overly messy as\nthe text interferes with the graph.\n\n### Is this evil?\n\nNow, I’ll be the first to say that the principle of overlaying text on a graph\nis probably not best practice, but sometimes you’ve got to do what you’ve got\nto do. Besides. Sometimes it’s a valid idea. If I remember rightly, the first\ntime I came across this idea, it was being used to highlight text when\npositioned on bars of a bar graph. So it’s not always an evil practice :-).\n\nAnyway, what we’ll do is leave the area fill in place and place the title back\non the graph, but position the title so that it lays on top of the fill like\nso;\n\n![Title lost in the area fill](images/drop01.png) Title lost in the area fill\n\nThe additional code for the title is the following and appears just after the\ndrawing of the axes.\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"x\", (width / 2))\t\t\t\t\n          .attr(\"y\", 25 )\n          .attr(\"text-anchor\", \"middle\")\t\n          .style(\"font-size\", \"24px\") \n          .style(\"text-decoration\", \"underline\") \t\n          .text(\"Value vs Date Graph\");\n    \n\n(the only change from the previous title example is the ‘y’ attribute which\nhas been hard coded to 25 to place it inconveniently on the filled area and\nthe size of the font)\n\nSo, what we want to end up with is something like the following…\n\n![A nice white drop shadow effect](images/drop02.png) A nice white drop shadow\neffect\n\nIn my humble opinion, it’s just enough to make the text acceptable :-).\n\nThe method that I’ll describe to carry this out is designed so that the drop\nshadow effect can be applied to any text elements in the graph, not the\nisolated example that we will use here. In order to implement this marvel of\nutility we will need to make changes in two areas. One in the CSS where we\nwill define a style for white shadowy backgrounds and the second to draw it.\n\n#### CSS for white shadowy background\n\nThe code to add to the CSS section is as follows;\n\n    \n    \n    text.shadow {\n      stroke: white;\n      stroke-width: 4px;\n      opacity: 0.8;\n    }\n    \n\nThe first line designates that the style applies to text with a ‘shadow’\nlabel. The stroke is set to white. The width of the line is set to 4px and it\nis made to be slightly see-through. So by setting the line that surrounds the\ntext to be thick, white and see-through gives it a slightly ‘cloudy’ effect.\nIf we remove the black text from over the top we get a slightly better look;\n\n![A closer look at just the drop shadow](images/drop03.png) A closer look at\njust the drop shadow\n\nOf course if you want to have a play with any of these settings, you should\nhave a go and see what works best for your graph.\n\n#### Drawing the white shadowy background.\n\nNow that we’ve set the style for our background, we need to draw it in.\n\nThe code for this should be extremely familiar;\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"x\", (width / 2))\t\t\t\t\n          .attr(\"y\", 25 )\n          .attr(\"text-anchor\", \"middle\")\t\n          .style(\"font-size\", \"24px\") \n          .style(\"text-decoration\", \"underline\") \n          .attr(\"class\", \"shadow\")\t\t\t// <=== Here's the different line\n          .text(\"Value vs Date Graph\");\n    \n\nThat’s because it’s identical to the piece of code that was used to draw the\ntitle except for the one line that is indicated above. The reason that it’s\nidentical is that what we are doing is placing a white shadow on the graph and\nthen the text on top of it, if it deviated by a significant amount it will\njust look silly. Of course a slight amount could look effective, in which case\nadjust the ‘`x`’ or ‘`y`’ attributes.\n\nOne of the things I pointed out in the previous paragraph was extremely\nimportant. That’s the bit that tells you that we needed to place the shadow\n**before** we placed the black text. For the same reason that we placed the\narea fill on first in the area fill example, If black text goes on before the\nshadow, it will look pretty silly. So place this block of code just before the\nblock that draws the title.\n\nSo the line that has been added in is the one that tells D3 that the text that\nis being drawn will have the white cloudy effect. And at the risk of repeating\nmyself, if you have several text elements that could benefit from this effect,\nonce you have the CSS code in place, all you need to do is duplicate the block\nthat adds the text and add in that single line and voila!\n\n### Adding grid lines to a graph\n\nGrid lines are an important feature for some graphs as they allow the eye to\nassociate three analogue scales (the x and y axis and the displayed line).\n\nThere is currently a tendency to use graphs without grid lines online as it\ngives the appearance of a ‘cleaner’ interface, but they are still widely used\nand a necessary component for graphing.\n\nThis is what we’re going to draw;\n\n![Basic graph with gridlines](images/grid01.png) Basic graph with gridlines\n\nWhile we’ll start with our default code for our simple graph, the full code\nfor the graph with grid lines can be found on\n[github](https://gist.github.com/d3noob/c506ac45617cf9ed39337f99f8511218) or\nin the code samples bundled with this book (grid.html and data.csv). A live\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218).\n\nLike pretty much everything in this document, the clever parts of this are not\nmy work. I’ve simply used other peoples cleverness to solve my problems. In\nthis case I think the source of this solution came from the good work of\nJustin Palmer in his excellent description of the design of a line graph\n[here](http://dealloc.me/2011/06/24/d3-is-not-a-graphing-library.html).\nHowever, in retrospect when I’ve looked back, I’m not sure if I got this right\n(as I did this quite a while ago when I was less fastidious about noting my\nsources). In any case, Justin’s work is excellent and I heartily recommend it,\nand here is my implementation of what I think is his work :-)\n\nHow to build grid lines?\n\nWe’re going to use the axis function to generate two more axis elements (one\nfor x and one for y) but for these ones instead of drawing the main lines and\nthe labels, we’re just going to draw the tick lines. Really long tick lines\n(I’m considering calling them [long\ncat](http://knowyourmeme.com/memes/longcat) lines).\n\nTo create them we have to add in 3 separate blocks of code.\n\n  1. One in the CSS section to define what style the grid lines will have.\n  2. One to define the functions that generate the grid lines. And…\n  3. One to draw the lines.\n\n#### The grid line CSS\n\nThis is the total styling that we need to add for the tick lines;\n\n    \n    \n    .grid line {\n      stroke: lightgrey;\n      stroke-opacity: 0.7;\n      shape-rendering: crispEdges;\n    }\n    \n    .grid path {\n      stroke-width: 0;\n    }\n    \n\nJust add this block of code at the end of the current CSS that is in the\nsimple graph template (just before the `</style>` tag).\n\nThe CSS here is done in two parts.\n\nThe first portion sets the line colour (stroke), the opacity (transparency) of\nthe lines and make sure that the lines are narrow (`crispEdges`).\n\n    \n    \n      stroke: lightgrey;\n      stroke-opacity: 0.7;\n      shape-rendering: crispEdges;\n    \n\nThe colour is pretty standard, but in using the opacity style we give\nourselves the opportunity to use a good shade of colour (if grey actually is a\ncolour) and to juggle the degree to which it stands out a little better.\n\nThe second part is the stroke width.\n\n    \n    \n      stroke-width: 0;\n    \n\nNow it might seem a little weird to be setting the stroke width to zero, but\nif you don’t (and we remove the style) this is what happens;\n\n![Axis lines made too thick](images/grid02.png) Axis lines made too thick\n\nIf you look closely (compare with the previous picture if necessary) the grid\nlines for the top and right edges have turned black. The stroke width style is\nobviously adding in new axis lines and we’re not interested in them at the\nmoment. Therefore, if we set the stroke width to zero, we get rid of the\nproblem.\n\n#### Define the grid line functions\n\nWe will need to define two functions to generate the grid lines and they look\na little like this;\n\n    \n    \n    // gridlines in x axis function\n    function make_x_gridlines() {\t\t\n        return d3.axisBottom(x)\n            .ticks(5)\n    }\n    \n    // gridlines in y axis function\n    function make_y_gridlines() {\t\t\n        return d3.axisLeft(y)\n            .ticks(5)\n    }\n    \n\nEach function will carry out its configuration when called from the later part\nof the script (the drawing part).\n\nA good spot to place the code is just before we load the data with the d3.csv\n\n    \n    \n            //   <== Put the functions here!\n    \n    // Get the data\n    d3.csv(\"data.csv\", function(error, data) {\n      if (error) throw error;\n    \n\nBoth functions are almost identical. They give the function a name\n(make_x_gridlines and make_y_gridlines) which will be used later when the\npiece of code that draws the lines calls out to them.\n\nBoth functions also show which parameters will be fed back to the drawing\nprocess when called. Both make sure they use the d3.axis function and then\nthey set individual attributes which make sense.\n\nThey make sure they’ve got the right axes (with the `x` and `y` variables in\nthe function). They set the orientation of the axes to match the incumbent\naxes (`d3.axisBottom(x)` and `d3.axisLeft(y)`). And they set the number of\nticks to match the number of ticks in the main axis (`.ticks(5)` and\n`.ticks(5)`). You have the opportunity here to do something slightly different\nif you want. For instance, think back to when we were setting up the axis for\nthe basic graph and we messed about, seeing how many ticks we could get to\nappear. If we increase the number of ticks that appear in the grid (lets say\nto `.ticks(30)` and `.ticks(10)`)) we get the following;\n\n![Grid lines with greater divisions](images/grid03.png) Grid lines with\ngreater divisions\n\nSo the grid lines can now show divisions of 20 on the y axis and per 2 days on\nthe x axis :-)\n\n#### Draw the lines\n\nThe final block of code we need is the bit that draws the lines.\n\n    \n    \n      // add the X gridlines\n      svg.append(\"g\")\t\t\t\n          .attr(\"class\", \"grid\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(make_x_gridlines()\n              .tickSize(-height)\n              .tickFormat(\"\")\n          )\n    \n      // add the Y gridlines\n      svg.append(\"g\")\t\t\t\n          .attr(\"class\", \"grid\")\n          .call(make_y_gridlines()\n              .tickSize(-width)\n              .tickFormat(\"\")\n          )\n    \n\nThe first two lines of both the x and y axis grid lines code above should be\npretty familiar by now. The first one appends the element to be drawn to the\ngroup “g”. the second line (`.attr(\"class\", \"grid\")`) makes sure that the\nstyle information set out in the CSS is applied.\n\nThe x axis grid lines portion makes a slight deviation from conformity here to\nadjust its positioning to take into account the coordinates system\n`.attr(\"transform\", \"translate(0,\" + height + \")\")`.\n\nThen both portions call their respective make axis functions\n(`.call(make_x_gridlines()` and `.call(make_y_gridlines()`).\n\nNow comes the really interesting bit.\n\nWhat you will see if you go to the [D3 API\nwiki](https://github.com/mbostock/d3/wiki/SVG-Axes#wiki-tickSize) is that for\nthe .tickSize function, the following is the format.\n\n    \n    \n    axis.tickSize([size])\n    \n\nSo in our example we are setting our ticks to a length that corresponds to the\nfull height or width of the graph. Which of course means that they extend\nacross the graph and have the appearance of grid lines! What a neat trick.\n\nThe last thing that is included in the code to draw the grid lines is the\ninstruction to suppress printing any label for the ticks;\n\n    \n    \n              .tickFormat(\"\")\n    \n\nAfter all, that would become a bit confusing to have two sets of labels. Even\nif one was on top of the other. They do tend to become obvious if that occurs\n(they kind of bulk out a bit like bold text).\n\nAnd that’s it. Grid lines!\n\n### Adding more than one line to a graph\n\nAll right, we’re starting to get serious now. Two lines on a graph is a bit of\na step into a different world in one respect. I mean that in the sense that\nthere’s more than one way to carry out the task, and I tend to do it one way\nand not the other mainly because I don’t fully understand the other way :-(.\n\nI should stress that that’s not because it’s more complex, or that it’s a bad\nway, it’s just that once I started doing things one way, I haven’t come across\na need to do things another way. There’s a good chance I will have to revisit\nthis decision in the future, but for now I’ll keep moving.\n\nHow are we going to do this? I think that the best way will be to make the\nexecutive decision that we have suddenly come across more data and that it is\nalso in our data.csv file (which we’ll rename data2.csv just to highlight the\ndifference between the two data sets). In fact it looks a little like this\n(apologies in advance for the big ugly block of data);\n\n    \n    \n    date,close,open\n    1-May-12,68.13,34.12\n    30-Apr-12,63.98,45.56\n    27-Apr-12,67.00,67.89\n    26-Apr-12,89.70,78.54\n    25-Apr-12,99.00,89.23\n    24-Apr-12,130.28,99.23\n    23-Apr-12,166.70,101.34\n    20-Apr-12,234.98,122.34\n    19-Apr-12,345.44,134.56\n    18-Apr-12,443.34,160.45\n    17-Apr-12,543.70,180.34\n    16-Apr-12,580.13,210.23\n    13-Apr-12,605.23,223.45\n    12-Apr-12,622.77,201.56\n    11-Apr-12,626.20,212.67\n    10-Apr-12,628.44,310.45\n    9-Apr-12,636.23,350.45\n    5-Apr-12,633.68,410.23\n    4-Apr-12,624.31,430.56\n    3-Apr-12,629.32,460.34\n    2-Apr-12,618.63,510.34\n    30-Mar-12,599.55,534.23\n    29-Mar-12,609.86,578.23\n    28-Mar-12,617.62,590.12\n    27-Mar-12,614.48,560.34\n    26-Mar-12,606.98,580.12\n    \n\nThree columns, date open and close. The first two are exactly what we have\nbeen dealing with all along and the last (open) is our new made up data. Each\ncolumn is separated by a comma (hence .csv (comma separated values)), which is\nthe format we’re currently using to import data.\n\nWe should save this as a new file so we don’t mess up our previous data, so\n(as mentioned earlier) let’s call it data2.csv.\n\nThere is a copy of this file and the sample code at\n[github](https://gist.github.com/d3noob/4db972df5d7efc7d611255d1cc6f3c4f) and\nin the code samples bundled with this book (multiple-lines.html and\ndata2.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/4db972df5d7efc7d611255d1cc6f3c4f).\n\nWe will build our new code using our [simple graph](chap04.xhtml#simplegraph)\ntemplate to start with, so the immediate consequence of this is that we need\nto edit the line that was looking for ‘data.csv’ to reflect the new name.\n\n    \n    \n    d3.csv(\"data2.csv\", function(error, data) {\n    \n\nSo when you browse to our new graph’s html file, we don’t see any changes. It\nstill happily loads the new data, but because it hasn’t been told to do\nanything with it, nothing new happens.\n\nWhat we need to do now it to essentially duplicate the code blocks that drew\nthe first line for the second line.\n\nThe good news is that in the simplest way possible that’s just two code\nblocks. The first sets up the function that defines the new line;\n\n    \n    \n    // define the 2nd line\n    var valueline2 = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.open); });\n    \n\nYou should notice that this block is identical to the block that sets up the\nfunction for the first line, except this one is called (imaginatively)\nvalueline2 and instead of including the variable ‘close’ for our datapoint we\nare using our new variable (from the extra column in the csv file) ‘open’. We\nshould put it directly after the block that sets up the function for\nvalueline.\n\nThe second block draws our new line;\n\n    \n    \n      // Add the valueline2 path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline2);\n    \n\nAgain, this is identical to the block that draws the first line, except this\none is called valueline2. We should put it directly after the block that draws\nvalueline.\n\nAfter those three small changes, check out your new graph;\n\n![Two lines, but the same colour](images/twolines01.png) Two lines, but the\nsame colour\n\nHey! Two lines! Hmm…. Both being the same colour is a bit confusing. Good\nnews. We can change the colour of the second line by inserting a line that\nadjusts its stroke (colour) very simply.\n\nSo here’s what our new drawing block looks like;\n\n    \n    \n      // Add the valueline2 path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .style(\"stroke\", \"red\")\n          .attr(\"d\", valueline2);\n    \n\nAnd as if by magic, here’s our new graph;\n\n![Two lines with two colours](images/twolines02.png) Two lines with two\ncolours\n\nWow. Right about now, we’re thinking ourselves pretty clever. But there are\ntwo places where we’re not doing things right. We took a simple way, but we\ntook some short cuts that might bite us in the posterior.\n\nThe first mistake we made was not ensuring that our variable `\"d.open\"` is\nbeing treated as a number or a string. We’re fortunate in this case that it\nis, but this can’t always be assumed. So, this is an easy fix and we just need\nto put the following (indicated line) in our code;\n\n    \n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseTime(d.date);\n          d.close = +d.close;\n          d.open = +d.open;         //  <=== Add this line in!\n      });\n    \n\nThe second and potentially more fatal flaw is that nowhere in our code do we\nmake allowance for our second set of data (the second line’s values) exceeding\nour first lines values.\n\nThat might not sound too normal straight away, but consider this. What if when\nwe made up our data earlier, some of the new data exceeded our maximum value\nin our original data? As a means of demonstration, here’s what happens when\nour second line of data has values higher than the first lines;\n\n![Two lines but the domain's not right](images/twolines03.png) Two lines but\nthe domain’s not right\n\nAhh…. We’re not too clever now.\n\nGood news though, we can fix it!\n\nThe problem comes about because when we set the domain for the y axis this is\nwhat we put in the code;\n\n    \n    \n      y.domain([0, d3.max(data, function(d) { return d.close; })]);\n    \n\nSo that only considers `d.close` when establishing the domain. With `d.open`\nexceeding our domain, it just keeps drawing off the graph!\n\nThe good news is that ‘Bill’ has provided a solution for just this problem\n[here](http://stackoverflow.com/questions/12732487/d3-js-dataset-array-w-\nmultiple-y-axis-values);\n\nAll you need to replace the `y.domain` line with is this;\n\n    \n    \n      y.domain([0, d3.max(data, function(d) {\n    \t  return Math.max(d.close, d.open); })]);\n    \n\nIt does much the same thing, but this time it returns the maximum of `d.close`\nand `d.open` (whichever is largest). Good work Bill.\n\nIf we put that code into the graph with the higher values for our second line\nwe are now presented with this;\n\n![Two lines with everything fitting onto the canvas](images/twolines04.png)\nTwo lines with everything fitting onto the canvas\n\nAnd it doesn’t matter which of the two sets of data is largest, the graph will\nalways adjust :-)\n\nYou will also have noticed that our y axis has auto adjusted again to cope.\nClever eh?\n\n### Labelling multiple lines on a graph\n\nOur previous example of a graph with multiple lines is a thing of rare beauty,\nbut which line relates to which set of data? We have data that defines values\nfor `open` and `close`, but we don’t know which line is which.\n\nIn this section we will add labels to our lines so that we know what it what.\n\nThis section was inspired by a question from a reader (Arun b.s) of the\n[d3noob.org](http://www.d3noob.org/2013/01/adding-more-than-one-line-to-graph-\nin.html) blog where the question was asked “How can we put text at the end of\neach line on the graph?”.\n\nThe question was so good I realised that it had to be part of the book, so\nhere you go :-).\n\nIt’s actually not too difficult. What we are trying to achieve is to find the\nposition of the end of each line and to add a text label at that position so\nthat the association of proximity denotes the linkage. Of course we’re going\nto go a little further and colour the text so that it’s really clear which\nlabel belongs with which line, but you get the idea.\n\nEach line requires a single block of script to add the text. The block that\nadds the `open` label is as follows;\n\n    \n    \n      svg.append(\"text\")\n          .attr(\"transform\", \"translate(\"+(width+3)+\",\"+y(data[0].open)+\")\")\n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"start\")\n          .style(\"fill\", \"red\")\n          .text(\"Open\");\n    \n\nSo firstly it appends a textual element to the svg object;\n\n    \n    \n      svg.append(\"text\")\n    \n\nThen it finds the position of the end of the line;\n\n    \n    \n          .attr(\"transform\", \"translate(\"+(width+3)+\",\"+y(data[0].open)+\")\")\n    \n\nTo do this we use the `transform` and `translate` attribute and find the x\nposition that equates to the end of the graph plus 3 pixels (`(width+3)`) (we\nadd in the three pixels to create a small separation between the end of the\nline and the label). The `y` position is far more interesting. We need to find\nthe position of the last point in our line for the `open` data. Because the\ndata is in the form of an indexed array and because the data has the latest\ndate at the start of the array, we only need to find the point at the `0`\nposition of the array. This is `data[0].open`. But of course, we also need to\nadjust our data for our scale and range, so we transform it using the `y`\nfunction (in the same way that we do it for the `valueline` and `valueline2`\npoints. So the script to find the point on the screen in the y direction is\n`y(data[0].open)`.\n\nIf our data was arranged with the last date at the end of our data we would\nhave to find the final index point and we would use\n`y(data[data.length-1].open))`.\n\nThen it’s just a matter of aligning and justifying our text correctly;\n\n    \n    \n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"start\")\n    \n\nThen colouring it the correct colour;\n\n    \n    \n          .style(\"fill\", \"red\")\n    \n\nAnd adding out text;\n\n    \n    \n          .text(\"Open\");\n    \n\nWe put this block of code after the blocks that add in the axes so that they\nmake sure they’re on top of anything else we draw. Of course we will want to\nadd another (almost) duplicate of the block for the ‘close’ column.\n\nThe only other small change we want to make is to change the right margin for\nthe graph that we set at the start of our script from 20 to 40 so that there\nis enough room to add our label without cutting it off.\n\nAfter that you have a marvellously labelled multi-line graph!\n\n![Multi-line graph with labels](images/multiplelabels.png) Multi-line graph\nwith labels\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/9edcd7a67e9ec8c8d24d20f3a47e8879) or\nin the code samples bundled with this book (dual-labels.html and data2.csv). A\nworking example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/9edcd7a67e9ec8c8d24d20f3a47e8879).\n\nNow, I’d like to pretend that this is perfection, but it isn’t. If our lines\nend too close together, the labels will interfere with each other, so in the\nideal world I would include a bit of fanciness to prevent that, but for the\npurposes of this exercise we can consider ourselves happy.\n\n### Multiple axes for a graph\n\nAlrighty… Let’s imagine that we want to show our wonderful graph with two\nlines, much like we already have, but imagine that the data that the lines are\nmade from is significantly different in magnitude from the original data (in\nthe example below, the data for the second line has been reduced by\napproximately a factor of 10 from our original data).\n\n    \n    \n    date,close,open\n    1-May-12,58.13,3.41\n    30-Apr-12,53.98,4.55\n    27-Apr-12,67.00,6.78\n    26-Apr-12,89.70,7.85\n    25-Apr-12,99.00,8.92\n    24-Apr-12,130.28,9.92\n    23-Apr-12,166.70,10.13\n    20-Apr-12,234.98,12.23\n    19-Apr-12,345.44,13.45\n    18-Apr-12,443.34,16.04\n    17-Apr-12,543.70,18.03\n    16-Apr-12,580.13,21.02\n    13-Apr-12,605.23,22.34\n    12-Apr-12,622.77,20.15\n    11-Apr-12,626.20,21.26\n    10-Apr-12,628.44,31.04\n    9-Apr-12,636.23,35.04\n    5-Apr-12,633.68,41.02\n    4-Apr-12,624.31,43.05\n    3-Apr-12,629.32,46.03\n    2-Apr-12,618.63,51.03\n    30-Mar-12,599.55,53.42\n    29-Mar-12,609.86,57.82\n    28-Mar-12,617.62,59.01\n    27-Mar-12,614.48,56.03\n    26-Mar-12,606.98,58.01\n    \n\nNow this isn’t a problem in itself. D3 will still make a reasonable graph of\nthe data, but because of the difference in range, the detail of the second\nline will be lost.\n\n![One line is dominating the other](images/multiaxes01.png) One line is\ndominating the other\n\nWhat I’m proposing is that we have a second y axis on the right hand side of\nthe graph that relates to the red line.\n\nThe mechanism used is based on the great examples put forward by Ben\nChristensen [here](http://benjchristensen.com/2012/05/02/line-graphs-\nusing-d3-js/).\n\nNow… You’ll need to concentrate a bit since there are quite a few different\nbits to change and adapt, but don’t despair, they’re all quite logical and\nmake sense.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/814a2bcb3e7d8d8db74f36f77c8e6b7f) or\nin the code samples bundled with this book (dual-axes.html and data4.csv). A\nworking example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/814a2bcb3e7d8d8db74f36f77c8e6b7f).\n\nFirst things first, there won’t be space on the right hand side of our graph\nto show the extra axis, so we should make our right hand margin a little\nlarger.\n\n    \n    \n    var margin = {top: 20, right: 40, bottom: 30, left: 50},\n    \n\nI went for 40 and it seems to fit pretty well.\n\nThen (and here’s where the main point of difference for this graph comes in)\nyou want to amend the code to separate out the two scales for the two lines in\nthe graph. This is actually a lot easier than it sounds, since it consists\nmainly of finding anywhere that mentions `y` and replacing it with `y0` and\nthen adding in a reciprocal piece of code for `y1`.\n\nThe idea here is that we will be creating two references for the y axis. One\nfor each column of data. Then when we draw the lines the scales will\nautomatically scale the data correctly (and separately) to our svg element and\nwe will draw two different y axes with the different scales. Believe it or\nnot, it sounds a lot harder than it is.\n\nLet’s get started.\n\nIn order to colour the text on the two different y axes we will need to\ndeclare their styles in the `<style>` section at the start of the code. In the\ndeclaration shown below we are calling the two different classes\n‘axisSteelBlue’ and ‘axisRed’. The style that we set for each is ‘fill’ since\nthis is the style that will colour the text\n\n    \n    \n    .axisSteelBlue text{\n      fill: steelblue;\n    }\n    \n    .axisRed text{\n      fill: red;\n    }\n    \n\nThen into the JavaScript and we want to change the variable declaration for\n`y` to `y0` and add in `y1`.\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime().range([0, width]);\n    var y0 = d3.scaleLinear().range([height, 0]);\n    var y1 = d3.scaleLinear().range([height, 0]);\n    \n\nNow change our valueline declarations so that they refer to the `y0` and `y1`\nscales.\n\n    \n    \n    // define the 1st line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y0(d.close); });\n    \n    // define the 2nd line\n    var valueline2 = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y1(d.open); });\n    \n\nThere are a few different ways for the scaling to work, but we’ll stick with\nthe fancy max method we used in the dual line example (although technically\nit’s not required).\n\n    \n    \n      y0.domain([0, d3.max(data, function(d) {return Math.max(d.close);})]);\n      y1.domain([0, d3.max(data, function(d) {return Math.max(d.open); })]); \n    \n\nAgain, here’s the `y0` and `y1` changed and added and the maximums for\n`d.close` and `d.open` are separated out).\n\nThe final piece of the puzzle is to draw the new axis, but we also want to\ncolour code the text in the axes to match the lines. We do this using the\nstyling that we declared earlier\n\n    \n    \n      // Add the Y0 Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axisSteelBlue\")\n          .call(d3.axisLeft(y0));\n    \n      // Add the Y1 Axis\n      svg.append(\"g\")\n          .attr(\"class\", \"axisRed\")\n          .attr(\"transform\", \"translate( \" + width + \", 0 )\")\n          .call(d3.axisRight(y1));\t\n    \n\nIn the above code you can see where we have added in a ‘style’ change for the\naxisLeft to make it ‘steelblue’ and a complementary change in the new section\nfor axisRight to make that text red.\n\nThe yAxisRight section obviously needs to be added in, but the only\nsignificant difference is the transform / translate attribute that moves the\naxis to the right hand side of the graph.\n\nAnd after all that, here’s the result…\n\n![Two lines with full range of the domain and two\naxes](images/multiaxes02.png) Two lines with full range of the domain and two\naxes\n\nNow, let’s not kid ourselves that it’s a thing of beauty, but we should\nconsole our aesthetic concerns with the warm glow of understanding how the\nfunction works :-).\n\n\n## Elements, Attributes and Styles\n\nThis chapter is intended to provide an overview of some of the simpler things\nthat d3.js can do, but in a way that may help some understand a little more\nabout how images can be added to a web page and how they can be manipulated.\n\nLoosely speaking we will look at how objects (elements (like circles,\nrectangles, lines and even text)) can be declared and added to a page, how\ntheir attributes in relation to the page (position, size, shape, actions) can\nbe changed and how their style (colour, width, transparency) can be applied.\n\nAs we go through the explanation of different changes that can be applied to\ndifferent elements there will be a small amount of repetition where there is\ncross-over with related drawing features. Please be patient :-). The aim is to\nhave each section as complete in its own right as practical.\n\n### The Framework\n\nTo be able to demonstrate how these three related aspects of drawing objects\nwork we will have to use a small, simple script to draw them in your web\nbrowser.\n\nWe will just take a moment to explain the script that draws a circle.\n\nHere’s the contents of the file in its entirety. I have imaginatively called\nit `circle.html` and you can find it in the code samples that can be\ndownloaded with the book.\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n     \n    var holder = d3.select(\"body\") // select the 'body' element\n          .append(\"svg\")           // append an SVG element to the body\n          .attr(\"width\", 449)      // make the SVG element 449 pixels wide\n          .attr(\"height\", 249);    // make the SVG element 249 pixels high\n    \n    // draw a circle\n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n    </script>\n    \n    </body>\n    \n\nPlease feel free to jump ahead slightly if you understand how a HTML file with\nJavaScript goes together :-).\n\nThe HTML part of the file can be thought of as a wrapper for the JavaScript\nthat will draw our circle. These are the HTML parts here…\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n     \n    </script>\n    \n    </body>\n    \n\nThis portion of the file is built using HTML ‘tags’. These will set up the\nenvironment for the JavaScript.\n\nThe tags tell the web browser what sort of language is being used and the type\nof characters used to write the code…\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n\nAreas of the code are labelled.\n\nLike the body…\n\n    \n    \n    <body>\n    \n    In this area we can put the stuff that will be \n    displayed on our web page.\n    \n    </body>\n    \n\nAnd the place where we put the JavaScript…\n\n    \n    \n    <script>\n    \n    Our d3.js code will go here.\n    \n    </script>\n    \n\nWe even load an external file that contains JavaScript that will help run our\ncode.\n\n    \n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n\nYes, that’s the line that loads d3.js. Once it’s loaded we can use the\ninstructions that it makes available to make other JavaScript code (in this\ncase ours) work.\n\nThen we have the JavaScript code that allows us to _use_ the functions made\npossible by d3.js.\n\n    \n    \n    var holder = d3.select(\"body\") // select the 'body' element\n          .append(\"svg\")           // append an SVG element to the body\n          .attr(\"width\", 449)      // make the SVG element 449 pixels wide\n          .attr(\"height\", 249);    // make the SVG element 249 pixels high\n    \n    // draw a circle\n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nI’ve broken the code into two separate blocks to provide some clarity to their\nfunction. We could make it one block, but that wouldn’t necessarily make it\neasier to understand.\n\nFirstly we add a ‘holder’ for our graphics on the web page. I’ve named it\n`holder` but we could just as easily named it anything we wanted.\n\n    \n    \n    var holder = d3.select(\"body\") // select the 'body' element\n          .append(\"svg\")           // append an SVG element to the body\n          .attr(\"width\", 449)      // make the SVG element 449 pixels wide\n          .attr(\"height\", 249);    // make the SVG element 249 pixels high\n    \n\nThe first thing we do when declaring our holder is to select the `body`\nelement of our web page (Remember those `<body>` tags in the HTML part\nearlier?).\n\nThen we append a Scalable Vector Graphic (SVG) object to the body and we make\nit 449 pixels wide and 249 pixels high.\n\nThe `width` and `height` are ‘attributes’ of the SVG object. That is to say\nthey describe a property of the object.\n\nBelieve it or not, I have made the container size unusual (not nice round\nnumbers like 450 x 250) for a good reason. Later I will introduce a grid to\nour diagram so we can see where everything is laid out and this size makes the\ngrid look better.\n\nThe second block of our JavaScript finally draws our circle.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThe first line appends a new element (a circle) to our SVG ‘holder’.\n\nIf you like, you can think of having the `holder` declaration in front of the\n`.append(\"circle\")` as being a nice short-hand way of writing the code. We\ncould have had a much longer line that selected the `body`, appended the svg\nelement and then appended our circle in one line, but it’s actually a far\nbetter scheme for building multiple objects to break the sequences up which\nwill allow us to manipulate groupings of objects in future code.\n\nThe second and third lines declare the attribute of our circle that specify\nwhere the centre of the circle is. In this case it’s at the x/y position\n200/100 (`cx`/`cy`).\n\nThe last line adds the radius attribute `r`. Here it is set to 50 pixels.\n\nThe three attributes `cx`, `cy` and `r` are all required when drawing a\ncircle. There are other attributes we can put in there (and when we look at\nsome of the upcoming elements, you should get a feel for them), but these are\nthe minimum.\n\nThe purpose of describing this block of code that draws a circle isn’t to show\nyou how to draw a circle. This has only been a way of showing you how the code\nin the following sections is laid out and how it works. The elements we are\ngoing to generate can be drawn with exactly the same file but with just the\nsection that adds the circle altered.\n\nFor example if you were to change this block of code;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nFor this block of code;\n\n    \n    \n    holder.append(\"rect\")          // attach a circle\n        .attr(\"x\", 150)            // x position of the top-left corner\n        .attr(\"y\", 50)             // y position of the top-left corner\n        .attr(\"width\", 100)        // set the rectangle width\n        .attr(\"height\", 100);      // set the rectangle height\n    \n\nInstead of drawing a circle we would be drawing a rectangle.\n\nSo this is what our circle will look like;\n\n![Circle](images/EAS-01.png) Circle\n\nBecause it will help a great deal to have a common frame of reference, I’m\ngoing to display the elements on a grid that looks a little like this;\n\n![Circle with Grid](images/EAS-02.png) Circle with Grid\n\nThe grid won’t form part of the code that gets explained, but I will take the\ntime out to describe how it’s generated in another section, because it’s quite\ncool in its own way :-).\n\nWith the grid in place it’s far easier to see that the centre of our circle is\nindeed at the coordinates x = 200, y = 100 and that the radius is 50.\n\nThe circle is still somewhat plain, but bear with me because as we start to\nexplore what we can do with styles and attributes we can add some variation to\nour elements.\n\n![Fancier Circle](images/EAS-03.png) Fancier Circle\n\nWith that explanation behind us we should begin our odyssey into the world of\nd3 elements.\n\n### Elements\n\nWe will begin by describing what we mean when we talk about an ‘element’.\n\nThere is considerable scope for confusion when talking about elements on a web\npage. Are we talking about [HTML\nelements](http://reference.sitepoint.com/html/page-structure), [SVG\nelements](https://developer.mozilla.org/en-US/docs/Web/SVG/Element) or\nsomething different?\n\nIn fact we are going to be describing a subset of SVG elements. Specifically a\ncollection of common shapes and objects which include circles, ellipses,\nrectangles, lines, polylines, polygons, text and paths.\n\n“Text?” I hear you say. “Doesn’t sound like a shape.” I suppose it depends on\nhow you think of it. We can use text in different ways in d3, but for this\nparticular exercise we _can_ regard text as an SVG element.\n\n#### Circle\n\nA [circle is a simple SVG shape](http://www.w3schools.com/svg/svg_circle.asp)\nthat is described by three required attributes.\n\n  * `cx`: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.\n  * `cy`: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.\n  * `r`: The radius of the circle from the `cx`, `cy` position to the perimeter of the circle.\n\nThe following is an example of the code section required to draw a circle in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThis will produce a circle as follows;\n\n![Circle](images/EAS-02.png) Circle\n\nThe centre of the circle is at x = 200 and y = 100 and the radius is 50\npixels.\n\n#### Ellipse\n\nAn [ellipse](http://www.w3schools.com/svg/svg_ellipse.asp) is described by\nfour required attributes;\n\n  * `cx`: The position of the centre of the ellipse in the x direction (left / right) measured from the left side of the screen.\n  * `cy`: The position of the centre of the ellipse in the y direction (up / down) measured from the top of the screen.\n  * `rx`: The radius of the ellipse in the x dimension from the `cx`, `cy` position to the perimeter of the ellipse.\n  * `ry`: The radius of the ellipse in the y dimension from the `cx`, `cy` position to the perimeter of the ellipse.\n\nThe following is an example of the code section required to draw an ellipse in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter;\n\n    \n    \n    holder.append(\"ellipse\")       // attach an ellipse\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"rx\", 100)           // set the x radius\n        .attr(\"ry\", 50);           // set the y radius\n    \n\nThis will produce an ellipse as follows;\n\n![Ellipse](images/EAS-04.png) Ellipse\n\nThe centre of the ellipse is at x = 200 and y = 100 and the radius is 50\npixels vertically and 100 pixels horizontally.\n\n#### Rectangle\n\nA [rectangle](http://www.w3schools.com/svg/svg_rect.asp) is described by four\nrequired attributes and two optional ones;\n\n  * `x`: The position on the x axis of the left hand side of the rectangle (required).\n  * `y`: The position on the y axis of the top of the rectangle (required).\n  * `width`: the width (in pixels) of the rectangle (required).\n  * `height`: the height (in pixels) of the rectangle (required).\n  * `rx`: The radius curve of the corner of the rectangle in the x dimension (optional).\n  * `ry`: The radius curve of the corner of the rectangle in the y dimension (optional).\n\nThe following is an example of the code section required to draw a rectangle\n(using only the required attributes) in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a rectangle as follows;\n\n![Rectangle](images/EAS-05.png) Rectangle\n\nThe top left corner of the rectangle is at 100, 50 and the rectangle is 200\npixels wide and 100 pixels high.\n\nThe following code section includes the optional attributes for the curved\ncorners;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200)     // set the width\n        .attr(\"rx\", 10)         // set the x corner curve radius\n        .attr(\"ry\", 10);        // set the y corner curve radius\n    \n\nThis will produce a rectangle (with curved corners) as follows;\n\n![Rectangle with curved corners](images/EAS-06.png) Rectangle with curved\ncorners\n\nThe corners are curved with radii in the x and y direction of 10 pixels.\n\n#### Line\n\nA [line](http://www.w3schools.com/svg/svg_line.asp) is a simple line between\ntwo points and is described by four required attributes.\n\n  * `x1`: The x position of the first end of the line as measured from the left of the screen.\n  * `y1`: The y position of the first end of the line as measured from the top of the screen.\n  * `x2`: The x position of the second end of the line as measured from the left of the screen.\n  * `y2`: The y position of the second end of the line as measured from the top of the screen.\n\nThe following is an example of the code section required to draw a line in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code is the `style`\ndeclaration. In this case the line has no colour and this can be added with\nthe `stroke` style which applies a colour to a line;\n\n    \n    \n    holder.append(\"line\")          // attach a line\n        .style(\"stroke\", \"black\")  // colour the line\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nThis will produce a line as follows;\n\n![Line](images/EAS-07.png) Line\n\nThe line extends from the point 100,50 to 300,150.\n\n#### Polyline\n\nA [polyline](http://www.w3schools.com/svg/svg_polyline.asp) is a sequence of\nconnected lines described with a single attribute, `points`.\n\n  * `points`: The `points` attribute is a list of x,y coordinates that are the locations of the connecting points of the polyline.\n\nThe following is an example of the code section required to draw a polyline in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code are the `style`\ndeclarations. In this case the line of the polyline has no colour and this can\nbe added with the `stroke` style which applies the colour black to a line.\nLikewise the area that is bounded by the polyline will be automatically filled\nwith black unless we explicitly tell the object not to. This is achieved in\nthis example by addition of the `fill` style to `none`.\n\n    \n    \n    holder.append(\"polyline\")      // attach a polyline\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points\n    \n\nThis will produce a polyline as follows;\n\n![Polyline](images/EAS-08.png) Polyline\n\nThe polyline extends from the point 100,50 to 200,150 to 300,50.\n\n#### Polygon\n\nA [polygon](http://www.w3schools.com/svg/svg_polygon.asp) is a sequence of\nconnected lines which form a closed shape described with a single attribute,\n`points`.\n\n  * `points`: The `points` attribute is a list of x,y coordinates that are the locations of the connecting points of the polygon. The last point is in turn connected to the first point.\n\nThe following is an example of the code section required to draw a polygon in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code are the `style`\ndeclarations. In this case the line of the polygon has no colour and this can\nbe added with the `stroke` style which applies the colour black to a line.\nLikewise the area that is bounded by the polygon will be automatically filled\nwith black unless we explicitly tell the object not to. This is achieved in\nthis example by addition of the `fill` style to `none`.\n\n    \n    \n    holder.append(\"polygon\")       // attach a polygon\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points \n    \n\nThis will produce a polygon as follows;\n\n![Polyline](images/EAS-09.png) Polyline\n\nThe polygon extends from the point 100,50 to 200,150 to 300,50 and then back\nto 100,50.\n\n#### Path\n\nA [path](http://www.w3schools.com/svg/svg_path.asp) is an outline of an SVG\nshape which is described with a ‘mini-language’ inside a single attribute.\n\n  * `d`: This attribute is a list of instructions that allow a shape to be drawn in a complex way using a [‘mini-language’ of commands](http://www.w3.org/TR/SVG/paths.html#PathData). These commands are written in a shorthand of single letters such as `M`-moveto, `Z`-closepath, `L`-lineto, `C`-curveto. These commands can be absolute (normally designated by capital letters) or relative (lower case).\n\nThe following is an example of the code section required to draw a triangle in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. A notable addition to this code are the `style`\ndeclarations. In this case the line of the path has no colour and this can be\nadded with the `stroke` style which applies the colour black to a line.\nLikewise the area that is bounded by the path will be automatically filled\nwith black unless we explicitly tell the object not to. This is achieved in\nthis example by addition of the `fill` style to `none`.\n\n    \n    \n    holder.append(\"path\")          // attach a path\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"d\", \"M 100,50, L 200,150, L 300,50 Z\");  // path commands \n    \n\nThis will produce a path as follows;\n\n![Path](images/EAS-10.png) Path\n\nThe path mini-language first moves (`M`) to 100,50 then draws a line (`L`) to\n200,150 then draws another line (`L`) to 300,50 then closes the path (`Z`).\n\n#### Clipped Path (AKA clipPath)\n\nA [clipPath](https://developer.mozilla.org/en-\nUS/docs/Web/SVG/Element/clipPath) is the path of a SVG shape that can be used\nin combination with another shape to remove any parts of the combined shape\nthat doesn’t fall within the clipPath. That sounds slightly confusing, so we\nwill break it down a bit to hopefully clarify the explanation.\n\nLet’s imagine that we want to display the intersection of two shapes. What we\nwill do is define our `clipPath` which will act as a ‘cookie cutter’ which can\ncut out the shape we want (we will choose an ellipse). Then we will draw our\nbase shape (which is analogous to the dough) that we will use our cookie\ncutter on (our dough will be shaped as a rectangle). The intersection of the\ncookie cutter and the dough is our clipped path.\n\nOur clipPath (cookie cutter) element is an ellipse;\n\n![clipPath \\(cookie cutter\\)](images/EAS-44.png) clipPath (cookie cutter)\n\nOur shape that we will be clipping (the dough) is a rectangle;\n\n![Rectangle element \\(dough\\)](images/EAS-45.png) Rectangle element (dough)\n\nThe intersection of the two is the clipped path (shaded grey);\n\n![Combination of the ellipse and the rectangle](images/EAS-46.png) Combination\nof the ellipse and the rectangle\n\nThe graphic examples above are misleading in the sense that the two basic\nshapes are not actually displayed. All that results from the use of the\n`clipPath` is the region that is the intersection of the two.\n\n![The clipped path](images/EAS-47.png) The clipped path\n\nThe following is an example of the code section required to draw the clipped\npath in conjunction with [the HTML file](chap06.xhtml#EASframework) outlined\nat the start of this chapter. The `clipPath` element is given the `ID`\n‘ellipse-clip’ and a specified size and location. Then when the rectangle is\nappended. the `clipPath` is specified as an attribute (via a URL) using `clip-\npath`.\n\n    \n    \n    // define the clipPath\n    holder.append(\"clipPath\")       // define a clip path\n    \t.attr(\"id\", \"ellipse-clip\") // give the clipPath an ID\n      .append(\"ellipse\")            // shape it as an ellipse\n    \t.attr(\"cx\", 175)            // position the x-centre\n    \t.attr(\"cy\", 100)            // position the y-centre\n    \t.attr(\"rx\", 100)            // set the x radius\n    \t.attr(\"ry\", 50);            // set the y radius\n    \n    // draw clipped path on the screen\n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 125)         // position the left of the rectangle\n        .attr(\"y\", 75)          // position the top of the rectangle\n        .attr(\"clip-path\", \"url(#ellipse-clip)\") // clip the rectangle\n        .style(\"fill\", \"lightgrey\")   // fill the clipped path with grey\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a path as follows;\n\n![The clipped path](images/EAS-47.png) The clipped path\n\nAn example of this in use can bee seen in the difference chart explanation\nlater in the book.\n\n#### Text\n\nA [text](http://www.w3schools.com/svg/svg_text.asp) element is an SVG object\nwhich is shaped as text. It is described by two required attributes and three\noptional ones.\n\n  * `x`: This attribute designates the anchor point location for the text in the x dimension (required).\n  * `y`: This attribute designates the anchor point location for the text in the y dimension (required).\n  * `dx`: This attribute designates the offset of the text from the anchor point in the x dimension (optional). There are several different sets of units that can be used to designated the offset of the text from an anchor point. These include `em` which is a scalable unit (used in these examples), `px` (pixels), `pt` (points (kind of like pixels)) and `5` (percent (scalable and kind of like `em`)) \n  * `dy`: This attribute designates the offset of the text from the anchor point in the y dimension (optional).\n  * `text-anchor`: This attribute controls the horizontal text alignment (optional). It has three values; `start` (left aligned), `middle` (centre aligned) and `end` (right aligned).\n\nThe following is an example of the code section required to draw the text\n“Hello World” in conjunction with [the HTML file](chap06.xhtml#EASframework)\noutlined at the start of this chapter. A notable addition to this code is the\n`style` declaration which applies a `black` `fill` to the text. Additionally\nthere is the declaration `.text` which defines the text that will be\ndisplayed.\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text \n        .text(\"Hello World\");     // define the text to display \n    \n\nThis will produce text as follows;\n\n![Text](images/EAS-11.png) Text\n\nIt can be seen from the image that the anchor point for the text is at 200,100\nand that the text is positioned with this anchor point at the bottom, left of\nthe text.\n\nThe following examples will demonstrate the various options for positioning\nand aligning text so that you can arrange it correctly.\n\n##### Anchor at the bottom, middle of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Bottom-middle](images/EAS-12.png) Text: Anchored Bottom-\nmiddle\n\n##### Anchor at the bottom, right of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"end\")  // set anchor y justification \n        .text(\"Hello World\");        // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Bottom-Right](images/EAS-13.png) Text: Anchored Bottom-Right\n\n##### Anchor at the middle, left of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"start\")  // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Left](images/EAS-15.png) Text: Anchored Middle-Left\n\n##### Anchor in the middle, centre of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Centre](images/EAS-14.png) Text: Anchored Middle-\nCentre\n\n##### Anchor in the middle, right of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")         // set offset y position\n        .attr(\"text-anchor\", \"end\")  // set anchor y justification \n        .text(\"Hello World\");        // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Right](images/EAS-16.png) Text: Anchored Middle-Right\n\n##### Anchor at the top, left of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".71em\")           // set offset y position\n        .attr(\"text-anchor\", \"start\")  // set anchor y justification \n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Top-Left](images/EAS-17.png) Text: Anchored Top-Left\n\n##### Anchor at the top, middle of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".71em\")            // set offset y position\n        .attr(\"text-anchor\", \"middle\")  // set anchor y justification \n        .text(\"Hello World\");           // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Top-Middle](images/EAS-18.png) Text: Anchored Top-Middle\n\n##### Anchor at the top, right of the text:\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".71em\")          // set offset y position\n        .attr(\"text-anchor\", \"end\")   // set anchor y justification \n        .text(\"Hello World\");         // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Top-Right](images/EAS-19.png) Text: Anchored Top-Right\n\n### Attributes\n\nAt the start of writing this section I was faced with the question “What’s an\nattribute?”. But a reasonable answer has eluded me, so I will make the\nassumption that the answer will be something of a compromise :-). I like to\nthink that an attribute of an element is something that is a characteristic of\nthe object without defining it, and/or it may affect the object’s position or\norientation on the page. There could be a strong argument to say that the\nfollowing section on styles could be seen to cross-over into attributes and I\nagree. However, for the purposes of providing a description of the syntax and\neffects, I’m happy with the following list :-).\n\nBecause not all attributes are applicable to all elements, there will be a bit\nof variation in the type of shapes we deal with in the description below, but\nthere won’t be any that are different to those that we’ve already looked at.\nThere will be some repetition with recurring information from the elements\nsection. This is intentional to hopefully allow each section to exist in its\nown right.\n\n####  `x`, `y`\n\nThe `x` and `y` attributes are used to designate a position on the web page\nthat is set from the top, left hand corner of the web page. Using the `x` and\n`y` attributes places the anchor points for these elements at a specified\nlocation. Of the elements that we have examined thus far, the rectangle\nelement and the text element have anchor points to allow them to be\npositioned.\n\nFor example the following is a code section required to draw a rectangle\n(using only the required attributes) in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a rectangle as follows;\n\n![Rectangle with `x`,`y` at 100,50](images/EAS-05.png) Rectangle with `x`,`y`\nat 100,50\n\nThe top left corner of the rectangle is specified using `x` and `y` at 100 and\n50 respectively.\n\n####  `x1`, `x2`, `y1`, `y2`\n\nThe `x1`, `x2`, `y1` and `y2` attributes are used to designate the position of\ntwo points on a web page that are set from the top, left hand corner of the\nweb page. These two points are connected with a line as part of the `line`\nelement.\n\nThe attributes are described as follows;\n\n  * `x1`: The x position of the first end of the line as measured from the left of the screen.\n  * `y1`: The y position of the first end of the line as measured from the top of the screen.\n  * `x2`: The x position of the second end of the line as measured from the left of the screen.\n  * `y2`: The y position of the second end of the line as measured from the top of the screen.\n\nThe following is an example of the code section required to draw a line in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. The attributes connect the point 100,50 (`x1`, `y1`)\nwith 300,150 (`x2`, `y2`);\n\n    \n    \n    holder.append(\"line\")          // attach a line\n        .style(\"stroke\", \"black\")  // colour the line\n        .attr(\"x1\", 100)     // x1 position of the first end of the line\n        .attr(\"y1\", 50)      // y1 position of the first end of the line\n        .attr(\"x2\", 300)     // x2 position of the second end of the line\n        .attr(\"y2\", 150);    // y2 position of the second end of the line\n    \n\nThis will produce a line as follows;\n\n![Line](images/EAS-07.png) Line\n\nThe line extends from the point 100,50 to 300,150.\n\n#### points\n\nThe `points` attribute is used to set a series of points which are\nsubsequently connected with a line and / or which may form the bounds of a\nshape. These are specifically associated with the `polyline` and `polygon`\nelements. Like the `x`, `y` and `x1`, `x2`, `y1`, `y2` attributes, the\ncoordinates are set from the top, left hand corner of the web page.\n\nThe data for the points is entered as a sequence of x,y points in the\nfollowing format;\n\n    \n    \n        .attr(\"points\", \"100,50, 200,150, 300,50\"); \n    \n\nWhere 100,50 is the first x,y point then 200,150 is the second.\n\nThe following is an example of the code section required to draw a polyline in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. The additional `style` declarations are included to\nillustrate the shape better. The `points` values can be compared with the\nsubsequent image.\n\n    \n    \n    holder.append(\"polyline\")      // attach a polyline\n        .style(\"stroke\", \"black\")  // colour the line\n        .style(\"fill\", \"none\")     // remove any fill colour\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points\n    \n\nThis will produce a polyline as follows;\n\n![Polyline using `points` attribute](images/EAS-08.png) Polyline using\n`points` attribute\n\nThe polyline extends from the point 100,50 to 200,150 to 300,50.\n\n####  `cx`, `cy`\n\nThe `cx`, `cy` attributes are associated with the circle and ellipse elements\nand designate the centre of each shape. The coordinates are set from the top,\nleft hand corner of the web page.\n\n  * `cx`: The position of the centre of the element in the x axis measured from the left side of the screen.\n  * `cy`: The position of the centre of the element in the y axis measured from the top of the screen.\n\nThe following is an example of the code section required to draw an ellipse in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. In it the centre of the ellipse is set by `cx`, `cy` as\n200, 100.\n\n    \n    \n    holder.append(\"ellipse\")       // attach an ellipse\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"rx\", 100)           // set the x radius\n        .attr(\"ry\", 50);           // set the y radius\n    \n\nThis will produce an ellipse as follows;\n\n![Ellipse with Centre at 200, 100](images/EAS-04.png) Ellipse with Centre at\n200, 100\n\nThe centre of the ellipse is at x = 200 and y = 100 and the radius is 50\npixels vertically and 100 pixels horizontally.\n\n####  `r`\n\nThe `r` attribute determines the radius of a circle element from the `cx`,\n`cy` position (the centre of the circle) to the perimeter of the circle.\n\nThe following is an example of the code section required to draw a circle in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThis will produce a circle with a radius of 50 pixels as follows;\n\n![Circle with Radius of 50 Pixels](images/EAS-02.png) Circle with Radius of 50\nPixels\n\nThe centre of the circle is at x = 200 and y = 100 and the radius is 50\npixels.\n\n####  `rx`, `ry`\n\nThe `rx`, `ry` attributes are associated with the ellipse element and\ndesignate the radius in the x direction (`rx`) and the radius in the y\ndirection (`ry`).\n\n  * `rx`: The radius of the ellipse in the x direction from the `cx`, `cy` position to the perimeter of the ellipse.\n  * `ry`: The radius of the ellipse in the y direction from the `cx`, `cy` position to the perimeter of the ellipse.\n\nThe following is an example of the code section required to draw an ellipse in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter. In it, the centre of the ellipse is set by `cx`, `cy`\nas 200, 100 and the radius in the x direction (`rx`) is 100 pixels and the\nradius in the y direction (`ry`) is 50 pixels.\n\n    \n    \n    holder.append(\"ellipse\")       // attach an ellipse\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"rx\", 100)           // set the x radius\n        .attr(\"ry\", 50);           // set the y radius\n    \n\nThis will produce an ellipse as follows;\n\n![Ellipse with x Radius of 100 and y Radius of 50](images/EAS-04.png) Ellipse\nwith x Radius of 100 and y Radius of 50\n\nThe centre of the ellipse is at x = 200 and y = 100 and the radius is 50\npixels vertically and 100 pixels horizontally.\n\n####  `transform (translate(x,y), scale(k), rotate(a))`\n\nThe transform attribute is a powerful one which allows us to change the\nproperties of an element in several different ways.\n\n  * `translate`: Where the element is moved by a relative value in the x,y direction. \n  * `scale`: Where the element’s attributes are increased or reduced by a specified factor.\n  * `rotate`: Where the element is rotated about its reference point by an angular value.\n\nWithout a degree of prior understanding, these transforms can appear to behave\nin unusual ways, but hopefully we’ll explain it sufficiently here so that you\ncan appreciate the logic in the way they work.\n\n#####  `transform (translate(x,y))`\n\nThe transform-translate attribute will take an element’s position and adjust\nit based on a specified value(s) in the x,y directions.\n\nThe best way to illustrate this is with an example;\n\nThis is the code snippet from [the HTML file](chap06.xhtml#EASframework)\noutlined at the start of this chapter which draws a circle at the position\n200,100 (`cx`,`cy`);\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"r\", 50);            // set the radius\n    \n\nThis will produce a circle as follows;\n\n![Circle](images/EAS-02.png) Circle\n\nIf we add in a `transform (translate(*x*,*y*))` attribute for values of x,y of\n50,50 this will shift our circle by an additional 50 pixels in the x direction\nand 50 pixels in the y direction.\n\nHere’s the code snippet that will draw our new circle;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-center\n        .attr(\"cy\", 100)           // position the y-center\n        .attr(\"transform\", \"translate(50,50)\") // translate the circle\n        .attr(\"r\", 50);            // set the radius\n    \n\nAnd here’s the resulting change;\n\n![Circle](images/EAS-20.png) Circle\n\nThe circle was positioned at the point 200,100 and then translated by 50\npixels in both axes to 250,150.\n\nThe original code snippet could in fact be written as follows;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"transform\", \"translate(200,100)\") // translate the circle\n        .attr(\"r\", 50);            // set the radius\n    \n\nSince by default our starting position is 0,0 if we apply a translation of\n200,100 we will end up at 200,100.\n\n#####  `transform (scale(k))`\n\nThe translate-scale attribute will take an element’s attributes and scale them\nby a factor _k_.\n\nOriginally I thought that this attribute would affect the size of the element,\nbut it affects more than that! As with the transform-translate attribute, the\nbest way to illustrate this is with an example;\n\nThe following code snippet (in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) which\ndraws a circle at the position 150,50 with a radius of 25 pixels;\n\n    \n    \n    holder.append(\"circle\")     // attach a circle\n        .attr(\"cx\", 150)        // position the x-centre\n        .attr(\"cy\", 50)         // position the y-centre\n        .attr(\"r\", 25);         // set the radius\n    \n\nThis will produce a circle as follows;\n\n![Circle](images/EAS-21.png) Circle\n\nIf we now introduce a transform-scale attribute with a scale of 2 we will see\nall three of the other attributes (`cx`, `cy` and `r`) scaled by a factor of\ntwo to 300, 100 and 50 respectively.\n\nHere is the code;\n\n    \n    \n    holder.append(\"circle\")             // attach a circle\n        .attr(\"cx\", 150)                // position the x-centre\n        .attr(\"cy\", 50)                 // position the y-centre\n        .attr(\"r\", 25)                  // set the radius\n        .attr(\"transform\", \"scale(2)\"); // scale the circle attributes\n    \n\nWhich will produce a circle as follows;\n\n![Circle](images/EAS-22.png) Circle\n\nIn this example we can see that the position (`cx`, `cy`) and the radius (`r`)\nhave been scaled up by a factor of 2.\n\n#####  `transform (rotate(a))`\n\nThe translate-rotate attribute will rotate an element and its attributes by a\ndeclared angle in degrees.\n\nThe ability to rotate elements is obviously a valuable tool. The transform-\nrotate attribute does a great job of it, but the key to making sure that you\nknow exactly what will happen to an object is to remember where the anchor\npoint is for the object and to ensure that the associated attributes are set\nappropriately. As with the transform translate & scale attributes, the best\nway to illustrate this is with an example;\n\nThe following is the code snippet (in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) which\ndraws the text “Hello World” at the position 200,100 with the anchor point\nbeing the the middle of the text;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .text(\"Hello World\");          // define the text to display\n    \n\nThis will produce text as follows;\n\n![Text: Anchored Middle-Centre](images/EAS-14.png) Text: Anchored Middle-\nCentre\n\nIf we then apply a transform-rotate of 10 degrees as follows;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .attr(\"transform\", \"rotate(10)\")\n        .text(\"Hello World\");          // define the text to display\n    \n\nWe will see the following on the screen;\n\n![Text: Anchored Middle-Centre](images/EAS-23.png) Text: Anchored Middle-\nCentre\n\nObviously the text has been rotated, but hopefully you’ll have noticed that\nit’s also been displaced. This is because the transform-rotate attribute has\nbeen applied to both the text element (which _has_ been rotated by 10 degrees)\n_and_ the `x`,`y` attributes. If you imagine the origin point for the element\nbeing at 0,0, the centre, middle of the text element has been rotated about\nthe point 0,0 by 10 degrees (hopefully slightly better explained in the\nfollowing picture).\n\n![Text: All positioning Attributes Rotated](images/EAS-24.png) Text: All\npositioning Attributes Rotated\n\nThis could be seen as an impediment to getting things to move / change as you\nwant to, but instead it’s an indication of a different way of doing things.\nThe solution to this particular feature is to combine the transform-rotate\nwith the transform-translate that we used earlier so that the code looks like\nthis;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .attr(\"transform\", \"translate(200,100) rotate(10)\")\n        .text(\"Hello World\");          // define the text to display\n    \n\nAnd the image on the page looks like this;\n\n![Text: Rotated by 10 Degrees Anchored Middle-Centre](images/EAS-25.png) Text:\nRotated by 10 Degrees Anchored Middle-Centre\n\nWhich leads us to the final example which is a combination of all three\naspects of the transform attribute.\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"dy\", \".35em\")           // set offset y position\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .attr(\"transform\", \"translate(200,100) scale(2) rotate(10)\")\n        .text(\"Hello World\");          // define the text to display\n    \n\n![Text: Translated, Scaled and Rotated](images/EAS-26.png) Text: Translated,\nScaled and Rotated\n\nHere we have a text element translated to its position on the page, rotated by\n10 degrees about the centre of the text and scaled by a factor of two.\n\n####  `width`, `height`\n\n`width` and `height` are required attributes of the rectangle element. `width`\ndesignates the width of the rectangle and `height` designates the height (If\nyou’re wondering, I often struggle defining the obvious).\n\nThe following is an example of the code section required to draw a rectangle\n(using only the required attributes) in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"rect\")       // attach a rectangle\n        .attr(\"x\", 100)         // position the left of the rectangle\n        .attr(\"y\", 50)          // position the top of the rectangle\n        .attr(\"height\", 100)    // set the height\n        .attr(\"width\", 200);    // set the width\n    \n\nThis will produce a rectangle as follows;\n\n![Rectangle](images/EAS-05.png) Rectangle\n\nThe width of the triangle is 200 pixels and the height is 100 pixels.\n\n####  `text-anchor`\n\nThe `text-anchor` attribute determines the justification of a text element\n\nText can have one of three `text-anchor` types;\n\n  * `start` where the text is left justified.\n  * `middle` where the text is centre justified.\n  * `end` where the text is right justified.\n\nThe following is an example of code that will draw three separate lines of\ntext with the three different `text-anchor` types in conjunction with [the\nHTML file](chap06.xhtml#EASframework) outlined at the start of this chapter;\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 50)            // set y position of bottom of text\n        .attr(\"text-anchor\", \"start\") // set anchor y justification\n        .text(\"Hello World - start\"); // define the text to display\n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"middle\") // set anchor y justification\n        .text(\"Hello World - middle\"); // define the text to display\n        \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 150)           // set y position of bottom of text\n        .attr(\"text-anchor\", \"end\") // set anchor y justification\n        .text(\"Hello World - end\"); // define the text to display\n    \n\nThis will produce an output as follows;\n\n![Text with Different `text-anchor` Attributes](images/EAS-27.png) Text with\nDifferent `text-anchor` Attributes\n\n####  `dx`, `dy`\n\n`dx` and `dy` are optional attributes that designate an offset of text\nelements from the anchor point in the x and y dimension . There are several\ndifferent sets of units that can be used to designate the offset of the text\nfrom an anchor point. These include `em` which is a scalable unit, `px`\n(pixels), `pt` (points (kind of like pixels)) and `%` (percent (scalable and\nkind of like `em`))\n\nWe can demonstrate the offset effect by noting the difference in two examples.\n\nThe first is a simple projection of SVG text that aligns the text “Hello\nWorld” above and to the right of the anchor point at 200,100 (It does this in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter.).\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text \n        .text(\"Hello World\");     // define the text to display \n    \n\nWhich produces the following on the page;\n\n![Text with the Anchor at the Bottom Left Corner](images/EAS-11.png) Text with\nthe Anchor at the Bottom Left Corner\n\nThe second example introduces the `dx` attribute setting the offset to 50\npixels. This adds another 50 pixels to the x dimension. We also introduce the\n`dy` attribute with an offset of `.35em`. This scalable unit allows the text\nto be set as a factor of the size of the text. In this case `.35em` will add\nhalf the height of the text to the y dimension placing the text so that it is\nexactly in the middle (vertically) of the 100 pixel line on the y dimension.\n\n    \n    \n    holder.append(\"text\")         // append text\n        .style(\"fill\", \"black\")   // fill the text with the colour black\n        .attr(\"x\", 200)           // set x position of left side of text\n        .attr(\"y\", 100)           // set y position of bottom of text \n        .attr(\"dx\", \"50px\")       // set offset x position\n        .attr(\"dy\", \".35em\")      // set offset y position\n        .text(\"Hello World\");     // define the text to display \n    \n\nWhich produces the following on the page;\n\n![Text with 50 Pixel x Offset and Half Height y Offset](images/EAS-28.png)\nText with 50 Pixel x Offset and Half Height y Offset\n\nThe text has been moved 50 pixels to the right and half the height of the text\ndown the page.\n\n####  `textLength`\n\nThe `textLength` attribute adjusts the length of the text to fit a specified\nvalue.\n\nThe following is a code snippet that prints the text “Hello World” above and\nto the right of the anchor point at 200,100 (It does this in conjunction with\n[the HTML file](chap06.xhtml#EASframework) outlined at the start of this\nchapter.). The addition of the `textLength` attribute declaration in the code\nstretches the “Hello World” out so that it fills 150 pixels.\n\n    \n    \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 100)            // set y position of bottom of text \n        .attr(\"textLength\", \"150\") // set text length\n        .text(\"Hello World\");      // define the text to display \n    \n\nWhich produces the following on the page;\n\n![Text Stretched to 150 Pixels Wide](images/EAS-29.png) Text Stretched to 150\nPixels Wide\n\nIt is worth noting that while the text has been spread out, the individual\nletters remain un-stretched. Only the letter and word spacing has been\nadjusted. However, using the `lengthAdjust` attribute can change this.\n\n####  `lengthAdjust`\n\nThe `lengthAdjust` attribute allows the `textLength` attribute to have the\nspacing of a text element controlled to be either `spacing` or\n`spacingAndGlyphs`;\n\n  * `spacing`: In this option the letters remain the same size, but the spacing between the letters and words are adjusted.\n  * `spacingAndGlyphs`: In this option the text is stretched or squeezed to fit.\n\nThe attribute can be best illustrated via an example. The following code\nsnippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) shows\nthree versions of the text element. The top line is the standard text. The\nmiddle line is the `textLength` set to 150 and the `lengthAdjust` set to\n`spacing` (which is the default). The bottom line is the `textLength` set to\n150 and the `lengthAdjust` set to `spacingAndGlyphs`.\n\n    \n    \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 50)             // set y position of bottom of text \n        .text(\"Hello World\");      // define the text to display \n        \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 100)            // set y position of bottom of text \n        .attr(\"textLength\", \"150\") // set text length\n        .attr(\"lengthAdjust\", \"spacing\")\n        .text(\"Hello World\");      // define the text to display \n    \n    holder.append(\"text\")          // append text\n        .style(\"fill\", \"black\")    // fill the text with the colour black\n        .attr(\"x\", 200)            // set x position of left side of text\n        .attr(\"y\", 150)            // set y position of bottom of text \n        .attr(\"textLength\", \"150\") // set text length\n        .attr(\"lengthAdjust\", \"spacingAndGlyphs\")\n        .text(\"Hello World\");      // define the text to display \n    \n\nThe image on the screen will look like the following;\n\n![Text Stretched in Three Ways](images/EAS-30.png) Text Stretched in Three\nWays\n\nThe image shows that the top line looks normal, the middle line has had the\nspaces increased to increase the length of the text and the bottom line has\nbeen stretched.\n\n### Styles\n\nWhat’s a style?\n\nBelieve it or not, that’s as difficult a question to answer as “What’s an\nattribute?”. I like to think that an element can be selected and arranged on a\nweb page with `select` and `attr`, but once it’s there, changes to how it\nlooks are a matter for `style`. We will cover a range of qualities that neatly\nfit into this definition in the following section (such as fill, opacity and\nstroke-width) but there are also a range of unusual style declarations that\nmany may not have come across (I certainly hadn’t before writing this).\n\nThe other important thing to mention about setting styles for elements is that\nthere are different ways to accomplish the task. We’ll go through the process\nof describing different styles as they can be applied to individual elements\nin isolation, but there is a more powerful way to manage styles across a range\nof elements via Cascading Style Sheets (CSS) in the `<style>` section of a web\npage or even via an external style sheet. We will examine these possibilities\nat the end of the section.\n\nFull disclosure: I have not figured out how to work some of the styles for\nd3.js I’m afraid that `clip-path` and `mask` have exceeded my skill-set and I\nwill have to leave them for another day :-(. I found that there are several\ngood examples that make use of these styles, but I have struggled\n(unsuccessfully) to present them in a simple example.\n\n####  `fill`\n\nThe `fill` style will fill the element being presented with a specified\ncolour.\n\nBy default, most elements will be filled with black (the majority of the\nexamples used in this chapter make no `fill` declaration).\n\nThe following example (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) shows\nthe syntax for filling a simple circle with the colour red;\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"fill\", \"red\");     // set the fill colour \n    \n\nWhich results in the following image;\n\n![Circle with Red Fill](images/EAS-31.png) Circle with Red Fill\n\nAs we saw with the `polyline` and `polygon` examples earlier in the chapter\nsome shapes may need to have their `fill` colour turned off in some\ncircumstances and this can be accomplished by declaring the colour to be\n`none` (`.style(\"fill\", \"none\");`).\n\nThere are several different ways to define exactly what colour we want as a\nfill. The example above uses a ‘named colour code’ to declare the colour as\n“red” but we could also have defined it as rgb (`.style(\"fill\",\n\"rgb(255,0,0)\");`) or in hexadecimal (`.style(\"fill\", \"#f00\");`)\n\n####  `stroke`\n\nThe `stroke` style applies a colour to lines.\n\nBy default many elements do not have a stroke colour set, so it’s a matter of\ndeclaring the colour with either a named colour code (“red”), an rgb value\n(“rgb(255,0,0)”) or the appropriate hex (“#f00”).\n\nThe following example (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter) shows\nthe syntax for applying the colour red to a simple circle. The fill has been\nset to `none` to help the colour stand out.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"stroke\", \"red\")    // set the line colour\n        .style(\"fill\", \"none\");    // set the fill colour \n    \n\nWhich results in the following image;\n\n![Circle with Red Border](images/EAS-32.png) Circle with Red Border\n\n####  `opacity`\n\nThe `opacity` style has the effect of varying an element’s transparency.\n\nThe valid range for `opacity` is from 0 (completely transparent) to 1 (solid\ncolour). We should make the distinction at this point that `opacity` affects\nthe entire element, whereas the following `fill-opacity` and `stroke-opacity`\naffect only the fill and stroke respectively.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a green circle with a red border. The opacity value of .2 creates a\ndegree of transparency which will show the grid lines underneath the element.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"opacity\", .2)      // set the element opacity\n        .style(\"stroke\", \"red\")    // set the line colour\n        .style(\"fill\", \"green\");   // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with opacity](images/EAS-33.png) Circle with opacity\n\n####  `fill-opacity`\n\nThe `fill-opacity` style changes the transparency of the fill of an element.\n\nThe valid range for `fill-opacity` is from 0 (completely transparent) to 1\n(solid colour). We should make the distinction at this point that `fill-\nopacity` affects only the fill of an element, whereas `opacity` will affect\nthe entire element.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a green circle with a red border. The opacity value of .2 creates a\ndegree of transparency for the fill which will show the grid lines underneath.\n\n    \n    \n    holder.append(\"circle\")        // attach a circle\n        .attr(\"cx\", 200)           // position the x-centre\n        .attr(\"cy\", 100)           // position the y-centre\n        .attr(\"r\", 50)             // set the radius\n        .style(\"fill-opacity\", .2) // set the fill opacity\n        .style(\"stroke\", \"red\")    // set the line colour\n        .style(\"fill\", \"green\");   // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Semi-Transparent Fill](images/EAS-34.png) Circle with Semi-\nTransparent Fill\n\nThe distinction between this image and the one for the `opacity` style clearly\nshows the line around the outside of the object as still a solid (opaque)\ncolour.\n\n####  `stroke-opacity`\n\nThe `stroke-opacity` style changes the transparency of the stroke (line) of an\nelement.\n\nThe valid range for `stroke-opacity` is from 0 (completely transparent) to 1\n(solid colour). We should make the distinction at this point that `stroke-\nopacity` affects only the line or border of an element, whereas `opacity` will\naffect the entire element.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates an empty circle with a red border. The opacity value of .2 creates a\ndegree of transparency for the stroke which will show the grid lines\nunderneath (or at least make it appear more ‘muted’).\n\n    \n    \n    holder.append(\"circle\")          // attach a circle\n        .attr(\"cx\", 200)             // position the x-centre\n        .attr(\"cy\", 100)             // position the y-centre\n        .attr(\"r\", 50)               // set the radius\n        .style(\"stroke-opacity\", .2) // set the stroke opacity\n        .style(\"stroke\", \"red\")      // set the line colour\n        .style(\"fill\", \"none\");      // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Red Border and opacity](images/EAS-35.png) Circle with Red\nBorder and opacity\n\nAlthough it is not necessarily easy to see in this example because the line is\nquite thin, the lines of the grid behind the circle will be showing through\nthe line of the circle.\n\n####  `stroke-width`\n\nThe `stroke-width` style adjusts the width of the line of an element.\n\nThe value specified when setting `stroke-width` is in pixels.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates an empty circle with a red border. The `stroke-width` is set to 5\nwhich equates to 5 pixels (it can also be specified as “5px”).\n\n    \n    \n    holder.append(\"circle\")          // attach a circle\n        .attr(\"cx\", 200)             // position the x-centre\n        .attr(\"cy\", 100)             // position the y-centre\n        .attr(\"r\", 50)               // set the radius\n        .style(\"stroke-width\", 5)    // set the stroke width\n        .style(\"stroke\", \"red\")      // set the line colour\n        .style(\"fill\", \"none\");      // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Thicker Red Border](images/EAS-36.png) Circle with Thicker Red\nBorder\n\nThe width of the line that forms the border of the circle is now 5 pixels wide\n:-).\n\n####  `stroke-dasharray`\n\nThe `stroke-dasharray` style allows us to form element lines with dashes\ninstead of solid lines.\n\nWe have covered dashed lines in practical way in a previous section of the\nbook (‘Make a Dashed Line’) but for the sake of completeness I will include\ndashed lines here as well.\n\nWe create a dashed line by specifying the length of a dash and then the length\nof a space. We can include a long list of dashes and spaces and once complete\nour line will simply repeat the pattern we have specified.\n\nFor example the following code snippet (which works in conjunction with [the\nHTML file](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a line with a dash of 10 pixels followed by a space of 3 pixels;\n\n    \n    \n    holder.append(\"circle\")       // attach a circle\n        .attr(\"cx\", 200)          // position the x-centre\n        .attr(\"cy\", 100)          // position the y-centre\n        .attr(\"r\", 50)            // set the radius\n        .style(\"stroke-dasharray\", (\"10,3\")) // make the stroke dashed\n        .style(\"stroke\", \"red\")   // set the line colour\n        .style(\"fill\", \"none\");   // set the fill colour\n    \n\nWhich results in the following image;\n\n![Circle with Dashed Red Border](images/EAS-37.png) Circle with Dashed Red\nBorder\n\nMore complex combinations of dashes and spaces are possible as are complex\nanimation sequences that leverage the ability to move objects along a path\n(these are certainly more advanced examples).\n\n####  `stroke-linecap`\n\nThe `stroke-linecap` style allows control of the shape of the ends of lines in\nd3.js.\n\nThere are three shape options;\n\n  * `butt` where the line simply butts up to the starting or ending position and is cut off squarely.\n  * `round` where the line is rounded in proportion to its width.\n  * `square` where the line is squared off but extended in proportion to its width.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ngenerates three lines showing each `stroke-linecap` style option. The top line\nuses `butt`. The middle line uses `round` and the bottom line uses `square`.\n\n    \n    \n    holder.append(\"line\")                 // attach a line\n        .style(\"stroke\", \"black\")         // colour the line\n        .style(\"stroke-width\", 20)        // adjust line width\n        .style(\"stroke-linecap\", \"butt\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 50);     // y position of the second end of the line\n    \n    holder.append(\"line\")                  // attach a line\n        .style(\"stroke\", \"black\")          // colour the line\n        .style(\"stroke-width\", 20)         // adjust line width\n        .style(\"stroke-linecap\", \"round\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 100)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 100);    // y position of the second end of the line\n    \n    holder.append(\"line\")                   // attach a line\n        .style(\"stroke\", \"black\")           // colour the line\n        .style(\"stroke-width\", 20)          // adjust line width\n        .style(\"stroke-linecap\", \"square\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 150)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nWhich results in the following image;\n\n![Three Lines with Different End Shapes](images/EAS-38.png) Three Lines with\nDifferent End Shapes\n\nThe shapes are quite distinct for each type and it is useful to note the\ndegree to which the lines extend beyond their start and end points.\n\n####  `stroke-linejoin`\n\nThe `stroke-linejoin` style specifies the shape of the join of two lines. This\nwould be used on `path`, `polyline` and `polygon` elements (and possibly\nmore).\n\nThere are three line join options;\n\n  * `miter` where the join is squared off as would be expected at the join of two lines. \n  * `round` where the outside portion of the join is rounded in proportion to its width.\n  * `bevel` where the join has a straight edged outer portion clipped off to provide a slightly more contoured effect while still being angular.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ngenerates a poly line where the join has the connection shaped using the\n`stroke-linejoin` `round` style.\n\n    \n    \n    holder.append(\"polyline\")       // attach a polyline\n        .style(\"stroke\", \"black\")   // colour the line\n        .style(\"fill\", \"none\")      // remove any fill colour\n    \t.style(\"stroke-width\", 20)  // colour the line\n    \t.style(\"stroke-linejoin\", \"round\")  // shape the line join\n        .attr(\"points\", \"100,50, 200,150, 300,50\");  // x,y points \n    \n\nWhich results in the following image;\n\n![Polyline with Round Join](images/EAS-39.png) Polyline with Round Join\n\nNote the curve on the outer of the join.\n\nChanging the shape of the line join to `bevel` produces the following;\n\n![Polyline with Bevel Join](images/EAS-40.png) Polyline with Bevel Join\n\nHere we can see the clipping of the outer portion of the join.\n\nAnd using `miter` produces a standard connection;\n\n![Polyline with Miter Join](images/EAS-41.png) Polyline with Miter Join\n\nThis is the default setting for line joins and does not need to be added\nunless the line join type has already been set to a different default.\n\n####  `writing-mode`\n\nThe `writing-mode` style changes the orientation of the text so that it prints\nout top to bottom. It has a single option “tb” that accomplishes this. It is\nrelatively limited in scope compared to the equivalent for CSS, but for the\npurposes of generating some text it has a definite use.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a line of text that is now printed from top to bottom instead of left\nto right.\n\n    \n    \n    holder.append(\"text\")            // append text\n        .style(\"fill\", \"black\")      // make the text black\n        .style(\"writing-mode\", \"tb\") // set the writing mode\n        .attr(\"x\", 200)         // set x position of left side of text\n        .attr(\"y\", 100)         // set y position of bottom of text\n        .text(\"Hello World\");   // define the text to display\n    \n\nWhich results in the following image;\n\n![Text rotated using writing-mode](images/EAS-42.png) Text rotated using\nwriting-mode\n\nIt is significant to note that while it looks like the text has been rotated\nabout its anchor point, this actually isn’t the case since the anchor point\nshould be at 200,100. Also, the `glyph-orientation-vertical` style (which\nfollows) will allow the text to be orientated vertically which will be useful.\n\n####  `glyph-orientation-vertical`\n\nThe `glyph-orientation-vertical` style changes the rotation of the individual\nglyphs (characters) in text and if used in conjunction with the `writing-mode`\nstyle (and set to 0) will allow the text to be displayed vertically with the\nletters orientated vertically as well.\n\nThe following code snippet (which works in conjunction with [the HTML\nfile](chap06.xhtml#EASframework) outlined at the start of this chapter)\ncreates a line of text that is now printed from top to bottom with letters\norientated vertically.\n\n    \n    \n    holder.append(\"text\")            // append text\n        .style(\"fill\", \"black\")      // make the text black\n        .style(\"writing-mode\", \"tb\") // set the writing mode\n        .style(\"glyph-orientation-vertical\", 0)\n        .attr(\"x\", 200)         // set x position of left side of text\n        .attr(\"y\", 25)          // set y position of bottom of text\n        .text(\"Hello World\");   // define the text to display\n    \n\nWhich results in the following image;\n\n![Text rotated and orientated](images/EAS-43.png) Text rotated and orientated\n\nIt is worth noting that the text spacing increases dramatically as the spacing\nfor each letter relies on the normal distance between the bottom and top of a\nline of text.\n\n#### Using styles in Cascading Style Sheets\n\nDeclaring styles on an element by element basis is an OK way to apply styles,\nbut when our visualizations become more complex, this can be an inefficient\nuse of code.\n\nA smarter way to provide a common set of styles to elements is to declare them\nin the `<style>` section of our HTML document using Cascading Style Sheets\n(CSS). These will then be automatically applied to our elements.\n\nWe start with an example script that draws our three lines that have different\nstyles of linecaps. Our previous example looked like the following (in\nconjunction with [the HTML file](chap06.xhtml#EASframework) outlined at the\nstart of this chapter)\n\n    \n    \n    holder.append(\"line\")                 // attach a line\n        .style(\"stroke\", \"black\")         // colour the line\n        .style(\"stroke-width\", 20)        // adjust line width\n        .style(\"stroke-linecap\", \"butt\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 50);     // y position of the second end of the line\n    \n    holder.append(\"line\")                  // attach a line\n        .style(\"stroke\", \"black\")          // colour the line\n        .style(\"stroke-width\", 20)         // adjust line width\n        .style(\"stroke-linecap\", \"round\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 100)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 100);    // y position of the second end of the line\n    \n    holder.append(\"line\")                   // attach a line\n        .style(\"stroke\", \"black\")           // colour the line\n        .style(\"stroke-width\", 20)          // adjust line width\n        .style(\"stroke-linecap\", \"square\")  // stroke-linecap type\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 150)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nWhich resulted in the following image;\n\n![Three Lines with Different End Shapes](images/EAS-38.png) Three Lines with\nDifferent End Shapes\n\nThe block of code for each of the three lines contains three separate `style`\ndeclarations. Two of which are identical for all three blocks of code;\n\n    \n    \n        .style(\"stroke\", \"black\")         // colour the line\n        .style(\"stroke-width\", 20)        // adjust line width\n    \n\nTo make these styles available from a common point, we declare them in the\n`<style>` section of our HTML file as follows;\n\n    \n    \n    <style>\n    line.linecap {\n      stroke: black;\n      stroke-width: 20;  \n    }\n    </style>\n    \n\nThe `<style>` tags simply tell our browser which part of [the HTML\nfile](chap06.xhtml#EASframework) we are using to define our styles.\n\nThe `line.linecap` portion identifies the following styles as belonging to the\n`line` elements that are also identified as belonging to the ‘class’ `linecap`\n(We have used the `linecap` name as a convenience only and it could just as\neasily have been `foobar`.).\n\nThe two styles are enclosed within curly braces and are declared in the form\n`<style-name>: <style-value>;`. So for our example here, the stroke is black\nand its width is 20 pixels.\n\nThen our example script can have the two styles removed from each of the\nblocks that draws the lines and in their place we add a new attribute `class`\nthat assigns a class to the element (in this case the class `linecap`). Our\nnew code will look like this;\n\n    \n    \n    holder.append(\"line\")           // attach a line\n        .style(\"stroke-linecap\", \"butt\")  // stroke-linecap type\n        .attr(\"class\", \"linecap\")   // inherits styles from CSS\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 50)      // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 50);     // y position of the second end of the line\n    \n    holder.append(\"line\")           // attach a line\n        .style(\"stroke-linecap\", \"round\")  // stroke-linecap type\n        .attr(\"class\", \"linecap\")   // inherits styles from CSS\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 100)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 100);    // y position of the second end of the line\n    \n    holder.append(\"line\")           // attach a line\n        .style(\"stroke-linecap\", \"square\")  // stroke-linecap type\n        .attr(\"class\", \"linecap\")   // inherits styles from CSS\n        .attr(\"x1\", 100)     // x position of the first end of the line\n        .attr(\"y1\", 150)     // y position of the first end of the line\n        .attr(\"x2\", 300)     // x position of the second end of the line\n        .attr(\"y2\", 150);    // y position of the second end of the line\n    \n\nWhile this has only replaced two lines with one in our code, the potential for\nuse in far more complex examples should be obvious. There is significantly\nmore detail that can be gone into with regard to CSS, but that would be beyond\nmy meagre abilities.\n\n\n## Manipulating data\n\n### How to use data imported from a csv file with spaces in the header.\n\nWhen importing data from a csv file (dataSpace.csv) that has headers with\nspaces in the middle of some of the fields there is a need to address the data\nslightly differently in order for it to be used easily in your JavaScript.\n\nFor example the following csv data has a column named ‘Date Purchased’;\n\n    \n    \n    Date Purchased,close\n    1-May-12,58.13\n    30-Apr-12,53.98\n    27-Apr-12,67.00\n    26-Apr-12,89.70\n    25-Apr-12,99.00\n    \n\nThis is not an uncommon occurrence since [RFC\n4180](http://tools.ietf.org/html/rfc4180) which specifies csv content allows\nfor it and d3.js supports the RFC;\n\n> Within the header and each record, there may be one or more fields,\n> separated by commas. Each line should contain the same number of fields\n> throughout the file. Spaces are considered part of a field and should not be\n> ignored.\n\nWhen we go to import the data using the d3.csv function, we need to reference\nthe ‘Data Purchased’ column in a way that makes allowances for the space. The\nfollowing piece of script (with grateful thanks to [Stephen Thomas for\nanswering my Stack Overflow\nquestion](http://stackoverflow.com/questions/21715201/unable-to-\nreference-d3-js-data-imported-from-a-csv-file-with-spaces-in-the-heade))\nappears to be the most basic solution.\n\n    \n    \n    d3.csv(\"dataSpace.csv\", function(error, data) {\n      if (error) throw error;\n    \n      data.forEach(function(d) {\n          d.date = parseTime(d['Date Purchased']);\n      });\n    ...\n    });\n    \n\nIn the example above the ‘Date Purchased’ column is re-declared as ‘date’\nmaking working in the following script much easier.\n\n### Extracting data from a portion of a string.\n\nSuppose we have a set of values we want to extract from a string because they\ncannot be used in their original form.\n\nFor example, the following csv file contains the column ‘value’ and the values\nof the data in that column are prefixed with a dollar sign ($).\n\n    \n    \n    value,date,score\n    $1234,2011-03-23,99\n    $2234,2011-03-24,100\n    $3234,2011-03-25,99\n    $4235,2011-03-26,100\n    \n\nWe can use the JavaScript substring() method to easily remove the leading\ncharacter from the data.\n\nThe following example processes our csv file after loading it and for each\n‘value’ entry on each row takes a substring of the entry that removes the\nfirst character and retains the rest.\n\n    \n    \n    d3.csv(\"dataSample.csv\", function(error, data) {\n      if (error) throw error;\n    \n        data.forEach(function(d) {\n            d.value = +d.value.substring(1);\n        });\n    ...\n    });\n    \n\nThe substring() function includes a ‘start’ index (as used above) and\noptionally a ‘stop’ index. More on how these can be configured can be found on\nthe [w3schools](http://www.w3schools.com/jsref/jsref_substring.asp) site.\n\n### Grouping and summing data (d3.nest)\n\nOften we will wish to group elements in an array into a hierarchical structure\nsimilar to the `GROUP BY` operator in SQL (but with the scope for multiple\nlevels). This can be achieved using the\n[`d3.nest`](https://github.com/d3/d3-collection/blob/master/README.md#nests)\noperator. Additionally we will sometimes wish to collapse the elements that we\nare grouping in a specific way (for instance to sum values). This can be\nachieved using the `rollup` function.\n\nThe example we will use is having the following csv file consisting of a\ncolumn of dates and corresponding values;\n\n    \n    \n    date,value\n    23-Mar-11,3\n    23-Mar-11,2\n    24-Mar-11,3\n    24-Mar-11,3\n    24-Mar-11,6\n    24-Mar-11,2\n    24-Mar-11,7\n    25-Mar-11,4\n    25-Mar-11,5\n    25-Mar-11,1\n    25-Mar-11,4\n    \n\nWe will nest the data according to the date and sum the data for each date so\nthat our data is in the equivalent form of;\n\n    \n    \n    key,values\n    23-Mar-11,5\n    24-Mar-11,21\n    25-Mar-11,14\n    \n\nWe will do this with the following script;\n\n    \n    \n    d3.csv(\"source-data.csv\", function(error, csv_data) {\n      if (error) throw error;\n    \n    var data = d3.nest()\n        .key(function(d) { return d.date;})\n        .rollup(function(d) { \n            return d3.sum(d, function(g) {return g.value; });\n        }).entries(csv_data);\n    \n    });\n    \n\nWe are assuming the data is in a csv file and is named `source-data.csv`.\n\nThe first thing we do is load that file and assign the loaded array the\nvariable name `csv_data`.\n\n    \n    \n    d3.csv(\"source-data.csv\", function(error, csv_data) {\n      if (error) throw error;\n    \n\nThen we declare our new array’s name will be `data` and we initiate the `nest`\nfunction;\n\n    \n    \n    var data = d3.nest()\n    \n\nWe assign the `key` for our new array as `date`. A ‘key’ is like a way of\nsaying “ _This is the thing we will be grouping on_ ”. In other words our\nresultant array will have a single entry for each unique `date` value.\n\n    \n    \n        .key(function(d) { return d.date;})\n    \n\nThen we include the `rollup` function that takes all the individual `value`\nvariables that are in each unique `date` field and sums them;\n\n    \n    \n        .rollup(function(d) { \n            return d3.sum(d, function(g) {return g.value; });\n    \n\nLastly we tell the entire nest function which data array we will be using for\nour source of data.\n\n    \n    \n        }).entries(csv_data);\n    \n\nWhat if your data turns out to be unsorted? Never fear, we can easily sort on\nthe key value by tacking on the `sortKeys` function like so;\n\n    \n    \n        .key(function(d) { return d.date;}).sortKeys(d3.ascending)\n    \n\nYou should note that our data will have changed name from `date` and `value`.\nThis is as a function of the `nest` and `rollup` process. But never fear, it’s\na simple task to re-name them if necessary using the following function (which\ncould include a call to parse the date, but I have omitted it for clarity);\n\n    \n    \n    data.forEach(function(d) {\n        d.date = d.key;\n        d.value = d.values;\n    });\n    \n\n### Selecting a random string from an array.\n\nWhat if we had a situation where we wanted to be able to select a random\ncolour for the fill of a set of objects from a restricted set of colour\noptions.\n\n![An array of random colours](images/randomColour.png) An array of random\ncolours\n\nThe colours we want are green, orange, red and blue and the solution uses an\nadaptation of the one [presented by Jacob Relkin on\nstackoverflow](http://stackoverflow.com/questions/4550505/getting-random-\nvalue-from-an-array).\n\nFirst we start by declaring the colours in an array;\n\n    \n    \n    var colorRange = ['green', 'orange', 'red', 'blue']; \n    \n\nFrom there we set up the function that will return one of the elements of the\narray at random by calculating an index number from the array of possible\noptions based on the length of the array;\n\n    \n    \n    function randomColor() {\n        return colorRange[Math.floor(Math.random() * colorRange.length)];\n    }\n    \n\n`colorRange.length` returns the number of elements in the array (in this case\n4). This is multiplied by a random number between 0 and 1 (`Math.random()`).\nThen we get the largest integer that is less than or equal to our generated\nnumber using `Math.floor`. This ‘flattens out’ the result to be one of 0,1,2\nor 3.\n\nThen when we want to find one of our random colours we simply call our\n`randomColour` function a little like the following for a `fill`.\n\n    \n    \n    ...\n        .style(\"fill\", randomColor)\n    ...\n    \n\n\n## Bar Charts and Histograms\n\nYes! There is a difference! I know they look similar but for a bar charts,\neach column represents a group defined by a category and with a histogram,\neach column represents a group defined by a range.\n\n### Bar Chart\n\n![Bar chart](images/bar-01.png) Bar chart\n\n  * Each column is positioned over a label that represents a categorical variable.\n  * The height of the column indicates the size of the group defined by the category.\n\n#### Histogram\n\n![Histogram](images/hist-01.png) Histogram\n\n  * Each column is positioned over a label that represents a quantitative variable.\n  * The column label can be a single value or a range of values.\n\n### Bar Charts\n\nA bar chart is a visual representation using either horizontal or vertical\nbars to show comparisons between discrete categories. There are a number of\nvariations of bar charts including stacked, grouped, horizontal and vertical.\n\nWe will work through a simple vertical bar chart that uses a value on the y\naxis and category in the form of a name on the x axis.\n\nThe end result will look like this;\n\n![Bar chart](images/bar-01.png) Bar chart\n\n#### The data\n\nThe data for this example will be sourced from an external (purely fictional)\ncsv file named `sales.csv`. It consists of a column of names and ‘sales’ and\nits contents are as follows;\n\n    \n    \n    salesperson,sales\n    Bob,33\n    Robin,12\n    Anne,41\n    Mark,16\n    Joe,59\n    Eve,38\n    Karen,21\n    Kirsty,25\n    Chris,30\n    Lisa,47\n    Tom,5\n    Stacy,20\n    Charles,13\n    Mary,29\n    \n\n#### The code\n\nThe full code listing for the example we are going to work through is as\nfollows;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    .bar { fill: steelblue; }\n    \n    </style>\n    <body>\n    \t\n    <!-- load the d3.js library -->    \t\n    <script src=\"//d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // set the ranges\n    var x = d3.scaleBand()\n              .range([0, width])\n              .padding(0.1);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n              \n    // append the svg object to the body of the page\n    // append a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // get the data\n    d3.csv(\"sales.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n        d.sales = +d.sales;\n      });\n    \n      // Scale the range of the data in the domains\n      x.domain(data.map(function(d) { return d.salesperson; }));\n      y.domain([0, d3.max(data, function(d) { return d.sales; })]);\n    \n      // append the rectangles for the bar chart\n      svg.selectAll(\".bar\")\n          .data(data)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", function(d) { return x(d.salesperson); })\n          .attr(\"width\", x.bandwidth())\n          .attr(\"y\", function(d) { return y(d.sales); })\n          .attr(\"height\", function(d) { return height - y(d.sales); });\n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (bar.html and sales.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4).\n\n#### The bar chart explained\n\nIn the course of describing the operation of the file I will gloss over the\naspects of the structure of an HTML file which have already been described at\nthe start of the book. Likewise, aspects of the JavaScript functions that have\nalready been covered will only be briefly explained.\n\nThe start of the file deals with setting up the document’s head and body,\nloading the d3.javascript script and setting up the CSS in the `<style>`\nsection.\n\nThe CSS section sets styling for the colour of the bars. In all reality we\ncould have placed it as a style later in the code, but it’s nice to have\nsomething in the CSS area because you never know, we might want it later.\n\n    \n    \n    .bar { fill: steelblue; }\n    \n\nThen our JavaScript section starts and the first thing that happens is that we\nset the size of the area that we’re going to use for the chart and the\nmargins;\n\n    \n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 20, right: 20, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nThe next section of our code includes some of the functions that will be\ncalled from the main body of the code. This includes the functions to\ndetermine positioning in the x and y domains.\n\n    \n    \n    // set the ranges\n    var x = d3.scaleBand()\n              .range([0, width])\n              .padding(0.1);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n    \n\nThe band scale set up for the x domain is a neat function that allows the\ncreation of a series of uniform bands that can be computed from the assigned\nrange. For the purposes of our bar chart, these will be the equivalent of the\nbars. These bands and their properties (the spacing between them and other\ndetails) can be assigned for display purposes.\n\nFor example, in this case the padding is the space made available between\nbars. This is set to `0.1`, or 1/10th of the width of the space available for\neach band. If we were to alter the padding to `0.5` (or half the width of the\nband) we would have the following;\n\n![Bar chart with 0.5 padding](images/bar-02.png) Bar chart with 0.5 padding\n\nFor the full description of band scales, check out the [D3\nwiki](https://github.com/d3/d3-scale#band-scales).\n\nThe function to set the scaling in the y domain is the same as most of our\nother graph examples;\n\n    \n    \n    var y = d3.scaleLinear()\n              .range([height, 0])\n    \n\nThe next block of code selects the `body` on the web page and appends an svg\nobject to it of the size that we have set up with our `width`, `height` and\n`margin`s.\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\")\n    \n\nIt also adds a `g` element that provides a reference point for adding our\naxes.\n\nThen we begin the main body of our JavaScript. We load our csv file and then\nloop through it making sure that the dates and numerical values are recognised\ncorrectly;\n\n    \n    \n    // get the data\n    d3.csv(\"sales.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n        d.sales = +d.sales;\n      });\n    \n\nWe then work through our x and y data and ensure that it is scaled to the\ndomains we are working in;\n\n    \n    \n      // Scale the range of the data in the domains\n      x.domain(data.map(function(d) { return d.salesperson; }));\n      y.domain([0, d3.max(data, function(d) { return d.sales; })]);\n    \n\nThen we add the bars to our chart;\n\n    \n    \n      // append the rectangles for the bar chart\n      svg.selectAll(\".bar\")\n          .data(data)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", function(d) { return x(d.salesperson); })\n          .attr(\"width\", x.bandwidth())\n          .attr(\"y\", function(d) { return y(d.sales); })\n          .attr(\"height\", function(d) { return height - y(d.sales); });\n    \n\nThis block of code creates the bars (`selectAll(\"bar\")`) and associates each\nof them with a data set (`.data(data)`).\n\nWe then append a rectangle (`.append(\"rect\")`) with the colour assigned by our\nclass (set in the `<style>` section) along with values for x/y position. The\nwidth of the bars is determined from our band scale function we assigned\nearlier and is found by retrieving the value via the `.bandwidth()` call. The\nheight is as configured in our earlier code.\n\nFinally we append our axes;\n\n    \n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nThe end result is our pretty looking bar chart;\n\n![Bar chart](images/bar-01.png) Bar chart\n\n### Histograms\n\nA histogram is a graphical representation of the distribution of numerical\ndata. It is typically formed by creating ‘bins’ of a larger dataset that group\nthe data into a range of values and count the number of pieces of data fall\ninto each bin. Each bin is then represented as a bar showing the relationship\nbetween each range.\n\nThe example we will work through shows the frequency of earthquakes above\nmagnitude 3 between July 2010 and January 2012 in Christchurch, New Zealand (A\ntime of some significant seismic activity). Data was sourced from New\nZealand’s [Geonet](http://www.geonet.org.nz/) site.\n\n![Histogram](images/hist-01.png) Histogram\n\nWe can see that the data has been ‘binned’ by month and that between the 1st\nof September and the 1st of October there were over 1800 earthquakes\nregistering over magnitude 3.\n\n#### The data\n\nThe data for this example will be sourced from an external (purely fictional)\ncsv file named `sales.csv`. It consists of a column of dates in day-month-year\nformat (and magnitudes, which won’t be used in this graph) and its contents\nlooks similar to the following;\n\n    \n    \n    dtg,value\n    01-08-2010,3\n    01-08-2010,3\n    01-08-2010,3\n    01-08-2010,3\n    01-08-2010,3.1\n    01-08-2010,3.2\n    01-08-2010,3.2\n    .\n    .\n    .\n    31-12-2011,3.2\n    31-12-2011,3.3\n    31-12-2011,3.4\n    31-12-2011,3.5\n    31-12-2011,3.5\n    31-12-2011,4.1\n    31-12-2011,4.9\n    \n\n#### The code\n\nThe full code listing for the example we are going to work through is as\nfollows;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    rect.bar { fill: steelblue; }\n    \n    </style>\n    <body>\n    \n    <!-- load the d3.js library -->    \t\n    <script src=\"//d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 10, right: 30, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // parse the date / time\n    var parseDate = d3.timeParse(\"%d-%m-%Y\");\n    \n    // set the ranges\n    var x = d3.scaleTime()\n              .domain([new Date(2010, 6, 3), new Date(2012, 0, 1)])\n              .rangeRound([0, width]);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n    \n    // set the parameters for the histogram\n    var histogram = d3.histogram()\n        .value(function(d) { return d.date; })\n        .domain(x.domain())\n        .thresholds(x.ticks(d3.timeMonth));\n    \n    // append the svg object to the body of the page\n    // append a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // get the data\n    d3.csv(\"earthquakes.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseDate(d.dtg);\n      });\n    \n      // group the data for the bars\n      var bins = histogram(data);\n    \n      // Scale the range of the data in the y domain\n      y.domain([0, d3.max(bins, function(d) { return d.length; })]);\n    \n      // append the bar rectangles to the svg element\n      svg.selectAll(\"rect\")\n          .data(bins)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", 1)\n          .attr(\"transform\", function(d) {\n    \t\t  return \"translate(\" + x(d.x0) + \",\" + y(d.length) + \")\"; })\n          .attr(\"width\", function(d) { return x(d.x1) - x(d.x0) -1 ; })\n          .attr(\"height\", function(d) { return height - y(d.length); });\n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n          \n    });\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/96b74d0bd6d11427dd797892551a103c) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (histogram.html and earthquakes.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/96b74d0bd6d11427dd797892551a103c).\n\n#### The histogram explained\n\nIn the course of describing the operation of the file I will gloss over the\naspects of the structure of an HTML file which have already been described at\nthe start of the book. Likewise, aspects of the JavaScript functions that have\nalready been covered will only be briefly explained.\n\nThe start of the file deals with setting up the document’s head and body,\nloading the d3.javascript script and setting up the CSS in the `<style>`\nsection.\n\nThe CSS section sets styling for the colour of the rectangles that make up the\nbars. Similar to the Bar graph, we could have placed it as a style later in\nthe code, but it’s nice to have something in the CSS area.\n\n    \n    \n    rect.bar { fill: steelblue; }\n    \n\nThen our JavaScript section starts and the first thing that happens is that we\nset the size of the area that we’re going to use for the chart and the\nmargins;\n\n    \n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 10, right: 30, bottom: 30, left: 40},\n        width = 960 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nThen we declare the code that parses the time;\n\n    \n    \n    // parse the date / time\n    var parseDate = d3.timeParse(\"%d-%m-%Y\");\n    \n\nHere we have it set to look for time that is formatted as day-month-year.\n\nThe next section of our code scales the ranges for x and y.\n\n    \n    \n    // set the ranges\n    var x = d3.scaleTime()\n              .domain([new Date(2010, 6, 3), new Date(2012, 0, 1)])\n              .rangeRound([0, width]);\n    var y = d3.scaleLinear()\n              .range([height, 0]);\n    \n\n`y` is pretty standard, but for `x` we specify a time scale that has a domain\nthat goes from one date to another. The date specified here is mildly\nartificial in the sense that I selected it to look good with the graph when I\nadjust the bins (you’ll see later), but a bit of experimentation will see you\nright. Lastly for the x range we get it to round itself to logical values\nusing `rangeRound`.\n\nNow we start to setup the function that will apply the D3 magic required to\nform our histogram with the code;\n\n    \n    \n    // set the parameters for the histogram\n    var histogram = d3.histogram()\n        .value(function(d) { return d.date; })\n        .domain(x.domain())\n        .thresholds(x.ticks(d3.timeMonth));\n    \n\nThe `d3.histogram` function allows us to form our data into ‘bins’ that form “\n_discrete samples into continuous, non-overlapping intervals_ ”. In other\nwords in this case we are going to take a data set of close to 10,000 points\nand we are going to form them into bins corresponding to the months that they\noccurred in. The value that we’re going to bin will be the variable `date` and\nthey will fit into the domain that we have already specified in the range\nsection (via `.domain(x.domain())`). Lastly, we apply the thresholds that we\nare going to use for the bins which in this case is monthly via\n`.thresholds(x.ticks(d3.timeMonth));`.\n\nWe can very crudely change our histogram by simply changing that to\n`.thresholds(x.ticks(d3.timeWeek));` to produce the following;\n\n![Histogram with weekly bins](images/hist-02.png) Histogram with weekly bins\n\nAnd we can go slightly more extreme by specifying a daily bin and produce the\nfollowing;\n\n![Histogram with daily bins](images/hist-03.png) Histogram with daily bins\n\n(Although technically I cheated slightly with this version and I removed the\npadding between the bars to allow the data to be presented a bit more\nfaithfully.)\n\nThe next block of code selects the `body` on the web page and appends an svg\nobject to it of the size that we have set up with our `width`, `height` and\n`margin`s.\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nIt also adds a `g` element that provides a reference point for adding our\naxes.\n\nThen we begin the main body of our JavaScript. We load our csv file and then\nloop through it making sure that the dates converted into a time format\ncorrectly;\n\n    \n    \n    // get the data\n    d3.csv(\"earthquakes.csv\", function(error, data) {\n      if (error) throw error;\n    \n      // format the data\n      data.forEach(function(d) {\n          d.date = parseDate(d.dtg);\n      });\n    \n\nNow that we have our data we can put it into the appropriate bins using the\nhistogram function that we declared earlier;\n\n    \n    \n      // group the data for the bars\n      var bins = histogram(data);\n    \n\nAt this point we have two data sets. The first is our array of information\nfrom our earthquakes.csv file which is called ‘data’. The second is an array\nof grouped data called ‘bins’. We use the ‘bins’ data to draw our histogram.\n\nWe then use our ‘bin’ data to ensure that the y domain is scaled to the\nlongest bar in the ‘bins’ data set;\n\n    \n    \n      // Scale the range of the data in the y domain\n      y.domain([0, d3.max(bins, function(d) { return d.length; })]);\n    \n\nThen we add the bars to our chart;\n\n    \n    \n      // append the bar rectangles to the svg element\n      svg.selectAll(\"rect\")\n          .data(bins)\n        .enter().append(\"rect\")\n          .attr(\"class\", \"bar\")\n          .attr(\"x\", 1)\n          .attr(\"transform\", function(d) {\n    \t\t  return \"translate(\" + x(d.x0) + \",\" + y(d.length) + \")\"; })\n          .attr(\"width\", function(d) { return x(d.x1) - x(d.x0) -1 ; })\n          .attr(\"height\", function(d) { return height - y(d.length); });\n    \n\nThis block of code selects all the rectangles (`selectAll(\"rect\")`) and\nassociates each of them with our binned data set (`.data(bins)`).\n\nWe then append the rectangles (`.append(\"rect\")`) with the colour assigned by\nour class (set in the `<style>` section) and we offset all the bars by 1 to\nmake sure that we have a nice symmetrical set of bars with a thin separation\n(`.attr(\"x\", 1)`).\n\nThe transform function sets the starting point for where we begin drawing the\nrectangles and the height and width attributes set the height and width of the\nrectangles. If you really want to stop and look at the transform and height\nattributes you will notice that it seems a bit ‘odd’. That is because it draws\nthe graph from the top of the screen down. The origin is at the top left of\nthe screen remember and we are trying to represent bars that appear to extend\nupwards from a ‘0’ point (on the y axis) that exists at a distance ‘height’\nfrom the top of the screen. Sound weird. It is a little, but at the very least\nit’s logical. You can do it in several different ways, some more confusing\nthan this, and I think that this represents a good balance between code\ncomplexity and understandability.\n\nIt’s also useful to note that when our histogram function was creating our\nbins, it also associated some variables with each bin. `x0` and `x1` to denote\nthe start and stop point for each bin in the x domain and `length` for the\nnumber of data points in each bin. You can see more details in the [D3 wiki\nhere](https://github.com/d3/d3-array/blob/master/README.md#histogram).\n\nFinally we append our axes;\n\n    \n    \n      // add the x Axis\n      svg.append(\"g\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n      // add the y Axis\n      svg.append(\"g\")\n          .call(d3.axisLeft(y));\n    \n\nThe end result is our sharp looking histogram;\n\n![Histogram](images/hist-01.png) Histogram\n\n\n## Tree Diagrams\n\n### What is a Tree Diagram?\n\nThe ‘[Tree\nlayout](https://github.com/d3/d3-hierarchy/blob/master/README.md#_tree)’ is\nnot a distinct type of diagram per se. Instead, it’s representative of D3’s\nfamily of hierarchical layouts.\n\nIt’s designed to produce a ‘node-link’ diagram that lays out the connection\nbetween nodes in a method that displays the relationship of one node to\nanother in a parent-child fashion.\n\nFor example, the following diagram shows a root node (the starting position)\nlabelled ‘Top Node’ which has two children (Bob: Child of Top Node and Sally:\nChild of Top Node). Subsequently, Bob:Child of Top Node has two dependant\nnodes (children) ‘Son of Bob’ and ‘Daughter of Bob’.\n\n![Tree layout diagram](images/tree-01.png) Tree layout diagram\n\nThe clear advantage to this style of diagram is that describing it in text is\ndifficult, but representing it graphically makes the relationships easy to\ndetermine.\n\nThe data required to produce this type of layout needs to describe the\nrelationships, but this is not necessarily an onerous task. For example, the\nfollowing is the data (in JSON form) for the diagram above and it shows the\nminimum information required to form the correct layout hierarchy.\n\n    \n    \n      {\n        \"name\": \"Top Node\",\n        \"children\": [\n          {\n            \"name\": \"Bob: Child of Top Node\",\n            \"children\": [\n              {\n                \"name\": \"Son of Bob\"\n              },\n              {\n                \"name\": \"Daughter of Bob\"\n              }\n            ]\n          },\n          {\n            \"name\": \"Sally: Child of Top Node\"\n          }\n        ]\n      }\n    \n\nIt shows each node as having a name that identifies it on the tree and, where\nappropriate, the children it has (as an array).\n\nThe data shown above is arranged as a hierarchy and it is not always possible\nto source data that is organised so nicely. As we go through examples for this\ntype of diagram we will look at options for importing ‘flat’ data (for example\nfrom a csv file) and converting it into a hierarchical form.\n\nThere is a wealth of examples of tree diagrams on the web, but I would\nrecommend a visit to\n[blockbuilder.org](http://blockbuilder.org/search#d3version=v4;api=d3.tree) as\na starting point to get some ideas.\n\nIn this chapter we’re going to look at a very simple piece of code to generate\na tree diagram before looking at different ways to adapt it. Including\nrotating it to be vertical, adding some dynamic styling to the nodes,\nimporting from a flat file and from an external source. Finally we’ll look at\na more complex example that is more commonly used on the web that allows a\nuser to expand and collapse nodes interactively.\n\n### A simple Tree Diagram explained\n\nWe are going to work through a simple example of the code that draws a tree\ndiagram, This is more for the understanding of the process rather than because\nit is a good example of code for drawing a tree diagram. It is a very limited\nexample that lacks any real interactivity which is one of the strengths of\nd3.js graphics. However, we will outline the operation of an interactive\nversion towards the end of the chapter once we have explored some possible\nconfiguration options that we might want to make.\n\nThe graphic that we are going to generate will look like this…\n\n![Simple tree layout diagram](images/tree-02.png) Simple tree layout diagram\n\nYou might well be asking why, when introducing the topic of tree diagrams we\nshowed a horizontal tree and why we are now going to draw a vertical tree\ndiagram. That would be a good question that deserves a good answer. When we\nlook at the code for drawing a vertical tree diagram it will look logical and\nwe will be able to describe it beautifully. That’s because the default\nstandard when D3 is drawing a tree diagram is to have it going from top to\nbottom. When we look at a horizontal tree diagram, the diagram and the code\nhas to be rotated by 90 degrees. This means that when we go to move or draw\nsomething in the x direction we will need to move in the y direction in the\ncode and vice versa. It has the potential to be quite confusing, so if we\nconsider the vertical diagram first and then rotate everything it seems much\neasier. Trust me.\n\nThe full code for it looks like this;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n        \n    .node circle {\n      fill: #fff;\n      stroke: steelblue;\n      stroke-width: 3px;\n    }\n    \n    .node text { font: 12px sans-serif; }\n    \n    .node--internal text {\n      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #ccc;\n      stroke-width: 2px;\n    }\n    \n    </style>\n    \n    <body>\n    \n    <!-- load the d3.js library -->    \t\n    <script src=\"//d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \t\n    var treeData =\n      {\n        \"name\": \"Top Level\",\n        \"children\": [\n          { \n    \t\t\"name\": \"Level 2: A\",\n            \"children\": [\n              { \"name\": \"Son of A\" },\n              { \"name\": \"Daughter of A\" }\n            ]\n          },\n          { \"name\": \"Level 2: B\" }\n        ]\n      };\n    \n    // set the dimensions and margins of the diagram\n    var margin = {top: 40, right: 30, bottom: 50, left: 30},\n        width = 660 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([width, height]);\n    \n    //  assigns the data to a hierarchy using parent-child relationships\n    var nodes = d3.hierarchy(treeData);\n    \n    // maps the node data to the tree layout\n    nodes = treemap(nodes);\n    \n    // append the svg obgect to the body of the page\n    // appends a 'group' element to 'svg'\n    // moves the 'group' element to the top left margin\n    var svg = d3.select(\"body\").append(\"svg\")\n          .attr(\"width\", width + margin.left + margin.right)\n          .attr(\"height\", height + margin.top + margin.bottom),\n        g = svg.append(\"g\")\n          .attr(\"transform\",\n                \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"C\" + d.x + \",\" + (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" +  (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n    // adds each node as a group\n    var node = g.selectAll(\".node\")\n        .data(nodes.descendants())\n      .enter().append(\"g\")\n        .attr(\"class\", function(d) { \n          return \"node\" + \n            (d.children ? \" node--internal\" : \" node--leaf\"); })\n        .attr(\"transform\", function(d) { \n          return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", 10);\n    \n    // adds the text to the node\n    node.append(\"text\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"y\", function(d) { return d.children ? -20 : 20; })\n      .style(\"text-anchor\", \"middle\")\n      .text(function(d) { return d.data.name; });\n        \n    </script>\n    </body>\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/b024fcce8b4b9264011a1c3e7c7d70dc) or\nin the code samples bundled with this book (simple-vertical-tree-\ndiagram.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/b024fcce8b4b9264011a1c3e7c7d70dc).\n\nIn the course of describing the operation of the file I will gloss over the\naspects of the structure of an HTML file which have already been described at\nthe start of the book. Likewise, aspects of the JavaScript functions that have\nalready been covered will only be briefly explained.\n\nThe start of the file deals with setting up the document’s head and body\nloading the d3.js script and setting up the CSS in the `<style>` section.\n\nThe CSS section sets styling for the circle that represents the nodes, the\ntext alongside them and the links between them.\n\n    \n    \n    .node circle {\n      fill: #fff;\n      stroke: steelblue;\n      stroke-width: 3px;\n    }\n    \n    .node text { font: 12px sans-serif; }\n    \n    .node--internal text {\n      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #ccc;\n      stroke-width: 2px;\n    }\n    \n\nThen our JavaScript section starts and the first thing that happens is that we\ndeclare our array of data in the following code;\n\n    \n    \n    var treeData =\n      {\n        \"name\": \"Top Level\",\n        \"children\": [\n          { \n    \t\t\"name\": \"Level 2: A\",\n            \"children\": [\n              { \"name\": \"Son of A\" },\n              { \"name\": \"Daughter of A\" }\n            ]\n          },\n          { \"name\": \"Level 2: B\" }\n        ]\n      };\n    \n\nAs outlined at the start of the chapter, this data is encoded hierarchically\nin JavaScript Object Notation (JSON). Each node must have a name and if it is\ngoing to have subordinate nodes it must include a ‘children’ element. There\nare many examples of hierarchical data that can be encoded in this way. From\nthe traditional parent - offspring example to directories on a hard drive or a\nbreakdown of materials for a complex object. Any system of encoding where\nthere is a single outcome from multiple sources like an election or an alert\nencoding system dependent on multiple trigger points.\n\nThe next section of our code declares some of the standard features for our\ndiagram such as the size and shape of the svg container with margins included.\n\n    \n    \n    // set the dimensions and margins of the diagram\n    var margin = {top: 40, right: 90, bottom: 50, left: 90},\n        width = 660 - margin.left - margin.right,\n        height = 500 - margin.top - margin.bottom;\n    \n\nNow we start to get into the specifics for the diagram. The next block of code\ninvokes the D3 `.tree` component, configures the data and assigns it to the\ntree structure (no actual drawing mind you, just getting the data ready).\n\n    \n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([width, height]);\n    \n    //  assigns the data to a hierarchy using parent-child relationships\n    var nodes = d3.hierarchy(treeData);\n    \n    // maps the node data to the tree layout\n    nodes = treemap(nodes);\n    \n\nThe first part of this is the declaration of `treemap` as using the `d3.tree`\nfunction and assigning the size of the diagram from our earlier variables;\n\n    \n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([width, height]);\n    \n\nThen we assign our data (with the variable `treeData`) to `nodes` using the\n`d3.hierarchy` function.\n\n    \n    \n    //  assigns the data to a hierarchy using parent-child relationships\n    var nodes = d3.hierarchy(treeData, function(d) {\n        return d.children;\n      });\n    \n\nThis assigns a range of properties to each node including;\n\n  * `node.data` \\- the data associated with the node (in our case it will include the name accessible as `node.data.name`)\n  * `node.depth` \\- a representation of the depth or number of hops from the initial ‘root’ node.\n  * `node.height` \\- the greatest distance from any descendant leaf nodes\n  * `node.parent` \\- the parent node, or null if it’s the root node\n  * `node.children` \\- child nodes or undefined for any leaf nodes\n\nWhile we’re telling the function to use the ‘children’ elements from\n‘treeData’, to generate the properties for the nodes, by default it will use\nthe name ‘ _children_ ’ if a name is not specified.\n\nLastly for this block we map the ‘nodes’ data to the tree layout;\n\n    \n    \n    // maps the node data to the tree layout\n    nodes = treemap(nodes);\n    \n\nThe next block of code appends our SVG working area to the body of our web\npage and creates a group element (`<g>`) that will contain our svg objects\n(our nodes, text and links).\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n          .attr(\"width\", width + margin.left + margin.right)\n          .attr(\"height\", height + margin.top + margin.bottom),\n        g = svg.append(\"g\")\n          .attr(\"transform\",\n                \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nNow we’re going to start drawing something! First up is the trickiest part.\nThe links between the nodes.\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"C\" + d.x + \",\" + (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" +  (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n\nI say _tricky_ because we’re going to be using the svg mini language again,\nand while it will work just fine if we simply paste it in and move on, if we\nwant to understand a bit more about how it works, we will need to take a bit\nof a detour.\n\nBut first we need to get the details for this block of code explained. We\ndeclare and select all the ‘links’ and then assign the nodes as ‘data’\n(`.data(nodes.descendants().slice(1))`). When we do this we are using\n`.descendants()` to return the array of ‘descendant’ nodes. We also specify\n`.slice(1)` to not include the main ‘root’ node since the links will be drawn\nby drawing a line from a child node to its parent (which we wouldn’t be able\nto do with the root node).\n\nWe append a path (`.enter().append(\"path\")`) and apply some styling\n(`.attr(\"class\", \"link\")`) and then embark on drawing the link lines with the\nSVG mini language via the ‘d’ attribute.\n\nAs we have mentioned previously the ‘d’ attribute allows for the creation of a\nstring of instructions that describe a path. These instructions include;\n\n  * Moveto : moves the drawing point using `M` for absolute coordinates and `m` for relative movements \n  * Lineto : draws a straight line from the current position to the next specified location using `L` for absolute coordinates and `l` for relative movement.\n  * Curveto : draws a [Bezier curve](https://developer.mozilla.org/en-US/docs/User:Jt_Sandbox/Curves_in_Paths) using control points from the current position to an end point. `C` designates absolute coordinates and `c` is used for relative movement. Either one or two sets of control points are used depending on whether a quadratic or cubic Bezier curve is used. \n  * Arcto : describes a curved path as an elliptical curve rather than a Bezier with additional complexity\n  * ClosePath : draws a straight line from the current position to the first point in the path\n\nIf we look at a single node instance and break down the ‘d’ attribute path we\ncan see the following;\n\n  * `\"M\" + d.x + \",\" + d.y` : Moves to the starting point of our node\n  * `\"C\" + d.x + \",\" + (d.y + d.parent.y) / 2` : Establishes that we are going to draw a Cubic (`C`) Bezier curve and the first control point for it is at `d.x` in the x dimension and halfway between the starting node and its parent.\n  * `\" \" + d.parent.x + \",\" + (d.y + d.parent.y) / 2` : Sets the second control point for the curve in line with the parent node in the x dimension and still halfway between the starting node and its parent in the y dimension.\n  * `\" \" + d.parent.x + \",\" + d.parent.y` : sets the end point for our curve at the parent node location.\n\n![Tree layout node locations for links](images/tree-03.png) Tree layout node\nlocations for links\n\nIf we wanted to make the code easier to follow we could change the curve\nbetween nodes to a straight line with the following code;\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"L\" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n\nWhich would result in lines being drawn with coordinates from the ‘d’\nattribute as follows;\n\n![Tree layout node locations for links](images/tree-03a.png) Tree layout node\nlocations for links\n\nThen we create a variable `node` that creates a group element (`g`) for each\nnode;\n\n    \n    \n    // adds each node as a group\n    var node = g.selectAll(\".node\")\n        .data(nodes.descendants())\n      .enter().append(\"g\")\n        .attr(\"class\", function(d) { \n          return \"node\" + \n            (d.children ? \" node--internal\" : \" node--leaf\"); })\n        .attr(\"transform\", function(d) { \n          return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n    \n\nThis time we can see that;\n\n  * We don’t slice off the root node (`.data(nodes.descendants())`) from our data set.\n  * We apply a different ‘class’ to the node depending on whether it’s an internal node (it has children) or it’s a leaf node (it has no children) `d.children ? \" node--internal\" : \" node--leaf\"`. \n  * We place each node ‘group’ at the appropriate location.\n  * We don’t _actually_ draw anything. All we’re doing is getting the properties for each node set.\n\nOnce we have everything set up we can start to add objects to our node groups.\n\nFirst we add our circle;\n\n    \n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", 10);\n    \n\nAnd then we add the text;\n\n    \n    \n    // adds the text to the node\n    node.append(\"text\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"y\", function(d) { return d.children ? -20 : 20; })\n      .style(\"text-anchor\", \"middle\")\n      .text(function(d) { return d.data.name; });\n    \n\nWhen we’re adding the text, we make sure that we add it on the side\nappropriate for either a leaf node or an internal node.\n\nAnd there’s our tree diagram.\n\n![Simple tree layout diagram](images/tree-02.png) Simple tree layout diagram\n\n### A horizontal tree diagram explained\n\nAs we discussed at the start of the previous section, we wanted to start\ndescribing tree diagrams with a vertical version because there was an added\ndegree of complexity with the horizontal version that might cause some\nconfusion. If you have worked through and understood the vertical version, the\nhorizontal won’t present any problems other than when you go “ _Oh, I see\nwhat’s going on._ ”. If you find yourself part way through this description of\nthe changes to the code and can’t see what’s going on, revisit the vertical\ncode and come back.\n\nThe graphic that we are going to generate will look like this…\n\n![Horizontal tree layout diagram](images/htree-01.png) Horizontal tree layout\ndiagram\n\nThe full code for this is almost identical to the code for the vertical tree\ndiagram with a couple of simple, yet major changes.\n\nThe first change is that the way that we draw the diagram relies on changing\nour reference by rotating everything by 90 degrees.\n\n![Rotate the tree by 90 degrees](images/htree-02.png) Rotate the tree by 90\ndegrees\n\nThe (very simplistic) diagram shows that what used to be our ‘x’ dimension is\nnow our ‘y’ dimension and visa versa.\n\nThe second change is that where we rotated our axes above we are now left with\ny and x dimensions that have an origin in the bottom left of the graph. Of\ncourse when we draw our diagram, the origin is in the top left corner. This\nvertical flip occurs automatically and is the reason the diagram doesn’t\nappear to have ‘just’ rotated.\n\n![Flip the tree vertically](images/htree-03.png) Flip the tree vertically\n\nNow we have our origin in the top left again and the layout of our tree looks\npretty much as the example we will be producing.\n\nBelieve it or not, this is **WAY** more difficult to explain than it is to\nactually do. Again, D3 takes care of the heavy lifting, the explanation of the\nchanges above is just to help us understand _why_ we make some of the changes.\n\nThe first change we make is just to give ourselves some extra margin space\nsince some of the labels extend slightly more left and right with a horizontal\ndiagram;\n\n    \n    \n    var margin = {top: 20, right: 90, bottom: 30, left: 90},\n    \n\nThe second change sets the size of the graphic. Here the width and height are\nswapped as part of the rotation.\n\n    \n    \n    // declares a tree layout and assigns the size\n    var treemap = d3.tree()\n        .size([height, width]);\n    \n\nWhen we add the links we need to incorporate the rotation and the easiest way\nto appreciate the change is to compare the two pieces of code at the same\ntime. In fact it is only when we draw the ‘d’ attribute for the path that we\nsee the changes.\n\nFirstly the vertical tree code;\n\n    \n    \n        .attr(\"d\", function(d) {\n           return \"M\" + d.x + \",\" + d.y\n             + \"C\" + d.x + \",\" + (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" +  (d.y + d.parent.y) / 2\n             + \" \" + d.parent.x + \",\" + d.parent.y;\n           });\n    \n\nThen the horizontal tree code;\n\n    \n    \n        .attr(\"d\", function(d) {\n           return \"M\" + d.y + \",\" + d.x\n             + \"C\" + (d.y + d.parent.y) / 2 + \",\" + d.x\n             + \" \" + (d.y + d.parent.y) / 2 + \",\" + d.parent.x\n             + \" \" + d.parent.y + \",\" + d.parent.x;\n           });\n    \n\nWhile there is a bit of math involved, the easiest way to tell that there is a\ndifference is that for the horizontal tree, each coordinate is being described\nin y,x fashion rather than the conventional x,y.\n\nA similar coordinate change is made when we translate the positions for the\nnodes;\n\n    \n    \n        .attr(\"transform\", function(d) { \n          return \"translate(\" + d.y + \",\" + d.x + \")\"; });\n    \n\nAnd lastly when we place the text next to the circles we need to adjust the\ndefault ‘y’ distance value with an ‘x’ distance value and to ensure that the\nlabels are spaced at an appropriate distance and to align the text to either\nthe left or right depending on whether it has children or not. We adjust the\ntext anchor appropriately with an ‘end’ or ‘start’.\n\n    \n    \n    node.append(\"text\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"x\", function(d) { return d.children ? -13 : 13; })\n      .style(\"text-anchor\", function(d) { \n        return d.children ? \"end\" : \"start\"; })\n      .text(function(d) { return d.data.name; });\n    \n\nAnd there we are….\n\n![Horizontal tree layout diagram](images/htree-01.png) Horizontal tree layout\ndiagram\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/5537fe63086c4f100114f87f124850dd), or\nin the code samples bundled with this book (simple-horizontal-tree-\ndiagram.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/5537fe63086c4f100114f87f124850dd).\n\n### Styling nodes in a tree diagram\n\n#### Changing node and link colours\n\nThe nodes in a tree diagram are objects that exist to provide a representation\nof the structure of data, but on a tree diagram they should also be viewed as\nan opportunity to encode additional information about the underlying data.\n\nFrom the horizontal example shown we have encoded a certain amount of\ninformation already. The position of the text relative to each node is\ndetermined by whether or not the node is the parent of another node (if it’s a\nparent it’s on the left) or a child that is on the edge of the tree (in which\ncase it is on the right of the node).\n\n![Node position on the tree diagram](images/htree-01.png) Node position on the\ntree diagram\n\nNow, that’s nice, but are we going to be satisfied with that??? (The answer is\n“No” by the way.)\n\nThis example is fairly simple, but it is an example of applying different\nstyles to the nodes to convey additional information. I should be clear at\nthis stage that I am not advocating turning your tree diagram into something\nthat looks like it came out of a circus, because that would be a crime against\nstyle, so don’t repeat my upcoming example, but let some of the features be a\ntrigger for developing your own subtle, yet compelling visualizations.\n\nBrace yourself. Here’s a picture of the tree diagram that we’re going to\ngenerate. Those with weaker constitutions should look away and flip forward a\nfew pages;\n\n![Tree diagram with excessive styling](images/tree-07.png) Tree diagram with\nexcessive styling\n\nThe changes that have been made are as a result of additional data fields that\nhave been added to the JSON array and these fields have been applied to\nvarious style options throughout the code.\n\nThe types of style changes we have made are \\- Variation of the diameter of\nnodes \\- Changing the fill and stroke colour of nodes \\- Changing the colour\nof links depending on the associated node they are connected to.\n\nThe code changes we describe from here are assuming that we start with our\nsimple horizontal tree diagram from the previous chapter. We’ll start by\nlooking at the new JSON data set;\n\n    \n    \n      {\n        \"name\": \"Top Level\",\n        \"value\": 10,\n        \"type\": \"black\",\n        \"level\": \"red\",\n        \"children\": [\n          {\n            \"name\": \"Level 2: A\",\n            \"value\": 15,\n            \"type\": \"grey\",\n            \"level\": \"red\",\n            \"children\": [\n              {\n                \"name\": \"Son of A\",\n                \"value\": 5,\n                \"type\": \"steelblue\",\n                \"level\": \"orange\"\n              },\n              {\n                \"name\": \"Daughter of A\",\n                \"value\": 8,\n                \"type\": \"steelblue\",\n                \"level\": \"red\"\n              }\n            ]\n          },\n          {\n            \"name\": \"Level 2: B\",\n            \"value\": 10,\n            \"type\": \"grey\",\n            \"level\": \"green\"\n          }\n        ]\n      }\n    \n\nEach node now has a `value` which might represent a degree of importance (we\nwill use this to affect the radius of the nodes), a `type` which might\nindicate a difference in the type of node (they might be in active, inactive\nor undetermined states) and a `level` which might indicate an alert level for\ndetermining problems (red = bad, orange = caution and green = normal).\n\nIrrespective of the contrived nature of our styling options, they are applied\nto our tree in fairly similar ways with some subtle differences.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/08ecb6ea9bb68ba0d9a7e89f344acec8) or\nin the code samples bundled with this book (tree-styling.html). A working\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/08ecb6ea9bb68ba0d9a7e89f344acec8).\n\nThe first change is to the node radius, stroke colour and fill colour.\n\nWe simply change the portion of the code that appends the circle from this…\n\n    \n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", 10);\n    \n\n… to this …\n\n    \n    \n    // adds the circle to the node\n    node.append(\"circle\")\n      .attr(\"r\", function(d) { return d.data.value; })\n      .style(\"stroke\", function(d) { return d.data.type; })\n      .style(\"fill\", function(d) { return d.data.level; });\n    \n\nThe changes return the radius attribute as a function using `data.value`, the\nstroke colour is returned using `data.type` and the fill colour is returned\nwith `data.level`. This is nice and simple, but we do need to make a slight\nadjustment to the code that sets the distance that the text is from the nodes\nso that when the radius expands or contracts, the text distance from the edge\nof the node adjusts as well.\n\nTo do this we take the clever piece of code that adjusts the distance that the\ntext is in the x dimension from the node that looks like this …\n\n    \n    \n      .attr(\"x\", function(d) { return d.children ? -13 : 13; })\n    \n\n… and we add in a dynamic aspect using the `data.value` field.\n\n    \n    \n      .attr(\"x\", function(d) { return d.children ? \n        (d.data.value + 4) * -1 : d.data.value + 4 })\n    \n\nThe last thing we wanted to do is to change the colour of the link based on\nthe colour of the node. We accomplish this by taking the code that inserts the\nlinks…\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .attr(\"d\", function(d) {\n           return \"M\" + d.y + \",\" + d.x\n             + \"C\" + (d.y + d.parent.y) / 2 + \",\" + d.x\n             + \" \" + (d.y + d.parent.y) / 2 + \",\" + d.parent.x\n             + \" \" + d.parent.y + \",\" + d.parent.x;\n           });;\n    \n\n… and adding in a line that styles the link colour (the stroke) based on the\n`data.level` colour of node.\n\n    \n    \n    // adds the links between the nodes\n    var link = g.selectAll(\".link\")\n        .data( nodes.descendants().slice(1))\n      .enter().append(\"path\")\n        .attr(\"class\", \"link\")\n        .style(\"stroke\", function(d) { return d.data.level; })\n        .attr(\"d\", function(d) {\n           return \"M\" + d.y + \",\" + d.x\n             + \"C\" + (d.y + d.parent.y) / 2 + \",\" + d.x\n             + \" \" + (d.y + d.parent.y) / 2 + \",\" + d.parent.x\n             + \" \" + d.parent.y + \",\" + d.parent.x;\n           });\n    \n\nUse the concepts here wisely. I don’t want to see any heinously styled tree\ndiagrams floating around the internet with “Thanks to the help from D3 Tips\nand Tricks” next to them. Be subtle, be thoughtful :-).\n\n#### Changing the nodes to different shapes\n\nMany thanks to Josiah who [asked a\nquestion](http://www.d3noob.org/2014/01/tree-diagrams-\nin-d3js_11.html?showComment=1398062145979#c8289012474475643167) on the\nd3noob.org blog on how the shapes of the nodes could be varied based on an\nassociated value in the data.\n\nThere is more than one way to do this, but perhaps the simplest is to replace\nthe section of the JavaScript that appends the circle with one that appends a\nsymbol from d3’s [symbol\ngenerator](https://github.com/d3/d3-shape/blob/master/README.md#symbols).\n\nThere are six pre-defined symbol types as follows;\n\n  * circle (`d3.symbolCircle`) - a circle.\n  * cross (`d3.symbolCross`) - a Greek cross or plus sign.\n  * diamond (`d3.symbolDiamond`) - a rhombus.\n  * square (`d3.symbolSquare`) - an axis-aligned square.\n  * triangle (`d3.symbolTriangle`) - an upward-pointing equilateral triangle.\n  * star (`d3.symbolStar`) - a five pointed star.\n  * ‘Y’ (`d3.symbolWye`) - a ‘Y’ shape.\n\nIf we start with our ‘[tree-styling](chap09.xhtml#tree-styling)’ script from\nabove we can replace the code block that added the circles with the following\nscript will look at the `value` in the data and assign either a cross or a\ndiamond depending on the `value`\n\n    \n    \n    // adds symbols as nodes\n    node.append(\"path\")\n      .style(\"stroke\", function(d) { return d.data.type; })\n      .style(\"fill\", function(d) { return d.data.level; })\n      .attr(\"d\", d3.symbol()\n         .size(function(d) { return d.data.value * 30; } )\n         .type(function(d) { if\n           (d.data.value >= 9) { return d3.symbolCross; } else if\n           (d.data.value <= 9) { return d3.symbolDiamond;}\n         }));\n    \n\nIt will also adjust the size of the symbol along with the stroke and fill.\n\n![Tree diagram different node shapes](images/tree-12.png) Tree diagram\ndifferent node shapes\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/76d6fa0dff4af77544da9dd69aef9249) or\nin the code samples bundled with this book (tree-symbol.html). A working\nonline example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/76d6fa0dff4af77544da9dd69aef9249).\n\n#### Using images as nodes\n\nMany thanks to nbhatta who [asked a\nquestion](http://www.d3noob.org/2014/01/tree-diagrams-\nin-d3js_11.html?showComment=1399025834455#c4911480988339223702) on the\nd3noob.org blog on how to use images as nodes.\n\n![Tree diagram with images for nodes](images/tree-13.png) Tree diagram with\nimages for nodes\n\nThis was a slightly simpler change and just involved replacing the code\nsnippet that added the circles with one that added an image;\n\n    \n    \n    // adds images as nodes\n    node.append(\"image\")\n      .attr(\"xlink:href\", function(d) { return d.data.icon; })\n      .attr(\"x\", \"-12px\")\n      .attr(\"y\", \"-12px\")\n      .attr(\"width\", \"24px\")\n      .attr(\"height\", \"24px\");\n    \n\nThe images I chose were all 48 x 48 pixel for the sake of consistency and in\nthe code above I formatted them to be half that size and moved them in the x\nand y direction so that they were centred correctly.\n\nThe cool thing that you will notice is that the specific icon that is placed\nat each node position is set by the name of the icon which is gathered from\nthe JSON file with the tree details;\n\n    \n    \n    var treeData = \n      {\n        \"name\": \"Top Level\",\n        \"value\": 10,\n        \"type\": \"black\",\n        \"level\": \"red\",\n        \"icon\": \"earth.png\",\n        \"children\": [\n          {\n            \"name\": \"Level 2: A\",\n            \"value\": 5,\n            \"type\": \"grey\",\n            \"level\": \"red\",\n           \"icon\": \"cart.png\",\n            \"children\": [\n              {\n                \"name\": \"Son of A\",\n                \"value\": 5,\n                \"type\": \"steelblue\",\n                \"icon\": \"lettern.png\",\n                \"level\": \"orange\"\n              },\n              {\n                \"name\": \"Daughter of A\",\n                \"value\": 18,\n                \"type\": \"steelblue\",\n                \"icon\": \"vlc.png\",\n                \"level\": \"red\"\n              }\n            ]\n          },\n          {\n            \"name\": \"Level 2: B\",\n            \"value\": 10,\n            \"type\": \"grey\",\n            \"icon\": \"random.png\",\n            \"level\": \"green\"\n          }\n        ]\n      };\n    \n\nIt’s possible to just have a single image and to hard-code it into the script,\nbut where’s the fun in that?\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/52945c64ab37f9f285c8797bcbf86d16) or\nin the code samples bundled with this book (tree-images.html, cart.png,\nearth.png, lettern.png, random.png and vlc.png). A working online example can\nbe found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/52945c64ab37f9f285c8797bcbf86d16).\n\n### Generating a tree diagram from external data\n\nIn all the examples we have looked at so far we have used data that we have\ndeclared from within the file itself. Being able to import data from an\nexternal file is an important feature that we need to know how to implement.\n\nStarting from the simple tree diagram example that we began with at the start\nof the chapter, the first change that we need to make is to remove the section\nof code that declares our data. But don’t throw it away since we will use it\nto create a separate file called `treeData.json`. Its contents will be;\n\n    \n    \n    {\n      \"name\": \"Top Level\",\n      \"children\": [\n        { \n          \"name\": \"Level 2: A\",\n          \"children\": [\n            { \"name\": \"Son of A\" },\n            { \"name\": \"Daughter of A\" }\n          ]\n        },\n        { \"name\": \"Level 2: B\" }\n      ]\n    }\n    \n\n(don’t include the `treeData =` part, or the semicolon at the end (you _can_\ndelete those))\n\nThen all we need to do is include a section that uses the `d3.json` accessor\nto load the file `treeData.json` (Remember to correctly address the file. This\none assumes that the `treeData.json` file is in the same directory as the html\nfile we are opening).\n\n    \n    \n    // load the external data\n    d3.json(\"treeData.json\", function(error, treeData) {\n      if (error) throw error;\n    \n\nWe can put it somewhere near the start of the JavaScript, but make sure it\ncomes before the ‘nodes’ declaration (when in doubt, check out the sample\ncode).\n\nWe also need to make sure that we include the wrapping, closing curly braces\nand bracket / semicolon (`});`) at the end of the script.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/d316a488cae262ae24e6ca897b209f9e) or\nin the code samples bundled with this book (tree-from-external.html and\ntreeData.json). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/d316a488cae262ae24e6ca897b209f9e).\n\n### Generating a tree diagram from ‘flat’ data\n\nTree diagrams are a fantastic way of displaying information, but one of the\ndrawbacks (to the examples we’ve been using so far) is the need to have your\ndata encoded hierarchically. Most data in a raw form will be flat. That is to\nsay, it won’t be formatted as an array with the parent - child relationships.\nInstead it will be a list of objects (which we will want to turn into nodes)\nthat might describe the relationship to each other, but they won’t be encoded\nthat way. For example, the following is the flat representation of the example\ndata we have been using thus far.\n\n    \n    \n      {\"name\": \"Top Level\", \"parent\": null}, \n      {\"name\": \"Level 2: A\", \"parent\": \"Top Level\" },\n      {\"name\": \"Level 2: B\", \"parent\": \"Top Level\" },\n      {\"name\": \"Son of A\", \"parent\": \"Level 2: A\" },\n      {\"name\": \"Daughter of A\", \"parent\": \"Level 2: A\" }\n    \n\nIt is actually fairly simple and consists of only the name of the node and the\nname of its parent node. It’s easy to see how this data could be developed\ninto a hierarchical form, but it would take a little time and for a larger\ndata set, that would be tiresome.\n\nLuckily computers are built for shuffling data about and with the advent of v4\nof d3.js we now have the `d3.stratify` operator that will convert flat data\ninto a hierarchy suitable for use in our tree diagram.\n\nWe will be using the simple example that we started with at the start of the\nchapter and the first change we need to make is to replace our original data…\n\n    \n    \n    var treeData =\n      {\n        \"name\": \"Top Level\",\n        \"children\": [\n          { \n    \t\t\"name\": \"Level 2: A\",\n            \"children\": [\n              { \"name\": \"Son of A\" },\n              { \"name\": \"Daughter of A\" }\n            ]\n          },\n          { \"name\": \"Level 2: B\" }\n        ]\n      };\n    \n\n… with our flat data array…\n\n    \n    \n    var flatData = [\n      {\"name\": \"Top Level\", \"parent\": null}, \n      {\"name\": \"Level 2: A\", \"parent\": \"Top Level\" },\n      {\"name\": \"Level 2: B\", \"parent\": \"Top Level\" },\n      {\"name\": \"Son of A\", \"parent\": \"Level 2: A\" },\n      {\"name\": \"Daughter of A\", \"parent\": \"Level 2: A\" }\n    ];\n    \n\nIt’s worth noting here that we have also changed the name of the array (to\n`flatData`) since we are going to convert, then declare our newly massaged\ndata with our original variable name `treeData` so that the remainder of our\ncode thinks there have been no changes.\n\nThen we use the `d3.stratify` operator on our flat data;\n\n    \n    \n    // convert the flat data into a hierarchy \n    var treeData = d3.stratify()\n      .id(function(d) { return d.name; })\n      .parentId(function(d) { return d.parent; })\n      (flatData);\n    \n\nThe stratify function requires a unique identifier to be used for each node\nand it will be declared as `.id`. In this example each of our nodes has a\nunique ‘name’, so we are using that as our `id` (`.id(function(d) { return\nd.name; })`). We also need to understand the hierarchy by having each node\nidentify who its parent is. This will be stored as `parentId`\n(`.parentId(function(d) { return d.parent; })`)\n\nThat’s it!\n\nBecause we want to be able to use our code as intact as possible from our\nhorizontal tree example we will want to run through our dataset and assign the\n‘name’ to each node that has been stored as `id`;\n\n    \n    \n    // assign the name to each node\n    treeData.each(function(d) {\n        d.name = d.id;\n      });\n    \n\nThat’s it!\n\nThe brevity of the code to do this is fantastic and well done to Mike Bostock\nfor including the new function in v4. Of course, the end result looks exactly\nthe same;\n\n![Tree diagram \\(but from flat data\\)](images/htree-01.png) Tree diagram (but\nfrom flat data)\n\n… but it adds a significant capability for use of additional data.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/e7e37cfe0e8763cb0915dee33cc2a24b) or\nin the code samples bundled with this book (tree-from-flat.html). A working\nexample can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/e7e37cfe0e8763cb0915dee33cc2a24b).\n\n### Generating a tree diagram from a CSV file.\n\nCreating a tree diagram from a csv file is an extension of the sections where\nwe [create a diagram from flat data](chap09.xhtml#treeFromFlat) and where we\n[create a diagram from an external file](chap09.xhtml#treeFromExternal).\n\nBy mashing these together and using a csv file something like the following…\n\n    \n    \n    name,parent\n    Top Level,null\n    Level 2: A,Top Level\n    Level 2: B,Top Level\n    Son of A,Level 2: A\n    Daughter of A,Level 2: A\n    \n\n… we can ingest the name of the nodes and their relationships and then format\nthe data correctly.\n\nThe main piece of code that we would add that is different from the standard\nhorizontal tree diagram is as follows;\n\n    \n    \n    // load the external data\n    d3.csv(\"treeCsv.csv\", function(error, flatData) {\n      if (error) throw error;\n    \n      // assign null correctly\n      flatData.forEach(function(d) {\n          if (d.parent == \"null\") { d.parent = null};\n        });\n    \n      // convert the flat data into a hierarchy \n      var treeData = d3.stratify()\n        .id(function(d) { return d.name; })\n        .parentId(function(d) { return d.parent; })\n        (flatData);\n    \n      // assign the name to each node\n      treeData.each(function(d) {\n          d.name = d.id;\n        });\n    \n\nThe only part of that code which is new is the portion where we look for the\nnode whose parent is ‘“null”’ and change it to null. This is necessary since\nthe script interprets the name as actually being the text ‘null’ so we have to\nforce the code to realise that we want it to refer to a null amount.\n\nThe end result looks very familiar.\n\n![Tree diagram \\(but from csv\\)](images/htree-01.png) Tree diagram (but from\ncsv)\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/https://gist.github.com/d3noob/1dbf3d4abe0ab53f8c4c6bd24192bb6b)\nor in the code samples bundled with this book (tree-from-csv.html and\ntreeCsv.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/1dbf3d4abe0ab53f8c4c6bd24192bb6b).\n\n### An interactive tree diagram\n\nThe examples presented thus far have all been static in the sense that they\npresent information on a web page, but that’s where they stop. One of the\nstrengths of web content is the ability to involve the reader to a greater\nextent. Therefore the following tree diagram example includes an interactive\nelement where the user can click on any parent node and it will collapse on\nitself to make more room for others or to simplify a view. Additionally, any\ncollapsed parent node can be clicked on and it will re-grow to its previous\ncondition.\n\nThe example included here has it’s roots in the is v3 tree diagram of [Mike\nBostock’s example](http://bl.ocks.org/mbostock/4339083). Kudos and thanks also\ngo out to Soumya Ranjan for steering me in the fight direction for the\ndiagonal solution. This was necessary to work around the deprecation of\n`svg.diagonal` in v3.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/43a860bc0024792f8803bba8ca0d5ecd), in\nthe appendices of this book or in the code samples bundled with this book\n(interactive-tree.html). A working online example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/43a860bc0024792f8803bba8ca0d5ecd).\n\nFor a brief visual description of the action. The diagram will initially\ndisplay a partially collapsed tree…\n\n![Partially collapsed tree diagram\\)](images/tree-10.png) Partially collapsed\ntree diagram)\n\nThen when clicking on the ‘Level 2: A’ node, the tree expands to…\n\n![Tree diagram\\)](images/htree-01.png) Tree diagram)\n\nWe could also click on the root node (`Top Level’) to fully collapse the tree…\n\n![Fully collapsed tree diagram\\)](images/tree-11.png) Fully collapsed tree\ndiagram)\n\nThen clicking on the nodes opens the diagram back up again.\n\nOne of the important changes is to allow the diagram to follow the d3.js model\nof enter - update - exit for the nodes with a suitable transition in between.\n\nNodes are coloured (“steelblue”) if they have been collapsed and at the end of\nthe script we have a function that makes use of the `d._children` reference we\nhave been using in most of our examples.\n\n    \n    \n    function click(d) {\n      if (d.children) {\n    \td._children = d.children;\n    \td.children = null;\n      } else {\n    \td.children = d._children;\n    \td._children = null;\n      }\n      update(d);\n    }\n    \n\nThis allows the action of clicking on the nodes to update the data associated\nwith the node and as a consequence change it’s properties in the script based\non if statements (Such as `\"fill\", function(d) { return d._children ?\n\"lightsteelblue\" : \"#fff\"; }` which will fill the node with “lightsteelblue”\nif `d._children` exists, otherwise make it white.)\n\nThe examples we have looked at in the previous sections in this chapter are\nall applicable to this interactive version, so this should provide you with\nthe capability to generate some interesting visualizations.\n\n\n## Sankey Diagrams\n\n### What is a Sankey Diagram?\n\nA Sankey diagram is a type of flow diagram where the ‘flow’ is represented by\narrows of varying thickness depending on the quantity of flow.\n\nThey are often used to visualize energy, material or cost transfers and are\nespecially useful in demonstrating proportionality to a flow where different\nparts of the diagram represent different quantities in a system.\n\nProbably the most famous example of a Sankey diagram is Charles Minard’s Map\nof Napoleon’s Russian Campaign of 1812.\n\n![Napoleon's Russian March](images/sankey01.png) Napoleon’s Russian March\n\nFrom Wikipedia;\n\n“ _Étienne-Jules Marey first called notice to this dramatic depiction of the\nfate of Napoleon’s army in the Russian campaign, saying it defies the pen of\nthe historian in its brutal eloquence. Edward Tufte says it “may well be the\nbest statistical graphic ever drawn” and uses it as a prime example in The\nVisual Display of Quantitative Information_.”\n\nWikipedia has a great explanation of the [diagram\ntype](http://en.wikipedia.org/wiki/Sankey_diagram) and there is a wealth of\ninformation dedicated to it on the inter-web. I heartily recommend\nhttp://www.sankey-diagrams.com/ for all things Sankey!\n\nSo it would come as little surprise that Mike Bostock has developed a plugin\nfor Sankey diagrams (http://bost.ocks.org/mike/sankey/) so that we can all\nenjoy Sankey goodness with lashings of D3.\n\n### Which Sankey plugin should we use?\n\nHmmmm…… Good question.\n\nAs at the time of writing there were 4 different sankey plugins listed on the\n[d3 wiki](https://github.com/d3/d3/wiki/Plugins) (including the vertical one).\nThe examples we will walk through have used the plugins from [Stefaan\nLippens](https://github.com/soxofaan/d3-plugin-captain-sankey) and [Jason\nDavies](https://github.com/d3/d3-plugins/tree/master/sankey) without problem.\nI have used the Jason Davies version for no other reason than it appears to be\nthe originator from which others have been derived.\n\n### How d3.js Sankey Diagrams want their data formatted\n\nIf we think of Sankey diagrams consisting of ‘nodes’ and ‘links’…\n\n![A simple Sankey diagram](images/sankey02.png) A simple Sankey diagram\n\n… the data that generates them must be formatted as nodes and links as well.\n\nFor instance a JSON file with appropriate data to build the diagram above\ncould look like the following;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"node\":0,\"name\":\"node0\"},\n    {\"node\":1,\"name\":\"node1\"},\n    {\"node\":2,\"name\":\"node2\"},\n    {\"node\":3,\"name\":\"node3\"},\n    {\"node\":4,\"name\":\"node4\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nIn the file above we have 6 nodes (0-5) sequentially numbered and with names\nappropriate to their position in the list.\n\nThe sequential numbering is only for the purpose of highlighting the structure\nof the data, since when we get D3 running, it will automatically index each of\nthe nodes according to its position. In other words, we could have omitted the\n“node”:n parts since D3 will know where each node is anyway. The big deal is\nthat _WE_ need to know what each node is as well. Especially if we’re going to\nbe building the data by hand (doing it dynamically would be cool, but let’s\nnot get ahead of ourselves just yet).\n\nThe ‘links’ part of the data can be broken down into individual source to\ntarget ‘links’ that have an associated value (could be a quantity or strength,\nbut at least a numeric value).\n\nThe ‘source’ and ‘target’ numbers are references to the list of nodes. So,\n“source”:1, “target”:2 means that this link is whatever node appears at\nposition 1 going to whatever node appears at position 2. The important point\nto make here is that D3 will not be interested in the numerical value of the\nnode, just its position in the list (starting at zero).\n\n### Description of the code\n\nThe code for the Sankey diagram is significantly different to that for a [line\ngraph](chap04.xhtml#simplegraph) although it shares the same core language and\nprogramming methodology.\n\nThe code we’ll go through is an adaptation of the [version first demonstrated\nby Mike Bostock](http://bost.ocks.org/mike/sankey/) so it’s got a pretty good\npedigree. We will begin with a version that uses data that is formatted so\nthat it can be used directly with no manipulation, then in subsequent sections\nwe will work on different techniques for getting data from different formats\n(and with different structures) to work.\n\nI found that getting data in the correct format was the biggest hurdle for\ngetting a Sankey diagram to work. We will start off assuming that the data is\nperfectly formatted, then where only the link data is available, then where\nthere is just names to work with (no numeric node values) and lastly, one that\ncan be used for people with changeable data from a MySQL database.\n\nWe won’t try to go over every inch of the code as we did with the [simple\ngraph example](chap04.xhtml#simplegraph) (I’ll skip things like the HTML\nheader) and will focus on the style sheet (CSS) portion and the JavaScript.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/013054e8d7807dff76247b81b0e29030) or\nin the code samples bundled with this book (sankey-formatted-json.html,\nsankey.js and sankey.json). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/013054e8d7807dff76247b81b0e29030).\n\nOn to the code…\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>SANKEY Experiment</title>\n    <style>\n    \n    .node rect {\n      cursor: move;\n      fill-opacity: .9;\n      shape-rendering: crispEdges;\n    }\n    \n    .node text {\n      pointer-events: none;\n      text-shadow: 0 1px 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #000;\n      stroke-opacity: .2;\n    }\n    \n    .link:hover {\n      stroke-opacity: .5;\n    }\n    \n    </style>\n    <body>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script src=\"sankey.js\"></script>\n    <script>\n    \t\n    var units = \"Widgets\";\n    \n    // set the dimensions and margins of the graph\n    var margin = {top: 10, right: 10, bottom: 10, left: 10},\n        width = 700 - margin.left - margin.right,\n        height = 300 - margin.top - margin.bottom;\n    \n    // format variables\n    var formatNumber = d3.format(\",.0f\"),    // zero decimal places\n        format = function(d) { return formatNumber(d) + \" \" + units; },\n        color = d3.scaleOrdinal(d3.schemeCategory20);\n    \n    // append the svg object to the body of the page\n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Set the sankey diagram properties\n    var sankey = d3.sankey()\n        .nodeWidth(36)\n        .nodePadding(40)\n        .size([width, height]);\n    \n    var path = sankey.link();\n    \n    // load the data\n    d3.json(\"sankey.json\", function(error, graph) {\n    \n      sankey\n          .nodes(graph.nodes)\n          .links(graph.links)\n          .layout(32);\n    \n    // add in the links\n      var link = svg.append(\"g\").selectAll(\".link\")\n          .data(graph.links)\n        .enter().append(\"path\")\n          .attr(\"class\", \"link\")\n          .attr(\"d\", path)\n          .style(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n          .sort(function(a, b) { return b.dy - a.dy; });\n    \n    // add the link titles\n      link.append(\"title\")\n            .text(function(d) {\n        \t\treturn d.source.name + \" → \" + \n                    d.target.name + \"\\n\" + format(d.value); });\n    \n    // add in the nodes\n      var node = svg.append(\"g\").selectAll(\".node\")\n          .data(graph.nodes)\n        .enter().append(\"g\")\n          .attr(\"class\", \"node\")\n          .attr(\"transform\", function(d) { \n    \t\t  return \"translate(\" + d.x + \",\" + d.y + \")\"; })\n          .call(d3.drag()\n            .subject(function(d) {\n              return d;\n            })\n            .on(\"start\", function() {\n              this.parentNode.appendChild(this);\n            })\n            .on(\"drag\", dragmove));\n    \n    // add the rectangles for the nodes\n      node.append(\"rect\")\n          .attr(\"height\", function(d) { return d.dy; })\n          .attr(\"width\", sankey.nodeWidth())\n          .style(\"fill\", function(d) { \n    \t\t  return d.color = color(d.name.replace(/ .*/, \"\")); })\n          .style(\"stroke\", function(d) { \n    \t\t  return d3.rgb(d.color).darker(2); })\n        .append(\"title\")\n          .text(function(d) { \n    \t\t  return d.name + \"\\n\" + format(d.value); });\n    \n    // add in the title for the nodes\n      node.append(\"text\")\n          .attr(\"x\", -6)\n          .attr(\"y\", function(d) { return d.dy / 2; })\n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"end\")\n          .attr(\"transform\", null)\n          .text(function(d) { return d.name; })\n        .filter(function(d) { return d.x < width / 2; })\n          .attr(\"x\", 6 + sankey.nodeWidth())\n          .attr(\"text-anchor\", \"start\");\n    \n    // the function for moving the nodes\n      function dragmove(d) {\n        d3.select(this)\n          .attr(\"transform\", \n                \"translate(\" \n                   + d.x + \",\" \n                   + (d.y = Math.max(\n                      0, Math.min(height - d.dy, d3.event.y))\n                     ) + \")\");\n        sankey.relayout();\n        link.attr(\"d\", path);\n      }\n    });\n    \n    </script>\n    \n    </body>\n    \n\nSo, going straight to the style sheet bounded by the `<style>` tags;\n\n    \n    \n    .node rect {\n      cursor: move;\n      fill-opacity: .9;\n      shape-rendering: crispEdges;\n    }\n    \n    .node text {\n      pointer-events: none;\n      text-shadow: 0 1px 0 #fff;\n    }\n    \n    .link {\n      fill: none;\n      stroke: #000;\n      stroke-opacity: .2;\n    }\n    \n    .link:hover {\n      stroke-opacity: .5;\n    }\n    \n\nThe CSS in this example is mainly concerned with formatting of the mouse\ncursor as it moves around the diagram.\n\nThe first part…\n\n    \n    \n    .node rect {\n      cursor: move;\n      fill-opacity: .9;\n      shape-rendering: crispEdges;\n    }\n    \n\n… provides the properties for the node rectangles. It changes the icon for the\ncursor when it moves over the rectangle to one that looks like it will move\nthe rectangle (there is a range of different icons that can be defined here\nhttp://www.echoecho.com/csscursors.htm), sets the fill colour to mostly opaque\nand keeps the edges sharp.\n\nThe next block…\n\n    \n    \n    .node text {\n      pointer-events: none;\n      text-shadow: 0 1px 0 #fff;\n    }\n    \n\n… sets the properties for the text at each node. The mouse is told to\nessentially ignore the text in favour of anything that’s under it (in the case\nof moving or highlighting something else) and a slight shadow is applied for\nreadability).\n\nThe following block…\n\n    \n    \n    .link {\n      fill: none;\n      stroke: #000;\n      stroke-opacity: .2;\n    }\n    \n\n… makes sure that the link has no fill (it actually appears to be a bendy\nrectangle with very thick edges that make the element appear to be a solid\nblock), colours the edges black (`#000`) and makes the edges almost\ntransparent.\n\nThe last block….\n\n    \n    \n    .link:hover {\n      stroke-opacity: .5;\n    }\n    \n\n… simply changes the opacity of the link when the mouse goes over it so that\nit’s more visible. If so desired, we could change the colour of the\nhighlighted link by adding in a line to this block changing the colour like\nthis `stroke: red;`.\n\nJust before we get into the JavaScript, we do something a little different for\nd3.js. We tells it to use a plug-in with the following line;\n\n    \n    \n    <script src=\"sankey.js\"></script>\n    \n\nThe concept of a plug-in is that it is a separate piece of code that will\nallow additional functionality to a core block (which in this case is d3.js).\nThere are a range of [plug-ins\navailable](https://github.com/d3/d3/wiki/Plugins) and we will need to source\nthe `sankey.js` file from [the\nrepository](https://github.com/d3/d3-plugins/tree/master/sankey) and place\nthat somewhere where our HTML code can access it. In this case I have put it\nin the same directory as the main sankey web page.\n\nThe start of our JavaScript begins by defining a range of variables that we’ll\nbe using.\n\nOur units are set as ‘Widgets’ (`var units = \"Widgets\";`), which is just a\nconvenient generic (nonsense) term to provide the impression that the flow of\nitems in this case is widgets being passed from one person to another.\n\nWe then set our canvas size and margins…\n\n    \n    \n    var margin = {top: 10, right: 10, bottom: 10, left: 10},\n        width = 700 - margin.left – margin.right,\n        height = 300 - margin.top – margin.bottom;\n    \n\n… before setting some formatting.\n\n    \n    \n    var formatNumber = d3.format(\",.0f\"),    // zero decimal places\n        format = function(d) { return formatNumber(d) + \" \" + units; },\n        color = d3.scaleOrdinal(d3.schemeCategory20);\n    \n\nThe `formatNumber` function acts on a number to set it to zero decimal places\nin this case. In the original Mike Bostock example it was to three places, but\nfor ‘widgets’ I’m presuming we don’t divide :-).\n\n`format` is a function that returns a given number formatted with\n`formatNumber` as well as a space and our units of choice (‘Widgets’). This is\nused to display the values for the links and nodes later in the script.\n\nThe `color = d3.scaleOrdinal(d3.schemeCategory20);` line is really interesting\nand provides access to a colour scale that is [pre-defined for your\nconvenience](https://github.com/d3/d3-scale/blob/master/README.md#schemeCategory20)!\nLater in the code we will see it in action.\n\nOur next block of code positions our svg element onto our page in relation to\nthe size and margins we have already defined;\n\n    \n    \n    var svg = d3.select(\"body\").append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n        .attr(\"transform\", \n              \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n\nThen we set the variables for our sankey diagram;\n\n    \n    \n    var sankey = d3.sankey()\n        .nodeWidth(36)\n        .nodePadding(40)\n        .size([width, height]);\n    \n\nWithout trying to state the obvious, this sets the width of the nodes\n(`.nodeWidth(36)`), the padding between the nodes (`.nodePadding(40)`) and the\nsize of the diagram(`.size([width, height]);`).\n\nThe following line defines the `path` variable as a pointer to the sankey\nfunction that makes the links between the nodes do their clever thing of\nbending into the right places;\n\n    \n    \n    var path = sankey.link();\n    \n\nI make the presumption that this is a defined function within `sankey.js`.\n\nThen we load the data for our sankey diagram with the following line;\n\n    \n    \n    d3.json(\"sankey.json\", function(error, graph) {\n    \n\nAs we have seen in previous usage of the `d3.json`, `d3.csv` and `d3.tsv`\nfunctions, this is a wrapper that acts on all the code within it bringing the\ndata in the form of `graph` to the remaining code.\n\nI think it’s a good time to take a slightly closer look at the data that we’ll\nbe using;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"node\":0,\"name\":\"node0\"},\n    {\"node\":1,\"name\":\"node1\"},\n    {\"node\":2,\"name\":\"node2\"},\n    {\"node\":3,\"name\":\"node3\"},\n    {\"node\":4,\"name\":\"node4\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nI want to look at the data now, because it highlights how it is accessed\nthroughout this portion of the code. It is split into two different blocks,\n‘nodes’ and ‘links’. The subset of variables available under ‘nodes’ is ‘node’\nand ‘name’. Likewise under ‘links’ we have ‘source’, ‘target’ and ‘value’.\nThis means that when we want to act on a subset of our data we define which\npiece by defining the hierarchy that leads to it. For instance, if we want to\ndefine an action for all the links, we would use graph.links (they’re kind of\nchained together).\n\nLet me take this opportunity to apologise to all those programmers who\n_actually_ know exactly what is going on here. It’s a mystery to me, but this\nis how I like to tell myself it works to help me get by :-).\n\nNow that we have our data loaded, we can assign the data to the sankey\nfunction so that it knows how to deal with it behind the scenes;\n\n    \n    \n      sankey\n          .nodes(graph.nodes)\n          .links(graph.links)\n          .layout(32);\n    \n\nIn keeping with our previous description of what’s going on with the data, we\nhave told the sankey function that the nodes it will be dealing with are in\n`graph.nodes` of our data structure.\n\nI’m not sure what the `.layout(32);` portion of the code does, but I’d be\ninterested to hear from any more knowledgeable readers. I’ve tried changing\nthe values to no apparent effect and googling has drawn a blank. Internally to\nthe `sankey.js` file it seems to indicate ‘iterations’ while it establishes\ncomputeNodeLinks, computeNodeValues, computeNodeBreadths, computeNodeDepths\n(iterations) and computeLinkDepths.\n\nThen we add our links to the diagram with the following block of code;\n\n    \n    \n      var link = svg.append(\"g\").selectAll(\".link\")\n          .data(graph.links)\n        .enter().append(\"path\")\n          .attr(\"class\", \"link\")\n          .attr(\"d\", path)\n          .style(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n          .sort(function(a, b) { return b.dy - a.dy; });\n    \n\nThis is an analogue of the block of code we examined way back in the section\nthat we covered in explaining the code of our first [simple\ngraph](chap04.xhtml#simplegraph).\n\nWe append svg elements for our links based on the data in `graph.links`, then\nadd in the paths (using the appropriate CSS). We set the stroke width to the\nwidth of the value associated with each link or ‘1’. Whichever is the larger\n(by virtue of the Math.max function). As an interesting sideline, if we force\nthis value to ‘10’ thusly…\n\n    \n    \n          .style(\"stroke-width\", 10)\n    \n\n… the graph looks quite interesting.\n\n![stroke-width 10 for Sankey links](images/sankey03.png) stroke-width 10 for\nSankey links\n\nThe sort function (`.sort(function(a, b) { return b.dy - a.dy; });`) makes\nsure the link for which the target has the highest y coordinate departs first\nout of the rectangle. Meaning if you have flows of 30,40,50 out of node 1,\nheading towards nodes 2, 3 and 4, with node 3 located above node 2 and that\nabove node 4, the outflow order from node 1 will be 40,50,30. This makes sure\nthere are a minimum of flow crosses. It’s slightly confusing and for a long\ntime it was a mystery (big thanks and kudos to ‘napicool’ who was able to\n[explain it on d3noob.org](http://www.d3noob.org/2013/02/formatting-data-for-\nsankey-diagrams-in.html).\n\nThe next block adds the titles to the links;\n\n    \n    \n      link.append(\"title\")\n            .text(function(d) {\n        \t\treturn d.source.name + \" → \" + \n                    d.target.name + \"\\n\" + format(d.value); });\n    \n\nThis code appends a text element to each link when moused over that contains\nthe source and target name (with a neat little arrow in between and the value)\nwhich, when applied with the `format` function, adds the units.\n\nThe next block appends the node objects (but not the rectangles or text) and\ncontains the instructions to allow them to be arranged with the mouse.\n\n    \n    \n      var node = svg.append(\"g\").selectAll(\".node\")\n          .data(graph.nodes)\n        .enter().append(\"g\")\n          .attr(\"class\", \"node\")\n          .attr(\"transform\", function(d) { \n    \t\t  return \"translate(\" + d.x + \",\" + d.y + \")\"; })\n          .call(d3.drag()\n            .subject(function(d) {\n              return d;\n            })\n            .on(\"start\", function() {\n              this.parentNode.appendChild(this);\n            })\n            .on(\"drag\", dragmove));\n    \n\nWhile it starts off in familiar territory with appending the node objects\nusing the `graph.nodes` data and putting them in the appropriate place with\nthe `transform` attribute, I can only assume that there is some trickery going\non behind the scenes to make sure the mouse can do what it needs to do with\nthe `d3.behaviour,drag` function. There is some excellent documentation on the\n[wiki](https://github.com/d3/d3-drag), but I can only presume that it knows\nwhat it’s doing :-). The `dragmove` function is laid out at the end of the\ncode, and we will explain how that operates later. Kudos for [this code\nportion](http://bl.ocks.org/syntagmatic/77c7f7e8802e8824eed473dd065c450b)\nshould go to @syntagmatic.\n\nI really enjoyed the next block;\n\n    \n    \n     node.append(\"rect\")\n          .attr(\"height\", function(d) { return d.dy; })\n          .attr(\"width\", sankey.nodeWidth())\n          .style(\"fill\", function(d) { \n    \t\t  return d.color = color(d.name.replace(/ .*/, \"\")); })\n          .style(\"stroke\", function(d) { \n    \t\t  return d3.rgb(d.color).darker(2); })\n        .append(\"title\")\n          .text(function(d) { \n    \t\t  return d.name + \"\\n\" + format(d.value); });\n    \n\nIt starts off with a fairly standard appending of a rectangle with a height\ngenerated by its value `{ return d.dy; }` and a width dictated by the\n`sankey.js` file to fit the area (`.attr(\"width\", sankey.nodeWidth())`).\n\nThen it gets interesting.\n\nThe colours are assigned in accordance with our earlier colour declaration and\nthe individual colours are added to the nodes by finding the first part of the\nname for each node and assigning it a colour from the palate (the script looks\nfor the first space in the name using a regular expression). For instance:\n‘Widget X’, ‘Widget Y’ and ‘Widget’ will all be coloured the same even if the\n‘Widget X’ and ‘Widget Y’ are inputs on the left and ‘Widget’ is a node in the\nmiddle.\n\nThe stroke around the outside of the rectangle is then drawn in the same\nshade, but `darker`. Then we return to the basics where we add the title of\nthe node in a tool tip type effect along with the value for the node.\n\nFrom here we add the titles for the nodes;\n\n    \n    \n      node.append(\"text\")\n          .attr(\"x\", -6)\n          .attr(\"y\", function(d) { return d.dy / 2; })\n          .attr(\"dy\", \".35em\")\n          .attr(\"text-anchor\", \"end\")\n          .attr(\"transform\", null)\n          .text(function(d) { return d.name; })\n        .filter(function(d) { return d.x < width / 2; })\n          .attr(\"x\", 6 + sankey.nodeWidth())\n          .attr(\"text-anchor\", \"start\");\n    \n\nAgain, this looks pretty familiar. We position the text titles carefully to\nthe left of the nodes. All except for those affected by the filter function\n(`return d.x < width / 2;`). Where if the position of the node on the x axis\nis less than half the width, the title is placed on the right of the node and\nanchored at the start of the text. Very neat.\n\nThe last block is also pretty neat, and contains a little surprise for those\nwho are so inclined.\n\n    \n    \n      function dragmove(d) {\n        d3.select(this)\n          .attr(\"transform\", \n                \"translate(\" \n                   + d.x + \",\" \n                   + (d.y = Math.max(\n                      0, Math.min(height - d.dy, d3.event.y))\n                     ) + \")\");\n        sankey.relayout();\n        link.attr(\"d\", path);\n    \n\nThis declares the function that controls the movement of the nodes with the\nmouse. It selects the item that it’s operating over (`d3.select(this)`) and\nthen allows translation in the y axis while maintaining the link connection\n(`sankey.relayout(); link.attr(\"d\", path);`).\n\nBut that’s not the cool part. A quick look at the code should reveal that if\nyou can move a node in the y axis, there should be no reason why you can’t\nmove it in the x axis as well!\n\nSure enough, if you replace the code above with this…\n\n    \n    \n      function dragmove(d) {\n        d3.select(this).attr(\"transform\", \n            \"translate(\" + (\n                d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))\n            )\n            + \",\" + (\n                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))\n            ) + \")\");\n        sankey.relayout();\n        link.attr(\"d\", path);\n    \n\n… you can move your nodes anywhere on the canvas.\n\n![Move your nodes in x *and* y!](images/sankey04.png) Move your nodes in x\n_and_ y!\n\nI know it doesn’t seem to add anything to the diagram (in fact, it could be\nargued that there is a certain aspect of detraction) however, it doesn’t mean\nthat one day the idea doesn’t come in handy :-). You can see a live version on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3337957c360d55c245f6057ab0866c05).\n\n### Formatting data for Sankey diagrams\n\n#### From a JSON file with numeric link values\n\nAs explained in the [previous section](chap10.xhtml#sankeydata), data to form\na Sankey diagram needs to be a combination of nodes and links.\n\n    \n    \n    {\n    \"nodes\":[\n    {\"node\":0,\"name\":\"node0\"},\n    {\"node\":1,\"name\":\"node1\"},\n    {\"node\":2,\"name\":\"node2\"},\n    {\"node\":3,\"name\":\"node3\"},\n    {\"node\":4,\"name\":\"node4\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nAs we also noted earlier, the `\"node\"` entries in the `\"nodes\"` section of the\nJSON file are superfluous and are really only there for our benefit since D3\nwill automatically index the nodes starting at zero. As a test to check this\nout we can change our data to the following;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"name\":\"Barry\"},\n    {\"name\":\"Frodo\"},\n    {\"name\":\"Elvis\"},\n    {\"name\":\"Sarah\"},\n    {\"name\":\"Alice\"}\n    ],\n    \"links\":[\n    {\"source\":0,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":2,\"value\":2},\n    {\"source\":1,\"target\":3,\"value\":2},\n    {\"source\":0,\"target\":4,\"value\":2},\n    {\"source\":2,\"target\":3,\"value\":2},\n    {\"source\":2,\"target\":4,\"value\":2},\n    {\"source\":3,\"target\":4,\"value\":4}\n    ]}\n    \n\nThis will produce the following graph;\n\n![Sankey graph with names](images/sankey05.png) Sankey graph with names\n\nAs you can see, essentially the same, but with easier to understand names.\n\nAs you can imagine, while the end result is great, the creation of the JSON\nfile manually would be painful at best. Doing something similar but with a\ngreater number of nodes / links would be a nightmare.\n\nLet’s see if we can make the process a bit easier and more flexible.\n\n#### From a JSON file with links as names\n\nIt would make thing much easier, if you are building the data from hand, to\nhave nodes with names, and the ‘source’ and ‘target’ links to have those same\nname values as identifiers.\n\nIn other words a list of unique names for the nodes (and perhaps some details)\nand a list of the links between those nodes using the names for the nodes.\n\nSo, something like this;\n\n    \n    \n    {\n    \"nodes\":[\n    {\"name\":\"Barry\"},\n    {\"name\":\"Frodo\"},\n    {\"name\":\"Elvis\"},\n    {\"name\":\"Sarah\"},\n    {\"name\":\"Alice\"}\n    ],\n    \"links\":[\n    {\"source\":\"Barry\",\"target\":\"Elvis\",\"value\":2},\n    {\"source\":\"Frodo\",\"target\":\"Elvis\",\"value\":2},\n    {\"source\":\"Frodo\",\"target\":\"Sarah\",\"value\":2},\n    {\"source\":\"Barry\",\"target\":\"Alice\",\"value\":2},\n    {\"source\":\"Elvis\",\"target\":\"Sarah\",\"value\":2},\n    {\"source\":\"Elvis\",\"target\":\"Alice\",\"value\":2},\n    {\"source\":\"Sarah\",\"target\":\"Alice\",\"value\":4}\n    ]}\n    \n\nOnce again, D3 to the rescue!\n\nThe little piece of code that can do this for us is here;\n\n    \n    \n        var nodeMap = {};\n        graph.nodes.forEach(function(x) { nodeMap[x.name] = x; });\n        graph.links = graph.links.map(function(x) {\n          return {\n            source: nodeMap[x.source],\n            target: nodeMap[x.target],\n            value: x.value\n          };\n        });\n    \n\nThis elegant solution comes from [Stack\nOverflow](http://stackoverflow.com/questions/14629853/json-representation-\nfor-d3-networks) and was provided by Chris Pettitt (nice job).\n\nSo if we sneak this piece of code into here…\n\n    \n    \n    d3.json(\"sankey-names.json\", function(error, graph) {\n    \n                //  <= Put the code here.\n    \n      sankey\n          .nodes(graph.nodes)\n          .links(graph.links)\n          .layout(32);\n    \n\n… and this time we use our JSON file with just names (sankey-names.json) and\nour new html file (sankey-formatted-names.html) we find our Sankey diagram\nworking perfectly!\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/d7800f34062b116f9ec0588f2e85e549) or\nin the code samples bundled with this book (sankey-formatted-names.html,\nsankey.js and sankey-names.json). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/d7800f34062b116f9ec0588f2e85e549).\n\n![Sankey graph with names again](images/sankey06.png) Sankey graph with names\nagain\n\nLooking at our new piece of code…\n\n    \n    \n        var nodeMap = {};\n        graph.nodes.forEach(function(x) { nodeMap[x.name] = x; });\n    \n\n… the first thing it does is create an object called `nodeMap` (The difference\nbetween an array and an object in JavaScript is one that is still a little\nblurry to me and judging from online comments, I am not alone).\n\nThen for each of the `graph.node` instances (where `x` is a range of numbers\nfrom 0 to the last node), we assign each node name to a number.\n\nThen in the next piece of code…\n\n    \n    \n        graph.links = graph.links.map(function(x) {\n          return {\n            source: nodeMap[x.source],\n            target: nodeMap[x.target],\n            value: x.value\n          };\n    \n\n… we go through all the links we have and for each link, we map the\nappropriate number to the correct name.\n\nVery clever.\n\n#### From a CSV with ‘source’, ‘target’ and ‘value’ info only.\n\nIn the first iteration of this section of the book I had no solution to\ncreating a Sankey diagram using a csv file as the source of the data.\n\nBut cometh the hour, cometh the man. Enter @timelyportfolio who, while\nclaiming no expertise in D3 or JavaScript was able to demonstrate a\n[solution](http://bl.ocks.org/timelyportfolio/5052095) to exactly the problem\nI was facing! Well done Sir! I salute you and name the technique the\ntimelyportfolio csv method!\n\nObservant readers will notice that there is a tiny difference between the\nsolution that timelyportfolio demonstrates (using d3.js v3) and the example\nbelow (using v4). Using v4 I found that I had to use `.object` when nesting\nthe data instead of `.map`.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/06e72deea99e7b4859841f305f63ba85) or\nin the code samples bundled with this book (sankey-formatted-csv.html,\nsankey.js and sankey.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/06e72deea99e7b4859841f305f63ba85).\n\nSo here’s the cleverness that @timelyportfolio demonstrated;\n\nUsing a csv file (in this case called `sankey.csv`) that looks like this;\n\n    \n    \n    source,target,value\n    Barry,Elvis,2\n    Frodo,Elvis,2\n    Frodo,Sarah,2\n    Barry,Alice,2\n    Elvis,Sarah,2\n    Elvis,Alice,2\n    Sarah,Alice,4\n    \n\nWe take this single line from our original Sankey diagram code;\n\n    \n    \n    d3.json(\"sankey-formatted.json\", function(error, graph) {\n    \n\nAnd replace it with the following block;\n\n    \n    \n    d3.csv(\"sankey.csv\", function(error, data) {\n     \n      //set up graph in same style as original example but empty\n      graph = {\"nodes\" : [], \"links\" : []};\n    \n      data.forEach(function (d) {\n        graph.nodes.push({ \"name\": d.source });\n        graph.nodes.push({ \"name\": d.target });\n        graph.links.push({ \"source\": d.source,\n                           \"target\": d.target,\n                           \"value\": +d.value });\n       });\n    \n      // return only the distinct / unique nodes\n      graph.nodes = d3.keys(d3.nest()\n        .key(function (d) { return d.name; })\n        .object(graph.nodes));\n    \n      // loop through each link replacing the text with its index from node\n      graph.links.forEach(function (d, i) {\n        graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);\n        graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);\n      });\n    \n      // now loop through each nodes to make nodes an array of objects\n      // rather than an array of strings\n      graph.nodes.forEach(function (d, i) {\n        graph.nodes[i] = { \"name\": d };\n      });\n    \n\nThe comments in the code (and they are fuller in @timelyportfolio’s [original\ngist solution](http://bl.ocks.org/timelyportfolio/5052095)) explain the\noperation;\n\n    \n    \n    d3.csv(\"sankey.csv\", function(error, data) {\n    \n\n… Loads the csv file from the data directory.\n\n    \n    \n      graph = {\"nodes\" : [], \"links\" : []};\n    \n\n… Declares `graph` to consist of two empty arrays called `nodes` and `links`.\n\n    \n    \n          data.forEach(function (d) {\n          graph.nodes.push({ \"name\": d.source });\n          graph.nodes.push({ \"name\": d.target });\n          graph.links.push({ \"source\": d.source,\n                             \"target\": d.target,\n                             \"value\": +d.value });\n         });\n    \n\n… Takes the `data` loaded with the csv file and for each row loads variables\nfor the `source` and `target` into the `nodes` array. Then for each row it\nloads variables for the `source` `target` and `value` into the `links` array.\n\n    \n    \n         graph.nodes = d3.keys(d3.nest()\n           .key(function (d) { return d.name; })\n           .object(graph.nodes));\n    \n\n… Is a routine that Mike Bostock described on [Google\nGroups](https://groups.google.com/forum/#!msg/d3-js/pl297cFtIQk/Eso4q_eBu1IJ)\nthat (as I understand it) nests each node name as a key so that it returns\nwith only unique nodes.\n\n    \n    \n         graph.links.forEach(function (d, i) {\n           graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);\n           graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);\n         });\n    \n\n… Goes through each `link` entry and, for each `source` and `target`, it finds\nthe unique index number of that name in the nodes array and assigns the link\nsource and target an appropriate number.\n\nAnd finally…\n\n    \n    \n         graph.nodes.forEach(function (d, i) {\n           graph.nodes[i] = { \"name\": d };\n         });\n    \n\n… Goes through each node and (in the words of @timelyportfolio) “ _make nodes\nan array of objects rather than an array of strings_ ” (I don’t really know\nwhat that means :-(. I just know it works :-).)\n\nThere you have it. A Sankey diagram from a csv file. Well played\n@timelyportfolio!\n\n\n## Assorted Tips and Tricks\n\n### Change a line chart into a scatter plot\n\nConfession time.\n\nIn the original book I didn’t actually intend to add in a section with a\nscatter plot in it for its own sake because I thought it would be;\n\n  1. tricky\n  2. not useful\n  3. all of the above\n\nI was wrong on all counts.\n\nI did want to have a scatter plot, because I wanted to display tool tips, but\nthis is too neat to ignore. It was literally a 5 minute job, 3 minutes of\nwhich was taken up by going to the [d3 gallery on the\nwiki](https://github.com/mbostock/d3/wiki/Gallery) and ogling at the cool\nstuff there before snapping out of it and going to the [scatter plot\nexample](http://bl.ocks.org/3887118) (that’s the v3 example by the way).\n\nAll we need to do is take the [simple graph](chap04.xhtml#simplegraph) example\nfile and slot the following block in between the ‘Add the valueline path’ and\nthe ‘add the x axis’ blocks.\n\n    \n    \n      // add the dots\n      svg.selectAll(\"dot\")\n         .data(data)\n         .enter().append(\"circle\")\n           .attr(\"r\", 5)\n           .attr(\"cx\", function(d) { return x(d.date); })\n           .attr(\"cy\", function(d) { return y(d.close); });\n    \n\nAnd we will get…\n\n![A scatter plot! \\(with a line\\)](images/scatter01.png) A scatter plot! (with\na line)\n\nThe full code for this graph can also be found on\n[github](https://gist.github.com/d3noob/2505b09d0feb51d0c9873cc486f10f67) or\nin the code samples bundled with this book (simple-scatterplot.html and\ndata.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/2505b09d0feb51d0c9873cc486f10f67).\n\nI deliberately put the dots _after_ the line in the drawing section, because I\nthought they would look better, but we could put the block of code before the\nline drawing block to get the following effect;\n\n![A scatter plot with the line in front of the dots](images/scatter02.png) A\nscatter plot with the line in front of the dots\n\n(just trying to reinforce the concept that ‘order’ matters when drawing\nobjects :-)).\n\nWe could of course just remove the line block all together…\n\n![A scatter plot without the line this time](images/scatter03.png) A scatter\nplot without the line this time\n\nBut in my humble opinion it loses something.\n\nSo what do the individual lines in the scatter plot block of JavaScript do?\n\nThe first line (`svg.selectAll(\"dot\")`) essentially provides a suitable group\nlabel for the svg circle elements that will be added. The next line associates\nthe range of data that we have to the group of elements we are about to add\nin.\n\nThen we add a circle for each data point (`.enter().append(\"circle\")`) with a\nradius of 5 pixels (`.attr(\"r\", 5)`) and appropriate x (`.attr(\"cx\",\nfunction(d) { return x(d.date); })`) and y (`.attr(\"cy\", function(d) { return\ny(d.close); });`) coordinates.\n\nThere is lots more that we could be doing with this piece of code including\nvarying the colour or size or opacity of the circles depending on the data and\nall sorts of really neat things, but for the mean time, there we go. Scatter\nplot!\n\n### Adding tooltips.\n\nTooltips have a marvellous duality. They are on one hand a pretty darned\nuseful thing that aids in giving context and information where required and on\nthe other hand, if done with a bit of care, they can look very stylish :-).\n\nTechnically, they represent a slight deviation from what we have been playing\nwith so far into a mildly more complex arena of ‘transitions’ and ‘events’.\nYou will probably regard this one of two ways. Either accepting that it just\nworks and using it as shown, or you will actually know what’s going on in\nwhich case feel free to deride my efforts as those of a rank amateur :-).\n\nThe original (d3.js v3) source for the implementation was taken from Mike\nBostock’s example on [bl.ocks.org](http://bl.ocks.org/1087001). This was\ncombined with a few other bit’s and pieces (the trickiest being working out\nhow to format the displayed date correctly and inserting a line break in the\ntooltip (which I found on [Google\nGroups](https://groups.google.com/forum/?fromgroups=#!topic/d3-js/GgFTf24ltjc);\n(well done to all those participating in that discussion)). I make the\nassumption that any or all errors that occur in the implementation will be\nmine, whereas, any successes will be down to the original contributors.\n\nJust in case there is some confusion, a tooltip (one word or two?) is a\ndiscrete piece of information that will pop into view when the mouse hovers\nover somewhere specific. Most of us have seen and used them, but I suppose we\nall tend to call them different things such as ‘infotip’, ‘hint’ or ‘hover\nbox’ I don’t know if there’s a right name for them, but here’s an example of\nwhat we’re trying to achieve;\n\n![A tooltip magically appears over a dot](images/tips01.png) A tooltip\nmagically appears over a dot\n\nWe can see the mouse has hovered over one of the scatter plot circles and a\ntip has appeared that provides us with the exact date and value for that\npoint.\n\nWe can also notice that there’s a certain degree of ‘fancy’ here as the\ninformation is bound by a rectangular shape with rounded corners and a slight\nopacity. The other piece of ‘fancy’ which you don’t see in a PDF (or whatever\nformat this distinguished tome will be published in on its 33rd reprint in the\nyear 2034), is that when these tool tips appear and disappear, they do so in\nan elegant fade-in, fade-out way. Pretty!\n\nBefore we get started describing how the code goes together, let’s take a\nquick look at the two technique specifics that I mentioned earlier,\n‘transitions’ and ‘events’.\n\n#### Transitions\n\nFrom the main d3.js web page (d3js.org) transitions are described as gradually\ninterpolating styles and attributes over time. So what I take that to mean is\nthat if you want to change an object, you can do so by simply specifying the\nattribute / style end point that you want it to end up with and the time you\nwant it to take and go!\n\nOf course, it’s not quite that simple, but luckily, smarter people than I have\ndone some fantastic work describing different aspects of transitions so please\nsee the following for a more complete description of the topic;\n\n  * Mike Bostock’s [Transition tutorial](https://bost.ocks.org/mike/transition/)\n  * Christophe Viau’s [‘Try D3 Now!’ tutorial](http://christopheviau.com/d3_tutorial/)\n\nHopefully observing the mouseover and mouseout transitions in the tooltips\nexample will whet your appetite for more!\n\n#### Events\n\nThe other technique is related to mouse ‘events’. This describes the browser\nwatching for when ‘something’ happens with the mouse on the screen and when it\ndoes, it takes a specified action. A (probably non-comprehensive) list of the\ntypes of events are the following;\n\n  * mousedown: Triggered by an element when a mouse button is pressed down over it\n  * mouseup: Triggered by an element when a mouse button is released over it\n  * mouseover: Triggered by an element when the mouse comes over it\n  * mouseout: Triggered by an element when the mouse goes out of it\n  * mousemove: Triggered by an element on every mouse move over it.\n  * click: Triggered by a mouse click: mousedown and then mouseup over an element\n  * contextmenu: Triggered by a right-button mouse click over an element.\n  * dblclick: Triggered by two clicks within a short time over an element\n\nHow many of these are valid to use within d3 I’m not sure, but I’m willing to\nbet that there are probably more than those here as well. Please go to\n<http://javascript.info/tutorial/mouse-events> for a far better description of\nthe topic if required.\n\n#### Get tipping\n\nSo, bolstered with a couple of new concepts to consider, let’s see how they\nare enacted in practice.\n\nThe full code for this graph can also be found on\n[github](https://gist.github.com/d3noob/257c360b3650b9f0a52dd8257d7a2d73) or\nin the code samples bundled with the book (simple-tooltips.html and data.csv).\nA live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/257c360b3650b9f0a52dd8257d7a2d73).\n\nIf we start with our simple-scatter plot graph there are 4 areas in it that we\nwill want to modify (it may be easier to check the simple-tooltips.html file\nin the code samples bundled with this book).\n\nThe first area is the CSS. The following code should be added just before the\n`</style>` tag;\n\n    \n    \n    div.tooltip {\n      position: absolute;\n      text-align: center;\n      width: 60px;\n      height: 28px;\n      padding: 2px;\n      font: 12px sans-serif;\n      background: lightsteelblue;\n      border: 0px;\n      border-radius: 8px;\n      pointer-events: none;\n    }\n    \n\nThese styles are defining how our tooltip will appear . Most of them are\nfairly straight forward. The position of the tooltip is done in absolute\nmeasurements, not relative. The text is centre aligned, the height, width and\ncolour of the rectangle is `28px`, `60px` and `lightsteelblue` respectively.\nThe ‘padding’ is an interesting feature that provides a neat way to grow a\nshape by a fixed amount from a specified size.\n\nWe set the border to `0px` so that it doesn’t show up and a neat style\n(attribute?) called `border-radius` provides the nice rounded corners on the\nrectangle.\n\nLastly, but by no means least, the `pointer-events: none` line is in place to\ninstruct the mouse event to go ‘through’ the element and target whatever is\n‘underneath’ that element instead (Read more\n[here](https://developer.mozilla.org/en-US/docs/CSS/pointer-events)). That\nmeans that even if the tooltip partly obscures the circle, the code will still\nact as if the mouse is only over the circle.\n\nThe second addition is a simple one-liner that should (for forms sake) be\nplaced under the `parseTime` variable declaration;\n\n    \n    \n    var formatTime = d3.timeFormat(\"%e %B\");\n    \n\nThis line formats the date when it appears in our tooltip. Without it, the\ntime would default to a disturbingly long combination of temporal details. In\nthe case here we have declared that we want to see the day of the month (`%e`)\nand the full month name(`%B`).\n\nThe third block of code is the function declaration for ‘div’.\n\n    \n    \n    var div = d3.select(\"body\").append(\"div\")\n        .attr(\"class\", \"tooltip\")\n        .style(\"opacity\", 0);\n    \n\nWe can place that just after the `valueline` definition in the JavaScript.\nAgain there’s not too much here that’s surprising. We tell it to attach a\n`div` element to the body element, we set the class to the tooltip class (from\nthe CSS) and we set the opacity to zero. It might sound strange to have the\nopacity set to zero, but remember, that’s the natural state of a tooltip. It\nwill live unseen until it’s moment of revelation arrives and it pops up!\n\nThe final block of code is slightly more complex and could be described as a\nmutant version of the neat little bit of code that we used to do the drawing\nof the dots for the scatter plot. That’s because the tooltips are all about\nthe scatter plot circles. Without a circle to ‘mouseover’, the tooltip never\nappears :-).\n\nSo here’s the code that includes the scatter plot drawing (it’s included since\nit’s pretty much integral);\n\n    \n    \n      // add the dots with tooltips\n      svg.selectAll(\"dot\")\n         .data(data)\n       .enter().append(\"circle\")\n         .attr(\"r\", 5)\n         .attr(\"cx\", function(d) { return x(d.date); })\n         .attr(\"cy\", function(d) { return y(d.close); })\n         .on(\"mouseover\", function(d) {\n           div.transition()\n             .duration(200)\n             .style(\"opacity\", .9);\n           div.html(formatTime(d.date) + \"<br/>\" + d.close)\n             .style(\"left\", (d3.event.pageX) + \"px\")\n             .style(\"top\", (d3.event.pageY - 28) + \"px\");\n           })\n         .on(\"mouseout\", function(d) {\n           div.transition()\n             .duration(500)\n             .style(\"opacity\", 0);\n           });\n    \n\nThe first six lines of the code are a repeat of the scatter plot drawing\nscript. The only changes are that we’ve removed the semicolon from the `cy`\nattribute line since the code now has to carry on.\n\nSo the additions are broken into two areas that correspond to the two events.\n`mouseover` and `mouseout`. When the mouse moves over any of the circles in\nthe scatter plot, the mouseover code is executed on the `div` element. When\nthe mouse is moved off the circle a different set of instructions are\nexecuted.\n\n### There is only one!\n\nIt would be a mistake to think of tooltips in the plural because there aren’t\na whole series of individual tooltips just waiting to appear for their\nspecific circle. There is only one tooltip that will appear when the mouse\nmoves over a circle. And depending on what circle it’s over, the properties of\nthe tooltip will alter slightly (in terms of its position and contents).\n\n#### on.mouseover\n\nThe `.on(\"mouseover\"` line initiates the introduction of the tooltip. Then we\ndeclare the element we will be introducing (‘`div`’) and that we will be\napplying a transition to its introduction (`.transition()`). The next two\nlines describe the transition. It will take 200 milliseconds\n(`.duration(200)`) and will result in changing the element’s opacity to .9\n(`.style(\"opacity\", .9);`). Given that the natural state of our tooltip is an\nopacity of 0, this make sense for something appearing, but it doesn’t go all\nthe way to a solid object and it retains a slight transparency just to make it\nlook less permanent.\n\nThe following three lines format our tooltip. The first one adds an html\nelement that contains our x and y information (the `date` and the `close`\nvalue). Now this is done in a slightly strange way. Other tooltips that I have\nseen have used a ‘`.text`’ element instead of a ‘`.html`’ one, but I have used\n‘`.html`’ in this case because I wanted to include the line break tag `<br/>`\nto separate the date and value. I’m sure there are other ways to do it, but\nthis worked for me. The other interesting part of this line is that this is\nwhere we call our time formatting function that we described earlier. The next\ntwo lines position the tooltip on the screen and to do this they grab the x\nand y coordinates of the mouse when the event takes place (with the\n`d3.event.pageX` and `d3.event.pageY` snippets) and apply a correction in the\ncase of the y coordinate to raise the tooltip up by the same amount as its\nheight (28 pixels).\n\n#### on.mouseout\n\nThe `.on(\"mouseout\"` section is slightly simpler in that it doesn’t have to do\nany fancy text / html / coordinate stuff. All it has to do is to fade out the\n‘div’ element. And that is done by simply reversing the opacity back to 0 and\nsetting the duration for the transition to 500 milliseconds (being slightly\nlonger than the fade-in makes it look slightly cooler IMHO).\n\nRight, there you go. As a description it’s ended up being a bit of a wall of\ntext I’m afraid. But hopefully between the explanation and the example code\nyou will get the idea. Please take the time to fiddle with the settings\ndescribed here to find the ones that work for you and in the process you will\nreinforce some of the principles that help D3 do its thing.\n\n#### Including an HTML link in a tool tip\n\nThere was an interesting question on\n[d3noob.org](http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html)\nabout adding an HTML link to a tooltip. While the person asking the question\nhad the problem pretty much solved already, I thought it might be useful for\nothers.\n\nThe premise is that you want to add a tool tip to your visualization using the\nmethod described here, but you also want to include an HTML link in the\ntooltip that will link somewhere else. This might look a little like the\nfollowing;\n\n![Tool tip with an HTML Link](images/tool-01.png) Tool tip with an HTML Link\n\nIn the image above the date has been turned into a link. In this case the link\ngoes to google.com, but that can obviously be configurable.\n\nThe full code for this example can be found on\n[github](https://https://gist.github.com/d3noob/036d13e5173de69f7758091ba9a2df2b)\nor in the code samples bundled with this book (simple-tooltips-link.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/036d13e5173de69f7758091ba9a2df2b).\n\nThere are a few changes that we would want to make to our original tooltip\ncode to implement this feature.\n\nFirst of all, we’ll add the link to the date element. Adding an HTML link can\nbe as simple as wrapping the ‘thing’ to be used as a link in [`<a>`\ntags](http://www.w3schools.com/tags/tag_a.asp) with an appropriate URL to go\nto.\n\nThe following adaptation of the code that prints the information into our\ntooltip code does just that;\n\n    \n    \n           div .html(\n             '<a href= \"http://google.com\">' + // The first <a> tag\n             formatTime(d.date) +\n             \"</a>\" +                          // closing </a> tag\n             \"<br/>\"  + d.close)     \n             .style(\"left\", (d3.event.pageX) + \"px\")             \n             .style(\"top\", (d3.event.pageY - 28) + \"px\");\n    \n\n`<a href= \"http://google.com\">` places our first `<a>` tag and declares the\nURL and the second tag follows after the date.\n\nThe second change we will want to make is to ensure that the tooltip stays in\nplace long enough for us to actually click on the link. The problem being\nsolved here is that our original code relies on the mouse being over the dot\non the graph to display the tooltip. if the tooltip is displayed and the\ncursor moves to press the link, it will move off the dot on the graph and the\ntooltip vanishes (Darn!).\n\nTo solve the problem we can leave the tooltip in place adjacent to a dot while\nthe mouse roams freely over the graph until the next time it reaches a dot and\nthen the previous tooltip vanishes and a new one appears. The best way to\nappreciate this difference is to check out the live example on\n[bl.ocks.org](http://bl.ocks.org/d3noob/036d13e5173de69f7758091ba9a2df2b).\n\nThe code is as follows (you may notice that this also includes the link as\ndescribed above);\n\n    \n    \n      // add the dots with tooltips\n      svg.selectAll(\"dot\")\n         .data(data)\n       .enter().append(\"circle\")\n         .attr(\"r\", 5)\n         .attr(\"cx\", function(d) { return x(d.date); })\n         .attr(\"cy\", function(d) { return y(d.close); })\n         .on(\"mouseover\", function(d) {\n           div.transition()\n             .duration(200)\n             .style(\"opacity\", .9);\n           div .html(\n             '<a href= \"http://google.com\">' + // The first <a> tag\n             formatTime(d.date) +\n             \"</a>\" +                          // closing </a> tag\n             \"<br/>\"  + d.close)     \n             .style(\"left\", (d3.event.pageX) + \"px\")             \n             .style(\"top\", (d3.event.pageY - 28) + \"px\");\n           });\n    \n\nWe have removed the `.on(\"mouseout\"` portion and moved the function that it\nused to carry out to the start of the `.on(\"mouseover\"` portion. That way the\nfirst thing that occurs when the mouse cursor moves over a dot is that it\nremoves the previous tooltip and then it places the new one.\n\nThe last change we need to make is to remove from the `<style>` section the\nline that told the mouse to ignore the tooltip;\n\n    \n    \n        pointer-events: none;   /* This line needs to be removed */\n    \n\n##### Moar Links!\n\nOne link is interesting, but let’s face it, we didn’t go to all the trouble of\nputting a link into a tool tip to just go to one location. Now we shift it up\na gear and start linking to different places depending on our data. At the\nsame time (and because someone asked) we will make the link open in a new tab!\n\nThe changes to the script are fairly minor, but one fairly large change is the\nneed to have links to go to. For this example I have added a range of links to\nvisit to our csv file so it now looks like this;\n\n    \n    \n    date,close,link\n    1-May-12,58.13,http://bl.ocks.org/d3noob/c37cb8e630aaef7df30d\n    30-Apr-12,53.98,http://bl.ocks.org/d3noob/11313583\n    27-Apr-12,67.00,http://bl.ocks.org/d3noob/11306153\n    26-Apr-12,89.70,http://bl.ocks.org/d3noob/11137963\n    25-Apr-12,99.00,http://bl.ocks.org/d3noob/10633856\n    24-Apr-12,130.28,http://bl.ocks.org/d3noob/10633704\n    23-Apr-12,166.70,http://bl.ocks.org/d3noob/10633421\n    20-Apr-12,234.98,http://bl.ocks.org/d3noob/10633192\n    19-Apr-12,345.44,http://bl.ocks.org/d3noob/10632804\n    18-Apr-12,443.34,http://bl.ocks.org/d3noob/9692795\n    17-Apr-12,543.70,http://bl.ocks.org/d3noob/9267535\n    16-Apr-12,580.13,http://bl.ocks.org/d3noob/9211665\n    13-Apr-12,605.23,http://bl.ocks.org/d3noob/9167301\n    12-Apr-12,622.77,http://bl.ocks.org/d3noob/8603837\n    11-Apr-12,626.20,http://bl.ocks.org/d3noob/8375092\n    10-Apr-12,628.44,http://bl.ocks.org/d3noob/8329447\n    9-Apr-12,636.23,http://bl.ocks.org/d3noob/8329404\n    5-Apr-12,633.68,http://bl.ocks.org/d3noob/8150631\n    4-Apr-12,624.31,http://bl.ocks.org/d3noob/8273682\n    3-Apr-12,629.32,http://bl.ocks.org/d3noob/7845954\n    2-Apr-12,618.63,http://bl.ocks.org/d3noob/6584483\n    30-Mar-12,599.55,http://bl.ocks.org/d3noob/5893649\n    29-Mar-12,609.86,http://bl.ocks.org/d3noob/6077996\n    28-Mar-12,617.62,http://bl.ocks.org/d3noob/5193723\n    27-Mar-12,614.48,http://bl.ocks.org/d3noob/5141528\n    26-Mar-12,606.98,http://bl.ocks.org/d3noob/5028304\n    \n\nThe code change is to the piece of JavaScript where we add the HTML. This is\nwhat we end up with;\n\n    \n    \n        div .html(\n            '<a href= \"'+d.link+'\" target=\"_blank\">' + //with a link\n            formatTime(d.date) +\n            \"</a>\" +\n            \"<br/>\"  + d.close)     \n            .style(\"left\", (d3.event.pageX) + \"px\")             \n            .style(\"top\", (d3.event.pageY - 28) + \"px\");\n    \n\nWe’ve replaced the URL `http://google.com` with the variable for our `link`\ncolumn `d.link` and we’ve also added in the `target=\"_blank\"` statement so\nthat our link opens in a new tab.\n\nA quick word of warning on this piece of code. it can look a little messy\nbecause it includes nested speech-marks and quotation marks. This makes it a\nbit confusing if you’re unused to the idea of nesting this type of\ninformation. If things aren’t working in this part of your code, I recommend\ngoing back to basics and adding one piece at a time, getting it right and then\nadd the next piece. Take it slow :-).\n\nThe full code for this multi link example can be found on\n[github](https://gist.github.com/d3noob/a04a5897a92c046563017c7590f0c12c) or\nin the code samples bundled with this book (tooltips-link-multi.html and data-\nlink.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/a04a5897a92c046563017c7590f0c12c).\n\nHopefully that helps people with a similar desire to include links in their\ntooltips. Many thanks to the reader who suggested it :-).\n\n### What are the predefined, named colours?\n\nThroughout this document I generally use colours defined by name. This is\nmainly because I can, and not for any other reason. In fact there several\ndifferent ways to define colours used in D3 / JavaScript / CSS and HTML. I\nhave no idea what the limitations for use are and / or how their use in\ndifferent browsers impacts on correct representation. But I do know that\nthey’re used widely.\n\nThere seem to be several different standards for what constitutes an\nauthoritative list of named colours. After a cursory search I was able to find\na great list on\n[about.com](http://webdesign.about.com/od/colorcharts/l/bl_namedcolors.htm)\nand there are some nice representations on\n[Wikipedia](http://en.wikipedia.org/wiki/Web_colors#X11_color_names).\n\nThe overriding point of all this is that there’s more than one way to define\ncolours in your graphs.\n\nIt means that considering… `.style(\"fill\", \"steelblue\")`  \nand…  \n`.style(\"fill\", \"#4682b4\")`  \nand…  \n`.style(\"fill\", \"rgb(70,130,180)\")`\n\nAll three alternatives result in the same colour being applied.\n\nFor a long time I didn’t actually have the images of the colours represented\nhere in D3 Tips and Tricks, but like all things, one day I thought ‘Hey, I\ncould just write a simple script that placed them on the screen’. So here they\nare :-).\n\nI have tried to group them as ‘like’ colours per the entry in Wikipedia.\n\n![](images/colour-01.png) ![](images/colour-02.png) ![](images/colour-03.png)\n![](images/colour-04.png) ![](images/colour-05.png) ![](images/colour-06.png)\n![](images/colour-07.png) ![](images/colour-08.png) ![](images/colour-09.png)\n![](images/colour-10.png) ![](images/colour-11.png) ![](images/colour-12.png)\n![](images/colour-13.png) ![](images/colour-14.png) ![](images/colour-15.png)\n![](images/colour-16.png) ![](images/colour-17.png) ![](images/colour-18.png)\n![](images/colour-19.png) ![](images/colour-20.png) ![](images/colour-21.png)\n![](images/colour-22.png) ![](images/colour-23.png) ![](images/colour-24.png)\n![](images/colour-25.png) ![](images/colour-26.png) ![](images/colour-27.png)\n![](images/colour-28.png) ![](images/colour-29.png) ![](images/colour-30.png)\n![](images/colour-31.png) ![](images/colour-32.png) ![](images/colour-33.png)\n![](images/colour-34.png) ![](images/colour-35.png) ![](images/colour-36.png)\n![](images/colour-37.png) ![](images/colour-39.png) ![](images/colour-40.png)\n![](images/colour-41.png) ![](images/colour-42.png) ![](images/colour-43.png)\n![](images/colour-44.png) ![](images/colour-45.png) ![](images/colour-46.png)\n![](images/colour-47.png)\n\nYou can also see a live page with the script that produces the rectangles at\n[bl.ocks.org](http://bl.ocks.org/d3noob/11313583).\n\n### Selecting / filtering a subset of objects\n\nImagine a scenario where you want to select (or should we say **filter**) a\nparticular range of objects from a larger set.\n\nFor example, what if we wanted to use our scatter plot example to show the\nline as normal, but we are particularly interested in the points where the\nvalues of the points fall below 400. Therefore, when the value falls below 400\nwe want them highlighted with a circle as we have done with *the scatter plot\npoints previously.\n\nSo that we end up with something that looks a little like this…\n\n![Only the points below 400 are selected](images/filter01.png) Only the points\nbelow 400 are selected\n\nErr… Yes, for those among you who are of the observant persuasion, I have\ndeliberately coloured them red as well (red for **DANGER**!).\n\nThis is a fairly simple example, but serves to illustrate the principle\nadequately. From our simple scatter plot example we only need to add in two\nlines to the block of code that draws the circles as follows;\n\n    \n    \n      // Add the scatterplot\n      svg.selectAll(\"dot\")\n          .data(data)\n        .enter().append(\"circle\")\n          .filter(function(d) { return d.close < 400 })  // <== This line\n          .style(\"fill\", \"red\")                          // <== and this one\n          .attr(\"r\", 5)\n          .attr(\"cx\", function(d) { return x(d.date); })\n          .attr(\"cy\", function(d) { return y(d.close); });\n    \n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/47b319ec0250b4063063942c64f0f949) or\nin the code samples bundled with this book (filter-selection.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/47b319ec0250b4063063942c64f0f949).\n\nThe first added line uses the `.filter` function to act on the data points and\naccording to the arguments passed to it in this case, only return those where\nthe value of d.close is less than 400 (`return d.close < 400`).\n\nThe second added line simply colours the circles red (`.style(\"fill\",\n\"red\")`).\n\nThat’s all there is to it. Pretty simple, but the filter function can be very\npowerful when used wisely.\n\n### Select items with an IF statement.\n\nThe [filtering – selection section](chap11.xhtml#filtering) above is a good\nway to adapt what you see on a graph, but so is a more familiar friend… The\n‘if’ statement.\n\nAn ‘if’ statement will act to carry out a task in a particular way dependant\non a condition that you specify.\n\nHere’s an example, what if we wanted to show our scatter plot as normal, but\nall those with a ‘close’ value less than 400 should be coloured red. Sound\nfamiliar? Yes, I know it’s similar to the example above, with the subtle\ndifference that it is leaving the circles above 400 in place (more on that to\nfollow).\n\nStarting with the [simple scatter plot](chap11.xhtml#scatterplot) example all\nwe have to do is include the if statement in the block of code that draws the\ncircles. Here’s the entire block with the additions highlighted;\n\n    \n    \n      // Add the scatterplot\n      svg.selectAll(\"dot\")\n          .data(data)\n        .enter().append(\"circle\")\n          .attr(\"r\", 5)\n          .style(\"fill\", function(d) {            // <== Add these\n              if (d.close <= 400) {return \"red\"}  // <== Add these\n              else { return \"black\" }             // <== Add these\n          ;})                                     // <== Add these\n          .attr(\"cx\", function(d) { return x(d.date); })\n          .attr(\"cy\", function(d) { return y(d.close); });\t\n    \n\nOur first added line introduces the style modifier and the rest of the code\nacts to provide a return for the ‘fill’ attribute.\n\nThe second line introduces our if statement. There’s very little difference\nusing `if` statements between languages. Just look out for maintaining the\ncorrect syntax and you should be fine. In this case we’re asking if the value\nof ‘d.close’ is less than or equal to 400 and if it is it will return the\n`\"red\"` statement for our fill.\n\nThe third line covers our rear and make sure that if the colour isn’t going to\nbe red, it’s going to be black. The last line just closes the style and\nfunction statements.\n\nThe result?\n\n![Points above 400 black and points below 400 red](images/if01.png) Points\nabove 400 black and points below 400 red\n\nAww….. nice.\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/491c32149571faef2750632d4620e7ce) or\nin the code samples bundled with this book (if-selection.html and data.csv). A\nworking example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/491c32149571faef2750632d4620e7ce).\n\nCould it be any cooler? I’m glad you asked.\n\nWhat if we wanted to have all the points where close was less than 400 red and\nall those where close was greater than 620 green? Oh yeah! Now we’re talking.\n\nSo with one small change to the if statement;\n\n    \n    \n          .style(\"fill\", function(d) {   \n             if (d.close <= 400) {return \"red\"}  \n             else if (d.close >= 620) {return \"lawngreen\"} // <== Right here \n             else { return \"black\" }  \n          ;})  \t\n    \n\nCheck it out…\n\n![Points coloured differently depending on their value](images/if02.png)\nPoints coloured differently depending on their value\n\nNice.\n\n### Applying a colour gradient to a line based on value.\n\nI know that we were impressed with the changing dots in a scatter plot based\non the value. But could we go one better?\n\nHow about we try to reproduce the same effect but by varying the colour of the\nplotted line. This is a neat feature and a useful example of the flexibility\nof d3.js and SVG in general. I used the appropriate bits of code from Mike\nBostock’s [Threshold Encoding example](http://bl.ocks.org/3970883). And I\nshould take the opportunity to heartily recommend browsing through his\ncollection of examples on [bl.ocks.org](http://bl.ocks.org/mbostock).\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/d3a22ef27b253ab8d49e97699a8e84b1) or\nin the code samples bundled with this book (line-graph-gradient.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/d3a22ef27b253ab8d49e97699a8e84b1).\n\nHere then is a plotted line that is red below 400, green above 620 and black\nin between.\n\n![Line colour varied with gradient](images/gradientline01.png) Line colour\nvaried with gradient\n\nHow cool is that?\n\nEnough beating around the bush, how is the magic line produced?\n\nStarting with our [simple line graph](chap04.xhtml#simplegraph), there are\nonly two blocks of code to go in. One is CSS in the `<style>` area and the\nsecond is a tricky little piece of code that deals with gradients.\n\nFirst the CSS.\n\n    \n    \n    .line {\t\t\t\t\t\t\t\n      fill: none;\t\t\t\t\t\n      stroke: url(#line-gradient);\t\n      stroke-width: 2px;\t\t\t\n    }\t\n    \n\nThis block will go in the `<style>` area.\n\nThere’s the fairly standard fill of none and a stroke width of 2 pixels, but\nthe `stroke: url(#line-gradient);` is something different.\n\nIn this case the stroke (the colour of the line) is being determined at a link\nwithin the page which is set by the anchor `#line-gradient`. We will see\nshortly that this is in our second block of code, so the colour is being\ndefined in a separate portion of the script.\n\nAnd now the JavaScript gradient code;\n\n    \n    \n      // set the gradient\n      svg.append(\"linearGradient\")\t\t\t\t\n        .attr(\"id\", \"line-gradient\")\t\t\t\n        .attr(\"gradientUnits\", \"userSpaceOnUse\")\t\n        .attr(\"x1\", 0).attr(\"y1\", y(0))\t\t\t\n        .attr(\"x2\", 0).attr(\"y2\", y(1000))\t\t\n      .selectAll(\"stop\")\t\t\t\t\t\t\n        .data([\t\t\t\t\t\t\t\t\n          {offset: \"0%\", color: \"red\"},\t\t\n          {offset: \"40%\", color: \"red\"},\t\n          {offset: \"40%\", color: \"black\"},\t\t\n          {offset: \"62%\", color: \"black\"},\t\t\n          {offset: \"62%\", color: \"lawngreen\"},\t\n          {offset: \"100%\", color: \"lawngreen\"}\t\n        ])\t\t\t\t\t\n      .enter().append(\"stop\")\t\t\t\n        .attr(\"offset\", function(d) { return d.offset; })\t\n        .attr(\"stop-color\", function(d) { return d.color; });\t\t\n    \n\nThere’s our anchor on the third line!\n\nBut let’s not get ahead of ourselves. This block should be placed after the x\nand y domains are set, but before the line is drawn.\n\nSeems a bit strange doesn’t it? This block is all about defining the actions\nof an element, but the element in this case is a gradient and the gradient\nacts on the line. This is one of the cool things about writing code and\nregarding that code as a set of building blocks of the final product. There\nare many supporting components for the final product.\n\nOur second line adds our linear gradient. Gradients consist of continuously\nsmooth colour transitions along a vector from one colour to another. We can\nhave a linear or radial gradient and depending on which you select, there are\na few options to define. There is some great information on gradients at\n<http://www.w3.org/TR/SVG/pservers.html> (more than I ever thought existed).\n\nThe third line (`.attr(\"id\", \"line-gradient\")`) sets our anchor for the CSS\nthat we saw earlier.\n\nThe fourth, fifth and sixth lines define the bounds of the area over which the\ngradient will act. Since the coordinates `x1`, `y1`, `x2`, `y2` will describe\nan area. The values for `y1` (0) and `y2` (1000) are used more for convenience\nto align with our data (which has a maximum value around 630 or so). For more\ninformation on the ‘gradientUnits’ attribute I found this page useful\n<https://developer.mozilla.org/en-US/docs/SVG/Attribute/gradientUnits>. We’ll\ncome back to the coordinates in a moment.\n\nThe next block selects all the ‘stop’ elements for the gradients. These stop\nelements define where on the range covered by our coordinates the colours\nstart and stop. These have to be defined as either percentages or numbers\n(where the numbers are really just percentages in disguise (i.e. 45% =0.45)).\n\nThe best way to consider the stop elements is in conjunction with the\n`gradientUnits`. The image following may help.\n\n![Varying colours for varying values make a\ngradient](images/gradientline02.png) Varying colours for varying values make a\ngradient\n\nIn this case our coordinates describe a vertical line from 0 to 1000. Our\ncolours transition from red (0) to red (400) at which point they change to\nblack (400) and this will continue until it gets to black (620). Then this\nchanges to green (620) and from there, any value above that will be green.\n\nNow, it might seem a little convoluted to be doubling up on the colours and\nvalues, but the reason is that the gradient functions have a lot more to them\nthan meets the eye and we’ll have a look at the possibilities once the\nexplanation of the code is done.\n\nAfter defining the stop elements, we enter and append the elements to the\ngradient (`.enter().append(\"stop\")`) with attributes for offset and colour\nthat we defined in the stop elements area.\n\nNow, that _IS_ cool, but by now, I hope that you have picked that a gradient\nfunction really does mean a gradient, and not just a straight change from one\ncolour to another.\n\nSo, let’s try changing the stop element offsets to the following (and making\nthe stroke-width slightly larger to see more clearly what’s going on);\n\n    \n    \n        .data([\t\t\t\t\t\t\t\t\n          {offset: \"0%\", color: \"red\"},\t\t\n          {offset: \"30%\", color: \"red\"},\t\n          {offset: \"45%\", color: \"black\"},\t\t\n          {offset: \"55%\", color: \"black\"},\t\t\n          {offset: \"60%\", color: \"lawngreen\"},\t\n          {offset: \"100%\", color: \"lawngreen\"}\t\n        ])\t\t\n    \n\nAnd here we go…\n\n![Line with a gradually changing gradient](images/gradientline03.png) Line\nwith a gradually changing gradient\n\nAhh… A real gradient.\n\nI have tended to find that I need to have a good think about how I set the\noffsets and bounds when doing this sort of thing since it can get quite\ncomplicated quite quickly :-)\n\n### Applying a colour gradient to an area fill.\n\nThe previous example of a varying gradient on a line is neat, but hopefully\nyou’re already thinking “Hang on, can’t that same thing be applied to an area\nfill?”.\n\nDamn! You’re catching on.\n\nTo do this there’s only a few things we need to change;\n\nFirst of all the CSS for the line needs to be amended to refer to the area. So\nthis…\n\n    \n    \n    .line {\t\t\t\t\t\t\t\n      fill: none;\t\t\t\t\t\n      stroke: url(#line-gradient);\t\n      stroke-width: 2px;\t\t\t\n    }\t\t\n    \n\n…gets changed to this…\n\n    \n    \n    .area {\t\t\t\t\t\t\t\n      fill: url(#area-gradient);\t\t\t\t\t\n      stroke-width: 0px;\t\t\t\n    }\t\t\n    \n\nWe’ve defined the styles for the area this time, but instead of the stroke\nbeing defined by the separate script, now it’s the area. While we’ve changed\nthe url name, it’s actually the same piece of code, with a different id\n(because it seemed wrong to be talking about an area when the label said\nline). We’ve also set the stroke width to zero, because we don’t want any\nlines around our filled area.\n\nNow we want to take the block of code that defined our line…\n\n    \n    \n    // define the line\n    var valueline = d3.line()\n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.close); });\t\t\n    \n\n… and we need to replace it with the standard block that defined an area fill.\n\n    \n    \n    // define the area\n    var\tarea = d3.area()\t\n        .x(function(d) { return x(d.date); })\t\n        .y0(height)\t\t\t\t\t\n        .y1(function(d) { return y(d.close); });\t\t\n    \n\nSo we’re not going to be drawing a line at all. Just the area fill.\n\nNext, as I mentioned earlier, we change the id for the `linearGradient` block\nfrom `\"line-gradient\"` to `\"area-gradient\"`\n\n    \n    \n          .attr(\"id\", \"area-gradient\")\t\t\t\n    \n\nAnd lastly, we remove the block of code that drew the line and replace it with\na block that draws an area. So change this….\n\n    \n    \n      // Add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"d\", valueline);\n    \n\n… to this;\n\n    \n    \n      // Add the area.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"area\")\n          .attr(\"d\", area);\n    \n\nAnd then sit back and marvel at your creation;\n\n![Area fill with a gradually changing gradient](images/gradientarea01.png)\nArea fill with a gradually changing gradient\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/49570a3cd70390c257c80ac75c5049f1) or\nin the code samples bundled with this book (area-graph-gradient.html and\ndata.csv). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/49570a3cd70390c257c80ac75c5049f1).\n\nFor a slightly ‘nicer’ looking example, you could check out a variation of one\nof Mike Bostock’s (v3) originals here; <http://bl.ocks.org/4433087>.\n\n### Transitions\n\nA transition in d3 is an application of an animation to an\n[element](chap06.xhtml#elements) on the page. For the purpose of demonstration\nwe can think of an [element](chap06.xhtml#elements) being one of the common\nshapes and objects which include circles, ellipses, rectangles, lines,\npolylines, polygons, text and paths. This is a gross oversimplification as\ntransitions can be applied in far more complex ways, but this will help us get\nstarted. An animation could be described as a change in an attribute or style\nof an element over time.\n\nIf we use a [circle](chap06.xhtml#circle) as an example we know that a\n[circle](chap06.xhtml#circle) is described by three required attributes;\n\n  * `cx`: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.\n  * `cy`: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.\n  * `r`: The radius of the circle from the `cx`, `cy` position to the perimeter of the circle. \n\nTo animate a [circle](chap06.xhtml#circle) we would therefore be _changing_\n(or transitioning) one of those attributes over time.\n\nThe following JavaScript will draw a simple blue circle with radius 20 pixels\nat the position 40,250\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a cicle to the svg\n    \t.attr(\"style\", \"blue\")   // fill the circle with 'blue'\n    \t.attr(\"r\", 20)          // set the radius to 10 pixels\n    \t.attr('cx', 40)         // position the circle at 40 on the x axis\n    \t.attr('cy', 250);       // position the circle at 250 on the y axis\n    \n\nTo transition that circle from left to right we would change the `cx`\nattribute by simply including the transition instruction the new value of the\nattribute to be changed and the time that it should be completed in;\n\n    \n    \n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('cx', 920);       // new horizontal position at 920 on x axis\n    \n\nThe total amount of code required is;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n    \t.attr(\"style\", \"blue\")   // fill the circle with 'blue'\n    \t.attr(\"r\", 20)          // set the radius to 10 pixels\n    \t.attr('cx', 40)         // position the circle at 40 on the x axis\n    \t.attr('cy', 250)        // position the circle at 250 on the y axis\n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('cx', 920);       // new horizontal position at 920 on x axis\n    \n    </script>\n    </body>\n    \n\nThe full code for this example can also be found on\n[github](https://gist.github.com/d3noob/c3cbb8af554eb848d09ab97306bb5583) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (transition-circle.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/c3cbb8af554eb848d09ab97306bb5583).\n\nAnd seen on the web page our circle moves from left to right.\n\n![Circle Transition](images/transition-01.png) Circle Transition\n\nA transition can be of more than one attribute at the same time. If we add\nlines to change the radius and fill colour as well we will have some\nJavaScript that looks a bit like this;\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n        .style(\"fill\", \"blue\")  // fill the circle with 'blue'\n        .attr(\"r\", 20)          // set the radius to 10 pixels\n        .attr('cx', 40)         // position the circle at 40 on the x axis\n        .attr('cy', 250)        // position the circle at 250 on the y axis\n        .transition()           // apply a transition\n        .duration(4000)         // apply it over 4000 milliseconds\n        .attr('cx', 920)        // new horizontal position at 920 on x axis\n        .attr('r', 40)          // new radius of 40 pixels\n        .style('fill', \"red\");  // new colour red\n    \n\nAnd when we load the page we see our circle move from left to right wile at\nthe same time increasing in radius and changing colour from blue to red.\n\n![Multi Attribute Circle Transition](images/transition-02.png) Multi Attribute\nCircle Transition\n\n#### Transitioning Chaining\n\nInstead of having multiple attributes / styles changing at once we can stagger\nthem using transition chaining. This is where we can employ several different\ntransitions to an element one after the other.\n\nFor example, the following JavaScript will move our circle from left to right\n_then_ it will increase the radius from 20 to 40 and _then_ it will change\nit’s colour from blue to red.\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n    \t.style(\"fill\", \"blue\")  // fill the circle with 'blue'\n    \t.attr(\"r\", 20)          // set the radius to 10 pixels\n    \t.attr('cx', 40)         // position the circle at 40 on the x axis\n    \t.attr('cy', 250)        // position the circle at 250 on the y axis\n        // 1st transition  \n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('cx', 920)        // new horizontal position at 920 on x axis\n        // 2nd transition\n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.attr('r', 40)          // new radius of 40 pixels\n        // 3rd transition\n    \t.transition()           // apply a transition\n    \t.duration(4000)         // apply it over 4000 milliseconds\n    \t.style('fill', \"red\");  // new colour red\n    \n\n![Transition Chaining](images/transition-03.png) Transition Chaining\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/899a0b2490318a96f9ebd40a5a84e4a7) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (transition-chaining.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/899a0b2490318a96f9ebd40a5a84e4a7).\n\n#### Transition Easing\n\nThe reader who runs the code or checks out the simple example\n[here](http://bl.ocks.org/d3noob/c3cbb8af554eb848d09ab97306bb5583) will notice\nthat our circle does not move from one side to the other at a constant speed.\nIt starts off slowly, builds up speed towards the middle of its travels and\nthen slows down before stopping. This gives the movement a pleasing\nappearance, but it is an example of the\n‘[easing](https://github.com/d3/d3-ease)’ of the transition from one point to\nanother.\n\nTo apply a linear motion to the movement we can introduce\n`.ease(d3.easeLinear)` to the code as follows;\n\n    \n    \n    var svg = d3.select(\"body\") // Select the body element\n        .append(\"svg\")          // Append an SVG element to the body\n        .attr(\"width\", 960)     // make it 960 pixels wide\n        .attr(\"height\", 500)    // make it 500 pixels high\n        .append(\"circle\")       // append a circle to the svg\n        .style(\"fill\", \"blue\")  // fill the circle with 'blue'\n        .attr(\"r\", 20)          // set the radius to 10 pixels\n        .attr('cx', 40)         // position the circle at 40 on the x axis\n        .attr('cy', 250)        // position the circle at 250 on the y axis\n        .transition()           // apply a transition\n        .ease(d3.easeLinear)    // control the speed of the transition\n        .duration(4000)         // apply it over 4000 milliseconds\n        .attr('cx', 920);       // new horizontal position at 920 on x axis\n    \n\nThe easing of an element describes a distortion in the apparent flow of time.\nThere are a range of different types of easing described in the [d3\nwiki](https://github.com/d3/d3-ease). Most are representative of a function\nalthough there are some which are intended to represent specific real-world\nmotions.\n\n  * linear\n  * quad\n  * cubic\n  * poly\n  * sin\n  * exp\n  * circle\n  * bounce\n  * back\n  * elastic\n\nEach easing (except linear) can be further modified using ‘In’, ‘Out’ or\nInOut’ which allows for variations in the animation that can give the\nappearance of starting or stopping at different points in the curves or in the\ncase of ‘InOut’ of going through a complete transition. For example,\n`.ease(d3.easeExpIn)` or `.ease(d3.easePolyInOut)`.\n\nIf an easing function is not specified, the default used is cubic and if ‘In’,\n‘Out’ or InOut’ aren’t specified, the default is ‘InOut’ except for bounce and\nelastic which use ‘Out’. Therefore we can use `.ease(d3.easePoly)` which is an\nalias for `.ease(d3.easePolyInOut)`. ‘easePoly’ is also an alias for\n‘easeCubic’ (and vice versa).\n\nTo get a good impression of the way that each easing method is represented,\nMike Bostock has an ‘[Easing\nExplorer](http://bl.ocks.org/mbostock/248bac3b8e354a9103c4)’ block set up\nhere. There is also a block to do a side by side comparison\n[here](http://bl.ocks.org/d3noob/1ea51d03775b9650e8dfd03474e202fe) (this is\nalso in the code samples bundled with [this\nbook](https://leanpub.com/d3-t-and-t-v4) (transition-easing-multiple.html)).\n\n#### Looping a Transition\n\nWe can use a transition to create a convincing impression of an element that\nis in a constant rate of change in a looping condition. We achieve this by\ncreating a [transition chain](chap11.xhtml#chaining) that starts and ends in\nthe same state and then we instruct the transition code to repeat itself.\n\nIn the example we will have a circle that moves from left to right and then\nback again constantly.\n\n![Looping Transitionn](images/transition-04.png) Looping Transitionn\n\nThe full code for this example can be found on\n[github](https://gist.github.com/d3noob/bf44061b1d443f455b3f857f82721372) or\nin the code samples bundled with [this book](https://leanpub.com/d3-t-and-\nt-v4) (transition-looping.html). A working example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/bf44061b1d443f455b3f857f82721372).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n    var svg = d3.select(\"body\")\n            .append(\"svg\")\n            .attr(\"width\", 960)\n            .attr(\"height\", 500);\n    \n    function circleTransition() { \n    \n        var timeCircle = svg.append(\"circle\")\n            .attr(\"fill\", \"steelblue\")\n            .attr(\"r\", 20);\n        repeat();\n        \n        function repeat() {\n          timeCircle\n            .attr('cx', 40)      // position the circle at 40 on the x axis\n            .attr('cy', 250)     // position the circle at 250 on the y axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 920)     // move the circle to 920 on the x axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 40)      // return the circle to 40 on the x axis\n            .on(\"end\", repeat);  // when the transition finishes start again\n        };\n    \n    };\n    \n    circleTransition();\n    \n    </script>\n    </body>\n    \n\nThe JavaScript starts by creating an SVG element;\n\n    \n    \n    var svg = d3.select(\"body\")\n            .append(\"svg\")\n            .attr(\"width\", 960)\n            .attr(\"height\", 500);\n    \n\nWe then declare the function `circleTransition` which starts by creating the\ncomponent that defines the circle and gives it a colour and radius;\n\n    \n    \n        var timeCircle = svg.append(\"circle\")\n            .attr(\"fill\", \"steelblue\")\n            .attr(\"r\", 20);\n    \n\nWe then call a sub function `repeat` that performs the transition chaining\nloop. Then the looping transition is declared;\n\n    \n    \n        function repeat() {\n          timeCircle\n            .attr('cx', 40)      // position the circle at 40 on the x axis\n            .attr('cy', 250)     // position the circle at 250 on the y axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 920)     // move the circle to 920 on the x axis\n            .transition()        // apply a transition\n            .duration(2000)      // apply it over 2000 milliseconds\n            .attr('cx', 40)      // return the circle to 40 on the x axis\n            .on(\"end\", repeat);  // when the transition finishes start again\n        };\n    \n\nHere we can see the familiar parts of a transition where the attributes and\ntransition details are declared in a chain so that when it completes, the\ncircle has moved from the left to the right and then back to the starting\nposition. At that point the code listens for the `end` of the transformations,\nand when this occurs it calls the transition function `repeat` again. This\nwill continue to cycle indefinitely.\n\nThe last part of the code is the instruction to call our initial function;\n\n    \n    \n    circleTransition();\n    \n\nBecause the code is executing\n[asynchronously](https://www.pluralsight.com/guides/front-end-\njavascript/introduction-to-asynchronous-javascript), it can continue to\noscillate while other code could be carrying out other tasks.\n\n### Show / hide an element by clicking on another element\n\nThis is a trick that I found I wanted to implement in order to present a graph\nwith a range of lines and to then provide the reader with the facility to\nclick on the associated legend to toggle the visibility of the lines off and\non as required.\n\nThe example we’ll follow is our friend from earlier, a slightly modified\nexample of the graph with two lines.\n\n![Show / hide lines on a graph](images/show-hide-01.png) Show / hide lines on\na graph\n\nIn this example we will be able to click on either of the two titles at the\nbottom of the graph (‘Blue Line’ or ‘Red Line’) and have it toggle the\nrespective line and Y axis.\n\n##### The code\n\nThe code for the example is available online at\n[bl.ocks.org](http://http://bl.ocks.org/d3noob/4abb9dc578abf070fe62302282a29c41)\nor [GitHub](https://gist.github.com/d3noob/4abb9dc578abf070fe62302282a29c41).\nIt is also available as the file ‘show-hide.html’ that can be a download when\nyou [download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThere are more changes in the example code than we will explain below such as\nthe addition of CSS to the `<style>` area and the code that allows both of the\nlines to be shown / hidden (we’ll only go through the blue line code).\n\nThere are two main parts to implementing this technique. Firstly we have to\nlabel the element (or elements) that we wish to show / hide and then we have\nto give the object that will get clicked on the attribute that allows it to\nrecognise a mouse click and the code that it subsequently uses to show / hide\nour labelled element.\n\nLabelling the element that is to be switched on and off is dreadfully easy. It\nsimply involves including an `id` attribute to an element that identifies it\nuniquely.\n\n    \n    \n      // add the valueline path.\n      svg.append(\"path\")\n          .data([data])\n          .attr(\"class\", \"line\")\n          .attr(\"id\", \"blueLine\")\n          .attr(\"d\", valueline);\n    \n\nIn the example above we have applied the `id` `blueLine` to the path that\ndraws the blue line on our graph.\n\nThe second part is a little trickier. The following is the portion of\nJavaScript that places our text label under the graph. The only part of it\nthat is unusual is the `.on(\"click\", function()` section of the code.\n\n    \n    \n      // add the blue line legend\n      svg.append(\"text\")\n         .attr(\"x\", 0)             \n         .attr(\"y\", height + margin.top + 15)    \n         .attr(\"class\", \"legend\")\n         .style(\"fill\", \"steelblue\")         \n         .on(\"click\", function(){\n           // determine if current line is visible\n           var active = blueLine.active ? false : true,\n           newOpacity = active ? 0 : 1;\n           // hide or show the elements\n           d3.select(\"#blueLine\").style(\"opacity\", newOpacity);\n           // update whether or not the elements are active\n           blueLine.active = active;\n         })\n         .text(\"Blue Line\");\n    \n\nWhen we click on our ‘Blue Line’ text element the `.on(\"click\", function()`\nsection executes.\n\nWe’re using a short-hand version of the `if` statement a couple of times here.\nFirstly we check to see if the variable `blueLine.active` is true or false and\nif it’s true it gets set to false and if it’s false it gets set to true (not\nat all confusing).\n\n    \n    \n           var active = blueLine.active ? false : true,\n           newOpacity = active ? 0 : 1;\n    \n\nThen after toggling this variable we set the value of `newOpacity` to either 0\nor 1 depending on whether `active` is `false` or `true` (the second short-hand\nJavaScript if statement).\n\nWe can then select our identifiers that we have declared using the `id`\nattributes in the earlier pieces of code and modify their opacity to either\n`0` (off) or `1` (on)\n\n    \n    \n           d3.select(\"#blueLine\").style(\"opacity\", newOpacity);\n    \n\nLastly we update our `blueLine.active` variable to whatever the `active` state\nis so that it can toggle correctly the next time it is clicked on.\n\n    \n    \n           blueLine.active = active;\n    \n\nQuite a neat piece of code. Kudos to Max Leiserson for providing the example\non which it is largely based in an [answer to a question on Stack\nOverflow](http://stackoverflow.com/questions/20249215/how-to-display-and-hide-\nlinks-and-nodes-when-clicking-on-a-node-in-d3-javascript).\n\n### Using HTML inputs with d3.js\n\nPart of the attraction of using technologies like d3.js is that it expands the\nscope of what is possible in a web page. At the same time, there are many\ndifferent options for displaying content on a page and plenty of ways of\ninteracting with it.\n\nSome of the most basic of capabilities has been the use of HTML entities that\nallow the entry of data on a page. This can take a range of different forms\n(pun intended) and the `<input>` tag is one of the most basic.\n\n#### What is an HTML input?\n\nAn HTML input is an element in HTML that allows a web page to input data.\nThere are a range of different input types (with varying degrees of\ncompatibility with browsers) and they are typically utilised inside a `<form>`\nelement.\n\nFor example the following code allows a web page to place two fields on a web\npage so that a user can enter their first and last names in separate boxes;\n\n    \n    \n    <form>\n      First name: <input type=\"text\" name=\"firstname\"><br>\n      Last name: <input type=\"text\" name=\"lastname\">\n    </form>\n    \n\nThe page would then display the following;\n\n![A form input](images/input-01.png) A form input\n\nThe range of input types is large and includes;\n\n  * text: A simple text field that a user can enter information into.\n  * radio: Buttons that let a user select only one of a limited number of choices.\n  * button: A clickable button that can activate JavaScript.\n  * range: A slider control for setting a number whose exact value is not important.\n  * number: A field for entering a number or toggling a number up and down.\n\n… and many more. To check out others and get further background, it would be\nworthwhile visiting the[ Mozilla developer](https://developer.mozilla.org/en-\nUS/docs/Web/HTML/Element/Input) pages or\n[w3schools.com](http://www.w3schools.com/tags/tag_input.asp).\n\nWhile d3.js has the power to control and manipulate a web page to an extreme\nextent, sometimes it’s desirable to use a simple process to get a result. The\nfollowing explanations will demonstrate a simple use case linking an HTML\ninput with a d3.js element and will go on to provide examples of using\nmultiple inputs, affecting multiple elements and using different input types.\nThe examples are deliberately kept simple. They are intended to demonstrate\nfunctionality and to provide a starting position for you to go forward :-).\n\n#### Using a `range` input with d3.js\n\nThe first example we will follow will use a `range` input to adjust the radius\nof a circle.\n\n![Adjust the radius of a circle](images/input-02.png) Adjust the radius of a\ncircle\n\n##### The code\n\nThe following is the full code for the example. A live version is available\nonline at\n[bl.ocks.org](http://bl.ocks.org/d3noob/147791d51cf6516715914c49cb869f57) or\n[GitHub](https://gist.github.com/d3noob/147791d51cf6516715914c49cb869f57). It\nis also available as the file ‘input-radius.html’ as a separate download with\nthe book D3 Tips and Tricks v4.x. A copy of the files that appear in the book\ncan be downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>Input test (circle)</title>\n      \n    <p>\n      <label for=\"nRadius\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             radius = <span id=\"nRadius-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"150\" id=\"nRadius\">\n    </p>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw the circle\n    holder.append(\"circle\")\n      .attr(\"cx\", 300)\n      .attr(\"cy\", 150) \n      .style(\"fill\", \"none\")   \n      .style(\"stroke\", \"blue\") \n      .attr(\"r\", 120);\n    \n    // when the input range changes update the circle \n    d3.select(\"#nRadius\").on(\"input\", function() {\n      update(+this.value);\n    });\n    \n    // Initial starting radius of the circle \n    update(120);\n    \n    // update the elements\n    function update(nRadius) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nRadius-value\").text(nRadius);\n      d3.select(\"#nRadius\").property(\"value\", nRadius);\n    \n      // update the circle radius\n      holder.selectAll(\"circle\") \n        .attr(\"r\", nRadius);\n    }\n    \n    </script>\n    \n\n##### The explanation\n\nAs with the other examples in the book I will not go over some of the simpler\nlines of code that are covered in greater detail in earlier sections of the\nbook and will concentrate on those sections that contain new concepts, code or\nlook like they might need expanding :-).\n\nThe first section is the portion that sets out the html `range` input;\n\n    \n    \n    <p>\n      <label for=\"nRadius\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             radius = <span id=\"nRadius-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"150\" id=\"nRadius\">\n    </p>\n    \n\nThe entire block is enclosed in a paragraph (`<p>`) tag so that is appears on\na single line. It can be broken down into the label that occurs before the\ninput slider which is given the id `nRadius-value` and the `input` proper.\n\nThe `for` attribute of the `label` tag equals to the id attribute of the input\nelement to bind them together. This allows us to update the text later as the\nslider is moved.\n\nThe `input` tag can include four attributes that specify restrictions on the\noperation of the slider;\n\n  * `max`: specifies the maximum value allowed\n  * `min`: specifies the minimum value allowed\n  * `step`: specifies the number intervals as you move the slider\n  * `value`: Specifies the default value\n\nThe `id`s supplied for both the label and the input are important since they\nprovide the reference for our d3.js script.\n\nThe first portion of our JavaScript is fairly routine if you’ve been following\nalong with the rest of the book.\n\n    \n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw the circle\n    holder.append(\"circle\")\n      .attr(\"cx\", 300)\n      .attr(\"cy\", 150) \n      .style(\"fill\", \"none\")   \n      .style(\"stroke\", \"blue\") \n      .attr(\"r\", 120);\n    \n\nWe append an SVG element to the `body` of our page and then we append a circle\nwith some particular styling to the SVG element.\n\nThen things start to get more interesting…\n\n    \n    \n    d3.select(\"#nRadius\").on(\"input\", function() {\n      update(+this.value);\n    });\n    \n\nWe select our input using the `id` that we had declared earlier in the html\n(`nRadius`). Then we use the `.on` operator which adds what is called an\n‘[event\nlistener](https://github.com/d3/d3-selection/blob/master/README.md#handling-\nevents)’ to the element so that when there is a change in the element (in this\ncase an adjustment of the slider of the input) a function is called\n(`function()`) that in turn calls the `update` function with the value from\nthe input (`+this.value`). We haven’t seen the `update` function yet, but\nnever fear, it’s coming.\n\nWe also call the update function with a specific value in the next line;\n\n    \n    \n    update(120);\n    \n\nThis might seem slightly redundant, but unless the function gets a value, the\ntext associated with the range input doesn’t get a reading and remains on ‘…’\nuntil the slider is moved.\n\nLastly we have our `update` function;\n\n    \n    \n    function update(nRadius) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nRadius-value\").text(nRadius);\n      d3.select(\"#nRadius\").property(\"value\", nRadius);\n    \n      // update the circle radius\n      holder.selectAll(\"circle\") \n        .attr(\"r\", nRadius);\n    }\n    \n\nThe first part of the function selects the `label` associated with our input\n(with the `id`, `nRadius-value`) and applies the value that has been passed\ninto the function (`nRadius`). The next line selects the input itself and\napplies the value to it (this would be the equivalent of having\n`value=\"<number here>\"` as a property in the html).\n\nLastly, we select the circle element and apply the new radius value based on\nour input value `nRadius` (`.attr(\"r\", nRadius)`).\n\nAnd there we have it, a fully adjustable radius for our circle controlled with\nan HTML input.\n\n![Maximum radius for our circle](images/input-03.png) Maximum radius for our\ncircle\n\n#### Using more than one input\n\nIn this example we will use two separate inputs (range type) to adjust the\nheight and width of a rectangle.\n\n![Dual inputs](images/input-04.png) Dual inputs\n\nThis is not too much of a stretch from the previous single input example with\nthe radius of a circle, but it may be useful to reinforce the concept and\nillustrate something slightly different.\n\n##### The code\n\nThe following is the full code for the example. A live version is available\nonline at\n[bl.ocks.org](http://bl.ocks.org/d3noob/aee9277a3664850501f3d1d0fc731c86) or\n[GitHub](https://gist.github.com/d3noob/aee9277a3664850501f3d1d0fc731c86). It\nis also available as the file ‘input-double.html’ as a separate download with\nD3 Tips and Tricks v4.x. A copy of the files that appear in the book can be\ndownloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>Double Input Test</title>\n    \n    <p>\n      <label for=\"nHeight\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             height = <span id=\"nHeight-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"280\" id=\"nHeight\">\n    </p>\n    \n    <p>\n      <label for=\"nWidth\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             width = <span id=\"nWidth-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"400\" id=\"nWidth\">\n    </p>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw a rectangle\n    holder.append(\"rect\")\n        .attr(\"x\", 300)\n        .attr(\"y\", 150)\n        .style(\"fill\", \"none\")\n        .style(\"stroke\", \"blue\")\n        .attr(\"height\", 150) \n        .attr(\"width\", 200);\n    \n    // read a change in the height input\n    d3.select(\"#nHeight\").on(\"input\", function() {\n      updateHeight(+this.value);\n    });\n    \n    // read a change in the width input\n    d3.select(\"#nWidth\").on(\"input\", function() {\n      updateWidth(+this.value);\n    });\n    \n    // update the values\n    updateHeight(150);\n    updateWidth(100);\n    \n    // Update the height attributes\n    function updateHeight(nHeight) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nHeight-value\").text(nHeight);\n      d3.select(\"#nHeight\").property(\"value\", nHeight);\n    \n      // update the rectangle height\n      holder.selectAll(\"rect\") \n        .attr(\"y\", 150-(nHeight/2)) \n        .attr(\"height\", nHeight); \n    }\n    \n    // Update the width attributes\n    function updateWidth(nWidth) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nWidth-value\").text(nWidth);\n      d3.select(\"#nWidth\").property(\"value\", nWidth);\n    \n      // update the rectangle width\n      holder.selectAll(\"rect\")\n        .attr(\"x\", 300-(nWidth/2)) \n        .attr(\"width\", nWidth);\n    }\n    \n    </script>\n    \n\n##### The explanation\n\nFor the sake of brevity, this explanation will simply concentrate on the\ndifferences between the previous single input example and this one.\n\nThe declarations for the inputs in the HTML at the start of the code are\nsimply duplicates of each other in terms of function;\n\n    \n    \n    <p>\n      <label for=\"nHeight\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             height = <span id=\"nHeight-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"280\" id=\"nHeight\">\n    </p>\n    \n    <p>\n      <label for=\"nWidth\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             width = <span id=\"nWidth-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"1\" max=\"400\" id=\"nWidth\">\n    </p>\n    \n\nThe only significant difference is the declaration of the `id`’s for each\ninput and their respective labels.\n\nThe JavaScript selection of the inputs is more duplication;\n\n    \n    \n    d3.select(\"#nHeight\").on(\"input\", function() {\n      updateHeight(+this.value);\n    });\n    \n    d3.select(\"#nWidth\").on(\"input\", function() {\n      updateWidth(+this.value);\n    });\n    \n\nAgain the only substantive difference is the use of the appropriate `id`\nvalues.\n\nThe updating of the width and height is done via two different functions;\n\n    \n    \n    function updateHeight(nHeight) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nHeight-value\").text(nHeight);\n      d3.select(\"#nHeight\").property(\"value\", nHeight);\n    \n      // update the rectangle height\n      holder.selectAll(\"rect\") \n        .attr(\"y\", 150-(nHeight/2)) \n        .attr(\"height\", nHeight); \n    }\n    \n    // Update the width attributes\n    function updateWidth(nWidth) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nWidth-value\").text(nWidth);\n      d3.select(\"#nWidth\").property(\"value\", nWidth);\n    \n      // update the rectangle width\n      holder.selectAll(\"rect\")\n        .attr(\"x\", 300-(nWidth/2)) \n        .attr(\"width\", nWidth);\n    }\n    \n\nThe rectangle is selected using a common `rect` designator, so multiple\nrectangles could be controlled. But each function controls only a specific\nattribute (height or width).\n\n#### Rotate text with an input\n\nThis example is really just a derivative of the adjustment of a single\nattribute of an element.\n\nI happen to think it’s just a little bit ‘neater’ because it includes text,\nbut in reality, it’s just another attribute that can be adjusted.\n\nHere we let our range input adjust the rotation of a piece of text.\n\n![Text rotation with an input](images/input-05.png) Text rotation with an\ninput\n\n##### The explanation\n\nWe’ll dispense with the full code listing since it’s just a regurgitation of\nthe adjusting of the radius of the circle example, but the code for the\nexample is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/d072f01abe615478633f39eb7c383dee) or\n[GitHub](https://gist.github.com/d3noob/d072f01abe615478633f39eb7c383dee). It\nis also available as the file ‘input-text-rotate.html’ as a separate download\nwith D3 Tips and Tricks v4.x. A copy of the files that appear in the book can\nbe downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/leanpub.com/d3-t-and-t-v4).\n\nThe only, thing of even a slight difference (other than some naming\nconventions) is the initial drawing of the text…\n\n    \n    \n    holder.append(\"text\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,150) rotate(0)\")\n      .text(\"d3noob.org\");\n    \n\n… and the update function;\n\n    \n    \n    function update(nAngle) {\n    \n      // adjust the text on the range slider\n      d3.select(\"#nAngle-value\").text(nAngle);\n      d3.select(\"#nAngle\").property(\"value\", nAngle);\n    \n      // rotate the text\n      holder.select(\"text\") \n        .attr(\"transform\", \"translate(300,150) rotate(\"+nAngle+\")\");\n    }\n    \n\n#### Use a `number` input with d3.js\n\nThere are obviously different inputs types that can be implemented. The\nfollowing example still rotates our text, but uses a `number` type of input to\ndo it;\n\n    \n    \n    <p>\n      <label for=\"nValue\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             angle = <span id=\"nValue-value\"></span>\n      </label>\n      <input type=\"number\" min=\"0\" max=\"360\" step=\"5\" value=\"0\" id=\"nValue\">\n    </p>\n    \n\nWe have set the `step` value to speed things up a bit when rotating, but it’s\ncompletely optional.\n\nThe input itself can be adjusted up or down using a mouse click or have a\nnumber typed into the input box.\n\n![Text rotation with a number input](images/input-06.png) Text rotation with a\nnumber input\n\nThis type of input is slightly different from the range type since it isn’t\nfully supported under Firefox and as a result when I was testing it the arrow\nkeys for going up and down weren’t present.\n\nThe full code for the example is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/365ab1f8708d245b0ef82ba8afe18370) or\n[GitHub](https://gist.github.com/d3noob/365ab1f8708d245b0ef82ba8afe18370). It\nis also available as the file ‘input-number-text.html’ as a separate download\nwith D3 Tips and Tricks v4.x. A copy of the files that appear in the book can\nbe downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n#### Change more than one element with an input\n\nThe final example looking at using HTML inputs with d3.js incorporates a\nsingle input acting or two different elements. This might seem self evident,\nbut if you’re as unfamiliar with HTML as I am (it’s embarrassing I know, but\nwhat can you do?) it may be of assistance.\n\nThe end result is to produce a single slider as a `range` input that rotates\ntwo separate text objects in different directions simultaneously.\n\n![Dual text rotation](images/input-07.png) Dual text rotation\n\n##### The code\n\nThe following is the full code for the example. A live version is available\nonline at\n[bl.ocks.org](http://bl.ocks.org/d3noob/b901b4c8242e5c2de95d0b6b1656cc33) or\n[GitHub](https://gist.github.com/d3noob/b901b4c8242e5c2de95d0b6b1656cc33). It\nis also available as the file ‘input-text-rotate-2.html’ as a separate\ndownload with D3 Tips and Tricks v4.x. A copy of the files that appear in the\nbook can be downloaded (in a zip file) when you [download the book from\nLeanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <title>Input test</title>\n    \n    <p>\n      <label for=\"nAngle\" \n             style=\"display: inline-block; width: 240px; text-align: right\">\n             angle = <span id=\"nAngle-value\">…</span>\n      </label>\n      <input type=\"range\" min=\"0\" max=\"360\" id=\"nAngle\">\n    </p>\n    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    <script>\n    \n    var width = 600;\n    var height = 300;\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw d3.js text\n    holder.append(\"text\")\n      .attr(\"class\", \"d3js\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,55) rotate(0)\")\n      .text(\"d3.js\");\n    \n    // draw d3noob.org text\n    holder.append(\"text\")\n      .attr(\"class\", \"d3noob\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,130) rotate(0)\")\n      .text(\"d3noob.org\");\n    \n    // when the input range changes update the rectangle \n    d3.select(\"#nAngle\").on(\"input\", function() {\n      update(+this.value);\n    });\n    \n    // Initial starting height of the rectangle \n    update(0);\n    \n    // update the elements\n    function update(nAngle) {\n    \n    // adjust the range text\n      d3.select(\"#nAngle-value\").text(nAngle);\n      d3.select(\"#nAngle\").property(\"value\", nAngle);\n    \n      // adjust d3.js text\n      holder.select(\"text.d3js\") \n        .attr(\"transform\", \"translate(300,55) rotate(\"+nAngle+\")\");\n    \n      // adjust d3noob.org text\n      holder.select(\"text.d3noob\") \n        .attr(\"transform\", \"translate(300,130) rotate(\"+(360 - nAngle)+\")\");\n    }\n    \n    </script>\n    \n\n##### The explanation\n\nThe explanation for this example differs from the others in the way that the\nd3.js elements (the two pieces of text) are initially appended and then\nupdated.\n\nWhen they are initially drawn…\n\n    \n    \n    holder.append(\"text\")\n      .attr(\"class\", \"d3js\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,55) rotate(0)\")\n      .text(\"d3.js\");\n    \n    holder.append(\"text\")\n      .attr(\"class\", \"d3noob\")\n      .style(\"fill\", \"black\")\n      .style(\"font-size\", \"56px\")\n      .attr(\"dy\", \".35em\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"transform\", \"translate(300,130) rotate(0)\")\n      .text(\"d3noob.org\");\n    \n\n… both elements are declared with a `class` attribute that serves as a\nreference for the future updating. Here, the text ‘d3.js’ is given a `class`\nname of `d3js` and the text ‘d3noob.org’ is given a `class` name of `d3noob`.\n\nThen when we call the `update` function each of the two text elements is\nadjusted seperatly by selecting each based on the `class` name that was\napplied in the initial setup;\n\n    \n    \n    function update(nAngle) {\n    \n    // adjust the range text\n      d3.select(\"#nAngle-value\").text(nAngle);\n      d3.select(\"#nAngle\").property(\"value\", nAngle);\n    \n      // adjust d3.js text\n      holder.select(\"text.d3js\") \n        .attr(\"transform\", \"translate(300,55) rotate(\"+nAngle+\")\");\n    \n      // adjust d3noob.org text\n      holder.select(\"text.d3noob\") \n        .attr(\"transform\", \"translate(300,130) rotate(\"+(360 - nAngle)+\")\");\n    }\n    \n\nSo the ‘d3.js’ text is selected using `text.d3js` and ‘d3noob.org’ is selected\nusing `text.d3noob`. That’s a pretty neat trick and a good lesson for applying\nspecific transformations to specific objects.\n\n### Add an HTML table to your graph\n\nSo graphs and graphics are D3’s bread and butter you’d think. Hmm…\n\nWell yes and no.\n\nYes D3 has extraordinary powers for presenting and manipulating images in a\nweb page. But if you’ve read through the entirety of the d3.js main site\n(haven’t we all) you will recall that D3 actually stands for Data Driven\nDocuments. It’s not necessarily about the pretty pictures and the swirling\ncascade of colour. It’s about generating something in a web browser based on\ndata.\n\nThis transitions nicely into consideration of adding a table of information\nthat can accompany your graph (it could just as easily (or easier) be stand\nalone, but for the sake of continuity, we’ll use the graph).\n\nWhat we’ll do is add the data that we’ve used to make our simple graph under\nthe graph itself. To make sure that it’s all nicely aligned, we’ll place it in\na table.\n\nIt should end up looking a little like this (and this has been cropped\nslightly at the bottom to avoid expanding the page with rows of numbers /\ndates).\n\n![Basic graph with a table of data](images/table01.png) Basic graph with a\ntable of data\n\nThe code was drawn from an example provided by [Shawn\nAllen](http://jsfiddle.net/7WQjr/) on [Google\nGroups](http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-\nto-a-csv-file). In fact, the post itself is an excellent one if you are\nconsidering creating a table straight from a csv file.\n\n#### HTML Tables\n\nI’m walking a fine line here since I have a remarkably small amount of\nknowledge on HTML tables. So I’ll try to provide a brief overview as I\nunderstand it and as I see it represented in the code below, but for a far\nfuller explanation, take a look at some great work by [Peter Cook\nhere](http://prcweb.co.uk/lab/selection/) or let Google be your friend.\n\nTables are made up of rows, columns and data (that goes in each cell). All you\nneed to do to successfully place a table on a web page is to lay out the rows\nand columns in a logical sequence using the appropriate HTML tags and you’re\naway.\n\nFor example here’s the total HTML code for a web page to display a simple\ntable;\n\n    \n    \n    <!DOCTYPE html>\n    <body>\n        <table border=\"1\">\n            <tr>\n                <th>Header 1</th>\n                <th>Header 2</th>\n            </tr>\n            <tr>\n                <td>row 1, cell 1</td>\n                <td>row 1, cell 2</td>\n            </tr>\n            <tr>\n                <td>row 2, cell 1</td>\n                <td>row 2, cell 2</td>\n            </tr>\n        </table>\n    </body>\n    \n\nThis will result in a table that looks a little like this in a web browser;\n\n**Header 1** | **Header 2**  \n---|---  \nrow 1, cell 1 | row 1, cell 2  \nrow 2, cell 1 | row 2, cell 2  \n  \nThe entire table itself is enclosed in `<table>` tags. Each row is enclosed in\n`<tr>` tags. Each row has two items which equate to the two columns. Each\npiece of data for each cell is enclosed in a `<td>` tag except for the first\nrow, which is a header and therefore has a special tag `<th>` that denotes it\nas a header making it bold and centred. For the sake of ease of viewing we\nhave told the table to place a border around each cell and we do this in the\nfirst `<table>` tag with the `border=\"1\"` statement (although in this book\nview it may be absent).\n\nThe good news is that you don’t need to fully understand all this, but it will\nhelp with the explanation of what we’re doing in the code below.\n\nThere are three main things you need to do to the basic line graph to get your\ntable to display.\n\n  1. Add some CSS\n  2. Add some table building d3.js code\n  3. Make a small but cunning change…\n\nThere is a copy of the code and the data file for this example at\n[github](https://gist.github.com/d3noob/3e5138a14cfc1822eedee2963c493399) and\nin the code samples bundled with this book (simple-graph-plus-table.html and\ndata.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3e5138a14cfc1822eedee2963c493399).\n\n#### First the CSS\n\nThis just helps the table with formatting and making sure the individual cells\nare spaced appropriately;\n\n    \n    \n    td, th {\n      padding: 1px 4px;\n    }\n    \n\nThis sets a padding of 1 px around each cell and 4 px between each column.\n\nFeel free to play with the figures to suit your application, I’ve just set\nthem there because I thought they looked appropriate.\n\nI’ve placed this portion of CSS at the end of our `<style>` section.\n\n#### Now the d3.js code\n\nOki doki… Hopefully you have a loose understanding of the html layout of a\ntable as explained above, but if not you can always go with the ‘it just\nworks’ approach.\n\nHere’s what we should add into our simple graph example;\n\n    \n    \n    // The table generation function\n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 400px\"),\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n        // append the header row\n        thead.append(\"tr\")\n            .selectAll(\"th\")\n            .data(columns)\n            .enter()\n            .append(\"th\")\n                .text(function(column) { return column; });\n    \n        // create a row for each object in the data\n        var rows = tbody.selectAll(\"tr\")\n            .data(data)\n            .enter()\n            .append(\"tr\");\n    \n        // create a cell in each row for each column\n        var cells = rows.selectAll(\"td\")\n            .data(function(row) {\n                return columns.map(function(column) {\n                    return {column: column, value: row[column]};\n                });\n            })\n            .enter()\n            .append(\"td\")\n            .attr(\"style\", \"font-family: Courier\") // sets the font style\n                .html(function(d) { return d.value; });\n        \n        return table;\n    }\n    \n    // render the table\n     var peopleTable = tabulate(data, [\"date\", \"close\"]);\n    \n\nAnd we should take care to add it into the code at the end of the portion\nwhere we’ve finished drawing the graph, but before the enclosing curly and\nregular brackets that complete the portion of the graph that has loaded our\ndata.csv file. This is because we want our new piece of code to have access to\nthat data and if we place it after those brackets it won’t know what data to\ndisplay.\n\nSo, right about here;\n\n    \n    \n            // Add the Y Axis\n            svg.append(\"g\")\n                .attr(\"class\", \"y axis\")\n                .call(yAxis);\n                                     // <= Add the code right here!\n    });\n    \n\nNow, we’re going to break with tradition a bit here and examine what our\ncurrent state of code produces. Then we’re going to explain something\ndifferent. _THEN_ we’re going to come back and explain the code…\n\nCheck it out…\n\n![Woah! What happened to the date?](images/table02.png) Woah! What happened to\nthe date?\n\nNot quite as we has originally envisaged?\n\nIndeed, the date has taken it upon itself to expand from a relatively modest\nformat of day-abbreviated month-two digit year (30-Apr-12) to a behemoth of a\nthing (Mon Apr 30 2012 00:00:00 GMT+1200 (New Zealand Standard Time)) that we\ncertainly didn’t intend, let alone have in our data.csv file.\n\nWhat’s going on here?\n\nI’m no expert, but this is what I tell myself is happening. The JavaScript\ncode recognises and deals with the ‘date’ variable as being a date/time (not a\nstring of numbers, letters and characters). Therefore, when we proceed to\ndisplay the variable on the screen, the browser says, “this is a date / time\nvalue, therefore in lieu of any other instructions, I will format it in the\nfollowing way”. This is perfectly valid and we could work through a method of\nre-formatting the code to display in a specific way, but there is a simpler\nway to solve the problem. Hence the third small but cunning change to our\noriginal code.\n\n#### A small but cunning change…\n\nOur table has decided to develop a mind of it’s own and format the date time\nas it sees fit. Well fair enough (I for one welcome our web time formatting\noverlords). How do we convince it to display the values in their natural form?\n\nWell, one solution that we could employ is to not tell the JavaScript that our\n`date` value in the data is actually time. In that condition, the code should\ntreat the values as an ordinary string and print it directly as it appears.\n\nThe good news is that this is pretty easy to do. Where originally we had a\nblock of data that consisted of `date` and `close`, all at different times, we\nwill now add a new variable called `date1` which will be the variable that we\nconvert to a time and draw the graph with. Leaving `date` to be the text\nstring that will be printed in our table.\n\nHow to do it?\n\nIt’s actually remarkably easy. Just change the following lines in the basic\nline graph code to amend `date` to `date1` and you’re good to go.\n\n    \n    \n        .x(function(d) { return x(d.date1); })\n    \n    \n    \n          d.date1 = parseTime(d.date);\n    \n    \n    \n      x.domain(d3.extent(data, function(d) { return d.date1; }));\n    \n\nThe middle line is probably the most significant, since this is the point\nwhere we declare `date1`, assign a time format and bring a new column of data\ninto being. The others simply refer to the data.\n\nSo we’ll make those small changes and now we can return to explain the d3.js\ncode…\n\n#### Explaining the d3.js code (reloaded).\n\nSo back we come to explain what is going on in the d3.js code that we\npresented a page or two back. Obviously it’s a fairly large chunk, and we can\nbreak it down into two chunks.\n\nThe first chunk we’ll look at is in fact the last part of the code that look\nlike this;\n\n    \n    \n    // render the table\n     var peopleTable = tabulate(data, [\"date\", \"close\"]);\n    \n\nThis portion simply calls the `tabulate` function using the `date` and `close`\ncolumns of our `data` array. Simply add or remove whichever columns you want\nto appear in your table (so long as they are in your data.csv file) and they\nwill be in your table. The tabulate function makes up all of the other part of\nthe added code.\n\nSo we come to the first block of the tabulate function;\n\n    \n    \n    // The table generation function\n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 400px\"),\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n\nHere the tabulate function is declared (`function tabulate`) and the variables\nthat the function will be using are specified (`(data, columns)`). In our case\n`data` is of course our `data` array and `columns` refers to `[\"date\",\n\"close\"]`.\n\nThe next line appends the table to the `body` of the web page (so it will\noccur just under the graph in this case). Then we do something slightly\nsneaky. The line `.attr(\"style\", \"margin-left: 400px\"),` is actually not the\ncode that was used to produce the table with the huge date/ time formatted\ninfo on. I deliberately used `.attr(\"style\", \"margin-left: 0px\"),` for the\nhuge date / time table since it’s job is to indent the table by a specified\namount from the left hand side of the page. And since the huge date time\nvalues would have pushed the table severely to the right, I cheated and used\n`0` instead of `400`. For the purposes of the final example where the date /\ntime values are formatted as expected, `400` is a good value.\n\nThe next two lines declare the functions we will use to add in the header\ncells (since they use the `<th>` tags for content) and the cells for the main\nbody of the table (they use `<td>`).\n\nThe next block of code adds in the header row;\n\n    \n    \n        // append the header row\n        thead.append(\"tr\")\n            .selectAll(\"th\")\n            .data(columns)\n            .enter()\n            .append(\"th\")\n                .text(function(column) { return column; });\n    \n\nHere we first append a row tag (`<tr>`), then we gather all the `columns` that\nwe have in our function (remember they were `[\"date\", \"close\"]`) and add them\nto our row using header tags (`<th>`).\n\nThe next block of code assigns the `row` variable to return (append) a row tag\n(`<tr>`) whenever it’s called …\n\n    \n    \n        // create a row for each object in the data\n        var rows = tbody.selectAll(\"tr\")\n            .data(data)\n            .enter()\n            .append(\"tr\");\n    \n\n… and it is in the following block of code…\n\n    \n    \n        // create a cell in each row for each column\n        var cells = rows.selectAll(\"td\")\n            .data(function(row) {\n                return columns.map(function(column) {\n                    return {column: column, value: row[column]};\n                });\n            })\n            .enter()\n            .append(\"td\")\n            .attr(\"style\", \"font-family: Courier\") // sets the font style\n                .html(function(d) { return d.value; });\n    \n\n… where we select each row that we’ve added (`var cells =\nrows.selectAll(\"td\")`). Then the following five lines works out from the\nintersection of the row and column which piece of data we’re looking at for\neach cell.\n\nThe last four lines take that piece of data (`d.value`) and wrap it in table\ndata tags (`<td>`) and place it in the correct cell as HTML.\n\nIt’s a very neat piece of code and I struggle to get my head around it, but\nthat doesn’t mean that I can’t appreciate the cleverness of it :-).\n\n#### Wrap up\n\nSo there we have it. Hopefully enough to explain what is going on and perhaps\nalso enough to convince ourselves that D3 is indeed more than just pretty\npictures. It’s all about the Data Driven Documents.\n\nAs mentioned earlier, there is a copy of the code and the data file for this\nexample at\n[github](https://gist.github.com/d3noob/3e5138a14cfc1822eedee2963c493399) and\nin the code samples bundled with this book (simple-graph-plus-table.html and\ndata.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/3e5138a14cfc1822eedee2963c493399).\n\n### More table madness: sorting, prettifying and adding columns\n\nWhen we last left our tables they were happily producing a faithful list of\nthe data points that we had in our graph.\n\nBut what if we wanted more?\n\nFrom the original contributors that bought you tables ([Shawn\nAllen](http://jsfiddle.net/7WQjr/) on [Google\nGroups](http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-\nto-a-csv-file)) and some neat additions from [Christophe\nViau](http://christopheviau.com/d3_tutorial/) comes extra coolness that I\ndidn’t include in the [previous example](chap11.xhtml#tables) :-).\n\nThere is a copy of the code and the data file for this example at\n[github](https://gist.github.com/d3noob/6f41685b1cd675d2d3de4f8a14777774) and\nin the code samples bundled with this book (simple-graph-plus-table-plus-\naddins.html and data2.csv). A live example can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/6f41685b1cd675d2d3de4f8a14777774).\n\n#### Add another column of information:\n\nFirstly, lets add another column of data to our table. To do this we want to\nhave something extra in our csv file to use, so let’s resurrect our old friend\ndata2.csv that we used for the graph with two lines previously. All we have to\ndo to make this a reality is change the reference that loads `data.csv` to\n`data2.csv` here;\n\n    \n    \n    d3.csv(\"data2.csv\", function(error, data) {\n    \n\nThis makes the assumption that you still have the data2.csv file in place. If\nnot, rush away and get it from the download of code samples from Leanpub.\n\nFrom here (and as promised in the previous chapter), it’s just a matter of\nadding in the extra column you want (in this case it’s the `open` column) like\nso;\n\n    \n    \n     var peopleTable = tabulate(data, [\"date\", \"close\", \"open\"]);\n    \n\n![Table with extra column](images/table03.png) Table with extra column\n\nYes, if you’re wondering, I have cheated slightly and changed the table indent\nto make it look slightly prettier.\n\nSo can we go further?\n\nYou know we can…\n\nIn the section where we format our data, lets add another column to our array\nin the form of a difference between the `close` value and the `open` value\n(and we’ll call it `diff`).\n\n    \n    \n      // format the data\n      data.forEach(function(d) {\n          d.date1 = parseTime(d.date);\n          d.close = +d.close;\n          d.open = +d.open;  //  <= added this for tidy house keeping\n          d.diff = Math.round(( d.close - d.open ) * 100 ) / 100;\n      });\n    \n\n(the `Math.round` function is to make sure we get a reasonable figure to\ndisplay, otherwise it tends to get carried away with decimal places)\n\nSo now we add in our new column (`diff`) to be tabulated;\n\n    \n    \n     var peopleTable = tabulate(data, [\"date\", \"close\", \"open\", \"diff\"]);\n    \n\n![Table with extra extra column](images/table04.png) Table with extra extra\ncolumn\n\nAnd yes, I changed the table indent again. I am a serial offender and will\ncontinue to change it to suit.\n\n#### Sorting on a column\n\nSo now with our four columns of awesome data, it turns out that we’re really\ninterested in the ones that have the highest `close` values. So we can sort on\nthe `close` column by adding the following lines directly after the line where\nwe declare the `peopleTable` function (which I will include in the code\nsnipped below for reference).\n\n    \n    \n    // render the table\n    var peopleTable = tabulate(data, [\"date\", \"close\", \"open\", \"diff\"]);\n    \n    peopleTable.selectAll(\"tbody tr\") \n               .sort(function(a, b) {\n                 return d3.descending(a.close, b.close);\n               });\n    \n\nWhich works magnificently;\n\n![Table sorted descending on 'close'](images/table05.png) Table sorted\ndescending on ‘close’\n\n#### Prettifying (actually just capitalising the header for each column)\n\nJust a little snippet that capitalises the headers for each row to make them\nlook slightly more authoritative.\n\nAdd the following lines of code directly below the block that you just added\nfor sorting the table;\n\n    \n    \n    peopleTable.selectAll(\"thead th\")\n               .text(function(column) {\n                 return column.charAt(0).toUpperCase() + column.substr(1);\n               });\n    \n\nThis is quite a tidy little piece of script. You can see it selecting the\nheaders (`selectAll(\"thead th\")`), then the first character in each header\n(`column.charAt(0)`), changing it to upper-case (`.toUpperCase()`) and adding\nit back to the rest of the string (`+ column.substr(1)`).\n\nWith the ultimate result…\n\n![Table with capitalised first characters in headers](images/table06.png)\nTable with capitalised first characters in headers\n\n#### Add borders\n\nSure our table looks nice and neatly arranged, but would a border look better?\n\nWell, here’s one way to do it;\n\nAll we need to do is add a border style to our table by adding in this line\nhere;\n\n    \n    \n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 200px\") // <= Remove the comma\n                .style(\"border\", \"2px black solid\"), // <= Add this line in\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n\n(don’t forget to move the comma from the end of the `margin-left` line)\n\nAnd the result is a tidy black border.\n\n![Table with a border](images/table07.png) Table with a border\n\nOK, so what about the individual cells?\n\nNo problem.\n\nIf we remember back to our CSS that we added in, we’ll just tell each cell\nthat we want a 1 pixel border buy amending the CSS for our table to this;\n\n    \n    \n    td, th {\n        padding: 1px 4px;\n        border: 1px black solid;\n    }\n    \n\nSo now each cell has a slightly more subtle border like this;\n\n![Table with cells with individual borders](images/table08.png) Table with\ncells with individual borders\n\nYikes! Not quite as subtle as I would have expected. I suppose it’s another\nexample of the code actually doing what you asked it to do. No problem,\n`border-collapse` to the rescue. Add the following line into here;\n\n    \n    \n    function tabulate(data, columns) {\n        var table = d3.select(\"body\").append(\"table\")\n                .attr(\"style\", \"margin-left: 200px\")\n                .style(\"border-collapse\", \"collapse\")   // <= Add this line in.\n                .style(\"border\", \"2px black solid\"),\n            thead = table.append(\"thead\"),\n            tbody = table.append(\"tbody\");\n    \n\nHow does that look?\n\n![Table with cells with collapsed borders](images/table09.png) Table with\ncells with collapsed borders\n\nAhh…. Much more refined.\n\nThe `border-collapse` style tells the table to overlap each cell’s borders,\nrather than treat them as discrete entities. So in this case it looks a bit\nbetter.\n\n### Adding web links to d3.js objects\n\nThe idea with this tip / trick is to be able to add a ‘link’ to an object so\nthat when you click on it, it takes you to a web page that we will pre-define.\n\nWe are going to generate a simple rectangle with some text and look at linking\nfrom the rectangle and the text separately and with some fanciness at the end\n:-).\n\nThe end result will be something that looks a little like this;\n\n![Objects with links](images/xlink-01.png) Objects with links\n\n(Notice the little pointing finger at the bottom that would indicate that\nthere actually _is_ a link there.)\n\nThe code that we will use as a starting point is this simple example that\ndraws a green rectangle and overlays some text on it;\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    \n    <body>\n    \n    <!-- load the d3.js library -->\t\n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n     \n    var width = 449;\n    var height = 249;\n    var word = \"gongoozler\";\n     \n    var holder = d3.select(\"body\")\n          .append(\"svg\")\n          .attr(\"width\", width)    \n          .attr(\"height\", height); \n    \n    // draw a rectangle\n    holder.append(\"rect\")  \n        .attr(\"x\", 100)\n        .attr(\"y\", 50)\n        .attr(\"height\", 100)\n        .attr(\"width\", 200)\n        .style(\"fill\", \"lightgreen\")\n        .attr(\"rx\", 10)\n        .attr(\"ry\", 10);\n    \n    // draw text on the screen\n    holder.append(\"text\")\n        .attr(\"x\", 200)\n        .attr(\"y\", 100)\n        .style(\"fill\", \"black\")\n        .style(\"font-size\", \"20px\")\n        .attr(\"dy\", \".35em\")\n        .attr(\"text-anchor\", \"middle\")\n        .text(word);\n    \n    </script>\n    \n    </body>\n    \n\nThere’s nothing too spectacular about the file. There’s a little bit of\nstyling and tweaking of attributes, but nothing too extreme. The only slightly\n‘odd’ part would be defining the word that is printed out as a variable (`var\nword = \"gongoozler\";`) and then adding it as a variable (`.text(word);`)\ninstead of just putting the word directly in there (which we could do like\nthis `.text(\"gongoozler\");`). We’re going to do this deliberately to explore\nadditional options for making our links a little more dynamic.\n\n#### It’s all about the ‘a’ and the ‘xlink’\n\nThe `<a>` tag in an HTML file defines a\n[hyperlink](http://www.w3schools.com/html/html_links.asp). Items bounded by an\n`<a>` tag will become a link to another web address. So what we will do is\ncreate an `<a>` tag and then append our d3.js, svg object to it.\n\nOf course, as well as including a link, we need to tell it where to go. We do\nthis by setting the `xlink:href` attribute for our tag to point to a specific\npage. Xlink is short for XML Linking Language and it is used to create\nhyperlinks in XML documents. In our case we will be defining the link that we\nwill want our user to go to.\n\n#### Adding in the links\n\nThe following is the adjusted code for our rectangle that adds in the `<a>`\ntag with the `xlink:href` attribute.\n\n    \n    \n    holder.append(\"a\")\n        .attr(\"xlink:href\", \"http://en.wikipedia.org\")\n        .append(\"rect\")  \n        .attr(\"x\", 100)\n        .attr(\"y\", 50)\n        .attr(\"height\", 100)\n        .attr(\"width\", 200)\n        .style(\"fill\", \"lightgreen\")\n        .attr(\"rx\", 10)\n        .attr(\"ry\", 10);\n    \n\nIt’s important to append the link before the object (otherwise it won’t work)\nbut other than that, it’s a pretty simple job.\n\nThe only fly in the ointment is that while we now have a rectangle that links\nto Wikipedia, if we hover our mouse over the text, we lose our link (since we\nhaven’t told the text to link anywhere).\n\nWe can remedy that by doing exactly the same thing with the text element;\n\n    \n    \n    holder.append(\"a\")\n        .attr(\"xlink:href\", \"http://en.wikipedia.org/wiki/\"+word)\n        .append(\"text\")\n        .attr(\"x\", 200)\n        .attr(\"y\", 100)\n        .style(\"fill\", \"black\")\n        .style(\"font-size\", \"20px\")\n        .attr(\"dy\", \".35em\")\n        .attr(\"text-anchor\", \"middle\")\n        .text(word);\n    \n\nThe only slight difference here is that we have used the address for Wikipedia\nas our base and added the variable for our word to the end of it so that the\nresulting web address takes us to Wikipedia and the specific page for the word\n‘gongoozler’. Hopefully this will indicate that if we had a set of variables\nin an array we would make our links a little more dynamic.\n\n#### Making the mouse pointer ignore an object\n\nSo in theory we’re done, but in practice this has been a slightly crude method\nfor adding what should be a _single_ link to two objects when we should be\nable to accomplish it by defining the link once.\n\nWhat we could do as an alternative to linking both the rectangle and the text\nusing two separate links is to make the mouse ignore the text and have it rely\nsolely on the rectangle. We can do this using the `pointer-events` style when\ndrawing our text. By setting it to `none` we are instructing our mouse to\nignore any potential interaction with the text when it hovers over it and\ninstead the pointer will register the link on the rectangle below it.\n\nThe code for the text therefore becomes…\n\n    \n    \n    holder.append(\"text\")\n        .attr(\"x\", 200)\n        .attr(\"y\", 100)\n        .style(\"fill\", \"black\")\n        .style(\"font-size\", \"20px\")\n        .attr(\"dy\", \".35em\")\n        .attr(\"text-anchor\", \"middle\")\n        .style(\"pointer-events\", \"none\")\n        .text(word);\n    \n\nAnd as you can see from the image below, the pointer will happily ignore the\ntext while reading the link from the rectangle.\n\n![Objects with links](images/xlink-02.png) Objects with links\n\nThe complete code for this example is available in the appendices and a live\nversion can be found on\n[bl.ocks.org](http://bl.ocks.org/d3noob/87d9880fd5ae41b8fb5e309b59031002) and\n[GitHub](https://gist.github.com/d3noob/87d9880fd5ae41b8fb5e309b59031002). The\ncode is also in the downloadable files available from Leanpub with the book in\na file called ‘xlink-rect-pointer-events.html’.\n\n### Using the Yahoo Query Language (YQL) to get data.\n\nOne of the things that I find frustrating is difficulty getting data to play\nwith. Often I will find myself thinking “It would be neat to see if this\ntechnique works” but then I spend a couple of hours looking for data that will\nbe appropriate.\n\nAnother difficulty is that access to dynamic data is also problematic. D3.js\nreally shines when displaying information that is changing and interactive.\nFinding data that is changing and which you can interact with is not easy.\n\nThen, when you do come across a web site that has an interesting data set,\naccessing that data becomes programmatically difficult because of restrictions\nin accessing information that crosses domains. A solution to this problem (and\nthere are a few) is to have a data set that is in a domain that permits\n[Cross-Origin Resource Sharing](http://en.wikipedia.org/wiki/Cross-\norigin_resource_sharing) (CORS). These are not as common as you might hope as\nit presents security concerns that need to be addressed.\n\nOne resource that I have come across is particularly useful for solving the\nproblems outlined above is the [Yahoo! Developer\nNetwork](http://developer.yahoo.com/yql/) which operates a service where you\ncan write a query in an SQL type fashion that will return data as formatted\n[JSON](chap11.xhtml#json) (or others). This query can be formed into an http\nrequest so that you can simply paste a generated URL directly into your\nbrowsers URL bar and it will return the requested data. Better than that,\nbecause it supports CORS (and because d3.js can manage a CORS request without\nbreaking a sweat) all you need to do is put the URL into you code (as a\n`d3.json` call for example) and you will be up and running.\n\n#### YQL by example\n\nI will use an example of looking for current weather information for\nWellington New Zealand from the [Weather\nUnderground](http://www.wunderground.com/) (wunderground).\n\nIn this example, we’re interested in retrieving a JSON ‘blob’ that contains\ndata on the weather conditions (temperature, wind speed / direction, humidity\netc) for a specific location.\n\nStart at the page for the console (<http://developer.yahoo.com/yql/console/>).\nOn the left there is a range of data ‘topics that you can choose from. We will\nwant to access one of the community tables, so select ‘Show Community Tables’\nand scroll down the list until you find ‘wunderground’ and\n‘wunderground.currentobservation’\n\n![Select Community Tables and\nwunderground.currentobservation](images/yql-01.png) Select Community Tables\nand wunderground.currentobservation\n\nThis will bring up a query in the console that is looking for the current\nweather from San Francisco International airport.\n\n![Query for weather from San Francisco](images/yql-02.png) Query for weather\nfrom San Francisco\n\nFor our example we want to be a bit more specific, so we replace the ‘SFO’\n‘location’ with ‘Wellington, New Zealand’.\n\nIf you then click on the ‘Test’ button the query will run and results will be\npresented in the box below it;\n\n![JSON weather from San Francisco](images/yql-03.png) JSON weather from San\nFrancisco\n\nIf that looks like the results you were expecting, fantastic!\n\nThe next gem from YQL is the\n[REST](http://en.wikipedia.org/wiki/Representational_state_transfer) query\nthat is automatically generated at the bottom of the page;\n\n![REST Query](images/yql-04.png) REST Query\n\nIf you select this query and past it in your URL bar, you will have the JSON\ndata returned into your browser.\n\nAt this point it might seem a bit confusing, and if you’re unfamiliar with how\nJSON based data sets are structured it will DEFINITELY be confusing (You will\nneed to do some research to get up to speed there). My advice is to first\nunderstand a bit about JSON and then examine the output from the REST query in\nthe developer console on your browser (this is a fairly long topic in itself,\nso I will not cover it here sorry). Additionally check out the ‘Examples’\nchapter for real world usage.\n\nIf you are comfortable with understanding how the data can be encoded, it is\nthen just a matter of including the REST query in your call when selecting\ndata using `d3.json` and you will be away.\n\nPlease check out the examples I will include in the ‘Examples’ chapter for a\ndeeper look at the use of the data with d3.js (This will also help with\nunderstanding the JSON structure).\n\n### Export an image from a d3.js page as a SVG or bitmap\n\nAt some point you will want to take your lovingly crafted D3 graphical\nmasterpiece and put it in a (close your eyes if you’re squeamish) Power Point\npresentation or Word document or export it for sharing in some other way.\n\nThere could be many reasons for wanting to do this and some may be more\ncomplicated than I will be willing to explore, but for the occasional\nconversion of images I have found what I regard as a fairly easy process.\n\nBefore we begin our exporting odyssey, let’s cover a little bit of\nhousekeeping and describe the difference between a vector graphic (in this\ncase specifically Scalable Vector Graphics) and a bitmap. Please skip ahead if\nyou’re comfortable with the terms.\n\n#### Bitmaps\n\nA bitmap (or raster) image is one that is composed of lots of discrete\nindividual dots (let’s call them pixels) which, when joined together (and\nzoomed out a bit) give the impression of an image. If we use the force layout\nexample we developed, and look at a screen shot (and it’s important to\nremember that this is a screen shot) of the image we see a picture that looks\nfairly benign.\n\n![A bitmap at a normal zoom level](images/prezoom.png) A bitmap at a normal\nzoom level\n\nHowever, as we enlarge the image by doubling its size (x 2) we begin to see\nsome rough edges appear.\n\n![A bitmap at 200%](images/prezoomx2.png) A bitmap at 200%\n\nAnd if we enlarge it by doubling again (x 4) , it starts to look decidedly\nrough.\n\n![A bitmap at 400%](images/prezoomx4.png) A bitmap at 400%\n\nDoubling again (x 8), starts to show the pixels pretty clearly.\n\n![A bitmap at 800%](images/prezoomx8.png) A bitmap at 800%\n\nDoubling again for the last time (x 16) and the pixels are plainly evident.\n\n![A bitmap at 1600%](images/prezoomx16.png) A bitmap at 1600%\n\nBitmaps can be saved in a wide range of formats depending on the users\nrequirements including compression, colour depth, transparency and a host of\nother attributes. Typically they can be identified by the file suffix .jpg,\n.png or .bmp (and there are an equally large number of other suffixes).\n\nThis will be the type of format that most people will be familiar with for\nimages and their ubiquity with the advent of digital cameras almost makes it\nredundant to describe them.\n\nHowever, there is another type of image and it is even more important to d3.js\nusers.\n\n#### Vector Graphics (Specifically SVG)\n\nScalable Vector Graphics (SVG) use a technique of drawing an image that relies\nmore on a description of an image than the final representation that a user\nsees. Instead of arranging individual pixels, an image is created by\ndescribing the way the image is created.\n\nFor instance, drawing a line would be accomplished by defining two sets of\ncoordinates and specifying a line of a particular width and colour be drawn\nbetween the points.\n\nThis might sound a little long winded, and it does create a sense of\nabstraction, but it is a far more powerful mechanism for drawing as there is\nno loss of detail with increasing scale. Changes to the image can be simply\ncarried out by adjusting the coordinates, colour description, line width or\ncurve diameter. If this all sounds a little familiar, you have _definitely_\nbeen paying attention, because this is the heart of the way that d3.js draws\nimages in a browser. It uses a combination of coordinates, shapes and\nattributes to create vector images in a web page.\n\nAs a demonstration of the difference, here is the same original picture which\nI have saved as a SVG image.\n\n![A SVG image at a normal zoom level](images/svgzoom.png) A SVG image at a\nnormal zoom level\n\nEnlarged by doubling its size (x 2) everything looks smooth.\n\n![A SVG at 200%](images/svgzoomx2.png) A SVG at 200%\n\nIf we enlarge it by doubling again (x 4) , it still looks good.\n\n![A SVG at 400%](images/svgzoomx4.png) A SVG at 400%\n\nDoubling again (x 8) and we can see that the text ‘James’ is actually composed\nof a fill colour and a border.\n\n![A SVG at 800%](images/svgzoomx8.png) A SVG at 800%\n\nDoubling again for the last time (x 16) everything still retains its clear\nsharp edges.\n\n![A SVG at 1600%](images/svgzoomx16.png) A SVG at 1600%\n\n#### Let’s get exporting!\n\nWe’ll use a three stage process for exporting our image (assuming the desired\nend result is a bitmap) and usefully, the first stage will result in us having\na vector image as well!\n\nThe sequence will go as follows:\n\n  1. Copy the image from the web page and save it as a SVG file\n  2. Open the SVG image in a program designed to use vector images and edit it if required.\n  3. Export that image as a bitmap\n\n##### Copying the image off the web page\n\nGetting the image out of a web page is made easy by using ‘[SVG\nCrowbar](http://nytimes.github.io/svg-crowbar/)’. This is a “ _A Chrome-\nspecific bookmarklet that extracts SVG nodes and accompanying styles from an\nHTML document and downloads them as an SVG file_ ”. What that means is that\nonce you drag the bookmarklet from the web page to your bookmarks (You need to\nbe using Google Chrome, and I’m told that about 60% of the people who visit\nd3noob.org do) you’re ready to go.\n\n![Drag the 'SVG Crowbar' Object from the web page to your bookmarks\nbar](images/svgcrowbar.png) Drag the ‘SVG Crowbar’ Object from the web page to\nyour bookmarks bar\n\nNow when you have a web page open that’s displaying a D3 creation, all you\nneed to do is click on the SVG Crowbar bookmark and you will be prompted for a\nlocation to save a svg image.\n\nReally. It’s that simple.\n\n##### Open the SVG Image and Edit\n\nObviously now that you have a SVG image, you need to be able to do something\nwith it. My preferred software for this is [Inkscape](http://inkscape.org/).\n\nInkscape is “ _An Open Source vector graphics editor, with capabilities\nsimilar to Illustrator, CorelDraw, or Xara X, using the W3C standard Scalable\nVector Graphics (SVG) file format_ ”.\n\nIt really is an extremely capable drawing program and it is capable of a lot\nmore than the job we’re going to use it for, so you may find it has other uses\nthat may be valuable.\n\nOnce installed, you can open the saved file directly into Inkscape.\n\n![Inkscape with our force diagram](images/inkscape.png) Inkscape with our\nforce diagram\n\nWhile here you can edit the drawing to your hearts delight. I particularly\nrecommend ungrouping the diagram and removing or adjusting individual elements\nif required.\n\nOnce you have finished editing, you are ready for the final step.\n\n##### Saving as a bitmap\n\nWhile still in Inkscape, go to the ‘File’, ‘Export Bitmap…’ menu.\n\n![Inkscape Export Bitmap menu](images/inkscape-export.png) Inkscape Export\nBitmap menu\n\nThis will open a dialog box where you can select an appropriate resolution and\nlocation for your bitmap and then press the export button.\n\n![Inkscape Export Bitmap dialog](images/inkscape-export-dialog.png) Inkscape\nExport Bitmap dialog\n\nThere you go.\n\nIt is worth knowing that the default settings here will export the diagram\nwith a transparent background (using *.png) which will fit in nicely with a\nwide range of graphical end uses.\n\n### Understanding JavaScript Object Notation (JSON)\n\nOne of the most useful things you might want to learn when understanding how\nto present your data with D3 is how to _structure_ your data so that it is\neasy to use.\n\nAs explained earlier in the book, there are several different types of data\nthat can be requested by D3 including text, Extensible Markup Language (XML),\nHyperText Markup Language (HTML), Comma Separated Values (CSV), Tab Separated\nValues (TSV) and JavaScript Object Notation (JSON).\n\nComma separated values and tab separated values are fairly well understood\nforms of data. They are expressed as rows and columns of information that are\nseparated using a known character. While these forms of data are simple to\nunderstand, it is not easy to incorporate a hierarchy structure to the data,\nand when you try, it isn’t natural and makes managing the data difficult.\n\nJavaScript Object Notation (JSON) presents a different mechanism for storing\ndata. A light weight description could read “ _JSON is a text-based open\nstandard designed to present human-readable data. It is derived from the\nJavaScript scripting language, but it is language and platform independent._ ”\n\nUnfortunately, when I first started using JSON, I struggled with the concept\nof how it was structured, in spite of some fine descriptions on the web (start\nwith <http://www.json.org/> in my humble opinion). So the following is how I\ncame to think of and understand JSON.\n\n**Fair Warning:** This advice is no substitute for the correct explanation of\nthe topic of data structures that I’m sure you could receive from a reputable\neducational site or institution. It’s just the way I like to think of it :-).\nIt’s also just the way that I _started_ to understand JSON. There is plenty to\nlearn and understand once you grasp the basics. So this isn’t a complete\nguide. Just the beginnings.\n\nIn the following steps we’ll go through a process that (hopefully)\ndemonstrates that we can transform identifiers that would represent the\nclosing price for a stock of 58.3 on 2013-03-14 into more traditional x,y\ncoordinates.\n\nI think of data as having an identifier and a value.\n\n    \n    \n    identifier: value\n    \n\nIf a point on a graph is located at the x,y coordinates 150,25 then the\nidentifier ‘x’ has a value 150.\n\n    \n    \n    \"x\": 150\n    \n\nIf the x axis was a time-line, the true value for ‘x’ could be “2013-03-14”.\n\n    \n    \n    \"x\": \"2013-03-14\"\n    \n\nThis example might look similar to those seen by users of d3.js, since if\nwe’re using date / time format we can let D3 sort out the messy parts like\nwhat coordinates to provide for the screen.\n\nAnd there’s no reason why we couldn’t give the ‘x’ identifier a more human\nreadable label such as “date”. So our data would look like;\n\n    \n    \n    \"date\": \"2013-03-14\"\n    \n\nThis is only one part of our original x,y = 150,25 data set. The same way that\nthe x value represented a position on the x axis that was really a date, the y\nvalue represents a position on the y axis that is really another number. It\nonly gets converted to 25 when we need to plot a position on a graph at\n150,25. If the ‘y’ component represents the closing price of a stock we could\ntake the same principles used to transform…\n\n    \n    \n    \"x\": 150\n    \n\n… into …\n\n    \n    \n    \"date\": \"2013-03-14\"\n    \n\n… to change ….\n\n    \n    \n    \"y\": 25\n    \n\n… into …\n\n    \n    \n    \"close\": 58.3\n    \n\nThis might sound slightly confusing, so try to think of it this way. We want\nto plot a point on a graph at 150,25, but the data that this position is\nderived from is really “2013-03-14”, 58.3. D3 can look after all the scaling\nand determination of the range so that the point gets plotted at 150,25 and\nour originating data can now be represented as;\n\n    \n    \n    \"date\": \"2013-03-14\", \"close\": 58.3\n    \n\nThis represents two separate pieces of data. Each of which has an identifier\n(“date” or “close”) and a value (“2013-03-14” and 58.3)\n\nIf we wanted to have a series of these data points that represented several\ndays of closing prices, we would store them as an array of identifiers and\nvalues similar to this;\n\n    \n    \n    { \"date\": \"2013-03-14\", close: 58.13 },\n    { \"date\": \"2013-03-15\", close: 53.98 },\n    { \"date\": \"2013-03-16\", close: 67.00 },\n    { \"date\": \"2013-03-17\", close: 89.70 },\n    { \"date\": \"2013-03-18\", close: 99.00 }\n    \n\nEach of the individual elements of the array is enclosed in curly brackets and\nseparated by commas.\n\nI am making the assumption that you are familiar with the concept of what an\n‘array’ is. If this is an unfamiliar word, in the context of data, then I\nstrongly recommend that you do some Goggling to build up some familiarity with\nthe principle.\n\nNow that we have an array, we can apply the same rules to it as we did the the\nitem that had a single value. We can give it an identifier all of its own. In\nthis case we will call it “data”. Now we can use our identifier: value analogy\nto use “data” as the identifier and the array as the value.\n\n    \n    \n    { \"data\": [\n      { \"date\": \"2013-03-14\", close: 58.13 },\n      { \"date\": \"2013-03-15\", close: 53.98 },\n      { \"date\": \"2013-03-16\", close: 67.00 },\n      { \"date\": \"2013-03-17\", close: 89.70 },\n      { \"date\": \"2013-03-18\", close: 99.00 }\n    ] }\n    \n\nThe array has been enclosed in square brackets to designate it as an array and\nthe entire identifier: value sequence has been encapsulated with curly braces\n(much the same way that the subset “date”, “close” values were enclosed with\ncurly braces.\n\nIf we try to convey the same principle in a more graphical format, we could\nshow our initial identifier and value for the x component like so;\n\n![Single identifier and value](images/iv-01.png) Single identifier and value\n\nThe we can add our additional component for the y value;\n\n![Single identifier and value](images/iv-02.png) Single identifier and value\n\nWe can then add several of these combinations together in an array;\n\n![Single identifier and value](images/iv-03.png) Single identifier and value\n\nThen the array becomes a value for another identifier “data”;\n\n![Single identifier and value](images/iv-04.png) Single identifier and value\n\nMore complex JSON files will have multiple levels of identifiers and values\narranged in complex hierarchies which can be difficult to interpret. However,\nlaying out the data in a logical way in a text file is an excellent way to\nstart to make sense of the data.\n\n\n## D3.js Examples Explained\n\nI’ve decided to include an examples chapter because I have occasionally come\nacross things that I wanted to do with data or a technique that didn’t\nnecessarily fall into a specific category or where I had something that I\nwanted to do that went beyond an exercise that I would want to turn into a\nsimple description.\n\nIn other words I think that this will be a place where I can put random\ngraphics that I have made up that don’t necessarily fall into a logical\ncategory but which I think would be worth recording.\n\nIn many cases these examples will combine a range of techniques that have been\nexplained in the book and in some cases they may include new material that\nperhaps I would have struggled to explain without putting the technique into\nbetter context.\n\nWhatever the case, I will try to explain the examples as best I can and to\ninclude a full code listing for each and a link to an electronic version\nwherever possible.\n\n### Multi-line graph with automatic legend and toggling show / hide lines.\n\n#### Purpose\n\nCreating a multi-line graph is a pretty handy thing to be able to do and we\nworked through an example earlier in the book as an extension of our simple\ngraph. In that example we used a csv file that had the data arranged with each\nlines values in a separate column.\n\n    \n    \n    date,close,open\n    1-May-12,68.13,34.12\n    30-Apr-12,63.98,45.56\n    27-Apr-12,67.00,67.89\n    26-Apr-12,89.70,78.54\n    25-Apr-12,99.00,89.23\n    24-Apr-12,130.28,99.23\n    23-Apr-12,166.70,101.34\n    \n\nThis is a common way to have data stored, but if you are retrieving\ninformation from a database, you may not have the luxury of having it laid out\nin columns. It may be presented in a more linear fashion where each lines\nvalues are stores on a unique row with the identifier for the line on the same\nrow. For instance, the data above could just as easily be presented as\nfollows;\n\n    \n    \n    price,date,value\n    close,1-May-12,68.13\n    close,30-Apr-12,63.98\n    close,27-Apr-12,67.00\n    close,26-Apr-12,89.70\n    close,25-Apr-12,99.00\n    close,24-Apr-12,130.28\n    close,23-Apr-12,166.70\n    open,1-May-12,34.12\n    open,30-Apr-12,45.56\n    open,27-Apr-12,67.89\n    open,26-Apr-12,78.54\n    open,25-Apr-12,89.23\n    open,24-Apr-12,99.23\n    open,23-Apr-12,101.34\n    \n\nIn this case, we would need to ‘pivot’ the data to produce the same multi-\ncolumn representation as the original format. This is not always easy, but it\ncan be achieved using the d3 [`nest`](chap07.xhtml#nest) function which we\nwill examine.\n\nAs well as this we will want to automatically encode the lines to make them\ndifferent colours and to add a legend with the line name and the colour of the\nappropriate line.\n\nFinally, because we will build a graph script that can cope with any number of\nlines (within reason), we will need to be able to show / hide the individual\nlines to try and clarify the graph if it gets too cluttered.\n\nAll of these features have been covered individually in the book, so what\nwe’re going to do is combine them in a way that presents us with an elegant\nmulti-line graph that looks a bit like this;\n\n![Multi-line graph with legend](images/super-01.png) Multi-line graph with\nlegend\n\n#### The Code\n\nThe following is the code for the initial example which is a slight derivative\nof the original simple graph. A live version is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/755a069aafbe66f3fd8497b9498df643) or\n[GitHub](https://gist.github.com/d3noob/755a069aafbe66f3fd8497b9498df643). It\nis also available as the files ‘super-multi-lines.html’ and ‘stocks.csv’ as a\ndownload with the book D3 Tips and Tricks (in a zip file) when you [download\nthe book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\n    \n    \n    <!DOCTYPE html>\n    <meta charset=\"utf-8\">\n    <style> /* set the CSS */\n    \n    body { font: 12px Arial;}\n    \n    path { \n        stroke: steelblue;\n        stroke-width: 2;\n        fill: none;\n    }\n    \n    .axis path,\n    .axis line {\n        fill: none;\n        stroke: grey;\n        stroke-width: 1;\n        shape-rendering: crispEdges;\n    }\n    \n    </style>\n    <body>\n    \n    <!-- load the d3.js library -->    \n    <script src=\"https://d3js.org/d3.v4.min.js\"></script>\n    \n    <script>\n    \n    // Set the dimensions of the canvas / graph\n    var margin = {top: 30, right: 20, bottom: 30, left: 50},\n        width = 600 - margin.left - margin.right,\n        height = 270 - margin.top - margin.bottom;\n    \n    // Parse the date / time\n    var parseDate = d3.timeParse(\"%b %Y\");\n    \n    // Set the ranges\n    var x = d3.scaleTime().range([0, width]);  \n    var y = d3.scaleLinear().range([height, 0]);\n    \n    // Define the line\n    var priceline = d3.line()    \n        .x(function(d) { return x(d.date); })\n        .y(function(d) { return y(d.price); });\n        \n    // Adds the svg canvas\n    var svg = d3.select(\"body\")\n        .append(\"svg\")\n            .attr(\"width\", width + margin.left + margin.right)\n            .attr(\"height\", height + margin.top + margin.bottom)\n        .append(\"g\")\n            .attr(\"transform\", \n                  \"translate(\" + margin.left + \",\" + margin.top + \")\");\n    \n    // Get the data\n    d3.csv(\"stocks.csv\", function(error, data) {\n        data.forEach(function(d) {\n            d.date = parseDate(d.date);\n            d.price = +d.price;\n        });\n    \n        // Scale the range of the data\n        x.domain(d3.extent(data, function(d) { return d.date; }));\n        y.domain([0, d3.max(data, function(d) { return d.price; })]);\n    \n        // Nest the entries by symbol\n        var dataNest = d3.nest()\n            .key(function(d) {return d.symbol;})\n            .entries(data);\n    \n        // Loop through each symbol / key\n        dataNest.forEach(function(d) { \n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .attr(\"d\", priceline(d.values));\n    \n        });\n    \n        // Add the X Axis\n        svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .attr(\"transform\", \"translate(0,\" + height + \")\")\n          .call(d3.axisBottom(x));\n    \n        // Add the Y Axis\n        svg.append(\"g\")\n          .attr(\"class\", \"axis\")\n          .call(d3.axisLeft(y));\n    \n    });\n    \n    </script>\n    </body>\n    \n\n#### Description\n\n##### Nesting the data\n\nThe example code above differs from the simple graph in two main ways.\n\nFirstly, the script loads the file `stocks.csv` which was used by Mike Bostock\nin his [small multiples example](http://bl.ocks.org/mbostock/1157787). This\nmeans that the variable names used are different (`price` for the value of the\nstocks, `symbol` for the name of the stock and good old `date` for the date)\nand we have to adjust the `parseDate` function to parse a modified date value.\n\nSecondly we add the code blocks to take the `stocks.csv` information that we\nload as `data` and we apply the `d3.nest` function to it and draw each line.\n\nThe following code nest’s the data\n\n    \n    \n        var dataNest = d3.nest()\n            .key(function(d) {return d.symbol;})\n            .entries(data);\n    \n\nWe declare our new array’s name as `dataNest` and we initiate the `nest`\nfunction;\n\n    \n    \n    \tvar dataNest = d3.nest()\n    \n\nWe assign the `key` for our new array as `symbol`. A ‘key’ is like a way of\nsaying “ _This is the thing we will be grouping on_ ”. In other words our\nresultant array will have a single entry for each unique `symbol` or stock\nwhich will itself be an array of dates and values.\n\n    \n    \n    \t\t.key(function(d) {return d.symbol;})\n    \n\nThen we tell the nest function which data array we will be using for our\nsource of data.\n\n    \n    \n    \t\t}).entries(data);\n    \n\nThen we use the nested data to loop through our stocks and draw the lines\n\n    \n    \n        dataNest.forEach(function(d) {\n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .attr(\"d\", priceline(d.values));\n    \n        });\n    \n\nThe `forEach` function being applied to `dataNest` means that it will take\neach of the keys that we have just declared with the `d3.nest` (each stock)\nand use the values for each stock to append a line using its values.\n\nThe end result looks like the following;\n\n![A very plain multi-line graph](images/super-02.png) A very plain multi-line\ngraph\n\nYou would be justified in thinking that this is more than a little confusing.\nClearly while we have been successful in making each stock draw a\ncorresponding line, unless we can tell them apart, the graph is pretty\nuseless.\n\n##### Applying the colours\n\nMaking sure that the colours that are applied to our lines (and ultimately our\nlegend text) is unique from line to line is actually pretty easy.\n\nThe code that we will implement for this change is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/ae9786c26d6a821eefeabe60dec350a9) or\n[GitHub](https://gist.github.com/d3noob/ae9786c26d6a821eefeabe60dec350a9). It\nis also available as the files ‘super-multi-colours.html’ and ‘stocks.csv’ as\na download with the book D3 Tips and Tricks v4 (in a zip file) when you\n[download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThe changes that we will make to our code are captured in the following code\nsnippet.\n\n    \n    \n        // set the colour scale\n        var color = d3.scaleOrdinal(d3.schemeCategory10);\n    \n        // Loop through each symbol / key\n        dataNest.forEach(function(d) { \n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .style(\"stroke\", function() { // Add the colours dynamically\n                    return d.color = color(d.key); })\n                .attr(\"d\", priceline(d.values));\n    \n        });\n    \n\nFirstly we need to declare an [ordinal\nscale](https://github.com/d3/d3/blob/master/API.md#ordinal-scales) for our\ncolours with `var color = d3.scaleOrdinal(d3.schemeCategory10);`. This is a\nset of categorical colours (10 of them in this case) that can be invoked which\nare a nice mix of difference from each other and pleasant on the eye.\n\nWe then use the colour scale to assign a unique stroke (line colour) for each\nunique key (symbol) in our dataset.\n\n    \n    \n        .style(\"stroke\", function() {\n            return d.color = color(d.key); })\n    \n\nIt seems easy when it’s implemented, but in all reality, it is the product of\nsome very clever thinking behind the scenes when designing d3.js and even\npicking the colours that are used. The end result is a far more usable graph\nof the stock prices.\n\n![Multi-line graph with unique colours](images/super-03.png) Multi-line graph\nwith unique colours\n\nOf course now we’re faced with the problem of not knowing which line\nrepresents which stock price. Time for a legend.\n\n##### Adding the legend\n\nIf we think about the process of adding a legend to our graph, what we’re\ntrying to achieve is to take every unique data series we have (stock) and add\na relevant label showing which colour relates to which stock. At the same\ntime, we need to arrange the labels in such a way that they are presented in a\nmanner that is not offensive to the eye. In the example I will go through I\nhave chosen to arrange them neatly spaced along the bottom of the graph. so\nthat the final result looks like the following;\n\n![Multi-line graph with legend](images/super-01.png) Multi-line graph with\nlegend\n\nBear in mind that the end result will align the legend completely\nautomatically. If there are three stocks it will be equally spaced, if it is\nsix stocks they will be equally spaced. The following is a reasonable\nmechanism to facilitate this, but if the labels for the data values are of\nradically different lengths, the final result will looks ‘odd’ likewise, if\nthere are a LOT of data values, the legend will start to get crowded.\n\nThe code that we will implement for this change is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/f8b7f107ba25c21971851728520224cb) or\n[GitHub](https://gist.github.com/d3noob/f8b7f107ba25c21971851728520224cb). It\nis also available as the files ‘super-multi-legend.html’ and ‘stocks.csv’ as a\ndownload with the book D3 Tips and Tricks v4 (in a zip file) when you\n[download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThere are three broad categories of changes that we will want to make to our\ncurrent code;\n\n  1. Declare a style for the legend font\n  2. Change the area and margins for the graph to accommodate the additional text\n  3. Add the text\n\nDeclaring the style for the legend text is as easy as making an appropriate\nentry in the `<style>` section of the code. For this example we can choose the\nfollowing;\n\n    \n    \n    .legend {\n        font-size: 16px;\n        font-weight: bold;\n        text-anchor: middle;\n    }\n    \n\nTo change the area and margins of the graph we can make the following small\nchanges to the code.\n\n    \n    \n    var margin = {top: 30, right: 20, bottom: 70, left: 50},\n        width = 600 - margin.left - margin.right,\n        height = 300 - margin.top - margin.bottom;\n    \n\nThe bottom margin is now 70 pixels high and the overall space for the area\nthat the graph (including the margins) covers is increased to 300 pixels.\n\nTo add the legend text is slightly more work, but only slightly more. The\nfollowing code incorporates the changes and there are commented out asterisks\nto the end of the lines that have been added\n\n    \n    \n        legendSpace = width/dataNest.length; // spacing for legend // ******\n    \n        // Loop through each symbol / key\n        dataNest.forEach(function(d,i) {                           // ******\n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .style(\"stroke\", function() { // Add the colours dynamically\n                    return d.color = color(d.key); })\n                .attr(\"d\", priceline(d.values));\n    \n            // Add the Legend\n            svg.append(\"text\")                                    // *******\n                .attr(\"x\", (legendSpace/2)+i*legendSpace) // spacing // ****\n                .attr(\"y\", height + (margin.bottom/2)+ 5)         // *******\n                .attr(\"class\", \"legend\")    // style the legend   // *******\n                .style(\"fill\", function() { // dynamic colours    // *******\n                    return d.color = color(d.key); })             // *******\n                .text(d.key);                                     // *******\n    \n        });\n    \n\nThe first added line finds the spacing between each legend label by dividing\nthe width of the graph area by the number of symbols (`key`’s or stocks).\n\n    \n    \n        legendSpace = width/dataNest.length;\n    \n\nThen there is a small and subtle change that might other wise go unnoticed,\nbut is nonetheless significant. We add an `i` to the `forEach` function;\n\n    \n    \n        dataNest.forEach(function(d,i) {\n    \n\nThis might not seem like much of a big deal, but declaring `i` allows us to\naccess the index of the returned data. This means that each unique `key`\n(stock or symbol) has a unique number. In our example those numbers would be\nfrom 0 to 3 (MSFT = 0, AMZN = 1, IBM = 2 and AAPL = 3 (this is the order in\nwhich the stocks appear in our csv file)).\n\nNow we get to adding our text. Again, this is a fairly simple exercise which\nis following the route that we have taken several times already in the book\nbut using some of our prepared values.\n\n    \n    \n            svg.append(\"text\")\n                .attr(\"x\", (legendSpace/2)+i*legendSpace)\n                .attr(\"y\", height + (margin.bottom/2)+ 5)\n                .attr(\"class\", \"legend\")\n                .style(\"fill\", function() {\n                    return d.color = color(d.key); })\n                .text(d.key);\n    \n\nThe horizontal spacing for the labels is achieved by setting each label to the\nposition set by the index associated with the label and the space available on\nthe graph. To make it work out nicely we add half a `legendSpace` at the start\n(`legendSpace/2`) and then add the product of the index (`i`) and\n`legendSpace` (`i*legendSpace`).\n\nWe position the legend vertically so that it is in the middle of the bottom\nmargin (`height + (margin.bottom/2)+ 5`).\n\nAnd we apply the same colour function to the text as we did to the lines\nearlier;\n\n    \n    \n                .style(\"fill\", function() {\n                    return d.color = color(d.key); })\n    \n\nThe final result is a neat and tidy legend at the bottom of the graph;\n\n![Multi-line graph with legend](images/super-01.png) Multi-line graph with\nlegend\n\nIf you’re looking for an exercise to test your skills you could adapt the code\nto show the legend to the right of the graph. And if you wanted to go one\nbetter, you could arrange the order of the legend to reflect the final numeric\nvalue on the right of the graph (I.e in this case AAPL would be on the top and\nMSFT on the bottom).\n\n##### Making it interactive\n\nThe last step we’ll take in this example is to provide ourselves with a bit of\ncontrol over how the graph looks. Even with the multiple colours, the graph\ncould still be said to be ‘busy’. To clean it up or at least to provide the\nability to more clearly display the data that a user wants to see we will add\ncode that will allow us to click on a legend label and this will toggle the\ncorresponding graph line on or off.\n\nThis is a progression from the example of how to show / hide an element by\nclicking on another element that was introduced in he ‘Assorted tips and\ntricks’ chapter.\n\nThe only changes to our code that need to be implemented are in the `forEach`\nsection below. I have left some comments with asterisks in the code below to\nillustrate lines that are added.\n\n    \n    \n        dataNest.forEach(function(d,i) {\n    \n            svg.append(\"path\")\n                .attr(\"class\", \"line\")\n                .style(\"stroke\", function() {\n                    return d.color = color(d.key); })\n                .attr(\"id\", 'tag'+d.key.replace(/\\s+/g, '')) // assign ID **\n                .attr(\"d\", priceline(d.values));\n    \n            // Add the Legend\n            svg.append(\"text\")\n                .attr(\"x\", (legendSpace/2)+i*legendSpace)\n                .attr(\"y\", height + (margin.bottom/2)+ 5)\n                .attr(\"class\", \"legend\")\n                .style(\"fill\", function() {\n                    return d.color = color(d.key); })\n                .on(\"click\", function(){                     // ************\n                    // Determine if current line is visible\n                    var active   = d.active ? false : true,  // ************\n                    newOpacity = active ? 0 : 1;             // ************\n                    // Hide or show the elements based on the ID\n                    d3.select(\"#tag\"+d.key.replace(/\\s+/g, '')) // *********\n                        .transition().duration(100)          // ************\n                        .style(\"opacity\", newOpacity);       // ************\n                    // Update whether or not the elements are active\n                    d.active = active;                       // ************\n                    })                                       // ************\n                .text(d.key);\n    \n        });\n    \n\nThe full code for the complete working example is available online at\n[bl.ocks.org](http://bl.ocks.org/d3noob/08af723fe615c08f9536f656b55755b4) or\n[GitHub](https://gist.github.com/d3noob/08af723fe615c08f9536f656b55755b4). It\nis also available as the files ‘super-multi.html’ and ‘stocks.csv’ as a\ndownload with the book D3 Tips and Tricks v4 (in a zip file) when you\n[download the book from Leanpub](https://leanpub.com/d3-t-and-t-v4).\n\nThe first piece of code that we need to add assign an `id` to each legend text\nlabel.\n\n    \n    \n            .attr(\"id\", 'tag'+d.key.replace(/\\s+/g, ''))\n    \n\nBeing able to use our `key` value as the id means that each label will have a\nunique identifier. “ _What’s with adding the`'tag'` piece of text to the\n`id`?_” I hear you ask. Good question. If our key starts with a number we\ncould strike trouble (in fact I’m sure there are plenty of other ways we could\nstrike trouble too, but this was one I came across). As well as that we\ninclude a little regular expression goodness to strip any spaces out of the\nkey with `.replace(/\\s+/g, '')`.\n\nThe `.replace` calls the regular expression action on our `key`. `\\s` is the\nregex for “whitespace”, and `g` is the “global” flag, meaning match ALL `\\s`\n(whitespaces). The `+` allows for any _contiguous_ string of space characters\nto being replaced with the empty string (`''`). This was a late addition to\nthe example and kudos go to the participants in the [Stack Overflow question\nhere](http://stackoverflow.com/questions/5963182/how-to-remove-spaces-from-a-\nstring-using-javascript).\n\nThen we use the `.on(\"click\", function(){` call carry out some actions on the\nlabel if it is clicked on. We toggle the `.active` descriptor for our element\nwith `var active = d.active ? false : true,`. Then we set the value of\n`newOpacity` to either `0` or `1` depending on whether `active` is false or\ntrue.\n\nFrom here we can select our label using its unique id and adjust it’s opacity\nto either `0` (transparent) or `1` (opaque);\n\n    \n    \n            d3.select(\"#tag\"+d.key.replace(/\\s+/g, ''))\n                .transition().duration(100)\n                .style(\"opacity\", newOpacity);\n    \n\nJust because we can, we also add in a `transition` statement so that the\nchange in transparency doesn’t occur in a flash (100 milli seconds in fact\n(`.duration(100)`)).\n\nLastly we update our `d.active` variable to whatever the active state is so\nthat it can toggle correctly the next time it is clicked on.\n\nSince it’s kind of difficult to represent interactivity in a book, head on\nover to the [live example on\nbl.ocks.org](http://bl.ocks.org/d3noob/e99a762017060ce81c76) to see the\ntoggling awesomeness that could be yours!\n\n",
    "book_id": "d3-t-and-t-v4",
    "book_title": "D3 Tips and Tricks v4.x",
    "book_author": "Malcolm Maclean",
    "topic_id": "design_data_visualization",
    "topic_label": "data visualization",
    "chunk_index": 5
  }
]