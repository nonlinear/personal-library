# Epic v0.5.0: Index Granularity

**Status:** üöß In Progress
**Branch:** v0.5.0
**Started:** 2026-01-25

---

## Goal

Add page/chapter metadata to chunks during indexing (data preparation only, NO display changes).

**Split from v0.4.0:**

- v0.4.0 discovered VS Code pill validation breaks with URL fragments
- Decided to split work:
  - **v0.5.0 (this epic):** Prepare the data (index with page/chapter info)
  - **v0.7.0 (future):** Display the data (solve VS Code limitation)

---

## What We're Building

**Chunks.json schema v2.0:**

```json
{
  "chunk_full": "...",
  "book_id": "...",
  "book_title": "...",
  "filename": "Book.pdf",
  "relative_path": "books/topic/Book.pdf",
  "page": 42, // NEW: PDF page number
  "chapter": "ch03", // NEW: EPUB chapter ID
  "cfi": "epubcfi(...)" // NEW: EPUB Canonical Fragment Identifier (optional)
}
```

**What changes:**

- ‚úÖ Indexing scripts extract page/chapter during chunking
- ‚úÖ chunks.json stores new metadata fields
- ‚úÖ Backward compatibility (old chunks still work)
- ‚ùå NO changes to research.py output format
- ‚ùå NO changes to citation display
- ‚ùå NO VS Code extension work

**Why this approach:**

- Data is ready when we solve display problem
- Can test extraction/storage independently
- No user-facing changes until v0.7.0

---

## Session Log

### 2026-01-25: Epic Creation

**Created from roadmap grooming:**

- Split Source Granularity (v0.4.0) into two epics
- Index Granularity (v0.5.0) = data preparation
- Citation Expression (v0.7.0) = display/navigation

**Tasks identified:**

- [ ] Update chunks.json schema to v2.0
- [ ] PDF chunking: Extract page numbers
- [ ] EPUB chunking: Extract chapter/section
- [ ] Store metadata (no output changes)
- [ ] Backward compatibility
- [ ] Validation tests
- [ ] Force reindex all topics

---

## Next Steps

1. Research PDF page extraction methods
2. Research EPUB chapter/CFI extraction
3. Update chunking code
4. Test with small topic first
5. Validate metadata accuracy

---

## Notes

**Key insight:** By separating data from presentation, we can make progress now while VS Code limitation is unresolved.

**Future work (v0.7.0):** Once data exists, we can explore:

- Two-link format: `[Book.pdf](path) - See page 42`
- Custom VS Code extension
- Wait for VS Code to support fragments
- Alternative display methods
