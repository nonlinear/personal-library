# Epic v0.4.0: Source Granularity

**Status:** üöß In Progress
**Branch:** v0.4.0
**Started:** 2026-01-24

---

## Goal

Add page/chapter granularity to citations for direct navigation:

- PDF citations ‚Üí `Book.pdf#page=42`
- EPUB citations ‚Üí chapter/CFI references
- Text snippets as verification fallback

---

## Session Log

### 2026-01-24: Epic Creation & Planning

**Grooming:**

- Defined problem: Citations require manual Ctrl+F
- Industry standards research:
  - PDF: RFC 3778 `#page=N` anchor
  - EPUB: CFI (Canonical Fragment Identifier) or chapter anchors
- VS Code extensions identified:
  - `tomoki1207.pdf` (already installed)
  - `mathematic.vscode-pdf` (already installed)
  - `cweijan.epub-reader` (already installed)

**Tasks created:**

- [ ] Test pill validation with anchors
- [ ] Extract page numbers during PDF chunking
- [ ] Extract chapters during EPUB chunking
- [ ] Update chunks.json schema to v2.0
- [ ] Modify research.py output
- [ ] Update research.prompt.md citations
- [ ] Force reindex all topics

**Workflow documented:**

- Created epic workflow in CONTRIBUTING.md
- 8-step process from grooming to branch creation
- Branch naming: `v0.X.0` (version only, no descriptive name)
- Notes location: `engine/docs/epic-notes/v0.X.0.md`

---

## Next Steps

1. Test PDF/EPUB links with anchors (verify pills work)
2. Locate chunking code (indexer.py or similar)
3. Add page/chapter extraction logic
4. Update chunks.json schema

---

## Technical Notes

**Chunk Schema v2.0 (proposed):**

```json
{
  "chunk_full": "...",
  "book_id": "...",
  "book_title": "...",
  "filename": "Book.pdf",
  "relative_path": "books/topic/Book.pdf",
  "page": 42, // NEW: PDF page number
  "chapter": "ch03", // NEW: EPUB chapter
  "cfi": "epubcfi(...)" // NEW: EPUB CFI (optional)
}
```

**Citation Format v2.0 (proposed):**

```markdown
1Ô∏è‚É£ [Book.pdf (page 42)](books/topic/Book.pdf#page=42)
four word verification snippet
```

**Critical question:** Do VS Code pills break with `#page=42` anchors?

---

## Experiments

### 2026-01-24: VS Code Pill Validation with URL Fragments

**Critical Discovery:** VS Code pill validation is **INCOMPATIBLE** with URL fragments (`#`).

**Test Methodology:**
Created test file `TEST-epub-anchors.md` with various anchor syntaxes using real EPUB:
`books/anarchy/david graeber/Debt.epub`

**Test Results:**

| Syntax              | Example                                    | Pill?  | Link?  | Notes                              |
| ------------------- | ------------------------------------------ | ------ | ------ | ---------------------------------- |
| **Baseline**        | `[file.epub](path/file.epub)`              | ‚úÖ YES | ‚úÖ YES | Standard pill validation works     |
| **Hash Fragment**   | `[file.epub](path/file.epub#chapter3)`     | ‚ùå NO  | ‚ùå NO  | Fragment breaks pill completely    |
| **Query String**    | `[file.epub](path/file.epub?chapter=3)`    | ‚ùå NO  | ‚ùå NO  | Nothing renders at all             |
| **URL Encoding**    | `[file.epub](path/file.epub%23chapter3)`   | ‚ùå NO  | ‚ùå NO  | Nothing renders at all             |
| **Double Encoding** | `[file.epub](path/file.epub%2523chapter3)` | ‚ùå NO  | ‚ùå NO  | Nothing renders at all             |
| **Empty Hash**      | `[file.epub](path/file.epub#)`             | ‚úÖ YES | ‚úÖ YES | Pill works but no navigation value |

**Key Findings:**

1. **Pill validation** requires exact path matching: `workspace-relative-path/filename.ext`
2. **Any fragment** (`#anything`) breaks validation ‚Üí no pill, no link rendered
3. **Alternative syntaxes** (query strings, encoding) also fail ‚Üí markdown doesn't render at all
4. **Empty fragment** (`#`) preserves pill but provides zero navigation benefit

**Impact on Epic:**

üî¥ **CRITICAL BLOCKER** - Cannot achieve primary goal (clickable navigation to specific pages/chapters)

**Possible Solutions:**

1. **Two-link approach:**

   ```markdown
   [Book.pdf](path/Book.pdf) - See page 42
   ```

   - Pill validates file existence
   - User manually navigates after opening

2. **Text-only granularity:**

   ```markdown
   [Book.pdf](path/Book.pdf) (page 42)
   four word verification snippet
   ```

   - No clickable navigation
   - Page number as reference only

3. **Report VS Code limitation:**
   - File issue on VS Code GitHub
   - Request fragment support in pill validation
   - Long-term solution

4. **Custom VS Code extension:**
   - Intercept citation format
   - Handle navigation internally
   - Significant development effort

5. **Accept limitation:**
   - Document in CHANGELOG
   - Epic provides page numbers but not navigation
   - Still improvement over current state

**Recommendation:** Proceed with **Solution 2** (text-only granularity) as pragmatic compromise:

- Provides page/chapter information for user reference
- Maintains pill validation (anti-phishing)
- Works within VS Code constraints
- Can upgrade later if VS Code adds fragment support

**Industry Context:**
No known documentation of this pill validation behavior exists. This may be first comprehensive test of VS Code pill validation with URL fragments.

---

### 2026-01-24: VS Code Path Autocomplete Investigation

**Problem:** Folders and files in `books/` directory not appearing in markdown path autocomplete (`[text](` + Ctrl+Space), even after reload.

**Hypothesis Chain:**

1. ‚ùå **files.exclude blocking autocomplete** ‚Üí Added books-specific patterns, still failed
2. ‚ùå **search.exclude blocking autocomplete** ‚Üí Only affects search, not autocomplete
3. ‚ùå **Need VS Code reload** ‚Üí Reloaded, still failed
4. ‚úÖ **Git ignore patterns block autocomplete** ‚Üí ROOT CAUSE FOUND

**Root Cause:**

VS Code markdown path autocomplete **respects .gitignore patterns** regardless of `files.exclude` or `search.exclude` settings.

**Failed Attempts:**

```jsonc
// project.code-workspace
"files.exclude": {
  "**/*.pkl": true,
  "**/*.index": true,
  "books/metadata.json": true,
  "books/**/*.pkl": true,      // ‚Üê Added redundantly
  "books/**/*.index": true     // ‚Üê Added redundantly
}
```

**Debugging Discovery:**

```bash
$ git check-ignore -v books/technology
.git/info/exclude:10:books/**/  books/technology
#                     ^^^^^^^^ ‚Üê PROBLEM: This ignores ALL subdirs
```

**Original .git/info/exclude:**

```gitignore
# Books (BYOB: Bring Your Own Books)
books/**/*.epub  # ‚úÖ Correct: ignores only EPUB files
books/**/        # ‚ùå WRONG: ignores ALL folders inside books/
```

**The `books/**/` pattern:\*\*

- Matches ANY directory path inside books/
- Result: `books/technology/`, `books/AI/`, etc. all ignored
- VS Code autocomplete skips ignored paths
- files.exclude cannot override git ignore

**Solution:**

Remove `books/**/` from `.git/info/exclude`, keep only `books/**/*.epub`:

```gitignore
# Books (BYOB: Bring Your Own Books - only EPUBs, not folders)
books/**/*.epub  # ‚úÖ Only ignores .epub files, folders remain visible
```

**Verification:**

```bash
$ git check-ignore -v books/technology 2>&1 || echo "NOT IGNORED"
NOT IGNORED  # ‚úÖ Success!
```

**Key Lessons:**

1. **Git patterns > VS Code settings** for autocomplete
2. **files.exclude ‚â† autocomplete visibility** (only affects Explorer)
3. **search.exclude ‚â† autocomplete visibility** (only affects search)
4. **.git/info/exclude is local** (not tracked in repo, perfect for BYOB)
5. **`**`vs`**/` matters:** `books/**/*.epub` (files) vs `books/**/` (dirs)

**Configuration Split:**

- **.gitignore:** Only .pkl, .index, metadata.json (repo-tracked)
- **.git/info/exclude:** Only .epub files (local, per-user)
- **files.exclude:** Hide clutter from Explorer (visual only)
- **files.watcherExclude:** Prevent VS Code watching large EPUBs (performance)

**Final State:**

```bash
# .gitignore (tracked)
books/**/*.pkl
books/**/*.index
books/metadata.json

# .git/info/exclude (local)
books/**/*.epub

# project.code-workspace (tracked)
"files.exclude": {
  "**/*.pkl": true,
  "**/*.index": true,
  "books/metadata.json": true,
  ...
}
"files.watcherExclude": {
  "**/*.pkl": true,
  "**/*.index": true,
  "books/**/*.epub": true  // ‚Üê Performance: don't watch large files
}
```

**Status:** ‚úÖ RESOLVED - Autocomplete should work after VS Code reload

**Final Verification (2026-01-24):**

After VS Code reload, autocomplete now working correctly:

- `[livro](` + Ctrl+Space shows `books/technology/`, `books/AI/`, etc.
- Folders visible in autocomplete
- EPUBs remain hidden (git ignored locally)
- files.exclude only affects Explorer view, not autocomplete

‚úÖ **Confirmed working** - Knowledge validation complete.
