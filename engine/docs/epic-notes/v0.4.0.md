# Epic v0.4.0: Source Granularity

**Status:** üöß In Progress  
**Branch:** v0.4.0  
**Started:** 2026-01-24

---

## Goal

Add page/chapter granularity to citations for direct navigation:
- PDF citations ‚Üí `Book.pdf#page=42`
- EPUB citations ‚Üí chapter/CFI references
- Text snippets as verification fallback

---

## Session Log

### 2026-01-24: Epic Creation & Planning

**Grooming:**
- Defined problem: Citations require manual Ctrl+F
- Industry standards research:
  - PDF: RFC 3778 `#page=N` anchor
  - EPUB: CFI (Canonical Fragment Identifier) or chapter anchors
- VS Code extensions identified:
  - `tomoki1207.pdf` (already installed)
  - `mathematic.vscode-pdf` (already installed)
  - `cweijan.epub-reader` (already installed)

**Tasks created:**
- [ ] Test pill validation with anchors
- [ ] Extract page numbers during PDF chunking
- [ ] Extract chapters during EPUB chunking
- [ ] Update chunks.json schema to v2.0
- [ ] Modify research.py output
- [ ] Update research.prompt.md citations
- [ ] Force reindex all topics

**Workflow documented:**
- Created epic workflow in CONTRIBUTING.md
- 8-step process from grooming to branch creation
- Branch naming: `v0.X.0` (version only, no descriptive name)
- Notes location: `engine/docs/epic-notes/v0.X.0.md`

---

## Next Steps

1. Test PDF/EPUB links with anchors (verify pills work)
2. Locate chunking code (indexer.py or similar)
3. Add page/chapter extraction logic
4. Update chunks.json schema

---

## Technical Notes

**Chunk Schema v2.0 (proposed):**
```json
{
  "chunk_full": "...",
  "book_id": "...",
  "book_title": "...",
  "filename": "Book.pdf",
  "relative_path": "books/topic/Book.pdf",
  "page": 42,           // NEW: PDF page number
  "chapter": "ch03",    // NEW: EPUB chapter
  "cfi": "epubcfi(...)" // NEW: EPUB CFI (optional)
}
```

**Citation Format v2.0 (proposed):**
```markdown
1Ô∏è‚É£ [Book.pdf (page 42)](books/topic/Book.pdf#page=42)
    four word verification snippet
```

**Critical question:** Do VS Code pills break with `#page=42` anchors?

---

## Experiments

(Testing results will be logged here)
